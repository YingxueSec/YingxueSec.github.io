<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>ç¬¬13ç«  å¼‚æ­¥ JavaScript | Jackhou Blog</title><meta name="keywords" content="ã€ŠJavaScriptæƒå¨æŒ‡å—ã€‹,JavaScript"><meta name="author" content="Jack hou"><meta name="copyright" content="Jack hou"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="ç¬¬13ç«  å¼‚æ­¥ JavaScript"><meta name="application-name" content="ç¬¬13ç«  å¼‚æ­¥ JavaScript"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="ç¬¬13ç«  å¼‚æ­¥ JavaScript"><meta property="og:url" content="http://www.houyanbin.com/2023/04/26/Books/%E3%80%8AJavaScript%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E3%80%8B/ch13/index.html"><meta property="og:site_name" content="Jackhou Blog"><meta property="og:description" content="Some computer programs, such as scientific simulations and machine learning models, are compute-bound: they run continuously, without pause, until"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/post/default_cover3.jpg"><meta property="article:author" content="Jack hou"><meta property="article:tag" content="Jackhou, blog"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/post/default_cover3.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://www.houyanbin.com/2023/04/26/Books/%E3%80%8AJavaScript%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E3%80%8B/ch13/"><link rel="preconnect" href="//npm.elemecdn.com"/><link rel="preconnect" href="//npm.onmicrosoft.cn"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@1.0.17/lib/assets/font-awesome-animation.min.css"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.14/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  preloader: {"source":3},
  friends_vue_info: {"apiurl":null},
  navMusic: true,
  mainTone: undefined,
  authorStatus: undefined,
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"ç¹","msgToSimplifiedChinese":"ç®€","rightMenuMsgToTraditionalChinese":"è½¬ä¸ºç¹ä½“","rightMenuMsgToSimplifiedChinese":"è½¬ä¸ºç®€ä½“"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: true,
    simplehomepage: false,
    post: false
  },
  runtime: 'å¤©',
  date_suffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"ä½ å·²åˆ‡æ¢ä¸ºç¹ä½“","cht_to_chs":"ä½ å·²åˆ‡æ¢ä¸ºç®€ä½“","day_to_night":"ä½ å·²åˆ‡æ¢ä¸ºæ·±è‰²æ¨¡å¼","night_to_day":"ä½ å·²åˆ‡æ¢ä¸ºæµ…è‰²æ¨¡å¼","bgLight":"#3b70fc","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'ç¬¬13ç«  å¼‚æ­¥ JavaScript',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-04-26 21:45:28',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="åŠ è½½å¤´åƒ" src="data:image/jpeg;base64,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"/><div class="loading-image-dot"></div><div id="loading-percentage">0%</div></div></div><script>if (GLOBAL_CONFIG.preloader.source == "2" || GLOBAL_CONFIG.preloader.source == "3") {
  const loadingPercentage = document.getElementById("loading-percentage");
  let loadingPercentageTimer = setInterval(function() {
    var progressBar = document.querySelector(".pace-progress");
    if (!progressBar) return
    var currentValue = progressBar.getAttribute("data-progress-text");
    if (currentValue !== loadingPercentage.textContent) {
      loadingPercentage.textContent = currentValue;
      if (currentValue === "100%") {
        clearInterval(loadingPercentageTimer);
      }
    }
  }, 100);
}

const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div id="web_box"><div id="web_container"><div id="menu-mask"></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">ç½‘é¡µ</div><div class="back-menu-list"><a class="back-menu-item" href="https://www.houyanbin.com/" title="åšå®¢" target="_blank"><img class="back-menu-item-icon" src="/img/favicon.png" alt="åšå®¢"/><span class="back-menu-item-text">åšå®¢</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">é¡¹ç›®</div><div class="back-menu-list"><a class="back-menu-item" href="https://image.anheyu.com/" title="å®‰çŸ¥é±¼å›¾åºŠ" target="_blank"><img class="back-menu-item-icon" src="https://image.anheyu.com/favicon.ico" alt="å®‰çŸ¥é±¼å›¾åºŠ"/><span class="back-menu-item-text">å®‰çŸ¥é±¼å›¾åºŠ</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">Jackhou Blog</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><span> æ–‡ç« </span></a><ul class="menus_item_child" style="left:-79px;"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> éš§é“</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> åˆ†ç±»</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> æ ‡ç­¾</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><span> å‹é“¾</span></a><ul class="menus_item_child" style="left:-31px;"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> å‹äººå¸</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> ç•™è¨€æ¿</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><span> æˆ‘çš„</span></a><ul class="menus_item_child" style="left:-79px;"><li><a class="site-page child faa-parent animated-hover" href="/music/?id=8868465080&amp;server=tencent&amp;type=0"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> éŸ³ä¹é¦†</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/bangumis/"><i class="anzhiyufont anzhiyu-icon-bilibili faa-tada" style="font-size: 0.9em;"></i><span> è¿½ç•ªé¡µ</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> ç›¸å†Œé›†</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><span> å…³äº</span></a><ul class="menus_item_child" style="left:-79px;"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> å…³äºæœ¬äºº</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> é—²è¨€ç¢è¯­</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> éšä¾¿é€›é€›</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button only-home" id="travellings_button" title="éšæœºå‰å¾€ä¸€ä¸ªå¼€å¾€é¡¹ç›®ç½‘ç«™"><a class="site-page" onclick="anzhiyu.totraveling()" title="éšæœºå‰å¾€ä¸€ä¸ªå¼€å¾€é¡¹ç›®ç½‘ç«™" href="javascript:void(0);" rel="external nofollow" data-pjax-state="external"><i class="anzhiyufont anzhiyu-icon-train"></i></a></div><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="éšæœºå‰å¾€ä¸€ä¸ªæ–‡ç« " href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="æœç´¢ğŸ”" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> æœç´¢</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="ä¸­æ§å°" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/index/wechat.jpg" target="_blank"><img class="post-qr-code-img" alt="wechat" src="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/index/wechat.jpg"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/index/alipay.jpg" target="_blank"><img class="post-qr-code-img" alt="alipay" src="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/index/alipay.jpg"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">äº’åŠ¨</div><span class="author-content-item-title"> <span>æœ€æ–°è¯„è®º</span></span></div><div class="aside-list"><span>æ­£åœ¨åŠ è½½ä¸­...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">å…´è¶£ç‚¹</div><span class="author-content-item-title">å¯»æ‰¾ä½ æ„Ÿå…´è¶£çš„é¢†åŸŸ</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/Article/" style="font-size: 1.05rem; color: rgb(79, 66, 4);">Article<sup>4</sup></a><a href="/tags/CSRF/" style="font-size: 1.05rem; color: rgb(66, 35, 16);">CSRF<sup>1</sup></a><a href="/tags/Git/" style="font-size: 1.05rem; color: rgb(187, 87, 72);">Git<sup>1</sup></a><a href="/tags/Java/" style="font-size: 1.05rem; color: rgb(43, 138, 111);">Java<sup>3</sup></a><a href="/tags/JavaScript/" style="font-size: 1.05rem; color: rgb(186, 33, 8);">JavaScript<sup>17</sup></a><a href="/tags/Linux/" style="font-size: 1.05rem; color: rgb(74, 122, 78);">Linux<sup>1</sup></a><a href="/tags/Pikachu/" style="font-size: 1.05rem; color: rgb(100, 195, 30);">Pikachu<sup>1</sup></a><a href="/tags/SQL/" style="font-size: 1.05rem; color: rgb(47, 124, 37);">SQL<sup>2</sup></a><a href="/tags/XAUUSD/" style="font-size: 1.05rem; color: rgb(77, 134, 102);">XAUUSD<sup>1</sup></a><a href="/tags/XSS/" style="font-size: 1.05rem; color: rgb(152, 7, 172);">XSS<sup>2</sup></a><a href="/tags/%E3%80%8AJavaScript%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E3%80%8B/" style="font-size: 1.05rem; color: rgb(115, 131, 100);">ã€ŠJavaScriptæƒå¨æŒ‡å—ã€‹<sup>17</sup></a><a href="/tags/%E5%8C%BF%E5%90%8D/" style="font-size: 1.05rem; color: rgb(80, 67, 184);">åŒ¿å<sup>3</sup></a><a href="/tags/%E5%8D%9A%E5%AE%A2/" style="font-size: 1.05rem; color: rgb(108, 0, 85);">åšå®¢<sup>10</sup></a><a href="/tags/%E5%AE%89%E5%85%A8/" style="font-size: 1.05rem; color: rgb(100, 190, 136);">å®‰å…¨<sup>20</sup></a><a href="/tags/%E6%94%AF%E4%BB%98/" style="font-size: 1.05rem; color: rgb(126, 28, 176);">æ”¯ä»˜<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2/" style="font-size: 1.05rem; color: rgb(90, 200, 3);">æ”»é˜²<sup>1</sup></a><a href="/tags/%E6%97%85%E8%A1%8C/" style="font-size: 1.05rem; color: rgb(190, 119, 97);">æ—…è¡Œ<sup>1</sup></a><a href="/tags/%E8%99%9A%E6%8B%9F%E6%9C%BA/" style="font-size: 1.05rem; color: rgb(198, 12, 22);">è™šæ‹Ÿæœº<sup>4</sup></a><a href="/tags/%E8%B6%8A%E6%9D%83/" style="font-size: 1.05rem; color: rgb(133, 130, 49);">è¶Šæƒ<sup>2</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>æ–‡ç« </span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>å½’æ¡£</span></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/09/"><span class="card-archive-list-date">ä¹æœˆ 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>ç¯‡</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/08/"><span class="card-archive-list-date">å…«æœˆ 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>ç¯‡</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/07/"><span class="card-archive-list-date">ä¸ƒæœˆ 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>ç¯‡</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/06/"><span class="card-archive-list-date">å…­æœˆ 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>ç¯‡</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/05/"><span class="card-archive-list-date">äº”æœˆ 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>ç¯‡</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/04/"><span class="card-archive-list-date">å››æœˆ 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">37</span><span>ç¯‡</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/03/"><span class="card-archive-list-date">ä¸‰æœˆ 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>ç¯‡</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" onclick="anzhiyu.switchDarkMode()" title="æ˜¾ç¤ºæ¨¡å¼åˆ‡æ¢" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="è¾¹æ æ˜¾ç¤ºæ§åˆ¶"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item on" id="consoleCommentBarrage" onclick="anzhiyu.switchCommentBarrage()" title="çƒ­è¯„å¼€å…³"><a class="commentBarrage"><i class="anzhiyufont anzhiyu-icon-message"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="éŸ³ä¹å¼€å…³"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">åŸåˆ›</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF/">æŠ€æœ¯</a><i class="anzhiyufont anzhiyu-icon-angle-right post-meta-separator"></i><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF/JavaScript/">JavaScript</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/%E3%80%8AJavaScript%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E3%80%8B/" tabindex="-1"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>ã€ŠJavaScriptæƒå¨æŒ‡å—ã€‹</span></a><a class="article-meta__tags" href="/tags/JavaScript/" tabindex="-1"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>JavaScript</span></a></span></div></div><h1 class="post-title">ç¬¬13ç«  å¼‚æ­¥ JavaScript</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2023-04-25T16:00:48.000Z" title="å‘è¡¨äº 2023-04-26 00:00:48">2023-04-26</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2023-04-26T13:45:28.000Z" title="æ›´æ–°äº 2023-04-26 21:45:28">2023-04-26</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="ç¬¬13ç«  å¼‚æ­¥ JavaScript"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="é˜…è¯»é‡">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="ä½œè€…IPå±åœ°ä¸ºåŒ—äº¬"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>åŒ—äº¬</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/post/default_cover3.jpg"></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><meta name="referrer" content="no-referrer"/>



<p>Some computer programs, such as scientific simulations and machine learning models, are compute-bound: they run continuously, without pause, until they have computed their result. Most real-world computer programs, however, are significantly asynchronous. This means that they often have to stop computing while waiting for data to arrive or for some event to occur. JavaScript programs in a web browser are typically event-driven, meaning that they wait for the user to click or tap before they actually do anything. And JavaScript-based servers typically wait for client requests to arrive over the network before they do anything.</p>
<blockquote>
<p>ä¸€äº›è®¡ç®—æœºç¨‹åºï¼Œå¦‚ç§‘å­¦æ¨¡æ‹Ÿå’Œæœºå™¨å­¦ä¹ æ¨¡å‹ï¼Œæ˜¯è®¡ç®—å—é™çš„ï¼šå®ƒä»¬ä¸åœåœ°è¿è¡Œï¼Œæ²¡æœ‰åœé¡¿ï¼Œç›´åˆ°è®¡ç®—å‡ºç»“æœã€‚ç„¶è€Œï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ç°å®ä¸–ç•Œä¸­çš„å¤§å¤šæ•°è®¡ç®—æœºç¨‹åºéƒ½æ˜¯å¼‚æ­¥çš„ã€‚è¿™æ„å‘³ç€åœ¨ç­‰å¾…æ•°æ®åˆ°è¾¾æˆ–æŸäº›äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå®ƒä»¬å¸¸å¸¸ä¸å¾—ä¸åœæ­¢è®¡ç®—ã€‚web æµè§ˆå™¨ä¸­çš„ JavaScript ç¨‹åºæ˜¯å…¸å‹åœ°äº‹ä»¶é©±åŠ¨çš„ï¼Œè¿™æ„å‘³ç€å®ƒä»¬åœ¨å®é™…æ‰§è¡Œä»»ä½•æ“ä½œä¹‹å‰ç­‰å¾…ç”¨æˆ·å•å‡»æˆ–ç‚¹å‡»ã€‚åŸºäº javascript çš„æœåŠ¡å™¨é€šå¸¸åœ¨æ‰§è¡Œä»»ä½•æ“ä½œä¹‹å‰ç­‰å¾…å®¢æˆ·æœºè¯·æ±‚é€šè¿‡ç½‘ç»œåˆ°è¾¾ã€‚</p>
</blockquote>
<p>This kind of asynchronous programming is commonplace in JavaScript, and this chapter documents three important language features that help make it easier to work with asynchronous code. Promises, new in ES6, are objects that represent the not-yet-available result of an asynchronous operation. The keywords async and await were introduced in ES2017 and provide new syntax that simplifies asynchronous programming by allowing you to structure your Promise-based code as if it was synchronous. Finally, asynchronous iterators and the for&#x2F;await loop were introduced in ES2018 and allow you to work with streams of asynchronous events using simple loops that appear synchronous.</p>
<blockquote>
<p>è¿™ç§å¼‚æ­¥ç¼–ç¨‹åœ¨ JavaScript ä¸­å¾ˆå¸¸è§ï¼Œæœ¬ç« å°†ä»‹ç»ä¸‰ç§é‡è¦çš„è¯­è¨€ç‰¹æ€§ï¼Œå®ƒä»¬æœ‰åŠ©äºç®€åŒ–å¼‚æ­¥ä»£ç çš„ä½¿ç”¨ã€‚Promise æ˜¯ ES6 ä¸­çš„æ–°ç‰¹æ€§ï¼Œæ˜¯è¡¨ç¤ºç›®å‰ä¸å¯ç”¨ç»“æœçš„å¼‚æ­¥æ“ä½œå¯¹è±¡ã€‚å…³é”®å­— async å’Œ await æ˜¯åœ¨ ES2017 ä¸­å¼•å…¥çš„ï¼Œå®ƒä»¬æä¾›äº†æ–°çš„è¯­æ³•ï¼Œé€šè¿‡å…è®¸å°†åŸºäº Promise çš„ä»£ç æ„é€ æˆåŒæ­¥çš„æ–¹å¼æ¥ç®€åŒ–å¼‚æ­¥ç¼–ç¨‹ã€‚æœ€åï¼Œåœ¨ ES2018 ä¸­å¼•å…¥äº†å¼‚æ­¥è¿­ä»£å™¨å’Œ for&#x2F;await å¾ªç¯ï¼Œå…è®¸ä½¿ç”¨ç®€å•çš„åŒæ­¥å¾ªç¯å¤„ç†å¼‚æ­¥äº‹ä»¶æµã€‚</p>
</blockquote>
<p>Ironically, even though JavaScript provides these powerful features for working with asynchronous code, there are no features of the core language that are themselves asynchronous. In order to demonstrate Promises, async, await, and for&#x2F;await, therefore, we will first take a detour into client-side and server-side JavaScript to explain some of the asynchronous features of web browsers and Node. (You can learn more about client-side and server-side JavaScript in Chapters 15 and 16.)</p>
<blockquote>
<p>å…·æœ‰è®½åˆºæ„å‘³çš„æ˜¯ï¼Œå°½ç®¡ JavaScript ä¸ºå¤„ç†å¼‚æ­¥ä»£ç æä¾›äº†è¿™äº›å¼ºå¤§çš„ç‰¹æ€§ï¼Œä½†æ ¸å¿ƒè¯­è¨€æœ¬èº«å¹¶æ²¡æœ‰å¼‚æ­¥çš„ç‰¹æ€§ã€‚å› æ­¤ï¼Œä¸ºäº†æ¼”ç¤º Promiseã€asyncã€await å’Œ for&#x2F;awaitï¼Œæˆ‘ä»¬å°†é¦–å…ˆä½¿ç”¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯ JavaScript æ¥è§£é‡Š web æµè§ˆå™¨å’Œ Node çš„ä¸€äº›å¼‚æ­¥ç‰¹æ€§ã€‚ï¼ˆå¯ä»¥åœ¨ç¬¬ 15 ç« å’Œç¬¬ 16 ç« ä¸­äº†è§£æ›´å¤šå…³äºå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯ JavaScript çš„çŸ¥è¯†ã€‚ï¼‰</p>
</blockquote>
<h2 id="13-1-Asynchronous-Programming-with-Callbacks"><a href="#13-1-Asynchronous-Programming-with-Callbacks" class="headerlink" title="13.1 Asynchronous Programming with Callbacks"></a>13.1 Asynchronous Programming with Callbacks</h2><p>At its most fundamental level, asynchronous programming in JavaScript is done with callbacks. A callback is a function that you write and then pass to some other function. That other function then invokes (â€œcalls backâ€) your function when some condition is met or some (asynchronous) event occurs. The invocation of the callback function you provide notifies you of the condition or event, and sometimes, the invocation will include function arguments that provide additional details. This is easier to understand with some concrete examples, and the subsections that follow demonstrate various forms of callback-based asynchronous programming using both client-side JavaScript and Node.</p>
<blockquote>
<p>åœ¨æœ€åŸºæœ¬çš„å±‚æ¬¡ä¸Šï¼ŒJavaScript ä¸­çš„å¼‚æ­¥ç¼–ç¨‹æ˜¯é€šè¿‡å›è°ƒæ¥å®Œæˆçš„ã€‚å›è°ƒæ˜¯ä¸€ä¸ªä½ ç¼–å†™çš„å‡½æ•°ï¼Œç„¶åä¼ é€’ç»™å…¶ä»–å‡½æ•°ã€‚å½“æ»¡è¶³æŸäº›æ¡ä»¶æˆ–å‘ç”ŸæŸäº›ï¼ˆå¼‚æ­¥ï¼‰äº‹ä»¶æ—¶ï¼Œå…¶ä»–å‡½æ•°è°ƒç”¨ï¼ˆâ€œå›è°ƒâ€ï¼‰ä½ çš„å‡½æ•°ã€‚æä¾›çš„å›è°ƒå‡½æ•°çš„è°ƒç”¨ä¼šé€šçŸ¥ä½ æ¡ä»¶æˆ–äº‹ä»¶ï¼Œæœ‰æ—¶ï¼Œè°ƒç”¨å°†æä¾›åŒ…å«é¢å¤–ç»†èŠ‚çš„å‡½æ•°å®å‚ã€‚é€šè¿‡ä¸€äº›å…·ä½“çš„ç¤ºä¾‹ä¼šæ›´å®¹æ˜“ç†è§£ï¼Œä¸‹é¢çš„å­èŠ‚å°†æ¼”ç¤ºä½¿ç”¨å®¢æˆ·ç«¯ JavaScript å’Œ Node çš„å„ç§å½¢å¼çš„åŸºäºå›è°ƒçš„å¼‚æ­¥ç¼–ç¨‹ã€‚</p>
</blockquote>
<h3 id="13-1-1-Timers"><a href="#13-1-1-Timers" class="headerlink" title="13.1.1 Timers"></a>13.1.1 Timers</h3><p>One of the simplest kinds of asynchrony is when you want to run some code after a certain amount of time has elapsed. As we saw in Â§11.10, you can do this with the setTimeout() function:</p>
<blockquote>
<p>å½“å¸Œæœ›åœ¨ç»è¿‡ä¸€å®šæ—¶é—´åè¿è¡ŒæŸäº›ä»£ç æ˜¯ä¸€ç§æœ€ç®€å•çš„å¼‚æ­¥ç±»å‹ã€‚æ­£å¦‚æˆ‘ä»¬åœ¨ Â§11.10 ä¸­çœ‹åˆ°çš„ï¼Œå¯ä»¥é€šè¿‡ setTimeout() å‡½æ•°æ¥åšåˆ°è¿™ä¸€ç‚¹ï¼š</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">setTimeout</span>(checkForUpdates, <span class="number">60000</span>);</span><br></pre></td></tr></table></figure>

<p>The first argument to setTimeout() is a function and the second is a time interval measured in milliseconds. In the preceding code, a hypothetical checkForUpdates() function will be called 60,000 milliseconds (1 minute) after the setTimeout() call. checkForUpdates() is a callback function that your program might define, and setTimeout() is the function that you invoke to register your callback function and specify under what asynchronous conditions it should be invoked.</p>
<blockquote>
<p>setTimeout() çš„ç¬¬ä¸€ä¸ªå®å‚æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œç¬¬äºŒä¸ªå®å‚æ˜¯ä¸€ä¸ªä»¥æ¯«ç§’ä¸ºå•ä½çš„æ—¶é—´é—´éš”ã€‚å‰é¢çš„ä»£ç ä¸­ï¼Œåœ¨ setTimeout() è°ƒç”¨å 60,000 æ¯«ç§’ï¼ˆ1åˆ†é’Ÿï¼‰åï¼Œå°†è°ƒç”¨ä¸€ä¸ªå‡å®šçš„ checkForUpdates() å‡½æ•°ã€‚checkForUpdates() æ˜¯ç¨‹åºå®šä¹‰çš„ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œè€Œ setTimeout() æ˜¯ç”¨äºæ³¨å†Œå›è°ƒå‡½æ•°å¹¶æŒ‡å®šåº”è¯¥åœ¨ä»€ä¹ˆå¼‚æ­¥æ¡ä»¶ä¸‹è°ƒç”¨å®ƒçš„å‡½æ•°ã€‚</p>
</blockquote>
<p>setTimeout() calls the specified callback function one time, passing no arguments, and then forgets about it. If you are writing a function that really does check for updates, you probably want it to run repeatedly. You can do this by using setInterval() instead of setTimeout():</p>
<blockquote>
<p>setTimeout() è°ƒç”¨ä¸€æ¬¡æŒ‡å®šçš„å›è°ƒå‡½æ•°ï¼Œä¸ä¼ é€’ä»»ä½•å®å‚ï¼Œç„¶åå¿˜è®°å®ƒã€‚å¦‚æœæ­£åœ¨ç¼–å†™ä¸€ä¸ªæ£€æŸ¥æ›´æ–°çš„å‡½æ•°ï¼Œå¯èƒ½å¸Œæœ›å®ƒé‡å¤è¿è¡Œã€‚å¯ä»¥ä½¿ç”¨ setInterval() æ¥ä»£æ›¿ setTimeout()ï¼š</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Call checkForUpdates in one minute and then again every minute after that</span></span><br><span class="line"><span class="keyword">let</span> updateIntervalId = <span class="built_in">setInterval</span>(checkForUpdates, <span class="number">60000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// setInterval() returns a value that we can use to stop the repeated</span></span><br><span class="line"><span class="comment">// invocations by calling clearInterval(). (Similarly, setTimeout()</span></span><br><span class="line"><span class="comment">// returns a value that you can pass to clearTimeout())</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">stopCheckingForUpdates</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="built_in">clearInterval</span>(updateIntervalId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="13-1-2-Events"><a href="#13-1-2-Events" class="headerlink" title="13.1.2 Events"></a>13.1.2 Events</h3><p>Client-side JavaScript programs are almost universally event driven: rather than running some kind of predetermined computation, they typically wait for the user to do something and then respond to the userâ€™s actions. The web browser generates an event when the user presses a key on the keyboard, moves the mouse, clicks a mouse button, or touches a touchscreen device. Event-driven JavaScript programs register callback functions for specified types of events in specified contexts, and the web browser invokes those functions whenever the specified events occur. These callback functions are called event handlers or event listeners, and they are registered with addEventListener():</p>
<blockquote>
<p>å®¢æˆ·ç«¯ JavaScript ç¨‹åºå‡ ä¹éƒ½æ˜¯ç”±äº‹ä»¶é©±åŠ¨çš„ï¼šå®ƒä»¬é€šå¸¸ä¸ç­‰å¾…ç”¨æˆ·æ‰§è¡ŒæŸç§é¢„å®šçš„è®¡ç®—ï¼Œè€Œæ˜¯ç­‰å¾…ç”¨æˆ·æ‰§è¡ŒæŸäº›æ“ä½œï¼Œç„¶åå“åº”ç”¨æˆ·çš„æ“ä½œã€‚å½“ç”¨æˆ·æŒ‰ä¸‹é”®ç›˜ä¸Šçš„é”®ï¼Œç§»åŠ¨é¼ æ ‡ï¼Œå•å‡»é¼ æ ‡æŒ‰é’®æˆ–è§¦æ‘¸è§¦æ‘¸å±è®¾å¤‡æ—¶ï¼ŒWeb æµè§ˆå™¨ä¼šå‘ç”Ÿäº‹ä»¶ã€‚äº‹ä»¶é©±åŠ¨çš„ JavaScript ç¨‹åºåœ¨æŒ‡å®šçš„ä¸Šä¸‹æ–‡ä¸­ä¸ºæŒ‡å®šç±»å‹çš„äº‹ä»¶æ³¨å†Œå›è°ƒå‡½æ•°ï¼Œå¹¶ä¸”åªè¦æŒ‡å®šäº‹ä»¶å‘ç”Ÿï¼ŒWeb æµè§ˆå™¨å°±ä¼šè°ƒç”¨è¿™äº›å‡½æ•°ã€‚è¿™äº›å›è°ƒå‡½æ•°ç§°ä¸ºäº‹ä»¶å¥æŸ„æˆ–äº‹ä»¶ç›‘å¬å™¨ï¼Œå¹¶ä¸”ä½¿ç”¨ addEventListener() æ³¨å†Œï¼š</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Ask the web browser to return an object representing the HTML</span></span><br><span class="line"><span class="comment">// &lt;button&gt; element that matches this CSS selector</span></span><br><span class="line"><span class="keyword">let</span> okay = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#confirmUpdateDialog button.okay&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Now register a callback function to be invoked when the user</span></span><br><span class="line"><span class="comment">// clicks on that button.</span></span><br><span class="line">okay.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, applyUpdate);</span><br></pre></td></tr></table></figure>
<p>In this example, applyUpdate() is a hypothetical callback function that we assume is implemented somewhere else. The call to document.querySelector() returns an object that represents a single specified element in the web page. We call addEventListener() on that element to register our callback. Then the first argument to addEventListener() is a string that specifies the kind of event weâ€™re interested inâ€”a mouse click or touchscreen tap, in this case. If the user clicks or taps on that specific element of the web page, then the browser will invoke our applyUpdate() callback function, passing an object that includes details (such as the time and the mouse pointer coordinates) about the event.</p>
<blockquote>
<p>åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œå‡è®¾ applyUpdate() æ˜¯æˆ‘ä»¬åœ¨æŸä¸ªåœ°æ–¹å®ç°çš„å›è°ƒå‡½æ•°ã€‚è°ƒç”¨ document.querySelector() è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œè¯¥å¯¹è±¡è¡¨ç¤ºç½‘é¡µä¸­çš„å•ä¸ªæŒ‡å®šå…ƒç´ ã€‚æˆ‘ä»¬åœ¨è¯¥å…ƒç´ ä¸Šè°ƒç”¨ addEventListener() æ¥æ³¨å†Œæˆ‘ä»¬çš„å›è°ƒã€‚ç„¶åï¼ŒaddEventListener() çš„ç¬¬ä¸€ä¸ªå®å‚æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¯¥å­—ç¬¦ä¸²æŒ‡å®šäº†äº‹ä»¶çš„ç±»å‹ï¼ˆåœ¨è¿™ç§æƒ…å†µä¸‹æ˜¯å•å‡»é¼ æ ‡æˆ–è§¦æ‘¸å±ï¼‰ã€‚å¦‚æœç”¨æˆ·å•å‡»æˆ–ç‚¹å‡»ç½‘é¡µä¸Šçš„ç‰¹å®šå…ƒç´ ï¼Œåˆ™æµè§ˆå™¨å°†è°ƒç”¨æˆ‘ä»¬çš„ applyUpdate() å›è°ƒå‡½æ•°ï¼Œå¹¶ä¼ é€’ä¸€ä¸ªåŒ…å«äº‹ä»¶è¯¦ç»†ä¿¡æ¯ï¼ˆä¾‹å¦‚æ—¶é—´å’Œé¼ æ ‡æŒ‡é’ˆåæ ‡ï¼‰çš„å¯¹è±¡ã€‚</p>
</blockquote>
<h3 id="13-1-3-Network-Events"><a href="#13-1-3-Network-Events" class="headerlink" title="13.1.3 Network Events"></a>13.1.3 Network Events</h3><p>Another common source of asynchrony in JavaScript programming is network requests. JavaScript running in the browser can fetch data from a web server with code like this:</p>
<blockquote>
<p>JavaScript ç¼–ç¨‹ä¸­å¼‚æ­¥çš„å¦ä¸€ä¸ªå¸¸è§æ¥æºæ˜¯ç½‘ç»œè¯·æ±‚ã€‚åœ¨æµè§ˆå™¨ä¸­è¿è¡Œçš„ JavaScript å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»£ç ä» Web æœåŠ¡å™¨è·å–æ•°æ®ï¼š</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">getCurrentVersionNumber</span>(<span class="params">versionCallback</span>) &#123; <span class="comment">// Note callback argument</span></span><br><span class="line">    <span class="comment">// Make a scripted HTTP request to a backend version API</span></span><br><span class="line">    <span class="keyword">let</span> request = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span><br><span class="line">    request.<span class="title function_">open</span>(<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;http://www.example.com/api/version&quot;</span>);</span><br><span class="line">    request.<span class="title function_">send</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register a callback that will be invoked when the response arrives</span></span><br><span class="line">    request.<span class="property">onload</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (request.<span class="property">status</span> === <span class="number">200</span>) &#123;</span><br><span class="line">            <span class="comment">// If HTTP status is good, get version number and call callback.</span></span><br><span class="line">            <span class="keyword">let</span> currentVersion = <span class="built_in">parseFloat</span>(request.<span class="property">responseText</span>);</span><br><span class="line">            <span class="title function_">versionCallback</span>(<span class="literal">null</span>, currentVersion);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Otherwise report an error to the callback</span></span><br><span class="line">            <span class="title function_">versionCallback</span>(response.<span class="property">statusText</span>, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// Register another callback that will be invoked for network errors</span></span><br><span class="line">    request.<span class="property">onerror</span> = request.<span class="property">ontimeout</span> = <span class="keyword">function</span>(<span class="params">e</span>) &#123;</span><br><span class="line">        <span class="title function_">versionCallback</span>(e.<span class="property">type</span>, <span class="literal">null</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Client-side JavaScript code can use the XMLHttpRequest class plus callback functions to make HTTP requests and asynchronously handle the serverâ€™s response when it arrives.[^1] The getCurrentVersionNumber() function defined here (we can imagine that it is used by the hypothetical checkForUpdates() function we discussed in Â§13.1.1) makes an HTTP request and defines event handlers that will be invoked when the serverâ€™s response is received or when a timeout or other error causes the request to fail.</p>
<blockquote>
<p>å®¢æˆ·ç«¯ JavaScript ä»£ç å¯ä»¥ä½¿ç”¨ XMLHttpRequest ç±»ä»¥åŠå›è°ƒå‡½æ•°æ¥å‘å‡º HTTP è¯·æ±‚ï¼Œå¹¶åœ¨æœåŠ¡å™¨å“åº”æ—¶å¼‚æ­¥å¤„ç†ã€‚[^1] è¿™é‡Œå®šä¹‰çš„ getCurrentVersionNumber() å‡½æ•°ï¼ˆæˆ‘ä»¬å¯ä»¥å‡è®¾åœ¨ Â§13.1.1 æåˆ°çš„ checkForUpdates() å‡½æ•°ä½¿ç”¨äº†è¯¥å‡½æ•°ï¼‰å‘å‡º HTTP è¯·æ±‚å¹¶å®šä¹‰äº‹ä»¶å¤„ç†ç¨‹åºï¼Œè¯¥äº‹ä»¶å¤„ç†ç¨‹åºå°†åœ¨æ”¶åˆ°æœåŠ¡å™¨çš„å“åº”æˆ–è¶…æ—¶æˆ–å…¶ä»–å¼‚å¸¸å¯¼è‡´è¯·æ±‚å¤±è´¥æ—¶è¢«è°ƒç”¨ã€‚</p>
</blockquote>
<p>Notice that the code example above does not call addEventListener() as our previous example did. For most web APIs (including this one), event handlers can be defined by invoking addEventListener() on the object generating the event and passing the name of the event of interest along with the callback function. Typically, though, you can also register a single event listener by assigning it directly to a property of the object. That is what we do in this example code, assigning functions to the onload, onerror, and ontimeout properties. By convention, event listener properties like these always have names that begin with on. addEventListener() is the more flexible technique because it allows for multiple event handlers. But in cases where you are sure that no other code will need to register a listener for the same object and event type, it can be simpler to simply set the appropriate property to your callback.</p>
<blockquote>
<p>è¯·æ³¨æ„ï¼Œä¸Šé¢çš„ä»£ç ç¤ºä¾‹æœªåƒå‰é¢çš„ç¤ºä¾‹é‚£æ ·è°ƒç”¨ addEventListener()ã€‚å¯¹äºå¤§å¤šæ•° Web APIï¼ˆåŒ…æ‹¬æ­¤APIï¼‰ï¼Œå¯ä»¥é€šè¿‡åœ¨ç”Ÿæˆäº‹ä»¶çš„å¯¹è±¡ä¸Šè°ƒç”¨ addEventListener() å¹¶å°†äº‹ä»¶çš„åç§°ä¸å›è°ƒå‡½æ•°ä¸€èµ·ä¼ é€’æ¥å®šä¹‰äº‹ä»¶å¤„ç†ç¨‹åºã€‚ä¸è¿‡ï¼Œé€šå¸¸ï¼Œä¹Ÿå¯ä»¥é€šè¿‡å°†å•ä¸ªäº‹ä»¶ä¾¦å¬å™¨ç›´æ¥åˆ†é…ç»™å¯¹è±¡çš„å±æ€§æ¥æ³¨å†Œå®ƒã€‚è¿™å°±æ˜¯æˆ‘ä»¬åœ¨æ­¤ç¤ºä¾‹ä»£ç ä¸­æ‰€åšçš„ï¼Œå°†å‡½æ•°åˆ†é…ç»™ onloadã€onerror å’Œ ontimeout å±æ€§ã€‚æŒ‰ç…§æƒ¯ä¾‹ï¼Œæ­¤ç±»äº‹ä»¶ä¾¦å¬å™¨å±æ€§çš„åç§°å§‹ç»ˆä»¥ on å¼€å¤´ã€‚ addEventListener() æ˜¯æ›´çµæ´»çš„æŠ€æœ¯ï¼Œå› ä¸ºå®ƒå…è®¸å¤šä¸ªäº‹ä»¶å¤„ç†ç¨‹åºã€‚ä½†æ˜¯ï¼Œå¦‚æœç¡®å®šæ²¡æœ‰å…¶ä»–ä»£ç éœ€è¦ä¸ºç›¸åŒçš„å¯¹è±¡å’Œäº‹ä»¶ç±»å‹æ³¨å†Œä¸€ä¸ªä¾¦å¬å™¨ï¼Œåˆ™åªéœ€å°†é€‚å½“çš„å±æ€§è®¾ç½®ä¸ºå›è°ƒä¼šæ›´ç®€å•ã€‚</p>
</blockquote>
<p>Another thing to note about the getCurrentVersionNumber() function in this example code is that, because it makes an asynchronous request, it cannot synchronously return the value (the current version number) that the caller is interested in. Instead, the caller passes a callback function, which is invoked when the result is ready or when an error occurs. In this case, the caller supplies a callback function that expects two arguments. If the XMLHttpRequest works correctly, then getCurrentVersionNumber() invokes the callback with a null first argument and the version number as the second argument. Or, if an error occurs, then getCurrentVersionNumber() invokes the callback with error details in the first argument and null as the second argument.</p>
<blockquote>
<p>æ­¤ç¤ºä¾‹ä»£ç ä¸­å…³äº getCurrentVersionNumber() å‡½æ•°çš„å¦ä¸€ç‚¹æ³¨æ„äº‹é¡¹æ˜¯ï¼Œç”±äºå®ƒå‘å‡ºå¼‚æ­¥è¯·æ±‚ï¼Œå› æ­¤æ— æ³•åŒæ­¥è¿”å›è°ƒç”¨è€…æ„Ÿå…´è¶£çš„å€¼ï¼ˆå½“å‰ç‰ˆæœ¬å·ï¼‰ã€‚ç›¸åï¼Œè°ƒç”¨è€…ä¼ é€’äº†ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå½“ç»“æœå‡†å¤‡å°±ç»ªæˆ–å‘ç”Ÿå¼‚å¸¸æ—¶è°ƒç”¨ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè°ƒç”¨æ–¹æä¾›äº†ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œè¯¥å‡½æ•°éœ€è¦ä¸¤ä¸ªå‚æ•°ã€‚å¦‚æœ XMLHttpRequest æ­£å¸¸å·¥ä½œï¼Œåˆ™ getCurrentVersionNumber() ä¼šä½¿ç”¨ null ä¸ºç¬¬ä¸€ä¸ªå®å‚å’Œç‰ˆæœ¬å·ä¸ºç¬¬äºŒä¸ªå®å‚è°ƒç”¨å›è°ƒå‡½æ•°ã€‚æˆ–è€…ï¼Œå¦‚æœå‘ç”Ÿå¼‚å¸¸ï¼Œåˆ™ getCurrentVersionNumber() ä¼šåœ¨ç¬¬ä¸€ä¸ªå®å‚ä¸­å¸¦æœ‰å¼‚å¸¸è¯¦ç»†ä¿¡æ¯ï¼Œè€Œåœ¨ç¬¬äºŒä¸ªå‚æ•°ä¸­ä½¿ç”¨ nullã€‚</p>
</blockquote>
<h3 id="13-1-4-Callbacks-and-Events-in-Node"><a href="#13-1-4-Callbacks-and-Events-in-Node" class="headerlink" title="13.1.4 Callbacks and Events in Node"></a>13.1.4 Callbacks and Events in Node</h3><p>The Node.js server-side JavaScript environment is deeply asynchronous and defines many APIs that use callbacks and events. The default API for reading the contents of a file, for example, is asynchronous and invokes a callback function when the contents of the file have been read:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>); <span class="comment">// The &quot;fs&quot; module has filesystem-related APIs</span></span><br><span class="line"><span class="keyword">let</span> options = &#123;           <span class="comment">// An object to hold options for our program</span></span><br><span class="line">    <span class="comment">// default options would go here</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Read a configuration file, then call the callback function</span></span><br><span class="line">fs.<span class="title function_">readFile</span>(<span class="string">&quot;config.json&quot;</span>, <span class="string">&quot;utf-8&quot;</span>, <span class="function">(<span class="params">err, text</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="comment">// If there was an error, display a warning, but continue</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;Could not read config file:&quot;</span>, err);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Otherwise, parse the file contents and assign to the options object</span></span><br><span class="line">        <span class="title class_">Object</span>.<span class="title function_">assign</span>(options, <span class="title class_">JSON</span>.<span class="title function_">parse</span>(text));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// In either case, we can now start running the program</span></span><br><span class="line">    <span class="title function_">startProgram</span>(options);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Nodeâ€™s fs.readFile() function takes a two-parameter callback as its last argument. It reads the specified file asynchronously and then invokes the callback. If the file was read successfully, it passes the file contents as the second callback argument. If there was an error, it passes the error as the first callback argument. In this example, we express the callback as an arrow function, which is a succinct and natural syntax for this kind of simple operation.</p>
<p>Node also defines a number of event-based APIs. The following function shows how to make an HTTP request for the contents of a URL in Node. It has two layers of asynchronous code handled with event listeners. Notice that Node uses an on() method to register event listeners instead of addEventListener():</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> https = <span class="built_in">require</span>(<span class="string">&quot;https&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Read the text content of the URL and asynchronously pass it to the callback.</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getText</span>(<span class="params">url, callback</span>) &#123;</span><br><span class="line">    <span class="comment">// Start an HTTP GET request for the URL</span></span><br><span class="line">    request = https.<span class="title function_">get</span>(url);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register a function to handle the &quot;response&quot; event.</span></span><br><span class="line">    request.<span class="title function_">on</span>(<span class="string">&quot;response&quot;</span>, <span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// The response event means that response headers have been received</span></span><br><span class="line">        <span class="keyword">let</span> httpStatus = response.<span class="property">statusCode</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The body of the HTTP response has not been received yet.</span></span><br><span class="line">        <span class="comment">// So we register more event handlers to to be called when it arrives.</span></span><br><span class="line">        response.<span class="title function_">setEncoding</span>(<span class="string">&quot;utf-8&quot;</span>);  <span class="comment">// We&#x27;re expecting Unicode text</span></span><br><span class="line">        <span class="keyword">let</span> body = <span class="string">&quot;&quot;</span>;                  <span class="comment">// which we will accumulate here.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// This event handler is called when a chunk of the body is ready</span></span><br><span class="line">        response.<span class="title function_">on</span>(<span class="string">&quot;data&quot;</span>, <span class="function"><span class="params">chunk</span> =&gt;</span> &#123; body += chunk; &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// This event handler is called when the response is complete</span></span><br><span class="line">        response.<span class="title function_">on</span>(<span class="string">&quot;end&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (httpStatus === <span class="number">200</span>) &#123;   <span class="comment">// If the HTTP response was good</span></span><br><span class="line">                <span class="title function_">callback</span>(<span class="literal">null</span>, body);   <span class="comment">// Pass response body to the callback</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;                    <span class="comment">// Otherwise pass an error</span></span><br><span class="line">                <span class="title function_">callback</span>(httpStatus, <span class="literal">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We also register an event handler for lower-level network errors</span></span><br><span class="line">    request.<span class="title function_">on</span>(<span class="string">&quot;error&quot;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">callback</span>(err, <span class="literal">null</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="13-2-Promises"><a href="#13-2-Promises" class="headerlink" title="13.2 Promises"></a>13.2 Promises</h2><p>Now that weâ€™ve seen examples of callback and event-based asynchronous programming in client-side and server-side JavaScript environments, we can introduce Promises, a core language feature designed to simplify asynchronous programming.</p>
<blockquote>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»è§è¿‡äº†å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯ JavaScript ç¯å¢ƒä¸­åŸºäºå›è°ƒå’ŒåŸºäºäº‹ä»¶çš„å¼‚æ­¥ç¼–ç¨‹çš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬æ¥ç€ä»‹ç» Promiseï¼Œè¿™æ˜¯ä¸€ç§æ—¨åœ¨ç®€åŒ–å¼‚æ­¥ç¼–ç¨‹çš„æ ¸å¿ƒè¯­è¨€ç‰¹æ€§ã€‚</p>
</blockquote>
<p>A Promise is an object that represents the result of an asynchronous computation. That result may or may not be ready yet, and the Promise API is intentionally vague about this: there is no way to synchronously get the value of a Promise; you can only ask the Promise to call a callback function when the value is ready. If you are defining an asynchronous API like the getText() function in the previous section, but want to make it Promise-based, omit the callback argument, and instead return a Promise object. The caller can then register one or more callbacks on this Promise object, and they will be invoked when the asynchronous computation is done.</p>
<blockquote>
<p>Promise æ˜¯æè¿°å¼‚æ­¥è®¡ç®—ç»“æœçš„å¯¹è±¡ã€‚è¯¥ç»“æœå¯èƒ½å‡†å¤‡å¥½æˆ–å°šæœªå‡†å¤‡å¥½ï¼ŒPromise API æ•…æ„å¯¹æ­¤å«ç³Šå…¶è¯ï¼šæ— æ³•åŒæ­¥è·å– Promise çš„å€¼ï¼›åªèƒ½è¦æ±‚ promise åœ¨å€¼å‡†å¤‡å¥½æ—¶è°ƒç”¨å›è°ƒå‡½æ•°ã€‚å¦‚æœè¦åƒä¸Šä¸€èŠ‚ä¸­çš„ getText() å‡½æ•°é‚£æ ·å®šä¹‰å¼‚æ­¥ APIï¼Œä½†æƒ³ä½¿å…¶åŸºäº Promiseï¼Œåˆ™çœç•¥ callback å‚æ•°ï¼Œè€Œè¿”å› Promise å¯¹è±¡ã€‚ç„¶åï¼Œè°ƒç”¨è€…å¯ä»¥åœ¨æ­¤ Promise å¯¹è±¡ä¸Šæ³¨å†Œä¸€ä¸ªæˆ–å¤šä¸ªå›è°ƒï¼Œå¹¶ä¸”åœ¨å¼‚æ­¥è®¡ç®—å®Œæˆåå°†è°ƒç”¨å®ƒä»¬ã€‚</p>
</blockquote>
<p>So, at the simplest level, Promises are just a different way of working with callbacks. However, there are practical benefits to using them. One real problem with callback-based asynchronous programming is that it is common to end up with callbacks inside callbacks inside callbacks, with lines of code so highly indented that it is difficult to read. Promises allow this kind of nested callback to be re-expressed as a more linear Promise chain that tends to be easier to read and easier to reason about.</p>
<blockquote>
<p>å› æ­¤ï¼Œæœ€ç®€å•çš„è¯´ï¼Œpromise åªæ˜¯ä½¿ç”¨å›è°ƒçš„å¦ä¸€ç§æ–¹å¼ã€‚ä½†æ˜¯ï¼Œä½¿ç”¨å®ƒæœ‰å®é™…çš„å¥½å¤„ã€‚åŸºäºå›è°ƒçš„å¼‚æ­¥ç¼–ç¨‹çš„ä¸€ä¸ªçœŸæ­£çš„é—®é¢˜æ˜¯ï¼Œé€šå¸¸åœ¨å›è°ƒå†…éƒ¨åµŒå¥—å¤šå±‚å›è°ƒï¼Œå¹¶ä¸”ä»£ç è¡Œç¼©è¿›ç¨‹åº¦å¾ˆé«˜ï¼Œä»¥è‡³äºå¾ˆéš¾é˜…è¯»ã€‚Promise å…è®¸å°†è¿™ç§åµŒå¥—çš„å›è°ƒä½œä¸ºæ›´çº¿æ€§çš„ Promise é“¾é‡æ–°è¡¨è¾¾ï¼Œè¯¥é“¾å¾€å¾€æ›´æ˜“äºé˜…è¯»å’Œæ¨ç†ã€‚</p>
</blockquote>
<p>Another problem with callbacks is that they can make handling errors difficult. If an asynchronous function (or an asynchronously invoked callback) throws an exception, there is no way for that exception to propagate back to the initiator of the asynchronous operation. This is a fundamental fact about asynchronous programming: it breaks exception handling. The alternative is to meticulously track and propagate errors with callback arguments and return values, but this is tedious and difficult to get right. Promises help here by standardizing a way to handle errors and providing a way for errors to propagate correctly through a chain of promises.</p>
<blockquote>
<p>å›è°ƒçš„å¦ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œå®ƒä»¬ä¼šä½¿å¤„ç†å¼‚å¸¸å˜å¾—å›°éš¾ã€‚å¦‚æœå¼‚æ­¥å‡½æ•°ï¼ˆæˆ–å¼‚æ­¥è°ƒç”¨çš„å›è°ƒï¼‰å¼•å‘å¼‚å¸¸ï¼Œåˆ™è¯¥å¼‚å¸¸æ— æ³•ä¼ æ’­å›å¼‚æ­¥æ“ä½œçš„å‘èµ·è€…ã€‚è¿™æ˜¯å…³äºå¼‚æ­¥ç¼–ç¨‹çš„åŸºæœ¬äº‹å®ï¼šå®ƒç ´åäº†å¼‚å¸¸å¤„ç†ã€‚æ›¿ä»£æ–¹æ³•æ˜¯ä½¿ç”¨å›è°ƒå®å‚å’Œè¿”å›å€¼æ¥ç²¾å¿ƒè·Ÿè¸ªå’Œä¼ æ’­å¼‚å¸¸ï¼Œä½†è¿™å¾ˆç¹çä¸”éš¾ä»¥æ­£ç¡®å¤„ç†ã€‚Promise é€šè¿‡æ ‡å‡†åŒ–å¤„ç†å¼‚å¸¸çš„æ–¹å¼ä»¥åŠä¸ºå¼‚å¸¸é€šè¿‡ Promise é“¾æ­£ç¡®ä¼ æ’­çš„æ–¹å¼æä¾›å¸®åŠ©ã€‚</p>
</blockquote>
<p>Note that Promises represent the future results of single asynchronous computations. They cannot be used to represent repeated asynchronous computations, however. Later in this chapter, weâ€™ll write a Promise-based alternative to the setTimeout() function, for example. But we canâ€™t use Promises to replace setInterval() because that function invokes a callback function repeatedly, which is something that Promises are just not designed to do. Similarly, we could use a Promise instead of the â€œloadâ€ event handler of an XMLHttpRequest object, since that callback is only ever called once. But we typically would not use a Promise in place of a â€œclickâ€ event handler of an HTML button object, since we normally want to allow the user to click a button multiple times.</p>
<blockquote>
<p>è¯·æ³¨æ„ï¼Œpromise è¡¨ç¤ºå•ä¸ªå¼‚æ­¥è®¡ç®—çš„æœªæ¥ç»“æœã€‚ä½†æ˜¯ï¼Œå®ƒä¸èƒ½ç”¨äºè¡¨ç¤ºé‡å¤çš„å¼‚æ­¥è®¡ç®—ã€‚ä¾‹å¦‚ï¼Œåœ¨æœ¬ç« çš„åé¢ï¼Œæˆ‘ä»¬å°†å†™ä¸€ä¸ªåŸºäº Promise çš„ setTieout() å‡½æ•°æ›¿ä»£æ–¹æ³•ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬ä¸èƒ½ä½¿ç”¨ Promise æ¥ä»£æ›¿ setInterval()ï¼Œå› ä¸ºè¯¥å‡½æ•°ä¼šåå¤è°ƒç”¨å›è°ƒå‡½æ•°ï¼Œè€Œ Promise å¹¶ä¸æ˜¯ã€‚åŒæ ·ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Promise ä»£æ›¿ XMLHttpRequest å¯¹è±¡çš„â€œloadâ€äº‹ä»¶å¤„ç†ç¨‹åºï¼Œå› ä¸ºè¯¥å›è°ƒä»…è¢«è°ƒç”¨ä¸€æ¬¡ã€‚ä½†æ˜¯æˆ‘ä»¬é€šå¸¸ä¸ä¼šä½¿ç”¨ Promise æ¥ä»£æ›¿ HTML æŒ‰é’®å¯¹è±¡çš„â€œclickâ€äº‹ä»¶å¤„ç†ç¨‹åºï¼Œå› ä¸ºæˆ‘ä»¬é€šå¸¸å¸Œæœ›å…è®¸ç”¨æˆ·å¤šæ¬¡å•å‡»æŒ‰é’®ã€‚</p>
</blockquote>
<p>The subsections that follow will:</p>
<blockquote>
<p>æ¥ä¸‹æ¥çš„å°èŠ‚å°†ï¼š</p>
</blockquote>
<ul>
<li>Explain Promise terminology and show basic Promise usage</li>
<li>Show how promises can be chained</li>
<li>Demonstrate how to create your own Promise-based APIs</li>
</ul>
<blockquote>
<ul>
<li>è§£é‡Š Promise æœ¯è¯­å¹¶æ¼”ç¤º Promise çš„åŸºæœ¬ç”¨æ³•</li>
<li>å±•ç¤ºå¦‚ä½•å°† Promise é“¾æ¥èµ·æ¥</li>
<li>æ¼”ç¤ºå¦‚ä½•åˆ›å»ºè‡ªå·±çš„åŸºäº Promise çš„ API</li>
</ul>
</blockquote>
<h4 id="IMPORTANT"><a href="#IMPORTANT" class="headerlink" title="IMPORTANT"></a>IMPORTANT</h4><p>Promises seem simple at first, and the basic use case for Promises is, in fact, straightforward and simple. But they can become surprisingly confusing for anything beyond the simplest use cases. Promises are a powerful idiom for asynchronous programming, but you need to understand them deeply to use them correctly and confidently. It is worth taking the time to develop that deep understanding, however, and I urge you to study this long chapter carefully.</p>
<blockquote>
<p>Promise ä¸€å¼€å§‹ä¼¼ä¹å¾ˆç®€å•ï¼Œå¹¶ä¸” Promise çš„åŸºæœ¬ç”¨ä¾‹å®é™…ä¸Šä¹Ÿæ˜¯ç®€å•æ˜äº†çš„ã€‚ä½†æ˜¯ï¼Œé™¤äº†æœ€ç®€å•çš„ç”¨ä¾‹ä¹‹å¤–ï¼Œå®ƒä»¬è¿˜ä¼šä½¿å…¶ä»–ä»»ä½•äº‹æƒ…å˜å¾—ä»¤äººå›°æƒ‘ã€‚å¯¹äºå¼‚æ­¥ç¼–ç¨‹ï¼ŒPromise æ˜¯ä¸€ä¸ªå¼ºå¤§çš„ä¹ æƒ¯ç”¨æ³•ï¼Œä½†æ˜¯éœ€è¦æ·±åˆ»ç†è§£å®ƒä»¬ï¼Œæ‰èƒ½æ­£ç¡®ã€è‡ªä¿¡åœ°ä½¿ç”¨å®ƒä»¬ã€‚ä½†æ˜¯ï¼Œå®ƒå€¼å¾—èŠ±æ—¶é—´æ¥æ·±å…¥ç†è§£ï¼Œæˆ‘å»ºè®®ä»”ç»†é˜…è¯»è¿™ä¸€é•¿ç¯‡ç« ã€‚</p>
</blockquote>
<h3 id="13-2-1-Using-Promises"><a href="#13-2-1-Using-Promises" class="headerlink" title="13.2.1 Using Promises"></a>13.2.1 Using Promises</h3><p>With the advent of Promises in the core JavaScript language, web browsers have begun to implement Promise-based APIs. In the previous section, we implemented a getText() function that made an asynchronous HTTP request and passed the body of the HTTP response to a specified callback function as a string. Imagine a variant of this function, getJSON(), which parses the body of the HTTP response as JSON and returns a Promise instead of accepting a callback argument. We will implement a getJSON() function later in this chapter, but for now, letâ€™s look at how we would use this Promise-returning utility function:</p>
<blockquote>
<p>éšç€æ ¸å¿ƒ JavaScript è¯­è¨€ä¸­ Promise çš„å‡ºç°ï¼ŒWeb æµè§ˆå™¨å·²ç»å¼€å§‹å®ç°åŸºäº Promise çš„ APIã€‚åœ¨ä¸Šä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å®ç°äº†ä¸€ä¸ª getText() å‡½æ•°ï¼Œè¯¥å‡½æ•°å‘å‡ºä¸€ä¸ªå¼‚æ­¥ HTTP è¯·æ±‚ï¼Œå¹¶å°† HTTP å“åº”çš„ä¸»ä½“ä½œä¸ºå­—ç¬¦ä¸²ä¼ é€’ç»™æŒ‡å®šçš„å›è°ƒå‡½æ•°ã€‚æƒ³è±¡ä¸€ä¸‹è¯¥å‡½æ•°çš„ä¸€ä¸ªå˜ä½“ getJSON()ï¼Œå®ƒå¯ä»¥è§£æä¸»ä½“ HTTP å“åº”çš„å½¢å¼ä¸º JSONï¼Œå¹¶è¿”å› Promise è€Œä¸æ˜¯æ¥å—å›è°ƒå‚æ•°ã€‚æˆ‘ä»¬å°†åœ¨æœ¬ç« ç¨åå®ç° getJSON() å‡½æ•°ï¼Œä½†ç°åœ¨ï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨è¿”å› Promise åŠŸèƒ½ç¨‹åºå‡½æ•°ï¼š</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">getJSON</span>(url).<span class="title function_">then</span>(<span class="function"><span class="params">jsonData</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// This is a callback function that will be asynchronously</span></span><br><span class="line">    <span class="comment">// invoked with the parsed JSON value when it becomes available.</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>getJSON() starts an asynchronous HTTP request for the URL you specify and then, while that request is pending, it returns a Promise object. The Promise object defines a then() instance method. Instead of passing our callback function directly to getJSON(), we instead pass it to the then() method. When the HTTP response arrives, the body of that response is parsed as JSON, and the resulting parsed value is passed to the function that we passed to then().</p>
<blockquote>
<p>getJSON() å¯¹æŒ‡å®šçš„ URL å¯åŠ¨ä¸€ä¸ªå¼‚æ­¥ HTTP è¯·æ±‚ï¼Œå½“è¯¥è¯·æ±‚å¾…å®šæ—¶ï¼Œå®ƒè¿”å›ä¸€ä¸ª Promise å¯¹è±¡ã€‚Promise å¯¹è±¡å®šä¹‰äº† then() å®ä¾‹æ–¹æ³•ã€‚æˆ‘ä»¬æ²¡æœ‰å°†å›è°ƒå‡½æ•°ç›´æ¥ä¼ é€’ç»™ getJSON()ï¼Œè€Œæ˜¯å°†å…¶ä¼ é€’ç»™ then() æ–¹æ³•ã€‚å½“ HTTP å“åº”æ—¶ï¼Œè¯¥å“åº”çš„ä¸»ä½“å°†è§£æä¸º JSONï¼Œå¹¶å°†æ‰€è§£æçš„ç»“æœå€¼ä¼ ç»™æˆ‘ä»¬ä¼ é€’ç»™ then() çš„å›è°ƒå‡½æ•°ã€‚</p>
</blockquote>
<p>You can think of the then() method as a callback registration method like the addEventListener() method used for registering event handlers in client-side JavaScript. If you call the then() method of a Promise object multiple times, each of the functions you specify will be called when the promised computation is complete.</p>
<blockquote>
<p>å¯ä»¥å°† then() æ–¹æ³•è§†ä¸ºå›è°ƒæ³¨å†Œæ–¹æ³•ï¼Œä¾‹å¦‚ç”¨äºåœ¨å®¢æˆ·ç«¯ JavaScript ä¸­æ³¨å†Œäº‹ä»¶å¤„ç†ç¨‹åºçš„ addEventListener() æ–¹æ³•ã€‚å¦‚æœå¤šæ¬¡è°ƒç”¨ Promise å¯¹è±¡çš„ then() æ–¹æ³•ï¼Œåˆ™åœ¨å®Œæˆ promise çš„è®¡ç®—åå°†è°ƒç”¨æŒ‡å®šçš„æ¯ä¸ªå‡½æ•°ã€‚</p>
</blockquote>
<p>Unlike many event listeners, though, a Promise represents a single computation, and each function registered with then() will be invoked only once. It is worth noting that the function you pass to then() is invoked asynchronously, even if the asynchronous computation is already complete when you call then().</p>
<blockquote>
<p>ä½†æ˜¯ï¼Œä¸è®¸å¤šäº‹ä»¶ä¾¦å¬å™¨ä¸åŒï¼ŒPromise è¡¨ç¤ºå•ä¸ªè®¡ç®—ï¼Œå¹¶ä¸” then() æ³¨å†Œçš„æ¯ä¸ªå‡½æ•°ä»…è¢«è°ƒç”¨ä¸€æ¬¡ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œä¼ é€’ç»™ then() çš„å‡½æ•°æ˜¯å¼‚æ­¥è°ƒç”¨çš„ï¼Œå³ä½¿è°ƒç”¨ then() æ—¶å¼‚æ­¥è®¡ç®—å·²ç»å®Œæˆã€‚</p>
</blockquote>
<p>At a simple syntactical level, the then() method is the distinctive feature of Promises, and it is idiomatic to append .then() directly to the function invocation that returns the Promise, without the intermediate step of assigning the Promise object to a variable.</p>
<blockquote>
<p>åœ¨ç®€å•çš„è¯­æ³•çº§åˆ«ä¸Šï¼Œthen() æ–¹æ³•æ˜¯ Promise ç‹¬æœ‰çš„ç‰¹æ€§ï¼Œç¼–ç ä¸­ä¹ æƒ¯äºå°† .then() ç›´æ¥è·Ÿéšè¿”å› Promise çš„å‡½æ•°ï¼Œè€Œæ— éœ€å°† Promise å¯¹è±¡åˆ†é…ç»™å˜é‡çš„ä¸­é—´æ­¥éª¤ã€‚</p>
</blockquote>
<p>It is also idiomatic to name functions that return Promises and functions that use the results of Promises with verbs, and these idioms lead to code that is particularly easy to read:</p>
<blockquote>
<p>å¸¸ç”¨å¸¦æœ‰åŠ¨è¯å‘½åè¿”å› Promise çš„å‡½æ•°å’Œä½¿ç”¨ Promise ç»“æœçš„å‡½æ•°ï¼Œè¿™äº›å¸¸ç”¨è¯­ä½¿ä»£ç ç‰¹åˆ«å®¹æ˜“é˜…è¯»ï¼š</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Suppose you have a function like this to display a user profile</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">displayUserProfile</span>(<span class="params">profile</span>) &#123; <span class="comment">/* implementation omitted */</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Here&#x27;s how you might use that function with a Promise.</span></span><br><span class="line"><span class="comment">// Notice how this line of code reads almost like an English sentence:</span></span><br><span class="line"><span class="title function_">getJSON</span>(<span class="string">&quot;/api/user/profile&quot;</span>).<span class="title function_">then</span>(displayUserProfile);</span><br></pre></td></tr></table></figure>
<h4 id="HANDLING-ERRORS-WITH-PROMISES"><a href="#HANDLING-ERRORS-WITH-PROMISES" class="headerlink" title="HANDLING ERRORS WITH PROMISES"></a>HANDLING ERRORS WITH PROMISES</h4><p>Asynchronous operations, particularly those that involve networking, can typically fail in a number of ways, and robust code has to be written to handle the errors that will inevitably occur.</p>
<blockquote>
<p>å¼‚æ­¥æ“ä½œï¼Œå°¤å…¶æ˜¯æ¶‰åŠç½‘ç»œçš„å¼‚æ­¥æ“ä½œï¼Œé€šå¸¸ä¼šä»¥å¤šç§æ–¹å¼å¤±è´¥ï¼Œå¹¶ä¸”å¿…é¡»ç¼–å†™å¥å£®çš„ä»£ç æ¥å¤„ç†ä¸å¯é¿å…åœ°ä¼šå‘ç”Ÿçš„å¼‚å¸¸ã€‚</p>
</blockquote>
<p>For Promises, we can do this by passing a second function to the then() method:</p>
<blockquote>
<p>å¯¹äº Promiseï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å°†ç¬¬äºŒä¸ªå‡½æ•°ä¼ é€’ç»™ then() æ–¹æ³•æ¥å®ç°ï¼š</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">getJSON</span>(<span class="string">&quot;/api/user/profile&quot;</span>).<span class="title function_">then</span>(displayUserProfile, handleProfileError);</span><br></pre></td></tr></table></figure>
<p>A Promise represents the future result of an asynchronous computation that occurs after the Promise object is created. Because the computation is performed after the Promise object is returned to us, there is no way that the computation can traditionally return a value or throw an exception that we can catch. The functions that we pass to then() provide alternatives. When a synchronous computation completes normally, it simply returns its result to its caller. When a Promise-based asynchronous computation completes normally, it passes its result to the function that is the first argument to then().</p>
<blockquote>
<p>Promise æè¿°åœ¨ Promise å¯¹è±¡åˆ›å»ºä¹‹åå‘ç”Ÿçš„å¼‚æ­¥è®¡ç®—çš„æœªæ¥ç»“æœã€‚ç”±äºè®¡ç®—æ˜¯åœ¨ Promise å¯¹è±¡è¿”å›ç»™æˆ‘ä»¬ä¹‹åæ‰§è¡Œçš„ï¼Œå› æ­¤è¯¥è®¡ç®—æ— æ³•ä¼ ç»Ÿåœ°è¿”å›å€¼æˆ–å¼•å‘æˆ‘ä»¬å¯ä»¥æ•è·çš„å¼‚å¸¸ã€‚æˆ‘ä»¬ä¼ é€’ç»™ then() çš„å‡½æ•°æä¾›äº†æ›¿ä»£æ–¹æ¡ˆã€‚å½“åŒæ­¥è®¡ç®—æ­£å¸¸å®Œæˆæ—¶ï¼Œå®ƒä»…å°†å…¶ç»“æœè¿”å›ç»™å…¶è°ƒç”¨è€…ã€‚å½“åŸºäº Promise çš„å¼‚æ­¥è®¡ç®—æ­£å¸¸å®Œæˆæ—¶ï¼Œå®ƒå°†å…¶ç»“æœä¼ é€’ç»™ then() çš„ç¬¬ä¸€ä¸ªå®å‚å‡½æ•°ã€‚</p>
</blockquote>
<p>When something goes wrong in a synchronous computation, it throws an exception that propagates up the call stack until there is a catch clause to handle it. When an asynchronous computation runs, its caller is no longer on the stack, so if something goes wrong, it is simply not possible to throw an exception back to the caller.</p>
<blockquote>
<p>å½“åŒæ­¥è®¡ç®—ä¸­å‡ºç°é—®é¢˜æ—¶ï¼Œå®ƒå°†å¼•å‘ä¸€ä¸ªå¼‚å¸¸ï¼Œè¯¥å¼‚å¸¸ä¼šæ²¿è°ƒç”¨å †æ ˆä¼ æ’­ï¼Œç›´åˆ°æœ‰ä¸€ä¸ª catch å­å¥æ¥å¤„ç†å®ƒä¸ºæ­¢ã€‚å½“å¼‚æ­¥è®¡ç®—è¿è¡Œæ—¶ï¼Œå®ƒçš„è°ƒç”¨è€…ä¸å†åœ¨å †æ ˆä¸Šï¼Œå› æ­¤ï¼Œå¦‚æœå‡ºç°é—®é¢˜ï¼Œåˆ™æ ¹æœ¬ä¸å¯èƒ½å°†å¼‚å¸¸æŠ›å‡ºç»™è°ƒç”¨è€…ã€‚</p>
</blockquote>
<p>Instead, Promise-based asynchronous computations pass the exception (typically as an Error object of some kind, though this is not required) to the second function passed to then(). So, in the code above, if getJSON() runs normally, it passes its result to displayUserProfile(). If there is an error (the user is not logged in, the server is down, the userâ€™s internet connection dropped, the request timed out, etc.), then getJSON() passes an Error object to handleProfileError().</p>
<blockquote>
<p>è€ŒåŸºäº Promise çš„å¼‚æ­¥è®¡ç®—å°†å¼‚å¸¸ï¼ˆé€šå¸¸æ˜¯æŸç§ Error å¯¹è±¡ï¼Œå°½ç®¡è¿™ä¸æ˜¯å¿…éœ€çš„ï¼‰ä¼ é€’ç»™ then() çš„ç¬¬äºŒä¸ªå‡½æ•°ã€‚å› æ­¤ï¼Œåœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œå¦‚æœ getJSON() æ­£å¸¸è¿è¡Œï¼Œå®ƒå°†å…¶ç»“æœä¼ é€’ç»™ displayUserProfile()ã€‚å¦‚æœå‡ºç°å¼‚å¸¸ï¼ˆç”¨æˆ·æœªç™»å½•ï¼ŒæœåŠ¡å™¨å…³é—­ï¼Œç”¨æˆ·çš„ Internet è¿æ¥æ–­å¼€ï¼Œè¯·æ±‚è¶…æ—¶ç­‰ï¼‰ï¼Œåˆ™ getJSON() ä¼šå°† Error å¯¹è±¡ä¼ é€’ç»™ handleProfileError()ã€‚</p>
</blockquote>
<p>In practice, it is rare to see two functions passed to then(). There is a better and more idiomatic way of handling errors when working with Promises. To understand it, first consider what happens if getJSON() completes normally but an error occurs in displayUserProfile(). That callback function is invoked asynchronously when getJSON() returns, so it is also asynchronous and cannot meaningfully throw an exception (because there is no code on the call stack to handle it).</p>
<blockquote>
<p>å®è·µä¸­ï¼Œå¾ˆå°‘æœ‰ä¸¤ä¸ªå‡½æ•°ä¼ é€’ç»™ then()ã€‚åœ¨å¤„ç† Promise æ—¶ï¼Œæœ‰ä¸€ç§æ›´å¥½æ›´å¸¸ç”¨çš„å¼‚å¸¸å¤„ç†æ–¹å¼ã€‚ä¸ºäº†ç†è§£å®ƒï¼Œé¦–å…ˆè€ƒè™‘å¦‚æœ getJSON() æ­£å¸¸å®Œæˆä½† displayUserProfile() ä¸­å‘ç”Ÿå¼‚å¸¸è¯¥æ€ä¹ˆåŠã€‚å½“ getJSON() è¿”å›æ—¶ï¼Œè¯¥å›è°ƒå‡½æ•°å°†å¼‚æ­¥è°ƒç”¨ï¼Œå› æ­¤å®ƒä¹Ÿæ˜¯å¼‚æ­¥çš„ï¼Œå¹¶ä¸”æ— æ³•æœ‰æ„ä¹‰åœ°å¼•å‘å¼‚å¸¸ï¼ˆå› ä¸ºè°ƒç”¨å †æ ˆä¸Šæ²¡æœ‰ä»£ç å¯ä»¥å¤„ç†è¯¥å¼‚å¸¸ï¼‰ã€‚</p>
</blockquote>
<p>The more idiomatic way to handle errors in this code looks like this:</p>
<blockquote>
<p>å¦‚ä¸‹æ‰€ç¤ºï¼Œå¤„ç†æ­¤ä»£ç ä¸­å¼‚å¸¸çš„æ›´å¸¸ç”¨æ–¹å¼ï¼š</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">getJSON</span>(<span class="string">&quot;/api/user/profile&quot;</span>).<span class="title function_">then</span>(displayUserProfile).<span class="title function_">catch</span>(handleProfileError);</span><br></pre></td></tr></table></figure>
<p>With this code, a normal result from getJSON() is still passed to displayUserProfile(), but any error in getJSON() or in displayUserProfile() (including any exceptions thrown by displayUserProfile) get passed to handleProfileError(). The catch() method is just a shorthand for calling then() with a null first argument and the specified error handler function as the second argument.</p>
<blockquote>
<p>ä½¿ç”¨æ­¤ä»£ç ï¼ŒgetJSON() çš„æ­£å¸¸ç»“æœä»ä¼šä¼ é€’ç»™ displayUserProfile()ï¼Œä½†æ˜¯ getJSON() æˆ– displayUserProfile() ä¸­çš„ä»»ä½•å¼‚å¸¸ï¼ˆåŒ…æ‹¬ displayUserProfile æŠ›å‡ºçš„ä»»ä½•å¼‚å¸¸ï¼‰éƒ½å°†ä¼ é€’ç»™ handleProfileError()ã€‚è°ƒç”¨ then() ç¬¬ä¸€ä¸ªå®å‚ä¸ºç©ºï¼ŒæŒ‡å®šçš„å¼‚å¸¸å¤„ç†å‡½æ•°ä¸ºç¬¬äºŒä¸ªå®å‚ï¼Œcatch() æ–¹æ³•åªæ˜¯å…¶ç®€å†™ã€‚</p>
</blockquote>
<p>Weâ€™ll have more to say about catch() and this error-handling idiom when we discuss Promise chains in the next section.</p>
<blockquote>
<p>åœ¨ä¸‹ä¸€èŠ‚ä¸­è®¨è®º Promise é“¾æ—¶ï¼Œæˆ‘ä»¬å°†å¯¹ catch() å’Œè¿™ä¸ªå¤„ç†å¼‚å¸¸å¸¸ç”¨æ–¹æ³•ä½œæ›´å¤šçš„è¯´æ˜ã€‚</p>
</blockquote>
<h4 id="PROMISE-TERMINOLOGY"><a href="#PROMISE-TERMINOLOGY" class="headerlink" title="PROMISE TERMINOLOGY"></a>PROMISE TERMINOLOGY</h4><p>Before we discuss Promises further, it is worth pausing to define some terms. When we are not programming and we talk about human promises, we say that a promise is â€œkeptâ€ or â€œbroken.â€ When discussing JavaScript Promises, the equivalent terms are â€œfulfilledâ€ and â€œrejected.â€ Imagine that you have called the then() method of a Promise and have passed two callback functions to it. We say that the promise has been fulfilled if and when the first callback is called. And we say that the Promise has been rejected if and when the second callback is called. If a Promise is neither fulfilled nor rejected, then it is pending. And once a promise is fulfilled or rejected, we say that it is settled. Note that a Promise can never be both fulfilled and rejected. Once a Promise settles, it will never change from fulfilled to rejected or vice versa.</p>
<blockquote>
<p>åœ¨æˆ‘ä»¬è¿›ä¸€æ­¥è®¨è®º Promises ä¹‹å‰ï¼Œéœ€è¦æš‚åœå®šä¹‰ä¸€äº›æœ¯è¯­ã€‚ç°å®ç”Ÿæ´»ä¸­ï¼Œæˆ‘ä»¬è®¨è®ºä¸‹äººç±»çš„è¯ºè¨€ï¼Œæˆ‘ä»¬è¯´â€œä¿¡å®ˆâ€æˆ–â€œè¿èƒŒâ€è¯ºè¨€ã€‚åœ¨è®¨è®º JavaScript Promise æ—¶ï¼Œç”¨â€œå·²å…‘ç°ï¼ˆfulfilledï¼‰â€å’Œâ€œå·²æ‹’ç»ï¼ˆrejectedï¼‰â€ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œå·²ç»è°ƒç”¨äº† Promise çš„ then() æ–¹æ³•ï¼Œå¹¶å‘å…¶ä¼ é€’äº†ä¸¤ä¸ªå›è°ƒå‡½æ•°ã€‚å½“è°ƒç”¨ç¬¬ä¸€ä¸ªå›è°ƒï¼Œé‚£ä¹ˆæˆ‘ä»¬è¯´ Promise å·²å…‘ç°ã€‚å½“è°ƒç”¨ç¬¬äºŒä¸ªå›è°ƒï¼Œæˆ‘ä»¬åˆ™è¯´ Promise å·²è¢«æ‹’ç»ã€‚å¦‚æœä¸€ä¸ª Promise æ—¢ä¸æ˜¯å·²å…‘ç°ä¹Ÿä¸æ˜¯å·²æ‹’ç»ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯å¾…å®šï¼ˆpendingï¼‰ã€‚ä¸€æ—¦ Promise å·²å…‘ç°æˆ–å·²æ‹’ç»ï¼Œæˆ‘ä»¬å°±è¯´å®ƒå·²æ•²å®šï¼ˆsettledï¼‰ã€‚è¯·æ³¨æ„ï¼Œä¸€ä¸ª Promise æ°¸è¿œä¸ä¼šåŒæ—¶å·²å…‘ç°å’Œå·²æ‹’ç»ã€‚Promise ä¸€æ—¦æ•²å®šï¼Œå°±æ°¸è¿œä¸ä¼šä»å·²å…‘ç°å˜ä¸ºå·²æ‹’ç»ï¼Œåä¹‹äº¦ç„¶ã€‚</p>
</blockquote>
<p>Remember how we defined Promises at the start of this section: â€œa Promise is an object that represents the result of an asynchronous operation.â€ It is important to remember that Promises are not just abstract ways registering callbacks to run when some async code finishesâ€”they represent the results of that async code. If the async code runs normally (and the Promise is fulfilled), then that result is essentially the return value of the code. And if the async code does not complete normally (and the Promise is rejected), then the result is an Error object or some other value that the code might have thrown if it was not asynchronous. Any Promise that has settled has a value associated with it, and that value will not change. If the Promise is fulfilled, then the value is a return value that gets passed to any callback functions registered as the first argument of then(). If the Promise is rejected, then the value is an error of some sort that is passed to any callback functions registered with catch() or as the second argument of then().</p>
<blockquote>
<p>è®°ä½æˆ‘ä»¬åœ¨æœ¬èŠ‚å¼€å§‹æ—¶å¦‚ä½•å®šä¹‰ Promiseï¼šâ€œPromise æ˜¯æè¿°å¼‚æ­¥è®¡ç®—ç»“æœçš„å¯¹è±¡ã€‚â€é‡è¦çš„æ˜¯è¦è®°ä½ï¼ŒPromise ä¸ä»…ä»…æ˜¯æ³¨å†Œåœ¨æŸäº›å¼‚æ­¥ä»£ç å®Œæˆæ—¶è¿è¡Œçš„å›è°ƒçš„æŠ½è±¡æ–¹å¼ï¼Œå®ƒä»¬è¿˜æè¿°äº†å¼‚æ­¥ä»£ç çš„ç»“æœã€‚å¦‚æœå¼‚æ­¥ä»£ç æ­£å¸¸è¿è¡Œï¼ˆå¹¶ä¸” Promise å·²å…‘ç°ï¼‰ï¼Œé‚£ä¹ˆè¯¥ç»“æœå®è´¨ä¸Šå°±æ˜¯ä»£ç çš„è¿”å›å€¼ã€‚è€Œä¸”ï¼Œå¦‚æœå¼‚æ­¥ä»£ç æ— æ³•æ­£å¸¸å®Œæˆï¼ˆå¹¶ä¸” Promise å·²æ‹’ç»ï¼‰ï¼Œé‚£ä¹ˆç»“æœå°†æ˜¯ Error å¯¹è±¡æˆ–å…¶ä»–ä¸æ˜¯å¼‚æ­¥çš„ä»£ç å¯èƒ½ä¼šæŠ›å‡ºçš„å€¼ã€‚ä»»ä½•å·²æ•²å®šçš„ Promise éƒ½æœ‰ä¸å…¶ç›¸å…³çš„å€¼ï¼Œå¹¶ä¸”è¯¥å€¼ä¸ä¼šæ”¹å˜ã€‚å¦‚æœ Promise å·²å…‘ç°ï¼Œåˆ™è¯¥å€¼æ˜¯ä¸€ä¸ªè¿”å›å€¼ï¼Œè¯¥å€¼å°†ä¼ é€’ç»™æ³¨å†Œä¸º then() ç¬¬ä¸€ä¸ªå®å‚çš„å›è°ƒå‡½æ•°ã€‚å¦‚æœ Promise å·²æ‹’ç»ï¼Œåˆ™è¯¥å€¼æ˜¯æŸç§å¼‚å¸¸ï¼Œè¯¥å¼‚å¸¸ä¼šä¼ é€’ç»™ä½¿ç”¨ catch() æˆ– then() çš„ç¬¬äºŒä¸ªå®å‚æ³¨å†Œçš„å›è°ƒå‡½æ•°ã€‚</p>
</blockquote>
<p>The reason that I want to be precise about Promise terminology is that Promises can also be resolved. It is easy to confuse this resolved state with the fulfilled state or with settled state, but it is not precisely the same as either. Understanding the resolved state is one of the keys to a deep understanding of Promises, and Iâ€™ll come back to it after weâ€™ve discussed Promise chains below.</p>
<blockquote>
<p>æˆ‘å¸Œæœ›å¯¹ Promise æœ¯è¯­ä¿æŒç²¾ç¡®çš„åŸå› æ˜¯ Promise è¿˜å¯ä»¥è¢«å†³è®®ã€‚å°†å·²å†³è®®çŠ¶æ€ä¸å·²å…‘ç°çŠ¶æ€æˆ–å·²æ•²å®šçŠ¶æ€æ··æ·†æ˜¯å¾ˆå®¹æ˜“çš„ï¼Œä½†æ˜¯ä¸‰è€…éƒ½ä¸å®Œå…¨ç›¸åŒã€‚ç†è§£å·²å†³è®®çŠ¶æ€æ˜¯æ·±å…¥äº†è§£ Promise çš„å…³é”®ä¹‹ä¸€ï¼Œåœ¨ä¸‹é¢è®¨è®ºäº† Promise é“¾ä¹‹åï¼Œæˆ‘å°†å†æ¬¡ä»‹ç»å®ƒã€‚</p>
</blockquote>
<h3 id="13-2-2-Chaining-Promises"><a href="#13-2-2-Chaining-Promises" class="headerlink" title="13.2.2 Chaining Promises"></a>13.2.2 Chaining Promises</h3><p>One of the most important benefits of Promises is that they provide a natural way to express a sequence of asynchronous operations as a linear chain of then() method invocations, without having to nest each operation within the callback of the previous one. Here, for example, is a hypothetical Promise chain:</p>
<blockquote>
<p>Promise çš„æœ€é‡è¦çš„å¥½å¤„ä¹‹ä¸€æ˜¯ï¼Œå®ƒä»¬æä¾›äº†ä¸€ç§è‡ªç„¶çš„æ–¹å¼æ¥è¡¨è¾¾ä¸€ç³»åˆ—å¼‚æ­¥æ“ä½œï¼Œè¡¨ç¤º then() æ–¹æ³•è°ƒç”¨çš„çº¿æ€§é“¾ï¼Œè€Œä¸å¿…å°†æ¯ä¸ªæ“ä½œåµŒå¥—åœ¨å‰ä¸€ä¸ªå›è°ƒä¸­ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªå‡è®¾çš„ Promise é“¾ï¼š</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">fetch</span>(documentURL)                      <span class="comment">// Make an HTTP request</span></span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> response.<span class="title function_">json</span>())  <span class="comment">// Ask for the JSON body of the response</span></span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">document</span> =&gt;</span> &#123;                 <span class="comment">// When we get the parsed JSON</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">render</span>(<span class="variable language_">document</span>);        <span class="comment">// display the document to the user</span></span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">rendered</span> =&gt;</span> &#123;                 <span class="comment">// When we get the rendered document</span></span><br><span class="line">        <span class="title function_">cacheInDatabase</span>(rendered);      <span class="comment">// cache it in the local database.</span></span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> <span class="title function_">handle</span>(error));     <span class="comment">// Handle any errors that occur</span></span><br></pre></td></tr></table></figure>
<p>This code illustrates how a chain of Promises can make it easy to express a sequence of asynchronous operations. Weâ€™re not going to discuss this particular Promise chain at all, however. We will continue to explore the idea of using Promise chains to make HTTP requests, however.</p>
<blockquote>
<p>æ­¤ä»£ç è¡¨æ˜äº† Promise é“¾å¦‚ä½•ç®€åŒ–ä¸€ç³»åˆ—å¼‚æ­¥æ“ä½œã€‚æˆ‘ä»¬ä¸ä¼šè®¨è®ºè¿™ä¸ªç‰¹æ®Šçš„ Promise é“¾ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬å°†ç»§ç»­æ¢ç´¢ä½¿ç”¨ Promise é“¾å‘å‡º HTTP è¯·æ±‚çš„æƒ³æ³•ã€‚ </p>
</blockquote>
<p>Earlier in this chapter, we saw the XMLHttpRequest object used to make an HTTP request in JavaScript. That strangely named object has an old and awkward API, and it has largely been replaced by the newer, Promise-based Fetch API (Â§15.11.1). In its simplest form, this new HTTP API is just the function fetch(). You pass it a URL, and it returns a Promise. That promise is fulfilled when the HTTP response begins to arrive and the HTTP status and headers are available:</p>
<blockquote>
<p>åœ¨æœ¬ç« çš„å‰é¢ï¼Œæˆ‘ä»¬çœ‹åˆ°äº† XMLHttpRequest å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ç”¨äºåœ¨ JavaScript ä¸­å‘å‡º HTTP è¯·æ±‚ã€‚è¿™ä¸ªå¥‡æ€ªå‘½åçš„å¯¹è±¡å…·æœ‰ä¸€ä¸ªæ—§ä¸”ç¬¨æ‹™çš„ APIï¼Œå¹¶ä¸”åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šå·²è¢«è¾ƒæ–°çš„åŸºäº Promise çš„ Fetch APIï¼ˆÂ§15.11.1ï¼‰æ‰€å–ä»£ã€‚ä»¥æœ€ç®€å•çš„å½¢å¼ï¼Œè¿™ä¸ªæ–°çš„ HTTP API åªæ˜¯ fetch() å‡½æ•°ã€‚ç»™å®ƒä¼ é€’ä¸€ä¸ª URLï¼Œç„¶åè¿”å›ä¸€ä¸ª Promiseã€‚å½“ HTTP å¼€å§‹æ”¶åˆ°å“åº”å¹¶ä¸” HTTP çŠ¶æ€å’Œæ ‡å¤´å¯ç”¨æ—¶ï¼Œè¿™ä¸ª promise å·²å…‘ç°ï¼š</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">fetch</span>(<span class="string">&quot;/api/user/profile&quot;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// When the promise resolves, we have status and headers</span></span><br><span class="line">    <span class="keyword">if</span> (response.<span class="property">ok</span> &amp;&amp;</span><br><span class="line">        response.<span class="property">headers</span>.<span class="title function_">get</span>(<span class="string">&quot;Content-Type&quot;</span>) === <span class="string">&quot;application/json&quot;</span>) &#123;</span><br><span class="line">        <span class="comment">// What can we do here? We don&#x27;t actually have the response body yet.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>When the Promise returned by fetch() is fulfilled, it passes a Response object to the function you passed to its then() method. This response object gives you access to request status and headers, and it also defines methods like text() and json(), which give you access to the body of the response in text and JSON-parsed forms, respectively. But although the initial Promise is fulfilled, the body of the response may not yet have arrived. So these text() and json() methods for accessing the body of the response themselves return Promises. Hereâ€™s a naive way of using fetch() and the response.json() method to get the body of an HTTP response:</p>
<blockquote>
<p>å½“ fetch() è¿”å›çš„ Promise å·²å…‘ç°æ—¶ï¼Œå®ƒå°† Response å¯¹è±¡ä¼ é€’ç»™ä¼ é€’ç»™ then() æ–¹æ³•çš„å‡½æ•°ã€‚æ­¤å“åº”å¯¹è±¡å¯ä»¥è®¿é—®è¯·æ±‚çŠ¶æ€å’Œæ ‡å¤´ï¼Œå¹¶ä¸”è¿˜å®šä¹‰äº†è¯¸å¦‚ text() å’Œ json() ä¹‹ç±»çš„æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•å¯ä»¥åˆ†åˆ«ä»¥æ–‡æœ¬å’Œ JSON çš„å½¢å¼è®¿é—®å“åº”çš„æ­£æ–‡ã€‚ä½†æ˜¯ï¼Œå°½ç®¡æœ€åˆçš„ Promise å·²å…‘ç°ï¼Œä½†å“åº”çš„ä¸»ä½“å¯èƒ½å°šæœªåˆ°è¾¾ã€‚å› æ­¤ï¼Œè¿™äº›ç”¨äºè®¿é—®å“åº”æ­£æ–‡çš„ text() å’Œ json() æ–¹æ³•æœ¬èº«è¿”å› Promiseã€‚è¿™æ˜¯ä½¿ç”¨ fetch() å’Œ response.json() æ–¹æ³•è·å– HTTP Response å“åº”æ­£æ–‡çš„ä¸€ç§ç®€å•æ–¹æ³•ï¼š </p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">fetch</span>(<span class="string">&quot;/api/user/profile&quot;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">    response.<span class="title function_">json</span>().<span class="title function_">then</span>(<span class="function"><span class="params">profile</span> =&gt;</span> &#123;  <span class="comment">// Ask for the JSON-parsed body</span></span><br><span class="line">        <span class="comment">// When the body of the response arrives, it will be automatically</span></span><br><span class="line">        <span class="comment">// parsed as JSON and passed to this function.</span></span><br><span class="line">        <span class="title function_">displayUserProfile</span>(profile);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>This is a naive way to use Promises because we nested them, like callbacks, which defeats the purpose. The preferred idiom is to use Promises in a sequential chain with code like this:</p>
<blockquote>
<p>è¿™æ˜¯ Promise ä¸€ç§æ²¡ç»éªŒçš„ä½¿ç”¨æ–¹å¼ï¼Œå› ä¸ºæˆ‘ä»¬åƒå›è°ƒä¸€æ ·åµŒå¥—äº†å®ƒä»¬ï¼Œè¿™è¿èƒŒäº†ç›®çš„ã€‚é¦–é€‰å¸¸ç”¨æ–¹æ³•æ˜¯åœ¨é¡ºåºé“¾ä¸­ä½¿ç”¨ Promiseï¼Œå…¶ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š </p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">fetch</span>(<span class="string">&quot;/api/user/profile&quot;</span>)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> response.<span class="title function_">json</span>();</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">profile</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">displayUserProfile</span>(profile);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<p>Letâ€™s look at the method invocations in this code, ignoring the arguments that are passed to the methods:</p>
<blockquote>
<p>è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™æ®µä»£ç ä¸­çš„æ–¹æ³•è°ƒç”¨ï¼Œå¿½ç•¥ä¼ é€’ç»™æ–¹æ³•çš„å‚æ•°ï¼š </p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">fetch</span>().<span class="title function_">then</span>().<span class="title function_">then</span>()</span><br></pre></td></tr></table></figure>
<p>When more than one method is invoked in a single expression like this, we call it a method chain. We know that the fetch() function returns a Promise object, and we can see that the first .then() in this chain invokes a method on that returned Promise object. But there is a second .then() in the chain, which means that the first invocation of the then() method must itself return a Promise.</p>
<blockquote>
<p>å½“åƒè¿™æ ·åœ¨å•ä¸ªè¡¨è¾¾å¼ä¸­è°ƒç”¨å¤šä¸ªæ–¹æ³•æ—¶ï¼Œæˆ‘ä»¬å°†å…¶ç§°ä¸ºæ–¹æ³•é“¾ã€‚æˆ‘ä»¬çŸ¥é“ fetch() å‡½æ•°è¿”å›ä¸€ä¸ª Promise å¯¹è±¡ï¼Œå¹¶ä¸”å¯ä»¥çœ‹åˆ°è¯¥é“¾ä¸­çš„ç¬¬ä¸€ä¸ª .then() ä½œä¸ºè¿”å›çš„ Promise å¯¹è±¡çš„æ–¹æ³•è°ƒç”¨ã€‚ä½†æ˜¯é“¾ä¸­è¿˜æœ‰ç¬¬äºŒä¸ª .then()ï¼Œè¿™æ„å‘³ç€ then() æ–¹æ³•çš„ç¬¬ä¸€æ¬¡è°ƒç”¨æœ¬èº«ä¸€å®šè¿”å› Promiseã€‚</p>
</blockquote>
<p>Sometimes, when an API is designed to use this kind of method chaining, there is just a single object, and each method of that object returns the object itself in order to facilitate chaining. That is not how Promises work, however. When we write a chain of .then() invocations, we are not registering multiple callbacks on a single Promise object. Instead, each invocation of the then() method returns a new Promise object. That new Promise object is not fulfilled until the function passed to then() is complete.</p>
<blockquote>
<p>æœ‰æ—¶ï¼Œå½“ä¸€ä¸ª API è®¾è®¡ä¸ºä½¿ç”¨è¿™ç§æ–¹æ³•é“¾æ¥æ—¶ï¼Œåªæœ‰ä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶ä¸”è¯¥å¯¹è±¡çš„æ¯ä¸ªæ–¹æ³•éƒ½è¿”å›è¯¥å¯¹è±¡æœ¬èº«ä»¥ä¾¿äºé“¾æ¥ã€‚ä½†æ˜¯ï¼Œè¿™ä¸æ˜¯ Promise çš„å·¥ä½œæ–¹å¼ã€‚å½“æˆ‘ä»¬ç¼–å†™ä¸€ç³»åˆ—çš„ .then() è°ƒç”¨æ—¶ï¼Œæˆ‘ä»¬å¹¶æœªåœ¨å•ä¸ª Promise å¯¹è±¡ä¸Šæ³¨å†Œå¤šä¸ªå›è°ƒã€‚è€Œæ˜¯ï¼Œå¯¹ then() æ–¹æ³•çš„æ¯æ¬¡è°ƒç”¨éƒ½ä¼šè¿”å›ä¸€ä¸ªæ–°çš„ Promise å¯¹è±¡ã€‚åœ¨ä¼ é€’ç»™ then() çš„å‡½æ•°å®Œæˆä¹‹å‰ï¼Œæ–°çš„ Promise å¯¹è±¡ä¸ä¼šè¢«å…‘ç°ã€‚</p>
</blockquote>
<p>Letâ€™s return to a simplified form of the original fetch() chain above. If we define the functions passed to the then() invocations elsewhere, we might refactor the code to look like this:</p>
<blockquote>
<p>è®©æˆ‘ä»¬å›åˆ°ä¸Šé¢åŸå§‹ fetch() é“¾çš„ç®€åŒ–å½¢å¼ã€‚å¦‚æœæˆ‘ä»¬åœ¨å…¶ä»–åœ°æ–¹å®šä¹‰ä¼ é€’ç»™ then() è°ƒç”¨çš„å‡½æ•°ï¼Œåˆ™å¯ä»¥å°†ä»£ç é‡æ„ä¸ºå¦‚ä¸‹å½¢å¼ï¼š</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">fetch</span>(theURL)          <span class="comment">// task 1; returns promise 1</span></span><br><span class="line">    .<span class="title function_">then</span>(callback1)   <span class="comment">// task 2; returns promise 2</span></span><br><span class="line">    .<span class="title function_">then</span>(callback2);  <span class="comment">// task 3; returns promise 3</span></span><br></pre></td></tr></table></figure>
<p>Letâ€™s walk through this code in detail:</p>
<blockquote>
<p>è®©æˆ‘ä»¬è¯¦ç»†ä»‹ç»è¿™æ®µä»£ç ï¼š</p>
</blockquote>
<ol>
<li>On the first line, fetch() is invoked with a URL. It initiates an HTTP GET request for that URL and returns a Promise. Weâ€™ll call this HTTP request â€œtask 1â€ and weâ€™ll call the Promise â€œpromise 1â€.</li>
<li>On the second line, we invoke the then() method of promise 1, passing the callback1 function that we want to be invoked when promise 1 is fulfilled. The then() method stores our callback somewhere, then returns a new Promise. Weâ€™ll call the new Promise returned at this step â€œpromise 2â€, and weâ€™ll say that â€œtask 2â€ begins when callback1 is invoked.</li>
<li>On the third line, we invoke the then() method of promise 2, passing the callback2 function we want invoked when promise 2 is fulfilled. This then() method remembers our callback and returns yet another Promise. Weâ€™ll say that â€œtask 3â€ begins when callback2 is invoked. We can call this latest Promise â€œpromise 3â€, but we donâ€™t really need a name for it because we wonâ€™t be using it at all.</li>
<li>The previous three steps all happen synchronously when the expression is first executed. Now we have an asynchronous pause while the HTTP request initiated in step 1 is sent out across the internet.</li>
<li>Eventually, the HTTP response starts to arrive. The asynchronous part of the fetch() call wraps the HTTP status and headers in a Response object and fulfills promise 1 with that Response object as the value.</li>
<li>When promise 1 is fulfilled, its value (the Response object) is passed to our callback1() function, and task 2 begins. The job of this task, given a Response object as input, is to obtain the response body as a JSON object.</li>
<li>Letâ€™s assume that task 2 completes normally and is able to parse the body of the HTTP response to produce a JSON object. This JSON object is used to fulfill promise 2.</li>
<li>The value that fulfills promise 2 becomes the input to task 3 when it is passed to the callback2() function. This third task now displays the data to the user in some unspecified way. When task 3 is complete (assuming it completes normally), then promise 3 will be fulfilled. But because we never did anything with promise 3, nothing happens when that Promise settles, and the chain of asynchronous computation ends at this point.</li>
</ol>
<blockquote>
<ol>
<li>åœ¨ç¬¬ä¸€è¡Œï¼Œä½¿ç”¨ URL è°ƒç”¨ fetch()ã€‚å®ƒé’ˆå¯¹è¯¥ URL å‘èµ· HTTP GETè¯·æ±‚å¹¶è¿”å› Promiseã€‚æˆ‘ä»¬å°†è¿™ä¸ª HTTP è¯·æ±‚ç§°ä¸ºâ€œtask 1â€ï¼Œå°† Promise ç§°ä¸ºâ€œpromise 1â€ã€‚</li>
<li>åœ¨ç¬¬äºŒè¡Œï¼Œæˆ‘ä»¬è°ƒç”¨ promise 1 çš„ then() æ–¹æ³•ï¼Œå¹¶ä¼ é€’ promise 1 åœ¨å·²å…‘ç°æ—¶è¦è°ƒç”¨çš„ callback1 å‡½æ•°ã€‚then() æ–¹æ³•å°†å›è°ƒå‡½æ•°å­˜å‚¨åœ¨æŸä¸ªä½ç½®ï¼Œç„¶åè¿”å›ä¸€ä¸ªæ–°çš„ Promiseã€‚æˆ‘ä»¬å°†åœ¨è¿™ä¸€æ­¥è¿”å›çš„æ–° Promise ç§°ä¸ºâ€œpromise 2â€ï¼Œå¹¶ä¸”æˆ‘ä»¬è¯´å½“ callback1 è¢«è°ƒç”¨æ—¶â€œtask 2â€å¼€å§‹ã€‚</li>
<li>åœ¨ç¬¬ä¸‰è¡Œï¼Œæˆ‘ä»¬è°ƒç”¨ promise 2 çš„ then() æ–¹æ³•ï¼Œå¹¶ä¼ é€’ promise 2 åœ¨å·²å…‘ç°æ—¶è¦è°ƒç”¨çš„ callback2 å‡½æ•°ã€‚è¿™ä¸ª then() æ–¹æ³•ä¼šè®°ä½æˆ‘ä»¬çš„å›è°ƒå¹¶è¿”å›å¦ä¸€ä¸ª Promiseã€‚æˆ‘ä»¬è¯´â€œtask 3â€æ˜¯åœ¨è°ƒç”¨ callback2 æ—¶å¼€å§‹çš„ã€‚æˆ‘ä»¬å¯ä»¥å°†æœ€æ–°çš„ Promise ç§°ä¸ºâ€œpromise 3â€ï¼Œä½†æ˜¯æˆ‘ä»¬å¹¶ä¸éœ€è¦å®ƒçš„åç§°ï¼Œå› ä¸ºæˆ‘ä»¬æ ¹æœ¬ä¸ä¼šä½¿ç”¨å®ƒã€‚</li>
<li>æœ€åˆæ‰§è¡Œè¡¨è¾¾å¼æ—¶ï¼Œå‰ä¸‰ä¸ªæ­¥éª¤éƒ½æ˜¯åŒæ­¥å‘ç”Ÿçš„ã€‚ç°åœ¨ï¼Œåœ¨ç¬¬ 1 æ­¥ä¸­å¯åŠ¨çš„ HTTP è¯·æ±‚é€šè¿‡ Internet å‘é€æ—¶ï¼Œæˆ‘ä»¬æœ‰äº†å¼‚æ­¥æš‚åœã€‚</li>
<li>æœ€ç»ˆï¼ŒHTTP å“åº”å¼€å§‹åˆ°è¾¾ã€‚fetch() è°ƒç”¨çš„å¼‚æ­¥éƒ¨åˆ†å°† HTTP çŠ¶æ€å’Œæ ‡å¤´åŒ…è£…åœ¨ Response å¯¹è±¡ä¸­ï¼Œå¹¶ä»¥è¯¥ Response å¯¹è±¡ä½œä¸ºå€¼æ¥å…‘ç° promise 1ã€‚</li>
<li>promise 1 å·²å…‘ç°åï¼Œå…¶å€¼ï¼ˆResponse å¯¹è±¡ï¼‰å°†ä¼ é€’åˆ°æˆ‘ä»¬çš„ callback1() å‡½æ•°ï¼Œtask 2 å¼€å§‹ã€‚ä»¥ Response å¯¹è±¡ä½œä¸ºè¾“å…¥ï¼Œæ­¤ä»»åŠ¡çš„å·¥ä½œæ˜¯è·å¾—å“åº”ä¸»ä½“è½¬åŒ–ä¸º JSON å¯¹è±¡ã€‚</li>
<li>å‡è®¾ task 2 æ­£å¸¸å®Œæˆï¼Œå¹¶ä¸”èƒ½å¤Ÿè§£æ HTTP å“åº”ä¸»ä½“ä»¥ç”Ÿæˆ JSON å¯¹è±¡ã€‚æ­¤ JSON å¯¹è±¡ç”¨äºå…‘ç° promise 2ã€‚</li>
<li>å…‘ç° promise 2 çš„å€¼åœ¨ä¼ é€’ç»™ callback2() å‡½æ•°æ—¶æˆä¸º task 3 çš„è¾“å…¥ã€‚ç°åœ¨ï¼Œç¬¬ä¸‰ä¸ªä»»åŠ¡ä»¥æŸç§æœªæŒ‡å®šçš„æ–¹å¼å‘ç”¨æˆ·æ˜¾ç¤ºæ•°æ®ã€‚å½“ task 3 å®Œæˆæ—¶ï¼ˆå‡è®¾å®ƒæ­£å¸¸å®Œæˆï¼‰ï¼Œåˆ™ promise 3 å°†è¢«å…‘ç°ã€‚ä½†æ˜¯ï¼Œå› ä¸ºæˆ‘ä»¬ä»æœªå¯¹ promise 3 åšä»»ä½•äº‹æƒ…ï¼Œæ‰€ä»¥å½“ promise 3 æ•²å®šæ—¶ï¼Œä»€ä¹ˆä¹Ÿæ²¡æœ‰å‘ç”Ÿï¼Œå¹¶ä¸”å¼‚æ­¥è®¡ç®—é“¾åˆ°æ­¤ç»“æŸã€‚</li>
</ol>
</blockquote>
<h3 id="13-2-3-Resolving-Promises"><a href="#13-2-3-Resolving-Promises" class="headerlink" title="13.2.3 Resolving Promises"></a>13.2.3 Resolving Promises</h3><p>While explaining the URL-fetching Promise chain with the list in the last section, we talked about promises 1, 2, and 3. But there is actually a fourth Promise object involved as well, and this brings us to our important discussion of what it means for a Promise to be â€œresolved.â€</p>
<blockquote>
<p>åœ¨ä¸Šä¸€éƒ¨åˆ†ä¸­ç”¨åˆ—è¡¨è§£é‡Š URL-fetching Promise é“¾æ—¶ï¼Œæˆ‘ä»¬è®¨è®ºäº† promise 1ã€2 å’Œ 3ã€‚ä½†æ˜¯å®é™…ä¸Šä¹Ÿæ¶‰åŠç¬¬å››ä¸ª Promise å¯¹è±¡ï¼Œå¹¶ä¸”è¿™ä¸ºæˆ‘ä»¬å¸¦æ¥é‡è¦çš„è®¨è®ºâ€”â€”â€”â€”ä»€ä¹ˆæ˜¯ Promise çš„â€œå·²å†³è®®ï¼ˆresolvedï¼‰â€çŠ¶æ€ ã€‚ </p>
</blockquote>
<p>Remember that fetch() returns a Promise object which, when fulfilled, passes a Response object to the callback function we register. This Response object has .text(), .json(), and other methods to request the body of the HTTP response in various forms. But since the body may not yet have arrived, these methods must return Promise objects. In the example weâ€™ve been studying, â€œtask 2â€ calls the .json() method and returns its value. This is the fourth Promise object, and it is the return value of the callback1() function.</p>
<blockquote>
<p>è¯·è®°ä½ï¼Œfetch() è¿”å›ä¸€ä¸ª Promise å¯¹è±¡ï¼Œå½“å…¶å·²å…‘ç°æ—¶ï¼Œå®ƒå°† Response å¯¹è±¡ä¼ é€’ç»™æˆ‘ä»¬æ³¨å†Œçš„å›è°ƒå‡½æ•°ã€‚æ­¤ Response å¯¹è±¡å…·æœ‰ .text()ã€.json() å’Œå…¶ä»–æ–¹æ³•ï¼Œä»¥å„ç§å½¢å¼è¯·æ±‚ HTTP å“åº”çš„ä¸»ä½“ã€‚ä½†æ˜¯ç”±äºä¸»ä½“å¯èƒ½å°šæœªåˆ°è¾¾ï¼Œå› æ­¤è¿™äº›æ–¹æ³•å¿…é¡»è¿”å› Promise å¯¹è±¡ã€‚åœ¨æˆ‘ä»¬ä¸€ç›´åœ¨ç ”ç©¶çš„ç¤ºä¾‹ä¸­ï¼Œâ€œtask 2â€è°ƒç”¨ .json() æ–¹æ³•å¹¶è¿”å›å…¶å€¼ã€‚è¿™æ˜¯ç¬¬å››ä¸ª Promise å¯¹è±¡ï¼Œå®ƒæ˜¯ callback1() å‡½æ•°çš„è¿”å›å€¼ã€‚</p>
</blockquote>
<p>Letâ€™s rewrite the URL-fetching code one more time in a verbose and nonidiomatic way that makes the callbacks and promises explicit:</p>
<blockquote>
<p>è®©æˆ‘ä»¬ä»¥å†—é•¿ä¸”éå¸¸ç”¨æ–¹å¼å†æ¬¡é‡å†™ URL-fetching ä»£ç ï¼Œä½¿å›è°ƒå’Œ Promise æ˜ç¡®åŒ–ï¼š</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">c1</span>(<span class="params">response</span>) &#123;               <span class="comment">// callback 1</span></span><br><span class="line">    <span class="keyword">let</span> p4 = response.<span class="title function_">json</span>();</span><br><span class="line">    <span class="keyword">return</span> p4;                        <span class="comment">// returns promise 4</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">c2</span>(<span class="params">profile</span>) &#123;                <span class="comment">// callback 2</span></span><br><span class="line">    <span class="title function_">displayUserProfile</span>(profile);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> p1 = <span class="title function_">fetch</span>(<span class="string">&quot;/api/user/profile&quot;</span>);  <span class="comment">// promise 1, task 1</span></span><br><span class="line"><span class="keyword">let</span> p2 = p1.<span class="title function_">then</span>(c1);                 <span class="comment">// promise 2, task 2</span></span><br><span class="line"><span class="keyword">let</span> p3 = p2.<span class="title function_">then</span>(c2);                 <span class="comment">// promise 3, task 3</span></span><br></pre></td></tr></table></figure>
<p>In order for Promise chains to work usefully, the output of task 2 must become the input to task 3. And in the example weâ€™re considering here, the input to task 3 is the body of the URL that was fetched, parsed as a JSON object. But, as weâ€™ve just discussed, the return value of callback c1 is not a JSON object, but Promise p4 for that JSON object. This seems like a contradiction, but it is not: when p1 is fulfilled, c1 is invoked, and task 2 begins. And when p2 is fulfilled, c2 is invoked, and task 3 begins. But just because task 2 begins when c1 is invoked, it does not mean that task 2 must end when c1 returns. Promises are about managing asynchronous tasks, after all, and if task 2 is asynchronous (which it is, in this case), then that task will not be complete by the time the callback returns.</p>
<blockquote>
<p>ä¸ºäº†ä½¿ Promise é“¾æœ‰æ•ˆåœ°å·¥ä½œï¼Œtask 2 çš„è¾“å‡ºå¿…é¡»æˆä¸º task 3 çš„è¾“å…¥ã€‚åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œè€ƒè™‘çš„æ˜¯ï¼Œtask 3 çš„è¾“å…¥æ˜¯ä» URL æ‰€è·å–çš„çš„ä¸»ä½“ï¼Œå°†å…¶è§£æä¸º JSON å¯¹è±¡ã€‚ä½†æ˜¯ï¼Œæ­£å¦‚æˆ‘ä»¬åˆšåˆšè®¨è®ºçš„é‚£æ ·ï¼Œå›è°ƒ c1 çš„è¿”å›å€¼ä¸æ˜¯ JSON å¯¹è±¡ï¼Œè€Œæ˜¯è¯¥ JSON å¯¹è±¡çš„ Promise p4ã€‚è¿™ä¼¼ä¹æœ‰çŸ›ç›¾ï¼Œä½†å¹¶éå¦‚æ­¤ï¼šå½“ p1 å·²å…‘ç°æ—¶ï¼Œå°†è°ƒç”¨ c1ï¼Œå¹¶ä¸” task 2 å¼€å§‹ã€‚å½“ p2 å·²å…‘ç°æ—¶ï¼Œc2 è¢«è°ƒç”¨ï¼Œtask 3 å¼€å§‹ã€‚ä½†æ˜¯ï¼Œä»…ä»…å› ä¸º c1 è¢«è°ƒç”¨æ—¶å¼€å§‹ task 2 ï¼Œå¯è¿™å¹¶ä¸æ„å‘³ç€ task 2 å¿…é¡»åœ¨ c1 è¿”å›æ—¶ç»“æŸã€‚æ¯•ç«Ÿï¼ŒPromise æ˜¯å…³äºç®¡ç†å¼‚æ­¥ä»»åŠ¡çš„ï¼Œå¦‚æœ task 2 æ˜¯å¼‚æ­¥çš„ï¼ˆåœ¨æœ¬ä¾‹ä¸­ä¸ºå¼‚æ­¥ï¼‰ï¼Œåˆ™åœ¨å›è°ƒè¿”å›æ—¶è¯¥ä»»åŠ¡å°†ä¸ä¼šå®Œæˆã€‚</p>
</blockquote>
<p>We are now ready to discuss the final detail that you need to understand to really master Promises. When you pass a callback c to the then() method, then() returns a Promise p and arranges to asynchronously invoke c at some later time. The callback performs some computation and returns a value v. When the callback returns, p is resolved with the value v. When a Promise is resolved with a value that is not itself a Promise, it is immediately fulfilled with that value. So if c returns a non-Promise, that return value becomes the value of p, p is fulfilled and we are done. But if the return value v is itself a Promise, then p is resolved but not yet fulfilled. At this stage, p cannot settle until the Promise v settles. If v is fulfilled, then p will be fulfilled to the same value. If v is rejected, then p will be rejected for the same reason. This is what the â€œresolvedâ€ state of a Promise means: the Promise has become associated with, or â€œlocked onto,â€ another Promise. We donâ€™t know yet whether p will be fulfilled or rejected, but our callback c no longer has any control over that. p is â€œresolvedâ€ in the sense that its fate now depends entirely on what happens to Promise v.</p>
<blockquote>
<p>ç°åœ¨æˆ‘ä»¬å‡†å¤‡è®¨è®ºæœ€åçš„ç»†èŠ‚ï¼Œéœ€è¦äº†è§£è¿™äº›æ‰èƒ½çœŸæ­£æŒæ¡ Promiseã€‚å½“å°†å›è°ƒ c ä¼ é€’ç»™ then() æ–¹æ³•æ—¶ï¼Œthen() è¿”å› Promise p å¹¶å®‰æ’åœ¨ä»¥åçš„æŸä¸ªæ—¶é—´å¼‚æ­¥è°ƒç”¨  cã€‚è°ƒæ‰§è¡Œä¸€äº›è®¡ç®—å¹¶è¿”å›å€¼ vã€‚å½“å›è°ƒè¿”å›æ—¶ï¼Œp ç”¨å€¼ v å†³è®®ã€‚å½“ Promise ä½¿ç”¨ä¸æ˜¯æœ¬èº«çš„ Promise å€¼å†³è®®æ—¶ï¼Œç«‹å³ç”¨è¯¥å€¼å…‘ç°ã€‚å› æ­¤ï¼Œå¦‚æœ c è¿”å›ä¸€ä¸ªé Promiseï¼Œåˆ™è¿”å›å€¼æˆä¸º p çš„å€¼ï¼Œåˆ™ p å·²å…‘ç°å¹¶ä¸”ä»»åŠ¡å®Œæˆã€‚ä½†æ˜¯ï¼Œå¦‚æœè¿”å›å€¼ v æœ¬èº«æ˜¯ä¸€ä¸ª Promiseï¼Œåˆ™ p å·²å†³è®®ä½†å°šæœªå…‘ç°ã€‚åœ¨æ­¤é˜¶æ®µï¼Œç›´åˆ° Promise v æ•²å®šï¼Œp æ‰èƒ½æ•²å®šã€‚å¦‚æœ v å·²å…‘ç°ï¼Œåˆ™ p å°†è¢«å…‘ç°ä¸ºç›¸åŒçš„å€¼ã€‚å¦‚æœ v å·²æ‹’ç»ï¼Œåˆ™ p å°†å› ç›¸åŒçš„åŸå› è€Œè¢«æ‹’ç»ã€‚è¿™å°±æ˜¯ä¸€ä¸ª Promise çš„â€œå·²å†³è®®ï¼ˆresolvedï¼‰â€çŠ¶æ€çš„å«ä¹‰ï¼šPromise å·²ä¸å¦ä¸€ä¸ª Promise å…³è”æˆ–â€œé”å®šâ€ã€‚æˆ‘ä»¬å°šä¸çŸ¥é“ p æ˜¯å·²å…‘ç°è¿˜æ˜¯æ‹’ç»ï¼Œä½†æ˜¯æˆ‘ä»¬çš„å›è°ƒ c å¯¹æ­¤ä¸å†å…·æœ‰ä»»ä½•æ§åˆ¶æƒã€‚p æ˜¯â€œå·²å†³è®®â€çš„ï¼Œä»è¿™ä¸€æ–¹é¢æ¥è¯´å®ƒå‘½è¿ç°åœ¨å®Œå…¨å–å†³äº Promise v ä¼šå‘ç”Ÿä»€ä¹ˆã€‚</p>
</blockquote>
<p>Letâ€™s bring this back to our URL-fetching example. When c1 returns p4, p2 is resolved. But being resolved is not the same as being fulfilled, so task 3 does not begin yet. When the full body of the HTTP response becomes available, then the .json() method can parse it and use that parsed value to fulfill p4. When p4 is fulfilled, p2 is automatically fulfilled as well, with the same parsed JSON value. At this point, the parsed JSON object is passed to c2, and task 3 begins.</p>
<blockquote>
<p>è®©æˆ‘ä»¬å›åˆ°æˆ‘ä»¬çš„ URL-fetching ç¤ºä¾‹ä¸­ã€‚ å½“ c1 è¿”å› p4 æ—¶ï¼Œp2 å·²å†³è®®ã€‚ä½†æ˜¯å·²å†³è®®ä¸å·²å…‘ç°å¹¶ä¸ç›¸åŒï¼Œå› æ­¤ task 3 å°šæœªå¼€å§‹ã€‚å½“ HTTP å“åº”çš„å…¨æ–‡å¯ç”¨æ—¶ï¼Œ.json() æ–¹æ³•å¯ä»¥å¯¹å…¶è¿›è¡Œè§£æï¼Œå¹¶ä½¿ç”¨è¯¥è§£æåçš„å€¼æ¥å·²å…‘ç° p4ã€‚ å½“ p4 å·²å…‘ç°æ—¶ï¼Œä¹Ÿä¼šä½¿ç”¨ç›¸åŒçš„å·²è§£æ JSON å€¼è‡ªåŠ¨å·²å…‘ç° p2ã€‚æ­¤æ—¶ï¼Œå·²è§£æçš„ JSON å¯¹è±¡å°†ä¼ é€’ç»™ c2ï¼Œç„¶å task 3 å¼€å§‹ã€‚</p>
</blockquote>
<p>This can be one of the trickiest parts of JavaScript to understand, and you may need to read this section more than once. Figure 13-1 presents the process in visual form and may help clarify it for you.</p>
<blockquote>
<p>è¿™å¯èƒ½æ˜¯ JavaScript æœ€éš¾ç†è§£çš„éƒ¨åˆ†ä¹‹ä¸€ï¼Œå¯èƒ½éœ€è¦å¤šæ¬¡é˜…è¯»æœ¬èŠ‚ã€‚å›¾ 13-1 ä»¥å¯è§†å½¢å¼æ˜¾ç¤ºäº†è¯¥è¿‡ç¨‹ï¼Œå¯èƒ½æœ‰åŠ©äºå¯¹å…¶è¿›è¡Œè¯´æ˜ã€‚</p>
</blockquote>
<p><Figures figure="13-1">Fetching a URL with Promises</Figures></p>
<h3 id="13-2-4-More-on-Promises-and-Errors"><a href="#13-2-4-More-on-Promises-and-Errors" class="headerlink" title="13.2.4 More on Promises and Errors"></a>13.2.4 More on Promises and Errors</h3><p>Earlier in the chapter, we saw that you can pass a second callback function to the .then() method and that this second function will be invoked if the Promise is rejected. When that happens, the argument to this second callback function is a valueâ€”typically an Error objectâ€”that represents the reason for the rejection. We also learned that it is uncommon (and even unidiomatic) to pass two callbacks to a .then() method. Instead, Promise-related errors are typically handled by adding a .catch() method invocation to a Promise chain. Now that we have examined Promise chains, we can return to error handling and discuss it in more detail. To preface the discussion, Iâ€™d like to stress that careful error handling is really important when doing asynchronous programming. With synchronous code, if you leave out error-handling code, youâ€™ll at least get an exception and a stack trace that you can use to figure out what is going wrong. With asynchronous code, unhandled exceptions will often go unreported, and errors can occur silently, making them much harder to debug. The good news is that the .catch() method makes it easy to handle errors when working with Promises.</p>
<blockquote>
<p>åœ¨æœ¬ç« çš„å‰é¢ï¼Œæˆ‘ä»¬çœ‹åˆ°å¯ä»¥å°†ç¬¬äºŒä¸ªå›è°ƒå‡½æ•°ä¼ é€’ç»™ .then() æ–¹æ³•ï¼Œå¹¶ä¸”å¦‚æœ Promise è¢«æ‹’ç»ï¼Œåˆ™å°†è°ƒç”¨è¯¥ç¬¬äºŒä¸ªå‡½æ•°ã€‚å‘ç”Ÿè¿™ç§æƒ…å†µæ—¶ï¼Œç¬¬äºŒä¸ªå›è°ƒå‡½æ•°çš„å®å‚æ˜¯ä¸€ä¸ªå€¼ï¼ˆé€šå¸¸æ˜¯ä¸€ä¸ª Error å¯¹è±¡ï¼‰ï¼Œå®ƒè¡¨ç¤ºæ‹’ç»çš„åŸå› ã€‚æˆ‘ä»¬è¿˜äº†è§£åˆ°ï¼Œå°†ä¸¤ä¸ªå›è°ƒä¼ é€’ç»™ .then() æ–¹æ³•å¹¶ä¸å¸¸è§ï¼ˆç”šè‡³æ˜¯å•ä¾‹çš„ï¼‰ã€‚ç›¸åï¼Œé€šå¸¸é€šè¿‡å‘ Promise é“¾æ·»åŠ  .catch() æ–¹æ³•è°ƒç”¨æ¥å¤„ç†ä¸ Promise ç›¸å…³çš„å¼‚å¸¸ã€‚ç°åœ¨æˆ‘ä»¬å·²ç»æ£€æŸ¥äº† Promise é“¾ï¼Œæˆ‘ä»¬å¯ä»¥è¿”å›å¼‚å¸¸å¤„ç†å¹¶æ›´è¯¦ç»†åœ°è®¨è®ºå®ƒã€‚åœ¨å¼€å§‹è®¨è®ºä¹‹å‰ï¼Œæˆ‘æƒ³å¼ºè°ƒæŒ‡å‡ºï¼Œè¿›è¡Œå¼‚æ­¥ç¼–ç¨‹æ—¶ï¼Œä»”ç»†çš„å¼‚å¸¸å¤„ç†éå¸¸é‡è¦ã€‚ä½¿ç”¨åŒæ­¥ä»£ç ï¼Œå¦‚æœçœç•¥äº†å¼‚å¸¸å¤„ç†ä»£ç ï¼Œåˆ™è‡³å°‘ä¼šå¾—åˆ°ä¸€ä¸ªå¼‚å¸¸å’Œä¸€ä¸ªå †æ ˆè·Ÿè¸ªï¼Œå¯ç”¨äºæ‰¾å‡ºé—®é¢˜æ‰€åœ¨ã€‚å¯¹äºå¼‚æ­¥ä»£ç ï¼Œæœªå¤„ç†çš„å¼‚å¸¸é€šå¸¸ä¸ä¼šæŠ¥å‘Šï¼Œå¼‚å¸¸å¯ä»¥é™é»˜å‘ç”Ÿï¼Œä»è€Œä½¿è°ƒè¯•æ›´åŠ å›°éš¾ã€‚å¥½æ¶ˆæ¯æ˜¯ï¼Œä½¿ç”¨ .catch() æ–¹æ³•å¯ä»¥æ›´è½»æ¾åœ°å¤„ç† Promise çš„å¼‚å¸¸ã€‚</p>
</blockquote>
<h4 id="THE-CATCH-AND-FINALLY-METHODS"><a href="#THE-CATCH-AND-FINALLY-METHODS" class="headerlink" title="THE CATCH AND FINALLY METHODS"></a>THE CATCH AND FINALLY METHODS</h4><p>The .catch() method of a Promise is simply a shorthand way to call .then() with null as the first argument and an error-handling callback as the second argument. Given any Promise p and a callback c, the following two lines are equivalent:</p>
<blockquote>
<p>.then() å¯ä»¥å¤„ç†å¼‚å¸¸ï¼Œä½¿ç”¨ null ä¸ºç¬¬ä¸€ä¸ªå®å‚ï¼Œè€Œå¼‚å¸¸å¤„ç†å›è°ƒä¸ºç¬¬äºŒä¸ªå®å‚ï¼ŒPromise çš„ .catch() æ–¹æ³•åªæ˜¯è¿™ç§ .then() è°ƒç”¨çš„ä¸€ç§ç®€ä¾¿å†™æ³•ã€‚ç»™å®š Promise p å’Œå›è°ƒ cï¼Œä»¥ä¸‹ä¸¤è¡Œä»£ç æ˜¯ç­‰æ•ˆçš„ï¼š</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">p.<span class="title function_">then</span>(<span class="literal">null</span>, c);</span><br><span class="line">p.<span class="title function_">catch</span>(c);</span><br></pre></td></tr></table></figure>
<p>The .catch() shorthand is preferred because it is simpler and because the name matches the catch clause in a try&#x2F;catch exception-handling statement. As weâ€™ve discussed, normal exceptions donâ€™t work with asynchronous code. The .catch() method of Promises is an alternative that does work for asynchronous code. When something goes wrong in synchronous code, we can speak of an exception â€œbubbling up the call stackâ€ until it finds a catch block. With an asynchronous chain of Promises, the comparable metaphor might be of an error â€œtrickling down the chainâ€ until it finds a .catch() invocation.</p>
<blockquote>
<p>é¦–é€‰ .catch() é€Ÿè®°ï¼Œå› ä¸ºå®ƒæ›´ç®€å•ï¼Œå¹¶ä¸”åç§°ä¸ try&#x2F;catch å¼‚å¸¸å¤„ç†è¯­å¥ä¸­çš„ catch å­å¥åŒ¹é…ã€‚æ­£å¦‚æˆ‘ä»¬æ‰€è®¨è®ºçš„ï¼Œæ™®é€šä¾‹å¤–ä¸é€‚ç”¨äºå¼‚æ­¥ä»£ç ã€‚Promise çš„ .catch() æ–¹æ³•æ˜¯ä¸€ç§é€‚ç”¨äºå¼‚æ­¥ä»£ç çš„æ›¿ä»£æ–¹æ³•ã€‚å½“åŒæ­¥ä»£ç ä¸­å‡ºç°é—®é¢˜æ—¶ï¼Œæˆ‘ä»¬â€œä½¿è°ƒç”¨å †æ ˆå†’æ³¡â€æè¿°ä¸€ä¸ªå¼‚å¸¸ï¼Œç›´åˆ°æ‰¾åˆ° catch å—ä¸ºæ­¢ã€‚å¯¹äºå¼‚æ­¥çš„ Promise é“¾ï¼Œåˆ™æ˜¯â€œå‘é“¾ä¸‹æ»´â€ï¼Œç›´åˆ°æ‰¾åˆ° .catch() è°ƒç”¨ä¸ºæ­¢ã€‚</p>
</blockquote>
<p>In ES2018, Promise objects also define a .finally() method whose purpose is similar to the finally clause in a try&#x2F;catch&#x2F;finally statement. If you add a .finally() invocation to your Promise chain, then the callback you pass to .finally() will be invoked when the Promise you called it on settles. Your callback will be invoked if the Promise fulfills or rejects, and it will not be passed any arguments, so you canâ€™t find out whether it fulfilled or rejected. But if you need to run some kind of cleanup code (such as closing open files or network connections) in either case, a .finally() callback is the ideal way to do that. Like .then() and .catch(), .finally() returns a new Promise object. The return value of a .finally() callback is generally ignored, and the Promise returned by .finally() will typically resolve or reject with the same value that the Promise that .finally() was invoked on resolves or rejects with. If a .finally() callback throws an exception, however, then the Promise returned by .finally() will reject with that value.</p>
<blockquote>
<p>åœ¨ ES2018 ä¸­ï¼ŒPromise å¯¹è±¡è¿˜å®šä¹‰äº†ä¸€ä¸ª .finally() æ–¹æ³•ï¼Œå…¶ç›®çš„ç±»ä¼¼äº try&#x2F;catch&#x2F;finally è¯­å¥ä¸­çš„ finally å­å¥ã€‚å¦‚æœå°† .finally() è°ƒç”¨æ·»åŠ åˆ° Promise é“¾ä¸­ï¼Œé‚£ä¹ˆ .finally() çš„è°ƒç”¨è€… Promise çš„æ•²å®šçš„æ—¶å€™ï¼Œä¼ é€’ç»™ .finally() çš„å›è°ƒå°†è¢«è°ƒç”¨ã€‚å¦‚æœ Promise å·²å…‘ç°æˆ–å·²æ‹’ç»ï¼Œåˆ™å°†è°ƒç”¨å›è°ƒï¼Œå¹¶ä¸”å®ƒä¸ä¼šå†ä½œä¸ºå®å‚ä¼ é€’ï¼Œå› æ­¤æ— æ³•ç¡®å®šå®ƒæ˜¯å·²å…‘ç°è¿˜æ˜¯å·²æ‹’ç»ã€‚ä½†æ˜¯ï¼Œæ— è®ºå“ªç§æƒ…å†µï¼Œå¦‚æœéƒ½éœ€è¦è¿è¡ŒæŸç§æ¸…ç†ä»£ç ï¼ˆä¾‹å¦‚å…³é—­æ‰“å¼€çš„æ–‡ä»¶æˆ–ç½‘ç»œè¿æ¥ï¼‰ï¼Œåˆ™ .finally() å›è°ƒæ˜¯å®ç°æ­¤ç›®çš„çš„ç†æƒ³æ–¹æ³•ã€‚ä¸ .then() å’Œ .catch() ä¸€æ ·ï¼Œ.finally() è¿”å›ä¸€ä¸ªæ–°çš„ Promise å¯¹è±¡ã€‚.finally() å›è°ƒçš„è¿”å›å€¼é€šå¸¸è¢«å¿½ç•¥ï¼Œ.finally() è¿”å›çš„ Promise é€šå¸¸å°†ä»¥è°ƒç”¨ .finally() çš„ Promise ç›¸åŒçš„å€¼æ¥å†³è®®æˆ–æ‹’ç»ã€‚ä½†æ˜¯ï¼Œå¦‚æœ .finally() å›è°ƒå¼•å‘å¼‚å¸¸ï¼Œåˆ™ .finally() è¿”å›çš„ Promise ä»¥è¯¥å¼‚å¸¸å€¼æ‹’ç»ã€‚</p>
</blockquote>
<p>The URL-fetching code that we studied in the previous sections did not do any error handling. Letâ€™s correct that now with a more realistic version of the code:</p>
<blockquote>
<p>æˆ‘ä»¬åœ¨ä¸Šä¸€èŠ‚ä¸­ç ”ç©¶çš„ URL-fetching ä»£ç æ²¡æœ‰ä»»ä½•å¼‚å¸¸å¤„ç†ã€‚ç°åœ¨ï¼Œä½¿ç”¨æ›´å¯è¡Œçš„ä»£ç ç‰ˆæœ¬è¿›è¡Œæ›´æ­£ï¼š</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">fetch</span>(<span class="string">&quot;/api/user/profile&quot;</span>)    <span class="comment">// Start the HTTP request</span></span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;       <span class="comment">// Call this when status and headers are ready</span></span><br><span class="line">        <span class="keyword">if</span> (!response.<span class="property">ok</span>) &#123;   <span class="comment">// If we got a 404 Not Found or similar error</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;      <span class="comment">// Maybe user is logged out; return null profile</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Now check the headers to ensure that the server sent us JSON.</span></span><br><span class="line">        <span class="comment">// If not, our server is broken, and this is a serious error!</span></span><br><span class="line">        <span class="keyword">let</span> type = response.<span class="property">headers</span>.<span class="title function_">get</span>(<span class="string">&quot;content-type&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (type !== <span class="string">&quot;application/json&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">`Expected JSON, got <span class="subst">$&#123;type&#125;</span>`</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If we get here, then we got a 2xx status and a JSON content-type</span></span><br><span class="line">        <span class="comment">// so we can confidently return a Promise for the response</span></span><br><span class="line">        <span class="comment">// body as a JSON object.</span></span><br><span class="line">        <span class="keyword">return</span> response.<span class="title function_">json</span>();</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">profile</span> =&gt;</span> &#123;        <span class="comment">// Called with the parsed response body or null</span></span><br><span class="line">        <span class="keyword">if</span> (profile) &#123;</span><br><span class="line">            <span class="title function_">displayUserProfile</span>(profile);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123; <span class="comment">// If we got a 404 error above and returned null we end up here</span></span><br><span class="line">            <span class="title function_">displayLoggedOutProfilePage</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> <span class="title class_">NetworkError</span>) &#123;</span><br><span class="line">            <span class="comment">// fetch() can fail this way if the internet connection is down</span></span><br><span class="line">            <span class="title function_">displayErrorMessage</span>(<span class="string">&quot;Check your internet connection.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> <span class="title class_">TypeError</span>) &#123;</span><br><span class="line">            <span class="comment">// This happens if we throw TypeError above</span></span><br><span class="line">            <span class="title function_">displayErrorMessage</span>(<span class="string">&quot;Something is wrong with our server!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// This must be some kind of unanticipated error</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<p>Letâ€™s analyze this code by looking at what happens when things go wrong. Weâ€™ll use the naming scheme we used before: p1 is the Promise returned by the fetch() call. p2 is the Promise returned by the first .then() call, and c1 is the callback that we pass to that .then() call. p3 is the Promise returned by the second .then() call, and c2 is the callback we pass to that call. Finally, c3 is the callback that we pass to the .catch() call. (That call returns a Promise, but we donâ€™t need to refer to it by name.)</p>
<blockquote>
<p>è®©æˆ‘ä»¬é€šè¿‡å‘ç”Ÿå¼‚å¸¸æƒ…å†µæƒ…å†µæ¥åˆ†ææ­¤ä»£ç ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ä¹‹å‰ä½¿ç”¨çš„å‘½åæ–¹æ¡ˆï¼šp1 æ˜¯ fetch() è°ƒç”¨è¿”å›çš„ Promiseã€‚p2 æ˜¯ç¬¬ä¸€ä¸ª .then() è°ƒç”¨è¿”å›çš„ Promiseï¼Œè€Œ c1 æ˜¯æˆ‘ä»¬ä¼ é€’ç»™è¯¥ .then() çš„å›è°ƒã€‚p3 æ˜¯ç¬¬äºŒä¸ª .then() è°ƒç”¨è¿”å›çš„ Promiseï¼Œè€Œ c2 æ˜¯æˆ‘ä»¬ä¼ é€’ç»™è¯¥è°ƒç”¨çš„å›è°ƒã€‚æœ€åï¼Œc3 æ˜¯æˆ‘ä»¬ä¼ é€’ç»™ .catch() çš„å›è°ƒã€‚ï¼ˆè¯¥è°ƒç”¨è¿”å›ä¸€ä¸ª Promiseï¼Œä½†æˆ‘ä»¬ä¸éœ€è¦æŒ‰åç§°å¼•ç”¨å®ƒã€‚ï¼‰</p>
</blockquote>
<p>The first thing that could fail is the fetch() request itself. If the network connection is down (or for some other reason an HTTP request cannot be made), then Promise p1 will be rejected with a NetworkError object. We didnâ€™t pass an error-handling callback function as the second argument to the .then() call, so p2 rejects as well with the same NetworkError object. (If we had passed an error handler to that first .then() call, the error handler would be invoked, and if it returned normally, p2 would be resolved and&#x2F;or fulfilled with the return value from that handler.) Without a handler, though, p2 is rejected, and then p3 is rejected for the same reason. At this point, the c3 error-handling callback is called, and the NetworkError-specific code within it runs.</p>
<blockquote>
<p>ç¬¬ä¸€ä¸ªå¯èƒ½å¤±è´¥çš„æ˜¯ fetch() è¯·æ±‚æœ¬èº«ã€‚å¦‚æœç½‘ç»œè¿æ¥æ–­å¼€ï¼ˆæˆ–ç”±äºæŸäº›å…¶ä»–åŸå› è€Œæ— æ³•å‘å‡º HTTP è¯·æ±‚ï¼‰ï¼Œåˆ™ Promise p1 å°†è¢« NetworkError å¯¹è±¡æ‹’ç»ã€‚æˆ‘ä»¬æ²¡æœ‰å°†å¼‚å¸¸å¤„ç†å›è°ƒå‡½æ•°ä½œä¸º .then() è°ƒç”¨çš„ç¬¬äºŒä¸ªå®å‚ä¼ é€’ï¼Œå› æ­¤ p2 åŒæ ·ä¼šè¢«ç›¸åŒçš„ NetworkError å¯¹è±¡æ‹’ç»ã€‚ï¼ˆå¦‚æœå°†å¼‚å¸¸å¤„ç†ç¨‹åºä¼ é€’ç»™ç¬¬ä¸€ä¸ª .then() è°ƒç”¨ï¼Œåˆ™å°†è°ƒç”¨è¯¥å¼‚å¸¸å¤„ç†ç¨‹åºï¼Œå¹¶ä¸”å¦‚æœè¯¥å¼‚å¸¸å¤„ç†ç¨‹åºæ­£å¸¸è¿”å›ï¼Œä¼´éšå¤„ç†çš„è¿”å›å€¼ï¼Œp2 å˜ä¸ºå·²å†³è®®å’Œæˆ–æˆ–å·²å…‘ç°ã€‚ï¼‰ä½†æ˜¯ï¼Œå‡ºäºç›¸åŒçš„åŸå› ï¼Œp2 è¢«æ‹’ç»ï¼Œç„¶å p3 è¢«æ‹’ç»ã€‚æ­¤æ—¶ï¼Œå°†è°ƒç”¨ c3 å¼‚å¸¸å¤„ç†å›è°ƒï¼Œå¹¶åœ¨å…¶ä¸­è¿è¡Œç‰¹å®šäº NetworkError çš„ä»£ç ã€‚</p>
</blockquote>
<p>Another way our code could fail is if our HTTP request returns a 404 Not Found or another HTTP error. These are valid HTTP responses, so the fetch() call does not consider them errors. fetch() encapsulates a 404 Not Found in a Response object and fulfills p1 with that object, causing c1 to be invoked. Our code in c1 checks the ok property of the Response object to detect that it has not received a normal HTTP response and handles that case by simply returning null. Because this return value is not a Promise, it fulfills p2 right away, and c2 is invoked with this value. Our code in c2 explicitly checks for and handles falsy values by displaying a different result to the user. This is a case where we treat an abnormal condition as a nonerror and handle it without actually using an error handler.</p>
<blockquote>
<p>ä»£ç å¤±è´¥çš„å¦ä¸€ç§æ–¹å¼æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬çš„ HTTP è¯·æ±‚è¿”å› 404 Not Found æˆ–å¦ä¸€ä¸ª HTTP å¼‚å¸¸ã€‚è¿™äº›æ˜¯æœ‰æ•ˆçš„ HTTP å“åº”ï¼Œå› æ­¤ fetch() è°ƒç”¨ä¸ä¼šå°†å…¶è§†ä¸ºå¼‚å¸¸ã€‚fetch() åœ¨ Response å¯¹è±¡ä¸­å°è£…äº†ä¸€ä¸ª 404 Not Foundï¼Œå¹¶ç”¨è¯¥å¯¹è±¡å·²å…‘ç° p1ï¼Œä»è€Œå¯¼è‡´ c1 è¢«è°ƒç”¨ã€‚æˆ‘ä»¬åœ¨ c1 ä¸­çš„ä»£ç æ£€æŸ¥ Response å¯¹è±¡çš„ ok å±æ€§ï¼Œä»¥æ£€æµ‹å®ƒæ²¡æœ‰æ”¶åˆ°æ­£å¸¸çš„ HTTP å“åº”ï¼Œå¹¶é€šè¿‡ç®€å•åœ°è¿”å› null æ¥å¤„ç†è¿™ç§æƒ…å†µã€‚å› ä¸ºæ­¤è¿”å›å€¼ä¸æ˜¯ Promiseï¼Œæ‰€ä»¥å®ƒç«‹å³å·²å…‘ç° p2ï¼Œå¹¶ä½¿ç”¨è¯¥å€¼è°ƒç”¨ c2ã€‚ æˆ‘ä»¬åœ¨ c2 ä¸­çš„ä»£ç æ˜¾å¼æ£€æŸ¥å¹¶å¤„ç†é”™è¯¯å€¼ï¼Œå¹¶å‘ç”¨æˆ·æ˜¾ç¤ºä¸åŒçš„ç»“æœã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†å¼‚å¸¸æƒ…å†µè§†ä¸ºéå¼‚å¸¸ï¼Œå¹¶åœ¨ä¸ä½¿ç”¨å¼‚å¸¸å¤„ç†ç¨‹åºçš„æƒ…å†µä¸‹å¯¹å…¶è¿›è¡Œå¤„ç†ã€‚</p>
</blockquote>
<p>A more serious error occurs in c1 if the we get a normal HTTP response code but the Content-Type header is not set appropriately. Our code expects a JSON-formatted response, so if the server is sending us HTML, XML, or plain text instead, weâ€™re going to have a problem. c1 includes code to check the Content-Type header. If the header is wrong, it treats this as a nonrecoverable problem and throws a TypeError. When a callback passed to .then() (or .catch()) throws a value, the Promise that was the return value of the .then() call is rejected with that thrown value. In this case, the code in c1 that raises a TypeError causes p2 to be rejected with that TypeError object. Since we did not specify an error handler for p2, p3 will be rejected as well. c2 will not be called, and the TypeError will be passed to c3, which has code to explicitly check for and handle this type of error.</p>
<blockquote>
<p>å¦‚æœæˆ‘ä»¬è·å¾—æ­£å¸¸çš„ HTTP å“åº”ä»£ç ï¼Œä½† Content-Type æ ‡å¤´è®¾ç½®ä¸æ­£ç¡®ï¼Œåˆ™ c1 ä¸­ä¼šå‘ç”Ÿæ›´ä¸¥é‡çš„å¼‚å¸¸ã€‚æˆ‘ä»¬çš„ä»£ç éœ€è¦ä¸€ä¸ª JSON æ ¼å¼çš„å“åº”ï¼Œå› æ­¤ï¼Œå¦‚æœæœåŠ¡å™¨å‘é€ç»™æˆ‘ä»¬çš„æ˜¯ HTMLã€XML æˆ–çº¯æ–‡æœ¬ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†ä¼šé‡åˆ°é—®é¢˜ã€‚c1 åŒ…å«ç”¨äºæ£€æŸ¥ Content-Type æ ‡å¤´çš„ä»£ç ã€‚å¦‚æœæ ‡å¤´é”™è¯¯ï¼Œåˆ™å°†å…¶è§†ä¸ºä¸å¯æ¢å¤çš„é—®é¢˜ï¼Œå¹¶å¼•å‘ TypeErrorã€‚å½“ä¼ é€’ç»™ .then()ï¼ˆæˆ– .catch()ï¼‰çš„å›è°ƒå¼•å‘ä¸€ä¸ªå€¼æ—¶ï¼Œä½œä¸º .then() è°ƒç”¨çš„è¿”å›çš„ Promise å°†è¢«è¯¥æŠ›å‡ºçš„å€¼æ‹’ç»ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œc1 ä¸­çš„ä»£ç å¼•å‘ TypeError å¯¼è‡´å¸¦æœ‰ TypeError å¯¹è±¡çš„ p2 ä¸€èµ·è¢«æ‹’ç»ã€‚ç”±äºæˆ‘ä»¬æ²¡æœ‰ä¸º p2 æŒ‡å®šå¼‚å¸¸å¤„ç†ç¨‹åºï¼Œå› æ­¤ p3 ä¹Ÿå°†è¢«æ‹’ç»ã€‚c2 å°†ä¸ä¼šè¢«è°ƒç”¨ï¼Œå¹¶ä¸” TypeError å°†ä¼ é€’ç»™ c3ï¼Œåè€…å…·æœ‰æ˜¾å¼æ£€æŸ¥å’Œå¤„ç†æ­¤ç±»å¼‚å¸¸çš„ä»£ç ã€‚</p>
</blockquote>
<p>There are a couple of things worth noting about this code. First, notice that the error object thrown with a regular, synchronous throw statement ends up being handled asynchronously with a .catch() method invocation in a Promise chain. This should make it clear why this shorthand method is preferred over passing a second argument to .then(), and also why it is so idiomatic to end Promise chains with a .catch() call.</p>
<blockquote>
<p>å…³äºæ­¤ä»£ç æœ‰äº›å¾—æ³¨æ„ã€‚é¦–å…ˆï¼Œè¯·æ³¨æ„ç”¨å¸¸è§„çš„åŒæ­¥ throw è¯­å¥å¼•å‘çš„å¼‚å¸¸å¯¹è±¡æœ€ç»ˆä¼šé€šè¿‡ Promise é“¾ä¸­çš„ .catch() æ–¹æ³•è°ƒç”¨è¿›è¡Œå¼‚æ­¥æ•è·ã€‚è¿™æ¸…æ¥šè¡¨æ˜ä¸ºä»€ä¹ˆä¸å°†ç¬¬äºŒä¸ªå®å‚ä¼ é€’ç»™ .then() ç›¸æ¯”æ›´åå‘ä½¿ç”¨è¿™ç§é€Ÿè®°æ–¹æ³•ï¼Œä»¥åŠä¸ºä»€ä¹ˆä¹ æƒ¯ä»¥ .catch() è°ƒç”¨ç»“æŸ Promise é“¾ã€‚</p>
</blockquote>
<p>Before we leave the topic of error handling, I want to point out that, although it is idiomatic to end every Promise chain with a .catch() to clean up (or at least log) any errors that occurred in the chain, it is also perfectly valid to use .catch() elsewhere in a Promise chain. If one of the stages in your Promise chain can fail with an error, and if the error is some kind of recoverable error that should not stop the rest of the chain from running, then you can insert a .catch() call in the chain, resulting in code that might look like this:</p>
<blockquote>
<p>åœ¨æˆ‘ä»¬ç»“æŸå¼‚å¸¸å¤„ç†ä¸»é¢˜ä¹‹å‰ï¼Œæˆ‘æƒ³æŒ‡å‡ºï¼Œå°½ç®¡ä¹ æƒ¯äºåœ¨æ¯ä¸ª Promise é“¾ä¸­æ·»åŠ ä¸€ä¸ª .catch() æ¥æ¸…ç†ï¼ˆæˆ–è‡³å°‘è®°å½•æ—¥å¿—ï¼‰è¯¥é“¾ä¸­å‘ç”Ÿçš„ä»»ä½•å¼‚å¸¸ï¼Œä½†æ˜¯åœ¨ Promise é“¾ä¸­çš„å…¶ä»–ä½ç½®ä½¿ç”¨ .catch() ä¹Ÿå®Œå…¨æœ‰æ•ˆã€‚å¦‚æœ Promise é“¾ä¸­çš„æŸä¸€é˜¶æ®µå¯èƒ½å› å¼‚å¸¸è€Œå¤±è´¥ï¼Œå¹¶ä¸”è¯¥å¼‚å¸¸æ˜¯æŸç§å¯æ¢å¤çš„å¼‚å¸¸ï¼Œå¹¶ä¸”è¯¥å¼‚å¸¸ä¸ä¼šé˜»æ­¢é“¾çš„å…¶ä½™éƒ¨åˆ†è¿è¡Œï¼Œåˆ™å¯ä»¥åœ¨é“¾ä¸­æ’å…¥ .catch() è°ƒç”¨ï¼Œä»£ç å¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">startAsyncOperation</span>()</span><br><span class="line">    .<span class="title function_">then</span>(doStageTwo)</span><br><span class="line">    .<span class="title function_">catch</span>(recoverFromStageTwoError)</span><br><span class="line">    .<span class="title function_">then</span>(doStageThree)</span><br><span class="line">    .<span class="title function_">then</span>(doStageFour)</span><br><span class="line">    .<span class="title function_">catch</span>(logStageThreeAndFourErrors);</span><br></pre></td></tr></table></figure>
<p>Remember that the callback you pass to .catch() will only be invoked if the callback at a previous stage throws an error. If the callback returns normally, then the .catch() callback will be skipped, and the return value of the previous callback will become the input to the next .then() callback. Also remember that .catch() callbacks are not just for reporting errors, but for handling and recovering from errors. Once an error has been passed to a .catch() callback, it stops propagating down the Promise chain. A .catch() callback can throw a new error, but if it returns normally, than that return value is used to resolve and&#x2F;or fulfill the associated Promise, and the error stops propagating.</p>
<blockquote>
<p>è¯·è®°ä½ï¼Œä»…å½“å‰ä¸€é˜¶æ®µçš„å›è°ƒå¼•å‘å¼‚å¸¸æ—¶ï¼Œæ‰ä¼šè°ƒç”¨ä¼ é€’ç»™ catch() çš„å›è°ƒã€‚å¦‚æœè¯¥å›è°ƒæ­£å¸¸è¿”å›ï¼Œåˆ™å°†è·³è¿‡ catch() å›è°ƒï¼Œå¹¶ä¸”å‰ä¸€ä¸ªå›è°ƒçš„è¿”å›å€¼å°†æˆä¸ºä¸‹ä¸€ä¸ª then() å›è°ƒçš„è¾“å…¥ã€‚è¿˜è¯·è®°ä½ï¼Œcatch() å›è°ƒä¸ä»…ç”¨äºå¼‚å¸¸æŠ¥å‘Šï¼Œè€Œä¸”ç”¨äºå¼‚å¸¸å¤„ç†å¹¶ä»å¼‚å¸¸ä¸­æ¢å¤ã€‚å°†å¼‚å¸¸ä¼ é€’ç»™ catch() å›è°ƒåï¼Œå®ƒå°†åœæ­¢æ²¿ Promise é“¾ä¼ æ’­ã€‚catch() å›è°ƒå¯ä»¥å¼•å‘æ–°çš„å¼‚å¸¸ï¼Œä½†æ˜¯å¦‚æœå®ƒæ­£å¸¸è¿”å›ï¼Œåˆ™è¯¥è¿”å›å€¼ç”¨äºå†³è®®å’Œæˆ–æˆ–å…‘ç°å…³è”çš„ Promiseï¼Œå¹¶ä¸”å¼‚å¸¸åœæ­¢ä¼ æ’­ã€‚</p>
</blockquote>
<p>Letâ€™s be concrete about this: in the preceding code example, if either startAsyncOperation() or doStageTwo() throws an error, then the recoverFromStageTwoError() function will be invoked. If recoverFromStageTwoError() returns normally, then its return value will be passed to doStageThree() and the asynchronous operation continues normally. On the other hand, if recoverFromStageTwoError() was unable to recover, it will itself throw an error (or it will rethrow the error that it was passed). In this case, neither doStageThree() nor doStageFour() will be invoked, and the error thrown by recoverFromStageTwoError() would be passed to logStageThreeAndFourErrors().</p>
<blockquote>
<p>è®©æˆ‘ä»¬å…·ä½“åœ°è®²ä¸€ä¸‹ï¼šåœ¨å‰é¢çš„ä»£ç ç¤ºä¾‹ä¸­ï¼Œå¦‚æœ startAsyncOperation() æˆ– doStageTwo() å¼•å‘å¼‚å¸¸ï¼Œåˆ™å°†è°ƒç”¨ recoveryFromStageTwoError() å‡½æ•°ã€‚å¦‚æœ restoreFromStageTwoError() æ­£å¸¸è¿”å›ï¼Œåˆ™å…¶è¿”å›å€¼å°†ä¼ é€’ç»™ doStageThree()ï¼Œå¹¶ä¸”å¼‚æ­¥æ“ä½œå°†æ­£å¸¸ç»§ç»­ã€‚å¦ä¸€æ–¹é¢ï¼Œå¦‚æœ recoverFromStageTwoError() æ— æ³•æ¢å¤ï¼Œåˆ™å®ƒæœ¬èº«å°†å¼•å‘å¼‚å¸¸ï¼ˆæˆ–è€…é‡æ–°æŠ›å‡ºä¼ å…¥çš„å¼‚å¸¸ï¼‰ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸ä¼šè°ƒç”¨ doStageThree() æˆ– doStageFour()ï¼Œå¹¶ä¸” recoverFromStageTwoError() å¼•å‘çš„å¼‚å¸¸å°†ä¼ é€’ç»™ logStageThreeAndFourErrors()ã€‚</p>
</blockquote>
<p>Sometimes, in complex network environments, errors can occur more or less at random, and it can be appropriate to handle those errors by simply retrying the asynchronous request. Imagine youâ€™ve written a Promise-based operation to query a database:</p>
<blockquote>
<p>æœ‰æ—¶ï¼Œåœ¨å¤æ‚çš„ç½‘ç»œç¯å¢ƒä¸­ï¼Œå¼‚å¸¸å¯èƒ½ä¼šæˆ–å¤šæˆ–å°‘åœ°éšæœºå‘ç”Ÿï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ç®€å•åœ°é‡è¯•å¼‚æ­¥è¯·æ±‚æ¥å¤„ç†è¿™äº›å¼‚å¸¸ã€‚å‡è®¾ç¼–å†™äº†ä¸€ä¸ªåŸºäº Promise çš„æ“ä½œæ¥æŸ¥è¯¢æ•°æ®åº“ï¼š</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">queryDatabase</span>()</span><br><span class="line">    .<span class="title function_">then</span>(displayTable)</span><br><span class="line">    .<span class="title function_">catch</span>(displayDatabaseError);</span><br></pre></td></tr></table></figure>
<p>Now suppose that transient network load issues are causing this to fail about 1% of the time. A simple solution might be to retry the query with a .catch() call:</p>
<blockquote>
<p>ç°åœ¨ï¼Œå‡è®¾å¤§çº¦ 1ï¼… çš„æ¦‚ç‡ç¬æ€ç½‘ç»œè´Ÿè½½é—®é¢˜å¯¼è‡´å…¶å¤±è´¥ã€‚ä¸€ä¸ªç®€å•çš„è§£å†³æ–¹æ¡ˆå¯èƒ½æ˜¯ä½¿ç”¨ .catch() è°ƒç”¨é‡è¯•æŸ¥è¯¢ï¼š</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">queryDatabase</span>()</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">wait</span>(<span class="number">500</span>).<span class="title function_">then</span>(queryDatabase))  <span class="comment">// On failure, wait and retry</span></span><br><span class="line">    .<span class="title function_">then</span>(displayTable)</span><br><span class="line">    .<span class="title function_">catch</span>(displayDatabaseError);</span><br></pre></td></tr></table></figure>
<p>If the hypothetical failures are truly random, then adding this one line of code should reduce your error rate from 1% to .01%.</p>
<blockquote>
<p>å¦‚æœå‡è®¾çš„å¤±è´¥ç¡®å®æ˜¯éšæœºçš„ï¼Œé‚£ä¹ˆæ·»åŠ è¿™ä¸€è¡Œä»£ç åº”ä½¿é”™è¯¯ç‡ä» 1ï¼… é™ä½åˆ° .01ï¼…ã€‚</p>
</blockquote>
<h4 id="RETURNING-FROM-A-PROMISE-CALLBACK"><a href="#RETURNING-FROM-A-PROMISE-CALLBACK" class="headerlink" title="RETURNING FROM A PROMISE CALLBACK"></a>RETURNING FROM A PROMISE CALLBACK</h4><p>Letâ€™s return one last time to the earlier URL-fetching example, and consider the c1 callback that we passed to the first .then() invocation. Notice that there are three ways that c1 can terminate. It can return normally with the Promise returned by the .json() call. This causes p2 to be resolved, but whether that Promise is fulfilled or rejected depends on what happens with the newly returned Promise. c1 can also return normally with the value null, which causes p2 to be fulfilled immediately. Finally, c1 can terminate by throwing an error, which causes p2 to be rejected. These are the three possible outcomes for a Promise, and the code in c1 demonstrates how the callback can cause each outcome.</p>
<blockquote>
<p>è®©æˆ‘ä»¬æœ€åä¸€æ¬¡è¿”å›å‰é¢çš„ URL-fetching ç¤ºä¾‹ï¼Œå¹¶è€ƒè™‘ä¼ é€’ç»™ç¬¬ä¸€ä¸ª .then() è°ƒç”¨çš„å›è°ƒ c1ã€‚æ³¨æ„ï¼Œc1 å¯ä»¥é€šè¿‡ä¸‰ç§æ–¹å¼ç»ˆæ­¢ã€‚å®ƒå¯ä»¥é€šè¿‡ .json() è°ƒç”¨è¿”å›çš„ Promise æ­£å¸¸è¿”å›ã€‚è¿™å°†å¯¼è‡´ p2 å˜ä¸ºå·²å†³è®®ï¼Œä½†æ˜¯è¯¥ Promise æ˜¯å·²å…‘ç°è¿˜æ˜¯æ‹’ç»å–å†³äºæ–°è¿”å›çš„ Promise å‘ç”Ÿäº†ä»€ä¹ˆã€‚c1 ä¹Ÿå¯ä»¥æ­£å¸¸è¿”å› null å€¼ï¼Œè¿™å°†å¯¼è‡´ p2 ç«‹å³å˜æˆå·²å…‘ç°ã€‚æœ€åï¼Œc1 å¯ä»¥é€šè¿‡å¼•å‘å¼‚å¸¸æ¥ç»ˆæ­¢ï¼Œä»è€Œå¯¼è‡´ p2 å˜æˆå·²æ‹’ç»ã€‚è¿™æ˜¯ Promise çš„ä¸‰ä¸ªå¯èƒ½ç»“æœï¼Œè€Œ c1 ä¸­çš„ä»£ç æ¼”ç¤ºäº†å›è°ƒå¦‚ä½•å¯¼è‡´æ¯ä¸ªç»“æœã€‚</p>
</blockquote>
<p>In a Promise chain, the value returned (or thrown) at one stage of the chain becomes the input to the next stage of the chain, so it is critical to get this right. In practice, forgetting to return a value from a callback function is actually a common source of Promise-related bugs, and this is exacerbated by JavaScriptâ€™s arrow function shortcut syntax. Consider this line of code that we saw earlier:</p>
<blockquote>
<p>åœ¨ Promise é“¾ä¸­ï¼Œåœ¨é“¾çš„ä¸€ä¸ªé˜¶æ®µè¿”å›ï¼ˆæˆ–æŠ›å‡ºï¼‰çš„å€¼æˆä¸ºé“¾çš„ä¸‹ä¸€é˜¶æ®µçš„è¾“å…¥ï¼Œå› æ­¤æ­£ç¡®å®ç°è¿™ä¸€ç‚¹è‡³å…³é‡è¦ã€‚å®é™…ä¸Šï¼Œå›è°ƒå‡½æ•°å¿˜è®°è¿”å›å€¼æ˜¯ä¸ Promise ç›¸å…³çš„å¸¸è§é”™è¯¯ï¼Œè€Œ JavaScript çš„ç®­å¤´å‡½æ•°å¿«æ·è¯­æ³•ä¼šåŠ å‰§è¿™ç§æƒ…å†µã€‚å›æƒ³ä¸€ä¸‹æˆ‘ä»¬ä¹‹å‰çœ‹åˆ°çš„ä»¥ä¸‹ä»£ç è¡Œï¼š</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.<span class="title function_">catch</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">wait</span>(<span class="number">500</span>).<span class="title function_">then</span>(queryDatabase))</span><br></pre></td></tr></table></figure>
<p>Recall from Chapter 8 that arrow functions allow a lot of shortcuts. Since there is exactly one argument (the error value), we can omit the parentheses. Since the body of the function is a single expression, we can omit the curly braces around the function body, and the value of the expression becomes the return value of the function. Because of these shortcuts, the preceding code is correct. But consider this innocuous-seeming change:</p>
<blockquote>
<p>å›é¡¾ç¬¬ 8 ç« ï¼Œç®­å¤´å‡½æ•°æä¾›äº†è®¸å¤šå¿«æ·æ–¹å¼ã€‚ç”±äºä»…å­˜åœ¨ä¸€ä¸ªå‚æ•°ï¼ˆå¼‚å¸¸å€¼ï¼‰ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥çœç•¥æ‹¬å·ã€‚ç”±äºå‡½æ•°çš„ä¸»ä½“æ˜¯å•ä¸ªè¡¨è¾¾å¼ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥çœç•¥å‡½æ•°ä¸»ä½“å‘¨å›´çš„èŠ±æ‹¬å·ï¼Œå¹¶ä¸”è¡¨è¾¾å¼çš„å€¼æˆä¸ºå‡½æ•°çš„è¿”å›å€¼ã€‚ç”±äºè¿™äº›å¿«æ·æ–¹å¼ï¼Œå‰é¢çš„ä»£ç æ˜¯æ­£ç¡®çš„ã€‚ä½†æ˜¯è€ƒè™‘ä¸€ä¸‹è¿™ç§æ— å®³çš„å˜åŒ–ï¼š</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.<span class="title function_">catch</span>(<span class="function"><span class="params">e</span> =&gt;</span> &#123; <span class="title function_">wait</span>(<span class="number">500</span>).<span class="title function_">then</span>(queryDatabase) &#125;)</span><br></pre></td></tr></table></figure>
<p>By adding the curly braces, we no longer get the automatic return. This function now returns undefined instead of returning a Promise, which means that the next stage in this Promise chain will be invoked with undefined as its input rather than the result of the retried query. It is a subtle error that may not be easy to debug.</p>
<blockquote>
<p>é€šè¿‡æ·»åŠ èŠ±æ‹¬å·ï¼Œæˆ‘ä»¬ä¸å†è·å¾—è‡ªåŠ¨è¿”å›ã€‚ç°åœ¨ï¼Œæ­¤å‡½æ•°è¿”å› undefined è€Œä¸æ˜¯è¿”å› Promiseï¼Œè¿™æ„å‘³ç€å°†ä»¥ undefined ä½œä¸ºè¾“å…¥è€Œä¸æ˜¯é‡è¯•æŸ¥è¯¢çš„ç»“æœæ¥è°ƒç”¨æ­¤ Promise é“¾ä¸­çš„ä¸‹ä¸€ä¸ªé˜¶æ®µã€‚è¿™æ˜¯ä¸€ä¸ªç»†å¾®çš„é”™è¯¯ï¼Œå¯èƒ½ä¸å®¹æ˜“è°ƒè¯•ã€‚</p>
</blockquote>
<h3 id="13-2-5-Promises-in-Parallel"><a href="#13-2-5-Promises-in-Parallel" class="headerlink" title="13.2.5 Promises in Parallel"></a>13.2.5 Promises in Parallel</h3><p>Weâ€™ve spent a lot of time talking about Promise chains for sequentially running the asynchronous steps of a larger asynchronous operation. Sometimes, though, we want to execute a number of asynchronous operations in parallel. The function Promise.all() can do this. Promise.all() takes an array of Promise objects as its input and returns a Promise. The returned Promise will be rejected if any of the input Promises are rejected. Otherwise, it will be fulfilled with an array of the fulfillment values of each of the input Promises. So, for example, if you want to fetch the text content of multiple URLs, you could use code like this:</p>
<blockquote>
<p>æˆ‘ä»¬èŠ±äº†å¾ˆå¤šæ—¶é—´è®¨è®º Promise é“¾ï¼Œè¿™äº›é“¾å¯æŒ‰é¡ºåºè¿è¡Œè¾ƒå¤§çš„å¼‚æ­¥çš„æ“ä½œæ­¥éª¤ã€‚ä½†æ˜¯ï¼Œæœ‰æ—¶æˆ‘ä»¬æƒ³å¹¶è¡Œæ‰§è¡Œè®¸å¤šå¼‚æ­¥æ“ä½œã€‚å‡½æ•° Promise.all() å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ã€‚Promise.all() å°† Promise å¯¹è±¡æ•°ç»„ä½œä¸ºå…¶è¾“å…¥ï¼Œå¹¶è¿”å› Promiseã€‚å¦‚æœä»»ä½•è¾“å…¥çš„ Promise ä¸­æœ‰ä¸€ä¸ªæ˜¯å·²æ‹’ç»çŠ¶æ€ï¼Œåˆ™è¿”å›çš„ Promise å°†è¢«æ‹’ç»ã€‚å¦åˆ™ï¼Œå®ƒå°†ä½¿ç”¨æ¯ä¸ªè¾“å…¥ Promise çš„å…‘ç°å€¼ç»„æˆçš„æ•°ç»„æ¥è¢«å…‘ç°ã€‚å› æ­¤ï¼Œä¾‹å¦‚ï¼Œå¦‚æœè¦è·å–å¤šä¸ª URL çš„æ–‡æœ¬å†…å®¹ï¼Œåˆ™å¯ä»¥ä½¿ç”¨å¦‚ä¸‹ä»£ç ï¼š</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// We start with an array of URLs</span></span><br><span class="line"><span class="keyword">const</span> urls = [ <span class="comment">/* zero or more URLs here */</span> ];</span><br><span class="line"><span class="comment">// And convert it to an array of Promise objects</span></span><br><span class="line">promises = urls.<span class="title function_">map</span>(<span class="function"><span class="params">url</span> =&gt;</span> <span class="title function_">fetch</span>(url).<span class="title function_">then</span>(<span class="function"><span class="params">r</span> =&gt;</span> r.<span class="title function_">text</span>()));</span><br><span class="line"><span class="comment">// Now get a Promise to run all those Promises in parallel</span></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">all</span>(promises)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">bodies</span> =&gt;</span> &#123; <span class="comment">/* do something with the array of strings */</span> &#125;)</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">error</span>(e));</span><br></pre></td></tr></table></figure>
<p>Promise.all() is slightly more flexible than described before. The input array can contain both Promise objects and non-Promise values. If an element of the array is not a Promise, it is treated as if it is the value of an already fulfilled Promise and is simply copied unchanged into the output array.</p>
<blockquote>
<p>Promise.all() æ¯”å‰é¢æè¿°çš„è¦çµæ´»ä¸€äº›ã€‚è¾“å…¥æ•°ç»„å¯ä»¥åŒ…å« Promise å¯¹è±¡å’Œé Promise å€¼ã€‚å¦‚æœæ•°ç»„çš„å…ƒç´ ä¸æ˜¯ Promiseï¼Œåˆ™å°†å…¶è§†ä¸ºå·²å…‘ç°çš„ Promise çš„å€¼ï¼Œå¹¶åŸå°ä¸åŠ¨åœ°å¤åˆ¶åˆ°è¾“å‡ºæ•°ç»„ä¸­ã€‚</p>
</blockquote>
<p>The Promise returned by Promise.all() rejects when any of the input Promises is rejected. This happens immediately upon the first rejection and can happen while other input Promises are still pending. In ES2020, Promise.allSettled() takes an array of input Promises and returns a Promise, just like Promise.all() does. But Promise.allSettled() never rejects the returned Promise, and it does not fulfill that Promise until all of the input Promises have settled. The Promise resolves to an array of objects, with one object for each input Promise. Each of these returned objects has a status property set to â€œfulfilledâ€ or â€œrejected.â€ If the status is â€œfulfilledâ€, then the object will also have a value property that gives the fulfillment value. And if the status is â€œrejectedâ€, then the object will also have a reason property that gives the error or rejection value of the corresponding Promise:</p>
<blockquote>
<p>å½“ä»»ä½•è¾“å…¥çš„ Promise è¢«æ‹’ç»æ—¶ï¼ŒPromise.all() è¿”å›çš„ Promise ä¹Ÿä¼šè¢«æ‹’ç»ã€‚è¿™åœ¨ç¬¬ä¸€æ¬¡æ‹’ç»æ—¶ç«‹å³å‘ç”Ÿï¼Œå¯èƒ½å…¶ä»–è¾“å…¥ Promise ä»æ˜¯å¾…å®šçŠ¶æ€ã€‚åœ¨ ES2020 ä¸­ï¼ŒPromise.allSettled() æ¥å—è¾“å…¥çš„ Promise æ•°ç»„ï¼Œå¹¶è¿”å› Promiseï¼Œå°±åƒ Promise.all() ä¸€æ ·ã€‚ä½†æ˜¯ Promise.allSettled() æ°¸è¿œä¸ä¼šæ‹’ç»è¿”å›çš„ Promiseï¼Œå¹¶ä¸”ä¸ä¼šå…‘ç°è¿™ä¸ª Promiseï¼Œç›´åˆ°æ‰€æœ‰è¾“å…¥ Promise å…¨éƒ¨å·²æ•²å®šã€‚Promise è§£æä¸ºä¸€ç»„å¯¹è±¡ï¼Œæ¯ä¸ªè¾“å…¥ Promise éƒ½æœ‰ä¸€ä¸ªå¯¹è±¡ã€‚æ¯ä¸ªè¿”å›çš„å¯¹è±¡ä¸­æœ‰ä¸€ä¸ªçŠ¶æ€å±æ€§è®¾ç½®ä¸ºâ€œå·²å…‘ç°â€æˆ–â€œå·²æ‹’ç»â€ã€‚å¦‚æœçŠ¶æ€ä¸ºâ€œå·²å…‘ç°â€ï¼Œåˆ™å¯¹è±¡è¿˜å°†å…·æœ‰ä¸€ä¸ª value å±æ€§ï¼Œè¯¥å±æ€§æä¾›å…‘ç°å€¼ã€‚å¹¶ä¸”ï¼Œå¦‚æœçŠ¶æ€ä¸ºâ€œå·²æ‹’ç»â€ï¼Œåˆ™å¯¹è±¡è¿˜å°†å…·æœ‰ä¸€ä¸ª reason å±æ€§ï¼Œè¯¥å±æ€§ç»™å‡ºç›¸åº”çš„ Promise çš„å¼‚å¸¸æˆ–æ‹’ç»å€¼ï¼š</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Promise</span>.<span class="title function_">allSettled</span>([<span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="number">1</span>), <span class="title class_">Promise</span>.<span class="title function_">reject</span>(<span class="number">2</span>), <span class="number">3</span>]).<span class="title function_">then</span>(<span class="function"><span class="params">results</span> =&gt;</span> &#123;</span><br><span class="line">    results[<span class="number">0</span>]  <span class="comment">// =&gt; &#123; status: &quot;fulfilled&quot;, value: 1 &#125;</span></span><br><span class="line">    results[<span class="number">1</span>]  <span class="comment">// =&gt; &#123; status: &quot;rejected&quot;, reason: 2 &#125;</span></span><br><span class="line">    results[<span class="number">2</span>]  <span class="comment">// =&gt; &#123; status: &quot;fulfilled&quot;, value: 3 &#125;</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Occasionally, you may want to run a number of Promises at once but may only care about the value of the first one to fulfill. In that case, you can use Promise.race() instead of Promise.all(). It returns a Promise that is fulfilled or rejected when the first of the Promises in the input array is fulfilled or rejected. (Or, if there are any non-Promise values in the input array, it simply returns the first of those.)</p>
<blockquote>
<p>æœ‰æ—¶ï¼Œå¯èƒ½æƒ³ä¸€æ¬¡è¿è¡Œå¤šä¸ª Promiseï¼Œä½†å¯èƒ½åªå…³å¿ƒç¬¬ä¸€ä¸ªè¦å…‘ç°çš„å€¼ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨ Promise.race() ä»£æ›¿ Promise.all()ã€‚å½“è¾“å…¥æ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ª Promise æ˜¯å·²å…‘ç°æˆ–å·²æ‹’ç»çŠ¶æ€æ—¶ï¼Œå®ƒè¿”å›ä¸€ä¸ªå·²å…‘ç°æˆ–å·²æ‹’ç»çš„ Promiseã€‚ï¼ˆæˆ–è€…ï¼Œå¦‚æœè¾“å…¥æ•°ç»„ä¸­æœ‰ä»»ä½•é Promise å€¼ï¼Œåˆ™åªè¿”å›å…¶ä¸­çš„ç¬¬ä¸€ä¸ªã€‚ï¼‰</p>
</blockquote>
<h3 id="13-2-6-Making-Promises"><a href="#13-2-6-Making-Promises" class="headerlink" title="13.2.6 Making Promises"></a>13.2.6 Making Promises</h3><p>Weâ€™ve used the Promise-returning function fetch() in many of the previous examples because it is one of the simplest functions built in to web browsers that returns a Promise. Our discussion of Promises has also relied on hypothetical Promise-returning functions getJSON() and wait(). Functions written to return Promises really are quite useful, and this section shows how you can create your own Promise-based APIs. In particular, weâ€™ll show implementations of getJSON() and wait().</p>
<blockquote>
<p>åœ¨ä¹‹å‰çš„è®¸å¤šç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬éƒ½ä½¿ç”¨äº† Promise è¿”å›å‡½æ•° fetch()ï¼Œå› ä¸ºå®ƒæ˜¯å†…ç½®äº Web æµè§ˆå™¨ä¸­çš„æœ€ç®€å•çš„è¿”å› Promise çš„å‡½æ•°ä¹‹ä¸€ã€‚æˆ‘ä»¬å¯¹ Promise çš„è®¨è®ºè¿˜ä¾èµ–äºå‡è®¾çš„ Promise è¿”å›å‡½æ•° getJSON() å’Œ wait()ã€‚ç¼–å†™ç”¨äºè¿”å› Promise çš„å‡½æ•°ç¡®å®éå¸¸æœ‰ç”¨ï¼Œæœ¬èŠ‚è¯´æ˜å¦‚ä½•åˆ›å»ºè‡ªå·±çš„åŸºäº Promise çš„ APIã€‚ç‰¹åˆ«æ˜¯ï¼Œæˆ‘ä»¬å°†å±•ç¤º getJSON() å’Œ wait() çš„å®ç°ã€‚</p>
</blockquote>
<h4 id="PROMISES-BASED-ON-OTHER-PROMISES"><a href="#PROMISES-BASED-ON-OTHER-PROMISES" class="headerlink" title="PROMISES BASED ON OTHER PROMISES"></a>PROMISES BASED ON OTHER PROMISES</h4><p>It is easy to write a function that returns a Promise if you have some other Promise-returning function to start with. Given a Promise, you can always create (and return) a new one by calling .then(). So if we use the existing fetch() function as a starting point, we can write getJSON() like this:</p>
<blockquote>
<p>å¦‚æœä»¥ Promise è¿”å›å‡½æ•°ä½œä¸ºå¼€å¤´æ¥å†™ä¸€ä¸ªè¿”å› Promise çš„å‡½æ•°æ˜¯å¾ˆå®¹æ˜“çš„ã€‚æœ‰äº† Promiseï¼Œæ€»æ˜¯å¯ä»¥é€šè¿‡è°ƒç”¨ .then() åˆ›å»ºï¼ˆå¹¶è¿”å›ï¼‰ä¸€ä¸ªæ–°çš„ Promiseã€‚å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨ç°æœ‰çš„ fetch() å‡½æ•°ä½œä¸ºèµ·ç‚¹ï¼Œåˆ™å¯ä»¥è¿™æ ·ç¼–å†™ getJSON()ï¼š</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">getJSON</span>(<span class="params">url</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">fetch</span>(url).<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> response.<span class="title function_">json</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The code is trivial because the Response object of the fetch() API has a predefined json() method. The json() method returns a Promise, which we return from our callback (the callback is an arrow function with a single-expression body, so the return is implicit), so the Promise returned by getJSON() resolves to the Promise returned by response.json(). When that Promise fulfills, the Promise returned by getJSON() fulfills to the same value. Note that there is no error handling in this getJSON() implementation. Instead of checking response.ok and the Content-Type header, we instead just allow the json() method to reject the Promise it returned with a SyntaxError if the response body cannot be parsed as JSON.</p>
<blockquote>
<p>è¯¥ä»£ç å¾ˆç®€å•ï¼Œå› ä¸º fetch() API çš„ Response å¯¹è±¡å…·æœ‰é¢„å®šä¹‰çš„ json() æ–¹æ³•ã€‚æˆ‘ä»¬ä»å›è°ƒï¼ˆè¯¥å›è°ƒæ˜¯å¸¦æœ‰å•ä¸ªè¡¨è¾¾å¼ä¸»ä½“çš„ç®­å¤´å‡½æ•°ï¼Œå› æ­¤è¿”å›å€¼æ˜¯éšå¼çš„ï¼‰ä¸­é€šè¿‡ json() æ–¹æ³•è¿”å›ä¸€ä¸ª Promiseï¼Œå› æ­¤ getJSON() è¿”å›çš„ Promise è§£æä¸º response.json()ã€‚å½“è¯¥ Promise å…‘ç°æ—¶ï¼Œç”± getJSON() è¿”å›çš„ Promise å°†å…‘ç°ä¸ºç›¸åŒçš„å€¼ã€‚è¯·æ³¨æ„ï¼Œæ­¤ getJSON() å®ç°ä¸­æ²¡æœ‰å¼‚å¸¸å¤„ç†ã€‚å¦‚æœä¸èƒ½å°† response ä¸»ä½“è§£æä¸º JSONï¼Œåˆ™æ— éœ€æ£€æŸ¥ response.ok å’Œ Content-Type æ ‡å¤´ï¼Œè€Œåªéœ€å…è®¸ json() æ–¹æ³•æ‹’ç»å®ƒçš„ Promise å¹¶è¿”å› SyntaxErrorã€‚</p>
</blockquote>
<p>Letâ€™s write another Promise-returning function, this time using getJSON() as the source of the initial Promise:</p>
<blockquote>
<p>è®©æˆ‘ä»¬ç¼–å†™å¦ä¸€ä¸ª Promise è¿”å›å‡½æ•°ï¼Œè¿™æ¬¡ä½¿ç”¨ getJSON() ä½œä¸ºåˆå§‹ Promise çš„æ¥æºï¼š</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">getHighScore</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">getJSON</span>(<span class="string">&quot;/api/user/profile&quot;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">profile</span> =&gt;</span> profile.<span class="property">highScore</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Weâ€™re assuming that this function is part of some sort of web-based game and that the URL â€œ&#x2F;api&#x2F;user&#x2F;profileâ€ returns a JSON-formatted data structure that includes a highScore property.</p>
<blockquote>
<p>æˆ‘ä»¬å‡è®¾æ­¤å‡½æ•°æ˜¯æŸç§åŸºäºç½‘ç»œçš„æ¸¸æˆçš„ä¸€éƒ¨åˆ†ï¼Œå¹¶ä¸” URLâ€œ&#x2F;api&#x2F;user&#x2F;profileâ€è¿”å›çš„æ˜¯åŒ…å« highScore å±æ€§çš„ JSON æ ¼å¼çš„æ•°æ®ç»“æ„ã€‚</p>
</blockquote>
<h4 id="PROMISES-BASED-ON-SYNCHRONOUS-VALUES"><a href="#PROMISES-BASED-ON-SYNCHRONOUS-VALUES" class="headerlink" title="PROMISES BASED ON SYNCHRONOUS VALUES"></a>PROMISES BASED ON SYNCHRONOUS VALUES</h4><p>Sometimes, you may need to implement an existing Promise-based API and return a Promise from a function, even though the computation to be performed does not actually require any asynchronous operations. In that case, the static methods Promise.resolve() and Promise.reject() will do what you want. Promise.resolve() takes a value as its single argument and returns a Promise that will immediately (but asynchronously) be fulfilled to that value. Similarly, Promise.reject() takes a single argument and returns a Promise that will be rejected with that value as the reason. (To be clear: the Promises returned by these static methods are not already fulfilled or rejected when they are returned, but they will fulfill or reject immediately after the current synchronous chunk of code has finished running. Typically, this happens within a few milliseconds unless there are many pending asynchronous tasks waiting to run.)</p>
<blockquote>
<p>æœ‰æ—¶ï¼Œå³ä½¿è¦æ‰§è¡Œçš„è®¡ç®—å®é™…ä¸Šä¸éœ€è¦ä»»ä½•å¼‚æ­¥æ“ä½œï¼Œä¹Ÿå¯èƒ½éœ€è¦å®ç°ç°æœ‰çš„åŸºäº Promise çš„ API å¹¶ä»å‡½æ•°è¿”å› Promiseã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé™æ€æ–¹æ³• Promise.resolve() å’Œ Promise.reject() ä¼šåšæ‚¨æƒ³è¦çš„ã€‚Promise.resolve() é‡‡ç”¨ä¸€ä¸ªå•ä¸ªå®å‚å€¼ï¼Œå¹¶è¿”å›ä¸€ä¸ª Promiseï¼Œè¯¥ Promise å°†ç«‹å³ï¼ˆä½†å¼‚æ­¥åœ°ï¼‰å…‘ç°ä¸ºè¯¥å€¼ã€‚åŒæ ·ï¼ŒPromise.reject() æ¥å—ä¸€ä¸ªå®å‚å€¼ï¼Œå¹¶è¿”å›ä¸€ä¸ª Promiseï¼Œè¯¥å€¼å°†ä½œä¸ºè¢«æ‹’ç»çš„åŸå› ã€‚ï¼ˆè¯·æ³¨æ„ï¼šè¿™äº›é™æ€æ–¹æ³•è¿”å›çš„ Promise åœ¨è¿”å›æ—¶å°šæœªå…‘ç°æˆ–æ‹’ç»ï¼Œä½†æ˜¯å®ƒä»¬å°†åœ¨å½“å‰åŒæ­¥ä»£ç å—è¿è¡Œå®Œæ¯•åç«‹å³å…‘ç°æˆ–æ‹’ç»ã€‚é€šå¸¸ï¼Œè¿™ç§æƒ…å†µä¼šåœ¨å‡ æ¯«ç§’å†…å‘ç”Ÿï¼Œé™¤éæœ‰è®¸å¤šç­‰å¾…æ‰§è¡Œçš„å¾…å¤„ç†å¼‚æ­¥ä»»åŠ¡ã€‚ï¼‰</p>
</blockquote>
<p>Recall from Â§13.2.3 that a resolved Promise is not the same thing as a fulfilled Promise. When we call Promise.resolve(), we typically pass the fulfillment value to create a Promise object that will very soon fulfill to that value. The method is not named Promise.fulfill(), however. If you pass a Promise p1 to Promise.resolve(), it will return a new Promise p2, which is immediately resolved, but which will not be fulfilled or rejected until p1 is fulfilled or rejected.</p>
<blockquote>
<p>å›é¡¾ Â§13.2.3ï¼Œå·²å†³è®®çš„ Promise ä¸å·²å…‘ç°çš„ Promise ä¸åŒã€‚å½“æˆ‘ä»¬è°ƒç”¨ Promise.resolve() æ—¶ï¼Œé€šå¸¸ä¼šä¼ é€’å…‘ç°å€¼ä»¥åˆ›å»ºä¸€ä¸ª Promise å¯¹è±¡ï¼Œè¯¥å¯¹è±¡å°†å¾ˆå¿«å…‘ç°è¯¥å€¼ã€‚ä½†æ˜¯ï¼Œè¯¥æ–¹æ³•æœªå‘½åä¸º Promise.fulfill()ã€‚å¦‚æœå°† Promise p1 ä¼ é€’ç»™ Promise.resolve()ï¼Œå®ƒå°†è¿”å›ä¸€ä¸ªæ–°çš„ Promise p2ï¼Œè¯¥ p2 ç«‹å³è¢«å†³è®®ï¼Œä½†æ˜¯ç›´åˆ° p1 è¢«å…‘ç°æˆ–æ‹’ç»ï¼Œè¯¥ Promise p2 æ‰ä¼šè¢«å…‘ç°æˆ–æ‹’ç»ã€‚ </p>
</blockquote>
<p>It is possible, but unusual, to write a Promise-based function where the value is computed synchronously and returned asynchronously with Promise.resolve(). It is fairly common, however, to have synchronous special cases within an asynchronous function, and you can handle these special cases with Promise.resolve() and Promise.reject(). In particular, if you detect error conditions (such as bad argument values) before beginning an asynchronous operation, you can report that error by returning a Promise created with Promise.reject(). (You could also just throw an error synchronously in that case, but that is considered poor form because then the caller of your function needs to write both a synchronous catch clause and use an asynchronous .catch() method to handle errors.) Finally, Promise.resolve() is sometimes useful to create the initial Promise in a chain of Promises. Weâ€™ll see a couple of examples that use it this way.</p>
<blockquote>
<p>å¯ä»¥ï¼ˆä½†ä¸å¸¸è§ï¼‰ç¼–å†™ä¸€ä¸ªåŸºäº Promise çš„å‡½æ•°ï¼ŒåŒæ­¥è®¡ç®—çš„å€¼é€šè¿‡é€šè¿‡ Promise.resolve() å¼‚æ­¥è¿”å›ã€‚ä½†æ˜¯ï¼Œåœ¨å¼‚æ­¥å‡½æ•°ä¸­åŒ…å«åŒæ­¥ç‰¹æ®Šæƒ…å†µæ˜¯å¾ˆå¸¸è§çš„ï¼Œå¯ä»¥ä½¿ç”¨ Promise.resolve() å’Œ Promise.reject() å¤„ç†è¿™äº›ç‰¹æ®Šæƒ…å†µã€‚ç‰¹åˆ«æ˜¯ï¼Œå¦‚æœåœ¨å¼€å§‹å¼‚æ­¥æ“ä½œä¹‹å‰æ£€æµ‹åˆ°å¼‚å¸¸æ¡ä»¶ï¼ˆä¾‹å¦‚å¼‚å¸¸çš„å®å‚å€¼ï¼‰ï¼Œåˆ™å¯ä»¥é€šè¿‡è¿”å›ä½¿ç”¨ Promise.reject() åˆ›å»ºçš„ Promise æ¥æŠ¥å‘Šè¯¥å¼‚å¸¸ã€‚ï¼ˆåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¹Ÿå¯ä»¥åŒæ­¥å¼•å‘å¼‚å¸¸ï¼Œä½†è¿™è¢«è®¤ä¸ºæ˜¯è¾ƒå·®çš„å½¢å¼ï¼Œå› ä¸ºå‡½æ•°çš„è°ƒç”¨è€…éœ€è¦åŒæ—¶ç¼–å†™åŒæ­¥ catch å­å¥å¹¶ä½¿ç”¨å¼‚æ­¥ .catch() æ–¹æ³•æ¥å¤„ç†å¼‚å¸¸ã€‚ï¼‰æœ€åï¼ŒPromise.resolve() æœ‰æ—¶å¯ç”¨äºåœ¨ Promise é“¾ä¸­åˆ›å»ºåˆå§‹ Promiseã€‚æˆ‘ä»¬å°†çœ‹åˆ°å‡ ä¸ªä½¿ç”¨è¿™ç§æ–¹å¼çš„ç¤ºä¾‹ã€‚ </p>
</blockquote>
<h4 id="PROMISES-FROM-SCRATCH"><a href="#PROMISES-FROM-SCRATCH" class="headerlink" title="PROMISES FROM SCRATCH"></a>PROMISES FROM SCRATCH</h4><p>For both getJSON() and getHighScore(), we started off by calling an existing function to get an initial Promise, and created and returned a new Promise by calling the .then() method of that initial Promise. But what about writing a Promise-returning function when you canâ€™t use another Promise-returning function as the starting point? In that case, you use the Promise() constructor to create a new Promise object that you have complete control over. Hereâ€™s how it works: you invoke the Promise() constructor and pass a function as its only argument. The function you pass should be written to expect two parameters, which, by convention, should be named resolve and reject. The constructor synchronously calls your function with function arguments for the resolve and reject parameters. After calling your function, the Promise() constructor returns the newly created Promise. That returned Promise is under the control of the function you passed to the constructor. That function should perform some asynchronous operation and then call the resolve function to resolve or fulfill the returned Promise or call the reject function to reject the returned Promise. Your function does not have to be asynchronous: it can call resolve or reject synchronously, but the Promise will still be resolved, fulfilled, or rejected asynchronously if you do this.</p>
<blockquote>
<p>å¯¹äº getJSON() å’Œ getHighScore()ï¼Œæˆ‘ä»¬é¦–å…ˆè°ƒç”¨ç°æœ‰å‡½æ•°ä»¥è·å–åˆå§‹ Promiseï¼Œç„¶åé€šè¿‡è°ƒç”¨è¯¥åˆå§‹ Promise çš„ .then() æ–¹æ³•åˆ›å»ºå¹¶è¿”å›æ–°çš„ Promiseã€‚ä½†æ˜¯ï¼Œå½“ä¸èƒ½ä½¿ç”¨å¦ä¸€ä¸ªè¿”å› Promise å‡½æ•°ä½œä¸ºèµ·ç‚¹æ—¶ï¼Œå¦‚ä½•ç¼–å†™è¿”å› Promise å‡½æ•°å‘¢ï¼Ÿåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨ Promise() æ„é€ å‡½æ•°åˆ›å»ºä¸€ä¸ªå¯ä»¥å®Œå…¨æ§åˆ¶çš„æ–° Promise å¯¹è±¡ã€‚å®ƒæ˜¯è¿™æ ·å·¥ä½œçš„ï¼šè°ƒç”¨ Promise() æ„é€ å‡½æ•°å¹¶å°†ä¸€ä¸ªå‡½æ•°ä½œä¸ºå”¯ä¸€å®å‚ä¼ é€’ã€‚ä¼ é€’çš„å‡½æ•°åº”ç¼–å†™ä¸ºåŒ…å«ä¸¤ä¸ªå‚æ•°ï¼ŒæŒ‰ç…§æƒ¯ä¾‹ï¼Œåº”å°†å…¶å‘½åä¸º resolve å’Œ rejectã€‚æ„é€ å‡½æ•°ä¼šåŒæ­¥è°ƒç”¨ä½¿ç”¨ resolve å’Œ reject å‚æ•°çš„å‡½æ•°ã€‚è°ƒç”¨å‡½æ•°åï¼ŒPromise() æ„é€ å‡½æ•°å°†è¿”å›æ–°åˆ›å»ºçš„ Promiseã€‚è¿”å›çš„ Promise å—ä¼ é€’ç»™æ„é€ å‡½æ•°çš„å‡½æ•°çš„æ§åˆ¶ã€‚è¯¥å‡½æ•°åº”è¯¥æ‰§è¡Œä¸€äº›å¼‚æ­¥æ“ä½œï¼Œç„¶åè°ƒç”¨ resolve å‡½æ•°æ¥å†³è®®æˆ–å…‘ç°è¿”å›çš„ Promiseï¼Œæˆ–è€…è°ƒç”¨ reject å‡½æ•°æ¥æ‹’ç»è¿”å›çš„ Promiseã€‚å‡½æ•°ä¸å¿…æ˜¯å¼‚æ­¥çš„ï¼šå®ƒå¯ä»¥åŒæ­¥åœ°è°ƒç”¨ resolve æˆ–æ‹’ç»ï¼Œä½†æ˜¯å¦‚æœè¿™æ ·åšï¼ŒPromise ä»å°†è¢«å¼‚æ­¥åœ°å†³è®®ï¼Œå…‘ç°æˆ–æ‹’ç»ã€‚</p>
</blockquote>
<p>It can be hard to understand the functions passed to a function passed to a constructor by just reading about it, but hopefully some examples will make this clear. Hereâ€™s how to write the Promise-based wait() function that we used in various examples earlier in the chapter:</p>
<blockquote>
<p>ä»…ä»…é˜…è¯»ä¸€ä¸‹å¾ˆéš¾ç†è§£ä¼ é€’ç»™æ„é€ å‡½æ•°çš„å‡½æ•°ï¼Œä½†æ˜¯å¸Œæœ›æœ‰ä¸€äº›ä¾‹å­å¯ä»¥ä½¿è¿™ä¸€ç‚¹å˜å¾—æ¸…æ¥šã€‚è¿™æ˜¯åœ¨æœ¬ç« å‰é¢çš„å„ç§ç¤ºä¾‹ä¸­ä½¿ç”¨çš„åŸºäº Promise çš„ wait() å‡½æ•°çš„ç¼–å†™æ–¹æ³•ï¼š</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">wait</span>(<span class="params">duration</span>) &#123;</span><br><span class="line">    <span class="comment">// Create and return a new Promise</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123; <span class="comment">// These control the Promise</span></span><br><span class="line">        <span class="comment">// If the argument is invalid, reject the Promise</span></span><br><span class="line">        <span class="keyword">if</span> (duration &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Time travel not yet implemented&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Otherwise, wait asynchronously and then resolve the Promise.</span></span><br><span class="line">        <span class="comment">// setTimeout will invoke resolve() with no arguments, which means</span></span><br><span class="line">        <span class="comment">// that the Promise will fulfill with the undefined value.</span></span><br><span class="line">        <span class="built_in">setTimeout</span>(resolve, duration);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Note that the pair of functions that you use to control the fate of a Promise created with the Promise() constructor are named resolve() and reject(), not fulfill() and reject(). If you pass a Promise to resolve(), the returned Promise will resolve to that new Promise. Often, however, you will pass a non-Promise value, which fulfills the returned Promise with that value.</p>
<blockquote>
<p>è¯·æ³¨æ„ï¼Œç”¨äºæ§åˆ¶ç”± Promise() æ„é€ å‡½æ•°åˆ›å»ºçš„ Promise å‘½è¿çš„ä¸€å¯¹å‡½æ•°åˆ†åˆ«å‘½åä¸º resolve() å’Œ reject()ï¼Œè€Œä¸æ˜¯ fulfill() å’Œ reject()ã€‚å¦‚æœä¼ é€’ä¸€ä¸ª Promise ç»™ resolve()ï¼Œåˆ™è¿”å›çš„ Promise å°†å†³è®®äºè¯¥æ–°çš„ Promiseã€‚ä½†æ˜¯ï¼Œé€šå¸¸ä¼šä¼ é€’ä¸€ä¸ªé Promise å€¼ï¼Œè¿”å›çš„ Promise ä¼šå…‘ç°è¿™ä¸ªå€¼ã€‚</p>
</blockquote>
<p>Example 13-1 is another example of using the Promise() constructor. This one implements our getJSON() function for use in Node, where the fetch() API is not built in. Remember that we started this chapter with a discussion of asynchronous callbacks and events. This example uses both callbacks and event handlers and is a good demonstration, therefore, of how we can implement Promise-based APIs on top of other styles of asynchronous programming.</p>
<blockquote>
<p>ç¤ºä¾‹ 13-1 æ˜¯ä½¿ç”¨ Promise() æ„é€ å‡½æ•°çš„å¦ä¸€ä¸ªç¤ºä¾‹ã€‚è¿™ä¸€èŠ‚å®ç°äº† Node ä¸­åœ¨æœªå†…ç½® fetch() API ä½¿ç”¨çš„ getJSON() å‡½æ•°ã€‚è¯·è®°ä½ï¼Œæœ¬ç« å¼€å§‹æ—¶è®¨è®ºäº†å¼‚æ­¥å›è°ƒå’Œäº‹ä»¶ã€‚æ­¤ç¤ºä¾‹åŒæ—¶ä½¿ç”¨äº†å›è°ƒå’Œäº‹ä»¶å¤„ç†ç¨‹åºï¼Œå› æ­¤å¾ˆå¥½åœ°æ¼”ç¤ºäº†å¦‚ä½•åœ¨å…¶ä»–é£æ ¼çš„å¼‚æ­¥ç¼–ç¨‹ä¹‹ä¸Šå®ç°åŸºäº Promise çš„ APIã€‚</p>
</blockquote>
<p>Example 13-1. An asynchronous getJSON() function</p>
<blockquote>
<p>ç¤ºä¾‹ 13-1 å¼‚æ­¥ getJSON() å‡½æ•°</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">&quot;http&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getJSON</span>(<span class="params">url</span>) &#123;</span><br><span class="line">    <span class="comment">// Create and return a new Promise</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// Start an HTTP GET request for the specified URL</span></span><br><span class="line">        request = http.<span class="title function_">get</span>(url, <span class="function"><span class="params">response</span> =&gt;</span> &#123; <span class="comment">// called when response starts</span></span><br><span class="line">            <span class="comment">// Reject the Promise if the HTTP status is wrong</span></span><br><span class="line">            <span class="keyword">if</span> (response.<span class="property">statusCode</span> !== <span class="number">200</span>) &#123;</span><br><span class="line">                <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`HTTP status <span class="subst">$&#123;response.statusCode&#125;</span>`</span>));</span><br><span class="line">                response.<span class="title function_">resume</span>();  <span class="comment">// so we don&#x27;t leak memory</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// And reject if the response headers are wrong</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (response.<span class="property">headers</span>[<span class="string">&quot;content-type&quot;</span>] !== <span class="string">&quot;application/json&quot;</span>) &#123;</span><br><span class="line">                <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Invalid content-type&quot;</span>));</span><br><span class="line">                response.<span class="title function_">resume</span>();  <span class="comment">// don&#x27;t leak memory</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Otherwise, register events to read the body of the response</span></span><br><span class="line">                <span class="keyword">let</span> body = <span class="string">&quot;&quot;</span>;</span><br><span class="line">                response.<span class="title function_">setEncoding</span>(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">                response.<span class="title function_">on</span>(<span class="string">&quot;data&quot;</span>, <span class="function"><span class="params">chunk</span> =&gt;</span> &#123; body += chunk; &#125;);</span><br><span class="line">                response.<span class="title function_">on</span>(<span class="string">&quot;end&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="comment">// When the response body is complete, try to parse it</span></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">let</span> parsed = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(body);</span><br><span class="line">                        <span class="comment">// If it parsed successfully, fulfill the Promise</span></span><br><span class="line">                        <span class="title function_">resolve</span>(parsed);</span><br><span class="line">                    &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">                        <span class="comment">// If parsing failed, reject the Promise</span></span><br><span class="line">                        <span class="title function_">reject</span>(e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// We also reject the Promise if the request fails before we</span></span><br><span class="line">        <span class="comment">// even get a response (such as when the network is down)</span></span><br><span class="line">        request.<span class="title function_">on</span>(<span class="string">&quot;error&quot;</span>, <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="title function_">reject</span>(error);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="13-2-7-Promises-in-Sequence"><a href="#13-2-7-Promises-in-Sequence" class="headerlink" title="13.2.7 Promises in Sequence"></a>13.2.7 Promises in Sequence</h3><p>Promise.all() makes it easy to run an arbitrary number of Promises in parallel. And Promise chains make it easy to express a sequence of a fixed number of Promises. Running an arbitrary number of Promises in sequence is trickier, however. Suppose, for example, that you have an array of URLs to fetch, but that to avoid overloading your network, you want to fetch them one at a time. If the array is of arbitrary length and unknown content, you canâ€™t write out a Promise chain in advance, so you need to build one dynamically, with code like this:</p>
<blockquote>
<p>Promise.all() ä½¿å¾—å¹¶è¡Œè¿è¡Œä»»æ„æ•°é‡çš„ Promise å˜å¾—å®¹æ˜“ã€‚Promise é“¾ä½¿è¡¨è¾¾å›ºå®šæ•°é‡çš„ Promise åºåˆ—å˜å¾—å®¹æ˜“ã€‚ä½†æ˜¯ï¼Œä¾æ¬¡æ‰§è¡Œä»»æ„æ•°é‡çš„ Promise ä¼šæ¯”è¾ƒæ£˜æ‰‹ã€‚ä¾‹å¦‚ï¼Œå‡è®¾æ‚¨è¦è·å–ä¸€ç»„ URLï¼Œä½†æ˜¯ä¸ºäº†é¿å…ç½‘ç»œè¿‡è½½ï¼Œå¸Œæœ›ä¸€æ¬¡è·å–ä¸€ä¸ª URLã€‚å¦‚æœæ•°ç»„çš„é•¿åº¦æ˜¯ä»»æ„çš„ä¸”å†…å®¹æœªçŸ¥ï¼Œåˆ™æ— æ³•æå‰å†™å‡º Promise é“¾ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨ä»¥ä¸‹ä»£ç åŠ¨æ€æ„å»ºä¸€ä¸ªï¼š</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">fetchSequentially</span>(<span class="params">urls</span>) &#123;</span><br><span class="line">    <span class="comment">// We&#x27;ll store the URL bodies here as we fetch them</span></span><br><span class="line">    <span class="keyword">const</span> bodies = [];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Here&#x27;s a Promise-returning function that fetches one body</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">fetchOne</span>(<span class="params">url</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">fetch</span>(url)</span><br><span class="line">            .<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> response.<span class="title function_">text</span>())</span><br><span class="line">            .<span class="title function_">then</span>(<span class="function"><span class="params">body</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="comment">// We save the body to the array, and we&#x27;re purposely</span></span><br><span class="line">                <span class="comment">// omitting a return value here (returning undefined)</span></span><br><span class="line">                bodies.<span class="title function_">push</span>(body);</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Start with a Promise that will fulfill right away (with value undefined)</span></span><br><span class="line">    <span class="keyword">let</span> p = <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="literal">undefined</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Now loop through the desired URLs, building a Promise chain</span></span><br><span class="line">    <span class="comment">// of arbitrary length, fetching one URL at each stage of the chain</span></span><br><span class="line">    <span class="keyword">for</span>(url <span class="keyword">of</span> urls) &#123;</span><br><span class="line">        p = p.<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="title function_">fetchOne</span>(url));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// When the last Promise in that chain is fulfilled, then the</span></span><br><span class="line">    <span class="comment">// bodies array is ready. So let&#x27;s return a Promise for that</span></span><br><span class="line">    <span class="comment">// bodies array. Note that we don&#x27;t include any error handlers:</span></span><br><span class="line">    <span class="comment">// we want to allow errors to propagate to the caller.</span></span><br><span class="line">    <span class="keyword">return</span> p.<span class="title function_">then</span>(<span class="function">() =&gt;</span> bodies);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>With this fetchSequentially() function defined, we could fetch the URLs one at a time with code much like the fetch-in-parallel code we used earlier to demonstrate Promise.all():</p>
<blockquote>
<p>å®šä¹‰äº†è¿™ä¸ª fetchSequentially() å‡½æ•°ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªä»£ç ä¸€æ¬¡æ¥è·å–å¤šä¸ª URLï¼Œå°±åƒæˆ‘ä»¬ä¹‹å‰ç”¨æ¥æ¼”ç¤º Promise.all() çš„å¹¶è¡Œè·å–ä»£ç ä¸€æ ·ï¼š</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">fetchSequentially</span>(urls)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">bodies</span> =&gt;</span> &#123; <span class="comment">/* do something with the array of strings */</span> &#125;)</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">error</span>(e));</span><br></pre></td></tr></table></figure>
<p>The fetchSequentially() function starts by creating a Promise that will fulfill immediately after it returns. It then builds a long, linear Promise chain off of that initial Promise and returns the last Promise in the chain. It is like setting up a row of dominoes and then knocking the first one over.</p>
<blockquote>
<p>fetchSequentially() å‡½æ•°é¦–å…ˆåˆ›å»ºä¸€ä¸ª Promiseï¼Œè¯¥ Promise å°†åœ¨è¿”å›åç«‹å³å…‘ç°ã€‚ç„¶åï¼Œå®ƒä»è¯¥åˆå§‹ Promise æ„å»ºä¸€ä¸ªé•¿çš„çº¿æ€§ Promise é“¾ï¼Œå¹¶è¿”å›é“¾ä¸­çš„æœ€åä¸€ä¸ª Promiseã€‚è¿™å°±åƒè®¾ç½®ä¸€æ’å¤šç±³è¯ºéª¨ç‰Œï¼Œç„¶åå°†ç¬¬ä¸€ä¸ªå¤šç±³è¯ºéª¨ç‰Œæ’å€’ä¸€æ ·ã€‚</p>
</blockquote>
<p>There is another (possibly more elegant) approach that we can take. Rather than creating the Promises in advance, we can have the callback for each Promise create and return the next Promise. That is, instead of creating and chaining a bunch of Promises, we instead create Promises that resolve to other Promises. Rather than creating a domino-like chain of Promises, we are instead creating a sequence of Promises nested one inside the other like a set of matryoshka dolls. With this approach, our code can return the first (outermost) Promise, knowing that it will eventually fulfill (or reject!) to the same value that the last (innermost) Promise in the sequence does. The promiseSequence() function that follows is written to be generic and is not specific to URL fetching. It is here at the end of our discussion of Promises because it is complicated. If youâ€™ve read this chapter carefully, however, I hope youâ€™ll be able to understand how it works. In particular, note that the nested function inside promiseSequence() appears to call itself recursively, but because the â€œrecursiveâ€ call is through a then() method, there is not actually any traditional recursion happening:</p>
<blockquote>
<p>æˆ‘ä»¬å¯ä»¥é‡‡ç”¨å¦ä¸€ç§æ–¹æ³•ï¼ˆå¯èƒ½æ›´ä¼˜é›…ï¼‰ã€‚é™¤äº†æå‰åˆ›å»º Promise å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä¸ºæ¯ä¸ª Promise åˆ›å»ºå›è°ƒï¼Œå¹¶è¿”å›ä¸‹ä¸€ä¸ª Promiseã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬æ²¡æœ‰åˆ›å»ºå’Œé“¾æ¥ä¸€å † Promiseï¼Œè€Œæ˜¯åˆ›å»ºäº†å†³è®®äºå…¶ä»–æ‰¿è¯ºçš„æ‰¿è¯ºã€‚ä¸å…¶åˆ›å»ºç±»ä¼¼å¤šç±³è¯ºéª¨ç‰Œçš„ Promise é“¾ï¼Œä¸å¦‚åˆ›å»ºä¸€ç³»åˆ—å½¼æ­¤åµŒå¥—åœ¨ä¸€èµ·çš„ Promise åºåˆ—ï¼Œå°±åƒä¿„ç½—æ–¯å¥—å¨ƒä¸€æ ·ã€‚ä½¿ç”¨è¿™ç§æ–¹æ³•ï¼Œæˆ‘ä»¬çš„ä»£ç å¯ä»¥çŸ¥é“ç¬¬ä¸€ä¸ªï¼ˆæœ€å¤–é¢çš„ï¼‰Promise æœ€ç»ˆå°†å…‘ç°ï¼ˆæˆ–æ‹’ç»ï¼ï¼‰ï¼Œä½¿å…¶è¿”å›åºåˆ—ä¸­æœ€åä¸€ä¸ªï¼ˆæœ€é‡Œé¢çš„ï¼‰Promise ç›¸åŒçš„å€¼ã€‚åé¢æ˜¯é€šç”¨çš„ promiseSequence() å‡½æ•°ï¼Œå¹¶ä¸ç‰¹å®šäº URL æå–ã€‚å› ä¸ºå®ƒå¾ˆå¤æ‚ï¼Œæ‰€ä»¥å°†å®ƒæ”¾åœ¨æˆ‘ä»¬å¯¹ Promise çš„è®¨è®ºçš„ç»“å°¾ã€‚ä½†æ˜¯ï¼Œå¦‚æœä»”ç»†é˜…è¯»äº†æœ¬ç« ï¼Œå¸Œæœ›èƒ½ç†è§£å®ƒçš„å·¥ä½œåŸç†ã€‚ç‰¹åˆ«è¦æ³¨æ„çš„æ˜¯ï¼ŒpromiseSequence() ä¸­çš„åµŒå¥—å‡½æ•°ç±»ä¼¼é€’å½’åœ°è°ƒç”¨è‡ªèº«ï¼Œä½†æ˜¯ç”±äºâ€œé€’å½’â€è°ƒç”¨æ˜¯é€šè¿‡ then() æ–¹æ³•è¿›è¡Œçš„ï¼Œå› æ­¤å®é™…ä¸Šæ²¡æœ‰å‘ç”Ÿä»»ä½•ä¼ ç»Ÿçš„é€’å½’ï¼š</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This function takes an array of input values and a &quot;promiseMaker&quot; function.</span></span><br><span class="line"><span class="comment">// For any input value x in the array, promiseMaker(x) should return a Promise</span></span><br><span class="line"><span class="comment">// that will fulfill to an output value. This function returns a Promise</span></span><br><span class="line"><span class="comment">// that fulfills to an array of the computed output values.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Rather than creating the Promises all at once and letting them run in</span></span><br><span class="line"><span class="comment">// parallel, however, promiseSequence() only runs one Promise at a time</span></span><br><span class="line"><span class="comment">// and does not call promiseMaker() for a value until the previous Promise</span></span><br><span class="line"><span class="comment">// has fulfilled.</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">promiseSequence</span>(<span class="params">inputs, promiseMaker</span>) &#123;</span><br><span class="line">    <span class="comment">// Make a private copy of the array that we can modify</span></span><br><span class="line">    inputs = [...inputs];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Here&#x27;s the function that we&#x27;ll use as a Promise callback</span></span><br><span class="line">    <span class="comment">// This is the pseudorecursive magic that makes this all work.</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">handleNextInput</span>(<span class="params">outputs</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (inputs.<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// If there are no more inputs left, then return the array</span></span><br><span class="line">            <span class="comment">// of outputs, finally fulfilling this Promise and all the</span></span><br><span class="line">            <span class="comment">// previous resolved-but-not-fulfilled Promises.</span></span><br><span class="line">            <span class="keyword">return</span> outputs;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// If there are still input values to process, then we&#x27;ll</span></span><br><span class="line">            <span class="comment">// return a Promise object, resolving the current Promise</span></span><br><span class="line">            <span class="comment">// with the future value from a new Promise.</span></span><br><span class="line">            <span class="keyword">let</span> nextInput = inputs.<span class="title function_">shift</span>(); <span class="comment">// Get the next input value,</span></span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">promiseMaker</span>(nextInput)  <span class="comment">// compute the next output value,</span></span><br><span class="line">                <span class="comment">// Then create a new outputs array with the new output value</span></span><br><span class="line">                .<span class="title function_">then</span>(<span class="function"><span class="params">output</span> =&gt;</span> outputs.<span class="title function_">concat</span>(output))</span><br><span class="line">                <span class="comment">// Then &quot;recurse&quot;, passing the new, longer, outputs array</span></span><br><span class="line">                .<span class="title function_">then</span>(handleNextInput);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Start with a Promise that fulfills to an empty array and use</span></span><br><span class="line">    <span class="comment">// the function above as its callback.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>([]).<span class="title function_">then</span>(handleNextInput);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This promiseSequence() function is intentionally generic. We can use it to fetch URLs with code like this:</p>
<blockquote>
<p>promiseSequence() å‡½æ•°æ˜¯é€šç”¨çš„ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒé€šè¿‡ä»¥ä¸‹ä»£ç æ¥è·å– URLï¼š</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Given a URL, return a Promise that fulfills to the URL body text</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fetchBody</span>(<span class="params">url</span>) &#123; <span class="keyword">return</span> <span class="title function_">fetch</span>(url).<span class="title function_">then</span>(<span class="function"><span class="params">r</span> =&gt;</span> r.<span class="title function_">text</span>()); &#125;</span><br><span class="line"><span class="comment">// Use it to sequentially fetch a bunch of URL bodies</span></span><br><span class="line"><span class="title function_">promiseSequence</span>(urls, fetchBody)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">bodies</span> =&gt;</span> &#123; <span class="comment">/* do something with the array of strings */</span> &#125;)</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="variable language_">console</span>.<span class="property">error</span>);</span><br></pre></td></tr></table></figure>
<h2 id="13-3-async-and-await"><a href="#13-3-async-and-await" class="headerlink" title="13.3 async and await"></a>13.3 async and await</h2><p>ES2017 introduces two new keywordsâ€”async and awaitâ€”that represent a paradigm shift in asynchronous JavaScript programming. These new keywords dramatically simplify the use of Promises and allow us to write Promise-based, asynchronous code that looks like synchronous code that blocks while waiting for network responses or other asynchronous events. Although it is still important to understand how Promises work, much of their complexity (and sometimes even their very presence!) vanishes when you use them with async and await.</p>
<blockquote>
<p>ES2017 å¼•å…¥äº†ä¸¤ä¸ªæ–°çš„å…³é”®å­—ï¼ˆasync å’Œ awaitï¼‰æè¿°å¼‚æ­¥ JavaScript ç¼–ç¨‹ä¸­çš„æ¨¡å¼è½¬å˜ã€‚è¿™äº›æ–°å…³é”®å­—æå¤§åœ°ç®€åŒ–äº† Promises çš„ä½¿ç”¨ï¼Œä½¿æˆ‘ä»¬èƒ½å¤Ÿç¼–å†™åŸºäº Promise çš„å¼‚æ­¥ä»£ç çœ‹èµ·æ¥åƒæ˜¯ç­‰å¾…ç½‘ç»œå“åº”æˆ–å…¶ä»–å¼‚æ­¥äº‹ä»¶è€Œé˜»å¡çš„åŒæ­¥ä»£ç ã€‚å°½ç®¡äº†è§£ Promises çš„å·¥ä½œåŸç†ä»ç„¶å¾ˆé‡è¦ï¼Œä½†æ˜¯å½“å°†å®ƒä»¬ä¸ async å’Œ await ä¸€èµ·ä½¿ç”¨æ—¶ï¼Œå®ƒä»¬çš„å¤§éƒ¨åˆ†å¤æ‚æ€§ï¼ˆæœ‰æ—¶ç”šè‡³æ˜¯å®ƒä»¬çš„å­˜åœ¨ï¼ï¼‰å°±æ¶ˆå¤±äº†ã€‚ </p>
</blockquote>
<p>As we discussed earlier in the chapter, asynchronous code canâ€™t return a value or throw an exception the way that regular synchronous code can. And this is why Promises are designed the way the are. The value of a fulfilled Promise is like the return value of a synchronous function. And the value of a rejected Promise is like a value thrown by a synchronous function. This latter similarity is made explicit by the naming of the .catch() method. async and await take efficient, Promise-based code and hide the Promises so that your asynchronous code can be as easy to read and as easy to reason about as inefficient, blocking, synchronous code.</p>
<blockquote>
<p>å¦‚æœ¬ç« å‰é¢æ‰€è¿°ï¼Œå¼‚æ­¥ä»£ç æ— æ³•åƒå¸¸è§„åŒæ­¥ä»£ç é‚£æ ·è¿”å›å€¼æˆ–å¼•å‘å¼‚å¸¸ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ Promise å¦‚æ­¤è®¾è®¡çš„åŸå› ã€‚å·²å…‘ç°çš„ Promise çš„å€¼ç±»ä¼¼äºåŒæ­¥å‡½æ•°çš„è¿”å›å€¼ã€‚è€Œä¸”å·²æ‹’ç»çš„ Promise çš„å€¼å°±åƒåŒæ­¥å‡½æ•°æŠ›å‡ºçš„å€¼ã€‚åè€…é€šè¿‡ç±»ä¼¼çš„ .catch() æ–¹æ³•å‘½åï¼Œä½¿å¾—è¡¨è¿°æ›´æ¸…æ™°ã€‚async å’Œ await ä½¿ç”¨é«˜æ•ˆçš„ã€åŸºäº Promise çš„ä»£ç å¹¶éšè— Promiseï¼Œä»¥ä¾¿å¼‚æ­¥ä»£ç å¯ä»¥åƒä½æ•ˆã€é˜»å¡ã€åŒæ­¥ä»£ç ä¸€æ ·å®¹æ˜“é˜…è¯»å’Œæ¨ç†ã€‚ </p>
</blockquote>
<h3 id="13-3-1-await-Expressions"><a href="#13-3-1-await-Expressions" class="headerlink" title="13.3.1 await Expressions"></a>13.3.1 await Expressions</h3><p>The await keyword takes a Promise and turns it back into a return value or a thrown exception. Given a Promise object p, the expression await p waits until p settles. If p fulfills, then the value of await p is the fulfillment value of p. On the other hand, if p is rejected, then the await p expression throws the rejection value of p. We donâ€™t usually use await with a variable that holds a Promise; instead, we use it before the invocation of a function that returns a Promise:</p>
<blockquote>
<p>å…³é”®å­— await æ¥å—ä¸€ä¸ª Promiseï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºè¿”å›å€¼æˆ–å¼•å‘çš„å¼‚å¸¸ã€‚ç»™å®šä¸€ä¸ª Promise å¯¹è±¡ pï¼Œè¡¨è¾¾å¼ await p ç­‰å¾…ç›´åˆ° p æ•²å®šã€‚å¦‚æœ p å…‘ç°ï¼Œåˆ™ç­‰å¾… p çš„å€¼å°±æ˜¯ p çš„å…‘ç°å€¼ã€‚å¦ä¸€æ–¹é¢ï¼Œå¦‚æœ p è¢«æ‹’ç»ï¼Œåˆ™ await p è¡¨è¾¾å¼å°†æŠ›å‡º p çš„æ‹’ç»å€¼ã€‚æˆ‘ä»¬é€šå¸¸ä¸å°† await ä¸ä¿å­˜ Promise çš„å˜é‡ä¸€èµ·ä½¿ç”¨ï¼›ç›¸åï¼Œæˆ‘ä»¬åœ¨è°ƒç”¨è¿”å› Promise çš„å‡½æ•°ä¹‹å‰ä½¿ç”¨å®ƒï¼š</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&quot;/api/user/profile&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> profile = <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br></pre></td></tr></table></figure>
<p>It is critical to understand right away that the await keyword does not cause your program to block and literally do nothing until the specified Promise settles. The code remains asynchronous, and the await simply disguises this fact. This means that any code that uses await is itself asynchronous.</p>
<blockquote>
<p>ç«‹å³äº†è§£è‡³å…³é‡è¦çš„ä¸€ç‚¹æ˜¯ï¼Œåœ¨æŒ‡å®šçš„ Promise æ•²å®šä¹‹å‰ï¼Œawait å…³é”®å­—ä¸ä¼šå¯¼è‡´ç¨‹åºé˜»å¡ï¼Œå¹¶ä¸”å®é™…ä¸Šä»€ä¹ˆä¹Ÿä¸åšã€‚ä»£ç ä¿æŒå¼‚æ­¥ï¼Œå¹¶ä¸” await åªæ˜¯æ©ç›–äº†è¿™ä¸€äº‹å®ã€‚è¿™æ„å‘³ç€ä½¿ç”¨ await çš„ä»»ä½•ä»£ç æœ¬èº«éƒ½æ˜¯å¼‚æ­¥çš„ã€‚ </p>
</blockquote>
<h3 id="13-3-2-async-Functions"><a href="#13-3-2-async-Functions" class="headerlink" title="13.3.2 async Functions"></a>13.3.2 async Functions</h3><p>Because any code that uses await is asynchronous, there is one critical rule: you can only use the await keyword within functions that have been declared with the async keyword. Hereâ€™s a version of the getHighScore() function from earlier in the chapter, rewritten to use async and await:</p>
<blockquote>
<p>å› ä¸ºä»»ä½•ä½¿ç”¨ await çš„ä»£ç éƒ½æ˜¯å¼‚æ­¥çš„ï¼Œæ‰€ä»¥æœ‰ä¸€ä¸ªå…³é”®è§„åˆ™ï¼šåªèƒ½åœ¨ä½¿ç”¨ async å…³é”®å­—å£°æ˜çš„å‡½æ•°ä¸­ä½¿ç”¨ await å…³é”®å­—ã€‚ä¸‹é¢æ˜¯æœ¬ç« å‰é¢çš„ getHighScore() å‡½æ•°çš„ä¸€ä¸ªç‰ˆæœ¬ï¼Œä½¿ç”¨ async å’Œ await é‡å†™ï¼š</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getHighScore</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&quot;/api/user/profile&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> profile = <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line">    <span class="keyword">return</span> profile.<span class="property">highScore</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Declaring a function async means that the return value of the function will be a Promise even if no Promise-related code appears in the body of the function. If an async function appears to return normally, then the Promise object that is the real return value of the function will resolve to that apparent return value. And if an async function appears to throw an exception, then the Promise object that it returns will be rejected with that exception.</p>
<blockquote>
<p>å¼‚æ­¥å£°æ˜å‡½æ•°æ„å‘³ç€å‡½æ•°çš„è¿”å›å€¼å°†æ˜¯ä¸€ä¸ª Promiseï¼Œå³ä½¿å‡½æ•°ä½“ä¸­æ²¡æœ‰å‡ºç°ä¸ Promise ç›¸å…³çš„ä»£ç ã€‚å¦‚æœå¼‚æ­¥å‡½æ•°çœ‹èµ·æ¥æ­£å¸¸è¿”å›ï¼Œé‚£ä¹ˆä½œä¸ºå‡½æ•°å®é™…è¿”å›å€¼çš„ Promise å¯¹è±¡å°†å†³è®®ä¸ºè¯¥è¿”å›å€¼ã€‚å¦‚æœä¸€ä¸ªå¼‚æ­¥å‡½æ•°å‡ºç°æŠ›å‡ºå¼‚å¸¸ï¼Œé‚£ä¹ˆå®ƒè¿”å›çš„ Promise å¯¹è±¡å°†è¢«é‚£ä¸ªå¼‚å¸¸æ‹’ç»ã€‚</p>
</blockquote>
<p>The getHighScore() function is declared async, so it returns a Promise. And because it returns a Promise, we can use the await keyword with it:</p>
<blockquote>
<p>getHighScore() å‡½æ•°è¢«å£°æ˜ä¸ºå¼‚æ­¥ï¼Œå› æ­¤å®ƒè¿”å›ä¸€ä¸ªæ‰¿è¯ºã€‚å› ä¸ºå®ƒè¿”å›ä¸€ä¸ªæ‰¿è¯ºï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ await å…³é”®å­—ï¼š</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">displayHighScore</span>(<span class="keyword">await</span> <span class="title function_">getHighScore</span>());</span><br></pre></td></tr></table></figure>
<p>But remember, that line of code will only work if it is inside another async function! You can nest await expressions within async functions as deeply as you want. But if youâ€™re at the top level [^2] or are inside a function that is not async for some reason, then you canâ€™t use await and have to deal with a returned Promise in the regular way:</p>
<blockquote>
<p>ä½†æ˜¯è¯·è®°ä½ï¼Œåªæœ‰åœ¨å¦ä¸€ä¸ªå¼‚æ­¥å‡½æ•°ä¸­ï¼Œè¯¥è¡Œä»£ç æ‰æœ‰æ•ˆï¼å¯ä»¥æ ¹æ®éœ€è¦åœ¨å¼‚æ­¥å‡½æ•°ä¸­åµŒå¥—ä»»ä½•å±‚ await è¡¨è¾¾å¼ã€‚ä½†æ˜¯ï¼Œå¦‚æœå¤„äºæœ€é«˜çº§åˆ« [^2] æˆ–ç”±äºæŸç§åŸå› è€Œå¤„äºä¸å¼‚æ­¥çš„å‡½æ•°å†…ï¼Œé‚£ä¹ˆæ‚¨æ— æ³•ä½¿ç”¨ await å¹¶ä¸”å¿…é¡»ä»¥å¸¸è§„æ–¹å¼å¤„ç†è¿”å›çš„ Promiseï¼š </p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">getHighScore</span>().<span class="title function_">then</span>(displayHighScore).<span class="title function_">catch</span>(<span class="variable language_">console</span>.<span class="property">error</span>);</span><br></pre></td></tr></table></figure>
<p>You can use the async keyword with any kind of function. It works with the function keyword as a statement or as an expression. It works with arrow functions and with the method shortcut form in classes and object literals. (See Chapter 8 for more about the various ways to write functions.)</p>
<blockquote>
<p>å¯ä»¥å°† async å…³é”®å­—ä¸ä»»ä½•å‡½æ•°ä¸€èµ·ä½¿ç”¨ã€‚å®ƒç”¨ä½œäº function å…³é”®å­—ä½œä¸ºè¯­å¥æˆ–è¡¨è¾¾å¼ã€‚å®ƒå¯ä¸ç®­å¤´å‡½æ•°ä»¥åŠç±»å’Œå¯¹è±¡å­—é¢é‡ä¸­çš„é€Ÿè®°æ–¹æ³•æ–¹å¼ä¸€èµ·ä½¿ç”¨ã€‚ï¼ˆæœ‰å…³å¦‚ä½•ç¼–å†™å‡½æ•°çš„å„ç§æ–¹æ³•ï¼Œè¯·å‚è§ç¬¬ 8 ç« ã€‚ï¼‰ </p>
</blockquote>
<h3 id="13-3-3-Awaiting-Multiple-Promises"><a href="#13-3-3-Awaiting-Multiple-Promises" class="headerlink" title="13.3.3 Awaiting Multiple Promises"></a>13.3.3 Awaiting Multiple Promises</h3><p>Suppose that weâ€™ve written our getJSON() function using async:</p>
<blockquote>
<p>å‡è®¾æˆ‘ä»¬å·²ç»ä½¿ç”¨ async ç¼–å†™äº† getJSON() å‡½æ•°ï¼š </p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getJSON</span>(<span class="params">url</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(url);</span><br><span class="line">    <span class="keyword">let</span> body = <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line">    <span class="keyword">return</span> body;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>And now suppose that we want to fetch two JSON values with this function:</p>
<blockquote>
<p>å¹¶ä¸”ç°åœ¨å‡è®¾æˆ‘ä»¬è¦ç”¨è¿™ä¸ªæ–¹æ³•è·å–ä¸¤ä¸ª JSON å€¼ï¼š</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> value1 = <span class="keyword">await</span> <span class="title function_">getJSON</span>(url1);</span><br><span class="line"><span class="keyword">let</span> value2 = <span class="keyword">await</span> <span class="title function_">getJSON</span>(url2);</span><br></pre></td></tr></table></figure>
<p>The problem with this code is that it is unnecessarily sequential: the fetch of the second URL will not begin until the first fetch is complete. If the second URL does not depend on the value obtained from the first URL, then we should probably try to fetch the two values at the same time. This is a case where the Promise-based nature of async functions shows. In order to await a set of concurrently executing async functions, we use Promise.all() just as we would if working with Promises directly:</p>
<blockquote>
<p>æ­¤ä»£ç çš„é—®é¢˜åœ¨äºï¼Œå®ƒä¸å¿…è¦åœ°æ˜¯è¿ç»­çš„ï¼šç¬¬äºŒä¸ª URL çš„è·å–è¦ç­‰åˆ°ç¬¬ä¸€æ¬¡è·å–å®Œæˆåæ‰èƒ½å¼€å§‹ã€‚å¦‚æœç¬¬äºŒä¸ª URL ä¸ä¾èµ–äºä»ç¬¬ä¸€ä¸ª URL è·å¾—çš„å€¼ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯èƒ½åº”è¯¥å°è¯•åŒæ—¶è·å–ä¸¤ä¸ªå€¼ã€‚è¿™æ˜¯åŸºäº Promise çš„å¼‚æ­¥å‡½æ•°æœ¬è´¨çš„ä¸€ç§æƒ…å†µã€‚ä¸ºäº†ç­‰å¾…ä¸€ç»„å¹¶å‘æ‰§è¡Œçš„å¼‚æ­¥å‡½æ•°ï¼Œæˆ‘ä»¬ä½¿ç”¨ Promise.all() å°±åƒç›´æ¥ä½¿ç”¨ Promise ä¸€æ ·ï¼š </p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> [value1, value2] = <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>([<span class="title function_">getJSON</span>(url1), <span class="title function_">getJSON</span>(url2)]);</span><br></pre></td></tr></table></figure>
<h3 id="13-3-4-Implementation-Details"><a href="#13-3-4-Implementation-Details" class="headerlink" title="13.3.4 Implementation Details"></a>13.3.4 Implementation Details</h3><p>Finally, in order to understand how async functions work, it may help to think about what is going on under the hood.</p>
<blockquote>
<p>æœ€åï¼Œä¸ºäº†äº†è§£å¼‚æ­¥åŠŸèƒ½æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œè€ƒè™‘ä¸€ä¸‹å¹•åå‘ç”Ÿäº†ä»€ä¹ˆå¯èƒ½ä¼šæœ‰æ‰€å¸®åŠ©ã€‚</p>
</blockquote>
<p>Suppose you write an async function like this:</p>
<blockquote>
<p>å‡è®¾å†™è¿™æ ·çš„ä¸€ä¸ªå¼‚æ­¥å‡½æ•°ï¼š</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">f</span>(<span class="params">x</span>) &#123; <span class="comment">/* body */</span> &#125;</span><br></pre></td></tr></table></figure>
<p>You can think about this as a Promise-returning function wrapped around the body of your original function:</p>
<blockquote>
<p>å¯ä»¥å°†å…¶è§†ä¸ºåŒ…è£…åŸå§‹å‡½æ•°ä¸»ä½“çš„ Promise è¿”å›å‡½æ•°ï¼š</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">f</span>(<span class="params">x</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span>(<span class="params">resolve, reject</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="title function_">resolve</span>((<span class="keyword">function</span>(<span class="params">x</span>) &#123; <span class="comment">/* body */</span> &#125;)(x));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">            <span class="title function_">reject</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>It is harder to express the await keyword in terms of a syntax transformation like this one. But think of the await keyword as a marker that breaks a function body up into separate, synchronous chunks. An ES2017 interpreter can break the function body up into a sequence of separate subfunctions, each of which gets passed to the then() method of the await-marked Promise that precedes it.</p>
<blockquote>
<p>ç”¨åƒè¿™æ ·çš„è¯­æ³•è½¬æ¢æ¥è¡¨è¾¾ await å…³é”®å­—æ¯”è¾ƒå›°éš¾ã€‚ä½†æ˜¯ï¼Œå°† await å…³é”®å­—è§†ä¸ºå°†å‡½æ•°ä¸»ä½“åˆ†è§£ä¸ºå•ç‹¬çš„åŒæ­¥å—çš„æ ‡è®°ã€‚ES2017 è§£é‡Šå™¨å¯ä»¥å°†å‡½æ•°ä¸»ä½“åˆ†è§£ä¸ºä¸€ç³»åˆ—å•ç‹¬çš„å­å‡½æ•°ï¼Œæ¯ä¸ªå­å‡½æ•°éƒ½ä¼ é€’ç»™ä½äºå…¶å‰é¢ await æ ‡è®°çš„ Promise çš„ then() æ–¹æ³•ã€‚</p>
</blockquote>
<h2 id="13-4-Asynchronous-Iteration"><a href="#13-4-Asynchronous-Iteration" class="headerlink" title="13.4 Asynchronous Iteration"></a>13.4 Asynchronous Iteration</h2><p>We began this chapter with a discussion of callback- and event-based asynchrony, and when we introduced Promises, we noted that they were useful for single-shot asynchronous computations but were not suitable for use with sources of repetitive asynchronous events, such as setInterval(), the â€œclickâ€ event in a web browser, or the â€œdataâ€ event on a Node stream. Because single Promises do not work for sequences of asynchronous events, we also cannot use regular async functions and the await statements for these things.</p>
<blockquote>
<p>åœ¨æœ¬ç« çš„å¼€å¤´æˆ‘ä»¬è®¨è®ºäº†åŸºäºå›è°ƒå’ŒåŸºäºäº‹ä»¶çš„å¼‚æ­¥ï¼Œå½“æˆ‘ä»¬ä»‹ç» Promise æ—¶ï¼Œæˆ‘ä»¬æ³¨æ„åˆ°å®ƒä»¬å¯¹äºå•æ¬¡å¼‚æ­¥è®¡ç®—å¾ˆæœ‰ç”¨ï¼Œä½†ä¸é€‚ç”¨äºé‡å¤æ€§å¼‚æ­¥äº‹ä»¶çš„ä»£ç ï¼Œä¾‹å¦‚ setInterval()ï¼Œç½‘ç»œæµè§ˆå™¨ä¸­çš„â€œclickâ€äº‹ä»¶æˆ– Node æµä¸Šçš„â€œdataâ€äº‹ä»¶ã€‚å› ä¸ºå•ä¸ª Promise ä¸é€‚ç”¨äºå¼‚æ­¥äº‹ä»¶åºåˆ—ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿä¸èƒ½å¯¹è¿™äº›äº‹ç‰©ä½¿ç”¨å¸¸è§„çš„å¼‚æ­¥å‡½æ•°å’Œ await è¯­å¥ã€‚</p>
</blockquote>
<p>ES2018 provides a solution, however. Asynchronous iterators are like the iterators described in Chapter 12, but they are Promise-based and are meant to be used with a new form of the for&#x2F;of loop: for&#x2F;await.</p>
<blockquote>
<p>ä½†æ˜¯ ES2018 æä¾›äº†ä¸€ä¸ªè§£å†³æ–¹æ¡ˆã€‚å¼‚æ­¥è¿­ä»£å™¨ç±»ä¼¼äºç¬¬ 12 ç« ä¸­æè¿°çš„è¿­ä»£å™¨ï¼Œä½†æ˜¯å®ƒä»¬åŸºäº Promiseï¼Œå¹¶ä¸”æ‰“ç®—ä¸ for&#x2F;of å¾ªç¯ä¸€èµ·ä½¿ç”¨çš„æ–°å½¢å¼ï¼šfor&#x2F;awaitã€‚</p>
</blockquote>
<h3 id="13-4-1-The-for-x2F-await-Loop"><a href="#13-4-1-The-for-x2F-await-Loop" class="headerlink" title="13.4.1 The for&#x2F;await Loop"></a>13.4.1 The for&#x2F;await Loop</h3><p>Node 12 makes its readable streams asynchronously iterable. This means you can read successive chunks of data from a stream with a for&#x2F;await loop like this one:</p>
<blockquote>
<p>Node 12 ä½¿å…¶å¯è¯»æµå¯ä»¥å¼‚æ­¥è¿­ä»£ã€‚è¿™æ„å‘³ç€å¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ‰€ç¤ºçš„ for&#x2F;await å¾ªç¯ä»æµä¸­è¯»å–è¿ç»­çš„æ•°æ®å—ï¼š</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">parseFile</span>(<span class="params">filename</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> stream = fs.<span class="title function_">createReadStream</span>(filename, &#123; <span class="attr">encoding</span>: <span class="string">&quot;utf-8&quot;</span>&#125;);</span><br><span class="line">    <span class="keyword">for</span> <span class="keyword">await</span> (<span class="keyword">let</span> chunk <span class="keyword">of</span> stream) &#123;</span><br><span class="line">        <span class="title function_">parseChunk</span>(chunk); <span class="comment">// Assume parseChunk() is defined elsewhere</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Like a regular await expression, the for&#x2F;await loop is Promise-based. Roughly speaking, the asynchronous iterator produces a Promise and the for&#x2F;await loop waits for that Promise to fulfill, assigns the fulfillment value to the loop variable, and runs the body of the loop. And then it starts over, getting another Promise from the iterator and waiting for that new Promise to fulfill.</p>
<blockquote>
<p>åƒæ™®é€šçš„ await è¡¨è¾¾å¼ä¸€æ ·ï¼Œfor&#x2F;await å¾ªç¯æ˜¯åŸºäº promise çš„ã€‚ç²—ç•¥åœ°è¯´ï¼Œå¼‚æ­¥è¿­ä»£å™¨äº§ç”Ÿä¸€ä¸ª Promiseï¼Œfor&#x2F;await å¾ªç¯ç­‰å¾…è¯¥ Promise å…‘ç°ï¼Œå°†å…‘ç°å€¼åˆ†é…ç»™å¾ªç¯å˜é‡ï¼Œç„¶åè¿è¡Œå¾ªç¯çš„ä¸»ä½“ã€‚ç„¶åé‡æ–°å¼€å§‹ï¼Œä»è¿­ä»£å™¨ä¸­è·å¾—å¦ä¸€ä¸ª Promiseï¼Œç„¶åç­‰å¾…è¯¥æ–° Promise å…‘ç°ã€‚</p>
</blockquote>
<p>Suppose you have an array of URLs:</p>
<blockquote>
<p>å‡è®¾æœ‰ä¸€ä¸ª URL æ•°ç»„ï¼š</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> urls = [url1, url2, url3];</span><br></pre></td></tr></table></figure>
<p>You can call fetch() on each URL to get an array of Promises:</p>
<blockquote>
<p>å¯ä»¥åœ¨æ¯ä¸ª URL ä¸Šè°ƒç”¨ fetch() ä»¥è·å–ä¸€ä¸ª promise æ•°ç»„ï¼š</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> promises = urls.<span class="title function_">map</span>(<span class="function"><span class="params">url</span> =&gt;</span> <span class="title function_">fetch</span>(url));</span><br></pre></td></tr></table></figure>
<p>We saw earlier in the chapter that we could now use Promise.all() to wait for all the Promises in the array to be fulfilled. But suppose we want the results of the first fetch as soon as they become available and donâ€™t want to wait for all the URLs to be fetched. (Of course, the first fetch might take longer than any of the others, so this is not necessarily faster than using Promise.all().) Arrays are iterable, so we can iterate through the array of promises with a regular for&#x2F;of loop:</p>
<blockquote>
<p>æˆ‘ä»¬åœ¨æœ¬ç« çš„å‰é¢å·²ç»çœ‹åˆ°ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥ä½¿ç”¨ Promise.all() ç­‰å¾…æ•°ç»„ä¸­çš„æ‰€æœ‰ promise éƒ½å·²å…Œç¾ã€‚ä½†æ˜¯ï¼Œå‡è®¾æˆ‘ä»¬å¸Œæœ›ç¬¬ä¸€ä¸ªæå–çš„ç»“æœå°½å¿«å¯ç”¨ï¼Œå¹¶ä¸”ä¸æƒ³ç­‰å¾…æ‰€æœ‰ URL éƒ½è¢«è·å–ã€‚ï¼ˆå½“ç„¶ï¼Œç¬¬ä¸€æ¬¡è·å–å¯èƒ½æ¯”å…¶ä»–ä»»ä½•è·å–éƒ½è¦èŠ±è´¹æ›´é•¿çš„æ—¶é—´ï¼Œå› æ­¤ä¸ä¸€å®šæ¯”ä½¿ç”¨ Promise.all() æ›´å¿«ã€‚ï¼‰æ•°ç»„æ˜¯å¯è¿­ä»£çš„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¸¸è§„çš„ for&#x2F;of å¯¹æ•°ç»„è¿›è¡Œéå†ï¼š</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">const</span> promise <span class="keyword">of</span> promises) &#123;</span><br><span class="line">    response = <span class="keyword">await</span> promise;</span><br><span class="line">    <span class="title function_">handle</span>(response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This example code uses a regular for&#x2F;of loop with a regular iterator. But because this iterator returns Promises, we can also use the new for&#x2F;await for slightly simpler code:</p>
<blockquote>
<p>æ­¤ç¤ºä¾‹ä»£ç ä½¿ç”¨ for&#x2F;of å¾ªç¯éå†å¸¸è§„è¿­ä»£å™¨ã€‚ä½†æ˜¯å› ä¸ºæ­¤è¿­ä»£å™¨è¿”å› Promiseï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜å¯ä»¥å°†æ–°çš„ for&#x2F;await ç¨å¾®ç®€åŒ–ä¸‹ä»£ç ï¼š</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> <span class="keyword">await</span> (<span class="keyword">const</span> response <span class="keyword">of</span> promises) &#123;</span><br><span class="line">    <span class="title function_">handle</span>(response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>In this case, the for&#x2F;await loop just builds the await call into the loop and makes our code slightly more compact, but the two examples do exactly the same thing. Importantly, both examples will only work if they are within functions declared async; a for&#x2F;await loop is no different than a regular await expression in that way.</p>
<blockquote>
<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œfor&#x2F;await å¾ªç¯ä»…å°† await è°ƒç”¨æ„å»ºåˆ°å¾ªç¯ä¸­ï¼Œå¹¶ä½¿æˆ‘ä»¬çš„ä»£ç ç¨å¾®ç´§å‡‘ä¸€äº›ï¼Œä½†æ˜¯ä¸¤ä¸ªç¤ºä¾‹çš„ä½œç”¨å®Œå…¨ç›¸åŒã€‚é‡è¦çš„æ˜¯ï¼Œè¿™ä¸¤ä¸ªç¤ºä¾‹åªæœ‰åœ¨å£°æ˜ä¸ºå¼‚æ­¥çš„å‡½æ•°ä¸­æ—¶æ‰èµ·ä½œç”¨ã€‚for&#x2F;await å¾ªç¯ä¸å¸¸è§„ await è¡¨è¾¾å¼æ²¡æœ‰ä»€ä¹ˆä¸åŒã€‚</p>
</blockquote>
<p>It is important to realize, however, that weâ€™re using for&#x2F;await with a regular iterator in this example. Things are more interesting with fully asynchronous iterators.</p>
<blockquote>
<p>ä½†æ˜¯ï¼Œé‡è¦çš„æ˜¯è¦æ„è¯†åˆ°ï¼Œåœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬æ­£åœ¨ä½¿ç”¨ for&#x2F;wait ä½œç”¨äºå¸¸è§„è¿­ä»£å™¨çš„ã€‚ä½œç”¨äºå®Œå…¨å¼‚æ­¥çš„è¿­ä»£å™¨ä½¿äº‹æƒ…å˜å¾—æ›´åŠ æœ‰è¶£ã€‚</p>
</blockquote>
<h3 id="13-4-2-Asynchronous-Iterators"><a href="#13-4-2-Asynchronous-Iterators" class="headerlink" title="13.4.2 Asynchronous Iterators"></a>13.4.2 Asynchronous Iterators</h3><p>Letâ€™s review some terminology from Chapter 12. An iterable object is one that can be used with a for&#x2F;of loop. It defines a method with the symbolic name Symbol.iterator. This method returns an iterator object. The iterator object has a next() method, which can be called repeatedly to obtain the values of the iterable object. The next() method of the iterator object returns iteration result objects. The iteration result object has a value property and&#x2F;or a done property.</p>
<blockquote>
<p>è®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹ç¬¬ 12 ç« ä¸­çš„ä¸€äº›æœ¯è¯­ã€‚å¯è¿­ä»£å¯¹è±¡æ˜¯å¯ä»¥ä¸ for&#x2F;of å¾ªç¯ä¸€èµ·ä½¿ç”¨çš„å¯¹è±¡ã€‚å®ƒå®šä¹‰äº†ä¸€ä¸ªåç§°ä¸º Symbol.iterator çš„æ–¹æ³•ã€‚æ­¤æ–¹æ³•è¿”å›ä¸€ä¸ªè¿­ä»£å™¨å¯¹è±¡ã€‚è¿­ä»£å™¨å¯¹è±¡å…·æœ‰ next() æ–¹æ³•ï¼Œå¯ä»¥é‡å¤è°ƒç”¨è¯¥æ–¹æ³•ä»¥è·å¾—å¯è¿­ä»£å¯¹è±¡çš„å€¼ã€‚è¿­ä»£å™¨å¯¹è±¡çš„ next() æ–¹æ³•è¿”å›è¿­ä»£ç»“æœå¯¹è±¡ã€‚è¿­ä»£ç»“æœå¯¹è±¡å…·æœ‰ value å±æ€§å’Œæˆ–æˆ– done å±æ€§ã€‚</p>
</blockquote>
<p>Asynchronous iterators are quite similar to regular iterators, but there are two important differences. First, an asynchronously iterable object implements a method with the symbolic name Symbol.asyncIterator instead of Symbol.iterator. (As we saw earlier, for&#x2F;await is compatible with regular iterable objects but it prefers asynchronously iterable objects, and tries the Symbol.asyncIterator method before it tries the Symbol.iterator method.) Second, the next() method of an asynchronous iterator returns a Promise that resolves to an iterator result object instead of returning an iterator result object directly.</p>
<blockquote>
<p>å¼‚æ­¥è¿­ä»£å™¨ä¸å¸¸è§„è¿­ä»£å™¨éå¸¸ç›¸ä¼¼ï¼Œä½†æ˜¯æœ‰ä¸¤ä¸ªé‡è¦çš„åŒºåˆ«ã€‚ é¦–å…ˆï¼Œä¸€ä¸ªå¼‚æ­¥å¯è¿­ä»£å¯¹è±¡ä»¥ç¬¦å·åç§° Symbol.asyncIterator è€Œä¸æ˜¯ Symbol.iterator å®ç°ä¸€ä¸ªæ–¹æ³•ã€‚ï¼ˆå¦‚å‰æ‰€è¿°ï¼Œfor&#x2F;await ä¸å¸¸è§„å¯è¿­ä»£å¯¹è±¡å…¼å®¹ï¼Œä½†æ˜¯å®ƒæ›´å–œæ¬¢å¼‚æ­¥å¯è¿­ä»£å¯¹è±¡ï¼Œå¹¶åœ¨å°è¯• Symbol.iterator æ–¹æ³•ä¹‹å‰å…ˆå°è¯•ä½¿ç”¨ Symbol.asyncIterator æ–¹æ³•ã€‚ï¼‰å…¶æ¬¡ï¼Œå¼‚æ­¥è¿­ä»£å™¨çš„ next() æ–¹æ³•è¿”å›è§£æä¸ºè¿­ä»£å™¨ç»“æœå¯¹è±¡çš„ Promiseï¼Œè€Œä¸æ˜¯ç›´æ¥è¿”å›è¿­ä»£å™¨ç»“æœå¯¹è±¡ã€‚</p>
</blockquote>
<p><strong>NOTE</strong><br>In the previous section, when we used for&#x2F;await on a regular, synchronously iterable array of Promises, we were working with synchronous iterator result objects in which the value property was a Promise object but the done property was synchronous. True asynchronous iterators return Promises for iteration result objects, and both the value and the done properties are asynchronous. The difference is a subtle one: with asynchronous iterators, the choice about when iteration ends can be made asynchronously.</p>
<blockquote>
<p>åœ¨ä¸Šä¸€èŠ‚ä¸­ï¼Œå½“æˆ‘ä»¬åœ¨å¸¸è§„çš„ã€åŒæ­¥å¯è¿­ä»£çš„ Promise æ•°ç»„ä¸Šä½¿ç”¨ for&#x2F;await æ—¶ï¼Œæˆ‘ä»¬æ­£åœ¨ä½¿ç”¨åŒæ­¥è¿­ä»£å™¨ç»“æœå¯¹è±¡ï¼Œå…¶ä¸­ value å±æ€§æ˜¯ Promise å¯¹è±¡ï¼Œä½† done å±æ€§æ˜¯åŒæ­¥çš„ã€‚çœŸæ­£çš„å¼‚æ­¥è¿­ä»£å™¨ä¸ºè¿­ä»£ç»“æœå¯¹è±¡è¿”å› Promiseï¼Œå¹¶ä¸” value å’Œ done å±æ€§éƒ½æ˜¯å¼‚æ­¥çš„ã€‚è¿™æ˜¯ä¸€ä¸ªå¾®å¦™çš„åŒºåˆ«ï¼šä½¿ç”¨å¼‚æ­¥è¿­ä»£å™¨ï¼Œå¯ä»¥å¼‚æ­¥é€‰æ‹©ä½•æ—¶ç»“æŸè¿­ä»£ã€‚</p>
</blockquote>
<h3 id="13-4-3-Asynchronous-Generators"><a href="#13-4-3-Asynchronous-Generators" class="headerlink" title="13.4.3 Asynchronous Generators"></a>13.4.3 Asynchronous Generators</h3><p>As we saw in Chapter 12, the easiest way to implement an iterator is often to use a generator. The same is true for asynchronous iterators, which we can implement with generator functions that we declare async. An async generator has the features of async functions and the features of generators: you can use await as you would in a regular async function, and you can use yield as you would in a regular generator. But values that you yield are automatically wrapped in Promises. Even the syntax for async generators is a combination: async function and function * combine into async function *. Here is an example that shows how you might use an async generator and a for&#x2F;await loop to repetitively run code at fixed intervals using loop syntax instead of a setInterval() callback function:</p>
<blockquote>
<p>æ­£å¦‚æˆ‘ä»¬åœ¨ç¬¬ 12 ç« ä¸­çœ‹åˆ°çš„é‚£æ ·ï¼Œå®ç°è¿­ä»£å™¨çš„æœ€ç®€å•æ–¹æ³•é€šå¸¸æ˜¯ä½¿ç”¨ç”Ÿæˆå™¨ã€‚å¼‚æ­¥è¿­ä»£å™¨ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å£°æ˜ä¸ºå¼‚æ­¥çš„ç”Ÿæˆå™¨å‡½æ•°æ¥å®ç°ã€‚å¼‚æ­¥ç”Ÿæˆå™¨å…·æœ‰å¼‚æ­¥ç‰¹æ€§å’Œç”Ÿæˆå™¨ç‰¹æ€§ï¼šå¯ä»¥åƒåœ¨å¸¸è§„å¼‚æ­¥å‡½æ•°ä¸­ä¸€æ ·ä½¿ç”¨ awaitï¼Œå¹¶ä¸”å¯ä»¥åƒåœ¨å¸¸è§„ç”Ÿæˆå™¨ä¸­ä¸€æ ·ä½¿ç”¨ yieldã€‚ä½†æ˜¯ï¼Œäº§ç”Ÿçš„å€¼ä¼šè‡ªåŠ¨åŒ…è£…åœ¨ Promise ä¸­ã€‚ç”šè‡³å¼‚æ­¥ç”Ÿæˆå™¨çš„è¯­æ³•ä¹Ÿæ˜¯ä¸€ä¸ªç»„åˆï¼šå¼‚æ­¥å‡½æ•°å’Œ function* ç»„åˆä¸º async function*ã€‚è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œæè¿°å¦‚ä½•ä½¿ç”¨å¼‚æ­¥ç”Ÿæˆå™¨å’Œ for&#x2F;await å¾ªç¯ä»£æ›¿ setInterval() å›è°ƒå‡½æ•°ä»¥å›ºå®šçš„é—´éš”é‡å¤è¿è¡Œä»£ç ï¼š</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A Promise-based wrapper around setTimeout() that we can use await with.</span></span><br><span class="line"><span class="comment">// Returns a Promise that fulfills in the specified number of milliseconds</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">elapsedTime</span>(<span class="params">ms</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> <span class="built_in">setTimeout</span>(resolve, ms));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// An async generator function that increments a counter and yields it</span></span><br><span class="line"><span class="comment">// a specified (or infinite) number of times at a specified interval.</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span>* <span class="title function_">clock</span>(<span class="params">interval, max=<span class="literal">Infinity</span></span>) &#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> count = <span class="number">1</span>; count &lt;= max; count++) &#123; <span class="comment">// regular for loop</span></span><br><span class="line">        <span class="keyword">await</span> <span class="title function_">elapsedTime</span>(interval);            <span class="comment">// wait for time to pass</span></span><br><span class="line">        <span class="keyword">yield</span> count;                            <span class="comment">// yield the counter</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// A test function that uses the async generator with for/await</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">test</span>(<span class="params"></span>) &#123;                       <span class="comment">// Async so we can use for/await</span></span><br><span class="line">    <span class="keyword">for</span> <span class="keyword">await</span> (<span class="keyword">let</span> tick <span class="keyword">of</span> <span class="title function_">clock</span>(<span class="number">300</span>, <span class="number">100</span>)) &#123; <span class="comment">// Loop 100 times every 300ms</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(tick);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="13-4-4-Implementing-Asynchronous-Iterators"><a href="#13-4-4-Implementing-Asynchronous-Iterators" class="headerlink" title="13.4.4 Implementing Asynchronous Iterators"></a>13.4.4 Implementing Asynchronous Iterators</h3><p>Instead of using async generators to implement asynchronous iterators, it is also possible to implement them directly by defining an object with a Symbol.asyncIterator() method that returns an object with a next() method that returns a Promise that resolves to an iterator result object. In the following code, we re-implement the clock() function from the preceding example so that it is not a generator and instead just returns an asynchronously iterable object. Notice that the next() method in this example does not explicitly return a Promise; instead, we just declare next() to be async:</p>
<blockquote>
<p>é™¤äº†ä½¿ç”¨å¼‚æ­¥ç”Ÿæˆå™¨æ¥å®ç°å¼‚æ­¥è¿­ä»£å™¨å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡ä½¿ç”¨ Symbol.asyncIterator() æ–¹æ³•å®šä¹‰ä¸€ä¸ªå¯¹è±¡æ¥ç›´æ¥å®ç°å®ƒä»¬ï¼Œè€Œ Symbol.asyncIterator() æ–¹æ³•å°†è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œè€Œ next() æ–¹æ³•å°†è¿”å›ä¸€ä¸ªå†³è®®ä¸ºè¿­ä»£å™¨ç»“æœå¯¹è±¡çš„ Promiseã€‚åœ¨ä¸‹é¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬é‡æ–°å®ç°äº†ä¸Šä¸€ä¸ªç¤ºä¾‹ä¸­çš„ clock() å‡½æ•°ï¼Œå› æ­¤å®ƒä¸æ˜¯ç”Ÿæˆå™¨ï¼Œè€Œä»…æ˜¯è¿”å›ä¸€ä¸ªå¼‚æ­¥å¯è¿­ä»£çš„å¯¹è±¡ã€‚è¯·æ³¨æ„ï¼Œæ­¤ç¤ºä¾‹ä¸­çš„ next() æ–¹æ³•æœªæ˜ç¡®è¿”å› Promiseï¼›ç›¸åï¼Œæˆ‘ä»¬åªå£°æ˜ next() æ˜¯å¼‚æ­¥çš„ï¼š</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">clock</span>(<span class="params">interval, max=<span class="literal">Infinity</span></span>) &#123;</span><br><span class="line">    <span class="comment">// A Promise-ified version of setTimeout that we can use await with.</span></span><br><span class="line">    <span class="comment">// Note that this takes an absolute time instead of an interval.</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">until</span>(<span class="params">time</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> <span class="built_in">setTimeout</span>(resolve, time - <span class="title class_">Date</span>.<span class="title function_">now</span>()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Return an asynchronously iterable object</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">startTime</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),  <span class="comment">// Remember when we started</span></span><br><span class="line">        <span class="attr">count</span>: <span class="number">1</span>,               <span class="comment">// Remember which iteration we&#x27;re on</span></span><br><span class="line">        <span class="keyword">async</span> <span class="title function_">next</span>(<span class="params"></span>) &#123;          <span class="comment">// The next() method makes this an iterator</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">count</span> &gt; max) &#123;     <span class="comment">// Are we done?</span></span><br><span class="line">                <span class="keyword">return</span> &#123; <span class="attr">done</span>: <span class="literal">true</span> &#125;;  <span class="comment">// Iteration result indicating done</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Figure out when the next iteration should begin,</span></span><br><span class="line">            <span class="keyword">let</span> targetTime = <span class="variable language_">this</span>.<span class="property">startTime</span> + <span class="variable language_">this</span>.<span class="property">count</span> * interval;</span><br><span class="line">            <span class="comment">// wait until that time,</span></span><br><span class="line">            <span class="keyword">await</span> <span class="title function_">until</span>(targetTime);</span><br><span class="line">            <span class="comment">// and return the count value in an iteration result object.</span></span><br><span class="line">            <span class="keyword">return</span> &#123; <span class="attr">value</span>: <span class="variable language_">this</span>.<span class="property">count</span>++ &#125;;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">// This method means that this iterator object is also an iterable.</span></span><br><span class="line">        [<span class="title class_">Symbol</span>.<span class="property">asyncIterator</span>]() &#123; <span class="keyword">return</span> <span class="variable language_">this</span>; &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This iterator-based version of the clock() function fixes a flaw in the generator-based version. Note that, in this newer code, we target the absolute time at which each iteration should begin and subtract the current time from that in order to compute the interval that we pass to setTimeout(). If we use clock() with a for&#x2F;await loop, this version will run loop iterations more precisely at the specified interval because it accounts for the time required to actually run the body of the loop. But this fix isnâ€™t just about timing accuracy. The for&#x2F;await loop always waits for the Promise returned by one iteration to be fulfilled before it begins the next iteration. But if you use an asynchronous iterator without a for&#x2F;await loop, there is nothing to prevent you from calling the next() method whenever you want. With the generator-based version of clock(), if you call the next() method three times sequentially, youâ€™ll get three Promises that will all fulfill at almost exactly the same time, which is probably not what you want. The iterator-based version weâ€™ve implemented here does not have that problem.</p>
<blockquote>
<p>è¿™ä¸ªåŸºäºè¿­ä»£å™¨ç‰ˆæœ¬çš„ clock() å‡½æ•°ä¿®å¤äº†åŸºäºç”Ÿæˆå™¨ç‰ˆæœ¬ä¸­çš„ä¸€ä¸ªç¼ºé™·ã€‚è¯·æ³¨æ„ï¼Œåœ¨æ­¤ä»£ç ä¸­ï¼Œæˆ‘ä»¬åœ¨æ¯æ¬¡è¿­ä»£å¼€å§‹æ—¶è®¾ç½®äº†ç»å¯¹ç›®æ ‡æ—¶é—´ï¼Œå¹¶å°†å…¶ä¸å½“å‰æ—¶é—´çš„å·®å€¼ä½œä¸ºé—´éš”ä¼ é€’ç»™ setTimeout()ã€‚å¦‚æœæˆ‘ä»¬å°† clock() ä¸ for&#x2F;await å¾ªç¯ä¸€èµ·ä½¿ç”¨ï¼Œåˆ™æ­¤ç‰ˆæœ¬å°†åœ¨æŒ‡å®šçš„æ—¶é—´é—´éš”å†…æ›´ç²¾ç¡®åœ°è¿è¡Œå¾ªç¯è¿­ä»£ï¼Œå› ä¸ºå®ƒè€ƒè™‘äº†å®é™…è¿è¡Œå¾ªç¯ä¸»ä½“æ‰€éœ€çš„æ—¶é—´ã€‚ä½†æ˜¯ï¼Œæ­¤ä¿®è¡¥ç¨‹åºä¸ä»…æ¶‰åŠå®šæ—¶ç²¾åº¦ã€‚for&#x2F;await å¾ªç¯å§‹ç»ˆåœ¨å¼€å§‹ä¸‹ä¸€æ¬¡è¿­ä»£ä¹‹å‰ç­‰å¾…ä¸€æ¬¡è¿­ä»£è¿”å›çš„ Promise è¢«å…‘ç°ã€‚ä½†æ˜¯ï¼Œå¦‚æœä½¿ç”¨ä¸å¸¦ for&#x2F;await å¾ªç¯çš„å¼‚æ­¥è¿­ä»£å™¨ï¼Œåˆ™æ²¡æœ‰ä»€ä¹ˆå¯ä»¥é˜»æ­¢åœ¨éœ€è¦æ—¶è°ƒç”¨ next() æ–¹æ³•ã€‚ä½¿ç”¨åŸºäºç”Ÿæˆå™¨çš„ clock() ç‰ˆæœ¬ï¼Œå¦‚æœä¾æ¬¡è°ƒç”¨ next() æ–¹æ³•ä¸‰éï¼Œå°†è·å¾—ä¸‰ä¸ª Promiseï¼Œè¿™äº› Promise å‡ ä¹éƒ½åœ¨åŒä¸€æ—¶é—´å®Œæˆï¼Œè¿™å¯èƒ½ä¸æ˜¯æƒ³è¦çš„ç»“æœã€‚æˆ‘ä»¬åœ¨è¿™é‡Œå®ç°çš„åŸºäºè¿­ä»£å™¨çš„ç‰ˆæœ¬æ²¡æœ‰è¿™ä¸ªé—®é¢˜ã€‚</p>
</blockquote>
<p>The benefit of asynchronous iterators is that they allow us to represent streams of asynchronous events or data. The clock() function discussed previously was fairly simple to write because the source of the asynchrony was the setTimeout() calls we were making ourselves. But when we are trying to work with other asynchronous sources, such as the triggering of event handlers, it becomes substantially harder to implement asynchronous iteratorsâ€”we typically have a single event handler function that responds to events, but each call to the iteratorâ€™s next() method must return a distinct Promise object, and multiple calls to next() may occur before the first Promise resolves. This means that any asynchronous iterator method must be able to maintain an internal queue of Promises that it resolves in order as asynchronous events are occurring. If we encapsulate this Promise-queueing behavior into an AsyncQueue class, then it becomes much easier to write asynchronous iterators based on AsyncQueue. [^3]</p>
<blockquote>
<p>å¼‚æ­¥è¿­ä»£å™¨çš„å¥½å¤„åœ¨äºï¼Œå®ƒä»¬å…è®¸æˆ‘ä»¬è¡¨ç¤ºå¼‚æ­¥äº‹ä»¶æˆ–æ•°æ®æµã€‚å‰é¢è®¨è®ºçš„ clock() å‡½æ•°ç¼–å†™èµ·æ¥éå¸¸ç®€å•ï¼Œå› ä¸ºå¼‚æ­¥æºæ˜¯æˆ‘ä»¬è‡ªå·±è¿›è¡Œçš„ setTimeout() è°ƒç”¨ã€‚ä½†æ˜¯ï¼Œå½“æˆ‘ä»¬å°è¯•ä¸å…¶ä»–å¼‚æ­¥æºä¸€èµ·ä½¿ç”¨æ—¶ï¼Œä¾‹å¦‚äº‹ä»¶å¤„ç†ç¨‹åºçš„è§¦å‘ï¼Œå®ç°å¼‚æ­¥è¿­ä»£å™¨çš„éš¾åº¦å°†å¤§å¤§æé«˜â€”â€”â€”â€”æˆ‘ä»¬é€šå¸¸åªæœ‰ä¸€ä¸ªäº‹ä»¶å¤„ç†ç¨‹åºå‡½æ•°æ¥å“åº”äº‹ä»¶ï¼Œä½†æ˜¯æ¯æ¬¡è°ƒç”¨è¿­ä»£å™¨çš„ next() æ–¹æ³•ä¸€å®šè¿”å›ä¸€ä¸ªä¸åŒçš„ Promise å¯¹è±¡ï¼Œå¹¶ä¸”åœ¨ç¬¬ä¸€ä¸ª Promise å†³è®®ä¹‹å‰ï¼Œå¯èƒ½ä¼šå¤šæ¬¡è°ƒç”¨ next()ã€‚è¿™æ„å‘³ç€ï¼Œä»»ä½•å¼‚æ­¥è¿­ä»£å™¨æ–¹æ³•éƒ½å¿…é¡»èƒ½å¤Ÿç»´æŠ¤ä¸€ä¸ªå†…éƒ¨çš„ Promise é˜Ÿåˆ—ï¼Œè¯¥é˜Ÿåˆ—å°†åœ¨å“åº”å¼‚æ­¥äº‹ä»¶æ—¶æŒ‰é¡ºåºè¿›è¡Œå†³è®®ã€‚å¦‚æœæˆ‘ä»¬å°†æ­¤ Promise æœ‰åºåˆ—çš„è¡Œä¸ºå°è£…åˆ° AsyncQueue ç±»ä¸­ï¼Œé‚£ä¹ˆåŸºäº AsyncQueue ç¼–å†™å¼‚æ­¥è¿­ä»£å™¨å°†å˜å¾—æ›´åŠ å®¹æ˜“ã€‚ [^3]</p>
</blockquote>
<p>The AsyncQueue class that follows has enqueue() and dequeue() methods as youâ€™d expect for a queue class. The dequeue() method returns a Promise rather than an actual value, however, which means that it is OK to call dequeue() before enqueue() has ever been called. The AsyncQueue class is also an asynchronous iterator, and is intended to be used with a for&#x2F;await loop whose body runs once each time a new value is asynchronously enqueued. (AsyncQueue has a close() method. Once called, no more values can be enqueued. When a closed queue is empty, the for&#x2F;await loop will stop looping.)</p>
<blockquote>
<p>æ­£å¦‚æœŸæœ›çš„é‚£æ ·ï¼Œåé¢çš„ AsyncQueue ç±»å…·æœ‰ enqueue() å’Œ dequeue() æ–¹æ³•ã€‚ä½†æ˜¯ï¼Œdequeue() æ–¹æ³•è¿”å› Promise è€Œä¸æ˜¯å®é™…å€¼ï¼Œè¿™æ„å‘³ç€å¯ä»¥åœ¨è°ƒç”¨ enqueue() ä¹‹å‰è°ƒç”¨ dequeue()ã€‚AsyncQueue ç±»ä¹Ÿæ˜¯ä¸€ä¸ªå¼‚æ­¥è¿­ä»£å™¨ï¼Œæ—¨åœ¨ä¸ for&#x2F;await å¾ªç¯ä¸€èµ·ä½¿ç”¨ï¼Œè¯¥å¾ªç¯çš„ä¸»ä½“åœ¨æ¯æ¬¡å°†æ–°å€¼å¼‚æ­¥æ’é˜Ÿæ—¶éƒ½è¿è¡Œä¸€æ¬¡ã€‚ï¼ˆAsyncQueue æœ‰ä¸€ä¸ª close() æ–¹æ³•ã€‚ä¸€æ—¦è¢«è°ƒç”¨ï¼Œå°±ä¸èƒ½å°†æ›´å¤šçš„å€¼åŠ å…¥é˜Ÿåˆ—ã€‚å½“å…³é—­çš„é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œfor&#x2F;await å¾ªç¯å°†åœæ­¢éå†ã€‚ï¼‰</p>
</blockquote>
<p>Note that the implementation of AsyncQueue does not use async or await and instead works directly with Promises. The code is somewhat complicated, and you can use it to test your understanding of the material weâ€™ve covered in this long chapter. Even if you donâ€™t fully understand the AsyncQueue implementation, do take a look at the shorter example that follows it: it implements a simple but very interesting asynchronous iterator on top of AsyncQueue.</p>
<blockquote>
<p>è¯·æ³¨æ„ï¼ŒAsyncQueue çš„å®ç°ä¸ä½¿ç”¨å¼‚æ­¥æˆ–ç­‰å¾…ï¼Œè€Œæ˜¯ç›´æ¥ä¸ Promise ä¸€èµ·ä½¿ç”¨ã€‚è¯¥ä»£ç æœ‰äº›å¤æ‚ï¼Œå¯ä»¥ä½¿ç”¨å®ƒæ¥æµ‹è¯•å¯¹æœ¬é•¿ç¯‡æ–‡ç« æ‰€æ¶‰åŠå†…å®¹çš„ç†è§£ã€‚å³ä½¿æ‚¨ä¸å®Œå…¨äº†è§£ AsyncQueue çš„å®ç°ï¼Œä¹Ÿè¯·çœ‹ä¸€ä¸‹å®ƒåé¢çš„ç®€çŸ­ç¤ºä¾‹ï¼šå®ƒåœ¨ AsyncQueue ä¹‹ä¸Šå®ç°äº†ä¸€ä¸ªç®€å•ä½†éå¸¸æœ‰è¶£çš„å¼‚æ­¥è¿­ä»£å™¨ã€‚</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * An asynchronously iterable queue class. Add values with enqueue()</span></span><br><span class="line"><span class="comment"> * and remove them with dequeue(). dequeue() returns a Promise, which</span></span><br><span class="line"><span class="comment"> * means that values can be dequeued before they are enqueued. The</span></span><br><span class="line"><span class="comment"> * class implements [Symbol.asyncIterator] and next() so that it can</span></span><br><span class="line"><span class="comment"> * be used with the for/await loop (which will not terminate until</span></span><br><span class="line"><span class="comment"> * the close() method is called.)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AsyncQueue</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// Values that have been queued but not dequeued yet are stored here</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">values</span> = [];</span><br><span class="line">        <span class="comment">// When Promises are dequeued before their corresponding values are</span></span><br><span class="line">        <span class="comment">// queued, the resolve methods for those Promises are stored here.</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">resolvers</span> = [];</span><br><span class="line">        <span class="comment">// Once closed, no more values can be enqueued, and no more unfulfilled</span></span><br><span class="line">        <span class="comment">// Promises returned.</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">closed</span> = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">enqueue</span>(<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">closed</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;AsyncQueue closed&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">resolvers</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// If this value has already been promised, resolve that Promise</span></span><br><span class="line">            <span class="keyword">const</span> resolve = <span class="variable language_">this</span>.<span class="property">resolvers</span>.<span class="title function_">shift</span>();</span><br><span class="line">            <span class="title function_">resolve</span>(value);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Otherwise, queue it up</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">values</span>.<span class="title function_">push</span>(value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">dequeue</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">values</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// If there is a queued value, return a resolved Promise for it</span></span><br><span class="line">            <span class="keyword">const</span> value = <span class="variable language_">this</span>.<span class="property">values</span>.<span class="title function_">shift</span>();</span><br><span class="line">            <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(value);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">closed</span>) &#123;</span><br><span class="line">            <span class="comment">// If no queued values and we&#x27;re closed, return a resolved</span></span><br><span class="line">            <span class="comment">// Promise for the &quot;end-of-stream&quot; marker</span></span><br><span class="line">            <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="title class_">AsyncQueue</span>.<span class="property">EOS</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Otherwise, return an unresolved Promise,</span></span><br><span class="line">            <span class="comment">// queuing the resolver function for later use</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123; <span class="variable language_">this</span>.<span class="property">resolvers</span>.<span class="title function_">push</span>(resolve); &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">close</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// Once the queue is closed, no more values will be enqueued.</span></span><br><span class="line">        <span class="comment">// So resolve any pending Promises with the end-of-stream marker</span></span><br><span class="line">        <span class="keyword">while</span>(<span class="variable language_">this</span>.<span class="property">resolvers</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">resolvers</span>.<span class="title function_">shift</span>()(<span class="title class_">AsyncQueue</span>.<span class="property">EOS</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">closed</span> = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Define the method that makes this class asynchronously iterable</span></span><br><span class="line">    [<span class="title class_">Symbol</span>.<span class="property">asyncIterator</span>]() &#123; <span class="keyword">return</span> <span class="variable language_">this</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Define the method that makes this an asynchronous iterator. The</span></span><br><span class="line">    <span class="comment">// dequeue() Promise resolves to a value or the EOS sentinel if we&#x27;re</span></span><br><span class="line">    <span class="comment">// closed. Here, we need to return a Promise that resolves to an</span></span><br><span class="line">    <span class="comment">// iterator result object.</span></span><br><span class="line">    <span class="title function_">next</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">dequeue</span>().<span class="title function_">then</span>(<span class="function"><span class="params">value</span> =&gt;</span> (value === <span class="title class_">AsyncQueue</span>.<span class="property">EOS</span>)</span><br><span class="line">                                   ? &#123; <span class="attr">value</span>: <span class="literal">undefined</span>, <span class="attr">done</span>: <span class="literal">true</span> &#125;</span><br><span class="line">                                   : &#123; <span class="attr">value</span>: value, <span class="attr">done</span>: <span class="literal">false</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// A sentinel value returned by dequeue() to mark &quot;end of stream&quot; when closed</span></span><br><span class="line"><span class="title class_">AsyncQueue</span>.<span class="property">EOS</span> = <span class="title class_">Symbol</span>(<span class="string">&quot;end-of-stream&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>Because this AsyncQueue class defines the asynchronous iteration basics, we can create our own, more interesting asynchronous iterators simply by asynchronously queueing values. Hereâ€™s an example that uses AsyncQueue to produce a stream of web browser events that can be handled with a for&#x2F;await loop:</p>
<blockquote>
<p>å› ä¸º AsyncQueue ç±»å®šä¹‰äº†å¼‚æ­¥è¿­ä»£åŸºç¡€ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç®€å•åœ°é€šè¿‡å¼‚æ­¥æ’é˜Ÿå€¼æ¥åˆ›å»ºæ›´æœ‰è¶£çš„è‡ªå®šä¹‰å¼‚æ­¥è¿­ä»£å™¨ã€‚è¿™æ˜¯ä¸€ä¸ªä½¿ç”¨ AsyncQueue ç”Ÿæˆå¯é€šè¿‡ for&#x2F;await å¾ªç¯å¤„ç†çš„ web æµè§ˆå™¨äº‹ä»¶æµçš„ç¤ºä¾‹ï¼š</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Push events of the specified type on the specified document element</span></span><br><span class="line"><span class="comment">// onto an AsyncQueue object, and return the queue for use as an event stream</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">eventStream</span>(<span class="params">elt, type</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> q = <span class="keyword">new</span> <span class="title class_">AsyncQueue</span>();                  <span class="comment">// Create a queue</span></span><br><span class="line">    elt.<span class="title function_">addEventListener</span>(type, <span class="function"><span class="params">e</span>=&gt;</span>q.<span class="title function_">enqueue</span>(e)); <span class="comment">// Enqueue events</span></span><br><span class="line">    <span class="keyword">return</span> q;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">handleKeys</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// Get a stream of keypress events and loop once for each one</span></span><br><span class="line">    <span class="keyword">for</span> <span class="keyword">await</span> (<span class="keyword">const</span> event <span class="keyword">of</span> <span class="title function_">eventStream</span>(<span class="variable language_">document</span>, <span class="string">&quot;keypress&quot;</span>)) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(event.<span class="property">key</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="13-5-Summary"><a href="#13-5-Summary" class="headerlink" title="13.5 Summary"></a>13.5 Summary</h2><p>In this chapter, you have learned:</p>
<blockquote>
<p>åœ¨æœ¬ç« ä¸­ï¼Œæ‚¨å­¦ä¹ äº†ï¼š</p>
</blockquote>
<ul>
<li>Most real-world JavaScript programming is asynchronous.</li>
</ul>
<blockquote>
<p>å¤§å¤šæ•°çœŸå®çš„ JavaScript ç¨‹åºéƒ½æ˜¯å¼‚æ­¥çš„ã€‚</p>
</blockquote>
<ul>
<li>Traditionally, asynchrony has been handled with events and callback functions. This can get complicated, however, because you can end up with multiple levels of callbacks nested inside other callbacks, and because it is difficult to do robust error handling.</li>
</ul>
<blockquote>
<p>ä¼ ç»Ÿä¸Šï¼Œå¼‚æ­¥æ˜¯é€šè¿‡äº‹ä»¶å’Œå›è°ƒå‡½æ•°æ¥å¤„ç†çš„ã€‚ä½†æ˜¯ï¼Œè¿™å¯èƒ½ä¼šå˜å¾—å¤æ‚ï¼Œå› ä¸ºæœ€ç»ˆå¯èƒ½ä¼šåµŒå¥—åœ¨å…¶ä»–å›è°ƒä¸­åµŒå¥—çš„å¤šä¸ªçº§åˆ«çš„å›è°ƒï¼Œå¹¶ä¸”å› ä¸ºå¾ˆéš¾è¿›è¡Œå¯é çš„å¼‚å¸¸å¤„ç†ã€‚</p>
</blockquote>
<ul>
<li>Promises provide a new way of structuring callback functions. If used correctly (and unfortunately, Promises are easy to use incorrectly), they can convert asynchronous code that would have been nested into linear chains of then() calls where one asynchronous step of a computation follows another. Also, Promises allow you to centralize your error-handling code into a single catch() call at the end of a chain of then() calls.</li>
</ul>
<blockquote>
<p>Promise æä¾›äº†æ„é€ å›è°ƒå‡½æ•°çš„æ–°æ–¹æ³•ã€‚å¦‚æœæ­£ç¡®ä½¿ç”¨ï¼ˆä¸å¹¸çš„æ˜¯ï¼ŒPromise æ˜“äºé”™è¯¯ä½¿ç”¨ï¼‰ï¼Œå®ƒä»¬å¯ä»¥å°†å¼‚æ­¥ä»£ç è½¬æ¢ä¸ºåµŒå¥—åœ¨è°ƒç”¨ then() çš„çº¿æ€§é“¾ä¸­çš„ä»£ç ï¼Œä¸€ä¸ªè®¡ç®—çš„å¼‚æ­¥æ­¥éª¤è·Ÿéšåœ¨å…¶ä»–ä¹‹åã€‚è€Œä¸”ï¼ŒPromise å…è®¸å°†å¼‚å¸¸å¤„ç†ä»£ç é›†ä¸­åˆ°ä¸€ä¸ª then() è°ƒç”¨é“¾æœ«å°¾çš„å•ä¸ª catch() è°ƒç”¨ä¸­ã€‚</p>
</blockquote>
<ul>
<li>The async and await keywords allow us to write asynchronous code that is Promise-based under the hood but that looks like synchronous code. This makes the code easier to understand and reason about. If a function is declared async, it will implicitly return a Promise. Inside an async function, you can await a Promise (or a function that returns a Promise) as if the Promise value was synchronously computed.</li>
</ul>
<blockquote>
<p>async å’Œ await å…³é”®å­—å…è®¸æˆ‘ä»¬ç¼–å†™å¼‚æ­¥ä»£ç ï¼Œè¯¥ä»£ç åŸºäº Promiseï¼Œä½†çœ‹èµ·æ¥åƒåŒæ­¥ä»£ç ã€‚è¿™ä½¿ä»£ç æ›´æ˜“äºç†è§£å’Œæ¨ç†ã€‚å¦‚æœä¸€ä¸ªå‡½æ•°è¢«å£°æ˜ä¸º asyncï¼Œå®ƒå°†éšå¼è¿”å›ä¸€ä¸ª Promiseã€‚åœ¨å¼‚æ­¥å‡½æ•°å†…éƒ¨ï¼Œå¯ä»¥ await Promiseï¼ˆæˆ–è¿”å› Promise çš„å‡½æ•°ï¼‰ï¼Œå°±åƒ Promise å€¼æ˜¯åŒæ­¥è®¡ç®—çš„ä¸€æ ·ã€‚</p>
</blockquote>
<ul>
<li>Objects that are asynchronously iterable can be used with a for&#x2F;await loop. You can create asynchronously iterable objects by implementing a <a href="">Symbol.asyncIterator</a> method or by invoking an async function * generator function. Asynchronous iterators provide an alternative to â€œdataâ€ events on streams in Node and can be used to represent a stream of user input events in client-side JavaScript.</li>
</ul>
<blockquote>
<p>å¼‚æ­¥å¯è¿­ä»£çš„å¯¹è±¡å¯ä»¥ä¸ for&#x2F;await å¾ªç¯ä¸€èµ·ä½¿ç”¨ã€‚å¯ä»¥é€šè¿‡å®ç° [Symbol.asyncIterator]() æ–¹æ³•æˆ–è°ƒç”¨ async function* ç”Ÿæˆå™¨å‡½æ•°æ¥åˆ›å»ºå¼‚æ­¥å¯è¿­ä»£å¯¹è±¡ã€‚å¼‚æ­¥è¿­ä»£å™¨ä¸º Node ä¸­æµçš„â€œdataâ€äº‹ä»¶æä¾›äº†ä¸€ç§æ›¿ä»£æ–¹æ³•ï¼Œå¯ç”¨äºè¡¨ç¤ºå®¢æˆ·ç«¯ JavaScript ä¸­çš„ç”¨æˆ·è¾“å…¥äº‹ä»¶çš„æµã€‚</p>
</blockquote>
<p>[^1]: The XMLHttpRequest class has nothing in particular to do with XML. In modern client-side JavaScript, it has largely been replaced by the fetch() API, which is covered in Â§15.11.1. The code example shown here is the last XMLHttpRequest-based example remaining in this book.<br>[^2]: You can typically use await at the top level in a browserâ€™s developer console. And there is a pending proposal to allow top-level await in a future version of JavaScript.<br>[^3]: I learned about this approach to asynchronous iteration from the blog of Dr. Axel Rauschmayer, <a href="">https://2ality.com</a>.</p>
<blockquote>
<p>[^1]: XMLHttpRequest ç±»ä¸ XML æ— å…³ã€‚åœ¨ç°ä»£çš„å®¢æˆ·ç«¯ JavaScript ä¸­ï¼Œå®ƒå·²è¢« fetch() API å–ä»£ï¼Œè¯¥ API å·²åœ¨ Â§15.11.1 ä¸­è¿›è¡Œäº†ä»‹ç»ã€‚æ­¤å¤„æ˜¾ç¤ºçš„ä»£ç ç¤ºä¾‹æ˜¯æœ¬ä¹¦ä¸­æœ€åä¸€ä¸ªåŸºäº XMLHttpRequest çš„ç¤ºä¾‹ã€‚<br>[^2]: é€šå¸¸ï¼Œå¯ä»¥åœ¨æµè§ˆå™¨çš„å¼€å‘äººå‘˜æ§åˆ¶å°çš„é¡¶å±‚ä½¿ç”¨ awaitã€‚è¿˜æœ‰ä¸€ä¸ªæ‚¬è€Œæœªå†³çš„å»ºè®®ï¼Œå…è®¸åœ¨å°†æ¥çš„ JavaScript ç‰ˆæœ¬ä¸­è¿›è¡Œé¡¶çº§ awaitã€‚<br>[^3]: æˆ‘ä» Dr. Axel Rauschmayer çš„åšå®¢<a href="">https://2ality.com</a>ä¸­äº†è§£äº†è¿™ç§å¼‚æ­¥è¿­ä»£æ–¹æ³•ã€‚</p>
</blockquote>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="å¤´åƒ"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img02.anzhiy.cn/adminuploads/1/2022/09/15/63232b7d91d22.jpg" title="å¤´åƒ" alt="å¤´åƒ"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img02.anzhiy.cn/adminuploads/1/2022/09/15/63232b7d91d22.jpg" title="å¤´åƒ" alt="å¤´åƒ"></a><div class="post-copyright__author_name">Jack hou</div><div class="post-copyright__author_desc"></div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="è¯¥æ–‡ç« ä¸ºåŸåˆ›æ–‡ç« ï¼Œæ³¨æ„ç‰ˆæƒåè®®" href="http://www.houyanbin.com/2023/04/26/Books/%E3%80%8AJavaScript%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E3%80%8B/ch13/">åŸåˆ›</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://www.houyanbin.com/2023/04/26/Books/%E3%80%8AJavaScript%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E3%80%8B/ch13/')">ç¬¬13ç«  å¼‚æ­¥ JavaScript</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="èµèµä½œè€…"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>æ‰“èµä½œè€…</div><div class="reward-main"><div class="reward-all"><span class="reward-title">æ„Ÿè°¢ä½ èµäºˆæˆ‘å‰è¿›çš„åŠ›é‡</span><ul class="reward-group"><li class="reward-item"><a href="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/index/wechat.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/index/wechat.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/index/alipay.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/index/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">èµèµè€…åå•</div><div class="reward-dec">å› ä¸ºä½ ä»¬çš„æ”¯æŒè®©æˆ‘æ„è¯†åˆ°å†™æ–‡ç« çš„ä»·å€¼ğŸ™</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display: none"></div><div class="reward-link mode"><a class="reward-link-button" href="/wechat/" data-pjax-state=""><i class="anzhiyufont anzhiyu-icon-plant-fill"></i>è¿è¥æ¨¡å¼ä¸è´£ä»»</a></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="ä½¿ç”¨æ‰‹æœºè®¿é—®è¿™ç¯‡æ–‡ç« "><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://www.houyanbin.com/2023/04/26/Books/%E3%80%8AJavaScript%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E3%80%8B/ch13/"></div><div class="reward-dec">ä½¿ç”¨æ‰‹æœºè®¿é—®è¿™ç¯‡æ–‡ç« </div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=ç¬¬13ç«  å¼‚æ­¥ JavaScript&amp;url=http://www.houyanbin.com/2023/04/26/Books/%E3%80%8AJavaScript%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E3%80%8B/ch13/&amp;pic=https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/post/default_cover3.jpg" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="å¤åˆ¶é“¾æ¥" onclick="rm.copyPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="http://www.houyanbin.com" target="_blank">Jackhou Blog</a>ï¼</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/%E3%80%8AJavaScript%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E3%80%8B/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>ã€ŠJavaScriptæƒå¨æŒ‡å—ã€‹<span class="tagsPageCount">17</span></a><a class="post-meta__box__tags" href="/tags/JavaScript/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>JavaScript<span class="tagsPageCount">17</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/post/default_cover6.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/04/26/Books/%E3%80%8AJavaScript%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E3%80%8B/ch14/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/post/default_cover6.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">ç¬¬14ç«  å…ƒç¼–ç¨‹</div></div></a></div><div class="next-post pull-right"><a href="/2023/04/26/Books/%E3%80%8AJavaScript%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E3%80%8B/ch12/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/post/default_cover4.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">ç¬¬12ç«  è¿­ä»£å™¨å’Œç”Ÿæˆå™¨</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><div><a href="/2023/04/26/Books/%E3%80%8AJavaScript%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E3%80%8B/ch1/" title="ç¬¬1ç«  JavaScript æ¦‚è¿°"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/post/default_cover1.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-04-26</div><div class="title">ç¬¬1ç«  JavaScript æ¦‚è¿°</div></div></a></div><div><a href="/2023/04/26/Books/%E3%80%8AJavaScript%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E3%80%8B/ch12/" title="ç¬¬12ç«  è¿­ä»£å™¨å’Œç”Ÿæˆå™¨"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/post/default_cover4.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-04-26</div><div class="title">ç¬¬12ç«  è¿­ä»£å™¨å’Œç”Ÿæˆå™¨</div></div></a></div><div><a href="/2023/04/26/Books/%E3%80%8AJavaScript%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E3%80%8B/ch10/" title="ç¬¬10ç«  æ¨¡å—"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/post/default_cover10.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-04-26</div><div class="title">ç¬¬10ç«  æ¨¡å—</div></div></a></div><div><a href="/2023/04/26/Books/%E3%80%8AJavaScript%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E3%80%8B/ch14/" title="ç¬¬14ç«  å…ƒç¼–ç¨‹"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/post/default_cover6.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-04-26</div><div class="title">ç¬¬14ç«  å…ƒç¼–ç¨‹</div></div></a></div><div><a href="/2023/04/26/Books/%E3%80%8AJavaScript%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E3%80%8B/ch11/" title="ç¬¬11ç«  JavaScript æ ‡å‡†åº“"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/post/default_cover.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-04-26</div><div class="title">ç¬¬11ç«  JavaScript æ ‡å‡†åº“</div></div></a></div><div><a href="/2023/04/26/Books/%E3%80%8AJavaScript%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E3%80%8B/ch17/" title="ç¬¬17ç«  JavaScript å·¥å…·å’Œæ‰©å±•"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/post/default_cover7.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-04-26</div><div class="title">ç¬¬17ç«  JavaScript å·¥å…·å’Œæ‰©å±•</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> è¯„è®º</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">åŒ¿åè¯„è®º</a></div><div class="comment-tips" id="comment-tips"><span>âœ… ä½ æ— éœ€åˆ é™¤ç©ºè¡Œï¼Œç›´æ¥è¯„è®ºä»¥è·å–æœ€ä½³å±•ç¤ºæ•ˆæœ</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-top" title="ç‚¹å‡»å±•å¼€"><div class="card-info-avatar"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img02.anzhiy.cn/adminuploads/1/2022/09/15/63232b7d91d22.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">Hiï¼Œè¿™æ˜¯æˆ‘çš„åšå®¢ç½‘ç«™ï¼Œæ¬¢è¿ä½ èƒ½åˆ°è®¿~</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">æˆ‘ä¼šåœ¨è¿™é‡Œåˆ†äº«æˆ‘çš„<b style="color:#fff">æŠ€æœ¯çŸ¥è¯†</b>ã€<b style="color:#fff">æ—¥å¸¸ç”Ÿæ´»</b>å’Œ<b style="color:#fff">äººç”Ÿç»éªŒã€‚</b></div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">Jack hou</h1><div class="author-info__desc"></div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/Hou-yanbin" target="_blank" title="Github"><i class="fab fa-github faa-tada"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/478589474" target="_blank" title="BiliBili"><i class="fa-brands fa-bilibili faa-tada"></i></a><a class="social-icon faa-parent animated-hover" href="https://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=jackhou921@qq.com" target="_blank" title="Email"><i class="anzhiyufont anzhiyu-icon-envelope"></i></a></div></div></div></div><div class="card-widget anzhiyu-right-widget" id="card-wechat" onclick="null"><div id="flip-wrapper"><div id="flip-content"><div class="face" style="background: url(https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/index/wxgzh1.png) center center / 100% no-repeat"></div><div class="back face" style="background: url(https://bu.dusays.com/2023/05/13/645fa415e8694.png) center center / 100% no-repeat"></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>æ–‡ç« ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#13-1-Asynchronous-Programming-with-Callbacks"><span class="toc-text">13.1 Asynchronous Programming with Callbacks</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#13-1-1-Timers"><span class="toc-text">13.1.1 Timers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-1-2-Events"><span class="toc-text">13.1.2 Events</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-1-3-Network-Events"><span class="toc-text">13.1.3 Network Events</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-1-4-Callbacks-and-Events-in-Node"><span class="toc-text">13.1.4 Callbacks and Events in Node</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-2-Promises"><span class="toc-text">13.2 Promises</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#IMPORTANT"><span class="toc-text">IMPORTANT</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-2-1-Using-Promises"><span class="toc-text">13.2.1 Using Promises</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#HANDLING-ERRORS-WITH-PROMISES"><span class="toc-text">HANDLING ERRORS WITH PROMISES</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PROMISE-TERMINOLOGY"><span class="toc-text">PROMISE TERMINOLOGY</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-2-2-Chaining-Promises"><span class="toc-text">13.2.2 Chaining Promises</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-2-3-Resolving-Promises"><span class="toc-text">13.2.3 Resolving Promises</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-2-4-More-on-Promises-and-Errors"><span class="toc-text">13.2.4 More on Promises and Errors</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#THE-CATCH-AND-FINALLY-METHODS"><span class="toc-text">THE CATCH AND FINALLY METHODS</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RETURNING-FROM-A-PROMISE-CALLBACK"><span class="toc-text">RETURNING FROM A PROMISE CALLBACK</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-2-5-Promises-in-Parallel"><span class="toc-text">13.2.5 Promises in Parallel</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-2-6-Making-Promises"><span class="toc-text">13.2.6 Making Promises</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#PROMISES-BASED-ON-OTHER-PROMISES"><span class="toc-text">PROMISES BASED ON OTHER PROMISES</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PROMISES-BASED-ON-SYNCHRONOUS-VALUES"><span class="toc-text">PROMISES BASED ON SYNCHRONOUS VALUES</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PROMISES-FROM-SCRATCH"><span class="toc-text">PROMISES FROM SCRATCH</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-2-7-Promises-in-Sequence"><span class="toc-text">13.2.7 Promises in Sequence</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-3-async-and-await"><span class="toc-text">13.3 async and await</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#13-3-1-await-Expressions"><span class="toc-text">13.3.1 await Expressions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-3-2-async-Functions"><span class="toc-text">13.3.2 async Functions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-3-3-Awaiting-Multiple-Promises"><span class="toc-text">13.3.3 Awaiting Multiple Promises</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-3-4-Implementation-Details"><span class="toc-text">13.3.4 Implementation Details</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-4-Asynchronous-Iteration"><span class="toc-text">13.4 Asynchronous Iteration</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#13-4-1-The-for-x2F-await-Loop"><span class="toc-text">13.4.1 The for&#x2F;await Loop</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-4-2-Asynchronous-Iterators"><span class="toc-text">13.4.2 Asynchronous Iterators</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-4-3-Asynchronous-Generators"><span class="toc-text">13.4.3 Asynchronous Generators</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-4-4-Implementing-Asynchronous-Iterators"><span class="toc-text">13.4.4 Implementing Asynchronous Iterators</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-5-Summary"><span class="toc-text">13.5 Summary</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/09/11/%E5%8C%BF%E5%90%8D/test/" title="æ— é¢˜"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/post/default_cover6.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="æ— é¢˜"/></a><div class="content"><a class="title" href="/2023/09/11/%E5%8C%BF%E5%90%8D/test/" title="æ— é¢˜">æ— é¢˜</a><time datetime="2023-09-11T07:50:46.501Z" title="å‘è¡¨äº 2023-09-11 15:50:46">2023-09-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/08/15/%E5%8C%BF%E5%90%8D/%E6%83%85%E4%BA%BA/" title="åšæƒ…äººçœŸçš„æ²¡æœ‰å¥½ä¸‹åœºå—ï¼Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/post/default_cover8.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="åšæƒ…äººçœŸçš„æ²¡æœ‰å¥½ä¸‹åœºå—ï¼Ÿ"/></a><div class="content"><a class="title" href="/2023/08/15/%E5%8C%BF%E5%90%8D/%E6%83%85%E4%BA%BA/" title="åšæƒ…äººçœŸçš„æ²¡æœ‰å¥½ä¸‹åœºå—ï¼Ÿ">åšæƒ…äººçœŸçš„æ²¡æœ‰å¥½ä¸‹åœºå—ï¼Ÿ</a><time datetime="2023-08-14T16:00:00.000Z" title="å‘è¡¨äº 2023-08-15 00:00:00">2023-08-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/07/30/%E5%8C%BF%E5%90%8D/%E4%B8%8D%E7%88%B1%E6%80%8E%E4%B9%88%E8%B5%B0%E4%B8%8B%E5%8E%BB/" title="ä¸çˆ±å‰è¡Œ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/post/default_cover8.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ä¸çˆ±å‰è¡Œ"/></a><div class="content"><a class="title" href="/2023/07/30/%E5%8C%BF%E5%90%8D/%E4%B8%8D%E7%88%B1%E6%80%8E%E4%B9%88%E8%B5%B0%E4%B8%8B%E5%8E%BB/" title="ä¸çˆ±å‰è¡Œ">ä¸çˆ±å‰è¡Œ</a><time datetime="2023-07-29T16:00:00.000Z" title="å‘è¡¨äº 2023-07-30 00:00:00">2023-07-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/07/22/%E5%8C%BF%E5%90%8D/%E7%A7%9F%E6%88%BF%E6%97%B6%E5%85%89/" title="ç§Ÿæˆ¿æ—¶å…‰"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/post/default_cover7.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ç§Ÿæˆ¿æ—¶å…‰"/></a><div class="content"><a class="title" href="/2023/07/22/%E5%8C%BF%E5%90%8D/%E7%A7%9F%E6%88%BF%E6%97%B6%E5%85%89/" title="ç§Ÿæˆ¿æ—¶å…‰">ç§Ÿæˆ¿æ—¶å…‰</a><time datetime="2023-07-21T16:00:00.000Z" title="å‘è¡¨äº 2023-07-22 00:00:00">2023-07-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/06/11/%E6%97%85%E8%A1%8C/%E6%95%85%E5%AE%AB%E8%AE%B0/" title="æ•…å®«è®°"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/post/default_cover6.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="æ•…å®«è®°"/></a><div class="content"><a class="title" href="/2023/06/11/%E6%97%85%E8%A1%8C/%E6%95%85%E5%AE%AB%E8%AE%B0/" title="æ•…å®«è®°">æ•…å®«è®°</a><time datetime="2023-06-10T16:00:00.000Z" title="å‘è¡¨äº 2023-06-11 00:00:00">2023-06-11</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div id="workboard"><img class="workSituationImg boardsign" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.0.4/img/badge/å®‰çŸ¥é±¼-ä¸Šç­æ‘¸é±¼ä¸­.svg" alt="è·ç¦»æœˆå…¥25kä¹Ÿå°±è¿˜å·®ä¸€ä¸ªå¤§ä½¬å¸¦æˆ‘~" title="è·ç¦»æœˆå…¥25kä¹Ÿå°±è¿˜å·®ä¸€ä¸ªå¤§ä½¬å¸¦æˆ‘~"/><div id="runtimeTextTip"></div></div></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2023 By Jack hou </div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://houyanbin.com" title="ä¸»é¢˜">ä¸»é¢˜</a></div></div></div></footer></div></div></div><div id="sidebar"><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img02.anzhiy.cn/adminuploads/1/2022/09/15/63232b7d91d22.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">æ–‡ç« </div><div class="length-num">59</div></a><a href="/tags/" title="tag"><div class="headline">æ ‡ç­¾</div><div class="length-num">19</div></a><a href="/categories/" title="category"><div class="headline">åˆ†ç±»</div><div class="length-num">11</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><span> æ–‡ç« </span></a><ul class="menus_item_child" style="left:-79px;"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> éš§é“</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> åˆ†ç±»</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> æ ‡ç­¾</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><span> å‹é“¾</span></a><ul class="menus_item_child" style="left:-31px;"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> å‹äººå¸</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> ç•™è¨€æ¿</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><span> æˆ‘çš„</span></a><ul class="menus_item_child" style="left:-79px;"><li><a class="site-page child faa-parent animated-hover" href="/music/?id=8868465080&amp;server=tencent&amp;type=0"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> éŸ³ä¹é¦†</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/bangumis/"><i class="anzhiyufont anzhiyu-icon-bilibili faa-tada" style="font-size: 0.9em;"></i><span> è¿½ç•ªé¡µ</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> ç›¸å†Œé›†</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><span> å…³äº</span></a><ul class="menus_item_child" style="left:-79px;"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> å…³äºæœ¬äºº</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> é—²è¨€ç¢è¯­</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> éšä¾¿é€›é€›</span></a></li></ul></div></div></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="ç®€ç¹è½¬æ¢">ç¹</button><button id="darkmode" type="button" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="ç›´è¾¾è¯„è®º"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><a id="switch_commentBarrage" href="javascript:anzhiyu.switchCommentBarrage();" title="å¼€å…³å¼¹å¹•"><i class="anzhiyufont anzhiyu-icon-danmu"></i></a><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">æ’­æ”¾éŸ³ä¹</a><div id="console-music-bg"></div><meting-js id="8868465080" server="tencent" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">æœç´¢</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  æ•°æ®åº“åŠ è½½ä¸­</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« " type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>å¤åˆ¶é€‰ä¸­æ–‡æœ¬</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>ç²˜è´´æ–‡æœ¬</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>å¼•ç”¨åˆ°è¯„è®º</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>æ–°çª—å£æ‰“å¼€</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>å¤åˆ¶é“¾æ¥åœ°å€</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>å¤åˆ¶æ­¤å›¾ç‰‡</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>ä¸‹è½½æ­¤å›¾ç‰‡</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>æ–°çª—å£æ‰“å¼€å›¾ç‰‡</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>ç«™å†…æœç´¢</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>ç™¾åº¦æœç´¢</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>æ’­æ”¾éŸ³ä¹</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>åˆ‡æ¢åˆ°ä¸Šä¸€é¦–</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>åˆ‡æ¢åˆ°ä¸‹ä¸€é¦–</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8868465080&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>æŸ¥çœ‹æ‰€æœ‰æ­Œæ›²</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>å¤åˆ¶æ­Œå</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>éšä¾¿é€›é€›</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>åšå®¢åˆ†ç±»</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>æ–‡ç« æ ‡ç­¾</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>å¤åˆ¶åœ°å€</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">å…³é—­çƒ­è¯„</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">æ·±è‰²æ¨¡å¼</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>è½‰ç‚ºç¹é«”</span></a></div></div><div id="rightmenu-mask"></div><div id="he-plugin-simple"></div><script>var WIDGET = {
  "CONFIG": {
    "modules": "0124",
    "background": "2",
    "tmpColor": "FFFFFF",
    "tmpSize": "16",
    "cityColor": "FFFFFF",
    "citySize": "16",
    "aqiColor": "E8D87B",
    "aqiSize": "16",
    "weatherIconSize": "24",
    "alertIconSize": "18",
    "padding": "10px 10px 10px 10px",
    "shadow": "0",
    "language": "auto",
    "borderRadius": "20",
    "fixed": "true",
    "vertical": "top",
    "horizontal": "left",
    "left": "20",
    "top": "7.1",
    "key": "df245676fb434a0691ead1c63341cd94"
  }
}
</script><link rel="stylesheet" href="https://widget.qweather.net/simple/static/css/he-simple.css?v=1.4.0"/><script src="https://widget.qweather.net/simple/static/js/he-simple.js?v=1.4.0"></script><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.14/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.3.1/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// æ¶ˆé™¤æ§åˆ¶å°æ‰“å°
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //åœ¨æ¢å¤å‰è¾“å‡ºæ—¥å¿—
  const grt = new Date("4/15/2023 00:00:00"); //æ­¤å¤„ä¿®æ”¹ä½ çš„å»ºç«™æ—¶é—´æˆ–è€…ç½‘ç«™ä¸Šçº¿æ—¶é—´
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `æ¬¢è¿ä½¿ç”¨å®‰çŸ¥é±¼!`,
    `ç”Ÿæ´»æ˜æœ—, ä¸‡ç‰©å¯çˆ±`,
    `
        
       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—
      â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â•šâ•â•â–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘
      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘
      â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ–ˆâ•”â•  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â•šâ–ˆâ–ˆâ•”â•  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘
      â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•
      â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•â•â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•   â•šâ•â•    â•šâ•â•â•â•â•â•
        
        `,
    "å·²ä¸Šçº¿",
    dnum,
    "å¤©",
    "Â©2023 By å®‰çŸ¥é±¼ V1.5.3",
  ];
  const ascll2 = [`NCC2-036`, `è°ƒç”¨å‰ç½®æ‘„åƒå¤´æ‹ç…§æˆåŠŸï¼Œè¯†åˆ«ä¸ºã€å°ç¬¨è›‹ã€‘.`, `Photo captured: `, `ğŸ¤ª`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#3b70fc",
      "",
      "color:#3b70fc",
      "color:#3b70fc",
      "",
      "color:#3b70fc",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c ä½ å¥½ï¼Œå°ç¬¨è›‹.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c âš¡ Powered by å®‰çŸ¥é±¼ %c ä½ æ­£åœ¨è®¿é—® Jack hou çš„åšå®¢.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c ä½ å·²æ‰“å¼€æ§åˆ¶å°.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c ä½ ç°åœ¨æ­£å¤„äºç›‘æ§ä¸­.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script async="async">(function () {
  var grt = new Date("4/15/2023 00:00:00"); //è®¾ç½®ç½‘ç«™ä¸Šçº¿æ—¶é—´
  var now = new Date();
  var dnum;
  var hnum;
  var mnum;
  var snum;
  var nowHour;

  // è®¡ç®—å¹¶æ›´æ–°å¤©æ•°ã€å°æ—¶æ•°ã€åˆ†é’Ÿæ•°å’Œç§’æ•°
  function updateTime() {
    now = new Date(); // æ›´æ–° now çš„å€¼
    nowHour = now.getHours(); // æ›´æ–° nowHour çš„å€¼
    var days = (now - grt) / 1000 / 60 / 60 / 24;
    dnum = Math.floor(days);
    var hours = (now - grt) / 1000 / 60 / 60 - 24 * dnum;
    hnum = Math.floor(hours);
    if (String(hnum).length == 1) {
      hnum = "0" + hnum;
    }
    var minutes = (now - grt) / 1000 / 60 - 24 * 60 * dnum - 60 * hnum;
    mnum = Math.floor(minutes);
    if (String(mnum).length == 1) {
      mnum = "0" + mnum;
    }
    var seconds = (now - grt) / 1000 - 24 * 60 * 60 * dnum - 60 * 60 * hnum - 60 * mnum;
    snum = Math.round(seconds);
    if (String(snum).length == 1) {
      snum = "0" + snum;
    }
  }

  // æ›´æ–°ç½‘é¡µä¸­æ˜¾ç¤ºçš„ç½‘ç«™è¿è¡Œæ—¶é—´
  function updateHtml() {
    const footer = document.getElementById("footer");
    if (!footer) return
    let currentTimeHtml = "";
    if (nowHour < 18 && nowHour >= 9) {
      // å¦‚æœæ˜¯ä¸Šç­æ—¶é—´ï¼Œé»˜è®¤å°±æ˜¯"å®‰çŸ¥é±¼-ä¸Šç­æ‘¸é±¼ä¸­.svg"å›¾ç‰‡ï¼Œä¸éœ€è¦æ›´æ”¹
      currentTimeHtml = `æœ¬ç«™å±…ç„¶è¿è¡Œäº† ${dnum} å¤©<span id='runtime'> ${hnum} å°æ—¶ ${mnum} åˆ† ${snum} ç§’ </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`;
    } else {
      // å¦‚æœæ˜¯ä¸‹ç­æ—¶é—´ï¼Œæ’å…¥"å®‰çŸ¥é±¼-ä¸‹ç­å•¦.svg"å›¾ç‰‡
      let img = document.querySelector("#workboard .workSituationImg");
      img.src = "https://npm.elemecdn.com/anzhiyu-blog@2.0.4/img/badge/å®‰çŸ¥é±¼-ä¸‹ç­å•¦.svg";
      img.title = "ä¸‹ç­äº†å°±è¯¥å¼€å¼€å¿ƒå¿ƒçš„ç©è€ï¼Œå˜¿å˜¿~";
      img.alt = "ä¸‹ç­äº†å°±è¯¥å¼€å¼€å¿ƒå¿ƒçš„ç©è€ï¼Œå˜¿å˜¿~";

      currentTimeHtml = `æœ¬ç«™å±…ç„¶è¿è¡Œäº† ${dnum} å¤©<span id='runtime'> ${hnum} å°æ—¶ ${mnum} åˆ† ${snum} ç§’ </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`;
    }

    if (document.getElementById("runtimeTextTip")) {
      document.getElementById("runtimeTextTip").innerHTML = currentTimeHtml;
    }
  }

  setInterval(() => {
    updateTime();
    updateHtml();
  }, 1000);
})();</script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://twikoo.houyanbin.com/',
      region: '',
      onCommentLoaded: function () {
        anzhiyu.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoo.houyanbin.com/',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      countELement.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init();
    
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://cdn.cbd.int/twikoo@1.6.17/dist/twikoo.all.min.js').then(runFn)
  }
  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) anzhiyu.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[å›¾ç‰‡]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[é“¾æ¥]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[ä»£ç ]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getComment = () => {
    const runTwikoo = () => {
      twikoo.getRecentComments({
        envId: 'https://twikoo.houyanbin.com/',
        region: '',
        pageSize: 6,
        includeReply: true
      }).then(function (res) {
        const twikooArray = res.map(e => {
          return {
            'content': changeContent(e.comment),
            'avatar': e.avatar,
            'nick': e.nick,
            'url': e.url + '#' + e.id,
            'date': new Date(e.created).toISOString()
          }
        })

        saveToLocal.set('twikoo-newest-comments', JSON.stringify(twikooArray), 10/(60*24))
        generateHtml(twikooArray)
      }).catch(function (err) {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.innerHTML= "æ— æ³•è·å–è¯„è®ºï¼Œè¯·ç¡®è®¤ç›¸å…³é…ç½®æ˜¯å¦æ­£ç¡®"
      })
    }

    if (typeof twikoo === 'object') {
      runTwikoo()
    } else {
      getScript('https://cdn.cbd.int/twikoo@1.6.17/dist/twikoo.all.min.js').then(runTwikoo)
    }
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'><div class='name'><span>${array[i].nick}</span></div></a>`
        }
        
        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div>`
      }
    } else {
      result += 'æ²¡æœ‰è¯„è®º'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom.innerHTML= result
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('twikoo-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "visitor@anzhiy.cn";</script><script>//åŠ¨æ€æ ‡é¢˜
let leaveTitle = 'w(ï¾ŸĞ”ï¾Ÿ)w ä¸è¦èµ°ï¼å†çœ‹çœ‹å˜›ï¼';
let backTitle = 'â™ª(^âˆ‡^*)æ¬¢è¿è‚¥æ¥ï¼';
let OriginTitile = document.title
let titleTime
document.addEventListener('visibilitychange', function () {
  if (document.hidden) {
    //ç¦»å¼€å½“å‰é¡µé¢æ—¶æ ‡ç­¾æ˜¾ç¤ºå†…å®¹
    document.title = leaveTitle
    clearTimeout(titleTime)
  } else {
    //è¿”å›å½“å‰é¡µé¢æ—¶æ ‡ç­¾æ˜¾ç¤ºå†…å®¹
    document.title = backTitle + OriginTitile
    //ä¸¤ç§’åå˜å›æ­£å¸¸æ ‡é¢˜
    titleTime = setTimeout(function () {
      document.title = OriginTitile
    }, 2000)
  }
})</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script>// åˆå§‹åŒ–å‡½æ•°
let rm = {};

//ç¦æ­¢å›¾ç‰‡ä¸è¶…é“¾æ¥æ‹–æ‹½
let aElements = document.getElementsByTagName("a");
for (let i = 0; i < aElements.length; i++) {
  aElements[i].setAttribute("draggable", "false");
  let imgElements = aElements[i].getElementsByTagName("img");
  for (let j = 0; j < imgElements.length; j++) {
    imgElements[j].setAttribute("draggable", "false");
  }
}

// æ˜¾ç¤ºèœå•
rm.showRightMenu = function (isTrue, x = 0, y = 0) {
  console.info(x, y)
  let rightMenu = document.getElementById("rightMenu");
  rightMenu.style.top = x + "px";
  rightMenu.style.left = y + "px";
  if (isTrue) {
    rightMenu.style.display = "block";
    stopMaskScroll();
  } else {
    rightMenu.style.display = "none";
  }
};

// éšè—èœå•
rm.hideRightMenu = function () {
  rm.showRightMenu(false);
  let rightMenuMask = document.querySelector("#rightmenu-mask");
  rightMenuMask.style.display = "none";
};

// å°ºå¯¸
let rmWidth = document.getElementById("rightMenu").offsetWidth;
let rmHeight = document.getElementById("rightMenu").offsetHeight;

// é‡æ–°å®šä¹‰å°ºå¯¸
rm.reloadrmSize = function () {
  rightMenu.style.visibility = "hidden";
  rightMenu.style.display = "block";
  // è·å–å®½åº¦å’Œé«˜åº¦
  rmWidth = document.getElementById("rightMenu").offsetWidth;
  rmHeight = document.getElementById("rightMenu").offsetHeight;
  rightMenu.style.visibility = "visible";
};

// è·å–ç‚¹å‡»çš„href
let domhref = "";
let domImgSrc = "";
let globalEvent = null;

var oncontextmenuFunction = function (event) {
  if (document.body.clientWidth > 768) {
    let pageX = event.clientX + 10; //åŠ 10æ˜¯ä¸ºäº†é˜²æ­¢æ˜¾ç¤ºæ—¶é¼ æ ‡é®åœ¨èœå•ä¸Š
    let pageY = event.clientY;

    //å…¶ä»–é¢å¤–èœå•
    const $rightMenuOther = document.querySelector(".rightMenuOther");
    const $rightMenuPlugin = document.querySelector(".rightMenuPlugin");
    const $rightMenuCopyText = document.querySelector("#menu-copytext");
    const $rightMenuPasteText = document.querySelector("#menu-pastetext");
    const $rightMenuCommentText = document.querySelector("#menu-commenttext");
    const $rightMenuNewWindow = document.querySelector("#menu-newwindow");
    const $rightMenuNewWindowImg = document.querySelector("#menu-newwindowimg");
    const $rightMenuCopyLink = document.querySelector("#menu-copylink");
    const $rightMenuCopyImg = document.querySelector("#menu-copyimg");
    const $rightMenuDownloadImg = document.querySelector("#menu-downloadimg");
    const $rightMenuSearch = document.querySelector("#menu-search");
    const $rightMenuSearchBaidu = document.querySelector("#menu-searchBaidu");
    const $rightMenuMusicToggle = document.querySelector("#menu-music-toggle");
    const $rightMenuMusicBack = document.querySelector("#menu-music-back");
    const $rightMenuMusicForward = document.querySelector("#menu-music-forward");
    const $rightMenuMusicPlaylist = document.querySelector("#menu-music-playlist");
    const $rightMenuMusicCopyMusicName = document.querySelector("#menu-music-copyMusicName");

    let href = event.target.href;
    let imgsrc = event.target.currentSrc;

    // åˆ¤æ–­æ¨¡å¼ æ‰©å±•æ¨¡å¼ä¸ºæœ‰äº‹ä»¶
    let pluginMode = false;
    $rightMenuOther.style.display = "block";
    globalEvent = event;

    // æ£€æŸ¥æ˜¯å¦éœ€è¦å¤åˆ¶ æ˜¯å¦æœ‰é€‰ä¸­æ–‡æœ¬
    if (selectTextNow && window.getSelection()) {
      pluginMode = true;
      $rightMenuCopyText.style.display = "block";
      $rightMenuCommentText.style.display = "block";
      $rightMenuSearch.style.display = "block";
      $rightMenuSearchBaidu.style.display = "block";
    } else {
      $rightMenuCopyText.style.display = "none";
      $rightMenuCommentText.style.display = "none";
      $rightMenuSearchBaidu.style.display = "none";
      $rightMenuSearch.style.display = "none";
    }

    //æ£€æŸ¥æ˜¯å¦å³é”®ç‚¹å‡»äº†é“¾æ¥aæ ‡ç­¾
    if (href) {
      pluginMode = true;
      $rightMenuNewWindow.style.display = "block";
      $rightMenuCopyLink.style.display = "block";
      domhref = href;
    } else {
      $rightMenuNewWindow.style.display = "none";
      $rightMenuCopyLink.style.display = "none";
    }

    //æ£€æŸ¥æ˜¯å¦éœ€è¦å¤åˆ¶å›¾ç‰‡
    if (imgsrc) {
      pluginMode = true;
      $rightMenuCopyImg.style.display = "block";
      $rightMenuDownloadImg.style.display = "block";
      $rightMenuNewWindowImg.style.display = "block";
      document.getElementById("rightMenu").style.width="12rem"
      domImgSrc = imgsrc;
    } else {
      $rightMenuCopyImg.style.display = "none";
      $rightMenuDownloadImg.style.display = "none";
      $rightMenuNewWindowImg.style.display = "none";
    }

    // åˆ¤æ–­æ˜¯å¦ä¸ºè¾“å…¥æ¡†
    if (event.target.tagName.toLowerCase() === "input" || event.target.tagName.toLowerCase() === "textarea") {
      pluginMode = true;
      $rightMenuPasteText.style.display = "block";
    } else {
      $rightMenuPasteText.style.display = "none";
    }
    const navMusicEl = document.querySelector("#nav-music");
    //åˆ¤æ–­æ˜¯å¦æ˜¯éŸ³ä¹
    if (navMusicEl && navMusicEl.contains(event.target)) {
      pluginMode = true;
      $rightMenuMusicToggle.style.display = "block";
      $rightMenuMusicBack.style.display = "block";
      $rightMenuMusicForward.style.display = "block";
      $rightMenuMusicPlaylist.style.display = "block";
      $rightMenuMusicCopyMusicName.style.display = "block";
    } else {
      $rightMenuMusicToggle.style.display = "none";
      $rightMenuMusicBack.style.display = "none";
      $rightMenuMusicForward.style.display = "none";
      $rightMenuMusicPlaylist.style.display = "none";
      $rightMenuMusicCopyMusicName.style.display = "none";
    }

    // å¦‚æœä¸æ˜¯æ‰©å±•æ¨¡å¼åˆ™éšè—æ‰©å±•æ¨¡å—
    if (pluginMode) {
      $rightMenuOther.style.display = "none";
      $rightMenuPlugin.style.display = "block";
    } else {
      $rightMenuPlugin.style.display = "none";
    }

    rm.reloadrmSize();

    // é¼ æ ‡é»˜è®¤æ˜¾ç¤ºåœ¨é¼ æ ‡å³ä¸‹æ–¹ï¼Œå½“é¼ æ ‡é å³æˆ–é ä¸‹æ—¶ï¼Œå°†èœå•æ˜¾ç¤ºåœ¨é¼ æ ‡å·¦æ–¹\ä¸Šæ–¹
    if (pageX + rmWidth > window.innerWidth) {
      pageX -= rmWidth + 10;
    }
    if (pageY + rmHeight > window.innerHeight) {
      pageY -= pageY + rmHeight - window.innerHeight;
    }

    rm.showRightMenu(true, pageY, pageX);
    document.getElementById("rightmenu-mask").style.display = "flex";
    return false;
  }
};

// ç›‘å¬å³é”®åˆå§‹åŒ–
window.oncontextmenu = oncontextmenuFunction

// ä¸‹è½½å›¾ç‰‡çŠ¶æ€
rm.downloadimging = false;

// å¤åˆ¶å›¾ç‰‡åˆ°å‰ªè´´æ¿
rm.writeClipImg = function (imgsrc) {
  console.log("æŒ‰ä¸‹å¤åˆ¶");
  rm.hideRightMenu();
  anzhiyu.snackbarShow("æ­£åœ¨ä¸‹è½½ä¸­ï¼Œè¯·ç¨å", false, 10000);
  if (rm.downloadimging == false) {
    rm.downloadimging = true;
    setTimeout(function () {
      copyImage(imgsrc);
      anzhiyu.snackbarShow("å¤åˆ¶æˆåŠŸï¼å›¾ç‰‡å·²æ·»åŠ ç›²æ°´å°ï¼Œè¯·éµå®ˆç‰ˆæƒåè®®");
      rm.downloadimging = false;
    }, "10000");
  }
};

function imageToBlob(imageURL) {
  const img = new Image();
  const c = document.createElement("canvas");
  const ctx = c.getContext("2d");
  img.crossOrigin = "";
  img.src = imageURL;
  return new Promise(resolve => {
    img.onload = function () {
      c.width = this.naturalWidth;
      c.height = this.naturalHeight;
      ctx.drawImage(this, 0, 0);
      c.toBlob(
        blob => {
          // here the image is a blob
          resolve(blob);
        },
        "image/png",
        0.75
      );
    };
  });
}

async function copyImage(imageURL) {
  const blob = await imageToBlob(imageURL);
  const item = new ClipboardItem({ "image/png": blob });
  navigator.clipboard.write([item]);
}

rm.copyUrl = function (id) {
  const input = document.createElement("input"); // Create a new <input> element
  input.id = "copyVal"; // Set the id of the new element to "copyVal"
  document.body.appendChild(input); // Append the new element to the end of the <body> element
  
  const text = id;
  input.value = text;
  input.select();
  input.setSelectionRange(0, input.value.length);
  document.execCommand("copy");
  
  input.remove(); // Remove the <input> element from the DOM
};

function stopMaskScroll() {
  if (document.getElementById("rightmenu-mask")) {
    let xscroll = document.getElementById("rightmenu-mask");
    xscroll.addEventListener(
      "mousewheel",
      function (e) {
        //é˜»æ­¢æµè§ˆå™¨é»˜è®¤æ–¹æ³•
        rm.hideRightMenu();
        // e.preventDefault();
      },
      { passive: true }
    );
  }
  if (document.getElementById("rightMenu")) {
    let xscroll = document.getElementById("rightMenu");
    xscroll.addEventListener(
      "mousewheel",
      function (e) {
        //é˜»æ­¢æµè§ˆå™¨é»˜è®¤æ–¹æ³•
        rm.hideRightMenu();
        // e.preventDefault();
      },
      { passive: true }
    );
  }
}

rm.rightmenuCopyText = function (txt) {
  if (navigator.clipboard) {
    navigator.clipboard.writeText(txt);
  }
  rm.hideRightMenu();
};

rm.copyPageUrl = function (url) {
  if (!url) {
    url = window.location.href;
  }
  rm.copyUrl(url);
  anzhiyu.snackbarShow("å¤åˆ¶é“¾æ¥åœ°å€æˆåŠŸ", false, 2000);
  rm.hideRightMenu();
};

rm.sharePage = function () {
  var content = window.location.href;
  rm.copyUrl(url);
  anzhiyu.snackbarShow("å¤åˆ¶é“¾æ¥åœ°å€æˆåŠŸ", false, 2000);
  rm.hideRightMenu();
};

// å¤åˆ¶å½“å‰é€‰ä¸­æ–‡æœ¬
var selectTextNow = "";
document.onmouseup = document.ondblclick = selceText;

function selceText() {
  var txt;
  if (document.selection) {
    txt = document.selection.createRange().text;
  } else {
    txt = window.getSelection().toString();
  }
  selectTextNow = txt !== "" ? txt : "";
}

// è¯»å–å‰ªåˆ‡æ¿
rm.readClipboard = function () {
  if (navigator.clipboard) {
    navigator.clipboard.readText().then(clipText => rm.insertAtCaret(globalEvent.target, clipText));
  }
};

// ç²˜è´´æ–‡æœ¬åˆ°ç„¦ç‚¹
rm.insertAtCaret = function (elemt, value) {
  const startPos = elemt.selectionStart,
    endPos = elemt.selectionEnd;
  if (document.selection) {
    elemt.focus();
    var sel = document.selection.createRange();
    sel.text = value;
    elemt.focus();
  } else {
    if (startPos || startPos == "0") {
      var scrollTop = elemt.scrollTop;
      elemt.value = elemt.value.substring(0, startPos) + value + elemt.value.substring(endPos, elemt.value.length);
      elemt.focus();
      elemt.selectionStart = startPos + value.length;
      elemt.selectionEnd = startPos + value.length;
      elemt.scrollTop = scrollTop;
    } else {
      elemt.value += value;
      elemt.focus();
    }
  }
};

//ç²˜è´´æ–‡æœ¬
rm.pasteText = function () {
  const result = rm.readClipboard() || "";
  rm.hideRightMenu();
};

//å¼•ç”¨åˆ°è¯„è®º
rm.rightMenuCommentText = function (txt) {
  rm.hideRightMenu();
  const postCommentDom = document.getElementById("post-comment");
  var domTop = postCommentDom.offsetTop;
  window.scrollTo(0, domTop - 80);
  if (txt == "undefined" || txt == "null") txt = "å¥½æ£’ï¼";
  function setText() {
    setTimeout(() => {
      var input = document.getElementsByClassName("el-textarea__inner")[0];
      if (!input) setText();
      let evt = document.createEvent("HTMLEvents");
      evt.initEvent("input", true, true);
      let inputValue = replaceAll(txt, "\n", "\n> ");
      input.value = "> " + inputValue + "\n\n";
      input.dispatchEvent(evt);
      input.focus();
      input.setSelectionRange(-1, -1);
      if (document.getElementById("comment-tips")) {
        document.getElementById("comment-tips").classList.add("show");
      }
    }, 100);
  }
  setText();
};

//æ›¿æ¢æ‰€æœ‰å†…å®¹
function replaceAll(string, search, replace) {
  return string.split(search).join(replace);
}

// ç™¾åº¦æœç´¢
rm.searchBaidu = function () {
  anzhiyu.snackbarShow("å³å°†è·³è½¬åˆ°ç™¾åº¦æœç´¢", false, 2000);
  setTimeout(function () {
    window.open("https://www.baidu.com/s?wd=" + selectTextNow);
  }, "2000");
  rm.hideRightMenu();
};

//åˆ†äº«é“¾æ¥
rm.copyLink = function () {
  rm.rightmenuCopyText(domhref);
  anzhiyu.snackbarShow("å·²å¤åˆ¶é“¾æ¥åœ°å€");
};

function addRightMenuClickEvent() {
  // æ·»åŠ ç‚¹å‡»äº‹ä»¶
  document.getElementById("menu-backward").addEventListener("click", function () {
  window.history.back();
    rm.hideRightMenu();
  });

  document.getElementById("menu-forward").addEventListener("click", function () {
    window.history.forward();
    rm.hideRightMenu();
  });

  document.getElementById("menu-refresh").addEventListener("click", function () {
    window.location.reload();
  });

  document.getElementById("menu-top").addEventListener("click", function () {
    anzhiyu.scrollToDest(0, 500);
    rm.hideRightMenu();
  });

  const menuLinks = document.querySelectorAll(".menu-link");
  menuLinks.forEach(function (link) {
    link.addEventListener("click", rm.hideRightMenu);
  });

  document.getElementById("menu-darkmode").addEventListener("click", anzhiyu.switchDarkMode);

  document.getElementById("menu-home") && document.getElementById("menu-home").addEventListener("click", function () {
    window.location.href = window.location.origin;
  });

  document.getElementById("menu-randomPost").addEventListener("click", function () {
    toRandomPost();
  });

  document.getElementById("menu-commentBarrage").addEventListener("click", anzhiyu.switchCommentBarrage);

  document.getElementById("rightmenu-mask").addEventListener("click", rm.hideRightMenu);

  document.getElementById("rightmenu-mask").addEventListener("contextmenu", function (event) {
    rm.hideRightMenu();
    event.preventDefault(); // Prevent the default context menu from appearing
  });

  document.getElementById("menu-copy").addEventListener("click", rm.copyPageUrl);

  document.getElementById("menu-pastetext").addEventListener("click", rm.pasteText);

  document.getElementById("menu-copytext").addEventListener("click", function () {
    rm.rightmenuCopyText(selectTextNow);
    anzhiyu.snackbarShow("å¤åˆ¶æˆåŠŸï¼Œå¤åˆ¶å’Œè½¬è½½è¯·æ ‡æ³¨æœ¬æ–‡åœ°å€");
  });

  document.getElementById("menu-commenttext").addEventListener("click", function () {
    rm.rightMenuCommentText(selectTextNow);
  });

  document.getElementById("menu-newwindow").addEventListener("click", function () {
    window.open(domhref, "_blank");
    rm.hideRightMenu();
  });

  document.getElementById("menu-copylink").addEventListener("click", rm.copyLink);

  document.getElementById("menu-downloadimg").addEventListener("click", function () {
    anzhiyu.downloadImage(domImgSrc, "anzhiyu");
  });

  document.getElementById("menu-newwindowimg").addEventListener("click", function () {
    window.open(domImgSrc, "_blank");
    rm.hideRightMenu();
  });

  document.getElementById("menu-copyimg").addEventListener("click", function () {
    rm.writeClipImg(domImgSrc);
  });

  document.getElementById("menu-searchBaidu").addEventListener("click", rm.searchBaidu);

  //éŸ³ä¹
  document.getElementById("menu-music-toggle").addEventListener("click", anzhiyu.musicToggle);

  document.getElementById("menu-music-back").addEventListener("click", anzhiyu.musicSkipBack);

  document.getElementById("menu-music-forward").addEventListener("click", anzhiyu.musicSkipForward);

  document.getElementById("menu-music-copyMusicName").addEventListener("click", function () {
    rm.rightmenuCopyText(anzhiyu.musicGetName());
    anzhiyu.snackbarShow("å¤åˆ¶æ­Œæ›²åç§°æˆåŠŸ", false, 3000);
  });

}

addRightMenuClickEvent();</script><script data-pjax>var themeColorMeta = document.querySelector('meta[name="theme-color"]');
var pageHeaderEl = document.getElementById("page-header");
var navMusicEl = document.getElementById("nav-music");
var consoleEl = document.getElementById("console");
// å·²éšæœºçš„æ­Œæ›²
var selectRandomSong = [];
// éŸ³ä¹é»˜è®¤å£°éŸ³å¤§å°
var musicVolume = 0.8;
// æ˜¯å¦åˆ‡æ¢äº†å‘¨æ°ä¼¦éŸ³ä¹åˆ—è¡¨
var changeMusicListFlag = false;
// å½“å‰é»˜è®¤æ’­æ”¾åˆ—è¡¨
var defaultPlayMusicList = [];

document.getElementById("page-name").innerText = document.title.split(" | Jackhou Blog")[0];
anzhiyu.initIndexEssay();
anzhiyu.changeTimeInEssay();
anzhiyu.removeBodyPaceClass();
anzhiyu.qrcodeCreate();
anzhiyu.changeTimeInAlbumDetail();
anzhiyu.reflashEssayWaterFall();
anzhiyu.sayhi();
anzhiyu.stopImgRightDrag();
anzhiyu.addNavBackgroundInit();
anzhiyu.setValueToBodyType();
anzhiyu.catalogActive();
anzhiyu.tagsPageActive();
anzhiyu.categoriesBarActive();
anzhiyu.topCategoriesBarScroll();
anzhiyu.switchRightClickMenuHotReview();
anzhiyu.getCustomPlayList();
anzhiyu.addEventListenerConsoleMusicList(false);
setTimeout(() => {if (typeof addFriendLinksInFooter === "function") {addFriendLinksInFooter();}}, 200)</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","meta[property=\"og:type\"]","meta[property=\"og:site_name\"]","meta[property=\"og:description\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div></body></html>