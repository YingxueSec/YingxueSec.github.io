<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>ç¬¬15ç«  Web æµè§ˆå™¨ä¸­çš„ JavaScript | Jackhou Blog</title><meta name="keywords" content="ã€ŠJavaScriptæƒå¨æŒ‡å—ã€‹,JavaScript"><meta name="author" content="Jack hou"><meta name="copyright" content="Jack hou"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="ç¬¬15ç«  Web æµè§ˆå™¨ä¸­çš„ JavaScript"><meta name="application-name" content="ç¬¬15ç«  Web æµè§ˆå™¨ä¸­çš„ JavaScript"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="ç¬¬15ç«  Web æµè§ˆå™¨ä¸­çš„ JavaScript"><meta property="og:url" content="http://www.houyanbin.com/2023/04/26/Books/%E3%80%8AJavaScript%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E3%80%8B/ch15/index.html"><meta property="og:site_name" content="Jackhou Blog"><meta property="og:description" content="The JavaScript language was created in 1994 with the express purpose of enabling dynamic behavior in the documents displayed by web browsers. The"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/post/default_cover5.jpg"><meta property="article:author" content="Jack hou"><meta property="article:tag" content="Jackhou, blog"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/post/default_cover5.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://www.houyanbin.com/2023/04/26/Books/%E3%80%8AJavaScript%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E3%80%8B/ch15/"><link rel="preconnect" href="//npm.elemecdn.com"/><link rel="preconnect" href="//npm.onmicrosoft.cn"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@1.0.17/lib/assets/font-awesome-animation.min.css"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.14/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  preloader: {"source":3},
  friends_vue_info: {"apiurl":null},
  navMusic: true,
  mainTone: undefined,
  authorStatus: undefined,
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"ç¹","msgToSimplifiedChinese":"ç®€","rightMenuMsgToTraditionalChinese":"è½¬ä¸ºç¹ä½“","rightMenuMsgToSimplifiedChinese":"è½¬ä¸ºç®€ä½“"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: true,
    simplehomepage: false,
    post: false
  },
  runtime: 'å¤©',
  date_suffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"ä½ å·²åˆ‡æ¢ä¸ºç¹ä½“","cht_to_chs":"ä½ å·²åˆ‡æ¢ä¸ºç®€ä½“","day_to_night":"ä½ å·²åˆ‡æ¢ä¸ºæ·±è‰²æ¨¡å¼","night_to_day":"ä½ å·²åˆ‡æ¢ä¸ºæµ…è‰²æ¨¡å¼","bgLight":"#3b70fc","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'ç¬¬15ç«  Web æµè§ˆå™¨ä¸­çš„ JavaScript',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-04-26 21:46:16',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="åŠ è½½å¤´åƒ" src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAASABIAAD/4QBwRXhpZgAATU0AKgAAAAgABAEGAAMAAAABAAIAAAESAAMAAAABAAEAAAEoAAMAAAABAAIAAIdpAAQAAAABAAAAPgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAABQKADAAQAAAABAAABPAAAAAD/7QA4UGhvdG9zaG9wIDMuMAA4QklNBAQAAAAAAAA4QklNBCUAAAAAABDUHYzZjwCyBOmACZjs+EJ+/8AAEQgBPAFAAwEiAAIRAQMRAf/EAB8AAAEFAQEBAQEBAAAAAAAAAAABAgMEBQYHCAkKC//EALUQAAIBAwMCBAMFBQQEAAABfQECAwAEEQUSITFBBhNRYQcicRQygZGhCCNCscEVUtHwJDNicoIJChYXGBkaJSYnKCkqNDU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6g4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2drh4uPk5ebn6Onq8fLz9PX29/j5+v/EAB8BAAMBAQEBAQEBAQEAAAAAAAABAgMEBQYHCAkKC//EALURAAIBAgQEAwQHBQQEAAECdwABAgMRBAUhMQYSQVEHYXETIjKBCBRCkaGxwQkjM1LwFWJy0QoWJDThJfEXGBkaJicoKSo1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoKDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uLj5OXm5+jp6vLz9PX29/j5+v/bAEMAAQEBAQEBAgEBAgMCAgIDBAMDAwMEBgQEBAQEBgcGBgYGBgYHBwcHBwcHBwgICAgICAkJCQkJCwsLCwsLCwsLC//bAEMBAgICAwMDBQMDBQsIBggLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLCwsLC//dAAQAFP/aAAwDAQACEQMRAD8A/ugop2R6UpaND+9+UDrT9ojQZUsQycV478ZPj58IfgR4fXxH8RtV+xW77tp27s7MZ7jpkV/O9+13/wAFWPil4z12bQf2bLpPDOjLEsOXQEvs+6RjGRyeuPxqzopUpXuf0B/tCftK/Av9nHTRqPxZvhCMN8pH93Gf/QhX4KftE/8ABXX4qeP92g/ASwPhzRzuVZHIbcOOeik9/SvyGF42vkHWsTGLIQg8DPpT44xENqcAdqyqVFY9GFPTUu63q/iPxT4o1DxP4l1KXUdQ1EqQspyF2Zzg575/Sq0G5Btbr3ruLr4V+N4vA178Rr2yaLS7FN/2gHPzHOAfTOPxrgI1kAyQTjqazw+8izTtpNjE4zur7n/Zq/YB+Mn7QOkJrVi2n6V4ZmOBtGTjsTyvpXwaHVPvV/Xd+wX4Q/4RH9j/AMDWCw+Wfseev3ulc+PdogfLXg//AIJDfs+aXqX23xlqF3r+/HmBpcZx0wecV976N+zP8C/Cv2SLRfCWjxrCCDm0VmboASSeo9817ciqh3Ac+tTyKJF2NXguHNIDNO3TgGXB696/ll/4KH/tZ6n8d/iPH4Z8JX4ufCGkiP7En9/b98+2cL+VfS//AAU5/a1XWdak/Zw8FSsJ9IjEWvsr/u5QfvY4GVYjkZHA61+aP7LP7Mfjv9qT4lW/w88GN9nshg6jqgXIscdT1H4c8162Dw1tWLzPZv2EP2QfEH7X/i2VHKxeFdPx/ackiErublVBBGWx2/lX9W/hD4beAvht4KTwF8PNLi0vT4htSOMDI+p4zWP8K/hV4W+DXgLTvh34NSRbDTU8uLzW3OVGMbmwMnrk16WiMpGa7pSSVgsXy25Q3rTaRTlAKWuNjPmn9r/4Iv8AtBfs9698N45FRrpFZVcZDlc8e3XrX8cE0fiHwj4o8kA2eo6VeqjbhyrKSCK/u2ycYr+R7/gpB8K7/wCGv7WutzxQLBpXiRRqFiF6EMSGb2Occc1E/hA/ph+BnxAi+M/wZ8N/E2Q+Z/aVovOc/d//AF16j9kt0IZVr8eP+CQvxtk8UeC9V+FniK73T6XF5kKt6jPA9B1/Ov2PJJ6ivCx8XdBHcuIixrtXpTqKK8461sFFFFAwpr/dp1MkBKHHXFXT+JAfx9f8FCPgbefA39pHWdDgTZpuoN9rs3XjKydR35GB3r6Y/wCCcf7HPwH/AGoPDfiP/hYH22a90V1Rn87gjD9sDAbHvjFfQ3/BZbwnZXsXgXxSgAuWN5bynHLgeUVyc9ufzr5W/wCCV3jBfB37VlpoVxJst/EFnPZyxngPuKnP1B6fWvqsDsDvY+d/2svgA/7L3xuvPhVaR7dFYb7BgoB9wT346c+teQ6D8M/iR4h8NP498M6BeXeg9Bd7doOeOmK/oa/4Ky/AbTvGPwVHxVi41TQQpZ1XLSKO59/wNfnR/wAExf2grL4X/H+bwdqjbbPxflXbdgKV4TP0LHuK7pOyuT7RdT5V+DH7V/7Q3wSQWXw78VTNp0YHk6dqiG90onnhVBTk55Ga/Zz4Nf8ABYLwDriSL+0Fp7eHb5ioV4ysisOeexx06gfjX0r8af2Cv2dPjTdz6tPoy6Lq11gtfWAEcufXpg54zxyABX5CftE/8Eu/j18PIX1b4eEeKtMjyRs/dzIo/vL8wPfpXI8Wk7Micos/pQ8A/ETwP8UNETX/AAHqcOpQMoY+UwJUH1FdopG4Cv4dfhx8WviV8CfFL6z4IuJNJ1W3cJKCG3BkJ+Vl4z3H41/QN+yV/wAFU/h78R9CtdD+N6p4c13o0bMGY+56fyrrjVi0czV2fstF/qxUlMJWJMnoKfWpD2Ciiig4mtT/0P7ouG4xj6V+If7YH/BVjSPDTXPgf9mORNT1aLiLUiu9GB9zjIHNfml+1R/wUS+MX7REl94a0B00XwXJIy+Ui5Z8cfeG04P0718IxszIrxkgNnDDvXFDm3kz1YYWzuafjHxN4n8e+O9T8e+Lrv7Rd6l5eV2427N3fPOd36e9YbogXMgLAegyfwGa7rwF8KfiB8UNXbRvAWnT6ncjGUhG7G7OM+mcHFfv38Fv+CUvgfwd4mPiP4zav/wmR+XEZXywTznne+O3r+FZ1cYo6HpQppI/Gf4HfsUftMftB3sdx8MfDEyaIwG/UtRP2OMZ/urhyx4PQjt61+6vwX/4JO/s+fD+ATfFpW8S6moU5LFVQ85AznrkflX6cRNk7vSrZVG7DOM++K4frjk7FOGh+C3/AAV6+JVjYeGfCP7PHhy6LRoyJdRL0UEDGT36HIr8xv2XfCV/4w+KOVQf2ZpVheahfk9o7Ziv9DVb9qX4o3Hxr/ao8YeNLOZpNJjuzb6cpHTYWDMPrkAfSv0C/ZS+GQ8Mf8E9/jF8YfL8v/hJdO1DDD/loeMD227se+fbn1MJPS7Odo/G5UN3aJOrbS3Uelf25fCOH7L8LvDOR10m1/k3+NfxL2+1YcjgbiB+PNf3Sx4wAoAAAAAGAB6AelcmZz7CLwlJRnA6Cvgn/go3+0bqf7PfwQe38JFF8Sa/CVsN/BAXAkKnsRuXB7Zr7H8b+O/C3w38L3PirxVP5FrbnDHrz6V/H7+1H8fdd/aX+LOo/EbUMpAWK2MTNlltD/q+QByfTtXNhIPdgeR+FtD8dePfE9n4a01ZtZ1LUCRvYnhTjJPXC1/Wl+xH+y/afsx/Ci38OXBWXUrlFNxKBg+pBr84P+CVH7G96b+L9pX4k2P7qJVfw8WGGC9Uf8jnpX78eXv5zivU2joAiorJwOaeIvbFOj71JXLKTuA1V206iioArMcAn0r8Yv8Agsd8OftvwM8PfFi3TB0LUwJgOCY3BKoT2HDdq/ZxmVVLN0FfPX7TnhXQ/iT+z54q8OyylMWpAbbu27s9sjPT1raK11Ez+Yf/AIJrfExfhx+1noeot/yDdWtxp8rE/KCxypP1B9q/roJB6DFfwreHNVfRJoNYaLzPMJ1JV3beAeEzg9f09K/uL0DWW1vTl1Dy/L3AnbnOAPfj+VeXmME1dFLc3aKKK8U2WwUUUUGoU1v7vrTqa3GDV07c2oH5lf8ABVvwXZ+If2P73WJRtl0a+sNQRgMsu3zAxH0HX61+Cf7JXjWy8CftSeA9f1HMpGqxAJu27vXnB9q/o9/4KCTrdfsgeNFccRoE/Bc/41/Ll8KSrfFnwhg/d1u0J/Mj+tfS4F6ETvZo/ty8eeDNF8eeD77wlraB4L6MxMSM4yOuM1/EJ8Wvhhqnwc+Kuu+Btcjkhv8ATbthHKDwYycrjt27fnX9zUZwjbucE1/P/wD8Fg/gtJDbeHvjzM3M5j0q52LnDJk7ic55HI47V01Kis0efNyTsfqR+y/8dtP/AGjPglovxKsj+9uF/frncUbA4JwOhyOgr6YfbIAufyr+dz/gj18aW8PePfEf7OWsXGwa6ZNU0tG5DBfQ8YyT7/jmv6GUTAHbHavExbcWmkCcm7M+af2i/wBj/wCC37RdiH8e2iSXZUgXwUC7B7ZcY3Ads1/NZ+09+wV8ZfgFMfE18Dq/h532f2lGxdYiegYbRjPPev68ZAMbj2zTUP2xdvSinmFnZo7adOy1P5Wv2Tv+Civj74AXMOgeJj/wkfh9AF8qM+XJFk8lScgn24zX9Rnwo+KPhH4s+CLPxr4KvUvrO6QEMvDIe6sOxFfg3+3T/wAEtodKs7r4mfsyaUZI9xm1DRYuAxPJeI4+Vep24PWvzc/Zm/ag+LP7L/j4eIPB0nk2isINT090/wBdGh+644wyc7T717VDEqS1OeS1P7V1UsMrzS7Gr5o/ZX/am+Gv7UPw3i8f+AZVEoVTfWIYH7HnPsPQ+ma+nfPik5XkV2LU5+W72P/R5SSXzwElHyHqPUV+gv7I3/BPP4qftFTx+J/EmdD8Bk4MrsQZvcDqfb619T/sB/8ABNu+1O8sfjJ+0Lp6xrEC2n6I/ER242n6JnrjnNf0FDjKtwa8XE42NrI+hR4t8IvhT4O+C/hG38DeB7f7Np9t/q064zXrjETIPaklgUnK8U+vBdV3ZstimY+P8/418vftlfG2y/Z//Zr8U+P5JPK1KNzp+nY4y5BIHfsDzivqlF/ir+eT/gst8SNSk8U+E/grYRm3EzEPbhtytlRjPAzjOa7cNdPY0krtH48aTouqaxqFvoeiqZ9QuMyBc4LHqT9ea/qn/ac8CaZ8If8Agm5rvw90Jt1vp2gmMHG3hhk8ZOPzr8f/APglT8HZfiP+0yvjYANH4QDSOhH384AAOeDlffNft7+3tF/xhn8Rk7JodxgZ6YxivVptpaGEpRufyWeCkZvEWilTz/almD+LV/cEMn8AWP0r+IPwIEHibSt56anZt+Ac5r+0f4leO9A+FPw/1n4j+K5fK0/SrZ/Nb0Jxj+Vc9a8pID8cv+Cvvx5sIbfTv2fNEcPK5F5qW05HmnAUfjg9+1fmP+xd8AU/aP8AjJbeAdVkA0x1xdKU3blOcc5XA4PrXhXj3x/qvxc+Iuq/EPxJJ5mo6vqJ1C4J6EnPH5V/TJ/wTZ/Zo0n4GfA5fEUcRh1TxW6Xt6P9qMEKfrlmrvowSjcOh+jeieHtO8PWCWFiMY6n1rbrOgEijDc/jV9W3Vo5rYViaPvUlRx96krje5AUZ7UV8c/tzfADXv2j/gNf/DvwzfGyvbg4jP8ACxPY/lxSA+viMjmmxxABlXA3Yzx6V+PH/BN79ry51+W8/Zv+MFwqeLNDBaQF+WUHBO3HHUdzX7ExyLzuIH41b2A/hy+N/gWT4WfHLxZ8MfK8oaTd+UqDsrDAA6+lf1O/8E9NbTU/2PPA5Mewiwjs+ufvfxdvTpX4B/8ABUDwGPCH7b3iiSGLampx6dqLHsZCzM3/AKCK/U7/AIIy6rJqfwD1zSJCWSw1qZowT91cA4HsM8fWsMTZ0J33A/YailOM8UlfNmgUUUHhSx4A71UYt7GgUxhkgU+mZy+PSrpL3jQ+Tv22ohB+yB8RzuHzaNO3pzxX8fAXoT2Of5j+tf2K/tuz6LH+yF8RP7Xzg6JOVx6cf/Wr+OVHIXcRxkCvoMInyMTd0z+9/OxCVFeHfHb4eW/xo+DniP4Wako+zatbPEeMkE8gj05Fe4q25SCOKzmix0GM0cz5jj5bn8S/g/W/FnwE+ONpdO7Wmt+DL8FX7sEJAz7denrX9mHw48ZaH8U/AWl/ELQ3H2fVoVnRR2DD07c5wPSv5if+CsvwN1H4UftGf8LBtnH2Px8++FQuNoQjcM5OSpf2r9Nf+CQPxXi8afAXUfAKqVfwreeQctk7ZQcdhgZUnFZ4unzRJiup+uDx44NRW8fl9O1fKv7a37Qdj+zV8AdW+JBz9vhwtptODu5yOh68dq/J7/gmz+3b488QfFGX4UfGC/GtnxJKJNNv7r/WHk5Jz6gjjNeRHCSUrnUnof0Gy4cgk1+Qn7ef7AcXxE+2fGb4XnyvEkWZCCuQVA6EZ5z+GPev2BLKWIGBgbiB2A7/AEqjdKJCCO1d1KTgrMzsfxu/s5ftI/E79lv4nD4gaDO8aCUQ6lZ4Ij3ISHyue/ev64fgH8bfBX7QHw0sPih4EuRLZX67lQnLqvYt9ecfSvx5/wCCmv7EumyJf/tK/D2EQwBQdasYl/1yjOGA9Rz9a+A/2Bf2uL/9mz4tQaXqWqtB4D1fL3kb5kVGU4XAyNpOTnntXq4fFpLUy5Uf/9L+4EEg5HUUBiKSivgZ1JNan0NmFFFNY7VLdcCsoP3izG8Qa/YeHdObUL5sAdB61/Fd8a/HU/xg+NPib4j3EjeXqd4zRqx4HJyR3+Y/0r+mH/gpV8W4Phl+zJPDcExnxNIdNDD0fnbj/a9fav5nvhD4Pb4r/Ffw/wCAUh837fdqCg74/wD119RgqSs2y2rqx/Sn/wAErPgdb/Cf9nj/AITi9tfJ1nxSwuJnP3tn8I7dMmvev25rFrz9jf4lRgZb+wrjHP0r600mBLDTEsSMiPvXiH7UWjR+Jf2cfHWkb9gm0S7XOM4+UHOMjOK7OWyOVw1P4uPDFzJF4jsHI2hbiJs/RhX7xf8ABXv4yvZ+F9G+CWjXRifUcXupIP4zgYH0J5/CvwatbyNpFaMANxgjtXpn7Q/xQ1P41fFnVvHN9KzJJKVh5Pyxg8Ad657LmLsezfsIfs4N+0H8crDQpzv07TZVu78gZBjU525zxnbiv6+gnIAr8hP+CP8A8FrfwL8FtQ+MF0gF/wCL0KFcYMaoScA5Ofvegr9cokKtyc1t9kvU1URdtSUijCA0tc7kxaFiiiimSFId2PlGT2FLRQB+Tf7ef/BP2y+NCH40fBlv7E+Iej4nV4PlEwXnDAY3bu9Yn7B37efiH4oeKpfgH+0Jp03/AAnqbZd5Hlo6chs57jAwf4vav10dQTv7+teWP8MfBrfED/hazaZbHxF9i+x/bfLXzMepOMmtbisfgz/wWd8PQ6P8ZvDfi9Iwn9raWilc7iGj4wT368V03/BF3XJbjxD8RbBhtD2Gm4Pusb/4mt7/AILTA3ehfDs4+a2kfnvhgox/46K8Q/4I63bQ/GvxOAMbtFb8cMP8K5a0HJNAlZWP6T6KKK+dZqFfOfxY/aQ8H/B/xF4X8P8Ai/8A1Piff5bbtuNm3J6HON49K+jK/nS/4LM+K9nxH8LfDYw+WNFsPMzuzxuHbHf69q7cNC6uaeR/REsiMdq8egNWVAHFfmN/wTX/AGlV+P3wR/sXVZAnibw9nzoy247ZO44GRx6V+kkN07KN4ye/1rTlszX1Pjf/AIKKauNF/Yx8d3Pk+cZLBtPA3Yxv/j6HP04+tfys/DDR/wC3Pil4Ps1byydfsRuxnAO/txX9G3/BXbWBY/snjTli8z7frVpGfmxj7+T09unFfzo/CbwH4y+IHxC07w58MTjxRLvOn8Z6Y3dx7V62FS5RJWR+/wB/wUV/bIvTqM/7IfwItn1rxLr8bWt20DgRxRPjdv8AlOAO5zX3/wDsffCzxZ8J/wBnHwx4C8Y3aXl5p9qsbMi7QD365/nXzd+xV/wTr8Lfs2aiPib4pmXVfHN6zSyXLfM+W+8MnO0DsBmv04HzgqTg1q4a3ZySkloj82f+CoPweh+Kv7Keq3KyC3vfDjC/t59u5kKdQB6Hoa/BX/gmN8Zdc+DX7UOl3S5XSdaJ07VUPQpIw/MqwyOa/sNaJWOT9a/h2+N/w88R/Av4s698Mdej2JYTkxMBgSI2cMPUEc9/rWbQKzP6gf8Ago74K07x1+yJ42S+Akh0/T3voiF3FgoyCp7eua/kvtoltVAyAAMD2Ff1VeDfincfGL/gnEPG+qyi4u7nw1dtO3q6yHBP45r+UW9ZWKI7bc9fXA61Dgt0Ur9T+vz9iv8Aaj8OftO/BO28Y2L+bqVor6bqJLZJ6YPbGcHH0r65QluvPpX8pH/BOX9pEfBD9oaw8NeI77y9A8YGPT1yvAwST39+PpX9Wy/KzL0xXnYtNLQEiTGO2K/kv/b7/Zlb9nz42tBo0WzwvqyA2LhcAMv3h1PNf1oM+FJ9K+RP24f2cl/aV/ZxvvD1kI49Vgb7Vp7t/DgHHrgPxnjjFc+HqNXuDZ//0/7gKKwNCux/YFocdQ3+f0rbjfzF3V+fn1fKSUH37jNNcblK+orm/HPivRfAXgvUPHfiGTyrLSrfdIfp0rTDxblczbP5qf8AgrN8a0+JPx9/4Vvo1wZdL8JQudoI2PcYAH4jnHNeqf8ABHv4RL4j+IPiD4pF0L+H4hHGjLnDuWwQc99p/L8vyP1PW77xZrF74v1xzLeavqL6g5br5bnhTX9AH7N/7TH7MX7E/wCzFpFhrWoJd+ItYVru7sbLBG88AeiqB35z+FfU0LKIPY/awKQprM1aNn0a5XuwAH4EGvwX1f8A4LQa19tNn8NvAUBs4s832peYx9CAv3e+c19O/CH/AIKrfs1+OrMv8RmHg/UZNomE4GxiM4G4Y3Yzwa3Ekz+YvUNM1LQL99Pvk27eh9a1/C2kah4y8SWHw90GPzdR1vUBYwD09W98emRmvYf2prbwhc/tBeJ1+H17p934fjuitj9gPCJySrDsMn5eT3r6X/4JgfDP/hKf2v8ATdemj32/hW0/tiRv7pJABzWBLP6hvh94I0v4b+CrDwPoUYS10u02IBwCUAyfxNd4YdvapvOWT+HqMfhU9aSWhLbICRgADGKSiiuRo5pc19AoooqiyxRRRQaBVaeJGQnpVmigD8SP+Cz22H4U+DQR11o/+gj/ABr4D/4JQP8A8ZVYjTP/ABJdQz/3wK/Qb/gtGFPwo8FhTnGtH/0Ee9fBn/BJQQr+1W3m/wDQFv8AH/fA96mTSV2B/UBRRRXzSepoFfyy/wDBWLxpH42/a0m05ZR/oGnfZC3XkdG7dcdK/p+8T+IdO8J6BceI9Wbbb22N5+tfxL/GDxpH8SfixrfjyQt5+oXBcljn5TnaK9bDQtEu2p9P/wDBN/4iXfwo/ac8PWtwDNpnikS6XeR5wCG27GYjtyfSv6yjB5bbTwfSv4XgrIo+YjBI/HuK/uC+Gfiyw+Ivw60j4hWPTVLcTE5zwAM+nTNU46mra6n4mf8ABaXWST8OfC8kX3ZtSvPMJ9MgLtx7DnP4V82f8ElNDN5+1sviRWwNM0S/BTGc+aYxnOexXGMc59q4f/gqB4+/4Tr9rLWLaKTzV0hFthjjGC3P4g198f8ABGTwok3hTxb4xLc740VOuTLvwc57AYxjnPtXpYRGTmran7tKu78Kkw3rTBkHApf3laSkrmLZYj71/Oz/AMFpfhnMfF3hX4qREB9TgSwlCrkluzE5/h+nf2r+iePrXwl/wUT+GEXxS/Zb8S6BAQNRss39mcZYYHQemDS6Er4j8P8A9kX42Xei/sb/ABs+BviPzJDa6FNd6aB0CuriRAPTIUjnvXyT+y58Pf8AhZ37Ufgzw0sW8S3u4t12A45x3/8ArV4K+rC5hKFQSy4PFfpP/wAEl/CJ8SftSW/iRpvL/sO0VvK2Z8wnd3yNuMZ6HNLlvozU+TP2rPgze/s+fGDU/h3FFiKH5bRcbRLYHgLjJwTg96/pd/YD+Px/aA+AWnX+oTfaNW0WKOx1GTuZ0Xkke4AOeBXyH/wV9/Z3bV/C2l/tD6LDmTw8x0+7CjJaPqrHn69vxr41/wCCUnxXXwt+0h/wgzSbf+Eq09Mw/wB4ox5z/s7v1rmxNCyEnc/ptoHA2joBgewpAyk4BzS14kotPQZ//9T+wH9mK4Grfs5eA788CTRLHHudn9a98XA718Af8E2Ne/tv9izwPqQj8tpJBuXO7A+uBX30kOwAZzXwU4tOzPrE9ycnAr8jP+CufxQOg/BvTPhXGrAeJblA7K2NyLjI/wDHh37/AJ/rmAXPHav5LP8Agox8bpPib+0rqkPhq4zp2jj7JD3XgnJHXr35ruwlJrVhbU+JVtXgxnv0qC4TOD1r7v8Ag5+z3Z+Jf2Sfin8edfG86H539mJt6eVn+LPbjtz618DiYt1r2IPYn2iTJgMcUhGRikLKv3iBTgc8iulPQi6IQ5jBcZOOw6193/8ABPP9rn4Qfsp/EHxL4i8e6RciDV7ORVbOMDcC3Y5xwO3WvhaiqH0sf2TfBT9s39nn4+6fHf8Aw916NPOGVXUcWhH1yWxX1Sk5YDI5r+DjKjluAOtfWvwQ/b+/ab+BWm/2D4b1t9U0QgBEviZJCF7byc4GT271KZlY/seUlRnsaPNXO3v9a/GT4Y/8FlvgtrGrQeGPiRo994dKqA8jjeA3chcDOfTPHvX6o6B4/wDCPxD04aj4MvbXUrY4y4G/GemRx1xWNkZ2O/opA+/5sYpN61mQWqKKKDQKhuF3xEVNRQB+J/8AwWUQP8KvB2Tn/idcf98//Wr4E/4JR2TXf7Vh2SbNmi6hnv1QV9N/8Fodbkgvvhn4daPl/wC0L0vu7ExnbjH05zXl3/BHGG6uPiv4zn2/Kmk7Qfc765sbf2Erbgf0aRy7CQRVtnVfvED61CYe5avMfjP8XPAPwQ+Ht38S/iC23TrLG9g2Oue/NeFQpycjQ/K7/grj+07D4T8EL+z7oEha71yF5LzYfuRjAXP5tX44/sYfAP8A4aM/aO0H4b38n+gGNtS1FNu4tHEQCOoxjP61wvx2+L2r/Hj4xa58WdUDRprEoeKJzyoXIJ9s5HHav6Lf+CYn7MWpfs8fCibxv4gIk8Q+JY98s23ZhOSg25OMbj+dfR0Ka5bMvW2h/OF8cPDLfDL40eMPhqZd/wDZOtXQC7du0Pt9z6etf0sfsH/F0aJ+wHZ/EHxYf9F8P2N7GRnG7a+7OccZ3Y79K/nv/bXimb9tb4pSyHcra1Jt7dM17/4l+PX9g/8ABOzSP2ewm3/hK7i9iL7uojCn7uD90+/O725upR5dUVUV4nwvrviHU/GPiPUvG2tuZ7jVIm1BnPJGSSB+Ga/sJ/Yj+DFr8E/2aPC3g9YRDf3CC+vT1JLAcE469MV/LL+xD8Go/jZ8f/D/AMMtSUTaZc+Y16vUNp2FAPt3r+1Dy0jjVIuBjoB09vpVU6nKrWOCbk5ETEFiV6Z4ptFFYubbKV+pbXIBI615v8S4dai+H+s3Oh2wvL5rSVdpbbuBHTpxxXpMfejBUHBrVaou5/CHrWmw6RfTaT4htf7I1gyP/oW7zcYPPz4X/wBBH6V/UN/wTY/Zil/Zx+B6+IvFtl5XiPxOfPnXqUGBj8yfSv0Cu/A3gu7P+k6RZPj1hU100CAY7+la2NGeZ/E3wNpfxP8Ah9q3gHXohLa6pbvEyt2cj5W/A1/FtqieOfgP8Ube4Qmy1nw1cgxkdntWO1u3ysG7fnX9y0sQJzX8vv8AwV7+EOqeFv2mpPHTKDZeJtODLIowqzNnr9Mde9TPVBfU/ot+E/jXRfiZ8MNE+ImjoEGpwB3UHowAB47ZOeDXfV+Pv/BIn4iTaz8Fta8IzuzPpV/wrDlVkzgfmp7V+vUczuoZhivOnFJgkf/V/oV/4JMa4br9mfUtJ8vaNH1yUBt2d5fHbHGMepzX6wwXnm9RX4T/APBHjWHu1+IPh4JgAabel89dgPy4/A85r92I41X5U4r5DFpRxUkj631PD/2mPjDH8C/gt4g+JhIT+zrOX5842tx7Gv4uJIstvJ5Ix+Vfvr/wWJ+NLx+EtI+AemSGNtQK6hqcYP3tgGAfYk5/Cvzy/wCCdfwv/wCFpftSaJFeR+bpukbr2977Y48V6VKCUUYTkrH9JX7PP7PWk/C39lfw/wDBPxHBBdsbGIXYkTIBHIwM8EZPevg74/f8Ejfgv4qiuNf+Fd4fDOpt83lKu6Fz9M8elfsUVY8mrceM7scitmcTk+Y/ju+KP7A/7XPwbsX1fXPCo1SwQnM+n5uwF9TgKRnnHB6V8gRyNINzLsPoO1f3tHOOK+JfjX+wh+zp8e9afxB4/wBBjh1Jclb2yAhkJPdsD5ug/KrN1Jn8gYBPTtSAZGR0r9kPj7/wSG+IuhadL4p+AXiE6zANzfYL0E8Dp0I7Z7V+R3xA+Hnjj4Ya2dD+Ien3ej3AYrtf5Dn+grWxoYBHY0qj5hQxyc/zpB8zbF5Pp3pALdxeeoUbf+BdKND1PxD4Q1FdW8N30djcDo9mdpOP73rUrDKkVlLAisSoApoaP1R+CH/BVX9oXwVqMNn49A8TafgK287JUX2POa/X/wCFH/BSr9l34g2UEXiPWG8LavLwdO1NQkynv37cdu9fygWreWMetP2ZPUfj0rIyP7x4+9PJAwCevAr+LX4Hftd/Hr9nLVoj4J1fdpkeALCVD/ZuB1yc9ce3Ff0OfsD/ALbUf7Usup+GfHdrbWPifRh9yNskAkg84XrgdqAP03ooFIGU5wc44/GswP5lf+CzXiMXnx+8OaOsPlnTtFkQMTnJDg/h1x+Hvx73/wAEZPBsQtvGnjrzARujsCmOhG45znnPPbjHvX5PftheKrb4k/tO+MfE8cpLzXzllH3VzxgflX9Dn/BK/wAETeCf2PNLWePa+qaheX8jH7zPLszn6YAFZtc2jF5H6KMqsNrDIPWv5cf+CkX7YDfG3xPP8G/Bk0g8K6VdiQk4w5HBHbrgHrX1J/wUj/bvW+gm+BvwR1oxuC8epahp1xnIOB5YIUY6HnPNfkV8Bfg34i/aF+MOj/B/w+QBqwkMj43bRHjnqPX1FXSw0YmnmfYP/BNj9lLRf2ivii+ta2om8K6GT+528MARxuz/ABEDtxiv6pZbYFgp5POAK8w+CXwt8MfA3wHZ/DnwTbrb6ZZLiMBcOWP3iT3JwKvfGf4q+Gfgl8Ltb+K3iR/Lj0qzkZCeBlsZ9fQV0RSSKbaP4/v2stRXW/2oviDq/eXW7nP/AAEgV8/mLeFkPIHQ49B/hVoQrvBm5BwG9cDj+VfoB+wJ+yFqH7SXj/8AtXxHZsPAtmfn81dvmKQSWySMDg+tJ67mkpxtY/UX/glJ+y9b/DH4V3Pxj1OEm78VErYMwKmLTVwAgXqNxGetfr6khNWXgD9T0pPI96xOVq4UUgZW6HNLWYy5H3qQ8daiQMQQpwT3r55+KX7TfwU+B0pX4teKLTTVOcBj83GO3HTIzzWyehLWp9D7Pf8Az+dQqpHT9f8AJr8Avir/AMFkpYZL1/gf4Ub5dq2+oaqBgddxXjLA+nFflZ8Tf2wP2p/iPo40Hxx4tvNS09juwrFAc+uD+laFpM/pt+Jv/BR39kb4TXIsPEHiqC+ugeU0zF0g+r5UYr8F/wBuT9vrS/2qbAeGbbQzpsmmXO6JiRucMBnIwPQY57mvzrguSycjr61XliUsG71LehSjY+//APgnD8XtW+Gn7T2hmMBJNZb+zNXJOAokOcYxklSD6V/WYIlU7QeR2r+FzwL4muPAuqad4htS0R0nUBftIp5C5HQdyMA1/bv4F8T/APCYeDNN8YGLaNRsVulfOcnA+XGB0yOe9ediovoB/9b9Cv8AglJe/wBnftWjTSvmfbNF1DnONvlquOO+c+o6V/THFJI3zMK/kR/YO1A2v7YngYOM7rpv6V/RJ+3/APHG0+CH7MWvahAyR6nqyrYWCuMgyy5wcd8V8pi4N4qTR9TU2P5xP22PjVbfHH9pnxJ46tcvYEPYW3qkUf3T9BzX7M/8Eb/hfa6B8GtU+LklqPO8S3O1ZT1McPLL9Muua/nX0jRbDW/E+m+ENJXyZtUhGnxLjdz3fHGSOOM81/cf8P8AwRofwl+H2j/DvQY1jtNJsfscCrx8nHP5+lehT+E8+o5XsjrtqnkDANOpqKyQhiCAAOTTqshJ3LknaoyM8VI/OB0r4c+Lv/BQn9mX4M2jNr2tf2rcpw0GjD7W34HKA1oarY+49igbV4x2rm9e0Dw/q4Q63ZRXfl52eYoO3OM4yDjOBn6V+EfxM/4LI3G17D4M+EtzLn/TtTO4kf8AfI9+K/M7xp+3b+1t4y1eXXbvxrf6XM+dx0pzaHHYDG4ADnHHc1tdbmqiz9Uv2wP2J/2DpbzULCfxbB8Kb9lEreUcAnJGVG4Dtg4A7V+AGt2tnoWt3Fxpd/FrEsuPL1CM5VgM8EgYY5PXAqzJff21MdWaPyjL/Du3Yx74H8qiuYg2MjOKV9TQjVty5p1IAAMClpAFFFFAEEqAgL29K+7v+CbXwuT4g/tX+H9SD4fQybxVIOGHHcEdwMV8LBlJxnNf0Bf8Edv2fPFOm2Ot/HDxha+Tpuq2q2dgrcMVBJI7Z2hhzjnPtVLsDlZH7plQ2cHrXyV+1p8bNP8A2f8A9n3xT4/SQCddOl+wSk/8v+NpI+m5T79K+rY8+tfzXf8ABVX9qzw98XPF+l/Cf4chkfw7exq4LZLSd12gcfd9TWd9CXe5+Qmgg3+pLayrtD4ya/WX9rb/AIKDwS+Frn9nf9mS7xoVpYnTTqa4Zhu4lAkBG4kgE4Ar8n4JVhfcgwVzyvNfTv7M37H/AMU/2nNU8/wl5VrojbSuoSHcDnPRMjPTruFYlHknwZ+D/jb44eNU8BeBbV7rUJkLqqLuGB13HsOetf1s/sr/ALNWh/swfCjT/Bmnyx3WsiNWub6MbVZuflxk/dyec85rb/Zv/Zl+Gv7MXgk+Cvh5Awa4Km9uzyLpee/ckHk19CeSa1J3LKsNpkx8w6/U15t8Vfh34P8AjN4Cvvhx47tftOnahgSLn+7XooQ96i8gg5HehyRUrWPxp0H/AII6fDXUPFya83im61XwyxV4o9/Lbc5XOTgHjNfrh4M8C+Ffhzow8O+EbJLO1Vy+F6ljgHJwM9PSu0tW2sKmljz8w/Gg4pTZErZ4PWn/ADfwKGPYHoa/Lv40/wDBWX9nj4Uah/Y/gOf/AISLU+QNibQuMeueK/JX44/8FWf2mvGmrzS/D69Tw5Zyk/u4081u2M4KZxRYtNvVn9OPjv4sfD/4XaDJrvxG1G20hIuofgmvys+KH/BZD4QaPEs/wh0W78VbSwJVRGpxjBBOcDr2r+dnxf4w1z4kap/wknj+8v8AV9SfO6e8fd/3yO3v61zgVVG1BgDpWdzWx9/fFP8A4KUftU/EG2e2t9aGkCQ8m0Xa2PQ9P6V8AjOOetTsN3Jpvl/5/wAmkMkIyMGlycbe1R+bGPvED61KoBYAkr7rwa0NCIxMOvH4UeUxG4dB7V0Oh+DPFfirVBpHgexudXuD1VTkLnp271+lnwV/4JXftHeNmjk8eIfCWRuO4+YVz7fJk+2aT2A/LHb8pUngjkV/WH/wTa8cnx3+yH4Zso5vOOjQmzZsdQMDPtnFfjb/AMFBf2SvBX7Ltv4K0jw/PLI+rJeSareyndulBVVZUzxnDEjdzn2r0D/gnT8cNP8AhJ+yR8ZNzfPo+6Yc4MmPMG3oduPXnr04rCUU3qI//9fgb/xLdaDcf25oDbbmzztP164r9a/+Covxsj+JN54W8CmLc2mWK6oku7I8zgAFccdOuTmvyQmVJWGQMVo70CAcLnj0zmvFcU3c+rlsfpr/AMEufgx/wsH9oV/HuFudO8LM2x2XAkkY/KcZOPu5xmv6RPiX8UfA/wAIfDMvjb4jXp0/Tbb/AFk+Mlfwr4T/AOCWnwQvvhH+y/pWt64gF/4mzqcgxhkEwGFPrgd8Cv59P2qP2p/ip+0D8Q9Xl1i42aPLerPp2nlNpWNS27c2SNzfLkY4xVHK43P33+Ln/BWj9mr4dTz+GPCgvvFV23G23ONv14OAa/PPxz/wV7/aB1+3up/h14ftfDCKR5fmKCwB7kADJ9q/Ifzy/UYx2phZ9uwMQPSgy5D1nx/8fvjf8WWa4+JniS61WVzuO4lUGewXJAFeVQlgSWOT61FUkfetCo7klIR196aJFzTgQa3R1xWhFAohTYh4H9auB0PQiofxC+5GQK2dM8JePPEWf+EX0nUNcx91bDT3JbPoQBnFJ2YudIzwCelJX278Nf8Agml+2H8T4nkudEk8KIAMf2iu1znOfl4wRj3r9K/hR/wRt8PwTKPjP4outbSMA5OQGJzkD5jtxx65o5R+0R/PvWrLpGoWn/H7Z3Sexg3D/wBCFf2F+AP2L/2YvhayDwJ4D0+IQf6s/wB38xXuOv8Aw48HeK40Xx5ZWutMoO7d7+npT5TDnSdj+an9hH9gDxb8cvFsHjP4y6X/AGX4d0yRXeJRh7gnlRyOV4PPav6iNL0Sy0PTV06wXaB1PrT42/Sr4cd6SkhTuVFj/CvxV+Nv/BIDw343+Il98QvBHif+x3vQpIuNxKbc9MEZ6+1fttvWqlyofBAzRzIFJs/KD4Gf8Em/2cPBcC6r42EPiy4bAy/KKRnnBz/kV+rFvANPXavI9aiQbDmrTHcMGsuZD9RWYnjtSJGh6ikqSPvSlJWBtWIgAOlJsWnUVzX1M2xqrtr8jP8Agq7+0TpHg/4Lw/B61/5CfishFO7AjZRkAjHIwTzkYx71+utfy8/8FcbA6F+09pvict5n2/RFi8vG3ZjbznnPXPQdK0Rgj8taTAzupA4Khuxp1amoMSww3NFFFBoFRypvTaf0p5OBmv0E/Yl/a0+C/wCz0tmnxB+HtlDHG+1vEKoCyY6F2x8uc+/Q0+Vj5WeV/Bz9gD9pf44yvfaH4Ylt9NIUx3moObVHBznaMOSRiv2G/Zv/AOCRPhD4epBrfx91P/hLboqC1nsITPOeCx3dR6YxX6h/C74ofDH4n6GninwHrMOoWM3KOpA6+2TXsCujBWTkDoapRHJvoeN/Cn4JfCv4H+Hl8K/CXRP7G0/j90o/u5xn6ZNevRqdmK0lfjmjy6LEc+lj8cv+CxOmvL8BND1/OP7K15CI/wDnpxwM9vyNfz16F8Q38OeAfGfh922weLFs3aIfwlFdQvvjHXA61/Sj/wAFc4o2/ZOZ1Oc6vY8j3kGa/lmvIIJSqEDpwPYVizSOx//Q84Bwc1658EvhifjF8VdC8AAbvtl0g2+uPyr9dfgB/wAE4fAfxB/ZF0XXPHiX2n+J9VUEPMehbt74/Cvev2Uv2F9J/Zh8d3nxBh8QR67qN1vw6j7u/wDE9P19sV5B9gqcmaP/AAVO1jxJoX7Ok+i6FCp0ZLy3F8V+Vd3zbSF5wDzxnjFfzbzXAnYOeo71/X78bvhR4b/aB+F2rfDLxOq7NRVSrP8Ad3Jng/XNfzT/ALRn7DHxg/Zz1q6tolGs+HEb/R9RXKgr3UDkPt9dwoMvYvsfKGFJ60bR613/AMM/gV8V/itcSr8PNHudQ2bc5XaPmzjnk9j2r9GPhv8A8ErPi1rYaPx3fWekuFUlWJdl3Z9wCf5fjSIVBs/Kny/8/wCTQYgw2k4B/wA+tf0SfC7/AIJX/s5/D9BP4y+2+KLs43PITtQrnhck9c+/SvtbRPhZ8NPBNz5vg3Q7fTIwPuqvI/E1rodFPBOR/Ml4H/Yq/as+IFzPH4d8G3lo0G0yLqw+xMN2ccYkOeDxX6FfCf8A4I+eNPEf2fXvGPiqDTRtyEhRicntncM/pX7ZwyjYBXT6Tqn2OUKRwa3N54RqOjPmn4Vf8E0v2WfhhaCKPR11i+YcvdYIcjuByAR+NfcMHh+w0og2ibD3FWrG58yESqMHsa1Gm3dqjmR4snaViNIsLg8VIEA4PNOoouXdtBUUgBwDUtRydql7EXYfc/GjzP8AP+RRJ2qOuZt3LJPM/wA/5FHmf5/yKjopXYEnmf5/yKPM/wA/5FR0UXYEnmf5/wAims26m0UXAKKKKQB16ED69K/O39un9izVf2utP0TTND12x0u70ckr53zF1IAIxkYBxz9K/RIjPBpLpFDrtGAPStDM/k8/aj/4Jz/HH4NsfEvhyYeKreXfny3KuoTGePm9fXtX50xS7s8V/e7HgrjgfXpXxr8Zv2Cf2bfjVqj+Itb0EWWrsMm/05Qm4+rEcP8AjjgYrVCbsfx74OM0lfph+0D/AMEufjt8I5JdX8HSnxZpiknz4tysB6FTnkfU1+Z496FubR3CkIBGCOKXHeiu2MVY64xVjovB/jvx58MtaXxN8N77+zr5MfMBw4HZhnBH19a/Zv8AZ3/4K9+LbeztNN/aE0jz5JCVa90+P5TjjJUk45PTP41+IinByeafcj5kbrt7Vm0Qf2+/C74z/Dj4t6PHrPgXWbfUElGQqMM/rXrwYYIccHrmv4OfBHj74hfDDxafGPw71E6ddnYCwBO4JngjIGOTX7Hfssf8Fcb3RZNO8FftGacsoGVk19cyP2xuXjqe2enesG9TncbnvH/BTf8AZz/a5+MSvH4EuV1nwamZZNBiLLlzgAoBuyQA3Ud6+Zf2L/8AgnT8UI/Htt4/+O2iS6Npllgo0o3/AH85wMjPQV/QD8OfjN8KPi3pUWp/D7X7XVIpl3ARsO/tkkH2r0aaFWXYRkHqO1Ia7I//0f7Er8Cz+y6Bb/8AHtYRCOMfTqf5VEoBUZq3qCESbm6mqiMCRGOp5ryNT9EjCPQk4EbZ6Vi6brehM7CO43E1txuBmvibx1a2/wAB/iHH8QzJ5dlqDqjYH8S5xn6ZNK4+RH3B9oQ8jpU7fL97iuSt7g6lGHU7RgH86+af2jC8fxM8HarGPlhcDPvwf6UDjST2R9eTByB5bFfcV866f8TNe/4SP/hFviBtiPXyx2/GvoGC88/hePevCfjL8MU8XeHVcKLq+TdkY2iTOPc4xj3rZG9CK6ntscaqoC8D3q2jYYEV5h8MrfxH/YKr4gyGXAUHr3zXpkSHPFavYyqWWh7loXOmxn1rXrK0JG/syPI7VpsxVcgZrjvqfIST5hSwHWlryH4ufFnwL8IPAuo/ED4g6gmnWOnpuJbq/Xgc9eK/mf8A2i/2o/iT+2t8SH8NaW403wK671URZfa/uGUkHb6itVsengctrYp/ulc/qM8GfEb4f/EWwXU/AmsW2pwsMgxNzj6V2xQDqa/jni+HfxA+GXiV/H3wR8S3ml6ouCymTKyBOx6Z7jp3r9D/AIIf8FevFej3MHg39pXSDC0R2fbo+VfPGSeO/tTsdeKyHFUEpOOh/QWy7qb5f+f8mvCfg1+0d8F/j7pY1L4QeILXW0dQyrA4LY9x2r3dGJHPWo5WeVKEou0kRUUrbQdoPNKy7aysyRtFFFIAooooAKKKKALFFFFaAFFFFAFR1LDggH36V8PfHX9gb9mT482UkfibQJLTUZCTJfaf0kPbOeDj0+tfclIqbUwvGK2juC3P5Uvjt/wTK+P3wLtmm0Qf8JVZDJMiMSyAduV/Hqa/O3nv1r+7KVAH+Y7R3Ir4A/aW/Y4/Z/8AjTdTXUVhFb+JiMpfrEGbJ65Axu7dT0FdCV0bwTeh/KWSByeKDtYeor7z+MX/AATa+NXw7gk8S+CvN8R6ZlsScggD2+b3r4BhLKOaOUtQZEVB5paKKkVmfof/AMEr9I8Ga7+2DY6obgPqOkWOoLZrs6xJ5XGe2OO1f1bK4PGK/lq/4JLaB4quP2iH8U6UynTNF04LqKN1xllVh+Z+ua/phXxYnQDp7UA1c//S/st8Q2km3ci14n8S9d1nw1oZ1nRIxJLDmvrbUNPjuIGXaMkV5TdaFPHK0m3cM15Fz7Wji7vU+XfBH7Q3hXxDOtlqaPptyeCkpBXPs2Bn8hXt/iPQ9P8AEtj/AGRqqeZby8snTNcp4s+FHgrxfGYdbsRJjJU5wVJ9K7uYuxBcYoO1TTK+m6cdOtUg37yqqu7GM7Rjpmvn/wDaOt1k0S1mf722Rc+w2mvpKpEthMQxotodMKsY6MzdMdmtI5XGCyg4/CtgsTj2qYWyRIEQcCo/K3fLn/P50jKVVIkRQfkT9K1NP0uViGZeKm0nSppJVkxkGvT7e3jgjUBelanm4rE9DZ0yFYLCNe+K4j4qfFDwJ8HfA178QviNeCy0uwAMspGcbvauwM2yPbj7pwfqK/lp/bG/aXvP21Pi23hrQIWb4f6TOFwRt34J575LY69sUonJhcK68vI8v+OXx0+KX7afxRHiDW0fTPCOju32Gy3ErcE/xt06Y9Oc12OiacmlrtiACjsOKu6foVppkCW9qBsQYAA7VeVTGcdc1reyP3jJMkWAo8jjqy/XN6voOl6nOr3cKO3qRzj610lK8DHBNWz2ZYVTVmj5+1H4DQW962oeAr1dDkbkeXGWAPqQGXP1r6X+H3/BQ39tX4EawkPxMtR410JML5hb94iDjhjkn1w351mRrtGMYp7p5kZXJX3BwaXKj5bNOEaGI96K1P1A+DH/AAVn/Zp+I1t9j8bMPDOocfupAFDE56Pntx1Hev0x8PeJ/C/i/SYtZ8K38d9byAENGQcZ7cE1/J7rXwv8JalCYJrYckEbRjH0rkNB8AfFD4c62da+Eni+70LnKx4dlU/g61jJHwOY8HYmm70lof2E0oVj0Ga/mW8H/wDBR/8AbU+FGpC28Z2kni9MbfNj6SKO7HnB/Cvv74cf8Fb/ANmPxdcH/hL5b3w2IztlNywG1z2xgA/XNYOOp8xicvxGHdqsD9ayCOtJXmfgX40fBb4lARfDrxTZ6vIVD7EkG7B/HrXpfPrT5GciTYtFKAD3pyoX+5lvoKnlZLaW5LRUbuYhmUEULIj9DVjTJKKKKACoZm2jNO8z/P8AkUxzvGKa3Fc5vVdT8mJkIwSK8YmmzcvNjBJ616T4rjOQVrz4xhDu6V0p6XPQwyRRuIi21emelfNPxt/ZJ+Dnx5El54xsQ2pN0u0wsmfcgAnt19K2/if8TNd8F/ErQ73UTnQbhmQx9CPM2jk+xFe5rIod9x7kflVHU4o/FfxN/wAEkdVgvVm8FeMVNuxbMWoRlig4wFIbnvngV5x4O/4JV/HLW9NN7498R6Fofl43rhjt698jd+lfvrMQSuP4uKIXXJGR8vpQZug+iPC/gj+zj8Pf2d9M/sb4eQCCBgFftlRnjvwe9e/RyEHipioPWsHRvEfh7xEZF0O5+0GLG/Axt3Zx+eDQY8jP/9P+5bYhGCKp3VhbuhOOver1IRkYrxz3oyaPPL7w2krHyxzjrXMN4W1YsSicV7AUyc05QVoOxYpnjZ8N6yDjyv1pw8Pa2vSL9a9x2LRsWmNYt9jymz8JXZKvcOPcV29voGmxoGEXzDvWz5HvVikZVK8pGXBaW8bZRcVaEeeE606vKvjZ8VfD/wAD/hfrXxV177ulWrlOdv3sZ5wfQdq3sRK7R+TH/BVH9q42dlD+zJ8NZRdXmsRn+2tjfKhJAZDwep9+MV+bngrwJB4J0CLTYXEkh+aVxxuY1zPheS8+L/xC1z42+LyZdW1mbeXfugJ2j9TXsy2xHO4AHoeopNn6lwdl1OhTVeb2Gwt8m1jjFP8AMQH74r37wz+zn481K98vV4Vsoe7Od38q+gNG/Zk8G2e1tWJuWHXA2j+ZrSx9jWzajFu09T4RjyzAJya6ix0PW9SA8q2Cj1JxX6R+HPhj4E8LzfadN09fM6ZY7v6V3ASOMbYlCjsBxQ5I82pxFVjsz83YPgv4/lxiz2Z/vHFbsX7PnxBlAx9lGexl5/8AQa/QcDI5pad0cc+KK+x8PSfsua7Igb7fjPpF/wDZmm237Kt8SrtrThu6smR/6FX3JubGM1GEAO6k2jjlxDXbu2fIh/ZcvjGFfVQw9AhB/PdxXn2qfsI+C75Plihjbu3IH6EYr9BgMDFMlG5CKVomFTO6zjZM/JzVP+CaizkNY+J0jA7feP5AgfpWPoPhT/gqt8BoWfwd4tXVdKt+YVXKBx3zkvj9a/WWWHEme1akEmIw2OlZpK58zWoRqS1R+Z3g/wD4K2ftLeCF+2fGPwPa6vbgKgNsx8xj3Ynbx9dp/wAfq/w//wAFmfgXqu99Q0HXNLZcYJAAOc9Bj+o9q7H4jfCLwx8VQ8XiNN3GIzjO3PU9favzu+Mf7L1n4b0t0j0Z42jOQ8ZyCvrn0o5UTHhmnidnqftZbfty/sma2w8z4iWKhOgI/ng19Haf4r8M6sGXw9qMOoeVjf5RztznGcZxnBr+R9/gzoEluVLMCR37VwMnwJs7eZprW4RSe8gOB+WaZs+Acya5qcbo/tCiuPMUHHWrVfxwxWXx70ZifCfji4iEn+sze3uTjp064zXH3/7RX7XvgKMaE3jzxDKq9ZWviv5Daf50rHLLgrNIvWnof2nU1uVOK/h2vvjh8ZtdKN4i8Xa7OUztUXu0DPXGEr7/AP8AgkV41/4Qf9oyTwW0m5fFdgsRXpkpuOf+A7unfNOx5eMyPEYRXraH9J3imKRyCgz0rzuRG6EV7hqUCvCwK5OK8l1WIwTElevNanPh6iW58sftP+FrTxF4AMs/ym0BZSOxOK7T4WazbeMPB1nPYnDRqEZT1BAxj9K9QliF8/zj7vSvFPgp4J174YyXX9txBhMVKgH+7nIPX1o9T0ITSZzfiTxXafEzw54h8KaCMz6exAzyJAhyfT24rb+AvjG18XeD2nlJ+32rFLgseoHANcl8NPC/iHR/iP4v0yC2Atkd/KBP3d/Xnv2rY8A/DvxF4X+L99Jp6iHwzcIZTEepPcZHqSKZ3Ll5T6Pjk4r5G/ZeuSNS161cYJlT9N2K+v8AywBheMV8ceAXbRf2mNY0TGBOTKfo/NFjCUVc/9T+5iiiivHPcLFFFFBoFFFFABRRRQBXr8A/+CznxtlbUvD/AOzppJbcSb/VgjcGDK4XpjIxkjOee3f9+ycCv5htEsdE/am/4KFeMfFuu/Po2jZUj727O76Yzt9+lbs9DAxvUv2PSPg/+zZmG2l1IB9LQEOSNvmn29q+4dB8LaD4ciW10i1SFF4yByfqa9Ku1E6gHtzWL5OGyBQz77DYrlpci2NGAsQCalIG4e9RxHCYAqU/3j2pzkrEzlfUXgCkyGGKH+7TY+9cbk7nK2ySiiitVNmIUUUU+Z9wCiiijmfcAx3oooqRWG/Mrblpjh5AQv3u31NS0YB60GkajifOnjT9n/wb4vMk9qE03VTksEG0N9T0P5V8MeNfh5rngaVRrEZUs5UHHBx3B71+sM8A3hyMn171k6voOk69aNZ6xCsqMCDuGePpTPby7OatBtLqfkQs4kUbTmuY8Y+CNM8ZaYbO++RsEq4GSP5V9hfFP4Bp4fgbxL4QVpbNiSy+nrgV89pH5bAnqDx71rax9vgc1WIjaWh+bvijQn0DV206RSu3pn0r3X9kDWDoH7Vfw71dk8zydat1x045wM9smt743+ETdQHWLaPayNk47jHNeHeAWjj8XaUWOGa+gVfx3Cg+c41oKWEukf3I3C72K9q5LxBpMVzbqE4YHOa7COHdEjZ/hH8qimt+QetaXPwvmkmeIzaPcQs2ExWQ8bH5Wr3uS0heMpt6jFcdP4SR3ZwcZNLmXc6qeKdzzUBwSR1PX8aQKw6V3cnhcgHAwfrn+tVR4S1R+UTIp8x6kcQuW7Zx+HpoiaNehxnP45zXbp4S1BWywFaqaFdqACgNO5Lxauf/1f7mKKKK8c9wsUUUUGgUUUUAFFFOX7w+tAHjvxt8Vaf8P/hT4n+Ieo/J/YunXrK2cdFBx364FfgL/wAEyNFYeC9Y1AEBYrvaR6/exX7Af8FCVZf2TviVMOE/sScn/vk1+an/AATzYj9na3x3v7o/qK3Z6uW6an3sTkkimkAkE9qar7jin1EpKx9ZDYaxx3xTA2Ce9LJ2qOuVyZpcUnJzSUUVIixRRRWhmV6KKK0AKKKKACiiigAooooAKDyCKKKAIQMrsHQcgdq8F+IHwY0DxJcS+JrSEDVtpxIe/tivoEEjpTFQk4zQehhcwlQ1R+Q/i/QI7iCfRb9dr5ZDnsw4r4HfQrzQ/i14f0pQR/xOrYEf7JY1/QT8X/hNY+O9LFzaosd9bfMjqMFh6E9xx+Ffkf4U8PC6/wCCgvgfw6X2Y12y56gc9cZ5rax2Z1mqrZfee5/XdF/qk/3R/KnEA9abH/q1+gpxBPQ4qZH5E/QgpR70lFYtu5Am1M7gMU4Ed6Sildj5mKDilyvpTaKOZj5mf//W/uYooorxz3CxRRRQaBRRRQAUUUUAfH37ftl9s/Yo+J0w+8uiT/8AoJr8uP8AgnkwP7O1sy8/6fdfoRX7h/FLw/J4x+Hes+DRjZqVs8RB9e1fzr/8EudSM/hnxD4VKf6rUC3mZ92GMY9uua2nsejgna5+q6fIv1p3mf5/yKH5ANR1xtu59ktgoooqRhRRRQBYooorQAooorQAooooAKKKKACiiigAooooAKKKMgdaAGA7mOPSvzf/AGSoT8Rf+CoPiDxYD9lFkb5vJ+/n7v8AF8uMdenevub4nfEOP4Q/D7WviU0wt/7MspSHPYvj/Cvn/wD4Iv8Awyl0XwN4l+LkcYjOs3rWZYjJlWBmJIOeMbumOc+3O9zxc3rtQ5Ez9xaKQEEZFLU3ifL6FiiiisiQooooAKKKTcobZn5vTvQB/9f+5iiiivHPcLFFFFBoFFFFABUcnapKjk7UAV5I/MxzX8ynjWSX9kT/AIKL6hPayFPDHiwBo2xyy3qq75PuRkZzjB9eP6b6/Jr/AIKqfs1j4p/BFPiN4bTZqfhMLImxeSh64+hAPQ/rW09jtws+Wep7EcDGT0JFPr5B/Y9+NA+MXwjga/k3appx2XIJ+Zs4Gce2K+tYsbGkBwo6k1xtXZ9dRqxcSCiiipOkKKKKALFFFFaAFFFFaAFFFFABRRRQAUUUUAFFFFABURYc4NPfhDWMRIMvzj1oMqzSiz83v+ClXxGceDdN+EPhSbN34j43/wB37v8AD3xnpkV+5X7KXwmj+CP7PXhX4WxqFGkWSR4HQEgE1+GX7IvgaP8AbJ/bRuv2irlHufCnhEI8KMuImkHIRT6jgnHqK/pRhVUXavQYArSWx8jmVbmlYq0UUVzO55wUUUUwLFFFHfHetAGuXCEx/exx9a+Qf2uP2p/DP7MXw9g1y/cf8JLqaN9hjDYyVI68HAPPOO1fUfiLxPoHhLT21bxHcfZrder4zX8iv7Z37Xl/+1d8SoteDO/hfS5MaZaOMFdh4fOe/p7UyWrn/9D+5iiiivHPcLFFFFBoFFFFABRRRQBXpGICnccAcmlpDjHzHA9a6DQ/mx/al+DXjD9g3402fxr+DlnLJ4NvHeV4k/gLtl89cjGBzzxX2n8GPjn4S+NPhmLXdAlUkqGvLDcGliP14zj6Cv1S8UeEfDnjzw7d+GfEtol5pl6mwhh+GR6EV/Oz+01+x18Qf2M/ihL8ePgG8h8PzSBri2UFwqEklW6cDscVzyj1PSwmMalZn6fhkbmMYXsD6UtfNnwN/aZ8GfGbfpsET6bqkagyWlwQHGfTofzFfS5jYIZNp2r1PpWLR9LSxEHHVkdFOXa33TTvL/z/AJNKzN1JPYkooorSxQUVH5n+f8ijzP8AP+RViuiSiiigYUUUUAFFFFABRkDrTWbbSogfhxnPB7cGgic1FXY3HmAMvIr8zP25fjpqMULfAv4byNNq9+wjdoR5g3dAMcdP1z7V9PftN/tBWv7OtlFHFvOrMxWzs0++X4+vrye1cX/wTb/ZFvdY1H/hsD4tSSvq+ssslmi/KVjGSd2c88ig8LMMercqP0V/Yt/Z1sP2a/gZp3w7MYTUZmN9f8YJebBAPr09BX2PB3rFikVsuo61qRS7c8Vqz5arVcpajaKKKxsMsUDkbhyPWggHKn6GuX8VeKNE8E6NNr3iPUotL02AfM8gzjPpyKots6Z/unr07da+Tfj7+2P8DP2d7MQ+ONTVdTYlBZKNt9xj+Lnjn+7X5FftU/8ABXjX3W68P/s1SSf2DATjxCxC7gcfcOCTjBr8cvEmv+JvEXiXUPFnivUn1TU9VcP842hQueByePmouK19z6L/AGqP2vPjp+1JdxWt47DSHvo1srEnBwCd2XHr8uRivlVrZogFPI7VNbyvE37xcE/pWizbqRR//9H+5jIoyD0r5q+C37UHwa/aGsxB4D1qJWG3/iXyjF/82cZOeOh7V9FquwbRnA6Zrxz2zSopodG+6QadQahRRRQAUVH5n+f8ijzP8/5FOzAkoqPzP8/5FHmf5/yKLMCMcLtHQdqCAeG6UUVXKyrM/ID9pL/glZ4T8YXr+Pf2f9Rfwn4lhJeCaIn5TxxkEZ6V8NN+1P8AHn9l7U18EftQ6Rew28jfKSoHyr1YdeuR1Ir+mTGeMge56VxPjzwd4E8eaDL4Z8f6fYazYzAhoZyGx7jIOD/hS9nc3jiqkdD8t/hp+0J8Hfijp8d94d1qLfKMiFsBwfQjIr2wzLLzHyK+efjZ/wAEgvg542t/+Eg+Bl7J4S1qDcySRPuR+nDEY4GPTvXyLqngP/gp18A7W5e+nm8X6UCAyRg3oCL3BypHft+FLk8j2sJmF9GfqMUA5JpTEw5P8q/LTw9/wUustGtRpnxZ8LrpF7EdjZBXa3ocrkdRX0Xof7cH7PN/+91jXBpKbVbdfOFXLdhgdq05Udqx0WfYdFcpovjnwdr/AJp07VLV/KxuxJ03Zx2HpXUqxJIPOO9WdCxEerBW3U6mhcdDS4Pr/n8qx5X2N/bQW7FJA5NR+bH/AHhTm3YyME+/SuQ13xp8PdBK/wDCZa5p2mrzuDnGMfjzRysbrQW7OwBDDcvINLXwr41/b2/Z58G3LWfh+Q6vcuTldOTLnb0356da+TfEv/BRL4q+MceEvhJoGFlJCKzNeX2O2CSMY5zipOapmFCK+LU/YjVdW0vQtNk1LU5NmzoPWvzt+LX7e2lw7vDnwYYXWqnP7zft29O2057964XwN/wTs/bH/aXnk8RfFq5j0TTBtb/iaMd7B85wF4BGOQCe1fsJ+yx+wH+zx+zRYw3uh6cmr+IIlA/tO7/euCM9CRz9eKdj5/HZspe7A/PP9k3/AIJ2eO/ip43m+PH7YscjLJIJINPfIJAJIUZ/hOeeO1fu/JH0q2ItvB7Ug2nvSPFqVpTd2VFXbV6PvSiIkgDqf8+teXfFP40fC74GeH/7e+K2uWulA5+TfuPy4zzgeo7Vra5zHqpBBweorn/FXi7wn4D8O3HivxpfCwsLbG+XGcZr8Jfjj/wWhhN0+gfs6aG8rwFg2o6pEMSAkY298Dn659q/HH4u/tC/HX42a8uufFbXP7U4ICCLYBuxnncfQdqZvqz9zPjZ/wAFk/Amiai3hr4H6GuvTDOL28G1h0xxg+/evxE+K3xq+K/xz10698WNSGokbsIF243Yz3PXA/KvE4m2/d4xX6J/s6/8E2/iL8X/AAJB8ZviTe/8I14eAy0T5eVs54IBXH/16v2cmaJJH5+QQpGDGvTtSlGEgkfkjp/nNaHiFdHh8SXMfh5CllG2yME56dT719y/8E+fgF4e/aC/aK0nSfFdsLjSdJBvLtD0KAZFL2bGz7e/YM/4Ji6Lq9tafFb9pm2BXAay0UoRHGF+4SM84z6Cvvn9uj9k34V/GH9n3USdEtLe/wDDllu06bAVUVB8sfA6N3PtX6PwWSQrt4wOAMcAD0r41/bw+JZ+D37I/jXxRbNuuBZ/YI/4cHkFuh9en60cjsZ893of/9LufiV+zl+0V+zxqcX/AAmmgXujfaN5gvfL8wfu8bvlyOm4fxd6+2P2dv8Agpb8evhpFbaB4zB8UaZFhMytslRfYncfwJr+onxH4Z8PeLdIl0TxRZQ6hZygh4bhBIjfUGvww/4KL/sVfs7eA/hfqPxS8EaEmk6xN+8aS2O1cpuwNuDx6ivIase2mfcfwM/4KG/s0fG/UB4e8PX/APZmtEDFheMElyeuR27etfdsUhdcsMEda/gmlRPLJKg4HcZ6V7p8F/20v2mvBuoxabovi29EJOAJH8wqBkAAnnHU/U0JXZqj+2UyqOvH40MdwBFfG37Hnxz8cfHD4PWPjbx99nmv7g7XaKPYpwAc4yQDzX2FFygbGM1pKHKBY+5+NHmf5/yKJO1R1vGKsBJ5f+f8mjy/8/5NSUVlZAR+X/n/ACaPL/z/AJNSUUWQEfl/5/yaPL/z/k1JRRZARGPvSBG5I4P51NRTHfoedeM/h/4H8bWP2Dxnoun6qH+8LtVP5ZU4r4q8ff8ABMf9kT4gFmk8FppO4g5027eLGD/D6V+i7RxscsoP1FOAAGBVcw1Nn4h3v/BFL4dSKp03xhqcJ7g5/wDi68utv+CQ3x80Uk6P8VZQWxk5fn6/MDxX9B1UX++frSuX7ae1z+d0f8Exv284lxB8SNLXHTN/ek/ogql/w7c/4KJZKR/FLS8D0vr3P6rX9EZ+8Ks3AB259KbSH9Yna1z+eOT/AIJJ/tU6kw/tj4tQrn0Rz/7Ur0rw1/wRP8FxxSf8Jv471W4dwu3apZVPOefM5zx2HSv3ZtfumruAVBPXmlZClXm1Zs/MHwL/AMEqf2TPCzRNLZXmo+TnC3l84jbPqqgZ/E198eBPhl8Ovhfp8WkfD7RLDSII12gWcQQ49z1Nd+kcZLZUH8Kr7VVhtGKknd6muGLxYPas0RAMWXvzVmH7tfzzf8FOP2/f2iv2f/Fms+D/AIY3lpZWKjhTBuPHvu96T2MbK9j99/EPiHQPCumtqniK5+zW69Xxn9M1+cPxj/4Kk/sp/Ci2a50PWf8AhKWUnclgM59NpOd3v6V/L9ffEXxv8Xdfg1P4g6nPqMq7iN7cZPXj8BVGVQkjKOgJFImx+k3xv/4KwftHeLxGPC5sPCmnrv8AM8tueduMnaN2MH0xmvzF1vW/EWr3W68uN/mNnjKjn8TgVqydqyLtVEZkIyVBP5UXGb+l+GPEWt67/wAI74bt/tk+AQuduc+/NfpR8IP+CSX7Q3xQukX4jRf8I3p2AWfzCxP0A25IxXzD+zJ+3B8ZPgHpYh+GdvpNkqEKM2m7hc/7Q9TVTxV+2d+1Z4s1h7zV/H2s5bJCR3BRFz2ULjArSl8QtT+jrQf2eP2Hv2INKX4j61p9hpWp26kLq9/h5iq4zjI7ZHSvyc/bw/4KLWHxg8NTfBn4Yacq6IznzLgxeWsi+ijOQDzmvyfkmknYPLjPsAP0AAqC5GUUV6sYrlNbGakpYciv29/4IwS/8V942A/589O7+pGf1zX4hqMnFe5/s7fE7xh8Ivjr4Z8UeCLn7PdyXPkMSMqUcDII46YGK55RSA/uJibbmv5Y/wDgp1+1vpnxn8e/8KR8Gu/9geF5AknPyyk8ED2O336Vl/tuftzftB+LDYeCm1CHTrHULRftIsYjE0m3GMncf7x6etflrH3rFxREYW1P/9k="/><div class="loading-image-dot"></div><div id="loading-percentage">0%</div></div></div><script>if (GLOBAL_CONFIG.preloader.source == "2" || GLOBAL_CONFIG.preloader.source == "3") {
  const loadingPercentage = document.getElementById("loading-percentage");
  let loadingPercentageTimer = setInterval(function() {
    var progressBar = document.querySelector(".pace-progress");
    if (!progressBar) return
    var currentValue = progressBar.getAttribute("data-progress-text");
    if (currentValue !== loadingPercentage.textContent) {
      loadingPercentage.textContent = currentValue;
      if (currentValue === "100%") {
        clearInterval(loadingPercentageTimer);
      }
    }
  }, 100);
}

const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div id="web_box"><div id="web_container"><div id="menu-mask"></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">ç½‘é¡µ</div><div class="back-menu-list"><a class="back-menu-item" href="https://www.houyanbin.com/" title="åšå®¢" target="_blank"><img class="back-menu-item-icon" src="/img/favicon.png" alt="åšå®¢"/><span class="back-menu-item-text">åšå®¢</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">é¡¹ç›®</div><div class="back-menu-list"><a class="back-menu-item" href="https://image.anheyu.com/" title="å®‰çŸ¥é±¼å›¾åºŠ" target="_blank"><img class="back-menu-item-icon" src="https://image.anheyu.com/favicon.ico" alt="å®‰çŸ¥é±¼å›¾åºŠ"/><span class="back-menu-item-text">å®‰çŸ¥é±¼å›¾åºŠ</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">Jackhou Blog</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><span> æ–‡ç« </span></a><ul class="menus_item_child" style="left:-79px;"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> éš§é“</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> åˆ†ç±»</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> æ ‡ç­¾</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><span> å‹é“¾</span></a><ul class="menus_item_child" style="left:-31px;"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> å‹äººå¸</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> ç•™è¨€æ¿</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><span> æˆ‘çš„</span></a><ul class="menus_item_child" style="left:-79px;"><li><a class="site-page child faa-parent animated-hover" href="/music/?id=8868465080&amp;server=tencent&amp;type=0"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> éŸ³ä¹é¦†</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/bangumis/"><i class="anzhiyufont anzhiyu-icon-bilibili faa-tada" style="font-size: 0.9em;"></i><span> è¿½ç•ªé¡µ</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> ç›¸å†Œé›†</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><span> å…³äº</span></a><ul class="menus_item_child" style="left:-79px;"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> å…³äºæœ¬äºº</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> é—²è¨€ç¢è¯­</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> éšä¾¿é€›é€›</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button only-home" id="travellings_button" title="éšæœºå‰å¾€ä¸€ä¸ªå¼€å¾€é¡¹ç›®ç½‘ç«™"><a class="site-page" onclick="anzhiyu.totraveling()" title="éšæœºå‰å¾€ä¸€ä¸ªå¼€å¾€é¡¹ç›®ç½‘ç«™" href="javascript:void(0);" rel="external nofollow" data-pjax-state="external"><i class="anzhiyufont anzhiyu-icon-train"></i></a></div><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="éšæœºå‰å¾€ä¸€ä¸ªæ–‡ç« " href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="æœç´¢ğŸ”" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> æœç´¢</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="ä¸­æ§å°" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/index/wechat.jpg" target="_blank"><img class="post-qr-code-img" alt="wechat" src="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/index/wechat.jpg"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/index/alipay.jpg" target="_blank"><img class="post-qr-code-img" alt="alipay" src="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/index/alipay.jpg"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">äº’åŠ¨</div><span class="author-content-item-title"> <span>æœ€æ–°è¯„è®º</span></span></div><div class="aside-list"><span>æ­£åœ¨åŠ è½½ä¸­...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">å…´è¶£ç‚¹</div><span class="author-content-item-title">å¯»æ‰¾ä½ æ„Ÿå…´è¶£çš„é¢†åŸŸ</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/Article/" style="font-size: 1.05rem; color: rgb(132, 188, 48);">Article<sup>4</sup></a><a href="/tags/CSRF/" style="font-size: 1.05rem; color: rgb(57, 189, 33);">CSRF<sup>1</sup></a><a href="/tags/Git/" style="font-size: 1.05rem; color: rgb(129, 146, 85);">Git<sup>1</sup></a><a href="/tags/Java/" style="font-size: 1.05rem; color: rgb(73, 63, 18);">Java<sup>3</sup></a><a href="/tags/JavaScript/" style="font-size: 1.05rem; color: rgb(187, 124, 58);">JavaScript<sup>17</sup></a><a href="/tags/Linux/" style="font-size: 1.05rem; color: rgb(165, 164, 3);">Linux<sup>1</sup></a><a href="/tags/Pikachu/" style="font-size: 1.05rem; color: rgb(91, 37, 117);">Pikachu<sup>1</sup></a><a href="/tags/SQL/" style="font-size: 1.05rem; color: rgb(127, 47, 60);">SQL<sup>2</sup></a><a href="/tags/XAUUSD/" style="font-size: 1.05rem; color: rgb(104, 112, 104);">XAUUSD<sup>1</sup></a><a href="/tags/XSS/" style="font-size: 1.05rem; color: rgb(21, 110, 199);">XSS<sup>2</sup></a><a href="/tags/%E3%80%8AJavaScript%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E3%80%8B/" style="font-size: 1.05rem; color: rgb(185, 114, 113);">ã€ŠJavaScriptæƒå¨æŒ‡å—ã€‹<sup>17</sup></a><a href="/tags/%E5%8C%BF%E5%90%8D/" style="font-size: 1.05rem; color: rgb(41, 132, 193);">åŒ¿å<sup>4</sup></a><a href="/tags/%E5%8D%9A%E5%AE%A2/" style="font-size: 1.05rem; color: rgb(178, 18, 142);">åšå®¢<sup>10</sup></a><a href="/tags/%E5%AE%89%E5%85%A8/" style="font-size: 1.05rem; color: rgb(166, 117, 175);">å®‰å…¨<sup>20</sup></a><a href="/tags/%E6%94%AF%E4%BB%98/" style="font-size: 1.05rem; color: rgb(36, 19, 42);">æ”¯ä»˜<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2/" style="font-size: 1.05rem; color: rgb(128, 115, 58);">æ”»é˜²<sup>1</sup></a><a href="/tags/%E6%97%85%E8%A1%8C/" style="font-size: 1.05rem; color: rgb(47, 161, 51);">æ—…è¡Œ<sup>1</sup></a><a href="/tags/%E8%99%9A%E6%8B%9F%E6%9C%BA/" style="font-size: 1.05rem; color: rgb(29, 106, 127);">è™šæ‹Ÿæœº<sup>4</sup></a><a href="/tags/%E8%B6%8A%E6%9D%83/" style="font-size: 1.05rem; color: rgb(39, 164, 35);">è¶Šæƒ<sup>2</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>æ–‡ç« </span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>å½’æ¡£</span></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/09/"><span class="card-archive-list-date">ä¹æœˆ 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>ç¯‡</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/08/"><span class="card-archive-list-date">å…«æœˆ 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>ç¯‡</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/07/"><span class="card-archive-list-date">ä¸ƒæœˆ 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>ç¯‡</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/06/"><span class="card-archive-list-date">å…­æœˆ 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>ç¯‡</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/05/"><span class="card-archive-list-date">äº”æœˆ 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>ç¯‡</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/04/"><span class="card-archive-list-date">å››æœˆ 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">37</span><span>ç¯‡</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/03/"><span class="card-archive-list-date">ä¸‰æœˆ 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>ç¯‡</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" onclick="anzhiyu.switchDarkMode()" title="æ˜¾ç¤ºæ¨¡å¼åˆ‡æ¢" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="è¾¹æ æ˜¾ç¤ºæ§åˆ¶"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item on" id="consoleCommentBarrage" onclick="anzhiyu.switchCommentBarrage()" title="çƒ­è¯„å¼€å…³"><a class="commentBarrage"><i class="anzhiyufont anzhiyu-icon-message"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="éŸ³ä¹å¼€å…³"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">åŸåˆ›</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF/">æŠ€æœ¯</a><i class="anzhiyufont anzhiyu-icon-angle-right post-meta-separator"></i><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF/JavaScript/">JavaScript</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/%E3%80%8AJavaScript%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E3%80%8B/" tabindex="-1"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>ã€ŠJavaScriptæƒå¨æŒ‡å—ã€‹</span></a><a class="article-meta__tags" href="/tags/JavaScript/" tabindex="-1"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>JavaScript</span></a></span></div></div><h1 class="post-title">ç¬¬15ç«  Web æµè§ˆå™¨ä¸­çš„ JavaScript</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2023-04-25T16:00:46.000Z" title="å‘è¡¨äº 2023-04-26 00:00:46">2023-04-26</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2023-04-26T13:46:16.000Z" title="æ›´æ–°äº 2023-04-26 21:46:16">2023-04-26</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="ç¬¬15ç«  Web æµè§ˆå™¨ä¸­çš„ JavaScript"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="é˜…è¯»é‡">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="ä½œè€…IPå±åœ°ä¸ºåŒ—äº¬"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>åŒ—äº¬</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/post/default_cover5.jpg"></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><meta name="referrer" content="no-referrer"/>



<p>The JavaScript language was created in 1994 with the express purpose of enabling dynamic behavior in the documents displayed by web browsers. The language has evolved significantly since then, and at the same time, the scope and capabilities of the web platform have grown explosively. Today, JavaScript programmers can think of the web as a full-featured platform for application development. Web browsers specialize in the display of formatted text and images, but, like native operating systems, browsers also provide other services, including graphics, video, audio, networking, storage, and threading. JavaScript is the language that enables web applications to use the services provided by the web platform, and this chapter demonstrates how you can use the most important of these services.</p>
<blockquote>
<p>JavaScriptè¯­è¨€åˆ›å»ºäº1994å¹´ï¼Œå…¶ä¸»è¦ç›®çš„æ˜¯åœ¨webæµè§ˆå™¨æ˜¾ç¤ºçš„æ–‡æ¡£ä¸­å¯ç”¨åŠ¨æ€è¡Œä¸ºã€‚ä»é‚£æ—¶èµ·ï¼Œè¯¥è¯­è¨€å·²ç»å‘ç”Ÿäº†æ˜¾è‘—çš„å‘å±•ï¼ŒåŒæ—¶ï¼Œwebå¹³å°çš„èŒƒå›´å’ŒåŠŸèƒ½ä¹Ÿçˆ†ç‚¸å¼åœ°å¢é•¿ã€‚å¦‚ä»Šï¼ŒJavaScriptç¨‹åºå‘˜å¯ä»¥å°†webçœ‹ä½œæ˜¯åº”ç”¨ç¨‹åºå¼€å‘çš„åŠŸèƒ½é½å…¨çš„å¹³å°ã€‚Webæµè§ˆå™¨ä¸“é—¨ç”¨äºæ˜¾ç¤ºæ ¼å¼åŒ–çš„æ–‡æœ¬å’Œå›¾åƒï¼Œä½†æ˜¯ï¼Œä¸æœ¬æœºæ“ä½œç³»ç»Ÿä¸€æ ·ï¼Œæµè§ˆå™¨ä¹Ÿæä¾›å…¶ä»–æœåŠ¡ï¼ŒåŒ…æ‹¬å›¾å½¢ã€è§†é¢‘ã€éŸ³é¢‘ã€ç½‘ç»œã€å­˜å‚¨å’Œçº¿ç¨‹å¤„ç†ã€‚JavaScriptæ˜¯ä¸€ç§ä½¿webåº”ç”¨ç¨‹åºèƒ½å¤Ÿä½¿ç”¨webå¹³å°æä¾›çš„æœåŠ¡çš„è¯­è¨€ï¼Œæœ¬ç« å°†æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨è¿™äº›æœåŠ¡ä¸­æœ€é‡è¦çš„ä¸€ç§ã€‚</p>
</blockquote>
<p>The chapter begins with the web platformâ€™s programming model, explaining how scripts are embedded within HTML pages (Â§15.1) and how JavaScript code is triggered asynchronously by events (Â§15.2). The sections that follow this introductory material document the core JavaScript APIs that enable your web applications to:</p>
<blockquote>
<p>æœ¬ç« ä»webå¹³å°çš„ç¼–ç¨‹æ¨¡å‹å¼€å§‹ï¼Œè¯´æ˜äº†è„šæœ¬æ˜¯å¦‚ä½•åµŒå…¥åˆ°HTMLé¡µé¢ä¸­çš„(Â§15.1)ï¼Œä»¥åŠJavaScriptä»£ç æ˜¯å¦‚ä½•è¢«äº‹ä»¶å¼‚æ­¥è§¦å‘çš„(Â§15.2)ã€‚æ¥ä¸‹æ¥çš„ç« èŠ‚ä»‹ç»äº†æ ¸å¿ƒJavaScript apiï¼Œä½¿æ‚¨çš„webåº”ç”¨ç¨‹åº:</p>
</blockquote>
<ul>
<li>Control document content (Â§15.3) and style (Â§15.4)</li>
<li>Determine the on-screen position of document elements (Â§15.5)</li>
<li>Create reusable user interface components (Â§15.6)</li>
<li>Draw graphics (Â§15.7 and Â§15.8)</li>
<li>Play and generate sounds (Â§15.9)</li>
<li>Manage browser navigation and history (Â§15.10)</li>
<li>Exchange data over the network (Â§15.11)</li>
<li>Store data on the userâ€™s computer (Â§15.12)</li>
<li>Perform concurrent computation with threads (Â§15.13)</li>
</ul>
<hr>
<blockquote>
<ul>
<li>æ§åˆ¶æ–‡ä»¶å†…å®¹(Â§15.3)å’Œæ ·å¼(Â§15.4)</li>
<li>ç¡®å®šæ–‡æ¡£å…ƒç´ åœ¨å±å¹•ä¸Šçš„ä½ç½®(Â§15.5)</li>
<li>åˆ›å»ºå¯é‡ç”¨çš„ç”¨æˆ·ç•Œé¢ç»„ä»¶(Â§15.6)</li>
<li>ç»˜åˆ¶å›¾å½¢(Â§15.7å’ŒÂ§15.8)</li>
<li>æ’­æ”¾å’Œç”Ÿæˆå£°éŸ³(Â§15.9)</li>
<li>ç®¡ç†æµè§ˆå™¨å¯¼èˆªå’Œå†å²è®°å½•(Â§15.10)</li>
<li>é€šè¿‡ç½‘ç»œäº¤æ¢æ•°æ®(Â§15.11)</li>
<li>åœ¨ç”¨æˆ·çš„è®¡ç®—æœºä¸Šå­˜å‚¨æ•°æ®(Â§15.12)</li>
<li>ç”¨çº¿ç¨‹æ‰§è¡Œå¹¶å‘è®¡ç®—(Â§15.13)</li>
</ul>
</blockquote>
<h4 id="CLIENT-SIDE-JAVASCRIPT"><a href="#CLIENT-SIDE-JAVASCRIPT" class="headerlink" title="CLIENT-SIDE JAVASCRIPT"></a>CLIENT-SIDE JAVASCRIPT</h4><p>In this book, and on the web, youâ€™ll see the term â€œclient-side JavaScript.â€ The term is simply a synonym for JavaScript written to run in a web browser, and it stands in contrast to â€œserver-sideâ€ code, which runs in web servers.</p>
<blockquote>
<p>åœ¨æœ¬ä¹¦å’Œwebä¸Šï¼Œæ‚¨å°†çœ‹åˆ°æœ¯è¯­â€œå®¢æˆ·ç«¯JavaScriptâ€ã€‚è¿™ä¸ªæœ¯è¯­åªæ˜¯åœ¨webæµè§ˆå™¨ä¸­è¿è¡Œçš„JavaScriptçš„åŒä¹‰è¯ï¼Œå®ƒä¸åœ¨webæœåŠ¡å™¨ä¸­è¿è¡Œçš„â€œæœåŠ¡å™¨ç«¯â€ä»£ç å½¢æˆå¯¹æ¯”ã€‚</p>
</blockquote>
<p>The two â€œsidesâ€ refer to the two ends of the network connection that separate the web server and the web browser, and software development for the web typically requires code to be written on both â€œsides.â€ Client-side and server-side are also often called â€œfrontendâ€ and â€œbackend.â€</p>
<blockquote>
<p>è¿™ä¸¤ä¸ªâ€œç«¯â€æŒ‡çš„æ˜¯ç½‘ç»œè¿æ¥çš„ä¸¤ç«¯ï¼Œå®ƒå°†webæœåŠ¡å™¨å’Œwebæµè§ˆå™¨åˆ†å¼€ï¼Œè€Œwebçš„è½¯ä»¶å¼€å‘é€šå¸¸éœ€è¦åœ¨è¿™ä¸¤ä¸ªâ€œç«¯â€ç¼–å†™ä»£ç ã€‚å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯é€šå¸¸ä¹Ÿç§°ä¸ºå‰ç«¯å’Œåç«¯ã€‚</p>
</blockquote>
<p>Previous editions of this book attempted to comprehensively cover all JavaScript APIs defined by web browsers, and as a result, this book was too long a decade ago. The number and complexity of web APIs has continued to grow, and I no longer think it makes sense to attempt to cover them all in one book. As of the seventh edition, my goal is to cover the JavaScript language definitively and to provide an in-depth introduction to using the language with Node and with web browsers. This chapter cannot cover all the web APIs, but it introduces the most important ones in enough detail that you can start using them right away. And, having learned about the core APIs covered here, you should be able to pick up new APIs (like those summarized in Â§15.15) when and if you need them.</p>
<blockquote>
<p>æœ¬ä¹¦çš„å‰å‡ ä¸ªç‰ˆæœ¬è¯•å›¾å…¨é¢åœ°æ¶µç›–webæµè§ˆå™¨å®šä¹‰çš„æ‰€æœ‰JavaScript apiï¼Œå› æ­¤ï¼Œè¿™æœ¬ä¹¦åœ¨åå¹´å‰å°±æ˜¾å¾—å¤ªé•¿äº†ã€‚web apiçš„æ•°é‡å’Œå¤æ‚æ€§ä¸€ç›´åœ¨å¢é•¿ï¼Œæˆ‘è®¤ä¸ºåœ¨ä¸€æœ¬ä¹¦ä¸­æ¶µç›–å®ƒä»¬å·²ç»æ²¡æœ‰æ„ä¹‰äº†ã€‚åœ¨ç¬¬7ç‰ˆä¸­ï¼Œæˆ‘çš„ç›®æ ‡æ˜¯è¯¦ç»†ä»‹ç»JavaScriptè¯­è¨€ï¼Œå¹¶æ·±å…¥ä»‹ç»å¦‚ä½•åœ¨Nodeå’Œwebæµè§ˆå™¨ä¸­ä½¿ç”¨è¯¥è¯­è¨€ã€‚æœ¬ç« ä¸èƒ½æ¶µç›–æ‰€æœ‰çš„web apiï¼Œä½†å®ƒä»‹ç»äº†æœ€é‡è¦çš„apiï¼Œè¶³å¤Ÿè¯¦ç»†ï¼Œæ‚¨å¯ä»¥ç«‹å³å¼€å§‹ä½¿ç”¨å®ƒä»¬ã€‚å¹¶ä¸”ï¼Œåœ¨äº†è§£äº†è¿™é‡Œæ‰€æ¶µç›–çš„æ ¸å¿ƒapiä¹‹åï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿåœ¨éœ€è¦çš„æ—¶å€™è·å¾—æ–°çš„api(å¦‚Â§15.15ä¸­æ€»ç»“çš„é‚£äº›api)ã€‚</p>
</blockquote>
<p>Node has a single implementation and a single authoritative source for documentation. Web APIs, by contrast, are defined by consensus among the major web browser vendors, and the authoritative documentation takes the form of a specification intended for the C++ programmers who implement the API, not for the JavaScript programmers who will use it. Fortunately, Mozillaâ€™s â€œMDN web docsâ€ project is a reliable and comprehensive source1 for web API documentation.</p>
<blockquote>
<p>Nodeåªæœ‰ä¸€ä¸ªå®ç°å’Œä¸€ä¸ªæƒå¨çš„æ–‡æ¡£æºã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼ŒWeb APIæ˜¯ç”±ä¸»è¦Webæµè§ˆå™¨ä¾›åº”å•†çš„å…±è¯†å®šä¹‰çš„ï¼Œæƒå¨æ–‡æ¡£é‡‡ç”¨äº†ä¸€ç§è§„èŒƒçš„å½¢å¼ï¼Œè¿™ç§è§„èŒƒæ˜¯ä¸ºå®ç°APIçš„c++ç¨‹åºå‘˜è®¾è®¡çš„ï¼Œè€Œä¸æ˜¯ä¸ºå°†ä½¿ç”¨å®ƒçš„JavaScriptç¨‹åºå‘˜è®¾è®¡çš„ã€‚å¹¸è¿çš„æ˜¯ï¼ŒMozillaçš„â€œMDN web docsâ€é¡¹ç›®æ˜¯ä¸€ä¸ªå¯é è€Œå…¨é¢çš„web APIæ–‡æ¡£æ¥æºã€‚</p>
</blockquote>
<h4 id="LEGACY-APIS"><a href="#LEGACY-APIS" class="headerlink" title="LEGACY APIS"></a>LEGACY APIS</h4><p>In the 25 years since JavaScript was first released, browser vendors have been adding features and APIs for programmers to use. Many of those APIs are now obsolete. They include:</p>
<ul>
<li>Proprietary APIs that were never standardized and&#x2F;or never implemented by other browser vendors. Microsoftâ€™s Internet Explorer defined a lot of these APIs. Some (like the innerHTML property) proved useful and were eventually standardized. Others (like the attachEvent() method) have been obsolete for years.</li>
<li>Inefficient APIs (like the document.write() method) that have such a severe performance impact that their use is no longer considered acceptable.</li>
<li>Outdated APIs that have long since been replaced by new APIs for achieving the same thing. An example is document.bgColor, which was defined to allow JavaScript to set the background color of a document. With the advent of CSS, document.bgColor became a quaint special case with no real purpose.</li>
<li>Poorly designed APIs that have been replaced by better ones. In the early days of the web, standards committees defined the key Document Object Model API in a language-agnostic way so that the same API could be used in Java programs to work with XML documents on and in JavaScript programs to work with HTML documents. This resulted in an API that was not well suited to the JavaScript language and that had features that web programmers didnâ€™t particularly care about. It took decades to recover from those early design mistakes, but todayâ€™s web browsers support a much-improved Document Object Model.</li>
</ul>
<p>Browser vendors may need to support these legacy APIs for the foreseeable future in order to ensure backward compatibility, but there is no longer any need for this book to document them or for you to learn about them. The web platform has matured and stabilized, and if you are a seasoned web developer who remembers the fourth or fifth edition of this book, then you may have as much outdated knowledge to forget as you have new material to learn.</p>
<h2 id="15-1-Web-Programming-Basics"><a href="#15-1-Web-Programming-Basics" class="headerlink" title="15.1 Web Programming Basics"></a>15.1 Web Programming Basics</h2><p>This section explains how JavaScript programs for the web are structured, how they are loaded into a web browser, how they obtain input, how they produce output, and how they run asynchronously by responding to events.</p>
<h3 id="15-1-1-JavaScript-in-HTML-lt-script-gt-Tags"><a href="#15-1-1-JavaScript-in-HTML-lt-script-gt-Tags" class="headerlink" title="15.1.1 JavaScript in HTML &lt;script&gt; Tags"></a>15.1.1 JavaScript in HTML <code>&lt;script&gt;</code> Tags</h3><p>Web browsers display HTML documents. If you want a web browser to execute JavaScript code, you must include (or reference) that code from an HTML document, and this is what the HTML <code>&lt;script&gt;</code> tag does.</p>
<p>JavaScript code can appear inline within an HTML file between <code>&lt;script&gt;</code> and <code>&lt;/script&gt;</code> tags. Here, for example, is an HTML file that includes a script tag with JavaScript code that dynamically updates one element of the document to make it behave like a digital clock:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span>                 <span class="comment">&lt;!-- This is an HTML5 file --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span>                          <span class="comment">&lt;!-- The root element --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span>                          <span class="comment">&lt;!-- Title, scripts &amp; styles can go here --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>Digital Clock<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css">                         <span class="comment">/* A CSS stylesheet for the clock */</span></span></span><br><span class="line"><span class="language-css"><span class="selector-id">#clock</span> &#123;                        <span class="comment">/* Styles apply to element with id=&quot;clock&quot; */</span></span></span><br><span class="line"><span class="language-css">  <span class="attribute">font</span>: bold <span class="number">24px</span> sans-serif;   <span class="comment">/* Use a big bold font */</span></span></span><br><span class="line"><span class="language-css">  <span class="attribute">background</span>: <span class="number">#ddf</span>;             <span class="comment">/* on a light bluish-gray background. */</span></span></span><br><span class="line"><span class="language-css">  <span class="attribute">padding</span>: <span class="number">15px</span>;                <span class="comment">/* Surround it with some space */</span></span></span><br><span class="line"><span class="language-css">  <span class="attribute">border</span>: solid black <span class="number">2px</span>;      <span class="comment">/* and a solid black border */</span></span></span><br><span class="line"><span class="language-css">  <span class="attribute">border-radius</span>: <span class="number">10px</span>;          <span class="comment">/* with rounded corners. */</span></span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span>                    <span class="comment">&lt;!-- The body holds the content of the document. --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Digital Clock<span class="tag">&lt;/<span class="name">h1</span>&gt;</span>    <span class="comment">&lt;!-- Display a title. --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;clock&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span>  <span class="comment">&lt;!-- We will insert the time into this element. --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// Define a function to display the current time</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">displayTime</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> clock = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#clock&quot;</span>); <span class="comment">// Get element with id=&quot;clock&quot;</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> now = <span class="keyword">new</span> <span class="title class_">Date</span>();                         <span class="comment">// Get current time</span></span></span><br><span class="line"><span class="language-javascript">    clock.<span class="property">textContent</span> = now.<span class="title function_">toLocaleTimeString</span>(); <span class="comment">// Display time in the clock</span></span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"><span class="title function_">displayTime</span>()                    <span class="comment">// Display the time right away</span></span></span><br><span class="line"><span class="language-javascript"><span class="built_in">setInterval</span>(displayTime, <span class="number">1000</span>);  <span class="comment">// And then update it every second.</span></span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Although JavaScript code can be embedded directly within a <code>&lt;script&gt;</code> tag, it is more common to instead use the src attribute of the <code>&lt;script&gt;</code> tag to specify the URL (an absolute URL or a URL relative to the URL of the HTML file being displayed) of a file containing JavaScript code. If we took the JavaScript code out of this HTML file and stored it in its own scripts&#x2F;digital_clock.js file, then the <code>&lt;script&gt;</code> tag might reference that file of code like this:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;scripts/digital_clock.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>A JavaScript file contains pure JavaScript, without <code>&lt;script&gt;</code> tags or any other HTML. By convention, files of JavaScript code have names that end with .js.</p>
<p>A <code>&lt;script&gt;</code> tag with the a src attribute behaves exactly as if the contents of the specified JavaScript file appeared directly between the <code>&lt;script&gt;</code> and <code>&lt;/script&gt;</code> tags. Note that the closing <code>&lt;/script&gt;</code> tag is required in HTML documents even when the src attribute is specified: HTML does not support a <code>&lt;script/&gt;</code> tag.</p>
<p>There are a number of advantages to using the src attribute:</p>
<ul>
<li>It simplifies your HTML files by allowing you to remove large blocks of JavaScript code from themâ€”that is, it helps keep content and behavior separate.</li>
<li>When multiple web pages share the same JavaScript code, using the src attribute allows you to maintain only a single copy of that code, rather than having to edit each HTML file when the code changes.</li>
<li>If a file of JavaScript code is shared by more than one page, it only needs to be downloaded once, by the first page that uses itâ€”subsequent pages can retrieve it from the browser cache.</li>
<li>Because the src attribute takes an arbitrary URL as its value, a JavaScript program or web page from one web server can employ code exported by other web servers. Much internet advertising relies on this fact.</li>
</ul>
<p>MODULES<br>Â§10.3 documents JavaScript modules and covers their import and export directives. If you have written your JavaScript program using modules (and have not used a code-bundling tool to combine all your modules into a single nonmodular file of JavaScript), then you must load the top-level module of your program with a <code>&lt;script&gt;</code> tag that has a type&#x3D;â€moduleâ€ attribute. If you do this, then the module you specify will be loaded, and all of the modules it imports will be loaded, and (recursively) all of the modules they import will be loaded. See Â§10.3.5 for complete details.</p>
<p>SPECIFYING SCRIPT TYPE<br>In the early days of the web, it was thought that browsers might some day implement languages other than JavaScript, and programmers added attributes like language&#x3D;â€javascriptâ€ and type&#x3D;â€application&#x2F;javascriptâ€ to their <code>&lt;script&gt;</code> tags. This is completely unnecessary. JavaScript is the default (and only) language of the web. The language attribute is deprecated, and there are only two reasons to use a type attribute on a <code>&lt;script&gt;</code> tag:</p>
<ul>
<li>To specify that the script is a module</li>
<li>To embed data into a web page without displaying it (see Â§15.3.4)</li>
</ul>
<p>WHEN SCRIPTS RUN: ASYNC AND DEFERRED<br>When JavaScript was first added to web browsers, there was no API for traversing and manipulating the structure and content of an already rendered document. The only way that JavaScript code could affect the content of a document was to generate that content on the fly while the document was in the process of loading. It did this by using the document.write() method to inject HTML text into the document at the location of the script.</p>
<p>The use of document.write() is no longer considered good style, but the fact that it is possible means that when the HTML parser encounters a <code>&lt;script&gt;</code> element, it must, by default, run the script just to be sure that it doesnâ€™t output any HTML before it can resume parsing and rendering the document. This can dramatically slow down parsing and rendering of the web page.</p>
<p>Fortunately, this default synchronous or blocking script execution mode is not the only option. The <code>&lt;script&gt;</code> tag can have defer and async attributes, which cause scripts to be executed differently. These are boolean attributesâ€”they donâ€™t have a value; they just need to be present on the <code>&lt;script&gt;</code> tag. Note that these attributes are only meaningful when used in conjunction with the src attribute:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">defer</span> <span class="attr">src</span>=<span class="string">&quot;deferred.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">async</span> <span class="attr">src</span>=<span class="string">&quot;async.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Both the defer and async attributes are ways of telling the browser that the linked script does not use document.write() to generate HTML output, and that the browser, therefore, can continue to parse and render the document while downloading the script. The defer attribute causes the browser to defer execution of the script until after the document has been fully loaded and parsed and is ready to be manipulated. The async attribute causes the browser to run the script as soon as possible but does not block document parsing while the script is being downloaded. If a <code>&lt;script&gt;</code> tag has both attributes, the async attribute takes precedence.</p>
<p>Note that deferred scripts run in the order in which they appear in the document. Async scripts run as they load, which means that they may execute out of order.</p>
<p>Scripts with the type&#x3D;â€moduleâ€ attribute are, by default, executed after the document has loaded, as if they had a defer attribute. You can override this default with the async attribute, which will cause the code to be executed as soon as the module and all of its dependencies have loaded.</p>
<p>A simple alternative to the async and defer attributesâ€”especially for code that is included directly in the HTMLâ€”is to simply put your scripts at the end of the HTML file. That way, the script can run knowing that the document content before it has been parsed and is ready to be manipulated.</p>
<p>LOADING SCRIPTS ON DEMAND<br>Sometimes, you may have JavaScript code that is not used when a document first loads and is only needed if the user takes some action like clicking on a button or opening a menu. If you are developing your code using modules, you can load a module on demand with import(), as described in Â§10.3.6.</p>
<p>If you are not using modules, you can load a file of JavaScript on demand simply by adding a <code>&lt;script&gt;</code> tag to your document when you want the script to load:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Asynchronously load and execute a script from a specified URL</span></span><br><span class="line"><span class="comment">// Returns a Promise that resolves when the script has loaded.</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">importScript</span>(<span class="params">url</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> s = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;script&quot;</span>); <span class="comment">// Create a &lt;script&gt; element</span></span><br><span class="line">        s.<span class="property">onload</span> = <span class="function">() =&gt;</span> &#123; <span class="title function_">resolve</span>(); &#125;;          <span class="comment">// Resolve promise when loaded</span></span><br><span class="line">        s.<span class="property">onerror</span> = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123; <span class="title function_">reject</span>(e); &#125;;        <span class="comment">// Reject on failure</span></span><br><span class="line">        s.<span class="property">src</span> = url;                              <span class="comment">// Set the script URL</span></span><br><span class="line">        <span class="variable language_">document</span>.<span class="property">head</span>.<span class="title function_">append</span>(s);                  <span class="comment">// Add &lt;script&gt; to document</span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This importScript() function uses DOM APIs (Â§15.3) to create a new <code>&lt;script&gt;</code> tag and add it to the document <code>&lt;head&gt;</code>. And it uses event handlers (Â§15.2) to determine when the script has loaded successfully or when loading has failed.</p>
<h3 id="15-1-2-The-Document-Object-Model"><a href="#15-1-2-The-Document-Object-Model" class="headerlink" title="15.1.2 The Document Object Model"></a>15.1.2 The Document Object Model</h3><p>One of the most important objects in client-side JavaScript programming is the Document objectâ€”which represents the HTML document that is displayed in a browser window or tab. The API for working with HTML documents is known as the Document Object Model, or DOM, and it is covered in detail in Â§15.3. But the DOM is so central to client-side JavaScript programming that it deserves to be introduced here.</p>
<p>HTML documents contain HTML elements nested within one another, forming a tree. Consider the following simple HTML document:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Sample Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>An HTML Document<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>This is a <span class="tag">&lt;<span class="name">i</span>&gt;</span>simple<span class="tag">&lt;/<span class="name">i</span>&gt;</span> document.</span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>The top-level <code>&lt;html&gt;</code> tag contains <code>&lt;head&gt;</code> and <code>&lt;body&gt;</code> tags. The <code>&lt;head&gt;</code> tag contains a <code>&lt;title&gt;</code> tag. And the <code>&lt;body&gt;</code> tag contains <code>&lt;h1&gt;</code> and <code>&lt;p&gt;</code> tags. The <code>&lt;title&gt;</code> and <code>&lt;h1&gt;</code> tags contain strings of text, and the <code>&lt;p&gt;</code> tag contains two strings of text with an <code>&lt;i&gt;</code> tag between them.</p>
<p>The DOM API mirrors the tree structure of an HTML document. For each HTML tag in the document, there is a corresponding JavaScript Element object, and for each run of text in the document, there is a corresponding Text object. The Element and Text classes, as well as the Document class itself, are all subclasses of the more general Node class, and Node objects are organized into a tree structure that JavaScript can query and traverse using the DOM API. The DOM representation of this document is the tree pictured in Figure 15-1.</p>
<p><Figures figure="15-1">The tree representation of an HTML document</Figures></p>
<p>If you are not already familiar with tree structures in computer programming, it is helpful to know that they borrow terminology from family trees. The node directly above a node is the parent of that node. The nodes one level directly below another node are the children of that node. Nodes at the same level, and with the same parent, are siblings. The set of nodes any number of levels below another node are the descendants of that node. And the parent, grandparent, and all other nodes above a node are the ancestors of that node.</p>
<p>The DOM API includes methods for creating new Element and Text nodes, and for inserting them into the document as children of other Element objects. There are also methods for moving elements within the document and for removing them entirely. While a server-side application might produce plain-text output by writing strings with console.log(), a client-side JavaScript application can produce formatted HTML output by building or manipulating the document tree document using the DOM API.</p>
<p>There is a JavaScript class corresponding to each HTML tag type, and each occurrence of the tag in a document is represented by an instance of the class. The <code>&lt;body&gt;</code> tag, for example, is represented by an instance of HTMLBodyElement, and a <code>&lt;table&gt;</code> tag is represented by an instance of HTMLTableElement. The JavaScript element objects have properties that correspond to the HTML attributes of the tags. For example, instances of HTMLImageElement, which represent <code>&lt;img&gt;</code> tags, have a src property that corresponds to the src attribute of the tag. The initial value of the src property is the attribute value that appears in the HTML tag, and setting this property with JavaScript changes the value of the HTML attribute (and causes the browser to load and display a new image). Most of the JavaScript element classes just mirror the attributes of an HTML tag, but some define additional methods. The HTMLAudioElement and HTMLVideoElement classes, for example, define methods like play() and pause() for controlling playback of audio and video files.</p>
<h3 id="15-1-3-The-Global-Object-in-Web-Browsers"><a href="#15-1-3-The-Global-Object-in-Web-Browsers" class="headerlink" title="15.1.3 The Global Object in Web Browsers"></a>15.1.3 The Global Object in Web Browsers</h3><p>There is one global object per browser window or tab (Â§3.7). All of the JavaScript code (except code running in worker threads; see Â§15.13) running in that window shares this single global object. This is true regardless of how many scripts or modules are in the document: all the scripts and modules of a document share a single global object; if one script defines a property on that object, that property is visible to all the other scripts as well.</p>
<p>The global object is where JavaScriptâ€™s standard library is definedâ€”the parseInt() function, the Math object, the Set class, and so on. In web browsers, the global object also contains the main entry points of various web APIs. For example, the document property represents the currently displayed document, the fetch() method makes HTTP network requests, and the Audio() constructor allows JavaScript programs to play sounds.</p>
<p>In web browsers, the global object does double duty: in addition to defining built-in types and functions, it also represents the current web browser window and defines properties like history (Â§15.10.2), which represent the windowâ€™s browsing history, and innerWidth, which holds the windowâ€™s width in pixels. One of the properties of this global object is named window, and its value is the global object itself. This means that you can simply type window to refer to the global object in your client-side code. When using window-specific features, it is often a good idea to include a window. prefix: window.innerWidth is clearer than innerWidth, for example.</p>
<h3 id="15-1-4-Scripts-Share-a-Namespace"><a href="#15-1-4-Scripts-Share-a-Namespace" class="headerlink" title="15.1.4 Scripts Share a Namespace"></a>15.1.4 Scripts Share a Namespace</h3><p>With modules, the constants, variables, functions, and classes defined at the top level (i.e., outside of any function or class definition) of the module are private to the module unless they are explicitly exported, in which case, they can be selectively imported by other modules. (Note that this property of modules is honored by code-bundling tools as well.)</p>
<p>With non-module scripts, however, the situation is completely different. If the top-level code in a script defines a constant, variable, function, or class, that declaration will be visible to all other scripts in the same document. If one script defines a function f() and another script defines a class c, then a third script can invoke the function and instantiate the class without having to take any action to import them. So if you are not using modules, the independent scripts in your document share a single namespace and behave as if they are all part of a single larger script. This can be convenient for small programs, but the need to avoid naming conflicts can become problematic for larger programs, especially when some of the scripts are third-party libraries.</p>
<p>There are some historical quirks with how this shared namespace works. var and function declarations at the top level create properties in the shared global object. If one script defines a top-level function f(), then another script in the same document can invoke that function as f() or as window.f(). On the other hand, the ES6 declarations const, let, and class, when used at the top level, do not create properties in the global object. They are still defined in a shared namespace, however: if one script defines a class C, other scripts will be able to create instances of that class with new C(), but not with new window.C().</p>
<p>To summarize: in modules, top-level declarations are scoped to the module and can be explicitly exported. In nonmodule scripts, however, top-level declarations are scoped to the containing document, and the declarations are shared by all scripts in the document. Older var and function declarations are shared via properties of the global object. Newer const, let, and class declarations are also shared and have the same document scope, but they do not exist as properties of any object that JavaScript code has access to.</p>
<h3 id="15-1-5-Execution-of-JavaScript-Programs"><a href="#15-1-5-Execution-of-JavaScript-Programs" class="headerlink" title="15.1.5 Execution of JavaScript Programs"></a>15.1.5 Execution of JavaScript Programs</h3><p>There is no formal definition of a program in client-side JavaScript, but we can say that a JavaScript program consists of all the JavaScript code in, or referenced from, a document. These separate bits of code share a single global Window object, which gives them access to the same underlying Document object representing the HTML document. Scripts that are not modules additionally share a top-level namespace.</p>
<p>If a web page includes an embedded frame (using the <code>&lt;iframe&gt;</code> element), the JavaScript code in the embedded document has a different global object and Document object than the code in the embedding document, and it can be considered a separate JavaScript program. Remember, though, that there is no formal definition of what the boundaries of a JavaScript program are. If the container document and the contained document are both loaded from the same server, the code in one document can interact with the code in the other, and you can treat them as two interacting parts of a single program, if you wish. Â§15.13.6 explains how a JavaScript program can send and receive messages to and from JavaScript code running in an <code>&lt;iframe&gt;</code>.</p>
<p>You can think of JavaScript program execution as occurring in two phases. In the first phase, the document content is loaded, and the code from <code>&lt;script&gt;</code> elements (both inline scripts and external scripts) is run. Scripts generally run in the order in which they appear in the document, though this default order can be modified by the async and defer attributes weâ€™ve described. The JavaScript code within any single script is run from top to bottom, subject, of course, to JavaScriptâ€™s conditionals, loops, and other control statements. Some scripts donâ€™t really do anything during this first phase and instead just define functions and classes for use in the second phase. Other scripts might do significant work during the first phase and then do nothing in the second. Imagine a script at the very end of a document that finds all <code>&lt;h1&gt;</code> and <code>&lt;h2&gt;</code> tags in the document and modifies the document by generating and inserting a table of contents at the beginning of the document. This could be done entirely in the first phase. (See Â§15.3.6 for an example that does exactly this.)</p>
<p>Once the document is loaded and all scripts have run, JavaScript execution enters its second phase. This phase is asynchronous and event-driven. If a script is going to participate in this second phase, then one of the things it must have done during the first phase is to register at least one event handler or other callback function that will be invoked asynchronously. During this event-driven second phase, the web browser invokes event handler functions and other callbacks in response to events that occur asynchronously. Event handlers are most commonly invoked in response to user input (mouse clicks, keystrokes, etc.) but may also be triggered by network activity, document and resource loading, elapsed time, or errors in JavaScript code. Events and event handlers are described in detail in Â§15.2.</p>
<p>Some of the first events to occur during the event-driven phase are the â€œDOMContentLoadedâ€ and â€œloadâ€ events. â€œDOMContentLoadedâ€ is triggered when the HTML document has been completely loaded and parsed. The â€œloadâ€ event is triggered when all of the documentâ€™s external resourcesâ€”such as imagesâ€”are also fully loaded. JavaScript programs often use one of these events as a trigger or starting signal. It is common to see programs whose scripts define functions but take no action other than registering an event handler function to be triggered by the â€œloadâ€ event at the beginning of the event-driven phase of execution. It is this â€œloadâ€ event handler that then manipulates the document and does whatever it is that the program is supposed to do. Note that it is common in JavaScript programming for an event handler function such as the â€œloadâ€ event handler described here to register other event handlers.</p>
<p>The loading phase of a JavaScript program is relatively short: ideally less than a second. Once the document is loaded, the event-driven phase lasts for as long as the document is displayed by the web browser. Because this phase is asynchronous and event-driven, there may be long periods of inactivity where no JavaScript is executed, punctuated by bursts of activity triggered by user or network events. Weâ€™ll cover these two phases in more detail next.</p>
<p>CLIENT-SIDE JAVASCRIPT THREADING MODEL<br>JavaScript is a single-threaded language, and single-threaded execution makes for much simpler programming: you can write code with the assurance that two event handlers will never run at the same time. You can manipulate document content knowing that no other thread is attempting to modify it at the same time, and you never need to worry about locks, deadlock, or race conditions when writing JavaScript code.</p>
<p>Single-threaded execution means that web browsers stop responding to user input while scripts and event handlers are executing. This places a burden on JavaScript programmers: it means that JavaScript scripts and event handlers must not run for too long. If a script performs a computationally intensive task, it will introduce a delay into document loading, and the user will not see the document content until the script completes. If an event handler performs a computationally intensive task, the browser may become nonresponsive, possibly causing the user to think that it has crashed.</p>
<p>The web platform defines a controlled form of concurrency called a â€œweb worker.â€ A web worker is a background thread for performing computationally intensive tasks without freezing the user interface. The code that runs in a web worker thread does not have access to document content, does not share any state with the main thread or with other workers, and can only communicate with the main thread and other workers through asynchronous message events, so the concurrency is not detectable to the main thread, and web workers do not alter the basic single-threaded execution model of JavaScript programs. See Â§15.13 for full details on the webâ€™s safe threading mechanism.</p>
<p>CLIENT-SIDE JAVASCRIPT TIMELINE<br>Weâ€™ve already seen that JavaScript programs begin in a script-execution phase and then transition to an event-handling phase. These two phases can be further broken down into the following steps:</p>
<ol>
<li>The web browser creates a Document object and begins parsing the web page, adding Element objects and Text nodes to the document as it parses HTML elements and their textual content. The document.readyState property has the value â€œloadingâ€ at this stage.</li>
<li>When the HTML parser encounters a <code>&lt;script&gt;</code> tag that does not have any of the async, defer, or type&#x3D;â€moduleâ€ attributes, it adds that script tag to the document and then executes the script. The script is executed synchronously, and the HTML parser pauses while the script downloads (if necessary) and runs. A script like this can use document.write() to insert text into the input stream, and that text will become part of the document when the parser resumes. A script like this often simply defines functions and registers event handlers for later use, but it can traverse and manipulate the document tree as it exists at that time. That is, non-module scripts that do not have an async or defer attribute can see their own <code>&lt;script&gt;</code> tag and document content that comes before it.</li>
<li>When the parser encounters a <code>&lt;script&gt;</code> element that has the async attribute set, it begins downloading the script text (and if the script is a module, it also recursively downloads all of the scriptâ€™s dependencies) and continues parsing the document. The script will be executed as soon as possible after it has downloaded, but the parser does not stop and wait for it to download. Asynchronous scripts must not use the document.write() method. They can see their own <code>&lt;script&gt;</code> tag and all document content that comes before it, and may or may not have access to additional document content.</li>
<li>When the document is completely parsed, the document.readyState property changes to â€œinteractive.â€</li>
<li>Any scripts that had the defer attribute set (along with any module scripts that do not have an async attribute) are executed in the order in which they appeared in the document. Async scripts may also be executed at this time. Deferred scripts have access to the complete document and they must not use the document.write() method.</li>
<li>The browser fires a â€œDOMContentLoadedâ€ event on the Document object. This marks the transition from synchronous script-execution phase to the asynchronous, event-driven phase of program execution. Note, however, that there may still be async scripts that have not yet executed at this point.</li>
<li>The document is completely parsed at this point, but the browser may still be waiting for additional content, such as images, to load. When all such content finishes loading, and when all async scripts have loaded and executed, the document.readyState property changes to â€œcompleteâ€ and the web browser fires a â€œloadâ€ event on the Window object.</li>
<li>From this point on, event handlers are invoked asynchronously in response to user input events, network events, timer expirations, and so on.</li>
</ol>
<h3 id="15-1-6-Program-Input-and-Output"><a href="#15-1-6-Program-Input-and-Output" class="headerlink" title="15.1.6 Program Input and Output"></a>15.1.6 Program Input and Output</h3><p>Like any program, client-side JavaScript programs process input data to produce output data. There are a variety of inputs available:</p>
<ul>
<li>The content of the document itself, which JavaScript code can access with the DOM API (Â§15.3).</li>
<li>User input, in the form of events, such as mouse clicks (or touch-screen taps) on HTML <code>&lt;button&gt;</code> elements, or text entered into HTML <code>&lt;textarea&gt;</code> elements, for example. Â§15.2 demonstrates how JavaScript programs can respond to user events like these.</li>
<li>The URL of the document being displayed is available to client-side JavaScript as document.URL. If you pass this string to the URL() constructor (Â§11.9), you can easily access the path, query, and fragment sections of the URL.</li>
<li>The content of the HTTP â€œCookieâ€ request header is available to client-side code as document.cookie. Cookies are usually used by server-side code for maintaining user sessions, but client-side code can also read (and write) them if necessary. See Â§15.12.2 for further details.</li>
<li>The global navigator property provides access to information about the web browser, the OS itâ€™s running on top of, and the capabilities of each. For example, navigator.userAgent is a string that identifies the web browser, navigator.language is the userâ€™s preferred language, and navigator.hardwareConcurrency returns the number of logical CPUs available to the web browser. Similarly, the global screen property provides access to the userâ€™s display size via the screen.width and screen.height properties. In a sense, these navigator and screen objects are to web browsers what environment variables are to Node programs.</li>
</ul>
<p>Client-side JavaScript typically produces output, when it needs to, by manipulating the HTML document with the DOM API (Â§15.3) or by using a higher-level framework such as React or Angular to manipulate the document. Client-side code can also use console.log() and related methods (Â§11.8) to produce output. But this output is only visible in the web developer console, so it is useful when debugging, but not for user-visible output.</p>
<h3 id="15-1-7-Program-Errors"><a href="#15-1-7-Program-Errors" class="headerlink" title="15.1.7 Program Errors"></a>15.1.7 Program Errors</h3><p>Unlike applications (such as Node applications) that run directly on top of the OS, JavaScript programs in a web browser canâ€™t really â€œcrash.â€ If an exception occurs while your JavaScript program is running, and if you do not have a catch statement to handle it, an error message will be displayed in the developer console, but any event handlers that have been registered keep running and responding to events.</p>
<p>If you would like to define an error handler of last resort to be invoked when this kind of uncaught exception occurs, set the onerror property of the Window object to an error handler function. When an uncaught exception propagates all the way up the call stack and an error message is about to be displayed in the developer console, the window.onerror function will be invoked with three string arguments. The first argument to window.onerror is a message describing the error. The second argument is a string that contains the URL of the JavaScript code that caused the error. The third argument is the line number within the document where the error occurred. If the onerror handler returns true, it tells the browser that the handler has handled the error and that no further action is necessaryâ€”in other words, the browser should not display its own error message.</p>
<p>When a Promise is rejected and there is no .catch() function to handle it, that is a situation much like an unhandled exception: an unanticipated error or a logic error in your program. You can detect this by defining a window.onunhandledrejection function or by using window.addEventListener() to register a handler for â€œunhandledrejectionâ€ events. The event object passed to this handler will have a promise property whose value is the Promise object that rejected and a reason property whose value is what would have been passed to a .catch() function. As with the error handlers described earlier, if you call preventDefault() on the unhandled rejection event object, it will be considered handled and wonâ€™t cause an error message in the developer console.</p>
<p>It is not often necessary to define onerror or onunhandledrejection handlers, but it can be quite useful as a telemetry mechanism if you want to report client-side errors to the server (using the fetch() function to make an HTTP POST request, for example) so that you can get information about unexpected errors that happen in your usersâ€™ browsers.</p>
<h3 id="15-1-8-The-Web-Security-Model"><a href="#15-1-8-The-Web-Security-Model" class="headerlink" title="15.1.8 The Web Security Model"></a>15.1.8 The Web Security Model</h3><p>The fact that web pages can execute arbitrary JavaScript code on your personal device has clear security implications, and browser vendors have worked hard to balance two competing goals:</p>
<ul>
<li>Defining powerful client-side APIs to enable useful web applications</li>
<li>Preventing malicious code from reading or altering your data, compromising your privacy, scamming you, or wasting your time</li>
</ul>
<p>The subsections that follow give a quick overview of the security restrictions and issues that you, as a JavaScript programmer, should to be aware of.</p>
<p>WHAT JAVASCRIPT CANâ€™T DO<br>Web browsersâ€™ first line of defense against malicious code is that they simply do not support certain capabilities. For example, client-side JavaScript does not provide any way to write or delete arbitrary files or list arbitrary directories on the client computer. This means a JavaScript program cannot delete data or plant viruses.</p>
<p>Similarly, client-side JavaScript does not have general-purpose networking capabilities. A client-side JavaScript program can make HTTP requests (Â§15.11.1). And another standard, known as WebSockets (Â§15.11.3), defines a socket-like API for communicating with specialized servers. But neither of these APIs allows unmediated access to the wider network. General-purpose internet clients and servers cannot be written in client-side JavaScript.</p>
<p>THE SAME-ORIGIN POLICY<br>The same-origin policy is a sweeping security restriction on what web content JavaScript code can interact with. It typically comes into play when a web page includes <code>&lt;iframe&gt;</code> elements. In this case, the same-origin policy governs the interactions of JavaScript code in one frame with the content of other frames. Specifically, a script can read only the properties of windows and documents that have the same origin as the document that contains the script.</p>
<p>The origin of a document is defined as the protocol, host, and port of the URL from which the document was loaded. Documents loaded from different web servers have different origins. Documents loaded through different ports of the same host have different origins. And a document loaded with the http: protocol has a different origin than one loaded with the https: protocol, even if they come from the same web server. Browsers typically treat every file: URL as a separate origin, which means that if youâ€™re working on a program that displays more than one document from the same server, you may not be able to test it locally using file: URLs and will have to run a static web server during development.</p>
<p>It is important to understand that the origin of the script itself is not relevant to the same-origin policy: what matters is the origin of the document in which the script is embedded. Suppose, for example, that a script hosted by host A is included (using the src property of a <code>&lt;script&gt;</code> element) in a web page served by host B. The origin of that script is host B, and the script has full access to the content of the document that contains it. If the document contains an <code>&lt;iframe&gt;</code> that contains a second document from host B, then the script also has full access to the content of that second document. But if the top-level document contains another <code>&lt;iframe&gt;</code> that displays a document from host C (or even one from host A), then the same-origin policy comes into effect and prevents the script from accessing this nested document.</p>
<p>The same-origin policy also applies to scripted HTTP requests (see Â§15.11.1). JavaScript code can make arbitrary HTTP requests to the web server from which the containing document was loaded, but it does not allow scripts to communicate with other web servers (unless those web servers opt in with CORS, as we describe next).</p>
<p>The same-origin policy poses problems for large websites that use multiple subdomains. For example, scripts with origin orders.example.com might need to read properties from documents on example.com. To support multidomain websites of this sort, scripts can alter their origin by setting document.domain to a domain suffix. So a script with origin <a target="_blank" rel="noopener" href="https://orders.example.com/">https://orders.example.com</a> can change its origin to <a target="_blank" rel="noopener" href="https://example.com/">https://example.com</a> by setting document.domain to â€œexample.com.â€ But that script cannot set document.domain to â€œorders.exampleâ€, â€œample.comâ€, or â€œcomâ€.</p>
<p>The second technique for relaxing the same-origin policy is Cross-Origin Resource Sharing, or CORS, which allows servers to decide which origins they are willing to serve. CORS extends HTTP with a new Origin: request header and a new Access-Control-Allow-Origin response header. It allows servers to use a header to explicitly list origins that may request a file or to use a wildcard and allow a file to be requested by any site. Browsers honor these CORS headers and do not relax same-origin restrictions unless they are present.</p>
<p>CROSS-SITE SCRIPTING<br>Cross-site scripting, or XSS, is a term for a category of security issues in which an attacker injects HTML tags or scripts into a target website. Client-side JavaScript programmers must be aware of, and defend against, cross-site scripting.</p>
<p>A web page is vulnerable to cross-site scripting if it dynamically generates document content and bases that content on user-submitted data without first â€œsanitizingâ€ that data by removing any embedded HTML tags from it. As a trivial example, consider the following web page that uses JavaScript to greet the user by name:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> name = <span class="keyword">new</span> <span class="title function_">URL</span>(<span class="variable language_">document</span>.<span class="property">URL</span>).<span class="property">searchParams</span>.<span class="title function_">get</span>(<span class="string">&quot;name&quot;</span>);</span></span><br><span class="line"><span class="language-javascript"><span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;h1&#x27;</span>).<span class="property">innerHTML</span> = <span class="string">&quot;Hello &quot;</span> + name;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>This two-line script extracts input from the â€œnameâ€ query parameter of the document URL. It then uses the DOM API to inject an HTML string into the first <code>&lt;h1&gt;</code> tag in the document. This page is intended to be invoked with a URL like this:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.example.com/greet.html?name=David</span><br></pre></td></tr></table></figure>
<p>When used like this, it displays the text â€œHello David.â€ But consider what happens when it is invoked with this query parameter:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">name=%3Cimg%20src=%22x.png%22%20onload=%22alert(%27hacked%27)%22/%3E</span><br></pre></td></tr></table></figure>
<p>When the URL-escaped parameters are decoded, this URL causes the following HTML to be injected into the document:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hello &lt;img src=&quot;x.png&quot; onload=&quot;alert(&#x27;hacked&#x27;)&quot;/&gt;</span><br></pre></td></tr></table></figure>
<p>After the image loads, the string of JavaScript in the onload attribute is executed. The global alert() function displays a modal dialogue box. A single dialogue box is relatively benign but demonstrates that arbitrary code execution is possible on this site because it displays unsanitized HTML.</p>
<p>Cross-site scripting attacks are so called because more than one site is involved. Site B includes a specially crafted link (like the one in the previous example) to site A. If site B can convince users to click the link, they will be taken to site A, but that site will now be running code from site B. That code might deface the page or cause it to malfunction. More dangerously, the malicious code could read cookies stored by site A (perhaps account numbers or other personally identifying information) and send that data back to site B. The injected code could even track the userâ€™s keystrokes and send that data back to site B.</p>
<p>In general, the way to prevent XSS attacks is to remove HTML tags from any untrusted data before using it to create dynamic document content. You can fix the greet.html file shown earlier by replacing special HTML characters in the untrusted input string with their equivalent HTML entities:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">name = name</span><br><span class="line">    .<span class="title function_">replace</span>(<span class="regexp">/&amp;/g</span>, <span class="string">&quot;&amp;amp;&quot;</span>)</span><br><span class="line">    .<span class="title function_">replace</span>(<span class="regexp">/&lt;/g</span>, <span class="string">&quot;&amp;lt;&quot;</span>)</span><br><span class="line">    .<span class="title function_">replace</span>(<span class="regexp">/&gt;/g</span>, <span class="string">&quot;&amp;gt;&quot;</span>)</span><br><span class="line">    .<span class="title function_">replace</span>(<span class="regexp">/&quot;/g</span>, <span class="string">&quot;&amp;quot;&quot;</span>)</span><br><span class="line">    .<span class="title function_">replace</span>(<span class="regexp">/&#x27;/g</span>, <span class="string">&quot;&amp;#x27;&quot;</span>)</span><br><span class="line">    .<span class="title function_">replace</span>(<span class="regexp">/\//g</span>, <span class="string">&quot;&amp;#x2F;&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>Another approach to the problem of XSS is to structure your web applications so that untrusted content is always displayed in an <code>&lt;iframe&gt;</code> with the sandbox attribute set to disable scripting and other capabilities.</p>
<p>Cross-site scripting is a pernicious vulnerability whose roots go deep into the architecture of the web. It is worth understanding this vulnerability in-depth, but further discussion is beyond the scope of this book. There are many online resources to help you defend against cross-site scripting.</p>
<h2 id="15-2-Events"><a href="#15-2-Events" class="headerlink" title="15.2 Events"></a>15.2 Events</h2><p>Client-side JavaScript programs use an asynchronous event-driven programming model. In this style of programming, the web browser generates an event whenever something interesting happens to the document or browser or to some element or object associated with it. For example, the web browser generates an event when it finishes loading a document, when the user moves the mouse over a hyperlink, or when the user strikes a key on the keyboard. If a JavaScript application cares about a particular type of event, it can register one or more functions to be invoked when events of that type occur. Note that this is not unique to web programming: all applications with graphical user interfaces are designed this wayâ€”they sit around waiting to be interacted with (i.e., they wait for events to occur), and then they respond.</p>
<p>In client-side JavaScript, events can occur on any element within an HTML document, and this fact makes the event model of web browsers significantly more complex than Nodeâ€™s event model. We begin this section with some important definitions that help to explain that event model:</p>
<p>event type<br>This string specifies what kind of event occurred. The type â€œmousemove,â€ for example, means that the user moved the mouse. The type â€œkeydownâ€ means that the user pressed a key on the keyboard down. And the type â€œloadâ€ means that a document (or some other resource) has finished loading from the network. Because the type of an event is just a string, itâ€™s sometimes called an event name, and indeed, we use this name to identify the kind of event weâ€™re talking about.</p>
<p>event target<br>This is the object on which the event occurred or with which the event is associated. When we speak of an event, we must specify both the type and the target. A load event on a Window, for example, or a click event on a <code>&lt;button&gt;</code> Element. Window, Document, and Element objects are the most common event targets in client-side JavaScript applications, but some events are triggered on other kinds of objects. For example, a Worker object (a kind of thread, covered Â§15.13) is a target for â€œmessageâ€ events that occur when the worker thread sends a message to the main thread.</p>
<p>event handler, or event listener<br>This function handles or responds to an event.2 Applications register their event handler functions with the web browser, specifying an event type and an event target. When an event of the specified type occurs on the specified target, the browser invokes the handler function. When event handlers are invoked for an object, we say that the browser has â€œfired,â€ â€œtriggered,â€ or â€œdispatchedâ€ the event. There are a number of ways to register event handlers, and the details of handler registration and invocation are explained in Â§15.2.2 and Â§15.2.3.</p>
<p>event object<br>This object is associated with a particular event and contains details about that event. Event objects are passed as an argument to the event handler function. All event objects have a type property that specifies the event type and a target property that specifies the event target. Each event type defines a set of properties for its associated event object. The object associated with a mouse event includes the coordinates of the mouse pointer, for example, and the object associated with a keyboard event contains details about the key that was pressed and the modifier keys that were held down. Many event types define only a few standard propertiesâ€”such as type and targetâ€”and do not carry much other useful information. For those events, it is the simple occurrence of the event, not the event details, that matter.</p>
<p>event propagation<br>This is the process by which the browser decides which objects to trigger event handlers on. For events that are specific to a single objectâ€”such as the â€œloadâ€ event on the Window object or a â€œmessageâ€ event on a Worker objectâ€”no propagation is required. But when certain kinds of events occur on elements within the HTML document, however, they propagate or â€œbubbleâ€ up the document tree. If the user moves the mouse over a hyperlink, the mousemove event is first fired on the <code>&lt;a&gt;</code> element that defines that link. Then it is fired on the containing elements: perhaps a <code>&lt;p&gt;</code> element, a <code>&lt;section&gt;</code> element, and the Document object itself. It is sometimes more convenient to register a single event handler on a Document or other container element than to register handlers on each individual element youâ€™re interested in. An event handler can stop the propagation of an event so that it will not continue to bubble and will not trigger handlers on containing elements. Handlers do this by invoking a method of the event object. In another form of event propagation, known as event capturing, handlers specially registered on container elements have the opportunity to intercept (or â€œcaptureâ€) events before they are delivered to their actual target. Event bubbling and capturing are covered in detail in Â§15.2.4.</p>
<p>Some events have default actions associated with them. When a click event occurs on a hyperlink, for example, the default action is for the browser to follow the link and load a new page. Event handlers can prevent this default action by invoking a method of the event object. This is sometimes called â€œcancelingâ€ the event and is covered in Â§15.2.5.</p>
<h3 id="15-2-1-Event-Categories"><a href="#15-2-1-Event-Categories" class="headerlink" title="15.2.1 Event Categories"></a>15.2.1 Event Categories</h3><p>Client-side JavaScript supports such a large number of event types that there is no way this chapter can cover them all. It can be useful, though, to group events into some general categories, to illustrate the scope and wide variety of supported events:</p>
<p>Device-dependent input events<br>These events are directly tied to a specific input device, such as the mouse or keyboard. They include event types such as â€œmousedown,â€ â€œmousemove,â€ â€œmouseup,â€ â€œtouchstart,â€ â€œtouchmove,â€ â€œtouchend,â€ â€œkeydown,â€ and â€œkeyup.â€</p>
<p>Device-independent input events<br>These input events are not directly tied to a specific input device. The â€œclickâ€ event, for example, indicates that a link or button (or other document element) has been activated. This is often done via a mouse click, but it could also be done by keyboard or (on touch-sensitive devices) with a tap. The â€œinputâ€ event is a device-independent alternative to the â€œkeydownâ€ event and supports keyboard input as well as alternatives such as cut-and-paste and input methods used for ideographic scripts. The â€œpointerdown,â€ â€œpointermove,â€ and â€œpointerupâ€ event types are device-independent alternatives to mouse and touch events. They work for mouse-type pointers, for touch screens, and for pen- or stylus-style input as well.</p>
<p>User interface events<br>UI events are higher-level events, often on HTML form elements that define a user interface for a web application. They include the â€œfocusâ€ event (when a text input field gains keyboard focus), the â€œchangeâ€ event (when the user changes the value displayed by a form element), and the â€œsubmitâ€ event (when the user clicks a Submit button in a form).</p>
<p>State-change events<br>Some events are not triggered directly by user activity, but by network or browser activity, and indicate some kind of life-cycle or state-related change. The â€œloadâ€ and â€œDOMContentLoadedâ€ eventsâ€”fired on the Window and Document objects, respectively, at the end of document loadingâ€”are probably the most commonly used of these events (see â€œClient-side JavaScript timelineâ€). Browsers fire â€œonlineâ€ and â€œofflineâ€ events on the Window object when network connectivity changes. The browserâ€™s history management mechanism (Â§15.10.4) fires the â€œpopstateâ€ event in response to the browserâ€™s Back button.</p>
<p>API-specific events<br>A number of web APIs defined by HTML and related specifications include their own event types. The HTML <code>&lt;video&gt;</code> and <code>&lt;audio&gt;</code> elements define a long list of associated event types such as â€œwaiting,â€ â€œplaying,â€ â€œseeking,â€ â€œvolumechange,â€ and so on, and you can use them to customize media playback. Generally speaking, web platform APIs that are asynchronous and were developed before Promises were added to JavaScript are event-based and define API-specific events. The IndexedDB API, for example (Â§15.12.3), fires â€œsuccessâ€ and â€œerrorâ€ events when database requests succeed or fail. And although the new fetch() API (Â§15.11.1) for making HTTP requests is Promise-based, the XMLHttpRequest API that it replaces defines a number of API-specific event types.</p>
<h3 id="15-2-2-Registering-Event-Handlers"><a href="#15-2-2-Registering-Event-Handlers" class="headerlink" title="15.2.2 Registering Event Handlers"></a>15.2.2 Registering Event Handlers</h3><p>There are two basic ways to register event handlers. The first, from the early days of the web, is to set a property on the object or document element that is the event target. The second (newer and more general) technique is to pass the handler to the addEventListener() method of the object or element.</p>
<p>SETTING EVENT HANDLER PROPERTIES<br>The simplest way to register an event handler is by setting a property of the event target to the desired event handler function. By convention, event handler properties have names that consist of the word â€œonâ€ followed by the event name: onclick, onchange, onload, onmouseover, and so on. Note that these property names are case sensitive and are written in all lowercase,3 even when the event type (such as â€œmousedownâ€) consists of multiple words. The following code includes two event handler registrations of this kind:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Set the onload property of the Window object to a function.</span></span><br><span class="line"><span class="comment">// The function is the event handler: it is invoked when the document loads.</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="property">onload</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// Look up a &lt;form&gt; element</span></span><br><span class="line">    <span class="keyword">let</span> form = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;form#shipping&quot;</span>);</span><br><span class="line">    <span class="comment">// Register an event handler function on the form that will be invoked</span></span><br><span class="line">    <span class="comment">// before the form is submitted. Assume isFormValid() is defined elsewhere.</span></span><br><span class="line">    form.<span class="property">onsubmit</span> = <span class="keyword">function</span>(<span class="params">event</span>) &#123; <span class="comment">// When the user submits the form</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_">isFormValid</span>(<span class="variable language_">this</span>)) &#123;     <span class="comment">// check whether form inputs are valid</span></span><br><span class="line">            event.<span class="title function_">preventDefault</span>();   <span class="comment">// and if not, prevent form submission.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>The shortcoming of event handler properties is that they are designed around the assumption that event targets will have at most one handler for each type of event. It is often better to register event handlers using addEventListener() because that technique does not overwrite any previously registered handlers.</p>
<p>SETTING EVENT HANDLER ATTRIBUTES<br>The event handler properties of document elements can also be defined directly in the HTML file as attributes on the corresponding HTML tag. (Handlers that would be registered on the Window element with JavaScript can be defined with attributes on the <code>&lt;body&gt;</code> tag in HTML.) This technique is generally frowned upon in modern web development, but it is possible, and itâ€™s documented here because you may still see it in existing code.</p>
<p>When defining an event handler as an HTML attribute, the attribute value should be a string of JavaScript code. That code should be the body of the event handler function, not a complete function declaration. That is, your HTML event handler code should not be surrounded by curly braces and prefixed with the function keyword. For example:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;console.log(&#x27;Thank you&#x27;);&quot;</span>&gt;</span>Please Click<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>If an HTML event handler attribute contains multiple JavaScript statements, you must remember to separate those statements with semicolons or break the attribute value across multiple lines.</p>
<p>When you specify a string of JavaScript code as the value of an HTML event handler attribute, the browser converts your string into a function that works something like this one:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span>(<span class="params">event</span>) &#123;</span><br><span class="line">    <span class="title function_">with</span>(<span class="params"><span class="variable language_">document</span></span>) &#123;</span><br><span class="line">        <span class="title function_">with</span>(<span class="params"><span class="variable language_">this</span>.form || &#123;&#125;</span>) &#123;</span><br><span class="line">            <span class="title function_">with</span>(<span class="params"><span class="variable language_">this</span></span>) &#123;</span><br><span class="line">                <span class="comment">/* your code here */</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The event argument means that your handler code can refer to the current event object as event. The with statements mean that the code of your handler can refer to the properties of the target object, the containing <code>&lt;form&gt;</code> (if any), and the containing Document object directly, as if they were variables in scope. The with statement is forbidden in strict mode (Â§5.6.3), but JavaScript code in HTML attributes is never strict. Event handlers defined in this way are executed in an environment in which unexpected variables are defined. This can be a source of confusing bugs and is a good reason to avoid writing event handlers in HTML.</p>
<p>ADDEVENTLISTENER()<br>Any object that can be an event targetâ€”this includes the Window and Document objects and all document Elementsâ€”defines a method named addEventListener() that you can use to register an event handler for that target. addEventListener() takes three arguments. The first is the event type for which the handler is being registered. The event type (or name) is a string that does not include the â€œonâ€ prefix used when setting event handler properties. The second argument to addEventListener() is the function that should be invoked when the specified type of event occurs. The third argument is optional and is explained below.</p>
<p>The following code registers two handlers for the â€œclickâ€ event on a <code>&lt;button&gt;</code> element. Note the differences between the two techniques used:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;mybutton&quot;</span>&gt;</span>Click me<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> b = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#mybutton&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">b.<span class="property">onclick</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Thanks for clicking me!&quot;</span>); &#125;;</span></span><br><span class="line"><span class="language-javascript">b.<span class="title function_">addEventListener</span>(<span class="string">&quot;click&quot;</span>, <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Thanks again!&quot;</span>); &#125;);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Calling addEventListener() with â€œclickâ€ as its first argument does not affect the value of the onclick property. In this code, a button click will log two messages to the developer console. And if we called addEventListener() first and then set onclick, we would still log two messages, just in the opposite order. More importantly, you can call addEventListener() multiple times to register more than one handler function for the same event type on the same object. When an event occurs on an object, all of the handlers registered for that type of event are invoked in the order in which they were registered. Invoking addEventListener() more than once on the same object with the same arguments has no effectâ€”the handler function remains registered only once, and the repeated invocation does not alter the order in which handlers are invoked.</p>
<p>addEventListener() is paired with a removeEventListener() method that expects the same two arguments (plus an optional third) but removes an event handler function from an object rather than adding it. It is often useful to temporarily register an event handler and then remove it soon afterward. For example, when you get a â€œmousedownâ€ event, you might register temporary event handlers for â€œmousemoveâ€ and â€œmouseupâ€ events so that you can see if the user drags the mouse. Youâ€™d then deregister these handlers when the â€œmouseupâ€ event arrives. In such a situation, your event handler removal code might look like this:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">document</span>.<span class="title function_">removeEventListener</span>(<span class="string">&quot;mousemove&quot;</span>, handleMouseMove);</span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">removeEventListener</span>(<span class="string">&quot;mouseup&quot;</span>, handleMouseUp);</span><br></pre></td></tr></table></figure>
<p>The optional third argument to addEventListener() is a boolean value or object. If you pass true, then your handler function is registered as a capturing event handler and is invoked at a different phase of event dispatch. Weâ€™ll cover event capturing in Â§15.2.4. If you pass a third argument of true when you register an event listener, then you must also pass true as the third argument to removeEventListener() if you want to remove the handler.</p>
<p>Registering a capturing event handler is only one of the three options that addEventListener() supports, and instead of passing a single boolean value, you can also pass an object that explicitly specifies the options you want:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;click&quot;</span>, handleClick, &#123;</span><br><span class="line">    <span class="attr">capture</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">once</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">passive</span>: <span class="literal">true</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>If the Options object has a capture property set to true, then the event handler will be registered as a capturing handler. If that property is false or is omitted, then the handler will be non-capturing.</p>
<p>If the Options object has a once property set to true, then the event listener will be automatically removed after it is triggered once. If this property is false or is omitted, then the handler is never automatically removed.</p>
<p>If the Options object has a passive property set to true, it indicates that the event handler will never call preventDefault() to cancel the default action (see Â§15.2.5). This is particularly important for touch events on mobile devicesâ€”if event handlers for â€œtouchmoveâ€ events can prevent the browserâ€™s default scrolling action, then the browser cannot implement smooth scrolling. This passive property provides a way to register a potentially disruptive event handler of this sort but lets the web browser know that it can safely begin its default behaviorâ€”such as scrollingâ€”while the event handler is running. Smooth scrolling is so important for a good user experience that Firefox and Chrome make â€œtouchmoveâ€ and â€œmousewheelâ€ events passive by default. So if you actually want to register a handler that calls preventDefault() for one of these events, you should explicitly set the passive property to false.</p>
<p>You can also pass an Options object to removeEventListener(), but the capture property is the only one that is relevant. There is no need to specify once or passive when removing a listener, and these properties are ignored.</p>
<h3 id="15-2-3-Event-Handler-Invocation"><a href="#15-2-3-Event-Handler-Invocation" class="headerlink" title="15.2.3 Event Handler Invocation"></a>15.2.3 Event Handler Invocation</h3><p>Once youâ€™ve registered an event handler, the web browser will invoke it automatically when an event of the specified type occurs on the specified object. This section describes event handler invocation in detail, explaining event handler arguments, the invocation context (the this value), and the meaning of the return value of an event handler.</p>
<p>EVENT HANDLER ARGUMENT<br>Event handlers are invoked with an Event object as their single argument. The properties of the Event object provide details about the event:</p>
<p>type<br>The type of the event that occurred.</p>
<p>target<br>The object on which the event occurred.</p>
<p>currentTarget<br>For events that propagate, this property is the object on which the current event handler was registered.</p>
<p>timeStamp<br>A timestamp (in milliseconds) that represents when the event occurred but that does not represent an absolute time. You can determine the elapsed time between two events by subtracting the timestamp of the first event from the timestamp of the second.</p>
<p>isTrusted<br>This property will be true if the event was dispatched by the web browser itself and false if the event was dispatched by JavaScript code.</p>
<p>Specific kinds of events have additional properties. Mouse and pointer events, for example, have clientX and clientY properties that specify the window coordinates at which the event occurred.</p>
<p>EVENT HANDLER CONTEXT<br>When you register an event handler by setting a property, it looks as if you are defining a new method on the target object:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">target.<span class="property">onclick</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123; <span class="comment">/* handler code */</span> &#125;;</span><br></pre></td></tr></table></figure>
<p>It isnâ€™t surprising, therefore, that event handlers are invoked as methods of the object on which they are defined. That is, within the body of an event handler, the this keyword refers to the object on which the event handler was registered.</p>
<p>Handlers are invoked with the target as their this value, even when registered using addEventListener(). This does not work for handlers defined as arrow functions, however: arrow functions always have the same this value as the scope in which they are defined.</p>
<p>HANDLER RETURN VALUE<br>In modern JavaScript, event handlers should not return anything. You may see event handlers that return values in older code, and the return value is typically a signal to the browser that it should not perform the default action associated with the event. If the onclick handler of a Submit button in a form returns false, for example, then the web browser will not submit the form (usually because the event handler determined that the userâ€™s input fails client-side validation).</p>
<p>The standard and preferred way to prevent the browser from performing a default action is to call the preventDefault() method (Â§15.2.5) on the Event object.</p>
<p>INVOCATION ORDER<br>An event target may have more than one event handler registered for a particular type of event. When an event of that type occurs, the browser invokes all of the handlers in the order in which they were registered. Interestingly, this is true even if you mix event handlers registered with addEventListener() with an event handler registered on an object property like onclick.</p>
<h3 id="15-2-4-Event-Propagation"><a href="#15-2-4-Event-Propagation" class="headerlink" title="15.2.4 Event Propagation"></a>15.2.4 Event Propagation</h3><p>When the target of an event is the Window object or some other standalone object, the browser responds to an event simply by invoking the appropriate handlers on that one object. When the event target is a Document or document Element, however, the situation is more complicated.</p>
<p>After the event handlers registered on the target element are invoked, most events â€œbubbleâ€ up the DOM tree. The event handlers of the targetâ€™s parent are invoked. Then the handlers registered on the targetâ€™s grandparent are invoked. This continues up to the Document object, and then beyond to the Window object. Event bubbling provides an alternative to registering handlers on lots of individual document elements: instead, you can register a single handler on a common ancestor element and handle events there. You might register a â€œchangeâ€ handler on a <code>&lt;form&gt;</code> element, for example, instead of registering a â€œchangeâ€ handler for every element in the form.</p>
<p>Most events that occur on document elements bubble. Notable exceptions are the â€œfocus,â€ â€œblur,â€ and â€œscrollâ€ events. The â€œloadâ€ event on document elements bubbles, but it stops bubbling at the Document object and does not propagate on to the Window object. (The â€œloadâ€ event handlers of the Window object are triggered only when the entire document has loaded.)</p>
<p>Event bubbling is the third â€œphaseâ€ of event propagation. The invocation of the event handlers of the target object itself is the second phase. The first phase, which occurs even before the target handlers are invoked, is called the â€œcapturingâ€ phase. Recall that addEventListener() takes an optional third argument. If that argument is true, or {capture:true}, then the event handler is registered as a capturing event handler for invocation during this first phase of event propagation. The capturing phase of event propagation is like the bubbling phase in reverse. The capturing handlers of the Window object are invoked first, then the capturing handlers of the Document object, then of the body object, and so on down the DOM tree until the capturing event handlers of the parent of the event target are invoked. Capturing event handlers registered on the event target itself are not invoked.</p>
<p>Event capturing provides an opportunity to peek at events before they are delivered to their target. A capturing event handler can be used for debugging, or it can be used along with the event cancellation technique described in the next section to filter events so that the target event handlers are never actually invoked. One common use for event capturing is handling mouse drags, where mouse motion events need to be handled by the object being dragged, not the document elements over which it is dragged.</p>
<h3 id="15-2-5-Event-Cancellation"><a href="#15-2-5-Event-Cancellation" class="headerlink" title="15.2.5 Event Cancellation"></a>15.2.5 Event Cancellation</h3><p>Browsers respond to many user events, even if your code does not: when the user clicks the mouse on a hyperlink, the browser follows the link. If an HTML text input element has the keyboard focus and the user types a key, the browser will enter the userâ€™s input. If the user moves their finger across a touch-screen device, the browser scrolls. If you register an event handler for events like these, you can prevent the browser from performing its default action by invoking the preventDefault() method of the event object. (Unless you registered the handler with the passive option, which makes preventDefault() ineffective.)</p>
<p>Canceling the default action associated with an event is only one kind of event cancellation. We can also cancel the propagation of events by calling the stopPropagation() method of the event object. If there are other handlers defined on the same object, the rest of those handlers will still be invoked, but no event handlers on any other object will be invoked after stopPropagation() is called. stopPropagation() works during the capturing phase, at the event target itself, and during the bubbling phase. stopImmediatePropagation() works like stopPropagation(), but it also prevents the invocation of any subsequent event handlers registered on the same object.</p>
<h3 id="15-2-6-Dispatching-Custom-Events"><a href="#15-2-6-Dispatching-Custom-Events" class="headerlink" title="15.2.6 Dispatching Custom Events"></a>15.2.6 Dispatching Custom Events</h3><p>Client-side JavaScriptâ€™s event API is a relatively powerful one, and you can use it to define and dispatch your own events. Suppose, for example, that your program periodically needs to perform a long calculation or make a network request and that, while this operation is pending, other operations are not possible. You want to let the user know about this by displaying â€œspinnersâ€ to indicate that the application is busy. But the module that is busy should not need to know where the spinners should be displayed. Instead, that module might just dispatch an event to announce that it is busy and then dispatch another event when it is no longer busy. Then, the UI module can register event handlers for those events and take whatever UI actions are appropriate to notify the user.</p>
<p>If a JavaScript object has an addEventListener() method, then it is an â€œevent target,â€ and this means it also has a dispatchEvent() method. You can create your own event object with the CustomEvent() constructor and pass it to dispatchEvent(). The first argument to CustomEvent() is a string that specifies the type of your event, and the second argument is an object that specifies the properties of the event object. Set the detail property of this object to a string, object, or other value that represents the content of your event. If you plan to dispatch your event on a document element and want it to bubble up the document tree, add bubbles:true to the second argument:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Dispatch a custom event so the UI knows we are busy</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">dispatchEvent</span>(<span class="keyword">new</span> <span class="title class_">CustomEvent</span>(<span class="string">&quot;busy&quot;</span>, &#123; <span class="attr">detail</span>: <span class="literal">true</span> &#125;));</span><br><span class="line"></span><br><span class="line"><span class="comment">// Perform a network operation</span></span><br><span class="line"><span class="title function_">fetch</span>(url)</span><br><span class="line">  .<span class="title function_">then</span>(handleNetworkResponse)</span><br><span class="line">  .<span class="title function_">catch</span>(handleNetworkError)</span><br><span class="line">  .<span class="title function_">finally</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// After the network request has succeeded or failed, dispatch</span></span><br><span class="line">      <span class="comment">// another event to let the UI know that we are no longer busy.</span></span><br><span class="line">      <span class="variable language_">document</span>.<span class="title function_">dispatchEvent</span>(<span class="keyword">new</span> <span class="title class_">CustomEvent</span>(<span class="string">&quot;busy&quot;</span>, &#123; <span class="attr">detail</span>: <span class="literal">false</span> &#125;));</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Elsewhere, in your program you can register a handler for &quot;busy&quot; events</span></span><br><span class="line"><span class="comment">// and use it to show or hide the spinner to let the user know.</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;busy&quot;</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (e.<span class="property">detail</span>) &#123;</span><br><span class="line">        <span class="title function_">showSpinner</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_">hideSpinner</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="15-3-Scripting-Documents"><a href="#15-3-Scripting-Documents" class="headerlink" title="15.3 Scripting Documents"></a>15.3 Scripting Documents</h2><p>Client-side JavaScript exists to turn static HTML documents into interactive web applications. So scripting the content of web pages is really the central purpose of JavaScript.</p>
<p>Every Window object has a document property that refers to a Document object. The Document object represents the content of the window, and it is the subject of this section. The Document object does not stand alone, however. It is the central object in the DOM for representing and manipulating document content.</p>
<p>The DOM was introduced in Â§15.1.2. This section explains the API in detail. It covers:</p>
<ul>
<li>How to query or select individual elements from a document.</li>
<li>How to traverse a document, and how to find the ancestors, siblings, and descendants of any document element.</li>
<li>How to query and set the attributes of document elements.</li>
<li>How to query, set, and modify the content of a document.</li>
<li>How to modify the structure of a document by creating, inserting, and deleting nodes.</li>
</ul>
<h3 id="15-3-1-Selecting-Document-Elements"><a href="#15-3-1-Selecting-Document-Elements" class="headerlink" title="15.3.1 Selecting Document Elements"></a>15.3.1 Selecting Document Elements</h3><p>Client-side JavaScript programs often need to manipulate one or more elements within the document. The global document property refers to the Document object, and the Document object has head and body properties that refer to the Element objects for the <code>&lt;head&gt;</code> and <code>&lt;body&gt;</code> tags, respectively. But a program that wants to manipulate an element embedded more deeply in the document must somehow obtain or select the Element objects that refer to those document elements.</p>
<p>SELECTING ELEMENTS WITH CSS SELECTORS<br>CSS stylesheets have a very powerful syntax, known as selectors, for describing elements or sets of elements within a document. The DOM methods querySelector() and querySelectorAll() allow us to find the element or elements within a document that match a specified CSS selector. Before we cover the methods, weâ€™ll start with a quick tutorial on CSS selector syntax.</p>
<p>CSS selectors can describe elements by tag name, the value of their id attribute, or the words in their class attribute:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">div                     <span class="comment">// Any &lt;div&gt; element</span></span><br><span class="line">#nav                    <span class="comment">// The element with id=&quot;nav&quot;</span></span><br><span class="line">.<span class="property">warning</span>                <span class="comment">// Any element with &quot;warning&quot; in its class attribute</span></span><br></pre></td></tr></table></figure>
<p>The # character is used to match based on the id attribute, and the . character is used to match based on the class attribute. Elements can also be selected based on more general attribute values:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">p[lang=<span class="string">&quot;fr&quot;</span>]            <span class="comment">// A paragraph written in French: &lt;p lang=&quot;fr&quot;&gt;</span></span><br><span class="line">*[name=<span class="string">&quot;x&quot;</span>]             <span class="comment">// Any element with a name=&quot;x&quot; attribute</span></span><br></pre></td></tr></table></figure>
<p>Note that these examples combine a tag name selector (or the * tag name wildcard) with an attribute selector. More complex combinations are also possible:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">span.<span class="property">fatal</span>.<span class="property">error</span>        <span class="comment">// Any &lt;span&gt; with &quot;fatal&quot; and &quot;error&quot; in its class</span></span><br><span class="line">span[lang=<span class="string">&quot;fr&quot;</span>].<span class="property">warning</span> <span class="comment">// Any &lt;span&gt; in French with class &quot;warning&quot;</span></span><br></pre></td></tr></table></figure>
<p>Selectors can also specify document structure:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#log span               <span class="comment">// Any &lt;span&gt; descendant of the element with id=&quot;log&quot;</span></span><br><span class="line">#log&gt;span               <span class="comment">// Any &lt;span&gt; child of the element with id=&quot;log&quot;</span></span><br><span class="line">body&gt;<span class="attr">h1</span>:first-child     <span class="comment">// The first &lt;h1&gt; child of the &lt;body&gt;</span></span><br><span class="line">img + p.<span class="property">caption</span>         <span class="comment">// A &lt;p&gt; with class &quot;caption&quot; immediately after an &lt;img&gt;</span></span><br><span class="line">h2 ~ p                  <span class="comment">// Any &lt;p&gt; that follows an &lt;h2&gt; and is a sibling of it</span></span><br></pre></td></tr></table></figure>
<p>If two selectors are separated by a comma, it means that weâ€™ve selected elements that match either one of the selectors:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">button, input[type=<span class="string">&quot;button&quot;</span>] <span class="comment">// All &lt;button&gt; and &lt;input type=&quot;button&quot;&gt; elements</span></span><br></pre></td></tr></table></figure>
<p>As you can see, CSS selectors allow us to refer to elements within a document by type, ID, class, attributes, and position within the document. The querySelector() method takes a CSS selector string as its argument and returns the first matching element in the document that it finds, or returns null if none match:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Find the document element for the HTML tag with attribute id=&quot;spinner&quot;</span></span><br><span class="line"><span class="keyword">let</span> spinner = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#spinner&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>querySelectorAll() is similar, but it returns all matching elements in the document rather than just returning the first:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Find all Element objects for &lt;h1&gt;, &lt;h2&gt;, and &lt;h3&gt; tags</span></span><br><span class="line"><span class="keyword">let</span> titles = <span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&quot;h1, h2, h3&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>The return value of querySelectorAll() is not an array of Element objects. Instead, it is an array-like object known as a NodeList. NodeList objects have a length property and can be indexed like arrays, so you can loop over them with a traditional for loop. NodeLists are also iterable, so you can use them with for&#x2F;of loops as well. If you want to convert a NodeList into a true array, simply pass it to Array.from().</p>
<p>The NodeList returned by querySelectorAll() will have a length property set to 0 if there are not any elements in the document that match the specified selector.</p>
<p>querySelector() and querySelectorAll() are implemented by the Element class as well as by the Document class. When invoked on an element, these methods will only return elements that are descendants of that element.</p>
<p>Note that CSS defines ::first-line and ::first-letter pseudoelements. In CSS, these match portions of text nodes rather than actual elements. They will not match if used with querySelectorAll() or querySelector(). Also, many browsers will refuse to return matches for the :link and :visited pseudoclasses, as this could expose information about the userâ€™s browsing history.</p>
<p>Another CSS-based element selection method is closest(). This method is defined by the Element class and takes a selector as its only argument. If the selector matches the element it is invoked on, it returns that element. Otherwise, it returns the closest ancestor element that the selector matches, or returns null if none matched. In a sense, closest() is the opposite of querySelector(): closest() starts at an element and looks for a match above it in the tree, while querySelector() starts with an element and looks for a match below it in the tree. closest() can be useful when you have registered an event handler at a high level in the document tree. If you are handling a â€œclickâ€ event, for example, you might want to know whether it is a click a hyperlink. The event object will tell you what the target was, but that target might be the text inside a link rather than the hyperlinkâ€™s <code>&lt;a&gt;</code> tag itself. Your event handler could look for the nearest containing hyperlink like this:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Find the closest enclosing &lt;a&gt; tag that has an href attribute.</span></span><br><span class="line"><span class="keyword">let</span> hyperlink = event.<span class="property">target</span>.<span class="title function_">closest</span>(<span class="string">&quot;a[href]&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>Here is another way you might use closest():</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Return true if the element e is inside of an HTML list element</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">insideList</span>(<span class="params">e</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> e.<span class="title function_">closest</span>(<span class="string">&quot;ul,ol,dl&quot;</span>) !== <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The related method matches() does not return ancestors or descendants: it simply tests whether an element is matched by a CSS selector and returns true if so and false otherwise:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Return true if e is an HTML heading element</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">isHeading</span>(<span class="params">e</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> e.<span class="title function_">matches</span>(<span class="string">&quot;h1,h2,h3,h4,h5,h6&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>OTHER ELEMENT SELECTION METHODS<br>In addition to querySelector() and querySelectorAll(), the DOM also defines a number of older element selection methods that are more or less obsolete now. You may still see some of these methods (especially getElementById()) in use, however:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Look up an element by id. The argument is just the id, without</span></span><br><span class="line"><span class="comment">// the CSS selector prefix #. Similar to document.querySelector(&quot;#sect1&quot;)</span></span><br><span class="line"><span class="keyword">let</span> sect1 = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;sect1&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Look up all elements (such as form checkboxes) that have a name=&quot;color&quot;</span></span><br><span class="line"><span class="comment">// attribute. Similar to document.querySelectorAll(&#x27;*[name=&quot;color&quot;]&#x27;);</span></span><br><span class="line"><span class="keyword">let</span> colors = <span class="variable language_">document</span>.<span class="title function_">getElementsByName</span>(<span class="string">&quot;color&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Look up all &lt;h1&gt; elements in the document.</span></span><br><span class="line"><span class="comment">// Similar to document.querySelectorAll(&quot;h1&quot;)</span></span><br><span class="line"><span class="keyword">let</span> headings = <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&quot;h1&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// getElementsByTagName() is also defined on elements.</span></span><br><span class="line"><span class="comment">// Get all &lt;h2&gt; elements within the sect1 element.</span></span><br><span class="line"><span class="keyword">let</span> subheads = sect1.<span class="title function_">getElementsByTagName</span>(<span class="string">&quot;h2&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Look up all elements that have class &quot;tooltip.&quot;</span></span><br><span class="line"><span class="comment">// Similar to document.querySelectorAll(&quot;.tooltip&quot;)</span></span><br><span class="line"><span class="keyword">let</span> tooltips = <span class="variable language_">document</span>.<span class="title function_">getElementsByClassName</span>(<span class="string">&quot;tooltip&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Look up all descendants of sect1 that have class &quot;sidebar&quot;</span></span><br><span class="line"><span class="comment">// Similar to sect1.querySelectorAll(&quot;.sidebar&quot;)</span></span><br><span class="line"><span class="keyword">let</span> sidebars = sect1.<span class="title function_">getElementsByClassName</span>(<span class="string">&quot;sidebar&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>Like querySelectorAll(), the methods in this code return a NodeList (except for getElementById(), which returns a single Element object). Unlike querySelectorAll(), however, the NodeLists returned by these older selection methods are â€œlive,â€ which means that the length and content of the list can change if the document content or structure changes.</p>
<p>PRESELECTED ELEMENTS<br>For historical reasons, the Document class defines shortcut properties to access certain kinds of nodes. The images, forms, and links properties, for example, provide easy access to the <code>&lt;img&gt;</code>, <code>&lt;form&gt;</code>, and <code>&lt;a&gt;</code> elements (but only <code>&lt;a&gt;</code> tags that have an href attribute) of a document. These properties refer to HTMLCollection objects, which are much like NodeList objects, but they can additionally be indexed by element ID or name. With the document.forms property, for example, you can access the <code>&lt;form id=&quot;address&quot;&gt;</code> tag as:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">document</span>.<span class="property">forms</span>.<span class="property">address</span>;</span><br></pre></td></tr></table></figure>
<p>An even more outdated API for selecting elements is the document.all property, which is like an HTMLCollection for all elements in the document. document.all is deprecated, and you should no longer use it.</p>
<h3 id="15-3-2-Document-Structure-and-Traversal"><a href="#15-3-2-Document-Structure-and-Traversal" class="headerlink" title="15.3.2 Document Structure and Traversal"></a>15.3.2 Document Structure and Traversal</h3><p>Once you have selected an Element from a Document, you sometimes need to find structurally related portions (parent, siblings, children) of the document. When we are primarily interested in the Elements of a document instead of the text within them (and the whitespace between them, which is also text), there is a traversal API that allows us to treat a document as a tree of Element objects, ignoring Text nodes that are also part of the document. This traversal API does not involve any methods; it is simply a set of properties on Element objects that allow us to refer to the parent, children, and siblings of a given element:</p>
<p>parentNode<br>This property of an element refers to the parent of the element, which will be another Element or a Document object.</p>
<p>children<br>This NodeList contains the Element children of an element, but excludes non-Element children like Text nodes (and Comment nodes).</p>
<p>childElementCount<br>The number of Element children. Returns the same value as children.length.</p>
<p>firstElementChild, lastElementChild<br>These properties refer to the first and last Element children of an Element. They are null if the Element has no Element children.</p>
<p>nextElementSibling, previousElementSibling<br>These properties refer to the sibling Elements immediately before or immediately after an Element, or null if there is no such sibling.</p>
<p>Using these Element properties, the second child Element of the first child Element of the Document can be referred to with either of these expressions:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">document</span>.<span class="property">children</span>[<span class="number">0</span>].<span class="property">children</span>[<span class="number">1</span>]</span><br><span class="line"><span class="variable language_">document</span>.<span class="property">firstElementChild</span>.<span class="property">firstElementChild</span>.<span class="property">nextElementSibling</span></span><br></pre></td></tr></table></figure>
<p>(In a standard HTML document, both of those expressions refer to the <code>&lt;body&gt;</code> tag of the document.)</p>
<p>Here are two functions that demonstrate how you can use these properties to recursively do a depth-first traversal of a document invoking a specified function for every element in the document:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Recursively traverse the Document or Element e, invoking the function</span></span><br><span class="line"><span class="comment">// f on e and on each of its descendants</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">traverse</span>(<span class="params">e, f</span>) &#123;</span><br><span class="line">    <span class="title function_">f</span>(e);                             <span class="comment">// Invoke f() on e</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> child <span class="keyword">of</span> e.<span class="property">children</span>) &#123;    <span class="comment">// Iterate over the children</span></span><br><span class="line">        <span class="title function_">traverse</span>(child, f);           <span class="comment">// And recurse on each one</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">traverse2</span>(<span class="params">e, f</span>) &#123;</span><br><span class="line">    <span class="title function_">f</span>(e);                             <span class="comment">// Invoke f() on e</span></span><br><span class="line">    <span class="keyword">let</span> child = e.<span class="property">firstElementChild</span>;  <span class="comment">// Iterate the children linked-list style</span></span><br><span class="line">    <span class="keyword">while</span>(child !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="title function_">traverse2</span>(child, f);          <span class="comment">// And recurse</span></span><br><span class="line">        child = child.<span class="property">nextElementSibling</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>DOCUMENTS AS TREES OF NODES<br>If you want to traverse a document or some portion of a document and do not want to ignore the Text nodes, you can use a different set of properties defined on all Node objects. This will allow you to see Elements, Text nodes, and even Comment nodes (which represent HTML comments in the document).</p>
<p>All Node objects define the following properties:</p>
<p>parentNode<br>The node that is the parent of this one, or null for nodes like the Document object that have no parent.</p>
<p>childNodes<br>A read-only NodeList that that contains all children (not just Element children) of the node.</p>
<p>firstChild, lastChild<br>The first and last child nodes of a node, or null if the node has no children.</p>
<p>nextSibling, previousSibling<br>The next and previous sibling nodes of a node. These properties connect nodes in a doubly linked list.</p>
<p>nodeType<br>A number that specifies what kind of node this is. Document nodes have value 9. Element nodes have value 1. Text nodes have value 3. Comment nodes have value 8.</p>
<p>nodeValue<br>The textual content of a Text or Comment node.</p>
<p>nodeName<br>The HTML tag name of an Element, converted to uppercase.</p>
<p>Using these Node properties, the second child node of the first child of the Document can be referred to with expressions like these:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">document</span>.<span class="property">childNodes</span>[<span class="number">0</span>].<span class="property">childNodes</span>[<span class="number">1</span>]</span><br><span class="line"><span class="variable language_">document</span>.<span class="property">firstChild</span>.<span class="property">firstChild</span>.<span class="property">nextSibling</span></span><br></pre></td></tr></table></figure>
<p>Suppose the document in question is the following:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span><span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">title</span>&gt;</span>Test<span class="tag">&lt;/<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">body</span>&gt;</span>Hello World!<span class="tag">&lt;/<span class="name">body</span>&gt;</span><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Then the second child of the first child is the <code>&lt;body&gt;</code> element. It has a nodeType of 1 and a nodeName of â€œBODYâ€.</p>
<p>Note, however, that this API is extremely sensitive to variations in the document text. If the document is modified by inserting a single newline between the <code>&lt;html&gt;</code> and the <code>&lt;head&gt;</code> tag, for example, the Text node that represents that newline becomes the first child of the first child, and the second child is the <code>&lt;head&gt;</code> element instead of the <code>&lt;body&gt;</code> element.</p>
<p>To demonstrate this Node-based traversal API, here is a function that returns all of the text within an element or document:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Return the plain-text content of element e, recursing into child elements.</span></span><br><span class="line"><span class="comment">// This method works like the textContent property</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">textContent</span>(<span class="params">e</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> s = <span class="string">&quot;&quot;</span>;                        <span class="comment">// Accumulate the text here</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> child = e.<span class="property">firstChild</span>; child !== <span class="literal">null</span>; child = child.<span class="property">nextSibling</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> type = child.<span class="property">nodeType</span>;</span><br><span class="line">        <span class="keyword">if</span> (type === <span class="number">3</span>) &#123;              <span class="comment">// If it is a Text node</span></span><br><span class="line">            s += child.<span class="property">nodeValue</span>;      <span class="comment">// add the text content to our string.</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type === <span class="number">1</span>) &#123;       <span class="comment">// And if it is an Element node</span></span><br><span class="line">            s += <span class="title function_">textContent</span>(child);   <span class="comment">// then recurse.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This function is a demonstration onlyâ€”in practice, you would simply write e.textContent to obtain the textual content of the element e.</p>
<h3 id="15-3-3-Attributes"><a href="#15-3-3-Attributes" class="headerlink" title="15.3.3 Attributes"></a>15.3.3 Attributes</h3><p>HTML elements consist of a tag name and a set of name&#x2F;value pairs known as attributes. The <code>&lt;a&gt;</code> element that defines a hyperlink, for example, uses the value of its href attribute as the destination of the link.</p>
<p>The Element class defines general getAttribute(), setAttribute(), hasAttribute(), and removeAttribute() methods for querying, setting, testing, and removing the attributes of an element. But the attribute values of HTML elements (for all standard attributes of standard HTML elements) are available as properties of the HTMLElement objects that represent those elements, and it is usually much easier to work with them as JavaScript properties than it is to call getAttribute() and related methods.</p>
<p>HTML ATTRIBUTES AS ELEMENT PROPERTIES<br>The Element objects that represent the elements of an HTML document usually define read&#x2F;write properties that mirror the HTML attributes of the elements. Element defines properties for the universal HTML attributes such as id, title, lang, and dir and event handler properties like onclick. Element-specific subtypes define attributes specific to those elements. To query the URL of an image, for example, you can use the src property of the HTMLElement that represents the <code>&lt;img&gt;</code> element:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> image = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#main_image&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> url = image.<span class="property">src</span>;       <span class="comment">// The src attribute is the URL of the image</span></span><br><span class="line">image.<span class="property">id</span> === <span class="string">&quot;main_image&quot;</span>  <span class="comment">// =&gt; true; we looked up the image by id</span></span><br></pre></td></tr></table></figure>
<p>Similarly, you might set the form-submission attributes of a <code>&lt;form&gt;</code> element with code like this:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> f = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;form&quot;</span>);      <span class="comment">// First &lt;form&gt; in the document</span></span><br><span class="line">f.<span class="property">action</span> = <span class="string">&quot;https://www.example.com/submit&quot;</span>; <span class="comment">// Set the URL to submit it to.</span></span><br><span class="line">f.<span class="property">method</span> = <span class="string">&quot;POST&quot;</span>;                           <span class="comment">// Set the HTTP request type.</span></span><br></pre></td></tr></table></figure>
<p>For some elements, such as the <code>&lt;input&gt;</code> element, some HTML attribute names map to differently named properties. The HTML value attribute of an <code>&lt;input&gt;</code>, for example, is mirrored by the JavaScript defaultValue property. The JavaScript value property of the <code>&lt;input&gt;</code> element contains the userâ€™s current input, but changes to the value property do not affect the defaultValue property nor the value attribute.</p>
<p>HTML attributes are not case sensitive, but JavaScript property names are. To convert an attribute name to the JavaScript property, write it in lowercase. If the attribute is more than one word long, however, put the first letter of each word after the first in uppercase: defaultChecked and tabIndex, for example. Event handler properties like onclick are an exception, however, and are written in lowercase.</p>
<p>Some HTML attribute names are reserved words in JavaScript. For these, the general rule is to prefix the property name with â€œhtmlâ€. The HTML for attribute (of the <code>&lt;label&gt;</code> element), for example, becomes the JavaScript htmlFor property. â€œclassâ€ is a reserved word in JavaScript, and the very important HTML class attribute is an exception to the rule: it becomes className in JavaScript code.</p>
<p>The properties that represent HTML attributes usually have string values. But when the attribute is a boolean or numeric value (the defaultChecked and maxLength attributes of an <code>&lt;input&gt;</code> element, for example), the properties are booleans or numbers instead of strings. Event handler attributes always have functions (or null) as their values.</p>
<p>Note that this property-based API for getting and setting attribute values does not define any way to remove an attribute from an element. In particular, the delete operator cannot be used for this purpose. If you need to delete an attribute, use the removeAttribute() method.</p>
<p>THE CLASS ATTRIBUTE<br>The class attribute of an HTML element is a particularly important one. Its value is a space-separated list of CSS classes that apply to the element and affect how it is styled with CSS. Because class is a reserved word in JavaScript, the value of this attribute is available through the className property on Element objects. The className property can set and return the value of the class attribute as a string. But the class attribute is poorly named: its value is a list of CSS classes, not a single class, and it is common in client-side JavaScript programming to want to add and remove individual class names from this list rather than work with the list as a single string.</p>
<p>For this reason, Element objects define a classList property that allows you to treat the class attribute as a list. The value of the classList property is an iterable Array-like object. Although the name of the property is classList, it behaves more like a set of classes, and defines add(), remove(), contains(), and toggle() methods:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// When we want to let the user know that we are busy, we display</span></span><br><span class="line"><span class="comment">// a spinner. To do this we have to remove the &quot;hidden&quot; class and add the</span></span><br><span class="line"><span class="comment">// &quot;animated&quot; class (assuming the stylesheets are configured correctly).</span></span><br><span class="line"><span class="keyword">let</span> spinner = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#spinner&quot;</span>);</span><br><span class="line">spinner.<span class="property">classList</span>.<span class="title function_">remove</span>(<span class="string">&quot;hidden&quot;</span>);</span><br><span class="line">spinner.<span class="property">classList</span>.<span class="title function_">add</span>(<span class="string">&quot;animated&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>DATASET ATTRIBUTES<br>It is sometimes useful to attach additional information to HTML elements, typically when JavaScript code will be selecting those elements and manipulating them in some way. In HTML, any attribute whose name is lowercase and begins with the prefix â€œdata-â€ is considered valid, and you can use them for any purpose. These â€œdataset attributesâ€ will not affect the presentation of the elements on which they appear, and they define a standard way to attach additional data without compromising document validity.</p>
<p>In the DOM, Element objects have a dataset property that refers to an object that has properties that correspond to the data- attributes with their prefix removed. Thus, dataset.x would hold the value of the data-x attribute. Hyphenated attributes map to camelCase property names: the attribute data-section-number becomes the property dataset.sectionNumber.</p>
<p>Suppose an HTML document contains this text:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h2</span> <span class="attr">id</span>=<span class="string">&quot;title&quot;</span> <span class="attr">data-section-number</span>=<span class="string">&quot;16.1&quot;</span>&gt;</span>Attributes<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Then you could write JavaScript like this to access that section number:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> number = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#title&quot;</span>).<span class="property">dataset</span>.<span class="property">sectionNumber</span>;</span><br></pre></td></tr></table></figure>
<h3 id="15-3-4-Element-Content"><a href="#15-3-4-Element-Content" class="headerlink" title="15.3.4 Element Content"></a>15.3.4 Element Content</h3><p>Look again at the document tree pictured in Figure 15-1, and ask yourself what the â€œcontentâ€ of the <code>&lt;p&gt;</code> element is. There are two ways we might answer this question:</p>
<ul>
<li>The content is the HTML string â€œThis is a <code>&lt;i&gt;</code>simple<code>&lt;/i&gt;</code> documentâ€.</li>
<li>The content is the plain-text string â€œThis is a simple documentâ€.</li>
</ul>
<p>Both of these are valid answers, and each answer is useful in its own way. The sections that follow explain how to work with the HTML representation and the plain-text representation of an elementâ€™s content.</p>
<p>ELEMENT CONTENT AS HTML<br>Reading the innerHTML property of an Element returns the content of that element as a string of markup. Setting this property on an element invokes the web browserâ€™s parser and replaces the elementâ€™s current content with a parsed representation of the new string. You can test this out by opening the developer console and typing:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">document</span>.<span class="property">body</span>.<span class="property">innerHTML</span> = <span class="string">&quot;&lt;h1&gt;Oops&lt;/h1&gt;&quot;</span>;</span><br></pre></td></tr></table></figure>
<p>You will see that the entire web page disappears and is replaced with the single heading, â€œOopsâ€. Web browsers are very good at parsing HTML, and setting innerHTML is usually fairly efficient. Note, however, that appending text to the innerHTML property with the +&#x3D; operator is not efficient because it requires both a serialization step to convert element content to a string and then a parsing step to convert the new string back into element content.</p>
<p>WARNING<br>When using these HTML APIs, it is very important that you never insert user input into the document. If you do this, you allow malicious users to inject their own scripts into your application. See â€œCross-site scriptingâ€ for details.</p>
<p>The outerHTML property of an Element is like innerHTML except that its value includes the element itself. When you query outerHTML, the value includes the opening and closing tags of the element. And when you set outerHTML on an element, the new content replaces the element itself.</p>
<p>A related Element method is insertAdjacentHTML(), which allows you to insert a string of arbitrary HTML markup â€œadjacentâ€ to the specified element. The markup is passed as the second argument to this method, and the precise meaning of â€œadjacentâ€ depends on the value of the first argument. This first argument should be a string with one of the values â€œbeforebegin,â€ â€œafterbegin,â€ â€œbeforeend,â€ or â€œafterend.â€ These values correspond to insertion points that are illustrated in Figure 15-2.</p>
<p><Figures figure="15-2">Insertion points for insertAdjacentHTML()</Figures></p>
<h4 id="ELEMENT-CONTENT-AS-PLAIN-TEXT"><a href="#ELEMENT-CONTENT-AS-PLAIN-TEXT" class="headerlink" title="ELEMENT CONTENT AS PLAIN TEXT"></a>ELEMENT CONTENT AS PLAIN TEXT</h4><p>Sometimes you want to query the content of an element as plain text or to insert plain text into a document (without having to escape the angle brackets and ampersands used in HTML markup). The standard way to do this is with the textContent property:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> para = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;p&quot;</span>); <span class="comment">// First &lt;p&gt; in the document</span></span><br><span class="line"><span class="keyword">let</span> text = para.<span class="property">textContent</span>;            <span class="comment">// Get the text of the paragraph</span></span><br><span class="line">para.<span class="property">textContent</span> = <span class="string">&quot;Hello World!&quot;</span>;      <span class="comment">// Alter the text of the paragraph</span></span><br></pre></td></tr></table></figure>
<p>The textContent property is defined by the Node class, so it works for Text nodes as well as Element nodes. For Element nodes, it finds and returns all text in all descendants of the element.</p>
<p>The Element class defines an innerText property that is similar to textContent. innerText has some unusual and complex behaviors, such as attempting to preserve table formatting. It is not well specified nor implemented compatibly between browsers, however, and should no longer be used.</p>
<p>TEXT IN <code>&lt;SCRIPT&gt;</code> ELEMENTS<br>Inline <code>&lt;script&gt;</code> elements (i.e., those that do not have a src attribute) have a text property that you can use to retrieve their text. The content of a <code>&lt;script&gt;</code> element is never displayed by the browser, and the HTML parser ignores angle brackets and ampersands within a script. This makes a <code>&lt;script&gt;</code> element an ideal place to embed arbitrary textual data for use by your application. Simply set the type attribute of the element to some value (such as â€œtext&#x2F;x-custom-dataâ€) that makes it clear that the script is not executable JavaScript code. If you do this, the JavaScript interpreter will ignore the script, but the element will exist in the document tree, and its text property will return the data to you.</p>
<h3 id="15-3-5-Creating-Inserting-and-Deleting-Nodes"><a href="#15-3-5-Creating-Inserting-and-Deleting-Nodes" class="headerlink" title="15.3.5 Creating, Inserting, and Deleting Nodes"></a>15.3.5 Creating, Inserting, and Deleting Nodes</h3><p>Weâ€™ve seen how to query and alter document content using strings of HTML and of plain text. And weâ€™ve also seen that we can traverse a Document to examine the individual Element and Text nodes that it is made of. It is also possible to alter a document at the level of individual nodes. The Document class defines methods for creating Element objects, and Element and Text objects have methods for inserting, deleting, and replacing nodes in the tree.</p>
<p>Create a new element with the createElement() method of the Document class and append strings of text or other elements to it with its append() and prepend() methods:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> paragraph = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;p&quot;</span>); <span class="comment">// Create an empty &lt;p&gt; element</span></span><br><span class="line"><span class="keyword">let</span> emphasis = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;em&quot;</span>); <span class="comment">// Create an empty &lt;em&gt; element</span></span><br><span class="line">emphasis.<span class="title function_">append</span>(<span class="string">&quot;World&quot;</span>);                    <span class="comment">// Add text to the &lt;em&gt; element</span></span><br><span class="line">paragraph.<span class="title function_">append</span>(<span class="string">&quot;Hello &quot;</span>, emphasis, <span class="string">&quot;!&quot;</span>);   <span class="comment">// Add text and &lt;em&gt; to &lt;p&gt;</span></span><br><span class="line">paragraph.<span class="title function_">prepend</span>(<span class="string">&quot;Â¡&quot;</span>);                      <span class="comment">// Add more text at start of &lt;p&gt;</span></span><br><span class="line">paragraph.<span class="property">innerHTML</span>                          <span class="comment">// =&gt; &quot;Â¡Hello &lt;em&gt;World&lt;/em&gt;!&quot;</span></span><br></pre></td></tr></table></figure>
<p>append() and prepend() take any number of arguments, which can be Node objects or strings. String arguments are automatically converted to Text nodes. (You can create Text nodes explicitly with document.createTextNode(), but there is rarely any reason to do so.) append() adds the arguments to the element at the end of the child list. prepend() adds the arguments at the start of the child list.</p>
<p>If you want to insert an Element or Text node into the middle of the containing elementâ€™s child list, then neither append() or prepend() will work for you. In this case, you should obtain a reference to a sibling node and call before() to insert the new content before that sibling or after() to insert it after that sibling. For example:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Find the heading element with class=&quot;greetings&quot;</span></span><br><span class="line"><span class="keyword">let</span> greetings = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;h2.greetings&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Now insert the new paragraph and a horizontal rule after that heading</span></span><br><span class="line">greetings.<span class="title function_">after</span>(paragraph, <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;hr&quot;</span>));</span><br></pre></td></tr></table></figure>
<p>Like append() and prepend(), after() and before() take any number of string and element arguments and insert them all into the document after converting strings to Text nodes. append() and prepend() are only defined on Element objects, but after() and before() work on both Element and Text nodes: you can use them to insert content relative to a Text node.</p>
<p>Note that elements can only be inserted at one spot in the document. If an element is already in the document and you insert it somewhere else, it will be moved to the new location, not copied:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// We inserted the paragraph after this element, but now we</span></span><br><span class="line"><span class="comment">// move it so it appears before the element instead</span></span><br><span class="line">greetings.<span class="title function_">before</span>(paragraph);</span><br></pre></td></tr></table></figure>
<p>If you do want to make a copy of an element, use the cloneNode() method, passing true to copy all of its content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Make a copy of the paragraph and insert it after the greetings element</span></span><br><span class="line">greetings.<span class="title function_">after</span>(paragraph.<span class="title function_">cloneNode</span>(<span class="literal">true</span>));</span><br></pre></td></tr></table></figure>
<p>You can remove an Element or Text node from the document by calling its remove() method, or you can replace it by calling replaceWith() instead. remove() takes no arguments, and replaceWith() takes any number of strings and elements just like before() and after() do:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Remove the greetings element from the document and replace it with</span></span><br><span class="line"><span class="comment">// the paragraph element (moving the paragraph from its current location</span></span><br><span class="line"><span class="comment">// if it is already inserted into the document).</span></span><br><span class="line">greetings.<span class="title function_">replaceWith</span>(paragraph);</span><br><span class="line"></span><br><span class="line"><span class="comment">// And now remove the paragraph.</span></span><br><span class="line">paragraph.<span class="title function_">remove</span>();</span><br></pre></td></tr></table></figure>
<p>The DOM API also defines an older generation of methods for inserting and removing content. appendChild(), insertBefore(), replaceChild(), and removeChild() are harder to use than the methods shown here and should never be needed.</p>
<h3 id="15-3-6-Example-Generating-a-Table-of-Contents"><a href="#15-3-6-Example-Generating-a-Table-of-Contents" class="headerlink" title="15.3.6 Example: Generating a Table of Contents"></a>15.3.6 Example: Generating a Table of Contents</h3><p>Example 15-1 shows how to dynamically create a table of contents for a document. It demonstrates many of the document scripting techniques described in the previous sections. The example is well commented, and you should have no trouble following the code.</p>
<p>Example 15-1. Generating a table of contents with the DOM API</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * TOC.js: create a table of contents for a document.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This script runs when the DOMContentLoaded event is fired and</span></span><br><span class="line"><span class="comment"> * automatically generates a table of contents for the document.</span></span><br><span class="line"><span class="comment"> * It does not define any global symbols so it should not conflict</span></span><br><span class="line"><span class="comment"> * with other scripts.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * When this script runs, it first looks for a document element with</span></span><br><span class="line"><span class="comment"> * an id of &quot;TOC&quot;. If there is no such element it creates one at the</span></span><br><span class="line"><span class="comment"> * start of the document. Next, the function finds all &lt;h2&gt; through</span></span><br><span class="line"><span class="comment"> * &lt;h6&gt; tags, treats them as section titles, and creates a table of</span></span><br><span class="line"><span class="comment"> * contents within the TOC element. The function adds section numbers</span></span><br><span class="line"><span class="comment"> * to each section heading and wraps the headings in named anchors so</span></span><br><span class="line"><span class="comment"> * that the TOC can link to them. The generated anchors have names</span></span><br><span class="line"><span class="comment"> * that begin with &quot;TOC&quot;, so you should avoid this prefix in your own</span></span><br><span class="line"><span class="comment"> * HTML.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The entries in the generated TOC can be styled with CSS. All</span></span><br><span class="line"><span class="comment"> * entries have a class &quot;TOCEntry&quot;. Entries also have a class that</span></span><br><span class="line"><span class="comment"> * corresponds to the level of the section heading. &lt;h1&gt; tags generate</span></span><br><span class="line"><span class="comment"> * entries of class &quot;TOCLevel1&quot;, &lt;h2&gt; tags generate entries of class</span></span><br><span class="line"><span class="comment"> * &quot;TOCLevel2&quot;, and so on. Section numbers inserted into headings have</span></span><br><span class="line"><span class="comment"> * class &quot;TOCSectNum&quot;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * You might use this script with a stylesheet like this:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *   #TOC &#123; border: solid black 1px; margin: 10px; padding: 10px; &#125;</span></span><br><span class="line"><span class="comment"> *   .TOCEntry &#123; margin: 5px 0px; &#125;</span></span><br><span class="line"><span class="comment"> *   .TOCEntry a &#123; text-decoration: none; &#125;</span></span><br><span class="line"><span class="comment"> *   .TOCLevel1 &#123; font-size: 16pt; font-weight: bold; &#125;</span></span><br><span class="line"><span class="comment"> *   .TOCLevel2 &#123; font-size: 14pt; margin-left: .25in; &#125;</span></span><br><span class="line"><span class="comment"> *   .TOCLevel3 &#123; font-size: 12pt; margin-left: .5in; &#125;</span></span><br><span class="line"><span class="comment"> *   .TOCSectNum:after &#123; content: &quot;: &quot;; &#125;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * To hide the section numbers, use this:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *   .TOCSectNum &#123; display: none &#125;</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;DOMContentLoaded&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// Find the TOC container element.</span></span><br><span class="line">    <span class="comment">// If there isn&#x27;t one, create one at the start of the document.</span></span><br><span class="line">    <span class="keyword">let</span> toc = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#TOC&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!toc) &#123;</span><br><span class="line">        toc = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;div&quot;</span>);</span><br><span class="line">        toc.<span class="property">id</span> = <span class="string">&quot;TOC&quot;</span>;</span><br><span class="line">        <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">prepend</span>(toc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Find all section heading elements. We&#x27;re assuming here that the</span></span><br><span class="line">    <span class="comment">// document title uses &lt;h1&gt; and that sections within the document are</span></span><br><span class="line">    <span class="comment">// marked with &lt;h2&gt; through &lt;h6&gt;.</span></span><br><span class="line">    <span class="keyword">let</span> headings = <span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&quot;h2,h3,h4,h5,h6&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialize an array that keeps track of section numbers.</span></span><br><span class="line">    <span class="keyword">let</span> sectionNumbers = [<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Now loop through the section header elements we found.</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> heading <span class="keyword">of</span> headings) &#123;</span><br><span class="line">        <span class="comment">// Skip the heading if it is inside the TOC container.</span></span><br><span class="line">        <span class="keyword">if</span> (heading.<span class="property">parentNode</span> === toc) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Figure out what level heading it is.</span></span><br><span class="line">        <span class="comment">// Subtract 1 because &lt;h2&gt; is a level-1 heading.</span></span><br><span class="line">        <span class="keyword">let</span> level = <span class="built_in">parseInt</span>(heading.<span class="property">tagName</span>.<span class="title function_">charAt</span>(<span class="number">1</span>)) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Increment the section number for this heading level</span></span><br><span class="line">        <span class="comment">// and reset all lower heading level numbers to zero.</span></span><br><span class="line">        sectionNumbers[level-<span class="number">1</span>]++;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> i = level; i &lt; sectionNumbers.<span class="property">length</span>; i++) &#123;</span><br><span class="line">            sectionNumbers[i] = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Now combine section numbers for all heading levels</span></span><br><span class="line">        <span class="comment">// to produce a section number like 2.3.1.</span></span><br><span class="line">        <span class="keyword">let</span> sectionNumber = sectionNumbers.<span class="title function_">slice</span>(<span class="number">0</span>, level).<span class="title function_">join</span>(<span class="string">&quot;.&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Add the section number to the section header title.</span></span><br><span class="line">        <span class="comment">// We place the number in a &lt;span&gt; to make it styleable.</span></span><br><span class="line">        <span class="keyword">let</span> span = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;span&quot;</span>);</span><br><span class="line">        span.<span class="property">className</span> = <span class="string">&quot;TOCSectNum&quot;</span>;</span><br><span class="line">        span.<span class="property">textContent</span> = sectionNumber;</span><br><span class="line">        heading.<span class="title function_">prepend</span>(span);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Wrap the heading in a named anchor so we can link to it.</span></span><br><span class="line">        <span class="keyword">let</span> anchor = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">        <span class="keyword">let</span> fragmentName = <span class="string">`TOC<span class="subst">$&#123;sectionNumber&#125;</span>`</span>;</span><br><span class="line">        anchor.<span class="property">name</span> = fragmentName;</span><br><span class="line">        heading.<span class="title function_">before</span>(anchor);    <span class="comment">// Insert anchor before heading</span></span><br><span class="line">        anchor.<span class="title function_">append</span>(heading);    <span class="comment">// and move heading inside anchor</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Now create a link to this section.</span></span><br><span class="line">        <span class="keyword">let</span> link = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">        link.<span class="property">href</span> = <span class="string">`#<span class="subst">$&#123;fragmentName&#125;</span>`</span>;     <span class="comment">// Link destination</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Copy the heading text into the link. This is a safe use of</span></span><br><span class="line">        <span class="comment">// innerHTML because we are not inserting any untrusted strings.</span></span><br><span class="line">        link.<span class="property">innerHTML</span> = heading.<span class="property">innerHTML</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Place the link in a div that is styleable based on the level.</span></span><br><span class="line">        <span class="keyword">let</span> entry = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;div&quot;</span>);</span><br><span class="line">        entry.<span class="property">classList</span>.<span class="title function_">add</span>(<span class="string">&quot;TOCEntry&quot;</span>, <span class="string">`TOCLevel<span class="subst">$&#123;level&#125;</span>`</span>);</span><br><span class="line">        entry.<span class="title function_">append</span>(link);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// And add the div to the TOC container.</span></span><br><span class="line">        toc.<span class="title function_">append</span>(entry);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="15-4-Scripting-CSS"><a href="#15-4-Scripting-CSS" class="headerlink" title="15.4 Scripting CSS"></a>15.4 Scripting CSS</h2><p>Weâ€™ve seen that JavaScript can control the logical structure and content of HTML documents. It can also control the visual appearance and layout of those documents by scripting CSS. The following subsections explain a few different techniques that JavaScript code can use to work with CSS.</p>
<p>This is a book about JavaScript, not about CSS, and this section assumes that you already have a working knowledge of how CSS is used to style HTML content. But itâ€™s worth mentioning some of the CSS styles that are commonly scripted from JavaScript:</p>
<ul>
<li>Setting the display style to â€œnoneâ€ hides an element. You can later show the element by setting display to some other value.</li>
<li>You can dynamically position elements by setting the position style to â€œabsolute,â€ â€œrelative,â€ or â€œfixedâ€ and then setting the top and left styles to the desired coordinates. This is important when using JavaScript to display dynamic content like modal dialogues and tooltips.</li>
<li>You can shift, scale, and rotate elements with the transform style.</li>
<li>You can animate changes to other CSS styles with the transition style. These animations are handled automatically by the web browser and do not require JavaScript, but you can use JavaScript to initiate the animations.</li>
</ul>
<h3 id="15-4-1-CSS-Classes"><a href="#15-4-1-CSS-Classes" class="headerlink" title="15.4.1 CSS Classes"></a>15.4.1 CSS Classes</h3><p>The simplest way to use JavaScript to affect the styling of document content is to add and remove CSS class names from the class attribute of HTML tags. This is easy to do with the classList property of Element objects, as explained in â€œThe class attributeâ€.</p>
<p>Suppose, for example, that your documentâ€™s stylesheet includes a definition for a â€œhiddenâ€ class:</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.hidden</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>:none;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>With this style defined, you can hide (and then show) an element with code like this:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Assume that this &quot;tooltip&quot; element has class=&quot;hidden&quot; in the HTML file.</span></span><br><span class="line"><span class="comment">// We can make it visible like this:</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#tooltip&quot;</span>).<span class="property">classList</span>.<span class="title function_">remove</span>(<span class="string">&quot;hidden&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// And we can hide it again like this:</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#tooltip&quot;</span>).<span class="property">classList</span>.<span class="title function_">add</span>(<span class="string">&quot;hidden&quot;</span>);</span><br></pre></td></tr></table></figure>
<h3 id="15-4-2-Inline-Styles"><a href="#15-4-2-Inline-Styles" class="headerlink" title="15.4.2 Inline Styles"></a>15.4.2 Inline Styles</h3><p>To continue with the preceding tooltip example, suppose that the document is structured with only a single tooltip element, and we want to dynamically position it before displaying it. In general, we canâ€™t create a different stylesheet class for each possible position of the tooltip, so the classList property wonâ€™t help us with positioning.</p>
<p>In this case, we need to script the style attribute of the tooltip element to set inline styles that are specific to that one element. The DOM defines a style property on all Element objects that correspond to the style attribute. Unlike most such properties, however, the style property is not a string. Instead, it is a CSSStyleDeclaration object: a parsed representation of the CSS styles that appear in textual form in the style attribute. To display and set the position of our hypothetical tooltip with JavaScript, we might use code like this:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">displayAt</span>(<span class="params">tooltip, x, y</span>) &#123;</span><br><span class="line">    tooltip.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&quot;block&quot;</span>;</span><br><span class="line">    tooltip.<span class="property">style</span>.<span class="property">position</span> = <span class="string">&quot;absolute&quot;</span>;</span><br><span class="line">    tooltip.<span class="property">style</span>.<span class="property">left</span> = <span class="string">`<span class="subst">$&#123;x&#125;</span>px`</span>;</span><br><span class="line">    tooltip.<span class="property">style</span>.<span class="property">top</span> = <span class="string">`<span class="subst">$&#123;y&#125;</span>px`</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>NAMING CONVENTIONS: CSS PROPERTIES IN JAVASCRIPT<br>Many CSS style properties, such as font-size, contain hyphens in their names. In JavaScript, a hyphen is interpreted as a minus sign and is not allowed in property names or other identifiers. Therefore, the names of the properties of the CSSStyleDeclaration object are slightly different from the names of actual CSS properties. If a CSS property name contains one or more hyphens, the CSSStyleDeclaration property name is formed by removing the hyphens and capitalizing the letter immediately following each hyphen. The CSS property border-left-width is accessed through the JavaScript borderLeftWidth property, for example, and the CSS font-family property is written as fontFamily in JavaScript.</p>
<p>When working with the style properties of the CSSStyleDeclaration object, remember that all values must be specified as strings. In a stylesheet or style attribute, you can write:</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">display</span>: block; <span class="attribute">font-family</span>: sans-serif; <span class="attribute">background-color</span>: <span class="number">#ffffff</span>;</span><br></pre></td></tr></table></figure>
<p>To accomplish the same thing for an element e with JavaScript, you have to quote all of the values:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">e.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&quot;block&quot;</span>;</span><br><span class="line">e.<span class="property">style</span>.<span class="property">fontFamily</span> = <span class="string">&quot;sans-serif&quot;</span>;</span><br><span class="line">e.<span class="property">style</span>.<span class="property">backgroundColor</span> = <span class="string">&quot;#ffffff&quot;</span>;</span><br></pre></td></tr></table></figure>
<p>Note that the semicolons go outside the strings. These are just normal JavaScript semicolons; the semicolons you use in CSS stylesheets are not required as part of the string values you set with JavaScript.</p>
<p>Furthermore, remember that many CSS properties require units such as â€œpxâ€ for pixels or â€œptâ€ for points. Thus, it is not correct to set the marginLeft property like this:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">e.<span class="property">style</span>.<span class="property">marginLeft</span> = <span class="number">300</span>;    <span class="comment">// Incorrect: this is a number, not a string</span></span><br><span class="line">e.<span class="property">style</span>.<span class="property">marginLeft</span> = <span class="string">&quot;300&quot;</span>;  <span class="comment">// Incorrect: the units are missing</span></span><br></pre></td></tr></table></figure>
<p>Units are required when setting style properties in JavaScript, just as they are when setting style properties in stylesheets. The correct way to set the value of the marginLeft property of an element e to 300 pixels is:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">e.<span class="property">style</span>.<span class="property">marginLeft</span> = <span class="string">&quot;300px&quot;</span>;</span><br></pre></td></tr></table></figure>
<p>If you want to set a CSS property to a computed value, be sure to append the units at the end of the computation:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">e.<span class="property">style</span>.<span class="property">left</span> = <span class="string">`<span class="subst">$&#123;x0 + left_border + left_padding&#125;</span>px`</span>;</span><br></pre></td></tr></table></figure>
<p>Recall that some CSS properties, such as margin, are shortcuts for other properties, such as margin-top, margin-right, margin-bottom, and margin-left. The CSSStyleDeclaration object has properties that correspond to these shortcut properties. For example, you might set the margin property like this:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">e.<span class="property">style</span>.<span class="property">margin</span> = <span class="string">`<span class="subst">$&#123;top&#125;</span>px <span class="subst">$&#123;right&#125;</span>px <span class="subst">$&#123;bottom&#125;</span>px <span class="subst">$&#123;left&#125;</span>px`</span>;</span><br></pre></td></tr></table></figure>
<p>Sometimes, you may find it easier to set or query the inline style of an element as a single string value rather than as a CSSStyleDeclaration object. To do that, you can use the Element getAttribute() and setAttribute() methods, or you can use the cssText property of the CSSStyleDeclaration object:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Copy the inline styles of element e to element f:</span></span><br><span class="line">f.<span class="title function_">setAttribute</span>(<span class="string">&quot;style&quot;</span>, e.<span class="title function_">getAttribute</span>(<span class="string">&quot;style&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// Or do it like this:</span></span><br><span class="line">f.<span class="property">style</span>.<span class="property">cssText</span> = e.<span class="property">style</span>.<span class="property">cssText</span>;</span><br></pre></td></tr></table></figure>
<p>When querying the style property of an element, keep in mind that it represents only the inline styles of an element and that most styles for most elements are specified in stylesheets rather than inline. Furthermore, the values you obtain when querying the style property will use whatever units and whatever shortcut property format is actually used on the HTML attribute, and your code may have to do some sophisticated parsing to interpret them. In general, if you want to query the styles of an element, you probably want the computed style, which is discussed next.</p>
<h3 id="15-4-3-Computed-Styles"><a href="#15-4-3-Computed-Styles" class="headerlink" title="15.4.3 Computed Styles"></a>15.4.3 Computed Styles</h3><p>The computed style for an element is the set of property values that the browser derives (or computes) from the elementâ€™s inline style plus all applicable style rules in all stylesheets: it is the set of properties actually used to display the element. Like inline styles, computed styles are represented with a CSSStyleDeclaration object. Unlike inline styles, however, computed styles are read-only. You canâ€™t set these styles, but the computed CSSStyleDeclaration object for an element lets you determine what style property values the browser used when rendering that element.</p>
<p>Obtain the computed style for an element with the getComputedStyle() method of the Window object. The first argument to this method is the element whose computed style is desired. The optional second argument is used to specify a CSS pseudoelement, such as â€œ::beforeâ€ or â€œ::afterâ€:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> title = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#section1title&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> styles = <span class="variable language_">window</span>.<span class="title function_">getComputedStyle</span>(title);</span><br><span class="line"><span class="keyword">let</span> beforeStyles = <span class="variable language_">window</span>.<span class="title function_">getComputedStyle</span>(title, <span class="string">&quot;::before&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>The return value of getComputedStyle() is a CSSStyleDeclaration object that represents all the styles that apply to the specified element (or pseudoelement). There are a number of important differences between a CSSStyleDeclaration object that represents inline styles and one that represents computed styles:</p>
<p>Computed style properties are read-only.</p>
<p>Computed style properties are absolute: relative units like percentages and points are converted to absolute values. Any property that specifies a size (such as a margin size or a font size) will have a value measured in pixels. This value will be a string with a â€œpxâ€ suffix, so youâ€™ll still need to parse it, but you wonâ€™t have to worry about parsing or converting other units. Properties whose values are colors will be returned in â€œrgb()â€ or â€œrgba()â€ format.</p>
<p>Shortcut properties are not computedâ€”only the fundamental properties that they are based on are. Donâ€™t query the margin property, for example, but use marginLeft, marginTop, and so on. Similarly, donâ€™t query border or even borderWidth. Instead, use borderLeftWidth, borderTopWidth, and so on.</p>
<p>The cssText property of the computed style is undefined.</p>
<p>A CSSStyleDeclaration object returned by getComputedStyle() generally contains much more information about an element than the CSSStyleDeclaration obtained from the inline style property of that element. But computed styles can be tricky, and querying them does not always provide the information you might expect. Consider the font-family attribute: it accepts a comma-separated list of desired font families for cross-platform portability. When you query the fontFamily property of a computed style, youâ€™re simply getting the value of the most specific font-family style that applies to the element. This may return a value such as â€œarial,helvetica,sans-serif,â€ which does not tell you which typeface is actually in use. Similarly, if an element is not absolutely positioned, attempting to query its position and size through the top and left properties of its computed style often returns the value auto. This is a perfectly legal CSS value, but it is probably not what you were looking for.</p>
<p>Although CSS can be used to precisely specify the position and size of document elements, querying the computed style of an element is not the preferred way to determine the elementâ€™s size and position. See Â§15.5.2 for a simpler, portable alternative.</p>
<h3 id="15-4-4-Scripting-Stylesheets"><a href="#15-4-4-Scripting-Stylesheets" class="headerlink" title="15.4.4 Scripting Stylesheets"></a>15.4.4 Scripting Stylesheets</h3><p>In addition to scripting class attributes and inline styles, JavaScript can also manipulate stylesheets themselves. Stylesheets are associated with an HTML document with a <code>&lt;style&gt;</code> tag or with a <code>&lt;link rel=&quot;stylesheet&quot;&gt;</code> tag. Both of these are regular HTML tags, so you can give them both id attributes and then look them up with document.querySelector().</p>
<p>The Element objects for both <code>&lt;style&gt;</code> and <code>&lt;link&gt;</code> tags have a disabled property that you can use to disable the entire stylesheet. You might use it with code like this:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This function switches between the &quot;light&quot; and &quot;dark&quot; themes</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">toggleTheme</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> lightTheme = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#light-theme&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> darkTheme = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#dark-theme&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (darkTheme.<span class="property">disabled</span>) &#123;          <span class="comment">// Currently light, switch to dark</span></span><br><span class="line">        lightTheme.<span class="property">disabled</span> = <span class="literal">true</span>;</span><br><span class="line">        darkTheme.<span class="property">disabled</span> = <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;                           <span class="comment">// Currently dark, switch to light</span></span><br><span class="line">        lightTheme.<span class="property">disabled</span> = <span class="literal">false</span>;</span><br><span class="line">        darkTheme.<span class="property">disabled</span> = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Another simple way to script stylesheets is to insert new ones into the document using DOM manipulation techniques weâ€™ve already seen. For example:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">setTheme</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="comment">// Create a new &lt;link rel=&quot;stylesheet&quot;&gt; element to load the named stylesheet</span></span><br><span class="line">    <span class="keyword">let</span> link = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;link&quot;</span>);</span><br><span class="line">    link.<span class="property">id</span> = <span class="string">&quot;theme&quot;</span>;</span><br><span class="line">    link.<span class="property">rel</span> = <span class="string">&quot;stylesheet&quot;</span>;</span><br><span class="line">    link.<span class="property">href</span> = <span class="string">`themes/<span class="subst">$&#123;name&#125;</span>.css`</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Look for an existing link with id &quot;theme&quot;</span></span><br><span class="line">    <span class="keyword">let</span> currentTheme = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#theme&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (currentTheme) &#123;</span><br><span class="line">        <span class="comment">// If there is an existing theme, replace it with the new one.</span></span><br><span class="line">        currentTheme.<span class="title function_">replaceWith</span>(link);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Otherwise, just insert the link to the theme stylesheet.</span></span><br><span class="line">        <span class="variable language_">document</span>.<span class="property">head</span>.<span class="title function_">append</span>(link);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Less subtly, you can also just insert a string of HTML containing a <code>&lt;style&gt;</code> tag into your document. This is a fun trick, for example:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">document</span>.<span class="property">head</span>.<span class="title function_">insertAdjacentHTML</span>(</span><br><span class="line">    <span class="string">&quot;beforeend&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&lt;style&gt;body&#123;transform:rotate(180deg)&#125;&lt;/style&gt;&quot;</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>Browsers define an API that allows JavaScript to look inside stylesheets to query, modify, insert, and delete style rules in that stylesheet. This API is so specialized that it is not documented here. You can read about it on MDN by searching for â€œCSSStyleSheetâ€ and â€œCSS Object Model.â€</p>
<h3 id="15-4-5-CSS-Animations-and-Events"><a href="#15-4-5-CSS-Animations-and-Events" class="headerlink" title="15.4.5 CSS Animations and Events"></a>15.4.5 CSS Animations and Events</h3><p>Suppose you have the following two CSS classes defined in a stylesheet:</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.transparent</span> &#123; <span class="attribute">opacity</span>: <span class="number">0</span>; &#125;</span><br><span class="line"><span class="selector-class">.fadeable</span> &#123; <span class="attribute">transition</span>: opacity .<span class="number">5s</span> ease-in &#125;</span><br></pre></td></tr></table></figure>
<p>If you apply the first style to an element, it will be fully transparent and therefore invisible. But if you apply the second style that tells the browser that when the opacity of the element changes, that change should be animated over a period of 0.5 seconds, â€œease-inâ€ specifies that the opacity change animation should start off slow and then accelerate.</p>
<p>Now suppose that your HTML document contains an element with the â€œfadeableâ€ class:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id=<span class="string">&quot;subscribe&quot;</span> <span class="keyword">class</span>=<span class="string">&quot;fadeable notification&quot;</span>&gt;...&lt;/div&gt;</span><br></pre></td></tr></table></figure>
<p>In JavaScript, you can add the â€œtransparentâ€ class:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#subscribe&quot;</span>).<span class="property">classList</span>.<span class="title function_">add</span>(<span class="string">&quot;transparent&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>This element is configured to animate opacity changes. Adding the â€œtransparentâ€ class changes the opacity and triggers an animate: the browser â€œfades outâ€ the element so that it becomes fully transparent over the period of half a second.</p>
<p>This works in reverse as well: if you remove the â€œtransparentâ€ class of a â€œfadeableâ€ element, that is also an opacity change, and the element fades back in and becomes visible again.</p>
<p>JavaScript does not have to do any work to make these animations happen: they are a pure CSS effect. But JavaScript can be used to trigger them.</p>
<p>JavaScript can also be used to monitor the progress of a CSS transition because the web browser fires events at the start and end of a transition. The â€œtransitionrunâ€ event is dispatched when the transition is first triggered. This may happen before any visual changes begin, when the transition-delay style has been specified. Once the visual changes begin a â€œtransitionstartâ€ event is dispatched, and when the animation is complete, a â€œtransitionendâ€ event is dispatched. The target of all these events is the element being animated, of course. The event object passed to handlers for these events is a TransitionEvent object. It has a propertyName property that specifies the CSS property being animated and an elapsedTime property that for â€œtransitionendâ€ events specifies how many seconds have passed since the â€œtransitionstartâ€ event.</p>
<p>In addition to transitions, CSS also supports a more complex form of animation known simply as â€œCSS Animations.â€ These use CSS properties such as animation-name and animation-duration and a special @keyframes rule to define animation details. Details of how CSS animations work are beyond the scope of this book, but once again, if you define all of the animation properties on a CSS class, then you can use JavaScript to trigger the animation simply by adding the class to the element that is to be animated.</p>
<p>And like CSS transitions, CSS animations also trigger events that your JavaScript code can listen form. â€œanimationstartâ€ is dispatched when the animation starts, and â€œanimationendâ€ is dispatched when it is complete. If the animation repeats more than once, then an â€œanimationiterationâ€ event is dispatched after each repetition except the last. The event target is the animated element, and the event object passed to handler functions is an AnimationEvent object. These events include an animationName property that specifies the animation-name property that defines the animation and an elapsedTime property that specifies how many seconds have passed since the animation started.</p>
<h2 id="15-5-Document-Geometry-and-Scrolling"><a href="#15-5-Document-Geometry-and-Scrolling" class="headerlink" title="15.5 Document Geometry and Scrolling"></a>15.5 Document Geometry and Scrolling</h2><p>In this chapter so far, we have thought about documents as abstract trees of elements and text nodes. But when a browser renders a document within a window, it creates a visual representation of the document in which each element has a position and a size. Often, web applications can treat documents as trees of elements and never have to think about how those elements are rendered on screen. Sometimes, however, it is necessary to determine the precise geometry of an element. If, for example, you want to use CSS to dynamically position an element (such as a tooltip) next to some ordinary browser-positioned element, you need to be able to determine the location of that element.</p>
<p>The following subsections explain how you can go back and forth between the abstract, tree-based model of a document and the geometrical, coordinate-based view of the document as it is laid out in a browser window.</p>
<h3 id="15-5-1-Document-Coordinates-and-Viewport-Coordinates"><a href="#15-5-1-Document-Coordinates-and-Viewport-Coordinates" class="headerlink" title="15.5.1 Document Coordinates and Viewport Coordinates"></a>15.5.1 Document Coordinates and Viewport Coordinates</h3><p>The position of a document element is measured in CSS pixels, with the x coordinate increasing to the right and the y coordinate increasing as we go down. There are two different points we can use as the coordinate system origin, however: the x and y coordinates of an element can be relative to the top-left corner of the document or relative to the top-left corner of the viewport in which the document is displayed. In top-level windows and tabs, the â€œviewportâ€ is the portion of the browser that actually displays document content: it excludes browser â€œchromeâ€ such as menus, toolbars, and tabs. For documents displayed in <code>&lt;iframe&gt;</code> tags, it is the iframe element in the DOM that defines the viewport for the nested document. In either case, when we talk about the position of an element, we must be clear whether we are using document coordinates or viewport coordinates. (Note that viewport coordinates are sometimes called â€œwindow coordinates.â€)</p>
<p>If the document is smaller than the viewport, or if it has not been scrolled, the upper-left corner of the document is in the upper-left corner of the viewport and the document and viewport coordinate systems are the same. In general, however, to convert between the two coordinate systems, we must add or subtract the scroll offsets. If an element has a y coordinate of 200 pixels in document coordinates, for example, and if the user has scrolled down by 75 pixels, then that element has a y coordinate of 125 pixels in viewport coordinates. Similarly, if an element has an x coordinate of 400 in viewport coordinates after the user has scrolled the viewport 200 pixels horizontally, then the elementâ€™s x coordinate in document coordinates is 600.</p>
<p>If we use the mental model of printed paper documents, it is logical to assume that every element in a document must have a unique position in document coordinates, regardless of how much the user has scrolled the document. That is an appealing property of paper documents, and it applies for simple web documents, but in general, document coordinates donâ€™t really work on the web. The problem is that the CSS overflow property allows elements within a document to contain more content than it can display. Elements can have their own scrollbars and serve as viewports for the content they contain. The fact that the web allows scrolling elements within a scrolling document means that it is simply not possible to describe the position of an element within the document using a single (x,y) point.</p>
<p>Because document coordinates donâ€™t really work, client-side JavaScript tends to use viewport coordinates. The getBoundingClientRect() and elementFromPoint() methods described next use viewport coordinates, for example, and the clientX and clientY properties of mouse and pointer event objects also use this coordinate system.</p>
<p>When you explicitly position an element using CSS position:fixed, the top and left properties are interpreted in viewport coordinates. If you use position:relative, the element is positioned relative to where it would have been if it didnâ€™t have the position property set. If you use position:absolute, then top and left are relative to the document or to the nearest containing positioned element. This means, for example, that an absolutely positioned element inside a relatively positioned element is positioned relative to the container element, not relative to the overall document. It is sometimes very useful to create a relatively positioned container with top and left set to 0 (so the container is laid out normally) in order to establish a new coordinate system origin for the absolutely positioned elements it contains. We might refer to this new coordinate system as â€œcontainer coordinatesâ€ to distinguish it from document coordinates and viewport coordinates.</p>
<p>CSS PIXELS<br>If, like me, you are old enough to remember computer monitors with resolutions of 1024 Ã— 768 and touch-screen phones with resolutions of 320 Ã— 480, then you may still think that the word â€œpixelâ€ refers to a single â€œpicture elementâ€ in hardware. Todayâ€™s 4K monitors and â€œretinaâ€ displays have such high resolution that software pixels have been decoupled from hardware pixels. A CSS pixelâ€”and therefore a client-side JavaScript pixelâ€”may in fact consist of multiple device pixels. The devicePixelRatio property of the Window object specifies how many device pixels are used for each software pixel. A â€œdprâ€ of 2, for example, means that each software pixel is actually a 2 Ã— 2 grid of hardware pixels. The devicePixelRatio value depends on the physical resolution of your hardware, on settings in your operating system, and on the zoom level in your browser.</p>
<p>devicePixelRatio does not have to be an integer. If you are using a CSS font size of â€œ12pxâ€ and the device pixel ratio is 2.5, then the actual font size, in device pixels, is 30. Because the pixel values we use in CSS no longer correspond directly to individual pixels on the screen, pixel coordinates no longer need to be integers. If the devicePixelRatio is 3, then a coordinate of 3.33 makes perfect sense. And if the ratio is actually 2, then a coordinate of 3.33 will just be rounded up to 3.5.</p>
<h3 id="15-5-2-Querying-the-Geometry-of-an-Element"><a href="#15-5-2-Querying-the-Geometry-of-an-Element" class="headerlink" title="15.5.2 Querying the Geometry of an Element"></a>15.5.2 Querying the Geometry of an Element</h3><p>You can determine the size (including CSS border and padding, but not the margin) and position (in viewport coordinates) of an element by calling its getBoundingClientRect() method. It takes no arguments and returns an object with properties left, right, top, bottom, width, and height. The left and top properties give the x and y coordinates of the upper-left corner of the element, and the right and bottom properties give the coordinates of the lower-right corner. The differences between these values are the width and height properties.</p>
<p>Block elements, such as images, paragraphs, and <code>&lt;div&gt;</code> elements are always rectangular when laid out by the browser. Inline elements, such as <code>&lt;span&gt;</code>, <code>&lt;code&gt;</code>, and <code>&lt;b&gt;</code> elements, however, may span multiple lines and may therefore consist of multiple rectangles. Imagine, for example, some text within <code>&lt;em&gt;</code> and <code>&lt;/em&gt;</code> tags that happens to be displayed so that it wraps across two lines. Its rectangles consist of the end of the first line and beginning of the second line. If you call getBoundingClientRect() on this element, the bounding rectangle would include the entire width of both lines. If you want to query the individual rectangles of inline elements, call the getClientRects() method to obtain a read-only, array-like object whose elements are rectangle objects like those returned by getBoundingClientRect().</p>
<h3 id="15-5-3-Determining-the-Element-at-a-Point"><a href="#15-5-3-Determining-the-Element-at-a-Point" class="headerlink" title="15.5.3 Determining the Element at a Point"></a>15.5.3 Determining the Element at a Point</h3><p>The getBoundingClientRect() method allows us to determine the current position of an element in a viewport. Sometimes we want to go in the other direction and determine which element is at a given location in the viewport. You can determine this with the elementFromPoint() method of the Document object. Call this method with the x and y coordinates of a point (using viewport coordinates, not document coordinates: the clientX and clientY coordinates of a mouse event work, for example). elementFromPoint() returns an Element object that is at the specified position. The hit detection algorithm for selecting the element is not precisely specified, but the intent of this method is that it returns the innermost (most deeply nested) and uppermost (highest CSS z-index attribute) element at that point.</p>
<h3 id="15-5-4-Scrolling"><a href="#15-5-4-Scrolling" class="headerlink" title="15.5.4 Scrolling"></a>15.5.4 Scrolling</h3><p>The scrollTo() method of the Window object takes the x and y coordinates of a point (in document coordinates) and sets these as the scrollbar offsets. That is, it scrolls the window so that the specified point is in the upper-left corner of the viewport. If you specify a point that is too close to the bottom or too close to the right edge of the document, the browser will move it as close as possible to the upper-left corner but wonâ€™t be able to get it all the way there. The following code scrolls the browser so that the bottom-most page of the document is visible:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Get the heights of the document and viewport.</span></span><br><span class="line"><span class="keyword">let</span> documentHeight = <span class="variable language_">document</span>.<span class="property">documentElement</span>.<span class="property">offsetHeight</span>;</span><br><span class="line"><span class="keyword">let</span> viewportHeight = <span class="variable language_">window</span>.<span class="property">innerHeight</span>;</span><br><span class="line"><span class="comment">// And scroll so the last &quot;page&quot; shows in the viewport</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="title function_">scrollTo</span>(<span class="number">0</span>, documentHeight - viewportHeight);</span><br></pre></td></tr></table></figure>
<p>The scrollBy() method of the Window is similar to scrollTo(), but its arguments are relative and are added to the current scroll position:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Scroll 50 pixels down every 500 ms. Note there is no way to turn this off!</span></span><br><span class="line"><span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123; <span class="title function_">scrollBy</span>(<span class="number">0</span>,<span class="number">50</span>)&#125;, <span class="number">500</span>);</span><br></pre></td></tr></table></figure>
<p>If you want to scroll smoothly with scrollTo() or scrollBy(), pass a single object argument instead of two numbers, like this:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">window</span>.<span class="title function_">scrollTo</span>(&#123;</span><br><span class="line">  <span class="attr">left</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">top</span>: documentHeight - viewportHeight,</span><br><span class="line">  <span class="attr">behavior</span>: <span class="string">&quot;smooth&quot;</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Often, instead of scrolling to a numeric location in a document, we just want to scroll so that a certain element in the document is visible. You can do this with the scrollIntoView() method on the desired HTML element. This method ensures that the element on which it is invoked is visible in the viewport. By default, it tries to put the top edge of the element at or near the top of the viewport. If false is passed as the only argument, it tries to put the bottom edge of the element at the bottom of the viewport. The browser will also scroll the viewport horizontally as needed to make the element visible.</p>
<p>You can also pass an object to scrollIntoView(), setting the behavior:â€smoothâ€ property for smooth scrolling. You can set the block property to specify where the element should be positioned vertically and the inline property to specify how it should be positioned horizontally if horizontal scrolling is needed. Legal values for both of these properties are start, end, nearest, and center.</p>
<h3 id="15-5-5-Viewport-Size-Content-Size-and-Scroll-Position"><a href="#15-5-5-Viewport-Size-Content-Size-and-Scroll-Position" class="headerlink" title="15.5.5 Viewport Size, Content Size, and Scroll Position"></a>15.5.5 Viewport Size, Content Size, and Scroll Position</h3><p>As weâ€™ve discussed, browser windows and other HTML elements can display scrolling content. When this is the case, we sometimes need to know the size of the viewport, the size of the content, and the scroll offsets of the content within the viewport. This section covers these details.</p>
<p>For browser windows, the viewport size is given by the window.innerWidth and window.innerHeight properties. (Web pages optimized for mobile devices often use a <code>&lt;meta name=&quot;viewport&quot;&gt;</code> tag in their <code>&lt;head&gt;</code> to set the desired viewport width for the page.) The total size of the document is the same as the size of the <code>&lt;html&gt;</code> element, document.documentElement. You can call getBoundingClientRect() on document.documentElement to get the width and height of the document, or you can use the offsetWidth and offsetHeight properties of document.documentElement. The scroll offsets of the document within its viewport are available as window.scrollX and window.scrollY. These are read-only properties, so you canâ€™t set them to scroll the document: use window.scrollTo() instead.</p>
<p>Things are a little more complicated for elements. Every Element object defines the following three groups of properties:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">offsetWidth     clientWidth      scrollWidth</span><br><span class="line">offsetHeight    clientHeight     scrollHeight</span><br><span class="line">offsetLeft      clientLeft       scrollLeft</span><br><span class="line">offsetTop       clientTop        scrollTop</span><br><span class="line">offsetParent</span><br></pre></td></tr></table></figure>
<p>The offsetWidth and offsetHeight properties of an element return its on-screen size in CSS pixels. The returned sizes include the element border and padding but not margins. The offsetLeft and offsetTop properties return the x and y coordinates of the element. For many elements, these values are document coordinates. But for descendants of positioned elements and for some other elements, such as table cells, these properties return coordinates that are relative to an ancestor element rather than the document itself. The offsetParent property specifies which element the properties are relative to. These offset properties are all read-only.</p>
<p>clientWidth and clientHeight are like offsetWidth and offsetHeight except that they do not include the border sizeâ€”only the content area and its padding. The clientLeft and clientTop properties are not very useful: they return the horizontal and vertical distance between the outside of an elementâ€™s padding and the outside of its border. Usually, these values are just the width of the left and top borders. These client properties are all read-only. For inline elements like <code>&lt;i&gt;</code>, <code>&lt;code&gt;</code>, and <code>&lt;span&gt;</code>, they all return 0.</p>
<p>scrollWidth and scrollHeight return the size of an elementâ€™s content area plus its padding plus any overflowing content. When the content fits within the content area without overflow, these properties are the same as clientWidth and clientHeight. But when there is overflow, they include the overflowing content and return values larger than clientWidth and clientHeight. scrollLeft and scrollTop give the scroll offset of the element content within the elementâ€™s viewport. Unlike all the other properties described here, scrollLeft and scrollTop are writable properties, and you can set them to scroll the content within an element. (In most browsers, Element objects also have scrollTo() and scrollBy() methods like the Window object does, but these are not yet universally supported.)</p>
<h2 id="15-6-Web-Components"><a href="#15-6-Web-Components" class="headerlink" title="15.6 Web Components"></a>15.6 Web Components</h2><p>HTML is a language for document markup and defines a rich set of tags for that purpose. Over the last three decades, it has become a language that is used to describe the user interfaces of web applications, but basic HTML tags such as <code>&lt;input&gt;</code> and <code>&lt;button&gt;</code> are inadequate for modern UI designs. Web developers are able to make it work, but only by using CSS and JavaScript to augment the appearance and behavior of basic HTML tags. Consider a typical user interface component, such as the search box shown in Figure 15-3.</p>
<p><Figures figure="15-3">A search box user interface component</Figures></p>
<p>The HTML <code>&lt;input&gt;</code> element can be used to accept a single line of input from the user, but it doesnâ€™t have any way to display icons like the magnifying glass on the left and the cancel X on the right. In order to implement a modern user interface element like this for the web, we need to use at least four HTML elements: an <code>&lt;input&gt;</code> element to accept and display the userâ€™s input, two <code>&lt;img&gt;</code> elements (or in this case, two <code>&lt;span&gt;</code> elements displaying Unicode glyphs), and a container <code>&lt;div&gt;</code> element to hold those three children. Furthermore, we have to use CSS to hide the default border of the <code>&lt;input&gt;</code> element and define a border for the container. And we need to use JavaScript to make all the HTML elements work together. When the user clicks on the X icon, we need an event handler to clear the input from the <code>&lt;input&gt;</code> element, for example.</p>
<p>That is a lot of work to do every time you want to display a search box in a web application, and most web applications today are not written using â€œrawâ€ HTML. Instead, many web developers use frameworks like React and Angular that support the creation of reusable user interface components like the search box shown here. Web components is a browser-native alternative to those frameworks based on three relatively recent additions to web standards that allow JavaScript to extend HTML with new tags that work as self-contained, reusable UI components.</p>
<p>The subsections that follow explain how to use web components defined by other developers in your own web pages, then explain each of the three technologies that web components are based on, and finally tie all three together in an example that implements the search box element pictured in Figure 15-3.</p>
<h3 id="15-6-1-Using-Web-Components"><a href="#15-6-1-Using-Web-Components" class="headerlink" title="15.6.1 Using Web Components"></a>15.6.1 Using Web Components</h3><p>Web components are defined in JavaScript, so in order to use a web component in your HTML file, you need to include the JavaScript file that defines the component. Because web components are a relatively new technology, they are often written as JavaScript modules, so you might include one in your HTML like this:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=<span class="string">&quot;module&quot;</span> src=<span class="string">&quot;components/search-box.js&quot;</span>&gt;</span><br></pre></td></tr></table></figure>
<p>Web components define their own HTML tag names, with the important restriction that those tag names must include a hyphen. (This means that future versions of HTML can introduce new tags without hyphens, and there is no chance that the tags will conflict with anyoneâ€™s web component.) To use a web component, just use its tag in your HTML file:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;search-box placeholder=<span class="string">&quot;Search...&quot;</span>&gt;&lt;/search-box&gt;</span><br></pre></td></tr></table></figure>
<p>Web components can have attributes just like regular HTML tags can; the documentation for the component you are using should tell you which attributes are supported. Web components cannot be defined with self-closing tags. You cannot write <code>&lt;search-box/&gt;</code>, for example. Your HTML file must include both the opening tag and the closing tag.</p>
<p>Like regular HTML elements, some web components are written to expect children and others are written in such a way that they do not expect (and will not display) children. Some web components are written so that they can optionally accept specially labeled children that will appear in named â€œslots.â€ The <code>&lt;search-box&gt;</code> component pictured in Figure 15-3 and implemented in Example 15-3 uses â€œslotsâ€ for the two icons it displays. If you want to to use a <code>&lt;search-box&gt;</code> with different icons, you can use HTML like this:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;search-box&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;images/search-icon.png&quot;</span> <span class="attr">slot</span>=<span class="string">&quot;left&quot;</span>/&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;images/cancel-icon.png&quot;</span> <span class="attr">slot</span>=<span class="string">&quot;right&quot;</span>/&gt;</span></span></span><br><span class="line">&lt;/search-box&gt;</span><br></pre></td></tr></table></figure>
<p>The slot attribute is an extension to HTML that it is used to specify which children should go where. The slot namesâ€”â€œleftâ€ and â€œrightâ€ in this exampleâ€”are defined by the web component. If the component you are using supports slots, that fact should be included in its documentation.</p>
<p>I previously noted that web components are often implemented as JavaScript modules and can be loaded into HTML files with a <code>&lt;script type=&quot;module&quot;&gt;</code> tag. You may remember from the beginning of this chapter that modules are loaded after document content is parsed, as if they had a deferred tag. So this means that a web browser will typically parse and render tags like <code>&lt;search-box&gt;</code> before it has run the code that will tell it what a <code>&lt;search-box&gt;</code> is. This is normal when using web components. HTML parsers in web browsers are flexible and very forgiving about input that they do not understand. When they encounter a web component tag before that component has been defined, they add a generic HTMLElement to the DOM tree even though they do not know what to do with it. Later, when the custom element is defined, the generic element is â€œupgradedâ€ so that it looks and behaves as desired.</p>
<p>If a web component has children, then those children will probably be displayed incorrectly before the component is defined. You can use this CSS to keep web components hidden until they are defined:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Make the &lt;search-box&gt; component invisible before it is defined.</span></span><br><span class="line"><span class="comment"> * And try to duplicate its eventual layout and size so that nearby</span></span><br><span class="line"><span class="comment"> * content does not move when it becomes defined.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">search-<span class="attr">box</span>:<span class="title function_">not</span>(<span class="params">:defined</span>) &#123;</span><br><span class="line">    <span class="attr">opacity</span>:<span class="number">0</span>;</span><br><span class="line">    <span class="attr">display</span>: inline-block;</span><br><span class="line">    <span class="attr">width</span>: 300px;</span><br><span class="line">    <span class="attr">height</span>: 50px;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Like regular HTML elements, web components can be used in JavaScript. If you include a <code>&lt;search-box&gt;</code> tag in your web page, then you can obtain a reference to it with querySelector() and an appropriate CSS selector, just as you would for any other HTML tag. Generally, it only makes sense to do this after the module that defines the component has run, so be careful when querying web components that you do not do so too early. Web component implementations typically (but this is not a requirement) define a JavaScript property for each HTML attribute they support. And, like HTML elements, they may also define useful methods. Once again, the documentation for the web component you are using should specify what properties and methods are available to your JavaScript code.</p>
<p>Now that you know how to use web components, the next three sections cover the three web browser features that allow us to implement them.</p>
<p>DOCUMENTFRAGMENT NODES<br>Before we can cover web component APIs, we need to return briefly to the DOM API to explain what a DocumentFragment is. The DOM API organizes a document into a tree of Node objects, where a Node can be a Document, an Element, a Text node, or even a Comment. None of these node types allows you to represent a fragment of a document that consists of a set of sibling nodes without their parent. This is where DocumentFragment comes in: it is another type of Node that serves as a temporary parent when you want to manipulate a group of sibling nodes as a single unit. You can create a DocumentFragment node with document.createDocumentFragment(). Once you have a DocumentFragment, you can use it like an Element and append() content to it. A DocumentFragment is different from an Element because it does not have a parent. But more importantly, when you insert a DocumentFragment node into the document, the DocumentFragment itself is not inserted. Instead, all of its children are inserted.</p>
<h3 id="15-6-2-HTML-Templates"><a href="#15-6-2-HTML-Templates" class="headerlink" title="15.6.2 HTML Templates"></a>15.6.2 HTML Templates</h3><p>The HTML <code>&lt;template&gt;</code> tag is only loosely related to web components, but it does enable a useful optimization for components that appear frequently in web pages. <code>&lt;template&gt;</code> tags and their children are never rendered by a web browser and are only useful on web pages that use JavaScript. The idea behind this tag is that when a web page contains multiple repetitions of the same basic HTML structure (such as rows in a table or the internal implementation of a web component), then we can use a <code>&lt;template&gt;</code> to define that element structure once, then use JavaScript to duplicate the structure as many times as needed.</p>
<p>In JavaScript, a <code>&lt;template&gt;</code> tag is represented by an HTMLTemplateElement object. This object defines a single content property, and the value of this property is a DocumentFragment of all the child nodes of the <code>&lt;template&gt;</code>. You can clone this DocumentFragment and then insert the cloned copy into your document as needed. The fragment itself will not be inserted, but its children will be. Suppose youâ€™re working with a document that includes a <code>&lt;table&gt;</code> and <code>&lt;template id=&quot;row&quot;&gt;</code> tag and that the template defines the structure of rows for that table. You might use the template like this:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> tableBody = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;tbody&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> template = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#row&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> clone = template.<span class="property">content</span>.<span class="title function_">cloneNode</span>(<span class="literal">true</span>);  <span class="comment">// deep clone</span></span><br><span class="line"><span class="comment">// ...Use the DOM to insert content into the &lt;td&gt; elements of the clone...</span></span><br><span class="line"><span class="comment">// Now add the cloned and initialized row into the table</span></span><br><span class="line">tableBody.<span class="title function_">append</span>(clone);</span><br></pre></td></tr></table></figure>
<p>Template elements do not have to appear literally in an HTML document in order to be useful. You can create a template in your JavaScript code, create its children with innerHTML, and then make as many clones as needed without the parsing overhead of innerHTML. This is how HTML templates are typically used in web components, and Example 15-3 demonstrates this technique.</p>
<h3 id="15-6-3-Custom-Elements"><a href="#15-6-3-Custom-Elements" class="headerlink" title="15.6.3 Custom Elements"></a>15.6.3 Custom Elements</h3><p>The second web browser feature that enables web components is â€œcustom elementsâ€: the ability to associate a JavaScript class with an HTML tag name so that any such tags in the document are automatically turned into instances of the class in the DOM tree. The customElements.define() method takes a web component tag name as its first argument (remember that the tag name must include a hyphen) and a subclass of HTMLElement as its second argument. Any existing elements in the document with that tag name are â€œupgradedâ€ to newly created instances of the class. And if the browser parses any HTML in the future, it will automatically create an instance of the class for each of the tags it encounters.</p>
<p>The class passed to customElements.define() should extend HTMLElement and not a more specific type like HTMLButtonElement.4 Recall from Chapter 9 that when a JavaScript class extends another class, the constructor function must call super() before it uses the this keyword, so if the custom element class has a constructor, it should call super() (with no arguments) before doing anything else.</p>
<p>The browser will automatically invoke certain â€œlifecycle methodsâ€ of a custom element class. The connectedCallback() method is invoked when an instance of the custom element is inserted into the document, and many elements use this method to perform initialization. There is also a disconnectedCallback() method invoked when (and if) the element is removed from the document, though this is less often used.</p>
<p>If a custom element class defines a static observedAttributes property whose value is an array of attribute names, and if any of the named attributes are set (or changed) on an instance of the custom element, the browser will invoke the attributeChangedCallback() method, passing the attribute name, its old value, and its new value. This callback can take whatever steps are necessary to update the component based on its attribute values.</p>
<p>Custom element classes can also define whatever other properties and methods they want to. Commonly, they will define getter and setter methods that make the elementâ€™s attributes available as JavaScript properties.</p>
<p>As an example of a custom element, suppose we want to be able to display circles within paragraphs of regular text. Weâ€™d like to be able to write HTML like this in order to render mathematical story problems like the one shown in Figure 15-4:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;p&gt;</span><br><span class="line">  <span class="title class_">The</span> <span class="variable language_">document</span> has one <span class="attr">marble</span>: <span class="language-xml"><span class="tag">&lt;<span class="name">inline-circle</span>&gt;</span><span class="tag">&lt;/<span class="name">inline-circle</span>&gt;</span></span>.</span><br><span class="line">  <span class="title class_">The</span> <span class="variable constant_">HTML</span> parser instantiates two more <span class="attr">marbles</span>:</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">inline-circle</span> <span class="attr">diameter</span>=<span class="string">&quot;1.2em&quot;</span> <span class="attr">color</span>=<span class="string">&quot;blue&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">inline-circle</span>&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">inline-circle</span> <span class="attr">diameter</span>=<span class="string">&quot;.6em&quot;</span> <span class="attr">color</span>=<span class="string">&quot;gold&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">inline-circle</span>&gt;</span></span>.</span><br><span class="line">  <span class="title class_">How</span> many marbles does the <span class="variable language_">document</span> contain now?</span><br><span class="line">&lt;/p&gt;</span><br></pre></td></tr></table></figure>

<p><Figures figure="15-4">An inline circle custom element</Figures></p>
<p>We can implement this <code>&lt;inline-circle&gt;</code> custom element with the code shown in Example 15-2:</p>
<p>Example 15-2. The <code>&lt;inline-circle&gt;</code> custom element</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">customElements.<span class="title function_">define</span>(<span class="string">&quot;inline-circle&quot;</span>, <span class="keyword">class</span> <span class="title class_">InlineCircle</span> <span class="keyword">extends</span> <span class="title class_ inherited__">HTMLElement</span> &#123;</span><br><span class="line">    <span class="comment">// The browser calls this method when an &lt;inline-circle&gt; element</span></span><br><span class="line">    <span class="comment">// is inserted into the document. There is also a disconnectedCallback()</span></span><br><span class="line">    <span class="comment">// that we don&#x27;t need in this example.</span></span><br><span class="line">    <span class="title function_">connectedCallback</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// Set the styles needed to create circles</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&quot;inline-block&quot;</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">borderRadius</span> = <span class="string">&quot;50%&quot;</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">border</span> = <span class="string">&quot;solid black 1px&quot;</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">transform</span> = <span class="string">&quot;translateY(10%)&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If there is not already a size defined, set a default size</span></span><br><span class="line">        <span class="comment">// that is based on the current font size.</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">width</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">width</span> = <span class="string">&quot;0.8em&quot;</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">height</span> = <span class="string">&quot;0.8em&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The static observedAttributes property specifies which attributes</span></span><br><span class="line">    <span class="comment">// we want to be notified about changes to. (We use a getter here since</span></span><br><span class="line">    <span class="comment">// we can only use &quot;static&quot; with methods.)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">get</span> <span class="title function_">observedAttributes</span>() &#123; <span class="keyword">return</span> [<span class="string">&quot;diameter&quot;</span>, <span class="string">&quot;color&quot;</span>]; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This callback is invoked when one of the attributes listed above</span></span><br><span class="line">    <span class="comment">// changes, either when the custom element is first parsed, or later.</span></span><br><span class="line">    <span class="title function_">attributeChangedCallback</span>(<span class="params">name, oldValue, newValue</span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span>(name) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;diameter&quot;</span>:</span><br><span class="line">            <span class="comment">// If the diameter attribute changes, update the size styles</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">width</span> = newValue;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">height</span> = newValue;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;color&quot;</span>:</span><br><span class="line">            <span class="comment">// If the color attribute changes, update the color styles</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">backgroundColor</span> = newValue;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Define JavaScript properties that correspond to the element&#x27;s</span></span><br><span class="line">    <span class="comment">// attributes. These getters and setters just get and set the underlying</span></span><br><span class="line">    <span class="comment">// attributes. If a JavaScript property is set, that sets the attribute</span></span><br><span class="line">    <span class="comment">// which triggers a call to attributeChangedCallback() which updates</span></span><br><span class="line">    <span class="comment">// the element styles.</span></span><br><span class="line">    <span class="keyword">get</span> <span class="title function_">diameter</span>() &#123; <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">getAttribute</span>(<span class="string">&quot;diameter&quot;</span>); &#125;</span><br><span class="line">    <span class="keyword">set</span> <span class="title function_">diameter</span>(<span class="params">diameter</span>) &#123; <span class="variable language_">this</span>.<span class="title function_">setAttribute</span>(<span class="string">&quot;diameter&quot;</span>, diameter); &#125;</span><br><span class="line">    <span class="keyword">get</span> <span class="title function_">color</span>() &#123; <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">getAttribute</span>(<span class="string">&quot;color&quot;</span>); &#125;</span><br><span class="line">    <span class="keyword">set</span> <span class="title function_">color</span>(<span class="params">color</span>) &#123; <span class="variable language_">this</span>.<span class="title function_">setAttribute</span>(<span class="string">&quot;color&quot;</span>, color); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="15-6-4-Shadow-DOM"><a href="#15-6-4-Shadow-DOM" class="headerlink" title="15.6.4 Shadow DOM"></a>15.6.4 Shadow DOM</h3><p>The custom element demonstrated in Example 15-2 is not well encapsulated. When you set its diameter or color attributes, it responds by altering its own style attribute, which is not behavior we would ever expect from a real HTML element. To turn a custom element into a true web component, it should use the powerful encapsulation mechanism known as shadow DOM.</p>
<p>Shadow DOM allows a â€œshadow rootâ€ to be attached to a custom element (and also to a <code>&lt;div&gt;</code>, <code>&lt;span&gt;</code>, <code>&lt;body&gt;</code>, <code>&lt;article&gt;</code>, <code>&lt;main&gt;</code>, <code>&lt;nav&gt;</code>, <code>&lt;header&gt;</code>, <code>&lt;footer&gt;</code>, <code>&lt;section&gt;</code>, <code>&lt;p&gt;</code>, <code>&lt;blockquote&gt;</code>, <code>&lt;aside&gt;</code>, or <code>&lt;h1&gt;</code> through <code>&lt;h6&gt;</code> element) known as a â€œshadow host.â€ Shadow host elements, like all HTML elements, are already the root of a normal DOM tree of descendant elements and text nodes. A shadow root is the root of another, more private, tree of descendant elements that sprouts from the shadow host and can be thought of as a distinct minidocument.</p>
<p>The word â€œshadowâ€ in â€œshadow DOMâ€ refers to the fact that elements that descend from a shadow root are â€œhiding in the shadowsâ€: they are not part of the normal DOM tree, do not appear in the children array of their host element, and are not visited by normal DOM traversal methods such as querySelector(). For contrast, the normal, regular DOM children of a shadow host are sometimes referred to as the â€œlight DOM.â€</p>
<p>To understand the purpose of the shadow DOM, picture the HTML <code>&lt;audio&gt;</code> and <code>&lt;video&gt;</code> elements: they display a nontrivial user interface for controlling media playback, but the play and pause buttons and other UI elements are not part of the DOM tree and cannot be manipulated by JavaScript. Given that web browsers are designed to display HTML, it is only natural that browser vendors would want to display internal UIs like these using HTML. In fact, most browsers have been doing something like that for a long time, and the shadow DOM makes it a standard part of the web platform.</p>
<p>SHADOW DOM ENCAPSULATION<br>The key feature of shadow DOM is the encapsulation it provides. The descendants of a shadow root are hidden fromâ€”and independent fromâ€”the regular DOM tree, almost as if they were in an independent document. There are three very important kinds of encapsulation provided by the shadow DOM:</p>
<ul>
<li>As already mentioned, elements in the shadow DOM are hidden from regular DOM methods like querySelectorAll(). When a shadow root is created and attached to its shadow host, it can be created in â€œopenâ€ or â€œclosedâ€ mode. A closed shadow root is completely sealed away and inaccessible. More commonly, though, shadow roots are created in â€œopenâ€ mode, which means that the shadow host has a shadowRoot property that JavaScript can use to gain access to the elements of the shadow root, if it has some reason to do so.</li>
<li>Styles defined beneath a shadow root are private to that tree and will never affect the light DOM elements on the outside. (A shadow root can define default styles for its host element, but these will be overridden by light DOM styles.) Similarly, the light DOM styles that apply to the shadow host element have no effect on the descendants of the shadow root. Elements in the shadow DOM will inherit things like font size and background color from the light DOM, and styles in the shadow DOM can choose to use CSS variables defined in the light DOM. For the most part, however, the styles of the light DOM and the styles of the shadow DOM are completely independent: the author of a web component and the user of a web component do not have to worry about collisions or conflicts between their stylesheets. Being able to â€œscopeâ€ CSS in this way is perhaps the most important feature of the shadow DOM.</li>
<li>Some events (like â€œloadâ€) that occur within the shadow DOM are confined to the shadow DOM. Others, including focus, mouse, and keyboard events bubble up and out. When an event that originates in the shadow DOM crosses the boundary and begins to propagate in the light DOM, its target property is changed to the shadow host element, so it appears to have originated directly on that element.</li>
</ul>
<p>SHADOW DOM SLOTS AND LIGHT DOM CHILDREN<br>An HTML element that is a shadow host has two trees of descendants. One is the children[] arrayâ€”the regular light DOM descendants of the host elementâ€”and the other is the shadow root and all of its descendants, and you may be wondering how two distinct content trees can be displayed within the same host element. Hereâ€™s how it works:</p>
<ul>
<li>The descendants of the shadow root are always displayed within the shadow host.</li>
<li>If those descendants include a <code>&lt;slot&gt;</code> element, then the regular light DOM children of the host element are displayed as if they were children of that <code>&lt;slot&gt;</code>, replacing any shadow DOM content in the slot. If the shadow DOM does not include a <code>&lt;slot&gt;</code>, then any light DOM content of the host is never displayed. If the shadow DOM has a <code>&lt;slot&gt;</code>, but the shadow host has no light DOM children, then the shadow DOM content of the slot is displayed as a default.</li>
<li>When light DOM content is displayed within a shadow DOM slot, we say that those elements have been â€œdistributed,â€ but it is important to understand that the elements do not actually become part of the shadow DOM. They can still be queried with querySelector(), and they still appear in the light DOM as children or descendants of the host element.</li>
<li>If the shadow DOM defines more than one <code>&lt;slot&gt;</code> and names those slots with a name attribute, then children of the shadow host can specify which slot they would like to appear in by specifying a slot&#x3D;â€slotnameâ€ attribute. We saw an example of this usage in Â§15.6.1 when we demonstrated how to customize the icons displayed by the <code>&lt;search-box&gt;</code> component.</li>
</ul>
<p>SHADOW DOM API<br>For all of its power, the Shadow DOM doesnâ€™t have much of a JavaScript API. To turn a light DOM element into a shadow host, just call its attachShadow() method, passing {mode:â€openâ€} as the only argument. This method returns a shadow root object and also sets that object as the value of the hostâ€™s shadowRoot property. The shadow root object is a DocumentFragment, and you can use DOM methods to add content to it or just set its innerHTML property to a string of HTML.</p>
<p>If your web component needs to know when the light DOM content of a shadow DOM <code>&lt;slot&gt;</code> has changed, it can register a listener for â€œslotchangedâ€ events directly on the <code>&lt;slot&gt;</code> element.</p>
<h3 id="15-6-5-Example-a-lt-search-box-gt-Web-Component"><a href="#15-6-5-Example-a-lt-search-box-gt-Web-Component" class="headerlink" title="15.6.5 Example: a &lt;search-box&gt; Web Component"></a>15.6.5 Example: a <code>&lt;search-box&gt;</code> Web Component</h3><p>Figure 15-3 illustrated a <code>&lt;search-box&gt;</code> web component. Example 15-3 demonstrates the three enabling technologies that define web components: it implements the <code>&lt;search-box&gt;</code> component as a custom element that uses a <code>&lt;template&gt;</code> tag for efficiency and a shadow root for encapsulation.</p>
<p>This example shows how to use the low-level web component APIs directly. In practice, many web components developed today create them using higher-level libraries such as â€œlit-element.â€ One of the reasons to use a library is that creating reusable and customizable components is actually quite hard to do well, and there are many details to get right. Example 15-3 demonstrates web components and does some basic keyboard focus handling, but otherwise ignores accessibility and makes no attempt to use proper ARIA attributes to make the component work with screen readers and other assistive technology.</p>
<p>Example 15-3. Implementing a web component</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This class defines a custom HTML &lt;search-box&gt; element that displays an</span></span><br><span class="line"><span class="comment"> * &lt;input&gt; text input field plus two icons or emoji. By default, it displays a</span></span><br><span class="line"><span class="comment"> * magnifying glass emoji (indicating search) to the left of the text field</span></span><br><span class="line"><span class="comment"> * and an X emoji (indicating cancel) to the right of the text field. It</span></span><br><span class="line"><span class="comment"> * hides the border on the input field and displays a border around itself,</span></span><br><span class="line"><span class="comment"> * creating the appearance that the two emoji are inside the input</span></span><br><span class="line"><span class="comment"> * field. Similarly, when the internal input field is focused, the focus ring</span></span><br><span class="line"><span class="comment"> * is displayed around the &lt;search-box&gt;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * You can override the default icons by including &lt;span&gt; or &lt;img&gt; children</span></span><br><span class="line"><span class="comment"> * of &lt;search-box&gt; with slot=&quot;left&quot; and slot=&quot;right&quot; attributes.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;search-box&gt; supports the normal HTML disabled and hidden attributes and</span></span><br><span class="line"><span class="comment"> * also size and placeholder attributes, which have the same meaning for this</span></span><br><span class="line"><span class="comment"> * element as they do for the &lt;input&gt; element.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Input events from the internal &lt;input&gt; element bubble up and appear with</span></span><br><span class="line"><span class="comment"> * their target field set to the &lt;search-box&gt; element.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The element fires a &quot;search&quot; event with the detail property set to the</span></span><br><span class="line"><span class="comment"> * current input string when the user clicks on the left emoji (the magnifying</span></span><br><span class="line"><span class="comment"> * glass). The &quot;search&quot; event is also dispatched when the internal text field</span></span><br><span class="line"><span class="comment"> * generates a &quot;change&quot; event (when the text has changed and the user types</span></span><br><span class="line"><span class="comment"> * Return or Tab).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The element fires a &quot;clear&quot; event when the user clicks on the right emoji</span></span><br><span class="line"><span class="comment"> * (the X). If no handler calls preventDefault() on the event then the element</span></span><br><span class="line"><span class="comment"> * clears the user&#x27;s input once event dispatch is complete.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Note that there are no onsearch and onclear properties or attributes:</span></span><br><span class="line"><span class="comment"> * handlers for the &quot;search&quot; and &quot;clear&quot; events can only be registered with</span></span><br><span class="line"><span class="comment"> * addEventListener().</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SearchBox</span> <span class="keyword">extends</span> <span class="title class_ inherited__">HTMLElement</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">super</span>(); <span class="comment">// Invoke the superclass constructor; must be first.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Create a shadow DOM tree and attach it to this element, setting</span></span><br><span class="line">        <span class="comment">// the value of this.shadowRoot.</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">attachShadow</span>(&#123;<span class="attr">mode</span>: <span class="string">&quot;open&quot;</span>&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Clone the template that defines the descendants and stylesheet for</span></span><br><span class="line">        <span class="comment">// this custom component, and append that content to the shadow root.</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">shadowRoot</span>.<span class="title function_">append</span>(<span class="title class_">SearchBox</span>.<span class="property">template</span>.<span class="property">content</span>.<span class="title function_">cloneNode</span>(<span class="literal">true</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Get references to the important elements in the shadow DOM</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">input</span> = <span class="variable language_">this</span>.<span class="property">shadowRoot</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#input&quot;</span>);</span><br><span class="line">        <span class="keyword">let</span> leftSlot = <span class="variable language_">this</span>.<span class="property">shadowRoot</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;slot[name=&quot;left&quot;]&#x27;</span>);</span><br><span class="line">        <span class="keyword">let</span> rightSlot = <span class="variable language_">this</span>.<span class="property">shadowRoot</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;slot[name=&quot;right&quot;]&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// When the internal input field gets or loses focus, set or remove</span></span><br><span class="line">        <span class="comment">// the &quot;focused&quot; attribute which will cause our internal stylesheet</span></span><br><span class="line">        <span class="comment">// to display or hide a fake focus ring on the entire component. Note</span></span><br><span class="line">        <span class="comment">// that the &quot;blur&quot; and &quot;focus&quot; events bubble and appear to originate</span></span><br><span class="line">        <span class="comment">// from the &lt;search-box&gt;.</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">input</span>.<span class="property">onfocus</span> = <span class="function">() =&gt;</span> &#123; <span class="variable language_">this</span>.<span class="title function_">setAttribute</span>(<span class="string">&quot;focused&quot;</span>, <span class="string">&quot;&quot;</span>); &#125;;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">input</span>.<span class="property">onblur</span> = <span class="function">() =&gt;</span> &#123; <span class="variable language_">this</span>.<span class="title function_">removeAttribute</span>(<span class="string">&quot;focused&quot;</span>);&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If the user clicks on the magnifying glass, trigger a &quot;search&quot;</span></span><br><span class="line">        <span class="comment">// event.  Also trigger it if the input field fires a &quot;change&quot;</span></span><br><span class="line">        <span class="comment">// event. (The &quot;change&quot; event does not bubble out of the Shadow DOM.)</span></span><br><span class="line">        leftSlot.<span class="property">onclick</span> = <span class="variable language_">this</span>.<span class="property">input</span>.<span class="property">onchange</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">            event.<span class="title function_">stopPropagation</span>();    <span class="comment">// Prevent click events from bubbling</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">disabled</span>) <span class="keyword">return</span>;  <span class="comment">// Do nothing when disabled</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">dispatchEvent</span>(<span class="keyword">new</span> <span class="title class_">CustomEvent</span>(<span class="string">&quot;search&quot;</span>, &#123;</span><br><span class="line">                <span class="attr">detail</span>: <span class="variable language_">this</span>.<span class="property">input</span>.<span class="property">value</span></span><br><span class="line">            &#125;));</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If the user clicks on the X, trigger a &quot;clear&quot; event.</span></span><br><span class="line">        <span class="comment">// If preventDefault() is not called on the event, clear the input.</span></span><br><span class="line">        rightSlot.<span class="property">onclick</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">            event.<span class="title function_">stopPropagation</span>();    <span class="comment">// Don&#x27;t let the click bubble up</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">disabled</span>) <span class="keyword">return</span>;  <span class="comment">// Don&#x27;t do anything if disabled</span></span><br><span class="line">            <span class="keyword">let</span> e = <span class="keyword">new</span> <span class="title class_">CustomEvent</span>(<span class="string">&quot;clear&quot;</span>, &#123; <span class="attr">cancelable</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">dispatchEvent</span>(e);</span><br><span class="line">            <span class="keyword">if</span> (!e.<span class="property">defaultPrevented</span>) &#123;  <span class="comment">// If the event was not &quot;cancelled&quot;</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">input</span>.<span class="property">value</span> = <span class="string">&quot;&quot;</span>;  <span class="comment">// then clear the input field</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// When some of our attributes are set or changed, we need to set the</span></span><br><span class="line">    <span class="comment">// corresponding value on the internal &lt;input&gt; element. This life cycle</span></span><br><span class="line">    <span class="comment">// method, together with the static observedAttributes property below,</span></span><br><span class="line">    <span class="comment">// takes care of that.</span></span><br><span class="line">    <span class="title function_">attributeChangedCallback</span>(<span class="params">name, oldValue, newValue</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (name === <span class="string">&quot;disabled&quot;</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">input</span>.<span class="property">disabled</span> = newValue !== <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name === <span class="string">&quot;placeholder&quot;</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">input</span>.<span class="property">placeholder</span> = newValue;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name === <span class="string">&quot;size&quot;</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">input</span>.<span class="property">size</span> = newValue;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name === <span class="string">&quot;value&quot;</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">input</span>.<span class="property">value</span> = newValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Finally, we define property getters and setters for properties that</span></span><br><span class="line">    <span class="comment">// correspond to the HTML attributes we support. The getters simply return</span></span><br><span class="line">    <span class="comment">// the value (or the presence) of the attribute. And the setters just set</span></span><br><span class="line">    <span class="comment">// the value (or the presence) of the attribute. When a setter method</span></span><br><span class="line">    <span class="comment">// changes an attribute, the browser will automatically invoke the</span></span><br><span class="line">    <span class="comment">// attributeChangedCallback above.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">get</span> <span class="title function_">placeholder</span>() &#123; <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">getAttribute</span>(<span class="string">&quot;placeholder&quot;</span>); &#125;</span><br><span class="line">    <span class="keyword">get</span> <span class="title function_">size</span>() &#123; <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">getAttribute</span>(<span class="string">&quot;size&quot;</span>); &#125;</span><br><span class="line">    <span class="keyword">get</span> <span class="title function_">value</span>() &#123; <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">getAttribute</span>(<span class="string">&quot;value&quot;</span>); &#125;</span><br><span class="line">    <span class="keyword">get</span> <span class="title function_">disabled</span>() &#123; <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">hasAttribute</span>(<span class="string">&quot;disabled&quot;</span>); &#125;</span><br><span class="line">    <span class="keyword">get</span> <span class="title function_">hidden</span>() &#123; <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">hasAttribute</span>(<span class="string">&quot;hidden&quot;</span>); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">set</span> <span class="title function_">placeholder</span>(<span class="params">value</span>) &#123; <span class="variable language_">this</span>.<span class="title function_">setAttribute</span>(<span class="string">&quot;placeholder&quot;</span>, value); &#125;</span><br><span class="line">    <span class="keyword">set</span> <span class="title function_">size</span>(<span class="params">value</span>) &#123; <span class="variable language_">this</span>.<span class="title function_">setAttribute</span>(<span class="string">&quot;size&quot;</span>, value); &#125;</span><br><span class="line">    <span class="keyword">set</span> <span class="title function_">value</span>(<span class="params">text</span>) &#123; <span class="variable language_">this</span>.<span class="title function_">setAttribute</span>(<span class="string">&quot;value&quot;</span>, text); &#125;</span><br><span class="line">    <span class="keyword">set</span> <span class="title function_">disabled</span>(<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (value) <span class="variable language_">this</span>.<span class="title function_">setAttribute</span>(<span class="string">&quot;disabled&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="variable language_">this</span>.<span class="title function_">removeAttribute</span>(<span class="string">&quot;disabled&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">set</span> <span class="title function_">hidden</span>(<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (value) <span class="variable language_">this</span>.<span class="title function_">setAttribute</span>(<span class="string">&quot;hidden&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="variable language_">this</span>.<span class="title function_">removeAttribute</span>(<span class="string">&quot;hidden&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This static field is required for the attributeChangedCallback method.</span></span><br><span class="line"><span class="comment">// Only attributes named in this array will trigger calls to that method.</span></span><br><span class="line"><span class="title class_">SearchBox</span>.<span class="property">observedAttributes</span> = [<span class="string">&quot;disabled&quot;</span>, <span class="string">&quot;placeholder&quot;</span>, <span class="string">&quot;size&quot;</span>, <span class="string">&quot;value&quot;</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create a &lt;template&gt; element to hold the stylesheet and the tree of</span></span><br><span class="line"><span class="comment">// elements that we&#x27;ll use for each instance of the SearchBox element.</span></span><br><span class="line"><span class="title class_">SearchBox</span>.<span class="property">template</span> = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;template&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// We initialize the template by parsing this string of HTML. Note, however,</span></span><br><span class="line"><span class="comment">// that when we instantiate a SearchBox, we are able to just clone the nodes</span></span><br><span class="line"><span class="comment">// in the template and do have to parse the HTML again.</span></span><br><span class="line"><span class="title class_">SearchBox</span>.<span class="property">template</span>.<span class="property">innerHTML</span> = <span class="string">`</span></span><br><span class="line"><span class="string">&lt;style&gt;</span></span><br><span class="line"><span class="string">/*</span></span><br><span class="line"><span class="string"> * The :host selector refers to the &lt;search-box&gt; element in the light</span></span><br><span class="line"><span class="string"> * DOM. These styles are defaults and can be overridden by the user of the</span></span><br><span class="line"><span class="string"> * &lt;search-box&gt; with styles in the light DOM.</span></span><br><span class="line"><span class="string"> */</span></span><br><span class="line"><span class="string">:host &#123;</span></span><br><span class="line"><span class="string">  display: inline-block;   /* The default is inline display */</span></span><br><span class="line"><span class="string">  border: solid black 1px; /* A rounded border around the &lt;input&gt; and &lt;slots&gt; */</span></span><br><span class="line"><span class="string">  border-radius: 5px;</span></span><br><span class="line"><span class="string">  padding: 4px 6px;        /* And some space inside the border */</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">:host([hidden]) &#123;          /* Note the parentheses: when host has hidden... */</span></span><br><span class="line"><span class="string">  display:none;            /* ...attribute set don&#x27;t display it */</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">:host([disabled]) &#123;        /* When host has the disabled attribute... */</span></span><br><span class="line"><span class="string">  opacity: 0.5;            /* ...gray it out */</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">:host([focused]) &#123;         /* When host has the focused attribute... */</span></span><br><span class="line"><span class="string">  box-shadow: 0 0 2px 2px #6AE;  /* display this fake focus ring. */</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/* The rest of the stylesheet only applies to elements in the Shadow DOM. */</span></span><br><span class="line"><span class="string">input &#123;</span></span><br><span class="line"><span class="string">  border-width: 0;         /* Hide the border of the internal input field. */</span></span><br><span class="line"><span class="string">  outline: none;           /* Hide the focus ring, too. */</span></span><br><span class="line"><span class="string">  font: inherit;           /* &lt;input&gt; elements don&#x27;t inherit font by default */</span></span><br><span class="line"><span class="string">  background: inherit;     /* Same for background color. */</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">slot &#123;</span></span><br><span class="line"><span class="string">  cursor: default;         /* An arrow pointer cursor over the buttons */</span></span><br><span class="line"><span class="string">  user-select: none;       /* Don&#x27;t let the user select the emoji text */</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&lt;/style&gt;</span></span><br><span class="line"><span class="string">&lt;div&gt;</span></span><br><span class="line"><span class="string">  &lt;slot name=&quot;left&quot;&gt;\u&#123;1f50d&#125;&lt;/slot&gt;  &lt;!-- U+1F50D is a magnifying glass --&gt;</span></span><br><span class="line"><span class="string">  &lt;input type=&quot;text&quot; id=&quot;input&quot; /&gt;    &lt;!-- The actual input element --&gt;</span></span><br><span class="line"><span class="string">  &lt;slot name=&quot;right&quot;&gt;\u&#123;2573&#125;&lt;/slot&gt;  &lt;!-- U+2573 is an X --&gt;</span></span><br><span class="line"><span class="string">&lt;/div&gt;</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Finally, we call customElement.define() to register the SearchBox element</span></span><br><span class="line"><span class="comment">// as the implementation of the &lt;search-box&gt; tag. Custom elements are required</span></span><br><span class="line"><span class="comment">// to have a tag name that contains a hyphen.</span></span><br><span class="line">customElements.<span class="title function_">define</span>(<span class="string">&quot;search-box&quot;</span>, <span class="title class_">SearchBox</span>);</span><br></pre></td></tr></table></figure>
<h2 id="15-7-SVG-Scalable-Vector-Graphics"><a href="#15-7-SVG-Scalable-Vector-Graphics" class="headerlink" title="15.7 SVG: Scalable Vector Graphics"></a>15.7 SVG: Scalable Vector Graphics</h2><p>SVG (scalable vector graphics) is an image format. The word â€œvectorâ€ in its name indicates that it is fundamentally different from raster image formats, such as GIF, JPEG, and PNG, that specify a matrix of pixel values. Instead, an SVG â€œimageâ€ is a precise, resolution-independent (hence â€œscalableâ€) description of the steps necessary to draw the desired graphic. SVG images are described by text files using the XML markup language, which is quite similar to HTML.</p>
<p>There are three ways you can use SVG in web browsers:</p>
<p>You can use .svg image files with regular HTML <code>&lt;img&gt;</code> tags, just as you would use a .png or .jpeg image.</p>
<p>Because the XML-based SVG format is so similar to HTML, you can actually embed SVG tags directly into your HTML documents. If you do this, the browserâ€™s HTML parser allows you to omit XML namespaces and treat SVG tags as if they were HTML tags.</p>
<p>You can use the DOM API to dynamically create SVG elements to generate images on demand.</p>
<p>The subsections that follow demonstrate the second and third uses of SVG. Note, however, that SVG has a large and moderately complex grammar. In addition to simple shape-drawing primitives, it includes support for arbitrary curves, text, and animation. SVG graphics can even incorporate JavaScript scripts and CSS stylesheets to add behavior and presentation information. A full description of SVG is well beyond the scope of this book. The goal of this section is just to show you how you can use SVG in your HTML documents and script it with JavaScript.</p>
<h3 id="15-7-1-SVG-in-HTML"><a href="#15-7-1-SVG-in-HTML" class="headerlink" title="15.7.1 SVG in HTML"></a>15.7.1 SVG in HTML</h3><p>SVG images can, of course, be displayed using HTML <code>&lt;img&gt;</code> tags. But you can also embed SVG directly in HTML. And if you do this, you can even use CSS stylesheets to specify things like fonts, colors, and line widths. Here, for example, is an HTML file that uses SVG to display an analog clock face:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>Analog Clock<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css"><span class="comment">/* These CSS styles all apply to the SVG elements defined below */</span></span></span><br><span class="line"><span class="language-css"><span class="selector-id">#clock</span> &#123;                             <span class="comment">/* Styles for everything in the clock:*/</span></span></span><br><span class="line"><span class="language-css">   stroke: black;                    <span class="comment">/* black lines */</span></span></span><br><span class="line"><span class="language-css">   stroke-linecap: round;            <span class="comment">/* with rounded ends */</span></span></span><br><span class="line"><span class="language-css">   fill: <span class="number">#ffe</span>;                       <span class="comment">/* on an off-white background */</span></span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-id">#clock</span> <span class="selector-class">.face</span> &#123; stroke-<span class="attribute">width</span>: <span class="number">3</span>; &#125;    <span class="comment">/* Clock face outline */</span></span></span><br><span class="line"><span class="language-css"><span class="selector-id">#clock</span> <span class="selector-class">.ticks</span> &#123; stroke-<span class="attribute">width</span>: <span class="number">2</span>; &#125;   <span class="comment">/* Lines that mark each hour */</span></span></span><br><span class="line"><span class="language-css"><span class="selector-id">#clock</span> <span class="selector-class">.hands</span> &#123; stroke-<span class="attribute">width</span>: <span class="number">3</span>; &#125;   <span class="comment">/* How to draw the clock hands */</span></span></span><br><span class="line"><span class="language-css"><span class="selector-id">#clock</span> <span class="selector-class">.numbers</span> &#123;                    <span class="comment">/* How to draw the numbers */</span></span></span><br><span class="line"><span class="language-css">    <span class="attribute">font-family</span>: sans-serif; <span class="attribute">font-size</span>: <span class="number">10</span>; <span class="attribute">font-weight</span>: bold;</span></span><br><span class="line"><span class="language-css">    text-anchor: middle; stroke: none; fill: black;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">svg</span> <span class="attr">id</span>=<span class="string">&quot;clock&quot;</span> <span class="attr">viewBox</span>=<span class="string">&quot;0 0 100 100&quot;</span> <span class="attr">width</span>=<span class="string">&quot;250&quot;</span> <span class="attr">height</span>=<span class="string">&quot;250&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- The width and height attributes are the screen size of the graphic --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- The viewBox attribute gives the internal coordinate system --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">circle</span> <span class="attr">class</span>=<span class="string">&quot;face&quot;</span> <span class="attr">cx</span>=<span class="string">&quot;50&quot;</span> <span class="attr">cy</span>=<span class="string">&quot;50&quot;</span> <span class="attr">r</span>=<span class="string">&quot;45&quot;</span>/&gt;</span>  <span class="comment">&lt;!-- the clock face --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">g</span> <span class="attr">class</span>=<span class="string">&quot;ticks&quot;</span>&gt;</span>   <span class="comment">&lt;!-- tick marks for each of the 12 hours --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">line</span> <span class="attr">x1</span>=<span class="string">&#x27;50&#x27;</span> <span class="attr">y1</span>=<span class="string">&#x27;5.000&#x27;</span> <span class="attr">x2</span>=<span class="string">&#x27;50.00&#x27;</span> <span class="attr">y2</span>=<span class="string">&#x27;10.00&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">line</span> <span class="attr">x1</span>=<span class="string">&#x27;72.50&#x27;</span> <span class="attr">y1</span>=<span class="string">&#x27;11.03&#x27;</span> <span class="attr">x2</span>=<span class="string">&#x27;70.00&#x27;</span> <span class="attr">y2</span>=<span class="string">&#x27;15.36&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">line</span> <span class="attr">x1</span>=<span class="string">&#x27;88.97&#x27;</span> <span class="attr">y1</span>=<span class="string">&#x27;27.50&#x27;</span> <span class="attr">x2</span>=<span class="string">&#x27;84.64&#x27;</span> <span class="attr">y2</span>=<span class="string">&#x27;30.00&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">line</span> <span class="attr">x1</span>=<span class="string">&#x27;95.00&#x27;</span> <span class="attr">y1</span>=<span class="string">&#x27;50.00&#x27;</span> <span class="attr">x2</span>=<span class="string">&#x27;90.00&#x27;</span> <span class="attr">y2</span>=<span class="string">&#x27;50.00&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">line</span> <span class="attr">x1</span>=<span class="string">&#x27;88.97&#x27;</span> <span class="attr">y1</span>=<span class="string">&#x27;72.50&#x27;</span> <span class="attr">x2</span>=<span class="string">&#x27;84.64&#x27;</span> <span class="attr">y2</span>=<span class="string">&#x27;70.00&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">line</span> <span class="attr">x1</span>=<span class="string">&#x27;72.50&#x27;</span> <span class="attr">y1</span>=<span class="string">&#x27;88.97&#x27;</span> <span class="attr">x2</span>=<span class="string">&#x27;70.00&#x27;</span> <span class="attr">y2</span>=<span class="string">&#x27;84.64&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">line</span> <span class="attr">x1</span>=<span class="string">&#x27;50.00&#x27;</span> <span class="attr">y1</span>=<span class="string">&#x27;95.00&#x27;</span> <span class="attr">x2</span>=<span class="string">&#x27;50.00&#x27;</span> <span class="attr">y2</span>=<span class="string">&#x27;90.00&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">line</span> <span class="attr">x1</span>=<span class="string">&#x27;27.50&#x27;</span> <span class="attr">y1</span>=<span class="string">&#x27;88.97&#x27;</span> <span class="attr">x2</span>=<span class="string">&#x27;30.00&#x27;</span> <span class="attr">y2</span>=<span class="string">&#x27;84.64&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">line</span> <span class="attr">x1</span>=<span class="string">&#x27;11.03&#x27;</span> <span class="attr">y1</span>=<span class="string">&#x27;72.50&#x27;</span> <span class="attr">x2</span>=<span class="string">&#x27;15.36&#x27;</span> <span class="attr">y2</span>=<span class="string">&#x27;70.00&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">line</span> <span class="attr">x1</span>=<span class="string">&#x27;5.000&#x27;</span> <span class="attr">y1</span>=<span class="string">&#x27;50.00&#x27;</span> <span class="attr">x2</span>=<span class="string">&#x27;10.00&#x27;</span> <span class="attr">y2</span>=<span class="string">&#x27;50.00&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">line</span> <span class="attr">x1</span>=<span class="string">&#x27;11.03&#x27;</span> <span class="attr">y1</span>=<span class="string">&#x27;27.50&#x27;</span> <span class="attr">x2</span>=<span class="string">&#x27;15.36&#x27;</span> <span class="attr">y2</span>=<span class="string">&#x27;30.00&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">line</span> <span class="attr">x1</span>=<span class="string">&#x27;27.50&#x27;</span> <span class="attr">y1</span>=<span class="string">&#x27;11.03&#x27;</span> <span class="attr">x2</span>=<span class="string">&#x27;30.00&#x27;</span> <span class="attr">y2</span>=<span class="string">&#x27;15.36&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">g</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">g</span> <span class="attr">class</span>=<span class="string">&quot;numbers&quot;</span>&gt;</span> <span class="comment">&lt;!-- Number the cardinal directions--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">text</span> <span class="attr">x</span>=<span class="string">&quot;50&quot;</span> <span class="attr">y</span>=<span class="string">&quot;18&quot;</span>&gt;</span>12<span class="tag">&lt;/<span class="name">text</span>&gt;</span><span class="tag">&lt;<span class="name">text</span> <span class="attr">x</span>=<span class="string">&quot;85&quot;</span> <span class="attr">y</span>=<span class="string">&quot;53&quot;</span>&gt;</span>3<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">text</span> <span class="attr">x</span>=<span class="string">&quot;50&quot;</span> <span class="attr">y</span>=<span class="string">&quot;88&quot;</span>&gt;</span>6<span class="tag">&lt;/<span class="name">text</span>&gt;</span><span class="tag">&lt;<span class="name">text</span> <span class="attr">x</span>=<span class="string">&quot;15&quot;</span> <span class="attr">y</span>=<span class="string">&quot;53&quot;</span>&gt;</span>9<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">g</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">g</span> <span class="attr">class</span>=<span class="string">&quot;hands&quot;</span>&gt;</span>   <span class="comment">&lt;!-- Draw hands pointing straight up. --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">line</span> <span class="attr">class</span>=<span class="string">&quot;hourhand&quot;</span> <span class="attr">x1</span>=<span class="string">&quot;50&quot;</span> <span class="attr">y1</span>=<span class="string">&quot;50&quot;</span> <span class="attr">x2</span>=<span class="string">&quot;50&quot;</span> <span class="attr">y2</span>=<span class="string">&quot;25&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">line</span> <span class="attr">class</span>=<span class="string">&quot;minutehand&quot;</span> <span class="attr">x1</span>=<span class="string">&quot;50&quot;</span> <span class="attr">y1</span>=<span class="string">&quot;50&quot;</span> <span class="attr">x2</span>=<span class="string">&quot;50&quot;</span> <span class="attr">y2</span>=<span class="string">&quot;20&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">g</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;clock.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Youâ€™ll notice that the descendants of the <code>&lt;svg&gt;</code> tag are not normal HTML tags. <code>&lt;circle&gt;</code>, <code>&lt;line&gt;</code>, and <code>&lt;text&gt;</code> tags have obvious purposes, though, and it should be clear how this SVG graphic works. There are many other SVG tags, however, and youâ€™ll need to consult an SVG reference to learn more. You may also notice that the stylesheet is odd. Styles like fill, stroke-width, and text-anchor are not normal CSS style properties. In this case, CSS is essentially being used to set attributes of SVG tags that appear in the document. Note also that the CSS font shorthand property does not work for SVG tags, and you must explicitly set font-family, font-size, and font-weight as separate style properties.</p>
<h3 id="15-7-2-Scripting-SVG"><a href="#15-7-2-Scripting-SVG" class="headerlink" title="15.7.2 Scripting SVG"></a>15.7.2 Scripting SVG</h3><p>One reason to embed SVG directly into your HTML files (instead of just using static <code>&lt;img&gt; </code>tags) is that if you do this, then you can use the DOM API to manipulate the SVG image. Suppose you use SVG to display icons in your web application. You could embed SVG within a <code>&lt;template&gt;</code> tag (Â§15.6.2) and then clone the template content whenever you need to insert a copy of that icon into your UI. And if you want the icon to respond to user activityâ€”by changing color when the user hovers the pointer over it, for exampleâ€”you can often achieve this with CSS.</p>
<p>It is also possible to dynamically manipulate SVG graphics that are directly embedded in HTML. The clock face example in the previous section displays a static clock with hour and minute hands facing straight up displaying the time noon or midnight. But you may have noticed that the HTML file includes a <code>&lt;script&gt;</code> tag. That script runs a function periodically to check the time and transform the hour and minute hands by rotating them the appropriate number of degrees so that the clock actually displays the current time, as shown in Figure 15-5.</p>
<p><Figures figure="15-5">A scripted SVG analog clock</Figures></p>
<p>The code to manipulate the clock is straightforward. It determines the proper angle of the hour and minute hands based on the current time, then uses querySelector() to look up the SVG elements that display those hands, then sets a transform attribute on them to rotate them around the center of the clock face. The function uses setTimeout() to ensure that it runs once a minute:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">function</span> <span class="title function_">updateClock</span>(<span class="params"></span>) &#123; <span class="comment">// Update the SVG clock graphic to show current time</span></span><br><span class="line">    <span class="keyword">let</span> now = <span class="keyword">new</span> <span class="title class_">Date</span>();                       <span class="comment">// Current time</span></span><br><span class="line">    <span class="keyword">let</span> sec = now.<span class="title function_">getSeconds</span>();                 <span class="comment">// Seconds</span></span><br><span class="line">    <span class="keyword">let</span> min = now.<span class="title function_">getMinutes</span>() + sec/<span class="number">60</span>;        <span class="comment">// Fractional minutes</span></span><br><span class="line">    <span class="keyword">let</span> hour = (now.<span class="title function_">getHours</span>() % <span class="number">12</span>) + min/<span class="number">60</span>;  <span class="comment">// Fractional hours</span></span><br><span class="line">    <span class="keyword">let</span> minangle = min * <span class="number">6</span>;                     <span class="comment">// 6 degrees per minute</span></span><br><span class="line">    <span class="keyword">let</span> hourangle = hour * <span class="number">30</span>;                  <span class="comment">// 30 degrees per hour</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get SVG elements for the hands of the clock</span></span><br><span class="line">    <span class="keyword">let</span> minhand = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#clock .minutehand&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> hourhand = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#clock .hourhand&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set an SVG attribute on them to move them around the clock face</span></span><br><span class="line">    minhand.<span class="title function_">setAttribute</span>(<span class="string">&quot;transform&quot;</span>, <span class="string">`rotate(<span class="subst">$&#123;minangle&#125;</span>,50,50)`</span>);</span><br><span class="line">    hourhand.<span class="title function_">setAttribute</span>(<span class="string">&quot;transform&quot;</span>, <span class="string">`rotate(<span class="subst">$&#123;hourangle&#125;</span>,50,50)`</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Run this function again in 10 seconds</span></span><br><span class="line">    <span class="built_in">setTimeout</span>(updateClock, <span class="number">10000</span>);</span><br><span class="line">&#125;()); <span class="comment">// Note immediate invocation of the function here.</span></span><br></pre></td></tr></table></figure>
<h3 id="15-7-3-Creating-SVG-Images-with-JavaScript"><a href="#15-7-3-Creating-SVG-Images-with-JavaScript" class="headerlink" title="15.7.3 Creating SVG Images with JavaScript"></a>15.7.3 Creating SVG Images with JavaScript</h3><p>In addition to simply scripting SVG images embedded in your HTML documents, you can also build SVG images from scratch, which can be useful to create visualizations of dynamically loaded data, for example. Example 15-4 demonstrates how you can use JavaScript to create SVG pie charts, like the one shown in Figure 15-6.</p>
<p>Even though SVG tags can be included within HTML documents, they are technically XML tags, not HTML tags, and if you want to create SVG elements with the JavaScript DOM API, you canâ€™t use the normal createElement() function that was introduced in Â§15.3.5. Instead you must use createElementNS(), which takes an XML namespace string as its first argument. For SVG, that namespace is the literal string â€œ<a target="_blank" rel="noopener" href="http://www.w3.org/2000/svg.%E2%80%9D">http://www.w3.org/2000/svg.â€</a></p>
<p><Figures figure="15-6">An SVG pie chart built with JavaScript (data from Stack Overflowâ€™s 2018 Developer Survey of Most Popular Technologies)</Figures></p>
<p>Other than the use of createElementNS(), the pie chartâ€“drawing code in Example 15-4 is relatively straightforward. There is a little math to convert the data being charted into pie-slice angles. The bulk of the example, however, is DOM code that creates SVG elements and sets attributes on those elements.</p>
<p>The most opaque part of this example is the code that draws the actual pie slices. The element used to display each slice is <code>&lt;path&gt;</code>. This SVG element describes arbitrary shapes comprised of lines and curves. The shape description is specified by the d attribute of the <code>&lt;path&gt;</code> element. The value of this attribute uses a compact grammar of letter codes and numbers that specify coordinates, angles, and other values. The letter M, for example, means â€œmove toâ€ and is followed by x and y coordinates. The letter L means â€œline toâ€ and draws a line from the current point to the coordinates that follow it. This example also uses the letter A to draw an arc. This letter is followed by seven numbers describing the arc, and you can look up the syntax online if you want to know more.</p>
<p>Example 15-4. Drawing a pie chart with JavaScript and SVG</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create an &lt;svg&gt; element and draw a pie chart into it.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This function expects an object argument with the following properties:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *   width, height: the size of the SVG graphic, in pixels</span></span><br><span class="line"><span class="comment"> *   cx, cy, r: the center and radius of the pie</span></span><br><span class="line"><span class="comment"> *   lx, ly: the upper-left corner of the chart legend</span></span><br><span class="line"><span class="comment"> *   data: an object whose property names are data labels and whose</span></span><br><span class="line"><span class="comment"> *         property values are the values associated with each label</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The function returns an &lt;svg&gt; element. The caller must insert it into</span></span><br><span class="line"><span class="comment"> * the document in order to make it visible.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">pieChart</span>(<span class="params">options</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> &#123;width, height, cx, cy, r, lx, ly, data&#125; = options;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This is the XML namespace for svg elements</span></span><br><span class="line">    <span class="keyword">let</span> svg = <span class="string">&quot;http://www.w3.org/2000/svg&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create the &lt;svg&gt; element, and specify pixel size and user coordinates</span></span><br><span class="line">    <span class="keyword">let</span> chart = <span class="variable language_">document</span>.<span class="title function_">createElementNS</span>(svg, <span class="string">&quot;svg&quot;</span>);</span><br><span class="line">    chart.<span class="title function_">setAttribute</span>(<span class="string">&quot;width&quot;</span>, width);</span><br><span class="line">    chart.<span class="title function_">setAttribute</span>(<span class="string">&quot;height&quot;</span>, height);</span><br><span class="line">    chart.<span class="title function_">setAttribute</span>(<span class="string">&quot;viewBox&quot;</span>, <span class="string">`0 0 <span class="subst">$&#123;width&#125;</span> <span class="subst">$&#123;height&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Define the text styles we&#x27;ll use for the chart. If we leave these</span></span><br><span class="line">    <span class="comment">// values unset here, they can be set with CSS instead.</span></span><br><span class="line">    chart.<span class="title function_">setAttribute</span>(<span class="string">&quot;font-family&quot;</span>, <span class="string">&quot;sans-serif&quot;</span>);</span><br><span class="line">    chart.<span class="title function_">setAttribute</span>(<span class="string">&quot;font-size&quot;</span>, <span class="string">&quot;18&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get labels and values as arrays and add up the values so we know how</span></span><br><span class="line">    <span class="comment">// big the pie is.</span></span><br><span class="line">    <span class="keyword">let</span> labels = <span class="title class_">Object</span>.<span class="title function_">keys</span>(data);</span><br><span class="line">    <span class="keyword">let</span> values = <span class="title class_">Object</span>.<span class="title function_">values</span>(data);</span><br><span class="line">    <span class="keyword">let</span> total = values.<span class="title function_">reduce</span>(<span class="function">(<span class="params">x,y</span>) =&gt;</span> x+y);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Figure out the angles for all the slices. Slice i starts at angles[i]</span></span><br><span class="line">    <span class="comment">// and ends at angles[i+1]. The angles are measured in radians.</span></span><br><span class="line">    <span class="keyword">let</span> angles = [<span class="number">0</span>];</span><br><span class="line">    values.<span class="title function_">forEach</span>(<span class="function">(<span class="params">x, i</span>) =&gt;</span> angles.<span class="title function_">push</span>(angles[i] + x/total * <span class="number">2</span> * <span class="title class_">Math</span>.<span class="property">PI</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Now loop through the slices of the pie</span></span><br><span class="line">    values.<span class="title function_">forEach</span>(<span class="function">(<span class="params">value, i</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// Compute the two points where our slice intersects the circle</span></span><br><span class="line">        <span class="comment">// These formulas are chosen so that an angle of 0 is at 12 o&#x27;clock</span></span><br><span class="line">        <span class="comment">// and positive angles increase clockwise.</span></span><br><span class="line">        <span class="keyword">let</span> x1 = cx + r * <span class="title class_">Math</span>.<span class="title function_">sin</span>(angles[i]);</span><br><span class="line">        <span class="keyword">let</span> y1 = cy - r * <span class="title class_">Math</span>.<span class="title function_">cos</span>(angles[i]);</span><br><span class="line">        <span class="keyword">let</span> x2 = cx + r * <span class="title class_">Math</span>.<span class="title function_">sin</span>(angles[i+<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">let</span> y2 = cy - r * <span class="title class_">Math</span>.<span class="title function_">cos</span>(angles[i+<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// This is a flag for angles larger than a half circle</span></span><br><span class="line">        <span class="comment">// It is required by the SVG arc drawing component</span></span><br><span class="line">        <span class="keyword">let</span> big = (angles[i+<span class="number">1</span>] - angles[i] &gt; <span class="title class_">Math</span>.<span class="property">PI</span>) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// This string describes how to draw a slice of the pie chart:</span></span><br><span class="line">        <span class="keyword">let</span> path = <span class="string">`M<span class="subst">$&#123;cx&#125;</span>,<span class="subst">$&#123;cy&#125;</span>`</span> +     <span class="comment">// Move to circle center.</span></span><br><span class="line">            <span class="string">`L<span class="subst">$&#123;x1&#125;</span>,<span class="subst">$&#123;y1&#125;</span>`</span> +            <span class="comment">// Draw line to (x1,y1).</span></span><br><span class="line">            <span class="string">`A<span class="subst">$&#123;r&#125;</span>,<span class="subst">$&#123;r&#125;</span> 0 <span class="subst">$&#123;big&#125;</span> 1`</span> +   <span class="comment">// Draw an arc of radius r...</span></span><br><span class="line">            <span class="string">`<span class="subst">$&#123;x2&#125;</span>,<span class="subst">$&#123;y2&#125;</span>`</span> +             <span class="comment">// ...ending at to (x2,y2).</span></span><br><span class="line">            <span class="string">&quot;Z&quot;</span>;                        <span class="comment">// Close path back to (cx,cy).</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Compute the CSS color for this slice. This formula works for only</span></span><br><span class="line">        <span class="comment">// about 15 colors. So don&#x27;t include more than 15 slices in a chart.</span></span><br><span class="line">        <span class="keyword">let</span> color = <span class="string">`hsl(<span class="subst">$&#123;(i*<span class="number">40</span>)%<span class="number">360</span>&#125;</span>,<span class="subst">$&#123;<span class="number">90</span>-<span class="number">3</span>*i&#125;</span>%,<span class="subst">$&#123;<span class="number">50</span>+<span class="number">2</span>*i&#125;</span>%)`</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We describe a slice with a &lt;path&gt; element. Note createElementNS().</span></span><br><span class="line">        <span class="keyword">let</span> slice = <span class="variable language_">document</span>.<span class="title function_">createElementNS</span>(svg, <span class="string">&quot;path&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Now set attributes on the &lt;path&gt; element</span></span><br><span class="line">        slice.<span class="title function_">setAttribute</span>(<span class="string">&quot;d&quot;</span>, path);           <span class="comment">// Set the path for this slice</span></span><br><span class="line">        slice.<span class="title function_">setAttribute</span>(<span class="string">&quot;fill&quot;</span>, color);       <span class="comment">// Set slice color</span></span><br><span class="line">        slice.<span class="title function_">setAttribute</span>(<span class="string">&quot;stroke&quot;</span>, <span class="string">&quot;black&quot;</span>);   <span class="comment">// Outline slice in black</span></span><br><span class="line">        slice.<span class="title function_">setAttribute</span>(<span class="string">&quot;stroke-width&quot;</span>, <span class="string">&quot;1&quot;</span>); <span class="comment">// 1 CSS pixel thick</span></span><br><span class="line">        chart.<span class="title function_">append</span>(slice);                     <span class="comment">// Add slice to chart</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Now draw a little matching square for the key</span></span><br><span class="line">        <span class="keyword">let</span> icon = <span class="variable language_">document</span>.<span class="title function_">createElementNS</span>(svg, <span class="string">&quot;rect&quot;</span>);</span><br><span class="line">        icon.<span class="title function_">setAttribute</span>(<span class="string">&quot;x&quot;</span>, lx);              <span class="comment">// Position the square</span></span><br><span class="line">        icon.<span class="title function_">setAttribute</span>(<span class="string">&quot;y&quot;</span>, ly + <span class="number">30</span>*i);</span><br><span class="line">        icon.<span class="title function_">setAttribute</span>(<span class="string">&quot;width&quot;</span>, <span class="number">20</span>);          <span class="comment">// Size the square</span></span><br><span class="line">        icon.<span class="title function_">setAttribute</span>(<span class="string">&quot;height&quot;</span>, <span class="number">20</span>);</span><br><span class="line">        icon.<span class="title function_">setAttribute</span>(<span class="string">&quot;fill&quot;</span>, color);        <span class="comment">// Same fill color as slice</span></span><br><span class="line">        icon.<span class="title function_">setAttribute</span>(<span class="string">&quot;stroke&quot;</span>, <span class="string">&quot;black&quot;</span>);    <span class="comment">// Same outline, too.</span></span><br><span class="line">        icon.<span class="title function_">setAttribute</span>(<span class="string">&quot;stroke-width&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">        chart.<span class="title function_">append</span>(icon);                      <span class="comment">// Add to the chart</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// And add a label to the right of the rectangle</span></span><br><span class="line">        <span class="keyword">let</span> label = <span class="variable language_">document</span>.<span class="title function_">createElementNS</span>(svg, <span class="string">&quot;text&quot;</span>);</span><br><span class="line">        label.<span class="title function_">setAttribute</span>(<span class="string">&quot;x&quot;</span>, lx + <span class="number">30</span>);        <span class="comment">// Position the text</span></span><br><span class="line">        label.<span class="title function_">setAttribute</span>(<span class="string">&quot;y&quot;</span>, ly + <span class="number">30</span>*i + <span class="number">16</span>);</span><br><span class="line">        label.<span class="title function_">append</span>(<span class="string">`<span class="subst">$&#123;labels[i]&#125;</span> <span class="subst">$&#123;value&#125;</span>`</span>);   <span class="comment">// Add text to label</span></span><br><span class="line">        chart.<span class="title function_">append</span>(label);                     <span class="comment">// Add label to the chart</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> chart;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The pie chart in Figure 15-6 was created using the pieChart() function from Example 15-4, like this:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#chart&quot;</span>).<span class="title function_">append</span>(<span class="title function_">pieChart</span>(&#123;</span><br><span class="line">    <span class="attr">width</span>: <span class="number">640</span>, <span class="attr">height</span>:<span class="number">400</span>,    <span class="comment">// Total size of the chart</span></span><br><span class="line">    <span class="attr">cx</span>: <span class="number">200</span>, <span class="attr">cy</span>: <span class="number">200</span>, <span class="attr">r</span>: <span class="number">180</span>,  <span class="comment">// Center and radius of the pie</span></span><br><span class="line">    <span class="attr">lx</span>: <span class="number">400</span>, <span class="attr">ly</span>: <span class="number">10</span>,           <span class="comment">// Position of the legend</span></span><br><span class="line">    <span class="attr">data</span>: &#123;                    <span class="comment">// The data to chart</span></span><br><span class="line">        <span class="string">&quot;JavaScript&quot;</span>: <span class="number">71.5</span>,</span><br><span class="line">        <span class="string">&quot;Java&quot;</span>: <span class="number">45.4</span>,</span><br><span class="line">        <span class="string">&quot;Bash/Shell&quot;</span>: <span class="number">40.4</span>,</span><br><span class="line">        <span class="string">&quot;Python&quot;</span>: <span class="number">37.9</span>,</span><br><span class="line">        <span class="string">&quot;C#&quot;</span>: <span class="number">35.3</span>,</span><br><span class="line">        <span class="string">&quot;PHP&quot;</span>: <span class="number">31.4</span>,</span><br><span class="line">        <span class="string">&quot;C++&quot;</span>: <span class="number">24.6</span>,</span><br><span class="line">        <span class="string">&quot;C&quot;</span>: <span class="number">22.1</span>,</span><br><span class="line">        <span class="string">&quot;TypeScript&quot;</span>: <span class="number">18.3</span>,</span><br><span class="line">        <span class="string">&quot;Ruby&quot;</span>: <span class="number">10.3</span>,</span><br><span class="line">        <span class="string">&quot;Swift&quot;</span>: <span class="number">8.3</span>,</span><br><span class="line">        <span class="string">&quot;Objective-C&quot;</span>: <span class="number">7.3</span>,</span><br><span class="line">        <span class="string">&quot;Go&quot;</span>: <span class="number">7.2</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>
<h2 id="15-8-Graphics-in-a-lt-canvas-gt"><a href="#15-8-Graphics-in-a-lt-canvas-gt" class="headerlink" title="15.8 Graphics in a &lt;canvas&gt;"></a>15.8 Graphics in a <code>&lt;canvas&gt;</code></h2><p>The <code>&lt;canvas&gt;</code> element has no appearance of its own but creates a drawing surface within the document and exposes a powerful drawing API to client-side JavaScript. The main difference between the <code>&lt;canvas&gt;</code> API and SVG is that with the canvas you create drawings by calling methods, and with SVG you create drawings by building a tree of XML elements. These two approaches are equivalently powerful: either one can be simulated with the other. On the surface, they are quite different, however, and each has its strengths and weaknesses. An SVG drawing, for example, is easily edited by removing elements from its description. To remove an element from the same graphic in a <code>&lt;canvas&gt;</code>, it is often necessary to erase the drawing and redraw it from scratch. Since the Canvas drawing API is JavaScript-based and relatively compact (unlike the SVG grammar), it is documented in more detail in this book.</p>
<p>3D GRAPHICS IN A CANVAS<br>You can also call getContext() with the string â€œwebglâ€ to obtain a context object that allows you to draw 3D graphics using the WebGL API. WebGL is a large, complicated, and low-level API that allows JavaScript programmers to access the GPU, write custom shaders, and perform other very powerful graphics operations. WebGL is not documented in this book, however: web developers are more likely to use utility libraries built on top of WebGL than to use the WebGL API directly.</p>
<p>Most of the Canvas drawing API is defined not on the <code>&lt;canvas&gt;</code> element itself, but instead on a â€œdrawing contextâ€ object obtained with the getContext() method of the canvas. Call getContext() with the argument â€œ2dâ€ to obtain a CanvasRenderingContext2D object that you can use to draw two-dimensional graphics into the canvas.</p>
<p>As a simple example of the Canvas API, the following HTML document uses <code>&lt;canvas&gt;</code> elements and some JavaScript to display two simple shapes:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>This is a red square: <span class="tag">&lt;<span class="name">canvas</span> <span class="attr">id</span>=<span class="string">&quot;square&quot;</span> <span class="attr">width</span>=<span class="string">10</span> <span class="attr">height</span>=<span class="string">10</span>&gt;</span><span class="tag">&lt;/<span class="name">canvas</span>&gt;</span>.</span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>This is a blue circle: <span class="tag">&lt;<span class="name">canvas</span> <span class="attr">id</span>=<span class="string">&quot;circle&quot;</span> <span class="attr">width</span>=<span class="string">10</span> <span class="attr">height</span>=<span class="string">10</span>&gt;</span><span class="tag">&lt;/<span class="name">canvas</span>&gt;</span>.</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> canvas = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#square&quot;</span>);  <span class="comment">// Get first canvas element</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> context = canvas.<span class="title function_">getContext</span>(<span class="string">&quot;2d&quot;</span>);           <span class="comment">// Get 2D drawing context</span></span></span><br><span class="line"><span class="language-javascript">context.<span class="property">fillStyle</span> = <span class="string">&quot;#f00&quot;</span>;                      <span class="comment">// Set fill color to red</span></span></span><br><span class="line"><span class="language-javascript">context.<span class="title function_">fillRect</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">10</span>);                     <span class="comment">// Fill a square</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">canvas = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#circle&quot;</span>);      <span class="comment">// Second canvas element</span></span></span><br><span class="line"><span class="language-javascript">context = canvas.<span class="title function_">getContext</span>(<span class="string">&quot;2d&quot;</span>);               <span class="comment">// Get its context</span></span></span><br><span class="line"><span class="language-javascript">context.<span class="title function_">beginPath</span>();                             <span class="comment">// Begin a new &quot;path&quot;</span></span></span><br><span class="line"><span class="language-javascript">context.<span class="title function_">arc</span>(<span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">2</span>*<span class="title class_">Math</span>.<span class="property">PI</span>, <span class="literal">true</span>);        <span class="comment">// Add a circle to the path</span></span></span><br><span class="line"><span class="language-javascript">context.<span class="property">fillStyle</span> = <span class="string">&quot;#00f&quot;</span>;                      <span class="comment">// Set blue fill color</span></span></span><br><span class="line"><span class="language-javascript">context.<span class="title function_">fill</span>();                                  <span class="comment">// Fill the path</span></span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Weâ€™ve seen that SVG describes complex shapes as a â€œpathâ€ of lines and curves that can be drawn or filled. The Canvas API also uses the notion of a path. Instead of describing a path as a string of letters and numbers, a path is defined by a series of method calls, such as the beginPath() and arc() invocations in the preceding code. Once a path is defined, other methods, such as fill(), operate on that path. Various properties of the context object, such as fillStyle, specify how these operations are performed.</p>
<p>The subsections that follow demonstrate the methods and properties of the 2D Canvas API. Much of the example code that follows operates on a variable c. This variable holds the CanvasRenderingContext2D object of the canvas, but the code to initialize that variable is sometimes not shown. In order to make these examples run, you would need to add HTML markup to define a canvas with appropriate width and height attributes, and then add code like this to initialize the variable c:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> canvas = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#my_canvas_id&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> c = canvas.<span class="title function_">getContext</span>(<span class="string">&#x27;2d&#x27;</span>);</span><br></pre></td></tr></table></figure>
<h3 id="15-8-1-Paths-and-Polygons"><a href="#15-8-1-Paths-and-Polygons" class="headerlink" title="15.8.1 Paths and Polygons"></a>15.8.1 Paths and Polygons</h3><p>To draw lines on a canvas and to fill the areas enclosed by those lines, you begin by defining a path. A path is a sequence of one or more subpaths. A subpath is a sequence of two or more points connected by line segments (or, as weâ€™ll see later, by curve segments). Begin a new path with the beginPath() method. Begin a new subpath with the moveTo() method. Once you have established the starting point of a subpath with moveTo(), you can connect that point to a new point with a straight line by calling lineTo(). The following code defines a path that includes two line segments:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">c.<span class="title function_">beginPath</span>();        <span class="comment">// Start a new path</span></span><br><span class="line">c.<span class="title function_">moveTo</span>(<span class="number">100</span>, <span class="number">100</span>);   <span class="comment">// Begin a subpath at (100,100)</span></span><br><span class="line">c.<span class="title function_">lineTo</span>(<span class="number">200</span>, <span class="number">200</span>);   <span class="comment">// Add a line from (100,100) to (200,200)</span></span><br><span class="line">c.<span class="title function_">lineTo</span>(<span class="number">100</span>, <span class="number">200</span>);   <span class="comment">// Add a line from (200,200) to (100,200)</span></span><br></pre></td></tr></table></figure>
<p>This code simply defines a path; it does not draw anything on the canvas. To draw (or â€œstrokeâ€) the two line segments in the path, call the stroke() method, and to fill the area defined by those line segments, call fill():</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">c.<span class="title function_">fill</span>();             <span class="comment">// Fill a triangular area</span></span><br><span class="line">c.<span class="title function_">stroke</span>();           <span class="comment">// Stroke two sides of the triangle</span></span><br></pre></td></tr></table></figure>
<p>This code (along with some additional code to set line widths and fill colors) produced the drawing shown in Figure 15-7.</p>
<p><Figures figure="15-7">A simple path, filled and stroked</Figures></p>
<p>Notice that the subpath defined in Figure 15-7 is â€œopen.â€ It consists of just two line segments, and the end point is not connected back to the starting point. This means that it does not enclose a region. The fill() method fills open subpaths by acting as if a straight line connected the last point in the subpath to the first point in the subpath. That is why this code fills a triangle, but strokes only two sides of the triangle.</p>
<p>If you wanted to stroke all three sides of the triangle just shown, you would call the closePath() method to connect the end point of the subpath to the start point. (You could also call lineTo(100,100), but then you end up with three line segments that share a start and end point but are not truly closed. When drawing with wide lines, the visual results are better if you use closePath().)</p>
<p>There are two other important points to notice about stroke() and fill(). First, both methods operate on all subpaths in the current path. Suppose we had added another subpath in the preceding code:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">c.<span class="title function_">moveTo</span>(<span class="number">300</span>,<span class="number">100</span>);    <span class="comment">// Begin a new subpath at (300,100);</span></span><br><span class="line">c.<span class="title function_">lineTo</span>(<span class="number">300</span>,<span class="number">200</span>);    <span class="comment">// Draw a vertical line down to (300,200);</span></span><br></pre></td></tr></table></figure>
<p>If we then called stroke(), we would draw two connected edges of a triangle and a disconnected vertical line.</p>
<p>The second point to note about stroke() and fill() is that neither one alters the current path: you can call fill() and the path will still be there when you call stroke(). When you are done with a path and want to begin another, you must remember to call beginPath(). If you donâ€™t, youâ€™ll end up adding new subpaths to the existing path, and you may end up drawing those old subpaths over and over again.</p>
<p>Example 15-5 defines a function for drawing regular polygons and demonstrates the use of moveTo(), lineTo(), and closePath() for defining subpaths and of fill() and stroke() for drawing those paths. It produces the drawing shown in Figure 15-8.</p>
<p><Figures figure="15-8">Regular polygons</Figures></p>
<p>Example 15-5. Regular polygons with moveTo(), lineTo(), and closePath()</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Define a regular polygon with n sides, centered at (x,y) with radius r.</span></span><br><span class="line"><span class="comment">// The vertices are equally spaced along the circumference of a circle.</span></span><br><span class="line"><span class="comment">// Put the first vertex straight up or at the specified angle.</span></span><br><span class="line"><span class="comment">// Rotate clockwise, unless the last argument is true.</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">polygon</span>(<span class="params">c, n, x, y, r, angle=<span class="number">0</span>, counterclockwise=<span class="literal">false</span></span>) &#123;</span><br><span class="line">    c.<span class="title function_">moveTo</span>(x + r*<span class="title class_">Math</span>.<span class="title function_">sin</span>(angle),  <span class="comment">// Begin a new subpath at the first vertex</span></span><br><span class="line">             y - r*<span class="title class_">Math</span>.<span class="title function_">cos</span>(angle)); <span class="comment">// Use trigonometry to compute position</span></span><br><span class="line">    <span class="keyword">let</span> delta = <span class="number">2</span>*<span class="title class_">Math</span>.<span class="property">PI</span>/n;         <span class="comment">// Angular distance between vertices</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">1</span>; i &lt; n; i++) &#123;     <span class="comment">// For each of the remaining vertices</span></span><br><span class="line">        angle += counterclockwise?-<span class="attr">delta</span>:delta; <span class="comment">// Adjust angle</span></span><br><span class="line">        c.<span class="title function_">lineTo</span>(x + r*<span class="title class_">Math</span>.<span class="title function_">sin</span>(angle),         <span class="comment">// Add line to next vertex</span></span><br><span class="line">                 y - r*<span class="title class_">Math</span>.<span class="title function_">cos</span>(angle));</span><br><span class="line">    &#125;</span><br><span class="line">    c.<span class="title function_">closePath</span>();                   <span class="comment">// Connect last vertex back to the first</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Assume there is just one canvas, and get its context object to draw with.</span></span><br><span class="line"><span class="keyword">let</span> c = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;canvas&quot;</span>).<span class="title function_">getContext</span>(<span class="string">&quot;2d&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Start a new path and add polygon subpaths</span></span><br><span class="line">c.<span class="title function_">beginPath</span>();</span><br><span class="line"><span class="title function_">polygon</span>(c, <span class="number">3</span>, <span class="number">50</span>, <span class="number">70</span>, <span class="number">50</span>);                   <span class="comment">// Triangle</span></span><br><span class="line"><span class="title function_">polygon</span>(c, <span class="number">4</span>, <span class="number">150</span>, <span class="number">60</span>, <span class="number">50</span>, <span class="title class_">Math</span>.<span class="property">PI</span>/<span class="number">4</span>);       <span class="comment">// Square</span></span><br><span class="line"><span class="title function_">polygon</span>(c, <span class="number">5</span>, <span class="number">255</span>, <span class="number">55</span>, <span class="number">50</span>);                  <span class="comment">// Pentagon</span></span><br><span class="line"><span class="title function_">polygon</span>(c, <span class="number">6</span>, <span class="number">365</span>, <span class="number">53</span>, <span class="number">50</span>, <span class="title class_">Math</span>.<span class="property">PI</span>/<span class="number">6</span>);       <span class="comment">// Hexagon</span></span><br><span class="line"><span class="title function_">polygon</span>(c, <span class="number">4</span>, <span class="number">365</span>, <span class="number">53</span>, <span class="number">20</span>, <span class="title class_">Math</span>.<span class="property">PI</span>/<span class="number">4</span>, <span class="literal">true</span>); <span class="comment">// Small square inside the hexagon</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Set some properties that control how the graphics will look</span></span><br><span class="line">c.<span class="property">fillStyle</span> = <span class="string">&quot;#ccc&quot;</span>;    <span class="comment">// Light gray interiors</span></span><br><span class="line">c.<span class="property">strokeStyle</span> = <span class="string">&quot;#008&quot;</span>;  <span class="comment">// outlined with dark blue lines</span></span><br><span class="line">c.<span class="property">lineWidth</span> = <span class="number">5</span>;         <span class="comment">// five pixels wide.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Now draw all the polygons (each in its own subpath) with these calls</span></span><br><span class="line">c.<span class="title function_">fill</span>();                <span class="comment">// Fill the shapes</span></span><br><span class="line">c.<span class="title function_">stroke</span>();              <span class="comment">// And stroke their outlines</span></span><br></pre></td></tr></table></figure>
<p>Notice that this example draws a hexagon with a square inside it. The square and the hexagon are separate subpaths, but they overlap. When this happens (or when a single subpath intersects itself), the canvas needs to be able to determine which regions are inside the path and which are outside. The canvas uses a test known as the â€œnonzero winding ruleâ€ to achieve this. In this case, the interior of the square is not filled because the square and the hexagon were drawn in the opposite directions: the vertices of the hexagon were connected with line segments moving clockwise around the circle. The vertices of the square were connected counterclockwise. Had the square been drawn clockwise as well, the call to fill() would have filled the interior of the square as well.</p>
<h3 id="15-8-2-Canvas-Dimensions-and-Coordinates"><a href="#15-8-2-Canvas-Dimensions-and-Coordinates" class="headerlink" title="15.8.2 Canvas Dimensions and Coordinates"></a>15.8.2 Canvas Dimensions and Coordinates</h3><p>The width and height attributes of the <code>&lt;canvas&gt;</code> element and the corresponding width and height properties of the Canvas object specify the dimensions of the canvas. The default canvas coordinate system places the origin (0,0) at the upper-left corner of the canvas. The x coordinates increase to the right and the y coordinates increase as you go down the screen. Points on the canvas can be specified using floating-point values.</p>
<p>The dimensions of a canvas cannot be altered without completely resetting the canvas. Setting either the width or height properties of a Canvas (even setting them to their current value) clears the canvas, erases the current path, and resets all graphics attributes (including current transformation and clipping region) to their original state.</p>
<p>The width and height attributes of a canvas specify the actual number of pixels that the canvas can draw into. Four bytes of memory are allocated for each pixel, so if width and height are both set to 100, the canvas allocates 40,000 bytes to represent 10,000 pixels.</p>
<p>The width and height attributes also specify the default size (in CSS pixels) at which the canvas will be displayed on the screen. If window.devicePixelRatio is 2, then 100 Ã— 100 CSS pixels is actually 40,000 hardware pixels. When the contents of the canvas are drawn onto the screen, the 10,000 pixels in memory will need to be enlarged to cover 40,000 physical pixels on the screen, and this means that your graphics will not be as crisp as they could be.</p>
<p>For optimum image quality, you should not use the width and height attributes to set the on-screen size of the canvas. Instead, set the desired on-screen size CSS pixel size of the canvas with CSS width and height style attributes. Then, before you begin drawing in your JavaScript code, set the width and height properties of the canvas object to the number of CSS pixels times window.devicePixelRatio. Continuing with the preceding example, this technique would result in the canvas being displayed at 100 Ã— 100 CSS pixels but allocating memory for 200 Ã— 200 pixels. (Even with this technique, the user can zoom in on the canvas and may see fuzzy or pixelated graphics if they do. This is in contrast to SVG graphics, which remain crisp no matter the on-screen size or zoom level.)</p>
<h3 id="15-8-3-Graphics-Attributes"><a href="#15-8-3-Graphics-Attributes" class="headerlink" title="15.8.3 Graphics Attributes"></a>15.8.3 Graphics Attributes</h3><p>Example 15-5 set the properties fillStyle, strokeStyle, and lineWidth on the context object of the canvas. These properties are graphics attributes that specify the color to be used by fill() and by stroke(), and the width of the lines to be drawn by stroke(). Notice that these parameters are not passed to the fill() and stroke() methods, but are instead part of the general graphics state of the canvas. If you define a method that draws a shape and do not set these properties yourself, the caller of your method can define the color of the shape by setting the strokeStyle and fillStyle properties before calling your method. This separation of graphics state from drawing commands is fundamental to the Canvas API and is akin to the separation of presentation from content achieved by applying CSS stylesheets to HTML documents.</p>
<p>There are a number of properties (and also some methods) on the context object that affect the graphics state of the canvas. They are detailed below.</p>
<p>LINE STYLES<br>The lineWidth property specifies how wide (in CSS pixels) the lines drawn by stroke() will be. The default value is 1. It is important to understand that line width is determined by the lineWidth property at the time stroke() is called, not at the time that lineTo() and other path-building methods are called. To fully understand the lineWidth property, it is important to visualize paths as infinitely thin one-dimensional lines. The lines and curves drawn by the stroke() method are centered over the path, with half of the lineWidth on either side. If youâ€™re stroking a closed path and only want the line to appear outside the path, stroke the path first, then fill with an opaque color to hide the portion of the stroke that appears inside the path. Or if you only want the line to appear inside a closed path, call the save() and clip() methods first, then call stroke() and restore(). (The save(), restore(), and clip() methods are described later.)</p>
<p>When drawing lines that are more than about two pixels wide, the lineCap and lineJoin properties can have a significant impact on the visual appearance of the ends of a path and the vertices at which two path segments meet. Figure 15-9 illustrates the values and resulting graphical appearance of lineCap and lineJoin.</p>
<p><Figures figure="15-9">The lineCap and lineJoin attributes</Figures></p>
<p>The default value for lineCap is â€œbutt.â€ The default value for lineJoin is â€œmiter.â€ Note, however, that if two lines meet at a very narrow angle, then the resulting miter can become quite long and visually distracting. If the miter at a given vertex would be longer than half of the line width times the miterLimit property, that vertex will be drawn with a beveled join instead of a mitered join. The default value for miterLimit is 10.</p>
<p>The stroke() method can draw dashed and dotted lines as well as solid lines, and a canvasâ€™s graphics state includes an array of numbers that serves as a â€œdash patternâ€ by specifying how many pixels to draw, then how many to omit. Unlike other line-drawing properties, the dash pattern is set and queried with the methods setLineDash() and getLineDash() instead of with a property. To specify a dotted dash pattern, you might use setLineDash() like this:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c.<span class="title function_">setLineDash</span>([<span class="number">18</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>]); <span class="comment">// 18px dash, 3px space, 3px dot, 3px space</span></span><br></pre></td></tr></table></figure>
<p>Finally, the lineDashOffset property specifies how far into the dash pattern drawing should begin. The default is 0. Paths stroked with the dash pattern shown here begin with an 18-pixel dash, but if lineDashOffset is set to 21, then that same path would begin with a dot followed by a space and a dash.</p>
<p>COLORS, PATTERNS, AND GRADIENTS<br>The fillStyle and strokeStyle properties specify how paths are filled and stroked. The word â€œstyleâ€ often means color, but these properties can also be used to specify a color gradient or an image to be used for filling and stroking. (Note that drawing a line is basically the same as filling a narrow region on both sides of the line, and filling and stroking are fundamentally the same operation.)</p>
<p>If you want to fill or stroke with a solid color (or a translucent color), simply set these properties to a valid CSS color string. Nothing else is required.</p>
<p>To fill (or stroke) with a color gradient, set fillStyle (or strokeStyle) to a CanvasGradient object returned by the createLinearGradient() or createRadialGradient() methods of the context. The arguments to createLinearGradient() are the coordinates of two points that define a line (it does not need to be horizontal or vertical) along which the colors will vary. The arguments to createRadialGradient() specify the centers and radii of two circles. (They need not be concentric, but the first circle typically lies entirely inside the second.) Areas inside the smaller circle or outside the larger will be filled with solid colors; areas between the two will be filled with a color gradient.</p>
<p>After creating the CanvasGradient object that defines the regions of the canvas that will be filled, you must define the gradient colors by calling the addColorStop() method of the CanvasGradient. The first argument to this method is a number between 0.0 and 1.0. The second argument is a CSS color specification. You must call this method at least twice to define a simple color gradient, but you may call it more than that. The color at 0.0 will appear at the start of the gradient, and the color at 1.0 will appear at the end. If you specify additional colors, they will appear at the specified fractional position within the gradient. Between the points you specify, colors will be smoothly interpolated. Here are some examples:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A linear gradient, diagonally across the canvas (assuming no transforms)</span></span><br><span class="line"><span class="keyword">let</span> bgfade = c.<span class="title function_">createLinearGradient</span>(<span class="number">0</span>,<span class="number">0</span>,canvas.<span class="property">width</span>,canvas.<span class="property">height</span>);</span><br><span class="line">bgfade.<span class="title function_">addColorStop</span>(<span class="number">0.0</span>, <span class="string">&quot;#88f&quot;</span>);  <span class="comment">// Start with light blue in upper left</span></span><br><span class="line">bgfade.<span class="title function_">addColorStop</span>(<span class="number">1.0</span>, <span class="string">&quot;#fff&quot;</span>);  <span class="comment">// Fade to white in lower right</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// A gradient between two concentric circles. Transparent in the middle</span></span><br><span class="line"><span class="comment">// fading to translucent gray and then back to transparent.</span></span><br><span class="line"><span class="keyword">let</span> donut = c.<span class="title function_">createRadialGradient</span>(<span class="number">300</span>,<span class="number">300</span>,<span class="number">100</span>, <span class="number">300</span>,<span class="number">300</span>,<span class="number">300</span>);</span><br><span class="line">donut.<span class="title function_">addColorStop</span>(<span class="number">0.0</span>, <span class="string">&quot;transparent&quot;</span>);           <span class="comment">// Transparent</span></span><br><span class="line">donut.<span class="title function_">addColorStop</span>(<span class="number">0.7</span>, <span class="string">&quot;rgba(100,100,100,.9)&quot;</span>);  <span class="comment">// Translucent gray</span></span><br><span class="line">donut.<span class="title function_">addColorStop</span>(<span class="number">1.0</span>, <span class="string">&quot;rgba(0,0,0,0)&quot;</span>);         <span class="comment">// Transparent again</span></span><br></pre></td></tr></table></figure>
<p>An important point to understand about gradients is that they are not position-independent. When you create a gradient, you specify bounds for the gradient. If you then attempt to fill an area outside of those bounds, youâ€™ll get the solid color defined at one end or the other of the gradient.</p>
<p>In addition to colors and color gradients, you can also fill and stroke using images. To do this, set fillStyle or strokeStyle to a CanvasPattern returned by the createPattern() method of the context object. The first argument to this method should be an <code>&lt;img&gt;</code> or <code>&lt;canvas&gt;</code> element that contains the image you want to fill or stroke with. (Note that the source image or canvas does not need to be inserted into the document in order to be used in this way.) The second argument to createPattern() is the string â€œrepeat,â€ â€œrepeat-x,â€ â€œrepeat-y,â€ or â€œno-repeat,â€ which specifies whether (and in which dimensions) the background images repeat.</p>
<p>TEXT STYLES<br>The font property specifies the font to be used by the text-drawing methods fillText() and strokeText() (see â€œTextâ€). The value of the font property should be a string in the same syntax as the CSS font attribute.</p>
<p>The textAlign property specifies how the text should be horizontally aligned with respect to the X coordinate passed to fillText() or strokeText(). Legal values are â€œstart,â€ â€œleft,â€ â€œcenter,â€ â€œright,â€ and â€œend.â€ The default is â€œstart,â€ which, for left-to-right text, has the same meaning as â€œleft.â€</p>
<p>The textBaseline property specifies how the text should be vertically aligned with respect to the y coordinate. The default value is â€œalphabetic,â€ and it is appropriate for Latin and similar scripts. The value â€œideographicâ€ is intended for use with scripts such as Chinese and Japanese. The value â€œhangingâ€ is intended for use with Devanagari and similar scripts (which are used for many of the languages of India). The â€œtop,â€ â€œmiddle,â€ and â€œbottomâ€ baselines are purely geometric baselines, based on the â€œem squareâ€ of the font.</p>
<p>SHADOWS<br>Four properties of the context object control the drawing of drop shadows. If you set these properties appropriately, any line, area, text, or image you draw will be given a shadow, which will make it appear as if it is floating above the canvas surface.</p>
<p>The shadowColor property specifies the color of the shadow. The default is fully transparent black, and shadows will never appear unless you set this property to a translucent or opaque color. This property can only be set to a color string: patterns and gradients are not allowed for shadows. Using a translucent shadow color produces the most realistic shadow effects because it allows the background to show through.</p>
<p>The shadowOffsetX and shadowOffsetY properties specify the X and Y offsets of the shadow. The default for both properties is 0, which places the shadow directly beneath your drawing, where it is not visible. If you set both properties to a positive value, shadows will appear below and to the right of what you draw, as if there were a light source above and to the left, shining onto the canvas from outside the computer screen. Larger offsets produce larger shadows and make drawn objects appear as if they are floating â€œhigherâ€ above the canvas. These values are not affected by coordinate transformations (Â§15.8.5): shadow direction and â€œheightâ€ remain consistent even when shapes are rotated and scaled.</p>
<p>The shadowBlur property specifies how blurred the edges of the shadow are. The default value is 0, which produces crisp, unblurred shadows. Larger values produce more blur, up to an implementation-defined upper bound.</p>
<p>TRANSLUCENCY AND COMPOSITING<br>If you want to stroke or fill a path using a translucent color, you can set strokeStyle or fillStyle using a CSS color syntax like â€œrgba(â€¦)â€ that supports alpha transparency. The â€œaâ€ in â€œRGBAâ€ stands for â€œalphaâ€ and is a value between 0 (fully transparent) and 1 (fully opaque). But the Canvas API provides another way to work with translucent colors. If you do not want to explicitly specify an alpha channel for each color, or if you want to add translucency to opaque images or patterns, you can set the globalAlpha property. Every pixel you draw will have its alpha value multiplied by globalAlpha. The default is 1, which adds no transparency. If you set globalAlpha to 0, everything you draw will be fully transparent, and nothing will appear in the canvas. But if you set this property to 0.5, then pixels that would otherwise have been opaque will be 50% opaque, and pixels that would have been 50% opaque will be 25% opaque instead.</p>
<p>When you stroke lines, fill regions, draw text, or copy images, you generally expect the new pixels to be drawn on top of the pixels that are already in the canvas. If you are drawing opaque pixels, they simply replace the pixels that are already there. If you are drawing with translucent pixels, the new (â€œsourceâ€) pixel is combined with the old (â€œdestinationâ€) pixel so that the old pixel shows through the new pixel based on how transparent that pixel is.</p>
<p>This process of combining new (possibly translucent) source pixels with existing (possibly translucent) destination pixels is called compositing, and the compositing process described previously is the default way that the Canvas API combines pixels. But you can set the globalCompositeOperation property to specify other ways of combining pixels. The default value is â€œsource-over,â€ which means that source pixels are drawn â€œoverâ€ the destination pixels and are combined with them if the source is translucent. But if you set globalCompositeOperation to â€œdestination-overâ€, then the canvas will combine pixels as if the new source pixels were drawn beneath the existing destination pixels. If the destination is translucent or transparent, some or all of the source pixel color is visible in the resulting color. As another example, the compositing mode â€œsource-atopâ€ combines the source pixels with the transparency of the destination pixels so that nothing is drawn on portions of the canvas that are already fully transparent. There are a number of legal values for globalCompositeOperation, but most have only specialized uses and are not covered here.</p>
<p>SAVING AND RESTORING GRAPHICS STATE<br>Since the Canvas API defines graphics attributes on the context object, you might be tempted to call getContext() multiple times to obtain multiple context objects. If you could do this, you could define different attributes on each context: each context would then be like a different brush and would paint with a different color or draw lines of different widths. Unfortunately, you cannot use the canvas in this way. Each <code>&lt;canvas&gt;</code> element has only a single context object, and every call to getContext() returns the same CanvasRenderingContext2D object.</p>
<p>Although the Canvas API only allows you to define a single set of graphics attributes at a time, it does allow you to save the current graphics state so that you can alter it and then easily restore it later. The save() method pushes the current graphics state onto a stack of saved states. The restore() method pops the stack and restores the most recently saved state. All of the properties that have been described in this section are part of the saved state, as are the current transformation and clipping region (both of which are explained later). Importantly, the currently defined path and the current point are not part of the graphics state and cannot be saved and restored.</p>
<h3 id="15-8-4-Canvas-Drawing-Operations"><a href="#15-8-4-Canvas-Drawing-Operations" class="headerlink" title="15.8.4 Canvas Drawing Operations"></a>15.8.4 Canvas Drawing Operations</h3><p>Weâ€™ve already seen some basic canvas methodsâ€”beginPath(), moveTo(), lineTo(), closePath(), fill(), and stroke()â€”for defining, filling, and drawing lines and polygons. But the Canvas API includes other drawing methods as well.</p>
<p>RECTANGLES<br>CanvasRenderingContext2D defines four methods for drawing rectangles. All four of these rectangle methods expect two arguments that specify one corner of the rectangle followed by the rectangle width and height. Normally, you specify the upper-left corner and then pass a positive width and positive height, but you may also specify other corners and pass negative dimensions.</p>
<p>fillRect() fills the specified rectangle with the current fillStyle. strokeRect() strokes the outline of the specified rectangle using the current strokeStyle and other line attributes. clearRect() is like fillRect(), but it ignores the current fill style and fills the rectangle with transparent black pixels (the default color of all blank canvases). The important thing about these three methods is that they do not affect the current path or the current point within that path.</p>
<p>The final rectangle method is named rect(), and it does affect the current path: it adds the specified rectangle, in a subpath of its own, to the path. Like other path-definition methods, it does not fill or stroke anything itself.</p>
<p>CURVES<br>A path is a sequence of subpaths, and a subpath is a sequence of connected points. In the paths we defined in Â§15.8.1, those points were connected with straight line segments, but that need not always be the case. The CanvasRenderingContext2D object defines a number of methods that add a new point to the subpath and connect the current point to that new point with a curve:</p>
<p>arc()<br>This method adds a circle, or a portion of a circle (an arc), to the path. The arc to be drawn is specified with six parameters: the x and y coordinates of the center of a circle, the radius of the circle, the start and end angles of the arc, and the direction (clockwise or counterclockwise) of the arc between those two angles. If there is a current point in the path, then this method connects the current point to the beginning of the arc with a straight line (which is useful when drawing wedges or pie slices), then connects the beginning of the arc to the end of the arc with a portion of a circle, leaving the end of the arc as the new current point. If there is no current point when this method is called, then it only adds the circular arc to the path.</p>
<p>ellipse()<br>This method is much like arc() except that it adds an ellipse or a portion of an ellipse to the path. Instead of one radius, it has two: an x-axis radius and a y-axis radius. Also, because ellipses are not radially symmetrical, this method takes another argument that specifies the number of radians by which the ellipse is rotated clockwise about its center.</p>
<p>arcTo()<br>This method draws a straight line and a circular arc just like the arc() method does, but it specifies the arc to be drawn using different parameters. The arguments to arcTo() specify points P1 and P2 and a radius. The arc that is added to the path has the specified radius. It begins at the tangent point with the (imaginary) line from the current point to P1 and ends at the tangent point with the (imaginary) line between P1 and P2. This unusual-seeming method of specifying arcs is actually quite useful for drawing shapes with rounded corners. If you specify a radius of 0, this method just draws a straight line from the current point to P1. With a nonzero radius, however, it draws a straight line from the current point in the direction of P1, then curves that line around in a circle until it is heading in the direction of P2.</p>
<p>bezierCurveTo()<br>This method adds a new point P to the subpath and connects it to the current point with a cubic Bezier curve. The shape of the curve is specified by two â€œcontrol points,â€ C1 and C2. At the start of the curve (at the current point), the curve heads in the direction of C1. At the end of the curve (at point P), the curve arrives from the direction of C2. In between these points, the direction of the curve varies smoothly. The point P becomes the new current point for the subpath.</p>
<p>quadraticCurveTo()<br>This method is like bezierCurveTo(), but it uses a quadratic Bezier curve instead of a cubic Bezier curve and has only a single control point.</p>
<p>You can use these methods to draw paths like those in Figure 15-10.</p>
<p><Figures figure="15-10">Curved paths in a canvas</Figures></p>
<p>Example 15-6 shows the code used to create Figure 15-10. The methods demonstrated in this code are some of the most complicated in the Canvas API; consult an online reference for complete details on the methods and their arguments.</p>
<p>Example 15-6. Adding curves to a path</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A utility function to convert angles from degrees to radians</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">rads</span>(<span class="params">x</span>) &#123; <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="property">PI</span>*x/<span class="number">180</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Get the context object of the document&#x27;s canvas element</span></span><br><span class="line"><span class="keyword">let</span> c = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;canvas&quot;</span>).<span class="title function_">getContext</span>(<span class="string">&quot;2d&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Define some graphics attributes and draw the curves</span></span><br><span class="line">c.<span class="property">fillStyle</span> = <span class="string">&quot;#aaa&quot;</span>;     <span class="comment">// Gray fills</span></span><br><span class="line">c.<span class="property">lineWidth</span> = <span class="number">2</span>;          <span class="comment">// 2-pixel black (by default) lines</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Draw a circle.</span></span><br><span class="line"><span class="comment">// There is no current point, so draw just the circle with no straight</span></span><br><span class="line"><span class="comment">// line from the current point to the start of the circle.</span></span><br><span class="line">c.<span class="title function_">beginPath</span>();</span><br><span class="line">c.<span class="title function_">arc</span>(<span class="number">75</span>,<span class="number">100</span>,<span class="number">50</span>,          <span class="comment">// Center at (75,100), radius 50</span></span><br><span class="line">      <span class="number">0</span>,<span class="title function_">rads</span>(<span class="number">360</span>),<span class="literal">false</span>); <span class="comment">// Go clockwise from 0 to 360 degrees</span></span><br><span class="line">c.<span class="title function_">fill</span>();                 <span class="comment">// Fill the circle</span></span><br><span class="line">c.<span class="title function_">stroke</span>();               <span class="comment">// Stroke its outline.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Now draw an ellipse in the same way</span></span><br><span class="line">c.<span class="title function_">beginPath</span>();            <span class="comment">// Start new path not connected to the circle</span></span><br><span class="line">c.<span class="title function_">ellipse</span>(<span class="number">200</span>, <span class="number">100</span>, <span class="number">50</span>, <span class="number">35</span>, <span class="title function_">rads</span>(<span class="number">15</span>),  <span class="comment">// Center, radii, and rotation</span></span><br><span class="line">          <span class="number">0</span>, <span class="title function_">rads</span>(<span class="number">360</span>), <span class="literal">false</span>);        <span class="comment">// Start angle, end angle, direction</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Draw a wedge. Angles are measured clockwise from the positive x axis.</span></span><br><span class="line"><span class="comment">// Note that arc() adds a line from the current point to the arc start.</span></span><br><span class="line">c.<span class="title function_">moveTo</span>(<span class="number">325</span>, <span class="number">100</span>);       <span class="comment">// Start at the center of the circle.</span></span><br><span class="line">c.<span class="title function_">arc</span>(<span class="number">325</span>, <span class="number">100</span>, <span class="number">50</span>,       <span class="comment">// Circle center and radius</span></span><br><span class="line">      <span class="title function_">rads</span>(-<span class="number">60</span>), <span class="title function_">rads</span>(<span class="number">0</span>), <span class="comment">// Start at angle -60 and go to angle 0</span></span><br><span class="line">      <span class="literal">true</span>);              <span class="comment">// counterclockwise</span></span><br><span class="line">c.<span class="title function_">closePath</span>();            <span class="comment">// Add radius back to the center of the circle</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Similar wedge, offset a bit, and in the opposite direction</span></span><br><span class="line">c.<span class="title function_">moveTo</span>(<span class="number">340</span>, <span class="number">92</span>);</span><br><span class="line">c.<span class="title function_">arc</span>(<span class="number">340</span>, <span class="number">92</span>, <span class="number">42</span>, <span class="title function_">rads</span>(-<span class="number">60</span>), <span class="title function_">rads</span>(<span class="number">0</span>), <span class="literal">false</span>);</span><br><span class="line">c.<span class="title function_">closePath</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Use arcTo() for rounded corners. Here we draw a square with</span></span><br><span class="line"><span class="comment">// upper left corner at (400,50) and corners of varying radii.</span></span><br><span class="line">c.<span class="title function_">moveTo</span>(<span class="number">450</span>, <span class="number">50</span>);           <span class="comment">// Begin in the middle of the top edge.</span></span><br><span class="line">c.<span class="title function_">arcTo</span>(<span class="number">500</span>,<span class="number">50</span>,<span class="number">500</span>,<span class="number">150</span>,<span class="number">30</span>);  <span class="comment">// Add part of top edge and upper right corner.</span></span><br><span class="line">c.<span class="title function_">arcTo</span>(<span class="number">500</span>,<span class="number">150</span>,<span class="number">400</span>,<span class="number">150</span>,<span class="number">20</span>); <span class="comment">// Add right edge and lower right corner.</span></span><br><span class="line">c.<span class="title function_">arcTo</span>(<span class="number">400</span>,<span class="number">150</span>,<span class="number">400</span>,<span class="number">50</span>,<span class="number">10</span>);  <span class="comment">// Add bottom edge and lower left corner.</span></span><br><span class="line">c.<span class="title function_">arcTo</span>(<span class="number">400</span>,<span class="number">50</span>,<span class="number">500</span>,<span class="number">50</span>,<span class="number">0</span>);    <span class="comment">// Add left edge and upper left corner.</span></span><br><span class="line">c.<span class="title function_">closePath</span>();               <span class="comment">// Close path to add the rest of the top edge.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Quadratic Bezier curve: one control point</span></span><br><span class="line">c.<span class="title function_">moveTo</span>(<span class="number">525</span>, <span class="number">125</span>);                      <span class="comment">// Begin here</span></span><br><span class="line">c.<span class="title function_">quadraticCurveTo</span>(<span class="number">550</span>, <span class="number">75</span>, <span class="number">625</span>, <span class="number">125</span>);   <span class="comment">// Draw a curve to (625, 125)</span></span><br><span class="line">c.<span class="title function_">fillRect</span>(<span class="number">550</span>-<span class="number">3</span>, <span class="number">75</span>-<span class="number">3</span>, <span class="number">6</span>, <span class="number">6</span>);           <span class="comment">// Mark the control point (550,75)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Cubic Bezier curve</span></span><br><span class="line">c.<span class="title function_">moveTo</span>(<span class="number">625</span>, <span class="number">100</span>);                      <span class="comment">// Start at (625, 100)</span></span><br><span class="line">c.<span class="title function_">bezierCurveTo</span>(<span class="number">645</span>,<span class="number">70</span>,<span class="number">705</span>,<span class="number">130</span>,<span class="number">725</span>,<span class="number">100</span>); <span class="comment">// Curve to (725, 100)</span></span><br><span class="line">c.<span class="title function_">fillRect</span>(<span class="number">645</span>-<span class="number">3</span>, <span class="number">70</span>-<span class="number">3</span>, <span class="number">6</span>, <span class="number">6</span>);           <span class="comment">// Mark control points</span></span><br><span class="line">c.<span class="title function_">fillRect</span>(<span class="number">705</span>-<span class="number">3</span>, <span class="number">130</span>-<span class="number">3</span>, <span class="number">6</span>, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Finally, fill the curves and stroke their outlines.</span></span><br><span class="line">c.<span class="title function_">fill</span>();</span><br><span class="line">c.<span class="title function_">stroke</span>();</span><br></pre></td></tr></table></figure>
<p>TEXT<br>To draw text in a canvas, you normally use the fillText() method, which draws text using the color (or gradient or pattern) specified by the fillStyle property. For special effects at large text sizes, you can use strokeText() to draw the outline of the individual font glyphs. Both methods take the text to be drawn as their first argument and take the x and y coordinates of the text as the second and third arguments. Neither method affects the current path or the current point.</p>
<p>fillText() and strokeText() take an optional fourth argument. If given, this argument specifies the maximum width of the text to be displayed. If the text would be wider than the specified value when drawn using the font property, the canvas will make it fit by scaling it or by using a narrower or smaller font.</p>
<p>If you need to measure text yourself before drawing it, pass it to the measureText() method. This method returns a TextMetrics object that specifies the measurements of the text when drawn with the current font. At the time of this writing, the only â€œmetricâ€ contained in the TextMetrics object is the width. Query the on-screen width of a string like this:</p>
<p>let width &#x3D; c.measureText(text).width;<br>This is useful if you want to center a string of text within a canvas, for example.</p>
<p>IMAGES<br>In addition to vector graphics (paths, lines, etc.), the Canvas API also supports bitmap images. The drawImage() method copies the pixels of a source image (or of a rectangle within the source image) onto the canvas, scaling and rotating the pixels of the image as necessary.</p>
<p>drawImage() can be invoked with three, five, or nine arguments. In all cases, the first argument is the source image from which pixels are to be copied. This image argument is often an <code>&lt;img&gt;</code> element, but it can also be another <code>&lt;canvas&gt;</code> element or even a <code>&lt;video&gt;</code> element (from which a single frame will be copied). If you specify an <code>&lt;img&gt;</code> or <code>&lt;video&gt;</code> element that is still loading its data, the drawImage() call will do nothing.</p>
<p>In the three-argument version of drawImage(), the second and third arguments specify the x and y coordinates at which the upper-left corner of the image is to be drawn. In this version of the method, the entire source image is copied to the canvas. The x and y coordinates are interpreted in the current coordinate system, and the image is scaled and rotated if necessary, depending on the canvas transform currently in effect.</p>
<p>The five-argument version of drawImage() adds width and height arguments to the x and y arguments described earlier. These four arguments define a destination rectangle within the canvas. The upper-left corner of the source image goes at (x,y), and the lower-right corner goes at (x+width, y+height). Again, the entire source image is copied. With this version of the method, the source image will be scaled to fit the destination rectangle.</p>
<p>The nine-argument version of drawImage() specifies both a source rectangle and a destination rectangle and copies only the pixels within the source rectangle. Arguments two through five specify the source rectangle. They are measured in CSS pixels. If the source image is another canvas, the source rectangle uses the default coordinate system for that canvas and ignores any transformations that have been specified. Arguments six through nine specify the destination rectangle into which the image is drawn and are in the current coordinate system of the canvas, not in the default coordinate system.</p>
<p>In addition to drawing images into a canvas, we can also extract the content of a canvas as an image using the toDataURL() method. Unlike all the other methods described here, toDataURL() is a method of the Canvas element itself, not of the context object. You normally invoke toDataURL() with no arguments, and it returns the content of the canvas as a PNG image, encoded as a string using a data: URL. The returned URL is suitable for use with an <code>&lt;img&gt;</code> element, and you can make a static snapshot of a canvas with code like this:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> img = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;img&quot;</span>);  <span class="comment">// Create an &lt;img&gt; element</span></span><br><span class="line">img.<span class="property">src</span> = canvas.<span class="title function_">toDataURL</span>();             <span class="comment">// Set its src attribute</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(img);           <span class="comment">// Append it to the document</span></span><br></pre></td></tr></table></figure>
<h3 id="15-8-5-Coordinate-System-Transforms"><a href="#15-8-5-Coordinate-System-Transforms" class="headerlink" title="15.8.5 Coordinate System Transforms"></a>15.8.5 Coordinate System Transforms</h3><p>As weâ€™ve noted, the default coordinate system of a canvas places the origin in the upper-left corner, has x coordinates increasing to the right, and has y coordinates increasing downward. In this default system, the coordinates of a point map directly to a CSS pixel (which then maps directly to one or more device pixels). Certain canvas operations and attributes (such as extracting raw pixel values and setting shadow offsets) always use this default coordinate system. In addition to the default coordinate system, however, every canvas has a â€œcurrent transformation matrixâ€ as part of its graphics state. This matrix defines the current coordinate system of the canvas. In most canvas operations, when you specify the coordinates of a point, it is taken to be a point in the current coordinate system, not in the default coordinate system. The current transformation matrix is used to convert the coordinates you specified to the equivalent coordinates in the default coordinate system.</p>
<p>The setTransform() method allows you to set a canvasâ€™s transformation matrix directly, but coordinate system transformations are usually easier to specify as a sequence of translations, rotations, and scaling operations. Figure 15-11 illustrates these operations and their effect on the canvas coordinate system. The program that produced the figure drew the same set of axes seven times in a row. The only thing that changed each time was the current transform. Notice that the transforms affect the text as well as the lines that are drawn.</p>
<p><Figures figure="15-11">Coordinate system transformations</Figures></p>
<p>The translate() method simply moves the origin of the coordinate system left, right, up, or down. The rotate() method rotates the axes clockwise by the specified angle. (The Canvas API always specifies angles in radians. To convert degrees to radians, divide by 180 and multiply by Math.PI.) The scale() method stretches or contracts distances along the x or y axes.</p>
<p>Passing a negative scale factor to the scale() method flips that axis across the origin, as if it were reflected in a mirror. This is what was done in the lower left of Figure 15-11: translate() was used to move the origin to the bottom-left corner of the canvas, then scale() was used to flip the y axis around so that y coordinates increase as we go up the page. A flipped coordinate system like this is familiar from algebra class and may be useful for plotting data points on charts. Note, however, that it makes text difficult to read!</p>
<p>UNDERSTANDING TRANSFORMATIONS MATHEMATICALLY<br>I find it easiest to understand transforms geometrically, thinking about translate(), rotate(), and scale() as transforming the axes of the coordinate system as illustrated in Figure 15-11. It is also possible to understand transforms algebraically as equations that map the coordinates of a point (x,y) in the transformed coordinate system back to the coordinates (xâ€™,yâ€™) of the same point in the previous coordinate system.</p>
<p>The method call c.translate(dx,dy) can be described with these equations:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">x<span class="string">&#x27; = x + dx;  // An X coordinate of 0 in the new system is dx in the old</span></span><br><span class="line"><span class="string">y&#x27;</span> = y + dy;</span><br></pre></td></tr></table></figure>
<p>Scaling operations have similarly simple equations. A call c.scale(sx,sy) can be described like this:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">x<span class="string">&#x27; = sx * x;</span></span><br><span class="line"><span class="string">y&#x27;</span> = sy * y;</span><br></pre></td></tr></table></figure>
<p>Rotations are more complicated. The call c.rotate(a) is described by these trigonometric equations:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">x<span class="string">&#x27; = x * cos(a) - y * sin(a);</span></span><br><span class="line"><span class="string">y&#x27;</span> = y * <span class="title function_">cos</span>(a) + x * <span class="title function_">sin</span>(a);</span><br></pre></td></tr></table></figure>
<p>Notice that the order of transformations matters. Suppose we start with the default coordinate system of a canvas, then translate it, and then scale it. In order to map the point (x,y) in the current coordinate system back to the point (xâ€™â€™,yâ€™â€™) in the default coordinate system, we must first apply the scaling equations to map the point to an intermediate point (xâ€™,yâ€™) in the translated but unscaled coordinate system, then use the translation equations to map from this intermediate point to (xâ€™â€™,yâ€™â€™). The result is this:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">x<span class="string">&#x27;&#x27;</span> = sx*x + dx;</span><br><span class="line">y<span class="string">&#x27;&#x27;</span> = sy*y + dy;</span><br></pre></td></tr></table></figure>
<p>If, on the other hand, weâ€™d called scale() before calling translate(), the resulting equations would be different:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">x<span class="string">&#x27;&#x27;</span> = sx*(x + dx);</span><br><span class="line">y<span class="string">&#x27;&#x27;</span> = sy*(y + dy);</span><br></pre></td></tr></table></figure>
<p>The key thing to remember when thinking algebraically about sequences of transformations is that you must work backward from the last (most recent) transformation to the first. When thinking geometrically about transformed axes, however, you work forward from first transformation to last.</p>
<p>The transformations supported by the canvas are known as affine transforms. Affine transforms may modify the distances between points and the angles between lines, but parallel lines always remain parallel after an affine transformationâ€”it is not possible, for example, to specify a fish-eye lens distortion with an affine transform. An arbitrary affine transform can be described by the six parameters a through f in these equations:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">x<span class="string">&#x27; = ax + cy + e</span></span><br><span class="line"><span class="string">y&#x27;</span> = bx + dy + f</span><br></pre></td></tr></table></figure>
<p>You can apply an arbitrary transformation to the current coordinate system by passing those six parameters to the transform() method. Figure 15-11 illustrates two types of transformationsâ€”shears and rotations about a specified pointâ€”that you can implement with the transform() method like this:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Shear transform:</span></span><br><span class="line"><span class="comment">//   x&#x27; = x + kx*y;</span></span><br><span class="line"><span class="comment">//   y&#x27; = ky*x + y;</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">shear</span>(<span class="params">c, kx, ky</span>) &#123; c.<span class="title function_">transform</span>(<span class="number">1</span>, ky, kx, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>); &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Rotate theta radians counterclockwise around the point (x,y)</span></span><br><span class="line"><span class="comment">// This can also be accomplished with a translate, rotate, translate sequence</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">rotateAbout</span>(<span class="params">c, theta, x, y</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> ct = <span class="title class_">Math</span>.<span class="title function_">cos</span>(theta);</span><br><span class="line">    <span class="keyword">let</span> st = <span class="title class_">Math</span>.<span class="title function_">sin</span>(theta);</span><br><span class="line">    c.<span class="title function_">transform</span>(ct, -st, st, ct, -x*ct-y*st+x, x*st-y*ct+y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The setTransform() method takes the same arguments as transform(), but instead of transforming the current coordinate system, it ignores the current system, transforms the default coordinate system, and makes the result the new current coordinate system. setTransform() is useful to temporarily reset the canvas to its default coordinate system:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">c.<span class="title function_">save</span>();                      <span class="comment">// Save current coordinate system</span></span><br><span class="line">c.<span class="title function_">setTransform</span>(<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>);   <span class="comment">// Revert to the default coordinate system</span></span><br><span class="line"><span class="comment">// Perform operations using default CSS pixel coordinates</span></span><br><span class="line">c.<span class="title function_">restore</span>();                   <span class="comment">// Restore the saved coordinate system</span></span><br></pre></td></tr></table></figure>
<p>TRANSFORMATION EXAMPLE<br>Example 15-7 demonstrates the power of coordinate system transformations by using the translate(), rotate(), and scale() methods recursively to draw a Koch snowflake fractal. The output of this example appears in Figure 15-12, which shows Koch snowflakes with 0, 1, 2, 3, and 4 levels of recursion.</p>
<p><Figures figure="15-12">Koch snowflakes</Figures></p>
<p>The code that produces these figures is elegant, but its use of recursive coordinate system transformations makes it somewhat difficult to understand. Even if you donâ€™t follow all the nuances, note that the code includes only a single invocation of the lineTo() method. Every single line segment in Figure 15-12 is drawn like this:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c.<span class="title function_">lineTo</span>(len, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>The value of the variable len does not change during the execution of the program, so the position, orientation, and length of each of the line segments is determined by translations, rotations, and scaling operations.</p>
<p>Example 15-7. A Koch snowflake with transformations</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> deg = <span class="title class_">Math</span>.<span class="property">PI</span>/<span class="number">180</span>;  <span class="comment">// For converting degrees to radians</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Draw a level-n Koch snowflake fractal on the canvas context c,</span></span><br><span class="line"><span class="comment">// with lower-left corner at (x,y) and side length len.</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">snowflake</span>(<span class="params">c, n, x, y, len</span>) &#123;</span><br><span class="line">    c.<span class="title function_">save</span>();           <span class="comment">// Save current transformation</span></span><br><span class="line">    c.<span class="title function_">translate</span>(x,y);   <span class="comment">// Translate origin to starting point</span></span><br><span class="line">    c.<span class="title function_">moveTo</span>(<span class="number">0</span>,<span class="number">0</span>);      <span class="comment">// Begin a new subpath at the new origin</span></span><br><span class="line">    <span class="title function_">leg</span>(n);             <span class="comment">// Draw the first leg of the snowflake</span></span><br><span class="line">    c.<span class="title function_">rotate</span>(-<span class="number">120</span>*deg); <span class="comment">// Now rotate 120 degrees counterclockwise</span></span><br><span class="line">    <span class="title function_">leg</span>(n);             <span class="comment">// Draw the second leg</span></span><br><span class="line">    c.<span class="title function_">rotate</span>(-<span class="number">120</span>*deg); <span class="comment">// Rotate again</span></span><br><span class="line">    <span class="title function_">leg</span>(n);             <span class="comment">// Draw the final leg</span></span><br><span class="line">    c.<span class="title function_">closePath</span>();      <span class="comment">// Close the subpath</span></span><br><span class="line">    c.<span class="title function_">restore</span>();        <span class="comment">// And restore original transformation</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Draw a single leg of a level-n Koch snowflake.</span></span><br><span class="line">    <span class="comment">// This function leaves the current point at the end of the leg it has</span></span><br><span class="line">    <span class="comment">// drawn and translates the coordinate system so the current point is (0,0).</span></span><br><span class="line">    <span class="comment">// This means you can easily call rotate() after drawing a leg.</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">leg</span>(<span class="params">n</span>) &#123;</span><br><span class="line">        c.<span class="title function_">save</span>();               <span class="comment">// Save the current transformation</span></span><br><span class="line">        <span class="keyword">if</span> (n === <span class="number">0</span>) &#123;          <span class="comment">// Nonrecursive case:</span></span><br><span class="line">            c.<span class="title function_">lineTo</span>(len, <span class="number">0</span>);   <span class="comment">//   Just draw a horizontal line</span></span><br><span class="line">        &#125;                       <span class="comment">//                                       _  _</span></span><br><span class="line">        <span class="keyword">else</span> &#123;                  <span class="comment">// Recursive case: draw 4 sub-legs like:  \/</span></span><br><span class="line">            c.<span class="title function_">scale</span>(<span class="number">1</span>/<span class="number">3</span>,<span class="number">1</span>/<span class="number">3</span>);   <span class="comment">// Sub-legs are 1/3 the size of this leg</span></span><br><span class="line">            <span class="title function_">leg</span>(n-<span class="number">1</span>);           <span class="comment">// Recurse for the first sub-leg</span></span><br><span class="line">            c.<span class="title function_">rotate</span>(<span class="number">60</span>*deg);   <span class="comment">// Turn 60 degrees clockwise</span></span><br><span class="line">            <span class="title function_">leg</span>(n-<span class="number">1</span>);           <span class="comment">// Second sub-leg</span></span><br><span class="line">            c.<span class="title function_">rotate</span>(-<span class="number">120</span>*deg); <span class="comment">// Rotate 120 degrees back</span></span><br><span class="line">            <span class="title function_">leg</span>(n-<span class="number">1</span>);           <span class="comment">// Third sub-leg</span></span><br><span class="line">            c.<span class="title function_">rotate</span>(<span class="number">60</span>*deg);   <span class="comment">// Rotate back to our original heading</span></span><br><span class="line">            <span class="title function_">leg</span>(n-<span class="number">1</span>);           <span class="comment">// Final sub-leg</span></span><br><span class="line">        &#125;</span><br><span class="line">        c.<span class="title function_">restore</span>();            <span class="comment">// Restore the transformation</span></span><br><span class="line">        c.<span class="title function_">translate</span>(len, <span class="number">0</span>);    <span class="comment">// But translate to make end of leg (0,0)</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> c = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;canvas&quot;</span>).<span class="title function_">getContext</span>(<span class="string">&quot;2d&quot;</span>);</span><br><span class="line"><span class="title function_">snowflake</span>(c, <span class="number">0</span>, <span class="number">25</span>, <span class="number">125</span>, <span class="number">125</span>);  <span class="comment">// A level-0 snowflake is a triangle</span></span><br><span class="line"><span class="title function_">snowflake</span>(c, <span class="number">1</span>, <span class="number">175</span>, <span class="number">125</span>, <span class="number">125</span>); <span class="comment">// A level-1 snowflake is a 6-sided star</span></span><br><span class="line"><span class="title function_">snowflake</span>(c, <span class="number">2</span>, <span class="number">325</span>, <span class="number">125</span>, <span class="number">125</span>); <span class="comment">// etc.</span></span><br><span class="line"><span class="title function_">snowflake</span>(c, <span class="number">3</span>, <span class="number">475</span>, <span class="number">125</span>, <span class="number">125</span>);</span><br><span class="line"><span class="title function_">snowflake</span>(c, <span class="number">4</span>, <span class="number">625</span>, <span class="number">125</span>, <span class="number">125</span>); <span class="comment">// A level-4 snowflake looks like a snowflake!</span></span><br><span class="line">c.<span class="title function_">stroke</span>();                     <span class="comment">// Stroke this very complicated path</span></span><br></pre></td></tr></table></figure>
<h3 id="15-8-6-Clipping"><a href="#15-8-6-Clipping" class="headerlink" title="15.8.6 Clipping"></a>15.8.6 Clipping</h3><p>After defining a path, you usually call stroke() or fill() (or both). You can also call the clip() method to define a clipping region. Once a clipping region is defined, nothing will be drawn outside of it. Figure 15-13 shows a complex drawing produced using clipping regions. The vertical stripe running down the middle and the text along the bottom of the figure were stroked with no clipping region and then filled after the triangular clipping region was defined.</p>
<p><Figures figure="15-13">Unclipped strokes and clipped fills</Figures></p>
<p>Figure 15-13 was generated using the polygon() method of Example 15-5 and the following code:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Define some drawing attributes</span></span><br><span class="line">c.<span class="property">font</span> = <span class="string">&quot;bold 60pt sans-serif&quot;</span>;    <span class="comment">// Big font</span></span><br><span class="line">c.<span class="property">lineWidth</span> = <span class="number">2</span>;                    <span class="comment">// Narrow lines</span></span><br><span class="line">c.<span class="property">strokeStyle</span> = <span class="string">&quot;#000&quot;</span>;             <span class="comment">// Black lines</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Outline a rectangle and some text</span></span><br><span class="line">c.<span class="title function_">strokeRect</span>(<span class="number">175</span>, <span class="number">25</span>, <span class="number">50</span>, <span class="number">325</span>);     <span class="comment">// A vertical stripe down the middle</span></span><br><span class="line">c.<span class="title function_">strokeText</span>(<span class="string">&quot;&lt;canvas&gt;&quot;</span>, <span class="number">15</span>, <span class="number">330</span>);  <span class="comment">// Note strokeText() instead of fillText()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Define a complex path with an interior that is outside.</span></span><br><span class="line"><span class="title function_">polygon</span>(c,<span class="number">3</span>,<span class="number">200</span>,<span class="number">225</span>,<span class="number">200</span>);           <span class="comment">// Large triangle</span></span><br><span class="line"><span class="title function_">polygon</span>(c,<span class="number">3</span>,<span class="number">200</span>,<span class="number">225</span>,<span class="number">100</span>,<span class="number">0</span>,<span class="literal">true</span>);    <span class="comment">// Smaller reverse triangle inside</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Make that path the clipping region.</span></span><br><span class="line">c.<span class="title function_">clip</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Stroke the path with a 5 pixel line, entirely inside the clipping region.</span></span><br><span class="line">c.<span class="property">lineWidth</span> = <span class="number">10</span>;       <span class="comment">// Half of this 10 pixel line will be clipped away</span></span><br><span class="line">c.<span class="title function_">stroke</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Fill the parts of the rectangle and text that are inside the clipping region</span></span><br><span class="line">c.<span class="property">fillStyle</span> = <span class="string">&quot;#aaa&quot;</span>;             <span class="comment">// Light gray</span></span><br><span class="line">c.<span class="title function_">fillRect</span>(<span class="number">175</span>, <span class="number">25</span>, <span class="number">50</span>, <span class="number">325</span>);     <span class="comment">// Fill the vertical stripe</span></span><br><span class="line">c.<span class="property">fillStyle</span> = <span class="string">&quot;#888&quot;</span>;             <span class="comment">// Darker gray</span></span><br><span class="line">c.<span class="title function_">fillText</span>(<span class="string">&quot;&lt;canvas&gt;&quot;</span>, <span class="number">15</span>, <span class="number">330</span>);  <span class="comment">// Fill the text</span></span><br></pre></td></tr></table></figure>
<p>It is important to note that when you call clip(), the current path is itself clipped to the current clipping region, then that clipped path becomes the new clipping region. This means that the clip() method can shrink the clipping region but can never enlarge it. There is no method to reset the clipping region, so before calling clip(), you should typically call save() so that you can later restore() the unclipped region.</p>
<h3 id="15-8-7-Pixel-Manipulation"><a href="#15-8-7-Pixel-Manipulation" class="headerlink" title="15.8.7 Pixel Manipulation"></a>15.8.7 Pixel Manipulation</h3><p>The getImageData() method returns an ImageData object that represents the raw pixels (as R, G, B, and A components) from a rectangular region of your canvas. You can create empty ImageData objects with createImageData(). The pixels in an ImageData object are writable, so you can set them any way you want, then copy those pixels back onto the canvas with putImageData().</p>
<p>These pixel manipulation methods provide very low-level access to the canvas. The rectangle you pass to getImageData() is in the default coordinate system: its dimensions are measured in CSS pixels, and it is not affected by the current transformation. When you call putImageData(), the position you specify is also measured in the default coordinate system. Furthermore, putImageData() ignores all graphics attributes. It does not perform any compositing, it does not multiply pixels by globalAlpha, and it does not draw shadows.</p>
<p>Pixel manipulation methods are useful for implementing image processing. Example 15-8 shows how to create a simple motion blur or â€œsmearâ€ effect like that shown in Figure 15-14.</p>
<p><Figures figure="15-14">A motion blur effect created by image processing</Figures></p>
<p>The following code demonstrates getImageData() and putImageData() and shows how to iterate through and modify the pixel values in an ImageData object.</p>
<p>Example 15-8. Motion blur with ImageData</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Smear the pixels of the rectangle to the right, producing a</span></span><br><span class="line"><span class="comment">// sort of motion blur as if objects are moving from right to left.</span></span><br><span class="line"><span class="comment">// n must be 2 or larger. Larger values produce bigger smears.</span></span><br><span class="line"><span class="comment">// The rectangle is specified in the default coordinate system.</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">smear</span>(<span class="params">c, n, x, y, w, h</span>) &#123;</span><br><span class="line">    <span class="comment">// Get the ImageData object that represents the rectangle of pixels to smear</span></span><br><span class="line">    <span class="keyword">let</span> pixels = c.<span class="title function_">getImageData</span>(x, y, w, h);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This smear is done in-place and requires only the source ImageData.</span></span><br><span class="line">    <span class="comment">// Some image processing algorithms require an additional ImageData to</span></span><br><span class="line">    <span class="comment">// store transformed pixel values. If we needed an output buffer, we could</span></span><br><span class="line">    <span class="comment">// create a new ImageData with the same dimensions like this:</span></span><br><span class="line">    <span class="comment">//   let output_pixels = c.createImageData(pixels);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get the dimensions of the grid of pixels in the ImageData object</span></span><br><span class="line">    <span class="keyword">let</span> width = pixels.<span class="property">width</span>, height = pixels.<span class="property">height</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This is the byte array that holds the raw pixel data, left-to-right and</span></span><br><span class="line">    <span class="comment">// top-to-bottom. Each pixel occupies 4 consecutive bytes in R,G,B,A order.</span></span><br><span class="line">    <span class="keyword">let</span> data = pixels.<span class="property">data</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Each pixel after the first in each row is smeared by replacing it with</span></span><br><span class="line">    <span class="comment">// 1/nth of its own value plus m/nths of the previous pixel&#x27;s value</span></span><br><span class="line">    <span class="keyword">let</span> m = n-<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> row = <span class="number">0</span>; row &lt; height; row++) &#123;  <span class="comment">// For each row</span></span><br><span class="line">        <span class="keyword">let</span> i = row*width*<span class="number">4</span> + <span class="number">4</span>;  <span class="comment">// The offset of the second pixel of the row</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> col = <span class="number">1</span>; col &lt; width; col++, i += <span class="number">4</span>) &#123; <span class="comment">// For each column</span></span><br><span class="line">            data[i] =   (data[i] + data[i-<span class="number">4</span>]*m)/n;     <span class="comment">// Red pixel component</span></span><br><span class="line">            data[i+<span class="number">1</span>] = (data[i+<span class="number">1</span>] + data[i-<span class="number">3</span>]*m)/n;   <span class="comment">// Green</span></span><br><span class="line">            data[i+<span class="number">2</span>] = (data[i+<span class="number">2</span>] + data[i-<span class="number">2</span>]*m)/n;   <span class="comment">// Blue</span></span><br><span class="line">            data[i+<span class="number">3</span>] = (data[i+<span class="number">3</span>] + data[i-<span class="number">1</span>]*m)/n;   <span class="comment">// Alpha component</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Now copy the smeared image data back to the same position on the canvas</span></span><br><span class="line">    c.<span class="title function_">putImageData</span>(pixels, x, y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="15-9-Audio-APIs"><a href="#15-9-Audio-APIs" class="headerlink" title="15.9 Audio APIs"></a>15.9 Audio APIs</h2><p>The HTML <code>&lt;audio&gt;</code> and <code>&lt;video&gt;</code> tags allow you to easily include sound and videos in your web pages. These are complex elements with significant APIs and nontrivial user interfaces. You can control media playback with the play() and pause() methods. You can set the volume and playbackRate properties to control the audio volume and speed of playback. And you can skip to a particular time within the media by setting the currentTime property.</p>
<p>We will not cover <code>&lt;audio&gt;</code> and <code>&lt;video&gt;</code> tags in any further detail here, however. The following subsections demonstrate two ways to add scripted sound effects to your web pages.</p>
<h3 id="15-9-1-The-Audio-Constructor"><a href="#15-9-1-The-Audio-Constructor" class="headerlink" title="15.9.1 The Audio() Constructor"></a>15.9.1 The Audio() Constructor</h3><p>You donâ€™t have to include an <code>&lt;audio&gt;</code> tag in your HTML document in order to include sound effects in your web pages. You can dynamically create <code>&lt;audio&gt;</code> elements with the normal DOM document.createElement() method, or, as a shortcut, you can simply use the Audio() constructor. You do not have to add the created element to your document in order to play it. You can simply call its play() method:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Load the sound effect in advance so it is ready for use</span></span><br><span class="line"><span class="keyword">let</span> soundeffect = <span class="keyword">new</span> <span class="title class_">Audio</span>(<span class="string">&quot;soundeffect.mp3&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Play the sound effect whenever the user clicks the mouse button</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;click&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    soundeffect.<span class="title function_">cloneNode</span>().<span class="title function_">play</span>(); <span class="comment">// Load and play the sound</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Note the use of cloneNode() here. If the user clicks the mouse rapidly, we want to be able to have multiple overlapping copies of the sound effect playing at the same time. To do that, we need multiple Audio elements. Because the Audio elements are not added to the document, they will be garbage collected when they are done playing.</p>
<h3 id="15-9-2-The-WebAudio-API"><a href="#15-9-2-The-WebAudio-API" class="headerlink" title="15.9.2 The WebAudio API"></a>15.9.2 The WebAudio API</h3><p>In addition to playback of recorded sounds with Audio elements, web browsers also allow the generation and playback of synthesized sounds with the WebAudio API. Using the WebAudio API is like hooking up an old-style electronic synthesizer with patch cords. With WebAudio, you create a set of AudioNode objects, which represents sources, transformations, or destinations of waveforms, and then connect these nodes together into a network to produce sounds. The API is not particularly complex, but a full explanation requires an understanding of electronic music and signal processing concepts that are beyond the scope of this book.</p>
<p>The following code below uses the WebAudio API to synthesize a short chord that fades out over about a second. This example demonstrates the basics of the WebAudio API. If this is interesting to you, you can find much more about this API online:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Begin by creating an audioContext object. Safari still requires</span></span><br><span class="line"><span class="comment">// us to use webkitAudioContext instead of AudioContext.</span></span><br><span class="line"><span class="keyword">let</span> audioContext = <span class="keyword">new</span> (<span class="variable language_">this</span>.<span class="property">AudioContext</span>||<span class="variable language_">this</span>.<span class="property">webkitAudioContext</span>)();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Define the base sound as a combination of three pure sine waves</span></span><br><span class="line"><span class="keyword">let</span> notes = [ <span class="number">293.7</span>, <span class="number">370.0</span>, <span class="number">440.0</span> ]; <span class="comment">// D major chord: D, F# and A</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Create oscillator nodes for each of the notes we want to play</span></span><br><span class="line"><span class="keyword">let</span> oscillators = notes.<span class="title function_">map</span>(<span class="function"><span class="params">note</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> o = audioContext.<span class="title function_">createOscillator</span>();</span><br><span class="line">    o.<span class="property">frequency</span>.<span class="property">value</span> = note;</span><br><span class="line">    <span class="keyword">return</span> o;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Shape the sound by controlling its volume over time.</span></span><br><span class="line"><span class="comment">// Starting at time 0 quickly ramp up to full volume.</span></span><br><span class="line"><span class="comment">// Then starting at time 0.1 slowly ramp down to 0.</span></span><br><span class="line"><span class="keyword">let</span> volumeControl = audioContext.<span class="title function_">createGain</span>();</span><br><span class="line">volumeControl.<span class="property">gain</span>.<span class="title function_">setTargetAtTime</span>(<span class="number">1</span>, <span class="number">0.0</span>, <span class="number">0.02</span>);</span><br><span class="line">volumeControl.<span class="property">gain</span>.<span class="title function_">setTargetAtTime</span>(<span class="number">0</span>, <span class="number">0.1</span>, <span class="number">0.2</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// We&#x27;re going to send the sound to the default destination:</span></span><br><span class="line"><span class="comment">// the user&#x27;s speakers</span></span><br><span class="line"><span class="keyword">let</span> speakers = audioContext.<span class="property">destination</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Connect each of the source notes to the volume control</span></span><br><span class="line">oscillators.<span class="title function_">forEach</span>(<span class="function"><span class="params">o</span> =&gt;</span> o.<span class="title function_">connect</span>(volumeControl));</span><br><span class="line"></span><br><span class="line"><span class="comment">// And connect the output of the volume control to the speakers.</span></span><br><span class="line">volumeControl.<span class="title function_">connect</span>(speakers);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Now start playing the sounds and let them run for 1.25 seconds.</span></span><br><span class="line"><span class="keyword">let</span> startTime = audioContext.<span class="property">currentTime</span>;</span><br><span class="line"><span class="keyword">let</span> stopTime = startTime + <span class="number">1.25</span>;</span><br><span class="line">oscillators.<span class="title function_">forEach</span>(<span class="function"><span class="params">o</span> =&gt;</span> &#123;</span><br><span class="line">    o.<span class="title function_">start</span>(startTime);</span><br><span class="line">    o.<span class="title function_">stop</span>(stopTime);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// If we want to create a sequence of sounds we can use event handlers</span></span><br><span class="line">oscillators[<span class="number">0</span>].<span class="title function_">addEventListener</span>(<span class="string">&quot;ended&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// This event handler is invoked when the note stops playing</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="15-10-Location-Navigation-and-History"><a href="#15-10-Location-Navigation-and-History" class="headerlink" title="15.10 Location, Navigation, and History"></a>15.10 Location, Navigation, and History</h2><p>The location property of both the Window and Document objects refers to the Location object, which represents the current URL of the document displayed in the window, and which also provides an API for loading new documents into the window.</p>
<p>The Location object is very much like a URL object (Â§11.9), and you can use properties like protocol, hostname, port, and path to access the various parts of the URL of the current document. The href property returns the entire URL as a string, as does the toString() method.</p>
<p>The hash and search properties of the Location object are interesting ones. The hash property returns the â€œfragment identifierâ€ portion of the URL, if there is one: a hash mark (#) followed by an element ID. The search property is similar. It returns the portion of the URL that starts with a question mark: often some sort of query string. In general, this portion of a URL is used to parameterize the URL and provides a way to embed arguments in it. While these arguments are usually intended for scripts run on a server, there is no reason why they cannot also be used in JavaScript-enabled pages.</p>
<p>URL objects have a searchParams property that is a parsed representation of the search property. The Location object does not have a searchParams property, but if you want to parse window.location.search, you can simply create a URL object from the Location object and then use the URLâ€™s searchParams:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> url = <span class="keyword">new</span> <span class="title function_">URL</span>(<span class="variable language_">window</span>.<span class="property">location</span>);</span><br><span class="line"><span class="keyword">let</span> query = url.<span class="property">searchParams</span>.<span class="title function_">get</span>(<span class="string">&quot;q&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> numResults = <span class="built_in">parseInt</span>(url.<span class="property">searchParams</span>.<span class="title function_">get</span>(<span class="string">&quot;n&quot;</span>) || <span class="string">&quot;10&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>In addition to the Location object that you can refer to as window.location or document.location, and the URL() constructor that we used earlier, browsers also define a document.URL property. Surprisingly, the value of this property is not a URL object, but just a string. The string holds the URL of the current document.</p>
<h3 id="15-10-1-Loading-New-Documents"><a href="#15-10-1-Loading-New-Documents" class="headerlink" title="15.10.1 Loading New Documents"></a>15.10.1 Loading New Documents</h3><p>If you assign a string to window.location or to document.location, that string is interpreted as a URL and the browser loads it, replacing the current document with a new one:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">window</span>.<span class="property">location</span> = <span class="string">&quot;http://www.oreilly.com&quot;</span>; <span class="comment">// Go buy some books!</span></span><br></pre></td></tr></table></figure>
<p>You can also assign relative URLs to location. They are resolved relative to the current URL:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">document</span>.<span class="property">location</span> = <span class="string">&quot;page2.html&quot;</span>;           <span class="comment">// Load the next page</span></span><br></pre></td></tr></table></figure>
<p>A bare fragment identifier is a special kind of relative URL that does not cause the browser to load a new document but simply to scroll so that the document element with id or name that matches the fragment is visible at the top of the browser window. As a special case, the fragment identifier #top makes the browser jump to the start of the document (assuming no element has an id&#x3D;â€topâ€ attribute):</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">location = <span class="string">&quot;#top&quot;</span>;                          <span class="comment">// Jump to the top of the document</span></span><br></pre></td></tr></table></figure>
<p>The individual properties of the Location object are writable, and setting them changes the location URL and also causes the browser to load a new document (or, in the case of the hash property, to navigate within the current document):</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">document</span>.<span class="property">location</span>.<span class="property">path</span> = <span class="string">&quot;pages/3.html&quot;</span>; <span class="comment">// Load a new page</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="property">location</span>.<span class="property">hash</span> = <span class="string">&quot;TOC&quot;</span>;          <span class="comment">// Scroll to the table of contents</span></span><br><span class="line">location.<span class="property">search</span> = <span class="string">&quot;?page=&quot;</span> + (page+<span class="number">1</span>);   <span class="comment">// Reload with new query string</span></span><br></pre></td></tr></table></figure>
<p>You can also load a new page by passing a new string to the assign() method of the Location object. This is the same as assigning the string to the location property, however, so itâ€™s not particularly interesting.</p>
<p>The replace() method of the Location object, on the other hand, is quite useful. When you pass a string to replace(), it is interpreted as a URL and causes the browser to load a new page, just as assign() does. The difference is that replace() replaces the current document in the browserâ€™s history. If a script in document A sets the location property or calls assign() to load document B and then the user clicks the Back button, the browser will go back to document A. If you use replace() instead, then document A is erased from the browserâ€™s history, and when the user clicks the Back button, the browser returns to whatever document was displayed before document A.</p>
<p>When a script unconditionally loads a new document, the replace() method is a better choice than assign(). Otherwise, the Back button would take the browser back to the original document, and the same script would again load the new document. Suppose you have a JavaScript-enhanced version of your page and a static version that does not use JavaScript. If you determine that the userâ€™s browser does not support the web platform APIs that you want to use, you could use location.replace() to load the static version:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// If the browser does not support the JavaScript APIs we need,</span></span><br><span class="line"><span class="comment">// redirect to a static page that does not use JavaScript.</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_">isBrowserSupported</span>()) location.<span class="title function_">replace</span>(<span class="string">&quot;staticpage.html&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>Notice that the URL passed to replace() is a relative one. Relative URLs are interpreted relative to the page in which they appear, just as they would be if they were used in a hyperlink.</p>
<p>In addition to the assign() and replace() methods, the Location object also defines reload(), which simply makes the browser reload the document.</p>
<h3 id="15-10-2-Browsing-History"><a href="#15-10-2-Browsing-History" class="headerlink" title="15.10.2 Browsing History"></a>15.10.2 Browsing History</h3><p>The history property of the Window object refers to the History object for the window. The History object models the browsing history of a window as a list of documents and document states. The length property of the History object specifies the number of elements in the browsing history list, but for security reasons, scripts are not allowed to access the stored URLs. (If they could, any scripts could snoop through your browsing history.)</p>
<p>The History object has back() and forward() methods that behave like the browserâ€™s Back and Forward buttons do: they make the browser go backward or forward one step in its browsing history. A third method, go(), takes an integer argument and can skip any number of pages forward (for positive arguments) or backward (for negative arguments) in the history list:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">history.<span class="title function_">go</span>(-<span class="number">2</span>);   <span class="comment">// Go back 2, like clicking the Back button twice</span></span><br><span class="line">history.<span class="title function_">go</span>(<span class="number">0</span>);    <span class="comment">// Another way to reload the current page</span></span><br></pre></td></tr></table></figure>
<p>If a window contains child windows (such as <code>&lt;iframe&gt;</code> elements), the browsing histories of the child windows are chronologically interleaved with the history of the main window. This means that calling history.back() (for example) on the main window may cause one of the child windows to navigate back to a previously displayed document but leaves the main window in its current state.</p>
<p>The History object described here dates back to the early days of the web when documents were passive and all computation was performed on the server. Today, web applications often generate or load content dynamically and display new application states without actually loading new documents. Applications like these must perform their own history management if they want the user to be able to use the Back and Forward buttons (or the equivalent gestures) to navigate from one application state to another in an intuitive way. There are two ways to accomplish this, described in the next two sections.</p>
<h3 id="15-10-3-History-Management-with-hashchange-Events"><a href="#15-10-3-History-Management-with-hashchange-Events" class="headerlink" title="15.10.3 History Management with hashchange Events"></a>15.10.3 History Management with hashchange Events</h3><p>One history management technique involves location.hash and the â€œhashchangeâ€ event. Here are the key facts you need to know to understand this technique:</p>
<p>The location.hash property sets the fragment identifier of the URL and is traditionally used to specify the ID of a document section to scroll to. But location.hash does not have to be an element ID: you can set it to any string. As long as no element happens to have that string as its ID, the browser wonâ€™t scroll when you set the hash property like this.</p>
<p>Setting the location.hash property updates the URL displayed in the location bar and, very importantly, adds an entry to the browserâ€™s history.</p>
<p>Whenever the fragment identifier of the document changes, the browser fires a â€œhashchangeâ€ event on the Window object. If you set location.hash explictly, a â€œhashchangeâ€ event is fired. And, as weâ€™ve mentioned, this change to the Location object creates a new entry in the browserâ€™s browsing history. So if the user now clicks the Back button, the browser will return to its previous URL before you set location.hash. But this means that the fragment identifier has changed again, so another â€œhashchangeâ€ event is fired in this case. This means that as long as you can create a unique fragment identifier for each possible state of your application, â€œhashchangeâ€ events will notify you if the user moves backward and forward though their browsing history.</p>
<p>To use this history management mechanism, youâ€™ll need to be able to encode the state information necessary to render a â€œpageâ€ of your application into a relatively short string of text that is suitable for use as a fragment identifier. And youâ€™ll need to write a function to convert page state into a string and another function to parse the string and re-create the page state it represents.</p>
<p>Once you have written those functions, the rest is easy. Define a window.onhashchange function (or register a â€œhashchangeâ€ listener with addEventListener()) that reads location.hash, converts that string into a representation of your application state, and then takes whatever actions are necessary to display that new application state.</p>
<p>When the user interacts with your application (such as by clicking a link) in a way that would cause the application to enter a new state, donâ€™t render the new state directly. Instead, encode the desired new state as a string and set location.hash to that string. This will trigger a â€œhashchangeâ€ event, and your handler for that event will display the new state. Using this roundabout technique ensures that the new state is inserted into the browsing history so that the Back and Forward buttons continue to work.</p>
<h3 id="15-10-4-History-Management-with-pushState"><a href="#15-10-4-History-Management-with-pushState" class="headerlink" title="15.10.4 History Management with pushState()"></a>15.10.4 History Management with pushState()</h3><p>The second technique for managing history is somewhat more complex but is less of a hack than the â€œhashchangeâ€ event. This more robust history-management technique is based on the history.pushState() method and the â€œpopstateâ€ event. When a web app enters a new state, it calls history.pushState() to add an object representing the state to the browserâ€™s history. If the user then clicks the Back button, the browser fires a â€œpopstateâ€ event with a copy of that saved state object, and the app uses that object to re-create its previous state. In addition to the saved state object, applications can also save a URL with each state, which is important if you want users to be able to bookmark and share links to the internal states of the app.</p>
<p>The first argument to pushState() is an object that contains all the state information necessary to restore the current state of the document. This object is saved using HTMLâ€™s structured clone algorithm, which is more versatile than JSON.stringify() and can support Map, Set, and Date objects as well as typed arrays and ArrayBuffers.</p>
<p>The second argument was intended to be a title string for the state, but most browsers do not support it, and you should just pass an empty string. The third argument is an optional URL that will be displayed in the location bar immediately and also if the user returns to this state via Back and Forward buttons. Relative URLs are resolved against the current location of the document. Associating a URL with each state allows the user to bookmark internal states of your application. Remember, though, that if the user saves a bookmark and then visits it a day later, you wonâ€™t get a â€œpopstateâ€ event about that visit: youâ€™ll have to restore your application state by parsing the URL.</p>
<p>THE STRUCTURED CLONE ALGORITHM<br>The history.pushState() method does not use JSON.stringify() (Â§11.6) to serialize state data. Instead, it (and other browser APIs weâ€™ll learn about later) uses a more robust serialization technique known as the structured clone algorithm, defined by the HTML standard.</p>
<p>The structured clone algorithm can serialize anything that JSON.stringify() can, but in addition, it enables serialization of most other JavaScript types, including Map, Set, Date, RegExp, and typed arrays, and it can handle data structures that include circular references. The structured clone algorithm cannot serialize functions or classes, however. When cloning objects it does not copy the prototype object, getters and setters, or non-enumerable properties. While the structured clone algorithm can clone most built-in JavaScript types, it cannot copy types defined by the host environment, such as document Element objects.</p>
<p>This means that the state object you pass to history.pushState() need not be limited to the objects, arrays, and primitive values that JSON.stringify() supports. Note, however, that if you pass an instance of a class that you have defined, that instance will be serialized as an ordinary JavaScript object and will lose its prototype.</p>
<p>In addition to the pushState() method, the History object also defines replaceState(), which takes the same arguments but replaces the current history state instead of adding a new state to the browsing history. When an application that uses pushState() is first loaded, it is often a good idea to call replaceState() to define a state object for this initial state of the application.</p>
<p>When the user navigates to saved history states using the Back or Forward buttons, the browser fires a â€œpopstateâ€ event on the Window object. The event object associated with the event has a property named state, which contains a copy (another structured clone) of the state object you passed to pushState().</p>
<p>Example 15-9 is a simple web applicationâ€”the number-guessing game pictured in Figure 15-15â€”that uses pushState() to save its history, allowing the user to â€œgo backâ€ to review or redo their guesses.</p>
<p><Figures figure="15-15">A number-guessing game</Figures></p>
<p>Example 15-9. History management with pushState()</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span><span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">title</span>&gt;</span>I&#x27;m thinking of a number...<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css"><span class="selector-tag">body</span> &#123; <span class="attribute">height</span>: <span class="number">250px</span>; <span class="attribute">display</span>: flex; <span class="attribute">flex-direction</span>: column;</span></span><br><span class="line"><span class="language-css">       <span class="attribute">align-items</span>: center; <span class="attribute">justify-content</span>: space-evenly; &#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-id">#heading</span> &#123; <span class="attribute">font</span>: bold <span class="number">36px</span> sans-serif; <span class="attribute">margin</span>: <span class="number">0</span>; &#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-id">#container</span> &#123; <span class="attribute">border</span>: solid black <span class="number">1px</span>; <span class="attribute">height</span>: <span class="number">1em</span>; <span class="attribute">width</span>: <span class="number">80%</span>; &#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-id">#range</span> &#123; <span class="attribute">background-color</span>: green; <span class="attribute">margin-left</span>: <span class="number">0%</span>; <span class="attribute">height</span>: <span class="number">1em</span>; <span class="attribute">width</span>: <span class="number">100%</span>; &#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-id">#input</span> &#123; <span class="attribute">display</span>: block; <span class="attribute">font-size</span>: <span class="number">24px</span>; <span class="attribute">width</span>: <span class="number">60%</span>; <span class="attribute">padding</span>: <span class="number">5px</span>; &#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-id">#playagain</span> &#123; <span class="attribute">font-size</span>: <span class="number">24px</span>; <span class="attribute">padding</span>: <span class="number">10px</span>; <span class="attribute">border-radius</span>: <span class="number">5px</span>; &#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">id</span>=<span class="string">&quot;heading&quot;</span>&gt;</span>I&#x27;m thinking of a number...<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- A visual representation of the numbers that have not been ruled out --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;container&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;range&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Where the user enters their guess --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;input&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- A button that reloads with no search string. Hidden until game ends. --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;playagain&quot;</span> <span class="attr">hidden</span> <span class="attr">onclick</span>=<span class="string">&quot;location.search=&#x27;&#x27;;&quot;</span>&gt;</span>Play Again<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">/**</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript"> * An instance of this GameState class represents the internal state of</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript"> * our number guessing game. The class defines static factory methods for</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript"> * initializing the game state from different sources, a method for</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript"> * updating the state based on a new guess, and a method for modifying the</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript"> * document based on the current state.</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript"> */</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">class</span> <span class="title class_">GameState</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// This is a factory function to create a new game</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">static</span> <span class="title function_">newGame</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> s = <span class="keyword">new</span> <span class="title class_">GameState</span>();</span></span><br><span class="line"><span class="language-javascript">        s.<span class="property">secret</span> = s.<span class="title function_">randomInt</span>(<span class="number">0</span>, <span class="number">100</span>);  <span class="comment">// An integer: 0 &lt; n &lt; 100</span></span></span><br><span class="line"><span class="language-javascript">        s.<span class="property">low</span> = <span class="number">0</span>;                       <span class="comment">// Guesses must be greater than this</span></span></span><br><span class="line"><span class="language-javascript">        s.<span class="property">high</span> = <span class="number">100</span>;                    <span class="comment">// Guesses must be less than this</span></span></span><br><span class="line"><span class="language-javascript">        s.<span class="property">numGuesses</span> = <span class="number">0</span>;                <span class="comment">// How many guesses have been made</span></span></span><br><span class="line"><span class="language-javascript">        s.<span class="property">guess</span> = <span class="literal">null</span>;                  <span class="comment">// What the last guess was</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> s;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// When we save the state of the game with history.pushState(), it is just</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// a plain JavaScript object that gets saved, not an instance of GameState.</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// So this factory function re-creates a GameState object based on the</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// plain object that we get from a popstate event.</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">static</span> <span class="title function_">fromStateObject</span>(<span class="params">stateObject</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> s = <span class="keyword">new</span> <span class="title class_">GameState</span>();</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">for</span>(<span class="keyword">let</span> key <span class="keyword">of</span> <span class="title class_">Object</span>.<span class="title function_">keys</span>(stateObject)) &#123;</span></span><br><span class="line"><span class="language-javascript">            s[key] = stateObject[key];</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> s;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// In order to enable bookmarking, we need to be able to encode the</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// state of any game as a URL. This is easy to do with URLSearchParams.</span></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">toURL</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> url = <span class="keyword">new</span> <span class="title function_">URL</span>(<span class="variable language_">window</span>.<span class="property">location</span>);</span></span><br><span class="line"><span class="language-javascript">        url.<span class="property">searchParams</span>.<span class="title function_">set</span>(<span class="string">&quot;l&quot;</span>, <span class="variable language_">this</span>.<span class="property">low</span>);</span></span><br><span class="line"><span class="language-javascript">        url.<span class="property">searchParams</span>.<span class="title function_">set</span>(<span class="string">&quot;h&quot;</span>, <span class="variable language_">this</span>.<span class="property">high</span>);</span></span><br><span class="line"><span class="language-javascript">        url.<span class="property">searchParams</span>.<span class="title function_">set</span>(<span class="string">&quot;n&quot;</span>, <span class="variable language_">this</span>.<span class="property">numGuesses</span>);</span></span><br><span class="line"><span class="language-javascript">        url.<span class="property">searchParams</span>.<span class="title function_">set</span>(<span class="string">&quot;g&quot;</span>, <span class="variable language_">this</span>.<span class="property">guess</span>);</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// Note that we can&#x27;t encode the secret number in the url or it</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// will give away the secret. If the user bookmarks the page with</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// these parameters and then returns to it, we will simply pick a</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// new random number between low and high.</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> url.<span class="property">href</span>;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// This is a factory function that creates a new GameState object and</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// initializes it from the specified URL. If the URL does not contain the</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// expected parameters or if they are malformed it just returns null.</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">static</span> <span class="title function_">fromURL</span>(<span class="params">url</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> s = <span class="keyword">new</span> <span class="title class_">GameState</span>();</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> params = <span class="keyword">new</span> <span class="title function_">URL</span>(url).<span class="property">searchParams</span>;</span></span><br><span class="line"><span class="language-javascript">        s.<span class="property">low</span> = <span class="built_in">parseInt</span>(params.<span class="title function_">get</span>(<span class="string">&quot;l&quot;</span>));</span></span><br><span class="line"><span class="language-javascript">        s.<span class="property">high</span> = <span class="built_in">parseInt</span>(params.<span class="title function_">get</span>(<span class="string">&quot;h&quot;</span>));</span></span><br><span class="line"><span class="language-javascript">        s.<span class="property">numGuesses</span> = <span class="built_in">parseInt</span>(params.<span class="title function_">get</span>(<span class="string">&quot;n&quot;</span>));</span></span><br><span class="line"><span class="language-javascript">        s.<span class="property">guess</span> = <span class="built_in">parseInt</span>(params.<span class="title function_">get</span>(<span class="string">&quot;g&quot;</span>));</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// If the URL is missing any of the parameters we need or if</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// they did not parse as integers, then return null;</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span> (<span class="built_in">isNaN</span>(s.<span class="property">low</span>) || <span class="built_in">isNaN</span>(s.<span class="property">high</span>) ||</span></span><br><span class="line"><span class="language-javascript">            <span class="built_in">isNaN</span>(s.<span class="property">numGuesses</span>) || <span class="built_in">isNaN</span>(s.<span class="property">guess</span>)) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span> <span class="literal">null</span>;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// Pick a new secret number in the right range each time we</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// restore a game from a URL.</span></span></span><br><span class="line"><span class="language-javascript">        s.<span class="property">secret</span> = s.<span class="title function_">randomInt</span>(s.<span class="property">low</span>, s.<span class="property">high</span>);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> s;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// Return an integer n, min &lt; n &lt; max</span></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">randomInt</span>(<span class="params">min, max</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> min + <span class="title class_">Math</span>.<span class="title function_">ceil</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * (max - min - <span class="number">1</span>));</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// Modify the document to display the current state of the game.</span></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> heading = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#heading&quot;</span>); <span class="comment">// The &lt;h1&gt; at the top</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> range = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#range&quot;</span>);     <span class="comment">// Display guess range</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> input = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#input&quot;</span>);     <span class="comment">// Guess input field</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> playagain = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#playagain&quot;</span>);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// Update the document heading and title</span></span></span><br><span class="line"><span class="language-javascript">        heading.<span class="property">textContent</span> = <span class="variable language_">document</span>.<span class="property">title</span> =</span></span><br><span class="line"><span class="language-javascript">            <span class="string">`I&#x27;m thinking of a number between <span class="subst">$&#123;<span class="variable language_">this</span>.low&#125;</span> and <span class="subst">$&#123;<span class="variable language_">this</span>.high&#125;</span>.`</span>;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// Update the visual range of numbers</span></span></span><br><span class="line"><span class="language-javascript">        range.<span class="property">style</span>.<span class="property">marginLeft</span> = <span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.low&#125;</span>%`</span>;</span></span><br><span class="line"><span class="language-javascript">        range.<span class="property">style</span>.<span class="property">width</span> = <span class="string">`<span class="subst">$&#123;(<span class="variable language_">this</span>.high-<span class="variable language_">this</span>.low)&#125;</span>%`</span>;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// Make sure the input field is empty and focused.</span></span></span><br><span class="line"><span class="language-javascript">        input.<span class="property">value</span> = <span class="string">&quot;&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">        input.<span class="title function_">focus</span>();</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// Display feedback based on the user&#x27;s last guess. The input</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// placeholder will show because we made the input field empty.</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">guess</span> === <span class="literal">null</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            input.<span class="property">placeholder</span> = <span class="string">&quot;Type your guess and hit Enter&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">guess</span> &lt; <span class="variable language_">this</span>.<span class="property">secret</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            input.<span class="property">placeholder</span> = <span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.guess&#125;</span> is too low. Guess again`</span>;</span></span><br><span class="line"><span class="language-javascript">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">guess</span> &gt; <span class="variable language_">this</span>.<span class="property">secret</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            input.<span class="property">placeholder</span> = <span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.guess&#125;</span> is too high. Guess again`</span>;</span></span><br><span class="line"><span class="language-javascript">        &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            input.<span class="property">placeholder</span> = <span class="variable language_">document</span>.<span class="property">title</span> = <span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.guess&#125;</span> is correct!`</span>;</span></span><br><span class="line"><span class="language-javascript">            heading.<span class="property">textContent</span> = <span class="string">`You win in <span class="subst">$&#123;<span class="variable language_">this</span>.numGuesses&#125;</span> guesses!`</span>;</span></span><br><span class="line"><span class="language-javascript">            playagain.<span class="property">hidden</span> = <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// Update the state of the game based on what the user guessed.</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// Returns true if the state was updated, and false otherwise.</span></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">updateForGuess</span>(<span class="params">guess</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// If it is a number and is in the right range</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span> ((guess &gt; <span class="variable language_">this</span>.<span class="property">low</span>) &amp;&amp; (guess &lt; <span class="variable language_">this</span>.<span class="property">high</span>)) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// Update state object based on this guess</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (guess &lt; <span class="variable language_">this</span>.<span class="property">secret</span>) <span class="variable language_">this</span>.<span class="property">low</span> = guess;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">else</span> <span class="keyword">if</span> (guess &gt; <span class="variable language_">this</span>.<span class="property">secret</span>) <span class="variable language_">this</span>.<span class="property">high</span> = guess;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">this</span>.<span class="property">guess</span> = guess;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">this</span>.<span class="property">numGuesses</span>++;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span> <span class="literal">true</span>;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">else</span> &#123; <span class="comment">// An invalid guess: notify user but don&#x27;t update state</span></span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">alert</span>(<span class="string">`Please enter a number greater than <span class="subst">$&#123;</span></span></span></span><br><span class="line"><span class="subst"><span class="string"><span class="language-javascript">                   <span class="variable language_">this</span>.low&#125;</span> and less than <span class="subst">$&#123;<span class="variable language_">this</span>.high&#125;</span>`</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// With the GameState class defined, making the game work is just a matter</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// of initializing, updating, saving and rendering the state object at</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// the appropriate times.</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// When we are first loaded, we try get the state of the game from the URL</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// and if that fails we instead begin a new game. So if the user bookmarks a</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// game that game can be restored from the URL. But if we load a page with</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// no query parameters we&#x27;ll just get a new game.</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> gamestate = <span class="title class_">GameState</span>.<span class="title function_">fromURL</span>(<span class="variable language_">window</span>.<span class="property">location</span>) || <span class="title class_">GameState</span>.<span class="title function_">newGame</span>();</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// Save this initial state of the game into the browser history, but use</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// replaceState instead of pushState() for this initial page</span></span></span><br><span class="line"><span class="language-javascript">history.<span class="title function_">replaceState</span>(gamestate, <span class="string">&quot;&quot;</span>, gamestate.<span class="title function_">toURL</span>());</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// Display this initial state</span></span></span><br><span class="line"><span class="language-javascript">gamestate.<span class="title function_">render</span>();</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// When the user guesses, update the state of the game based on their guess</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// then save the new state to browser history and render the new state</span></span></span><br><span class="line"><span class="language-javascript"><span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#input&quot;</span>).<span class="property">onchange</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span> (gamestate.<span class="title function_">updateForGuess</span>(<span class="built_in">parseInt</span>(event.<span class="property">target</span>.<span class="property">value</span>))) &#123;</span></span><br><span class="line"><span class="language-javascript">        history.<span class="title function_">pushState</span>(gamestate, <span class="string">&quot;&quot;</span>, gamestate.<span class="title function_">toURL</span>());</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">    gamestate.<span class="title function_">render</span>();</span></span><br><span class="line"><span class="language-javascript">&#125;;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// If the user goes back or forward in history, we&#x27;ll get a popstate event</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// on the window object with a copy of the state object we saved with</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// pushState. When that happens, render the new state.</span></span></span><br><span class="line"><span class="language-javascript"><span class="variable language_">window</span>.<span class="property">onpopstate</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    gamestate = <span class="title class_">GameState</span>.<span class="title function_">fromStateObject</span>(event.<span class="property">state</span>); <span class="comment">// Restore the state</span></span></span><br><span class="line"><span class="language-javascript">    gamestate.<span class="title function_">render</span>();                                 <span class="comment">// and display it</span></span></span><br><span class="line"><span class="language-javascript">&#125;;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="15-11-Networking"><a href="#15-11-Networking" class="headerlink" title="15.11 Networking"></a>15.11 Networking</h2><p>Every time you load a web page, the browser makes network requestsâ€”using the HTTP and HTTPS protocolsâ€”for an HTML file as well as the images, fonts, scripts, and stylesheets that the file depends on. But in addition to being able to make network requests in response to user actions, web browsers also expose JavaScript APIs for networking as well.</p>
<p>This section covers three network APIs:</p>
<p>The fetch() method defines a Promise-based API for making HTTP and HTTPS requests. The fetch() API makes basic GET requests simple but has a comprehensive feature set that also supports just about any possible HTTP use case.</p>
<p>The Server-Sent Events (or SSE) API is a convenient, event-based interface to HTTP â€œlong pollingâ€ techniques where the web server holds the network connection open so that it can send data to the client whenever it wants.</p>
<p>WebSockets is a networking protocol that is not HTTP but is designed to interoperate with HTTP. It defines an asynchronous message-passing API where clients and servers can send and receive messages from each other in a way that is similar to TCP network sockets.</p>
<h3 id="15-11-1-fetch"><a href="#15-11-1-fetch" class="headerlink" title="15.11.1 fetch()"></a>15.11.1 fetch()</h3><p>For basic HTTP requests, using fetch() is a three-step process:</p>
<p>Call fetch(), passing the URL whose content you want to retrieve.</p>
<p>Get the response object that is asynchronously returned by step 1 when the HTTP response begins to arrive and call a method of this response object to ask for the body of the response.</p>
<p>Get the body object that is asynchronously returned by step 2 and process it however you want.</p>
<p>The fetch() API is completely Promise-based, and there are two asynchronous steps here, so you typically expect two then() calls or two await expressions when using fetch(). (And if youâ€™ve forgotten what those are, you may want to reread Chapter 13 before continuing with this section.)</p>
<p>Hereâ€™s what a fetch() request looks like if you are using then() and expect the serverâ€™s response to your request to be JSON-formatted:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">fetch</span>(<span class="string">&quot;/api/users/current&quot;</span>)            <span class="comment">// Make an HTTP (or HTTPS) GET request</span></span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> response.<span class="title function_">json</span>()) <span class="comment">// Parse its body as a JSON object</span></span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">currentUser</span> =&gt;</span> &#123;             <span class="comment">// Then process that parsed object</span></span><br><span class="line">        <span class="title function_">displayUserInfo</span>(currentUser);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<p>Hereâ€™s a similar request made using the async and await keywords to an API that returns a plain string rather than a JSON object:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">isServiceReady</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&quot;/api/service/status&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> body = <span class="keyword">await</span> response.<span class="title function_">text</span>();</span><br><span class="line">    <span class="keyword">return</span> body === <span class="string">&quot;ready&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>If you understand these two code examples, then you know 80% of what you need to know to use the fetch() API. The subsections that follow will demonstrate how to make requests and receive responses that are somewhat more complicated than those shown here.</p>
<p>GOODBYE XMLHTTPREQUEST<br>The fetch() API replaces the baroque and misleadingly named XMLHttpRequest API (which has nothing to do with XML). You may still see XHR (as it is often abbreviated) in existing code, but there is no reason today to use it in new code, and it is not documented in this chapter. There is one example of XMLHttpRequest in this book, however, and you can refer to Â§13.1.3 if youâ€™d like to see an example of old-style JavaScript networking.</p>
<p>HTTP STATUS CODES, RESPONSE HEADERS, AND NETWORK ERRORS<br>The three-step fetch() process shown in Â§15.11.1 elides all error-handling code. Hereâ€™s a more realistic version:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">fetch</span>(<span class="string">&quot;/api/users/current&quot;</span>)   <span class="comment">// Make an HTTP (or HTTPS) GET request.</span></span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;       <span class="comment">// When we get a response, first check it</span></span><br><span class="line">        <span class="keyword">if</span> (response.<span class="property">ok</span> &amp;&amp;    <span class="comment">// for a success code and the expected type.</span></span><br><span class="line">            response.<span class="property">headers</span>.<span class="title function_">get</span>(<span class="string">&quot;Content-Type&quot;</span>) === <span class="string">&quot;application/json&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> response.<span class="title function_">json</span>(); <span class="comment">// Return a Promise for the body.</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(        <span class="comment">// Or throw an error.</span></span><br><span class="line">                <span class="string">`Unexpected response status <span class="subst">$&#123;response.status&#125;</span> or content type`</span></span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">currentUser</span> =&gt;</span> &#123;    <span class="comment">// When the response.json() Promise resolves</span></span><br><span class="line">        <span class="title function_">displayUserInfo</span>(currentUser); <span class="comment">// do something with the parsed body.</span></span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;         <span class="comment">// Or if anything went wrong, just log the error.</span></span><br><span class="line">        <span class="comment">// If the user&#x27;s browser is offline, fetch() itself will reject.</span></span><br><span class="line">        <span class="comment">// If the server returns a bad response then we throw an error above.</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error while fetching current user:&quot;</span>, error);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<p>The Promise returned by fetch() resolves to a Response object. The status property of this object is the HTTP status code, such as 200 for successful requests or 404 for â€œNot Foundâ€ responses. (statusText gives the standard English text that goes along with the numeric status code.) Conveniently, the ok property of a Response is true if status is 200 or any code between 200 and 299 and is false for any other code.</p>
<p>fetch() resolves its Promise when the serverâ€™s response starts to arrive, as soon as the HTTP status and response headers are available, but typically before the full response body has arrived. Even though the body is not available yet, you can examine the headers in this second step of the fetch process. The headers property of a Response object is a Headers object. Use its has() method to test for the presence of a header, or use its get() method to get the value of a header. HTTP header names are case-insensitive, so you can pass lowercase or mixed-case header names to these functions.</p>
<p>The Headers object is also iterable if you ever need to do that:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">fetch</span>(url).<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> [name,value] <span class="keyword">of</span> response.<span class="property">headers</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;name&#125;</span>: <span class="subst">$&#123;value&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>If a web server responds to your fetch() request, then the Promise that was returned will be fulfilled with a Response object, even if the serverâ€™s response was a 404 Not Found error or a 500 Internal Server Error. fetch() only rejects the Promise it returns if it cannot contact the web server at all. This can happen if the userâ€™s computer is offline, the server is unresponsive, or the URL specifies a hostname that does not exist. Because these things can happen on any network request, it is always a good idea to include a .catch() clause any time you make a fetch() call.</p>
<p>SETTING REQUEST PARAMETERS<br>Sometimes you want to pass extra parameters along with the URL when you make a request. This can be done by adding name&#x2F;value pairs at the end of a URL after a ?. The URL and URLSearchParams classes (which were covered in Â§11.9) make it easy to construct URLs in this form, and the fetch() function accepts URL objects as its first argument, so you can include request parameters in a fetch() request like this:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">search</span>(<span class="params">term</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> url = <span class="keyword">new</span> <span class="title function_">URL</span>(<span class="string">&quot;/api/search&quot;</span>);</span><br><span class="line">    url.<span class="property">searchParams</span>.<span class="title function_">set</span>(<span class="string">&quot;q&quot;</span>, term);</span><br><span class="line">    <span class="keyword">let</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(url);</span><br><span class="line">    <span class="keyword">if</span> (!response.<span class="property">ok</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(response.<span class="property">statusText</span>);</span><br><span class="line">    <span class="keyword">let</span> resultsArray = <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line">    <span class="keyword">return</span> resultsArray;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>SETTING REQUEST HEADERS<br>Sometimes you need to set headers in your fetch() requests. If youâ€™re making web API requests that require credentials, for example, then you may need to include an Authorization header that contains those credentials. In order to do this, you can use the two-argument version of fetch(). As before, the first argument is a string or URL object that specifies the URL to fetch. The second argument is an object that can provide additional options, including request headers:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> authHeaders = <span class="keyword">new</span> <span class="title class_">Headers</span>();</span><br><span class="line"><span class="comment">// Don&#x27;t use Basic auth unless it is over an HTTPS connection.</span></span><br><span class="line">authHeaders.<span class="title function_">set</span>(<span class="string">&quot;Authorization&quot;</span>,</span><br><span class="line">                <span class="string">`Basic <span class="subst">$&#123;btoa(<span class="string">`<span class="subst">$&#123;username&#125;</span>:<span class="subst">$&#123;password&#125;</span>`</span>)&#125;</span>`</span>);</span><br><span class="line"><span class="title function_">fetch</span>(<span class="string">&quot;/api/users/&quot;</span>, &#123; <span class="attr">headers</span>: authHeaders &#125;)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> response.<span class="title function_">json</span>())             <span class="comment">// Error handling omitted...</span></span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">usersList</span> =&gt;</span> <span class="title function_">displayAllUsers</span>(usersList));</span><br></pre></td></tr></table></figure>
<p>There are a number of other options that can be specified in the second argument to fetch(), and weâ€™ll see it again later. An alternative to passing two arguments to fetch() is to instead pass the same two arguments to the Request() constructor and then pass the resulting Request object to fetch():</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> request = <span class="keyword">new</span> <span class="title class_">Request</span>(url, &#123; headers &#125;);</span><br><span class="line"><span class="title function_">fetch</span>(request).<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> ...);</span><br></pre></td></tr></table></figure>
<p>PARSING RESPONSE BODIES<br>In the three-step fetch() process that weâ€™ve demonstrated, the second step ends by calling the json() or text() methods of the Response object and returning the Promise object that those methods return. Then, the third step begins when that Promise resolves with the body of the response parsed as a JSON object or simply as a string of text.</p>
<p>These are probably the two most common scenarios, but they are not the only ways to obtain the body of a web serverâ€™s response. In addition to json() and text(), the Response object also has these methods:</p>
<p>arrayBuffer()<br>This method returns a Promise that resolves to an ArrayBuffer. This is useful when the response contains binary data. You can use the ArrayBuffer to create a typed array (Â§11.2) or a DataView object (Â§11.2.5) from which you can read the binary data.</p>
<p>blob()<br>This method returns a Promise that resolves to a Blob object. Blobs are not covered in any detail in this book, but the name stands for â€œBinary Large Object,â€ and they are useful when you expect large amounts of binary data. If you ask for the body of the response as a Blob, the browser implementation may stream the response data to a temporary file and then return a Blob object that represents that temporary file. Blob objects, therefore, do not allow random access to the response body the way that an ArrayBuffer does. Once you have a Blob, you can create a URL that refers to it with URL.createObjectURL(), or you can use the event-based FileReader API to asynchronously obtain the content of the Blob as a string or an ArrayBuffer. At the time of this writing, some browsers also define Promise-based text() and arrayBuffer() methods that give a more direct route for obtaining the content of a Blob.</p>
<p>formData()<br>This method returns a Promise that resolves to a FormData object. You should use this method if you expect the body of the Response to be encoded in â€œmultipart&#x2F;form-dataâ€ format. This format is common in POST requests made to a server, but uncommon in server responses, so this method is not frequently used.</p>
<p>STREAMING RESPONSE BODIES<br>In addition to the five response methods that asynchronously return some form of the complete response body to you, there is also an option to stream the response body, which is useful if there is some kind of processing you can do on the chunks of the response body as they arrive over the network. But streaming the response is also useful if you want to display a progress bar so that the user can see the progress of the download.</p>
<p>The body property of a Response object is a ReadableStream object. If you have already called a response method like text() or json() that reads, parses, and returns the body, then bodyUsed will be true to indicate that the body stream has already been read. If bodyUsed is false, however, then the stream has not yet been read. In this case, you can call getReader() on response.body to obtain a stream reader object, then use the read() method of this reader object to asynchronously read chunks of text from the stream. The read() method returns a Promise that resolves to an object with done and value properties. done will be true if the entire body has been read or if the stream was closed. And value will either be the next chunk, as a Uint8Array, or undefined if there are no more chunks.</p>
<p>This streaming API is relatively straightforward if you use async and await but is surprisingly complex if you attempt to use it with raw Promises. Example 15-10 demonstrates the API by defining a streamBody() function. Suppose you wanted to download a large JSON file and report download progress to the user. You canâ€™t do that with the json() method of the Response object, but you could do it with the streamBody() function, like this (assuming that an updateProgress() function is defined to set the value attribute on an HTML <code>&lt;progress&gt;</code> element):</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">fetch</span>(<span class="string">&#x27;big.json&#x27;</span>)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> <span class="title function_">streamBody</span>(response, updateProgress))</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">bodyText</span> =&gt;</span> <span class="title class_">JSON</span>.<span class="title function_">parse</span>(bodyText))</span><br><span class="line">    .<span class="title function_">then</span>(handleBigJSONObject);</span><br></pre></td></tr></table></figure>
<p>The streamBody() function can be implemented as shown in Example 15-10.</p>
<p>Example 15-10. Streaming the response body from a fetch() request</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * An asynchronous function for streaming the body of a Response object</span></span><br><span class="line"><span class="comment"> * obtained from a fetch() request. Pass the Response object as the first</span></span><br><span class="line"><span class="comment"> * argument followed by two optional callbacks.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If you specify a function as the second argument, that reportProgress</span></span><br><span class="line"><span class="comment"> * callback will be called once for each chunk that is received. The first</span></span><br><span class="line"><span class="comment"> * argument passed is the total number of bytes received so far. The second</span></span><br><span class="line"><span class="comment"> * argument is a number between 0 and 1 specifying how complete the download</span></span><br><span class="line"><span class="comment"> * is. If the Response object has no &quot;Content-Length&quot; header, however, then</span></span><br><span class="line"><span class="comment"> * this second argument will always be NaN.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If you want to process the data in chunks as they arrive, specify a</span></span><br><span class="line"><span class="comment"> * function as the third argument. The chunks will be passed, as Uint8Array</span></span><br><span class="line"><span class="comment"> * objects, to this processChunk callback.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * streamBody() returns a Promise that resolves to a string. If a processChunk</span></span><br><span class="line"><span class="comment"> * callback was supplied then this string is the concatenation of the values</span></span><br><span class="line"><span class="comment"> * returned by that callback. Otherwise the string is the concatenation of</span></span><br><span class="line"><span class="comment"> * the chunk values converted to UTF-8 strings.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">streamBody</span>(<span class="params">response, reportProgress, processChunk</span>) &#123;</span><br><span class="line">    <span class="comment">// How many bytes are we expecting, or NaN if no header</span></span><br><span class="line">    <span class="keyword">let</span> expectedBytes = <span class="built_in">parseInt</span>(response.<span class="property">headers</span>.<span class="title function_">get</span>(<span class="string">&quot;Content-Length&quot;</span>));</span><br><span class="line">    <span class="keyword">let</span> bytesRead = <span class="number">0</span>;                       <span class="comment">// How many bytes received so far</span></span><br><span class="line">    <span class="keyword">let</span> reader = response.<span class="property">body</span>.<span class="title function_">getReader</span>();  <span class="comment">// Read bytes with this function</span></span><br><span class="line">    <span class="keyword">let</span> decoder = <span class="keyword">new</span> <span class="title class_">TextDecoder</span>(<span class="string">&quot;utf-8&quot;</span>);  <span class="comment">// For converting bytes to text</span></span><br><span class="line">    <span class="keyword">let</span> body = <span class="string">&quot;&quot;</span>;                           <span class="comment">// Text read so far</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>) &#123;                                 <span class="comment">// Loop until we exit below</span></span><br><span class="line">        <span class="keyword">let</span> &#123;done, value&#125; = <span class="keyword">await</span> reader.<span class="title function_">read</span>();  <span class="comment">// Read a chunk</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (value) &#123;                              <span class="comment">// If we got a byte array:</span></span><br><span class="line">            <span class="keyword">if</span> (processChunk) &#123;                   <span class="comment">// Process the bytes if</span></span><br><span class="line">                <span class="keyword">let</span> processed = <span class="title function_">processChunk</span>(value);  <span class="comment">// a callback was passed.</span></span><br><span class="line">                <span class="keyword">if</span> (processed) &#123;</span><br><span class="line">                    body += processed;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;                              <span class="comment">// Otherwise, convert bytes</span></span><br><span class="line">                body += decoder.<span class="title function_">decode</span>(value, &#123;<span class="attr">stream</span>: <span class="literal">true</span>&#125;); <span class="comment">// to text.</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (reportProgress) &#123;                 <span class="comment">// If a progress callback was</span></span><br><span class="line">                bytesRead += value.<span class="property">length</span>;        <span class="comment">// passed, then call it</span></span><br><span class="line">                <span class="title function_">reportProgress</span>(bytesRead, bytesRead / expectedBytes);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (done) &#123;                               <span class="comment">// If this is the last chunk,</span></span><br><span class="line">            <span class="keyword">break</span>;                                <span class="comment">// exit the loop</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> body;   <span class="comment">// Return the body text we accumulated</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This streaming API is new at the time of this writing and is expected to evolve. In particular, there are plans to make ReadableStream objects asynchronously iterable so that they can be used with for&#x2F;await loops (Â§13.4.1).</p>
<p>SPECIFYING THE REQUEST METHOD AND REQUEST BODY<br>In each of the fetch() examples shown so far, we have made an HTTP (or HTTPS) GET request. If you want to use a different request method (such as POST, PUT, or DELETE), simply use the two-argument version of fetch(), passing an Options object with a method parameter:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">fetch</span>(url, &#123; <span class="attr">method</span>: <span class="string">&quot;POST&quot;</span> &#125;).<span class="title function_">then</span>(<span class="function"><span class="params">r</span> =&gt;</span> r.<span class="title function_">json</span>()).<span class="title function_">then</span>(handleResponse);</span><br></pre></td></tr></table></figure>
<p>POST and PUT requests typically have a request body containing data to be sent to the server. As long as the method property is not set to â€œGETâ€ or â€œHEADâ€ (which do not support request bodies), you can specify a request body by setting the body property of the Options object:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">fetch</span>(url, &#123;</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">    <span class="attr">body</span>: <span class="string">&quot;hello world&quot;</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>When you specify a request body, the browser automatically adds an appropriate â€œContent-Lengthâ€ header to the request. When the body is a string, as in the preceding example, the browser defaults the â€œContent-Typeâ€ header to â€œtext&#x2F;plain;charset&#x3D;UTF-8.â€ You may need to override this default if you specify a string body of some more specific type such as â€œtext&#x2F;htmlâ€ or â€œapplication&#x2F;jsonâ€:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">fetch</span>(url, &#123;</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">    <span class="attr">headers</span>: <span class="keyword">new</span> <span class="title class_">Headers</span>(&#123;<span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/json&quot;</span>&#125;),</span><br><span class="line">    <span class="attr">body</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(requestBody)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>The body property of the fetch() options object does not have to be a string. If you have binary data in a typed array or a DataView object or an ArrayBuffer, you can set the body property to that value and specify an appropriate â€œContent-Typeâ€ header. If you have binary data in Blob form, you can simply set body to the Blob. Blobs have a type property that specifies their content type, and the value of this property is used as the default value of the â€œContent-Typeâ€ header.</p>
<p>With POST requests, is it somewhat common to pass a set of name&#x2F;value parameters in the request body (instead of encoding them into the query portion of the URL). There are two ways to do this:</p>
<p>You can specify your parameter names and values with URLSearchParams (which we saw earlier in this section, and which is documented in Â§11.9) and then pass the URLSearchParams object as the value of the body property. If you do this, the body will be set to a string that looks like the query portion of a URL, and the â€œContent-Typeâ€ header will be automatically set to â€œapplication&#x2F;x-www-form-urlencoded;charset&#x3D;UTF-8.â€</p>
<p>If instead you specify your parameter names and values with a FormData object, the body will use a more verbose multipart encoding and â€œContent-Typeâ€ will be set to â€œmultipart&#x2F;form-data; boundary&#x3D;â€¦â€ with a unique boundary string that matches the body. Using a FormData object is particularly useful when the values you want to upload are long, or are File or Blob objects that may each have its own â€œContent-Type.â€ FormData objects can be created and initialized with values by passing a <code>&lt;form&gt;</code> element to the FormData() constructor. But you can also create â€œmultipart&#x2F;form-dataâ€ request bodies by invoking the FormData() constructor with no arguments and initializing the name&#x2F;value pairs it represents with the set() and append() methods.</p>
<p>FILE UPLOAD WITH FETCH()<br>Uploading files from a userâ€™s computer to a web server is a common task and can be accomplished using a FormData object as the request body. A common way to obtain a File object is to display an <code>&lt;input type=&quot;file&quot;&gt;</code> element on your web page and listen for â€œchangeâ€ events on that element. When a â€œchangeâ€ event occurs, the files array of the input element should contain at least one File object. File objects are also available through the HTML drag-and-drop API. That API is not covered in this book, but you can get files from the dataTransfer.files array of the event object passed to an event listener for â€œdropâ€ events.</p>
<p>Remember also that File objects are a kind of Blob, and sometimes it can be useful to upload Blobs. Suppose youâ€™ve written a web application that allows the user to create drawings in a <code>&lt;canvas&gt;</code> element. You can upload the userâ€™s drawings as PNG files with code like the following:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The canvas.toBlob() function is callback-based.</span></span><br><span class="line"><span class="comment">// This is a Promise-based wrapper for it.</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getCanvasBlob</span>(<span class="params">canvas</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        canvas.<span class="title function_">toBlob</span>(resolve);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Here is how we upload a PNG file from a canvas</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">uploadCanvasImage</span>(<span class="params">canvas</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> pngblob = <span class="keyword">await</span> <span class="title function_">getCanvasBlob</span>(canvas);</span><br><span class="line">    <span class="keyword">let</span> formdata = <span class="keyword">new</span> <span class="title class_">FormData</span>();</span><br><span class="line">    formdata.<span class="title function_">set</span>(<span class="string">&quot;canvasimage&quot;</span>, pngblob);</span><br><span class="line">    <span class="keyword">let</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&quot;/upload&quot;</span>, &#123; <span class="attr">method</span>: <span class="string">&quot;POST&quot;</span>, <span class="attr">body</span>: formdata &#125;);</span><br><span class="line">    <span class="keyword">let</span> body = <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>CROSS-ORIGIN REQUESTS<br>Most often, fetch() is used by web applications to request data from their own web server. Requests like these are known as same-origin requests because the URL passed to fetch() has the same origin (protocol plus hostname plus port) as the document that contains the script that is making the request.</p>
<p>For security reasons, web browsers generally disallow (though there are exceptions for images and scripts) cross-origin network requests. However, Cross-Origin Resource Sharing, or CORS, enables safe cross-origin requests. When fetch() is used with a cross-origin URL, the browser adds an â€œOriginâ€ header to the request (and does not allow it to be overridden via the headers property) to notify the web server that the request is coming from a document with a different origin. If the server responds to the request with an appropriate â€œAccess-Control-Allow-Originâ€ header, then the request proceeds. Otherwise, if the server does not explicitly allow the request, then the Promise returned by fetch() is rejected.</p>
<p>ABORTING A REQUEST<br>Sometimes you may want to abort a fetch() request that you have already issued, perhaps because the user clicked a Cancel button or the request is taking too long. The fetch API allows requests to be aborted using the AbortController and AbortSignal classes. (These classes define a generic abort mechanism suitable for use by other APIs as well.)</p>
<p>If you want to have the option of aborting a fetch() request, then create an AbortController object before starting the request. The signal property of the controller object is an AbortSignal object. Pass this signal object as the value of the signal property of the options object that you pass to fetch(). Having done that, you can call the abort() method of the controller object to abort the request, which will cause any Promise objects related to the fetch request to reject with an exception.</p>
<p>Here is an example of using the AbortController mechanism to enforce a timeout for fetch requests:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This function is like fetch(), but it adds support for a timeout</span></span><br><span class="line"><span class="comment">// property in the options object and aborts the fetch if it is not complete</span></span><br><span class="line"><span class="comment">// within the number of milliseconds specified by that property.</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fetchWithTimeout</span>(<span class="params">url, options=&#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">timeout</span>) &#123;  <span class="comment">// If the timeout property exists and is nonzero</span></span><br><span class="line">        <span class="keyword">let</span> controller = <span class="keyword">new</span> <span class="title class_">AbortController</span>();  <span class="comment">// Create a controller</span></span><br><span class="line">        options.<span class="property">signal</span> = controller.<span class="property">signal</span>;      <span class="comment">// Set the signal property</span></span><br><span class="line">        <span class="comment">// Start a timer that will send the abort signal after the specified</span></span><br><span class="line">        <span class="comment">// number of milliseconds have passed. Note that we never cancel</span></span><br><span class="line">        <span class="comment">// this timer. Calling abort() after the fetch is complete has</span></span><br><span class="line">        <span class="comment">// no effect.</span></span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123; controller.<span class="title function_">abort</span>(); &#125;, options.<span class="property">timeout</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Now just perform a normal fetch</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">fetch</span>(url, options);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>MISCELLANEOUS REQUEST OPTIONS<br>Weâ€™ve seen that an Options object can be passed as the second argument to fetch() (or as the second argument to the Request() constructor) to specify the request method, request headers, and request body. It supports a number of other options as well, including these:</p>
<p>cache<br>Use this property to override the browserâ€™s default caching behavior. HTTP caching is a complex topic that is beyond the scope of this book, but if you know something about how it works, you can use the following legal values of cache:</p>
<p>â€œdefaultâ€<br>This value specifies the default caching behavior. Fresh responses in the cache are served directly from the cache, and stale responses are revalidated before being served.</p>
<p>â€œno-storeâ€<br>This value makes the browser ignore its cache. The cache is not checked for matches when the request is made and is not updated when the response arrives.</p>
<p>â€œreloadâ€<br>This value tells the browser to always make a normal network request, ignoring the cache. When the response arrives, however, it is stored in the cache.</p>
<p>â€œno-cacheâ€<br>This (misleadingly named) value tells the browser to not serve fresh values from the cache. Fresh or stale cached values are revalidated before being returned.</p>
<p>â€œforce-cacheâ€<br>This value tells the browser to serve responses from the cache even if they are stale.</p>
<p>redirect<br>This property controls how the browser handles redirect responses from the server. The three legal values are:</p>
<p>â€œfollowâ€<br>This is the default value, and it makes the browser follow redirects automatically. If you use this default, the Response objects you get with fetch() should never have a status in the 300 to 399 range.</p>
<p>â€œerrorâ€<br>This value makes fetch() reject its returned Promise if the server returns a redirect response.</p>
<p>â€œmanualâ€<br>This value means that you want to manually handle redirect responses, and the Promise returned by fetch() may resolve to a Response object with a status in the 300 to 399 range. In this case, you will have to use the â€œLocationâ€ header of the Response to manually follow the redirection.</p>
<p>referrer<br>You can set this property to a string that contains a relative URL to specify the value of the HTTP â€œRefererâ€ header (which is historically misspelled with three Rs instead of four). If you set this property to the empty string, then the â€œRefererâ€ header will be omitted from the request.</p>
<h3 id="15-11-2-Server-Sent-Events"><a href="#15-11-2-Server-Sent-Events" class="headerlink" title="15.11.2 Server-Sent Events"></a>15.11.2 Server-Sent Events</h3><p>A fundamental feature of the HTTP protocol upon which the web is built is that clients initiate requests and servers respond to those requests. Some web apps find it useful, however, to have their server send them notifications when events occur. This does not come naturally to HTTP, but the technique that has been devised is for the client to make a request to the server, and then neither the client nor the server close the connection. When the server has something to tell the client about, it writes data to the connection but keeps it open. The effect is as if the client makes a network request and the server responds in a slow and bursty way with significant pauses between bursts of activity. Network connections like this donâ€™t usually stay open forever, but if the client detects that the connection has closed, it can simply make another request to reopen the connection.</p>
<p>This technique for allowing servers to send messages to clients is surprisingly effective (though it can be expensive on the server side because the server must maintain an active connection to all of its clients). Because it is a useful programming pattern, client-side JavaScript supports it with the EventSource API. To create this kind of long-lived request connection to a web server, simply pass a URL to the EventSource() constructor. When the server writes (properly formatted) data to the connection, the EventSource object translates those into events that you can listen for:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> ticker = <span class="keyword">new</span> <span class="title class_">EventSource</span>(<span class="string">&quot;stockprices.php&quot;</span>);</span><br><span class="line">ticker.<span class="title function_">addEventListener</span>(<span class="string">&quot;bid&quot;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">displayNewBid</span>(event.<span class="property">data</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The event object associated with a message event has a data property that holds whatever string the server sent as the payload for this event. The event object also has a type property, like all event objects do, that specifies the name of the event. The server determines the type of the events that are generated. If the server omits an event name in the data it writes, then the event type defaults to â€œmessage.â€</p>
<p>The Server-Sent Event protocol is straightforward. The client initiates a connection to the server (when it creates the EventSource object), and the server keeps this connection open. When an event occurs, the server writes lines of text to the connection. An event going over the wire might look like this, if the comments were omitted:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">event</span>: bid  <span class="comment">// sets the type of the event object</span></span><br><span class="line"><span class="attr">data</span>: <span class="variable constant_">GOOG</span>  <span class="comment">// sets the data property</span></span><br><span class="line"><span class="attr">data</span>: <span class="number">999</span>   <span class="comment">// appends a newline and more data</span></span><br><span class="line">            <span class="comment">// a blank line marks the end of the event</span></span><br></pre></td></tr></table></figure>
<p>There are some additional details to the protocol that allow events to be given IDs and allow a reconnecting client to tell the server what the ID of the last event it received was, so that a server can resend any events it missed. Those details are invisible on the client side, however, and are not discussed here.</p>
<p>One obvious application for Server-Sent Events is for multiuser collaborations like online chat. A chat client might use fetch() to post messages to the chat room and subscribe to the stream of chatter with an EventSource object. Example 15-11 demonstrates how easy it is to write a chat client like this with EventSource.</p>
<p>Example 15-11. A simple chat client using EventSource</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">title</span>&gt;</span>SSE Chat<span class="tag">&lt;/<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- The chat UI is just a single text input field --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- New chat messages will be inserted before this input field --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;input&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:100%; padding:10px; border:solid black 2px&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// Take care of some UI details</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> nick = <span class="title function_">prompt</span>(<span class="string">&quot;Enter your nickname&quot;</span>);     <span class="comment">// Get user&#x27;s nickname</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> input = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;input&quot;</span>); <span class="comment">// Find the input field</span></span></span><br><span class="line"><span class="language-javascript">input.<span class="title function_">focus</span>();                                <span class="comment">// Set keyboard focus</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// Register for notification of new messages using EventSource</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> chat = <span class="keyword">new</span> <span class="title class_">EventSource</span>(<span class="string">&quot;/chat&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">chat.<span class="title function_">addEventListener</span>(<span class="string">&quot;chat&quot;</span>, <span class="function"><span class="params">event</span> =&gt;</span> &#123;  <span class="comment">// When a chat message arrives</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> div = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;div&quot;</span>);  <span class="comment">// Create a &lt;div&gt;</span></span></span><br><span class="line"><span class="language-javascript">    div.<span class="title function_">append</span>(event.<span class="property">data</span>);                   <span class="comment">// Add text from the message</span></span></span><br><span class="line"><span class="language-javascript">    input.<span class="title function_">before</span>(div);                        <span class="comment">// And add div before input</span></span></span><br><span class="line"><span class="language-javascript">    input.<span class="title function_">scrollIntoView</span>();                   <span class="comment">// Ensure input elt is visible</span></span></span><br><span class="line"><span class="language-javascript">&#125;);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// Post the user&#x27;s messages to the server using fetch</span></span></span><br><span class="line"><span class="language-javascript">input.<span class="title function_">addEventListener</span>(<span class="string">&quot;change&quot;</span>, <span class="function">()=&gt;</span>&#123;  <span class="comment">// When the user strikes return</span></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">fetch</span>(<span class="string">&quot;/chat&quot;</span>, &#123;                    <span class="comment">// Start an HTTP request to this url.</span></span></span><br><span class="line"><span class="language-javascript">        <span class="attr">method</span>: <span class="string">&quot;POST&quot;</span>,                 <span class="comment">// Make it a POST request with body</span></span></span><br><span class="line"><span class="language-javascript">        <span class="attr">body</span>: nick + <span class="string">&quot;: &quot;</span> + input.<span class="property">value</span> <span class="comment">// set to the user&#x27;s nick and input.</span></span></span><br><span class="line"><span class="language-javascript">    &#125;)</span></span><br><span class="line"><span class="language-javascript">    .<span class="title function_">catch</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="variable language_">console</span>.<span class="property">error</span>);         <span class="comment">// Ignore response, but log any errors.</span></span></span><br><span class="line"><span class="language-javascript">    input.<span class="property">value</span> = <span class="string">&quot;&quot;</span>;                   <span class="comment">// Clear the input</span></span></span><br><span class="line"><span class="language-javascript">&#125;);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>The server-side code for this chat program is not much more complicated than the client-side code. Example 15-12 is a simple Node HTTP server. When a client requests the root URL â€œ&#x2F;â€, it sends the chat client code shown in Example 15-11. When a client makes a GET request for the URL â€œ&#x2F;chatâ€, it saves the response object and keeps that connection open. And when a client makes a POST request to â€œ&#x2F;chatâ€, it uses the body of the request as a chat message and writes it, using the â€œtext&#x2F;event-streamâ€ format to each of the saved response objects. The server code listens on port 8080, so after running it with Node, point your browser to <a target="_blank" rel="noopener" href="http://localhost:8080/">http://localhost:8080</a> to connect and begin chatting with yourself.</p>
<p>Example 15-12. A Server-Sent Events chat server</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This is server-side JavaScript, intended to be run with NodeJS.</span></span><br><span class="line"><span class="comment">// It implements a very simple, completely anonymous chat room.</span></span><br><span class="line"><span class="comment">// POST new messages to /chat, or GET a text/event-stream of messages</span></span><br><span class="line"><span class="comment">// from the same URL. Making a GET request to / returns a simple HTML file</span></span><br><span class="line"><span class="comment">// that contains the client-side chat UI.</span></span><br><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">&quot;http&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> url = <span class="built_in">require</span>(<span class="string">&quot;url&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// The HTML file for the chat client. Used below.</span></span><br><span class="line"><span class="keyword">const</span> clientHTML = fs.<span class="title function_">readFileSync</span>(<span class="string">&quot;chatClient.html&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// An array of ServerResponse objects that we&#x27;re going to send events to</span></span><br><span class="line"><span class="keyword">let</span> clients = [];</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create a new server, and listen on port 8080.</span></span><br><span class="line"><span class="comment">// Connect to http://localhost:8080/ to use it.</span></span><br><span class="line"><span class="keyword">let</span> server = <span class="keyword">new</span> http.<span class="title class_">Server</span>();</span><br><span class="line">server.<span class="title function_">listen</span>(<span class="number">8080</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// When the server gets a new request, run this function</span></span><br><span class="line">server.<span class="title function_">on</span>(<span class="string">&quot;request&quot;</span>, <span class="function">(<span class="params">request, response</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// Parse the requested URL</span></span><br><span class="line">    <span class="keyword">let</span> pathname = url.<span class="title function_">parse</span>(request.<span class="property">url</span>).<span class="property">pathname</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the request was for &quot;/&quot;, send the client-side chat UI.</span></span><br><span class="line">    <span class="keyword">if</span> (pathname === <span class="string">&quot;/&quot;</span>) &#123;  <span class="comment">// A request for the chat UI</span></span><br><span class="line">        response.<span class="title function_">writeHead</span>(<span class="number">200</span>, &#123;<span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;text/html&quot;</span>&#125;).<span class="title function_">end</span>(clientHTML);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Otherwise send a 404 error for any path other than &quot;/chat&quot; or for</span></span><br><span class="line">    <span class="comment">// any method other than &quot;GET&quot; and &quot;POST&quot;</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (pathname !== <span class="string">&quot;/chat&quot;</span> ||</span><br><span class="line">             (request.<span class="property">method</span> !== <span class="string">&quot;GET&quot;</span> &amp;&amp; request.<span class="property">method</span> !== <span class="string">&quot;POST&quot;</span>)) &#123;</span><br><span class="line">        response.<span class="title function_">writeHead</span>(<span class="number">404</span>).<span class="title function_">end</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// If the /chat request was a GET, then a client is connecting.</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (request.<span class="property">method</span> === <span class="string">&quot;GET&quot;</span>) &#123;</span><br><span class="line">        <span class="title function_">acceptNewClient</span>(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Otherwise the /chat request is a POST of a new message</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_">broadcastNewMessage</span>(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// This handles GET requests for the /chat endpoint which are generated when</span></span><br><span class="line"><span class="comment">// the client creates a new EventSource object (or when the EventSource</span></span><br><span class="line"><span class="comment">// reconnects automatically).</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">acceptNewClient</span>(<span class="params">request, response</span>) &#123;</span><br><span class="line">    <span class="comment">// Remember the response object so we can send future messages to it</span></span><br><span class="line">    clients.<span class="title function_">push</span>(response);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the client closes the connection, remove the corresponding</span></span><br><span class="line">    <span class="comment">// response object from the array of active clients</span></span><br><span class="line">    request.<span class="property">connection</span>.<span class="title function_">on</span>(<span class="string">&quot;end&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        clients.<span class="title function_">splice</span>(clients.<span class="title function_">indexOf</span>(response), <span class="number">1</span>);</span><br><span class="line">        response.<span class="title function_">end</span>();</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set headers and send an initial chat event to just this one client</span></span><br><span class="line">    response.<span class="title function_">writeHead</span>(<span class="number">200</span>, &#123;</span><br><span class="line">        <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;text/event-stream&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;keep-alive&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Cache-Control&quot;</span>: <span class="string">&quot;no-cache&quot;</span></span><br><span class="line">    &#125;);</span><br><span class="line">    response.<span class="title function_">write</span>(<span class="string">&quot;event: chat\ndata: Connected\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Note that we intentionally do not call response.end() here.</span></span><br><span class="line">    <span class="comment">// Keeping the connection open is what makes Server-Sent Events work.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This function is called in response to POST requests to the /chat endpoint</span></span><br><span class="line"><span class="comment">// which clients send when users type a new message.</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">broadcastNewMessage</span>(<span class="params">request, response</span>) &#123;</span><br><span class="line">    <span class="comment">// First, read the body of the request to get the user&#x27;s message</span></span><br><span class="line">    request.<span class="title function_">setEncoding</span>(<span class="string">&quot;utf8&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> body = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span> <span class="keyword">await</span> (<span class="keyword">let</span> chunk <span class="keyword">of</span> request) &#123;</span><br><span class="line">        body += chunk;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Once we&#x27;ve read the body send an empty response and close the connection</span></span><br><span class="line">    response.<span class="title function_">writeHead</span>(<span class="number">200</span>).<span class="title function_">end</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Format the message in text/event-stream format, prefixing each</span></span><br><span class="line">    <span class="comment">// line with &quot;data: &quot;</span></span><br><span class="line">    <span class="keyword">let</span> message = <span class="string">&quot;data: &quot;</span> + body.<span class="title function_">replace</span>(<span class="string">&quot;\n&quot;</span>, <span class="string">&quot;\ndata: &quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Give the message data a prefix that defines it as a &quot;chat&quot; event</span></span><br><span class="line">    <span class="comment">// and give it a double newline suffix that marks the end of the event.</span></span><br><span class="line">    <span class="keyword">let</span> event = <span class="string">`event: chat\n<span class="subst">$&#123;message&#125;</span>\n\n`</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Now send this event to all listening clients</span></span><br><span class="line">    clients.<span class="title function_">forEach</span>(<span class="function"><span class="params">client</span> =&gt;</span> client.<span class="title function_">write</span>(event));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="15-11-3-WebSockets"><a href="#15-11-3-WebSockets" class="headerlink" title="15.11.3 WebSockets"></a>15.11.3 WebSockets</h3><p>The WebSocket API is a simple interface to a complex and powerful network protocol. WebSockets allow JavaScript code in the browser to easily exchange text and binary messages with a server. As with Server-Sent Events, the client must establish the connection, but once the connection is established, the server can asynchronously send messages to the client. Unlike SSE, binary messages are supported, and messages can be sent in both directions, not just from server to client.</p>
<p>The network protocol that enables WebSockets is a kind of extension to HTTP. Although the WebSocket API is reminiscent of low-level network sockets, connection endpoints are not identified by IP address and port. Instead, when you want to connect to a service using the WebSocket protocol, you specify the service with a URL, just as you would for a web service. WebSocket URLs begin with wss:&#x2F;&#x2F; instead of https:&#x2F;&#x2F;, however. (Browsers typically restrict WebSockets to only work in pages loaded over secure https:&#x2F;&#x2F; connections).</p>
<p>To establish a WebSocket connection, the browser first establishes an HTTP connection and sends the server an Upgrade: websocket header requesting that the connection be switched from the HTTP protocol to the WebSocket protocol. What this means is that in order to use WebSockets in your client-side JavaScript, you will need to be working with a web server that also speaks the WebSocket protocol, and you will need to have server-side code written to send and receive data using that protocol. If your server is set up that way, then this section will explain everything you need to know to handle the client-side end of the connection. If your server does not support the WebSocket protocol, consider using Server-Sent Events (Â§15.11.2) instead.</p>
<p>CREATING, CONNECTING, AND DISCONNECTING WEBSOCKETS<br>If you want to communicate with a WebSocket-enabled server, create a WebSocket object, specifying the wss:&#x2F;&#x2F; URL that identifies the server and service you want to use:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> socket = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(<span class="string">&quot;wss://example.com/stockticker&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>When you create a WebSocket, the connection process begins automatically. But a newly created WebSocket will not be connected when it is first returned.</p>
<p>The readyState property of the socket specifies what state the connection is in. This property can have the following values:</p>
<p>WebSocket.CONNECTING<br>This WebSocket is connecting.</p>
<p>WebSocket.OPEN<br>This WebSocket is connected and ready for communication.</p>
<p>WebSocket.CLOSING<br>This WebSocket connection is being closed.</p>
<p>WebSocket.CLOSED<br>This WebSocket has been closed; no further communication is possible. This state can also occur when the initial connection attempt fails.</p>
<p>When a WebSocket transitions from the CONNECTING to the OPEN state, it fires an â€œopenâ€ event, and you can listen for this event by setting the onopen property of the WebSocket or by calling addEventListener() on that object.</p>
<p>If a protocol or other error occurs for a WebSocket connection, the WebSocket object fires an â€œerrorâ€ event. You can set onerror to define a handler, or, alternatively, use addEventListener().</p>
<p>When you are done with a WebSocket, you can close the connection by calling the close() method of the WebSocket object. When a WebSocket changes to the CLOSED state, it fires a â€œcloseâ€ event, and you can set the onclose property to listen for this event.</p>
<p>SENDING MESSAGES OVER A WEBSOCKET<br>To send a message to the server on the other end of a WebSocket connection, simply invoke the send() method of the WebSocket object. send() expects a single message argument, which can be a string, Blob, ArrayBuffer, typed array, or DataView object.</p>
<p>The send() method buffers the specified message to be transmitted and returns before the message is actually sent. The bufferedAmount property of the WebSocket object specifies the number of bytes that are buffered but not yet sent. (Surprisingly, WebSockets do not fire any event when this value reaches 0.)</p>
<p>RECEIVING MESSAGES FROM A WEBSOCKET<br>To receive messages from a server over a WebSocket, register an event handler for â€œmessageâ€ events, either by setting the onmessage property of the WebSocket object, or by calling addEventListener(). The object associated with a â€œmessageâ€ event is a MessageEvent instance with a data property that contains the serverâ€™s message. If the server sent UTF-8 encoded text, then event.data will be a string containing that text.</p>
<p>If the server sends a message that consists of binary data instead of text, then the data property will (by default) be a Blob object representing that data. If you prefer to receive binary messages as ArrayBuffers instead of Blobs, set the binaryType property of the WebSocket object to the string â€œarraybuffer.â€</p>
<p>There are a number of Web APIs that use MessageEvent objects for exchanging messages. Some of these APIs use the structured clone algorithm (see â€œThe Structured Clone Algorithmâ€) to allow complex data structures as the message payload. WebSockets is not one of those APIs: messages exchanged over a WebSocket are either a single string of Unicode characters or a single string of bytes (represented as a Blob or an ArrayBuffer).</p>
<p>PROTOCOL NEGOTIATION<br>The WebSocket protocol enables the exchange of text and binary messages, but says nothing at all about the structure or meaning of those messages. Applications that use WebSockets must build their own communication protocol on top of this simple message-exchange mechanism. The use of wss:&#x2F;&#x2F; URLs helps with this: each URL will typically have its own rules for how messages are to be exchanged. If you write code to connect to wss:&#x2F;&#x2F;example.com&#x2F;stockticker, then you probably know that you will be receiving messages about stock prices.</p>
<p>Protocols tend to evolve, however. If a hypothetical stock quotation protocol is updated, you can define a new URL and connect to the updated service as wss:&#x2F;&#x2F;example.com&#x2F;stockticker&#x2F;v2. URL-based versioning is not always sufficient, however. With complex protocols that have evolved over time, you may end up with deployed servers that support multiple versions of the protocol and deployed clients that support a different set of protocol versions.</p>
<p>Anticipating this situation, the WebSocket protocol and API include an application-level protocol negotiation feature. When you call the WebSocket() constructor, the wss:&#x2F;&#x2F; URL is the first argument, but you can also pass an array of strings as the second argument. If you do this, you are specifying a list of application protocols that you know how to handle and asking the server to pick one. During the connection process, the server will choose one of the protocols (or will fail with an error if it does not support any of the clientâ€™s options). Once the connection has been established, the protocol property of the WebSocket object specifies which protocol version the server chose.</p>
<h2 id="15-12-Storage"><a href="#15-12-Storage" class="headerlink" title="15.12 Storage"></a>15.12 Storage</h2><p>Web applications can use browser APIs to store data locally on the userâ€™s computer. This client-side storage serves to give the web browser a memory. Web apps can store user preferences, for example, or even store their complete state, so that they can resume exactly where you left off at the end of your last visit. Client-side storage is segregated by origin, so pages from one site canâ€™t read the data stored by pages from another site. But two pages from the same site can share storage and use it as a communication mechanism. Data input in a form on one page can be displayed in a table on another page, for example. Web applications can choose the lifetime of the data they store: data can be stored temporarily so that it is retained only until the window closes or the browser exits, or it can be saved on the userâ€™s computer and stored permanently so that it is available months or years later.</p>
<p>There are a number of forms of client-side storage:</p>
<p>Web Storage<br>The Web Storage API consists of the localStorage and sessionStorage objects, which are essentially persistent objects that map string keys to string values. Web Storage is very easy to use and is suitable for storing large (but not huge) amounts of data.</p>
<p>Cookies<br>Cookies are an old client-side storage mechanism that was designed for use by server-side scripts. An awkward JavaScript API makes cookies scriptable on the client side, but theyâ€™re hard to use and suitable only for storing small amounts of textual data. Also, any data stored as cookies is always transmitted to the server with every HTTP request, even if the data is only of interest to the client.</p>
<p>IndexedDB<br>IndexedDB is an asynchronous API to an object database that supports indexing.</p>
<p>STORAGE, SECURITY, AND PRIVACY<br>Web browsers often offer to remember web passwords for you, and they store them safely in encrypted form on the device. But none of the forms of client-side data storage described in this chapter involve encryption: you should assume that anything your web applications save resides on the userâ€™s device in unencrypted form. Stored data is therefore accessible to curious users who share access to the device and to malicious software (such as spyware) that exists on the device. For this reason, no form of client-side storage should ever be used for passwords, financial account numbers, or other similarly sensitive information.</p>
<h3 id="15-12-1-localStorage-and-sessionStorage"><a href="#15-12-1-localStorage-and-sessionStorage" class="headerlink" title="15.12.1 localStorage and sessionStorage"></a>15.12.1 localStorage and sessionStorage</h3><p>The localStorage and sessionStorage properties of the Window object refer to Storage objects. A Storage object behaves much like a regular JavaScript object, except that:</p>
<p>The property values of Storage objects must be strings.</p>
<p>The properties stored in a Storage object persist. If you set a property of the localStorage object and then the user reloads the page, the value you saved in that property is still available to your program.</p>
<p>You can use the localStorage object like this, for example:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> name = <span class="variable language_">localStorage</span>.<span class="property">username</span>;         <span class="comment">// Query a stored value.</span></span><br><span class="line"><span class="keyword">if</span> (!name) &#123;</span><br><span class="line">    name = <span class="title function_">prompt</span>(<span class="string">&quot;What is your name?&quot;</span>);  <span class="comment">// Ask the user a question.</span></span><br><span class="line">    <span class="variable language_">localStorage</span>.<span class="property">username</span> = name;         <span class="comment">// Store the user&#x27;s response.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>You can use the delete operator to remove properties from localStorage and sessionStorage, and you can use a for&#x2F;in loop or Object.keys() to enumerate the properties of a Storage object. If you want to remove all properties of a storage object, call the clear() method:</p>
<p>localStorage.clear();<br>Storage objects also define getItem(), setItem(), and deleteItem() methods, which you can use instead of direct property access and the delete operator if you want to.</p>
<p>Keep in mind that the properties of Storage objects can only store strings. If you want to store and retrieve other kinds of data, youâ€™ll have to encode and decode it yourself.</p>
<p>For example:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// If you store a number, it is automatically converted to a string.</span></span><br><span class="line"><span class="comment">// Don&#x27;t forget to parse it when retrieving it from storage.</span></span><br><span class="line"><span class="variable language_">localStorage</span>.<span class="property">x</span> = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">let</span> x = <span class="built_in">parseInt</span>(<span class="variable language_">localStorage</span>.<span class="property">x</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Convert a Date to a string when setting, and parse it when getting</span></span><br><span class="line"><span class="variable language_">localStorage</span>.<span class="property">lastRead</span> = (<span class="keyword">new</span> <span class="title class_">Date</span>()).<span class="title function_">toUTCString</span>();</span><br><span class="line"><span class="keyword">let</span> lastRead = <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="title class_">Date</span>.<span class="title function_">parse</span>(<span class="variable language_">localStorage</span>.<span class="property">lastRead</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// JSON makes a convenient encoding for any primitive or data structure</span></span><br><span class="line"><span class="variable language_">localStorage</span>.<span class="property">data</span> = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(data);  <span class="comment">// Encode and store</span></span><br><span class="line"><span class="keyword">let</span> data = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="variable language_">localStorage</span>.<span class="property">data</span>);  <span class="comment">// Retrieve and decode.</span></span><br></pre></td></tr></table></figure>
<p>STORAGE LIFETIME AND SCOPE<br>The difference between localStorage and sessionStorage involves the lifetime and scope of the storage. Data stored through localStorage is permanent: it does not expire and remains stored on the userâ€™s device until a web app deletes it or the user asks the browser (through some browser-specific UI) to delete it.</p>
<p>localStorage is scoped to the document origin. As explained in â€œThe same-origin policyâ€, the origin of a document is defined by its protocol, hostname, and port. All documents with the same origin share the same localStorage data (regardless of the origin of the scripts that actually access localStorage). They can read each otherâ€™s data, and they can overwrite each otherâ€™s data. But documents with different origins can never read or overwrite each otherâ€™s data (even if theyâ€™re both running a script from the same third-party server).</p>
<p>Note that localStorage is also scoped by browser implementation. If you visit a site using Firefox and then visit again using Chrome (for example), any data stored during the first visit will not be accessible during the second visit.</p>
<p>Data stored through sessionStorage has a different lifetime than data stored through localStorage: it has the same lifetime as the top-level window or browser tab in which the script that stored it is running. When the window or tab is permanently closed, any data stored through sessionStorage is deleted. (Note, however, that modern browsers have the ability to reopen recently closed tabs and restore the last browsing session, so the lifetime of these tabs and their associated sessionStorage may be longer than it seems.)</p>
<p>Like localStorage, sessionStorage is scoped to the document origin so that documents with different origins will never share sessionStorage. But sessionStorage is also scoped on a per-window basis. If a user has two browser tabs displaying documents from the same origin, those two tabs have separate sessionStorage data: the scripts running in one tab cannot read or overwrite the data written by scripts in the other tab, even if both tabs are visiting exactly the same page and are running exactly the same scripts.</p>
<p>STORAGE EVENTS<br>Whenever the data stored in localStorage changes, the browser triggers a â€œstorageâ€ event on any other Window objects to which that data is visible (but not on the window that made the change). If a browser has two tabs open to pages with the same origin, and one of those pages stores a value in localStorage, the other tab will receive a â€œstorageâ€ event.</p>
<p>Register a handler for â€œstorageâ€ events either by setting window.onstorage or by calling window.addEventListener() with event type â€œstorageâ€.</p>
<p>The event object associated with a â€œstorageâ€ event has some important properties:</p>
<p>key<br>The name or key of the item that was set or removed. If the clear() method was called, this property will be null.</p>
<p>newValue<br>Holds the new value of the item, if there is one. If removeItem() was called, this property will not be present.</p>
<p>oldValue<br>Holds the old value of an existing item that changed or was deleted. If a new property (with no old value) is added, then this property will not be present in the event object.</p>
<p>storageArea<br>The Storage object that changed. This is usually the localStorage object.</p>
<p>url<br>The URL (as a string) of the document whose script made this storage change.</p>
<p>Note that localStorage and the â€œstorageâ€ event can serve as a broadcast mechanism by which a browser sends a message to all windows that are currently visiting the same website. If a user requests that a website stop performing animations, for example, the site might store that preference in localStorage so that it can honor it in future visits. And by storing the preference, it generates an event that allows other windows displaying the same site to honor the request as well.</p>
<p>As another example, imagine a web-based image-editing application that allows the user to display tool palettes in separate windows. When the user selects a tool, the application uses localStorage to save the current state and to generate a notification to other windows that a new tool has been selected.</p>
<h3 id="15-12-2-Cookies"><a href="#15-12-2-Cookies" class="headerlink" title="15.12.2 Cookies"></a>15.12.2 Cookies</h3><p>A cookie is a small amount of named data stored by the web browser and associated with a particular web page or website. Cookies were designed for server-side programming, and at the lowest level, they are implemented as an extension to the HTTP protocol. Cookie data is automatically transmitted between the web browser and web server, so server-side scripts can read and write cookie values that are stored on the client. This section demonstrates how client-side scripts can also manipulate cookies using the cookie property of the Document object.</p>
<p>WHY â€œCOOKIEâ€?<br>The name â€œcookieâ€ does not have a lot of significance, but it is not used without precedent. In the annals of computing history, the term â€œcookieâ€ or â€œmagic cookieâ€ has been used to refer to a small chunk of data, particularly a chunk of privileged or secret data, akin to a password, that proves identity or permits access. In JavaScript, cookies are used to save state and can establish a kind of identity for a web browser. Cookies in JavaScript do not use any kind of cryptography, however, and are not secure in any way (although transmitting them across an https: connection helps).</p>
<p>The API for manipulating cookies is an old and cryptic one. There are no methods involved: cookies are queried, set, and deleted by reading and writing the cookie property of the Document object using specially formatted strings. The lifetime and scope of each cookie can be individually specified with cookie attributes. These attributes are also specified with specially formatted strings set on the same cookie property.</p>
<p>The subsections that follow explain how to query and set cookie values and attributes.</p>
<p>READING COOKIES<br>When you read the document.cookie property, it returns a string that contains all the cookies that apply to the current document. The string is a list of name&#x2F;value pairs separated from each other by a semicolon and a space. The cookie value is just the value itself and does not include any of the attributes that may be associated with that cookie. (Weâ€™ll talk about attributes next.) In order to make use of the document.cookie property, you must typically call the split() method to break it into individual name&#x2F;value pairs.</p>
<p>Once you have extracted the value of a cookie from the cookie property, you must interpret that value based on whatever format or encoding was used by the cookieâ€™s creator. You might, for example, pass the cookie value to decodeURIComponent() and then to JSON.parse().</p>
<p>The code that follows defines a getCookie() function that parses the document.cookie property and returns an object whose properties specify the names and values of the documentâ€™s cookies:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Return the document&#x27;s cookies as a Map object.</span></span><br><span class="line"><span class="comment">// Assume that cookie values are encoded with encodeURIComponent().</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getCookies</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> cookies = <span class="keyword">new</span> <span class="title class_">Map</span>();    <span class="comment">// The object we will return</span></span><br><span class="line">    <span class="keyword">let</span> all = <span class="variable language_">document</span>.<span class="property">cookie</span>;  <span class="comment">// Get all cookies in one big string</span></span><br><span class="line">    <span class="keyword">let</span> list = all.<span class="title function_">split</span>(<span class="string">&quot;; &quot;</span>); <span class="comment">// Split into individual name/value pairs</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> cookie <span class="keyword">of</span> list) &#123;   <span class="comment">// For each cookie in that list</span></span><br><span class="line">        <span class="keyword">if</span> (!cookie.<span class="title function_">includes</span>(<span class="string">&quot;=&quot;</span>)) <span class="keyword">continue</span>; <span class="comment">// Skip if there is no = sign</span></span><br><span class="line">        <span class="keyword">let</span> p = cookie.<span class="title function_">indexOf</span>(<span class="string">&quot;=&quot;</span>);         <span class="comment">// Find the first = sign</span></span><br><span class="line">        <span class="keyword">let</span> name = cookie.<span class="title function_">substring</span>(<span class="number">0</span>, p);   <span class="comment">// Get cookie name</span></span><br><span class="line">        <span class="keyword">let</span> value = cookie.<span class="title function_">substring</span>(p+<span class="number">1</span>);   <span class="comment">// Get cookie value</span></span><br><span class="line">        value = <span class="built_in">decodeURIComponent</span>(value);   <span class="comment">// Decode the value</span></span><br><span class="line">        cookies.<span class="title function_">set</span>(name, value);            <span class="comment">// Remember cookie name and value</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cookies;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>COOKIE ATTRIBUTES: LIFETIME AND SCOPE<br>In addition to a name and a value, each cookie has optional attributes that control its lifetime and scope. Before we can describe how to set cookies with JavaScript, we need to explain cookie attributes.</p>
<p>Cookies are transient by default; the values they store last for the duration of the web browser session but are lost when the user exits the browser. If you want a cookie to last beyond a single browsing session, you must tell the browser how long (in seconds) you would like it to retain the cookie by specifying a max-age attribute. If you specify a lifetime, the browser will store cookies in a file and delete them only once they expire.</p>
<p>Cookie visibility is scoped by document origin as localStorage and sessionStorage are, but also by document path. This scope is configurable through cookie attributes path and domain. By default, a cookie is associated with, and accessible to, the web page that created it and any other web pages in the same directory or any subdirectories of that directory. If the web page example.com&#x2F;catalog&#x2F;index.html creates a cookie, for example, that cookie is also visible to example.com&#x2F;catalog&#x2F;order.html and example.com&#x2F;catalog&#x2F;widgets&#x2F;index.html, but it is not visible to example.com&#x2F;about.html.</p>
<p>This default visibility behavior is often exactly what you want. Sometimes, though, youâ€™ll want to use cookie values throughout a website, regardless of which page creates the cookie. For instance, if the user enters their mailing address in a form on one page, you may want to save that address to use as the default the next time they return to the page and also as the default in an entirely unrelated form on another page where they are asked to enter a billing address. To allow this usage, you specify a path for the cookie. Then, any web page from the same web server whose URL begins with the path prefix you specified can share the cookie. For example, if a cookie set by example.com&#x2F;catalog&#x2F;widgets&#x2F;index.html has its path set to â€œ&#x2F;catalogâ€, that cookie is also visible to example.com&#x2F;catalog&#x2F;order.html. Or, if the path is set to â€œ&#x2F;â€, the cookie is visible to any page in the example.com domain, giving the cookie a scope like that of localStorage.</p>
<p>By default, cookies are scoped by document origin. Large websites may want cookies to be shared across subdomains, however. For example, the server at order.example.com may need to read cookie values set from catalog.example.com. This is where the domain attribute comes in. If a cookie created by a page on catalog.example.com sets its path attribute to â€œ&#x2F;â€ and its domain attribute to â€œ.example.com,â€ that cookie is available to all web pages on catalog.example.com, orders.example.com, and any other server in the example.com domain. Note that you cannot set the domain of a cookie to a domain other than a parent domain of your server.</p>
<p>The final cookie attribute is a boolean attribute named secure that specifies how cookie values are transmitted over the network. By default, cookies are insecure, which means that they are transmitted over a normal, insecure HTTP connection. If a cookie is marked secure, however, it is transmitted only when the browser and server are connected via HTTPS or another secure protocol.</p>
<p>COOKIE LIMITATIONS<br>Cookies are intended for storage of small amounts of data by server-side scripts, and that data is transferred to the server each time a relevant URL is requested. The standard that defines cookies encourages browser manufacturers to allow unlimited numbers of cookies of unrestricted size but does not require browsers to retain more than 300 cookies total, 20 cookies per web server, or 4 KB of data per cookie (both name and value count toward this 4 KB limit). In practice, browsers allow many more than 300 cookies total, but the 4 KB size limit may still be enforced by some.</p>
<p>STORING COOKIES<br>To associate a transient cookie value with the current document, simply set the cookie property to a name&#x3D;value string. For example:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">document</span>.<span class="property">cookie</span> = <span class="string">`version=<span class="subst">$&#123;<span class="built_in">encodeURIComponent</span>(<span class="variable language_">document</span>.lastModified)&#125;</span>`</span>;</span><br></pre></td></tr></table></figure>
<p>The next time you read the cookie property, the name&#x2F;value pair you stored is included in the list of cookies for the document. Cookie values cannot include semicolons, commas, or whitespace. For this reason, you may want to use the core JavaScript global function encodeURIComponent() to encode the value before storing it in the cookie. If you do this, youâ€™ll have to use the corresponding decodeURIComponent() function when you read the cookie value.</p>
<p>A cookie written with a simple name&#x2F;value pair lasts for the current web-browsing session but is lost when the user exits the browser. To create a cookie that can last across browser sessions, specify its lifetime (in seconds) with a max-age attribute. You can do this by setting the cookie property to a string of the form: name&#x3D;value; max-age&#x3D;seconds. The following function sets a cookie with an optional max-age attribute:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Store the name/value pair as a cookie, encoding the value with</span></span><br><span class="line"><span class="comment">// encodeURIComponent() in order to escape semicolons, commas, and spaces.</span></span><br><span class="line"><span class="comment">// If daysToLive is a number, set the max-age attribute so that the cookie</span></span><br><span class="line"><span class="comment">// expires after the specified number of days. Pass 0 to delete a cookie.</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">setCookie</span>(<span class="params">name, value, daysToLive=<span class="literal">null</span></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> cookie = <span class="string">`<span class="subst">$&#123;name&#125;</span>=<span class="subst">$&#123;<span class="built_in">encodeURIComponent</span>(value)&#125;</span>`</span>;</span><br><span class="line">    <span class="keyword">if</span> (daysToLive !== <span class="literal">null</span>) &#123;</span><br><span class="line">        cookie += <span class="string">`; max-age=<span class="subst">$&#123;daysToLive*<span class="number">60</span>*<span class="number">60</span>*<span class="number">24</span>&#125;</span>`</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">cookie</span> = cookie;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Similarly, you can set the path and domain attributes of a cookie by appending strings of the form ;path&#x3D;value or ;domain&#x3D;value to the string that you set on the document.cookie property. To set the secure property, simply append ;secure.</p>
<p>To change the value of a cookie, set its value again using the same name, path, and domain along with the new value. You can change the lifetime of a cookie when you change its value by specifying a new max-age attribute.</p>
<p>To delete a cookie, set it again using the same name, path, and domain, specifying an arbitrary (or empty) value, and a max-age attribute of 0.</p>
<h3 id="15-12-3-IndexedDB"><a href="#15-12-3-IndexedDB" class="headerlink" title="15.12.3 IndexedDB"></a>15.12.3 IndexedDB</h3><p>Web application architecture has traditionally featured HTML, CSS, and JavaScript on the client and a database on the server. You may find it surprising, therefore, to learn that the web platform includes a simple object database with a JavaScript API for persistently storing JavaScript objects on the userâ€™s computer and retrieving them as needed.</p>
<p>IndexedDB is an object database, not a relational database, and it is much simpler than databases that support SQL queries. It is more powerful, efficient, and robust than the key&#x2F;value storage provided by the localStorage, however. Like the localStorage, IndexedDB databases are scoped to the origin of the containing document: two web pages with the same origin can access each otherâ€™s data, but web pages from different origins cannot.</p>
<p>Each origin can have any number of IndexedDB databases. Each one has a name that must be unique within the origin. In the IndexedDB API, a database is simply a collection of named object stores. As the name implies, an object store stores objects. Objects are serialized into the object store using the structured clone algorithm (see â€œThe Structured Clone Algorithmâ€), which means that the objects you store can have properties whose values are Maps, Sets, or typed arrays. Each object must have a key by which it can be sorted and retrieved from the store. Keys must be uniqueâ€”two objects in the same store may not have the same keyâ€”and they must have a natural ordering so that they can be sorted. JavaScript strings, numbers, and Date objects are valid keys. An IndexedDB database can automatically generate a unique key for each object you insert into the database. Often, though, the objects you insert into an object store will already have a property that is suitable for use as a key. In this case, you specify a â€œkey pathâ€ for that property when you create the object store. Conceptually, a key path is a value that tells the database how to extract an objectâ€™s key from the object.</p>
<p>In addition to retrieving objects from an object store by their primary key value, you may want to be able to search based on the value of other properties in the object. In order to be able to do this, you can define any number of indexes on the object store. (The ability to index an object store explains the name â€œIndexedDB.â€) Each index defines a secondary key for the stored objects. These indexes are not generally unique, and multiple objects may match a single key value.</p>
<p>IndexedDB provides atomicity guarantees: queries and updates to the database are grouped within a transaction so that they all succeed together or all fail together and never leave the database in an undefined, partially updated state. Transactions in IndexedDB are simpler than in many database APIs; weâ€™ll mention them again later.</p>
<p>Conceptually, the IndexedDB API is quite simple. To query or update a database, you first open the database you want (specifying it by name). Next, you create a transaction object and use that object to look up the desired object store within the database, also by name. Finally, you look up an object by calling the get() method of the object store or store a new object by calling put() (or by calling add(), if you want to avoid overwriting existing objects).</p>
<p>If you want to look up the objects for a range of keys, you create an IDBRange object that specifies the upper and lower bounds of the range and pass it to the getAll() or openCursor() methods of the object store.</p>
<p>If you want to make a query using a secondary key, you look up the named index of the object store, then call the get(), getAll(), or openCursor() methods of the index object, passing either a single key or an IDBRange object.</p>
<p>This conceptual simplicity of the IndexedDB API is complicated, however, by the fact that the API is asynchronous (so that web apps can use it without blocking the browserâ€™s main UI thread). IndexedDB was defined before Promises were widely supported, so the API is event-based rather than Promise-based, which means that it does not work with async and await.</p>
<p>Creating transactions and looking up object stores and indexes are synchronous operations. But opening a database, updating an object store, and querying a store or index are all asynchronous operations. These asynchronous methods all immediately return a request object. The browser triggers a success or error event on the request object when the request succeeds or fails, and you can define handlers with the onsuccess and onerror properties. Inside an onsuccess handler, the result of the operation is available as the result property of the request object. Another useful event is the â€œcompleteâ€ event dispatched on transaction objects when a transaction has completed successfully.</p>
<p>One convenient feature of this asynchronous API is that it simplifies transaction management. The IndexedDB API forces you to create a transaction object in order to get the object store on which you can perform queries and updates. In a synchronous API, you would expect to explicitly mark the end of the transaction by calling a commit() method. But with IndexedDB, transactions are automatically committed (if you do not explicitly abort them) when all the onsuccess event handlers have run and there are no more pending asynchronous requests that refer to that transaction.</p>
<p>There is one more event that is important to the IndexedDB API. When you open a database for the first time, or when you increment the version number of an existing database, IndexedDB fires an â€œupgradeneededâ€ event on the request object returned by the indexedDB.open() call. The job of the event handler for â€œupgradeneededâ€ events is to define or update the schema for the new database (or the new version of the existing database). For IndexedDB databases, this means creating object stores and defining indexes on those object stores. And in fact, the only time the IndexedDB API allows you to create an object store or an index is in response to an â€œupgradeneededâ€ event.</p>
<p>With this high-level overview of IndexedDB in mind, you should now be able to understand Example 15-13. That example uses IndexedDB to create and query a database that maps US postal codes (zip codes) to US cities. It demonstrates many, but not all, of the basic features of IndexedDB. Example 15-13 is long, but well commented.</p>
<p>Example 15-13. A IndexedDB database of US postal codes</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This utility function asynchronously obtains the database object (creating</span></span><br><span class="line"><span class="comment">// and initializing the DB if necessary) and passes it to the callback.</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">withDB</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> request = indexedDB.<span class="title function_">open</span>(<span class="string">&quot;zipcodes&quot;</span>, <span class="number">1</span>); <span class="comment">// Request v1 of the database</span></span><br><span class="line">    request.<span class="property">onerror</span> = <span class="variable language_">console</span>.<span class="property">error</span>;   <span class="comment">// Log any errors</span></span><br><span class="line">    request.<span class="property">onsuccess</span> = <span class="function">() =&gt;</span> &#123;   <span class="comment">// Or call this when done</span></span><br><span class="line">        <span class="keyword">let</span> db = request.<span class="property">result</span>;  <span class="comment">// The result of the request is the database</span></span><br><span class="line">        <span class="title function_">callback</span>(db);             <span class="comment">// Invoke the callback with the database</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If version 1 of the database does not yet exist, then this event</span></span><br><span class="line">    <span class="comment">// handler will be triggered. This is used to create and initialize</span></span><br><span class="line">    <span class="comment">// object stores and indexes when the DB is first created or to modify</span></span><br><span class="line">    <span class="comment">// them when we switch from one version of the DB schema to another.</span></span><br><span class="line">    request.<span class="property">onupgradeneeded</span> = <span class="function">() =&gt;</span> &#123; <span class="title function_">initdb</span>(request.<span class="property">result</span>, callback); &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// withDB() calls this function if the database has not been initialized yet.</span></span><br><span class="line"><span class="comment">// We set up the database and populate it with data, then pass the database to</span></span><br><span class="line"><span class="comment">// the callback function.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Our zip code database includes one object store that holds objects like this:</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//   &#123;</span></span><br><span class="line"><span class="comment">//     zipcode: &quot;02134&quot;,</span></span><br><span class="line"><span class="comment">//     city: &quot;Allston&quot;,</span></span><br><span class="line"><span class="comment">//     state: &quot;MA&quot;,</span></span><br><span class="line"><span class="comment">//   &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// We use the &quot;zipcode&quot; property as the database key and create an index for</span></span><br><span class="line"><span class="comment">// the city name.</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">initdb</span>(<span class="params">db, callback</span>) &#123;</span><br><span class="line">    <span class="comment">// Create the object store, specifying a name for the store and</span></span><br><span class="line">    <span class="comment">// an options object that includes the &quot;key path&quot; specifying the</span></span><br><span class="line">    <span class="comment">// property name of the key field for this store.</span></span><br><span class="line">    <span class="keyword">let</span> store = db.<span class="title function_">createObjectStore</span>(<span class="string">&quot;zipcodes&quot;</span>, <span class="comment">// store name</span></span><br><span class="line">                                     &#123; <span class="attr">keyPath</span>: <span class="string">&quot;zipcode&quot;</span> &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Now index the object store by city name as well as by zip code.</span></span><br><span class="line">    <span class="comment">// With this method the key path string is passed directly as a</span></span><br><span class="line">    <span class="comment">// required argument rather than as part of an options object.</span></span><br><span class="line">    store.<span class="title function_">createIndex</span>(<span class="string">&quot;cities&quot;</span>, <span class="string">&quot;city&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Now get the data we are going to initialize the database with.</span></span><br><span class="line">    <span class="comment">// The zipcodes.json data file was generated from CC-licensed data from</span></span><br><span class="line">    <span class="comment">// www.geonames.org: https://download.geonames.org/export/zip/US.zip</span></span><br><span class="line">    <span class="title function_">fetch</span>(<span class="string">&quot;zipcodes.json&quot;</span>)                  <span class="comment">// Make an HTTP GET request</span></span><br><span class="line">        .<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> response.<span class="title function_">json</span>())  <span class="comment">// Parse the body as JSON</span></span><br><span class="line">        .<span class="title function_">then</span>(<span class="function"><span class="params">zipcodes</span> =&gt;</span> &#123;                 <span class="comment">// Get 40K zip code records</span></span><br><span class="line">            <span class="comment">// In order to insert zip code data into the database we need a</span></span><br><span class="line">            <span class="comment">// transaction object. To create our transaction object, we need</span></span><br><span class="line">            <span class="comment">// to specify which object stores we&#x27;ll be using (we only have</span></span><br><span class="line">            <span class="comment">// one) and we need to tell it that we&#x27;ll be doing writes to the</span></span><br><span class="line">            <span class="comment">// database, not just reads:</span></span><br><span class="line">            <span class="keyword">let</span> transaction = db.<span class="title function_">transaction</span>([<span class="string">&quot;zipcodes&quot;</span>], <span class="string">&quot;readwrite&quot;</span>);</span><br><span class="line">            transaction.<span class="property">onerror</span> = <span class="variable language_">console</span>.<span class="property">error</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Get our object store from the transaction</span></span><br><span class="line">            <span class="keyword">let</span> store = transaction.<span class="title function_">objectStore</span>(<span class="string">&quot;zipcodes&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// The best part about the IndexedDB API is that object stores</span></span><br><span class="line">            <span class="comment">// are *really* simple. Here&#x27;s how we add (or update) our records:</span></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">let</span> record <span class="keyword">of</span> zipcodes) &#123; store.<span class="title function_">put</span>(record); &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// When the transaction completes successfully, the database</span></span><br><span class="line">            <span class="comment">// is initialized and ready for use, so we can call the</span></span><br><span class="line">            <span class="comment">// callback function that was originally passed to withDB()</span></span><br><span class="line">            transaction.<span class="property">oncomplete</span> = <span class="function">() =&gt;</span> &#123; <span class="title function_">callback</span>(db); &#125;;</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Given a zip code, use the IndexedDB API to asynchronously look up the city</span></span><br><span class="line"><span class="comment">// with that zip code, and pass it to the specified callback, or pass null if</span></span><br><span class="line"><span class="comment">// no city is found.</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">lookupCity</span>(<span class="params">zip, callback</span>) &#123;</span><br><span class="line">    <span class="title function_">withDB</span>(<span class="function"><span class="params">db</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// Create a read-only transaction object for this query. The</span></span><br><span class="line">        <span class="comment">// argument is an array of object stores we will need to use.</span></span><br><span class="line">        <span class="keyword">let</span> transaction = db.<span class="title function_">transaction</span>([<span class="string">&quot;zipcodes&quot;</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Get the object store from the transaction</span></span><br><span class="line">        <span class="keyword">let</span> zipcodes = transaction.<span class="title function_">objectStore</span>(<span class="string">&quot;zipcodes&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Now request the object that matches the specified zipcode key.</span></span><br><span class="line">        <span class="comment">// The lines above were synchronous, but this one is async.</span></span><br><span class="line">        <span class="keyword">let</span> request = zipcodes.<span class="title function_">get</span>(zip);</span><br><span class="line">        request.<span class="property">onerror</span> = <span class="variable language_">console</span>.<span class="property">error</span>;  <span class="comment">// Log errors</span></span><br><span class="line">        request.<span class="property">onsuccess</span> = <span class="function">() =&gt;</span> &#123;       <span class="comment">// Or call this function on success</span></span><br><span class="line">            <span class="keyword">let</span> record = request.<span class="property">result</span>;  <span class="comment">// This is the query result</span></span><br><span class="line">            <span class="keyword">if</span> (record) &#123; <span class="comment">// If we found a match, pass it to the callback</span></span><br><span class="line">                <span class="title function_">callback</span>(<span class="string">`<span class="subst">$&#123;record.city&#125;</span>, <span class="subst">$&#123;record.state&#125;</span>`</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;     <span class="comment">// Otherwise, tell the callback that we failed</span></span><br><span class="line">                <span class="title function_">callback</span>(<span class="literal">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Given the name of a city, use the IndexedDB API to asynchronously</span></span><br><span class="line"><span class="comment">// look up all zip code records for all cities (in any state) that have</span></span><br><span class="line"><span class="comment">// that (case-sensitive) name.</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">lookupZipcodes</span>(<span class="params">city, callback</span>) &#123;</span><br><span class="line">    <span class="title function_">withDB</span>(<span class="function"><span class="params">db</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// As above, we create a transaction and get the object store</span></span><br><span class="line">        <span class="keyword">let</span> transaction = db.<span class="title function_">transaction</span>([<span class="string">&quot;zipcodes&quot;</span>]);</span><br><span class="line">        <span class="keyword">let</span> store = transaction.<span class="title function_">objectStore</span>(<span class="string">&quot;zipcodes&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// This time we also get the city index of the object store</span></span><br><span class="line">        <span class="keyword">let</span> index = store.<span class="title function_">index</span>(<span class="string">&quot;cities&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Ask for all matching records in the index with the specified</span></span><br><span class="line">        <span class="comment">// city name, and when we get them we pass them to the callback.</span></span><br><span class="line">        <span class="comment">// If we expected more results, we might use openCursor() instead.</span></span><br><span class="line">        <span class="keyword">let</span> request = index.<span class="title function_">getAll</span>(city);</span><br><span class="line">        request.<span class="property">onerror</span> = <span class="variable language_">console</span>.<span class="property">error</span>;</span><br><span class="line">        request.<span class="property">onsuccess</span> = <span class="function">() =&gt;</span> &#123; <span class="title function_">callback</span>(request.<span class="property">result</span>); &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="15-13-Worker-Threads-and-Messaging"><a href="#15-13-Worker-Threads-and-Messaging" class="headerlink" title="15.13 Worker Threads and Messaging"></a>15.13 Worker Threads and Messaging</h2><p>One of the fundamental features of JavaScript is that it is single-threaded: a browser will never run two event handlers at the same time, and it will never trigger a timer while an event handler is running, for example. Concurrent updates to application state or to the document are simply not possible, and client-side programmers do not need to think about, or even understand, concurrent programming. A corollary is that client-side JavaScript functions must not run too long; otherwise, they will tie up the event loop and the web browser will become unresponsive to user input. This is the reason that fetch() is an asynchronous function, for example.</p>
<p>Web browsers very carefully relax the single-thread requirement with the Worker class: instances of this class represent threads that run concurrently with the main thread and the event loop. Workers live in a self-contained execution environment with a completely independent global object and no access to the Window or Document objects. Workers can communicate with the main thread only through asynchronous message passing. This means that concurrent modifications of the DOM remain impossible, but it also means that you can write long-running functions that do not stall the event loop and hang the browser. Creating a new worker is not a heavyweight operation like opening a new browser window, but workers are not flyweight â€œfibersâ€ either, and it does not make sense to create new workers to perform trivial operations. Complex web applications may find it useful to create tens of workers, but it is unlikely that an application with hundreds or thousands of workers would be practical.</p>
<p>Workers are useful when your application needs to perform computationally intensive tasks, such as image processing. Using a worker moves tasks like this off the main thread so that the browser does not become unresponsive. And workers also offer the possibility of dividing the work among multiple threads. But workers are also useful when you have to perform frequent moderately intensive computations. Suppose, for example, that youâ€™re implementing a simple in-browser code editor, and want to include syntax highlighting. To get the highlighting right, you need to parse the code on every keystroke. But if you do that on the main thread, it is likely that the parsing code will prevent the event handlers that respond to the userâ€™s key strokes from running promptly and the userâ€™s typing experience will be sluggish.</p>
<p>As with any threading API, there are two parts to the Worker API. The first is the Worker object: this is what a worker looks like from the outside, to the thread that creates it. The second is the WorkerGlobalScope: this is the global object for a new worker, and it is what a worker thread looks like, on the inside, to itself.</p>
<p>The following sections cover Worker and WorkerGlobalScope and also explain the message-passing API that allows workers to communicate with the main thread and each other. The same communication API is used to exchange messages between a document and <code>&lt;iframe&gt;</code> elements contained in the document, and this is covered in the following sections as well.</p>
<h3 id="15-13-1-Worker-Objects"><a href="#15-13-1-Worker-Objects" class="headerlink" title="15.13.1 Worker Objects"></a>15.13.1 Worker Objects</h3><p>To create a new worker, call the Worker() constructor, passing a URL that specifies the JavaScript code that the worker is to run:</p>
<p>let dataCruncher &#x3D; new Worker(â€œutils&#x2F;cruncher.jsâ€);<br>If you specify a relative URL, it is resolved relative to the URL of the document that contains the script that called the Worker() constructor. If you specify an absolute URL, it must have the same origin (same protocol, host, and port) as that containing document.</p>
<p>Once you have a Worker object, you can send data to it with postMessage(). The value you pass to postMessage() will be copied using the structured clone algorithm (see â€œThe Structured Clone Algorithmâ€), and the resulting copy will be delivered to the worker via a message event:</p>
<p>dataCruncher.postMessage(â€œ&#x2F;api&#x2F;data&#x2F;to&#x2F;crunchâ€);<br>Here weâ€™re just passing a single string message, but you can also use objects, arrays, typed arrays, Maps, Sets, and so on. You can receive messages from a worker by listening for â€œmessageâ€ events on the Worker object:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dataCruncher.<span class="property">onmessage</span> = <span class="keyword">function</span>(<span class="params">e</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> stats = e.<span class="property">data</span>;  <span class="comment">// The message is the data property of the event</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Average: <span class="subst">$&#123;stats.mean&#125;</span>`</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Like all event targets, Worker objects define the standard addEventListener() and removeEventListener() methods, and you can use these in place of the onmessage.</p>
<p>In addition to postMessage(), Worker objects have just one other method, terminate(), which forces a worker thread to stop running.</p>
<h3 id="15-13-2-The-Global-Object-in-Workers"><a href="#15-13-2-The-Global-Object-in-Workers" class="headerlink" title="15.13.2 The Global Object in Workers"></a>15.13.2 The Global Object in Workers</h3><p>When you create a new worker with the Worker() constructor, you specify the URL of a file of JavaScript code. That code is executed in a new, pristine JavaScript execution environment, isolated from the script that created the worker. The global object for that new execution environment is a WorkerGlobalScope object. A WorkerGlobalScope is something more than the core JavaScript global object, but less than a full-blown client-side Window object.</p>
<p>The WorkerGlobalScope object has a postMessage() method and an onmessage event handler property that are just like those of the Worker object but work in the opposite direction: calling postMessage() inside a worker generates a message event outside the worker, and messages sent from outside the worker are turned into events and delivered to the onmessage handler. Because the WorkerGlobalScope is the global object for a worker, postMessage() and onmessage look like a global function and global variable to worker code.</p>
<p>If you pass an object as the second argument to the Worker() constructor, and if that object has a name property, then the value of that property becomes the value of the name property in the workerâ€™s global object. A worker might include this name in any messages it prints with console.warn() or console.error().</p>
<p>The close() function allows a worker to terminate itself, and it is similar in effect to the terminate() method of a Worker object.</p>
<p>Since WorkerGlobalScope is the global object for workers, it has all of the properties of the core JavaScript global object, such as the JSON object, the isNaN() function, and the Date() constructor. In addition, however, WorkerGlobalScope also has the following properties of the client-side Window object:</p>
<p>self is a reference to the global object itself. WorkerGlobalScope is not a Window object and does not define a window property.</p>
<p>The timer methods setTimeout(), clearTimeout(), setInterval(), and clearInterval().</p>
<p>A location property that describes the URL that was passed to the Worker() constructor. This property refers to a Location object, just as the location property of a Window does. The Location object has properties href, protocol, host, hostname, port, pathname, search, and hash. In a worker, these properties are read-only, however.</p>
<p>A navigator property that refers to an object with properties like those of the Navigator object of a window. A workerâ€™s Navigator object has the properties appName, appVersion, platform, userAgent, and onLine.</p>
<p>The usual event target methods addEventListener() and removeEventListener().</p>
<p>Finally, the WorkerGlobalScope object includes important client-side JavaScript APIs including the Console object, the fetch() function, and the IndexedDB API. WorkerGlobalScope also includes the Worker() constructor, which means that worker threads can create their own workers.</p>
<h3 id="15-13-3-Importing-Code-into-a-Worker"><a href="#15-13-3-Importing-Code-into-a-Worker" class="headerlink" title="15.13.3 Importing Code into a Worker"></a>15.13.3 Importing Code into a Worker</h3><p>Workers were defined in web browsers before JavaScript had a module system, so workers have a unique system for including additional code. WorkerGlobalScope defines importScripts() as a global function that all workers have access to:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Before we start working, load the classes and utilities we&#x27;ll need</span></span><br><span class="line">importScripts(<span class="string">&quot;utils/Histogram.js&quot;</span>, <span class="string">&quot;utils/BitSet.js&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>importScripts() takes one or more URL arguments, each of which should refer to a file of JavaScript code. Relative URLs are resolved relative to the URL that was passed to the Worker() constructor (not relative to the containing document). importScripts() synchronously loads and executes these files one after the other, in the order in which they were specified. If loading a script causes a network error, or if executing throws an error of any sort, none of the subsequent scripts are loaded or executed. A script loaded with importScripts() can itself call importScripts() to load the files it depends on. Note, however, that importScripts() does not try to keep track of what scripts have already loaded and does nothing to prevent dependency cycles.</p>
<p>importScripts() is a synchronous function: it does not return until all of the scripts have loaded and executed. You can start using the scripts you loaded as soon as importScripts() returns: there is no need for a callback, event handler, then() method or await. Once you have internalized the asynchronous nature of client-side JavaScript, it feels strange to go back to simple, synchronous programming again. But that is the beauty of threads: you can use a blocking function call in a worker without blocking the event loop in the main thread, and without blocking the computations being concurrently performed in other workers.</p>
<p>MODULES IN WORKERS<br>In order to use modules in workers, you must pass a second argument to the Worker() constructor. This second argument must be an object with a type property set to the string â€œmodule.â€ Passing a type:â€moduleâ€ option to the Worker() constructor is much like using the type&#x3D;â€moduleâ€ attribute on an HTML <code>&lt;script&gt;</code> tag: it means that the code should be interpreted as a module and that import declarations are allowed.</p>
<p>When a worker loads a module instead of a traditional script, the WorkerGlobalScope does not define the importScripts() function.</p>
<p>Note that as of early 2020, Chrome is the only browser that supports true modules and import declarations in workers.</p>
<h3 id="15-13-4-Worker-Execution-Model"><a href="#15-13-4-Worker-Execution-Model" class="headerlink" title="15.13.4 Worker Execution Model"></a>15.13.4 Worker Execution Model</h3><p>Worker threads run their code (and all imported scripts or modules) synchronously from top to bottom, and then enter an asynchronous phase in which they respond to events and timers. If a worker registers a â€œmessageâ€ event handler, it will never exit as long as there is a possibility that message events will still arrive. But if a worker doesnâ€™t listen for messages, it will run until there are no further pending tasks (such as fetch() promises and timers) and all task-related callbacks have been called. Once all registered callbacks have been called, there is no way a worker can begin a new task, so it is safe for the thread to exit, which it will do automatically. A worker can also explicitly shut itself down by calling the global close() function. Note that there are no properties or methods on the Worker object that specify whether a worker thread is still running or not, so workers should not close themselves without somehow coordinating this with their parent thread.</p>
<p>ERRORS IN WORKERS<br>If an exception occurs in a worker and is not caught by any catch clause, then an â€œerrorâ€ event is triggered on the global object of the worker. If this event is handled and the handler calls the preventDefault() method of the event object, the error propagation ends. Otherwise, the â€œerrorâ€ event is fired on the Worker object. If preventDefault() is called there, then propagation ends. Otherwise, an error message is printed in the developer console and the onerror handler (Â§15.1.7) of the Window object is invoked.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Handle uncaught worker errors with a handler inside the worker.</span></span><br><span class="line">self.<span class="property">onerror</span> = <span class="keyword">function</span>(<span class="params">e</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Error in worker at <span class="subst">$&#123;e.filename&#125;</span>:<span class="subst">$&#123;e.lineno&#125;</span>: <span class="subst">$&#123;e.message&#125;</span>`</span>);</span><br><span class="line">    e.<span class="title function_">preventDefault</span>();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Or, handle uncaught worker errors with a handler outside the worker.</span></span><br><span class="line">worker.<span class="property">onerror</span> = <span class="keyword">function</span>(<span class="params">e</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Error in worker at <span class="subst">$&#123;e.filename&#125;</span>:<span class="subst">$&#123;e.lineno&#125;</span>: <span class="subst">$&#123;e.message&#125;</span>`</span>);</span><br><span class="line">    e.<span class="title function_">preventDefault</span>();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Like windows, workers can register a handler to be invoked when a Promise is rejected and there is no .catch() function to handle it. Within a worker you can detect this by defining a self.onunhandledrejection function or by using addEventListener() to register a global handler for â€œunhandledrejectionâ€ events. The event object passed to this handler will have a promise property whose value is the Promise object that rejected and a reason property whose value is what would have been passed to a .catch() function.</p>
<h3 id="15-13-5-postMessage-MessagePorts-and-MessageChannels"><a href="#15-13-5-postMessage-MessagePorts-and-MessageChannels" class="headerlink" title="15.13.5 postMessage(), MessagePorts, and MessageChannels"></a>15.13.5 postMessage(), MessagePorts, and MessageChannels</h3><p>The postMessage() method of the Worker object and the global postMesage() function defined inside a worker both work by invoking the postMessage() methods of a pair of MessagePort objects that are automatically created along with the worker. Client-side JavaScript canâ€™t directly access these automatically created MessagePort objects, but it can create new pairs of connected ports with the MessageChannel() constructor:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> channel = <span class="keyword">new</span> <span class="title class_">MessageChannel</span>;                <span class="comment">// Create a new channel.</span></span><br><span class="line"><span class="keyword">let</span> myPort = channel.<span class="property">port1</span>;                      <span class="comment">// It has two ports</span></span><br><span class="line"><span class="keyword">let</span> yourPort = channel.<span class="property">port2</span>;                    <span class="comment">// connected to each other.</span></span><br><span class="line"></span><br><span class="line">myPort.<span class="title function_">postMessage</span>(<span class="string">&quot;Can you hear me?&quot;</span>);          <span class="comment">// A message posted to one will</span></span><br><span class="line">yourPort.<span class="property">onmessage</span> = <span class="function">(<span class="params">e</span>) =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(e.<span class="property">data</span>); <span class="comment">// be received on the other.</span></span><br></pre></td></tr></table></figure>
<p>A MessageChannel is an object with port1 and port2 properties that refer to a pair of connected MessagePort objects. A MessagePort is an object with a postMessage() method and an onmessage event handler property. When postMessage() is called on one port of a connected pair, a â€œmessageâ€ event is fired on the other port in the pair. You can receive these â€œmessageâ€ events by setting the onmessage property or by using addEventListener() to register a listener for â€œmessageâ€ events.</p>
<p>Messages sent to a port are queued until the onmessage property is defined or until the start() method is called on the port. This prevents messages sent by one end of the channel from being missed by the other end. If you use addEventListener() with a MessagePort, donâ€™t forget to call start() or you may never see a message delivered.</p>
<p>All the postMessage() calls weâ€™ve seen so far have taken a single message argument. But the method also accepts an optional second argument. This second argument is an array of items that are to be transferred to the other end of the channel instead of having a copy sent across the channel. Values that can be transferred instead of copied are MessagePorts and ArrayBuffers. (Some browsers also implement other transferable types, such as ImageBitmap and OffscreenCanvas. These are not universally supported, however, and are not covered in this book.) If the first argument to postMessage() includes a MessagePort (nested anywhere within the message object), then that MessagePort must also appear in the second argument. If you do this, then the MessagePort will become available to the other end of the channel and will immediately become nonfunctional on your end. Suppose you have created a worker and want to have two channels for communicating with it: one channel for ordinary data exchange and one channel for high-priority messages. In the main thread, you might create a MessageChannel, then call postMessage() on the worker to pass one of the MessagePorts to it:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> worker = <span class="keyword">new</span> <span class="title class_">Worker</span>(<span class="string">&quot;worker.js&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> urgentChannel = <span class="keyword">new</span> <span class="title class_">MessageChannel</span>();</span><br><span class="line"><span class="keyword">let</span> urgentPort = urgentChannel.<span class="property">port1</span>;</span><br><span class="line">worker.<span class="title function_">postMessage</span>(&#123; <span class="attr">command</span>: <span class="string">&quot;setUrgentPort&quot;</span>, <span class="attr">value</span>: urgentChannel.<span class="property">port2</span> &#125;,</span><br><span class="line">                   [ urgentChannel.<span class="property">port2</span> ]);</span><br><span class="line"><span class="comment">// Now we can receive urgent messages from the worker like this</span></span><br><span class="line">urgentPort.<span class="title function_">addEventListener</span>(<span class="string">&quot;message&quot;</span>, handleUrgentMessage);</span><br><span class="line">urgentPort.<span class="title function_">start</span>();  <span class="comment">// Start receiving messages</span></span><br><span class="line"><span class="comment">// And send urgent messages like this</span></span><br><span class="line">urgentPort.<span class="title function_">postMessage</span>(<span class="string">&quot;test&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>MessageChannels are also useful if you create two workers and want to allow them to communicate directly with each other rather than requiring code on the main thread to relay messages between them.</p>
<p>The other use of the second argument to postMessage() is to transfer ArrayBuffers between workers without having to copy them. This is an important performance enhancement for large ArrayBuffers like those used to hold image data. When an ArrayBuffer is transferred over a MessagePort, the ArrayBuffer becomes unusable in the original thread so that there is no possibility of concurrent access to its contents. If the first argument to postMessage() includes an ArrayBuffer, or any value (such as a typed array) that has an ArrayBuffer, then that buffer may appear as an array element in the second postMessage() argument. If it does appear, then it will be transferred without copying. If not, then the ArrayBuffer will be copied rather than transferred. Example 15-14 will demonstrate the use of this transfer technique with ArrayBuffers.</p>
<h3 id="15-13-6-Cross-Origin-Messaging-with-postMessage"><a href="#15-13-6-Cross-Origin-Messaging-with-postMessage" class="headerlink" title="15.13.6 Cross-Origin Messaging with postMessage()"></a>15.13.6 Cross-Origin Messaging with postMessage()</h3><p>There is another use case for the postMessage() method in client-side JavaScript. It involves windows instead of workers, but there are enough similarities between the two cases that we will describe the postMessage() method of the Window object here.</p>
<p>When a document contains an <code>&lt;iframe&gt;</code> element, that element acts as an embedded but independent window. The Element object that represents the <code>&lt;iframe&gt;</code> has a contentWindow property that is the Window object for the embedded document. And for scripts running within that nested iframe, the window.parent property refers to the containing Window object. When two windows display documents with the same origin, then scripts in each of those windows have access to the contents of the other window. But when the documents have different origins, the browserâ€™s same-origin policy prevents JavaScript in one window from accessing the content of another window.</p>
<p>For workers, postMessage() provides a safe way for two independent threads to communicate without sharing memory. For windows, postMessage() provides a controlled way for two independent origins to safely exchange messages. Even if the same-origin policy prevents your script from seeing the content of another window, you can still call postMessage() on that window, and doing so will cause a â€œmessageâ€ event to be triggered on that window, where it can be seen by the event handlers in that windowâ€™s scripts.</p>
<p>The postMessage() method of a Window is a little different than the postMessage() method of a Worker, however. The first argument is still an arbitrary message that will be copied by the structured clone algorithm. But the optional second argument listing objects to be transferred instead of copied becomes an optional third argument. The postMessage() method of a window takes a string as its required second argument. This second argument should be an origin (a protocol, hostname, and optional port) that specifies who you expect to be receiving the message. If you pass the string â€œ<a target="_blank" rel="noopener" href="https://good.example.comâ€/">https://good.example.comâ€</a> as the second argument, but the window you are posting the message to actually contains content from â€œ<a target="_blank" rel="noopener" href="https://malware.example.com,â€/">https://malware.example.com,â€</a> then the message you posted will not be delivered. If you are willing to send your message to content from any origin, then you can pass the wildcard â€œ*â€ as the second argument.</p>
<p>JavaScript code running inside a window or <code>&lt;iframe&gt;</code> can receive messages posted to that window or frame by defining the onmessage property of that window or by calling addEventListener() for â€œmessageâ€ events. As with workers, when you receive a â€œmessageâ€ event for a window, the data property of the event object is the message that was sent. In addition, however, â€œmessageâ€ events delivered to windows also define source and origin properties. The source property specifies the Window object that sent the event, and you can use event.source.postMessage() to send a reply. The origin property specifies the origin of the content in the source window. This is not something the sender of the message can forge, and when you receive a â€œmessageâ€ event, you will typically want to verify that it is from an origin you expect.</p>
<h2 id="15-14-Example-The-Mandelbrot-Set"><a href="#15-14-Example-The-Mandelbrot-Set" class="headerlink" title="15.14 Example: The Mandelbrot Set"></a>15.14 Example: The Mandelbrot Set</h2><p>This chapter on client-side JavaScript culminates with a long example that demonstrates using workers and messaging to parallelize computationally intensive tasks. But it is written to be an engaging, real-world web application and also demonstrates a number of the other APIs demonstrated in this chapter, including history management; use of the ImageData class with a <code>&lt;canvas&gt;</code>; and the use of keyboard, pointer, and resize events. It also demonstrates important core JavaScript features, including generators and a sophisticated use of Promises.</p>
<p>The example is a program for displaying and exploring the Mandelbrot set, a complex fractal that includes beautiful images like the one shown in Figure 15-16.</p>
<p><Figures figure="15-16">A portion of the Mandelbrot set</Figures></p>
<p>The Mandelbrot set is defined as the set of points on the complex plane, which, when put through a repeated process of complex multiplication and addition, produce a value whose magnitude remains bounded. The contours of the set are surprisingly complex, and computing which points are members of the set and which are not is computationally intensive: to produce a 500Ã—500 image of the Mandelbrot set, you must individually compute the membership of each of the 250,000 pixels in your image. And to verify that the value associated with each pixel remains bounded, you may have to repeat the process of complex multiplication 1,000 times or more. (More iterations give more sharply defined boundaries for the set; fewer iterations produce fuzzier boundaries.) With up to 250 million steps of complex arithmetic required to produce a high-quality image of the Mandelbrot set, you can understand why using workers is a valuable technique. Example 15-14 shows the worker code we will use. This file is relatively compact: it is just the raw computational muscle for the larger program. Two things are worth noting about it, however:</p>
<p>The worker creates an ImageData object to represent the rectangular grid of pixels for which it is computing Mandelbrot set membership. But instead of storing actual pixel values in the ImageData, it uses a custom-typed array to treat each pixel as a 32-bit integer. It stores the number of iterations required for each pixel in this array. If the magnitude of the complex number computed for each pixel becomes greater than four, then it is mathematically guaranteed to grow without bounds from then on, and we say it has â€œescaped.â€ So the value this worker returns for each pixel is the number of iterations before the value escaped. We tell the worker the maximum number of iterations it should try for each value, and pixels that reach this maximum number are considered to be in the set.</p>
<p>The worker transfers the ArrayBuffer associated with the ImageData back to the main thread so the memory associated with it does not need to be copied.</p>
<p>Example 15-14. Worker code for computing regions of the Mandelbrot set</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This is a simple worker that receives a message from its parent thread,</span></span><br><span class="line"><span class="comment">// performs the computation described by that message and then posts the</span></span><br><span class="line"><span class="comment">// result of that computation back to the parent thread.</span></span><br><span class="line">onmessage = <span class="keyword">function</span>(<span class="params">message</span>) &#123;</span><br><span class="line">    <span class="comment">// First, we unpack the message we received:</span></span><br><span class="line">    <span class="comment">//  - tile is an object with width and height properties. It specifies the</span></span><br><span class="line">    <span class="comment">//    size of the rectangle of pixels for which we will be computing</span></span><br><span class="line">    <span class="comment">//    Mandelbrot set membership.</span></span><br><span class="line">    <span class="comment">//  - (x0, y0) is the point in the complex plane that corresponds to the</span></span><br><span class="line">    <span class="comment">//    upper-left pixel in the tile.</span></span><br><span class="line">    <span class="comment">//  - perPixel is the pixel size in both the real and imaginary dimensions.</span></span><br><span class="line">    <span class="comment">//  - maxIterations specifies the maximum number of iterations we will</span></span><br><span class="line">    <span class="comment">//    perform before deciding that a pixel is in the set.</span></span><br><span class="line">    <span class="keyword">const</span> &#123;tile, x0, y0, perPixel, maxIterations&#125; = message.<span class="property">data</span>;</span><br><span class="line">    <span class="keyword">const</span> &#123;width, height&#125; = tile;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Next, we create an ImageData object to represent the rectangular array</span></span><br><span class="line">    <span class="comment">// of pixels, get its internal ArrayBuffer, and create a typed array view</span></span><br><span class="line">    <span class="comment">// of that buffer so we can treat each pixel as a single integer instead of</span></span><br><span class="line">    <span class="comment">// four individual bytes. We&#x27;ll store the number of iterations for each</span></span><br><span class="line">    <span class="comment">// pixel in this iterations array. (The iterations will be transformed into</span></span><br><span class="line">    <span class="comment">// actual pixel colors in the parent thread.)</span></span><br><span class="line">    <span class="keyword">const</span> imageData = <span class="keyword">new</span> <span class="title class_">ImageData</span>(width, height);</span><br><span class="line">    <span class="keyword">const</span> iterations = <span class="keyword">new</span> <span class="title class_">Uint32Array</span>(imageData.<span class="property">data</span>.<span class="property">buffer</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Now we begin the computation. There are three nested for loops here.</span></span><br><span class="line">    <span class="comment">// The outer two loop over the rows and columns of pixels, and the inner</span></span><br><span class="line">    <span class="comment">// loop iterates each pixel to see if it &quot;escapes&quot; or not. The various</span></span><br><span class="line">    <span class="comment">// loop variables are the following:</span></span><br><span class="line">    <span class="comment">// - row and column are integers representing the pixel coordinate.</span></span><br><span class="line">    <span class="comment">// - x and y represent the complex point for each pixel: x + yi.</span></span><br><span class="line">    <span class="comment">// - index is the index in the iterations array for the current pixel.</span></span><br><span class="line">    <span class="comment">// - n tracks the number of iterations for each pixel.</span></span><br><span class="line">    <span class="comment">// - max and min track the largest and smallest number of iterations</span></span><br><span class="line">    <span class="comment">//   we&#x27;ve seen so far for any pixel in the rectangle.</span></span><br><span class="line">    <span class="keyword">let</span> index = <span class="number">0</span>, max = <span class="number">0</span>, min=maxIterations;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> row = <span class="number">0</span>, y = y0; row &lt; height; row++, y += perPixel) &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> column = <span class="number">0</span>, x = x0; column &lt; width; column++, x += perPixel) &#123;</span><br><span class="line">            <span class="comment">// For each pixel we start with the complex number c = x+yi.</span></span><br><span class="line">            <span class="comment">// Then we repeatedly compute the complex number z(n+1) based on</span></span><br><span class="line">            <span class="comment">// this recursive formula:</span></span><br><span class="line">            <span class="comment">//    z(0) = c</span></span><br><span class="line">            <span class="comment">//    z(n+1) = z(n)^2 + c</span></span><br><span class="line">            <span class="comment">// If |z(n)| (the magnitude of z(n)) is &gt; 2, then the</span></span><br><span class="line">            <span class="comment">// pixel is not part of the set and we stop after n iterations.</span></span><br><span class="line">            <span class="keyword">let</span> n;             <span class="comment">// The number of iterations so far</span></span><br><span class="line">            <span class="keyword">let</span> r = x, i = y;  <span class="comment">// Start with z(0) set to c</span></span><br><span class="line">            <span class="keyword">for</span>(n = <span class="number">0</span>; n &lt; maxIterations; n++) &#123;</span><br><span class="line">                <span class="keyword">let</span> rr = r*r, ii = i*i; <span class="comment">// Square the two parts of z(n).</span></span><br><span class="line">                <span class="keyword">if</span> (rr + ii &gt; <span class="number">4</span>) &#123;      <span class="comment">// If |z(n)|^2 is &gt; 4 then</span></span><br><span class="line">                    <span class="keyword">break</span>;              <span class="comment">// we&#x27;ve escaped and can stop iterating.</span></span><br><span class="line">                &#125;</span><br><span class="line">                i = <span class="number">2</span>*r*i + y;          <span class="comment">// Compute imaginary part of z(n+1).</span></span><br><span class="line">                r = rr - ii + x;        <span class="comment">// And the real part of z(n+1).</span></span><br><span class="line">            &#125;</span><br><span class="line">            iterations[index++] = n;    <span class="comment">// Remember # iterations for each pixel.</span></span><br><span class="line">            <span class="keyword">if</span> (n &gt; max) max = n;       <span class="comment">// Track the maximum number we&#x27;ve seen.</span></span><br><span class="line">            <span class="keyword">if</span> (n &lt; min) min = n;       <span class="comment">// And the minimum as well.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// When the computation is complete, send the results back to the parent</span></span><br><span class="line">    <span class="comment">// thread. The imageData object will be copied, but the giant ArrayBuffer</span></span><br><span class="line">    <span class="comment">// it contains will be transferred for a nice performance boost.</span></span><br><span class="line">    <span class="title function_">postMessage</span>(&#123;tile, imageData, min, max&#125;, [imageData.<span class="property">data</span>.<span class="property">buffer</span>]);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>The Mandelbrot set viewer application that uses that worker code is shown in Example 15-15. Now that you have nearly reached the end of this chapter, this long example is something of a capstone experience that brings together a number of important core and client-side JavaScript features and APIs. The code is thoroughly commented, and I encourage you to read it carefully.</p>
<p>Example 15-15. A web application for displaying and exploring the Mandelbrot set</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This class represents a subrectangle of a canvas or image. We use Tiles to</span></span><br><span class="line"><span class="comment"> * divide a canvas into regions that can be processed independently by Workers.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Tile</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">x, y, width, height</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">x</span> = x;                     <span class="comment">// The properties of a Tile object</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">y</span> = y;                     <span class="comment">// represent the position and size</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">width</span> = width;             <span class="comment">// of the tile within a larger</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">height</span> = height;           <span class="comment">// rectangle.</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This static method is a generator that divides a rectangle of the</span></span><br><span class="line">    <span class="comment">// specified width and height into the specified number of rows and</span></span><br><span class="line">    <span class="comment">// columns and yields numRows*numCols Tile objects to cover the rectangle.</span></span><br><span class="line">    <span class="keyword">static</span> *<span class="title function_">tiles</span>(<span class="params">width, height, numRows, numCols</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> columnWidth = <span class="title class_">Math</span>.<span class="title function_">ceil</span>(width / numCols);</span><br><span class="line">        <span class="keyword">let</span> rowHeight = <span class="title class_">Math</span>.<span class="title function_">ceil</span>(height / numRows);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> row = <span class="number">0</span>; row &lt; numRows; row++) &#123;</span><br><span class="line">            <span class="keyword">let</span> tileHeight = (row &lt; numRows-<span class="number">1</span>)</span><br><span class="line">                ? rowHeight                          <span class="comment">// height of most rows</span></span><br><span class="line">                : height - rowHeight * (numRows-<span class="number">1</span>);  <span class="comment">// height of last row</span></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">let</span> col = <span class="number">0</span>; col &lt; numCols; col++) &#123;</span><br><span class="line">                <span class="keyword">let</span> tileWidth = (col &lt; numCols-<span class="number">1</span>)</span><br><span class="line">                    ? columnWidth                    <span class="comment">// width of most columns</span></span><br><span class="line">                    : width - columnWidth * (numCols-<span class="number">1</span>); <span class="comment">// and last column</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">yield</span> <span class="keyword">new</span> <span class="title class_">Tile</span>(col * columnWidth, row * rowHeight,</span><br><span class="line">                               tileWidth, tileHeight);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This class represents a pool of workers, all running the same code. The</span></span><br><span class="line"><span class="comment"> * worker code you specify must respond to each message it receives by</span></span><br><span class="line"><span class="comment"> * performing some kind of computation and then posting a single message with</span></span><br><span class="line"><span class="comment"> * the result of that computation.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Given a WorkerPool and message that represents work to be performed, simply</span></span><br><span class="line"><span class="comment"> * call addWork(), with the message as an argument. If there is a Worker</span></span><br><span class="line"><span class="comment"> * object that is currently idle, the message will be posted to that worker</span></span><br><span class="line"><span class="comment"> * immediately. If there are no idle Worker objects, the message will be</span></span><br><span class="line"><span class="comment"> * queued and will be posted to a Worker when one becomes available.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * addWork() returns a Promise, which will resolve with the message recieved</span></span><br><span class="line"><span class="comment"> * from the work, or will reject if the worker throws an unhandled error.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WorkerPool</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">numWorkers, workerSource</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">idleWorkers</span> = [];       <span class="comment">// Workers that are not currently working</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">workQueue</span> = [];         <span class="comment">// Work not currently being processed</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">workerMap</span> = <span class="keyword">new</span> <span class="title class_">Map</span>();  <span class="comment">// Map workers to resolve and reject funcs</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Create the specified number of workers, add message and error</span></span><br><span class="line">        <span class="comment">// handlers and save them in the idleWorkers array.</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; numWorkers; i++) &#123;</span><br><span class="line">            <span class="keyword">let</span> worker = <span class="keyword">new</span> <span class="title class_">Worker</span>(workerSource);</span><br><span class="line">            worker.<span class="property">onmessage</span> = <span class="function"><span class="params">message</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">_workerDone</span>(worker, <span class="literal">null</span>, message.<span class="property">data</span>);</span><br><span class="line">            &#125;;</span><br><span class="line">            worker.<span class="property">onerror</span> = <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">_workerDone</span>(worker, error, <span class="literal">null</span>);</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">idleWorkers</span>[i] = worker;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This internal method is called when a worker finishes working, either</span></span><br><span class="line">    <span class="comment">// by sending a message or by throwing an error.</span></span><br><span class="line">    <span class="title function_">_workerDone</span>(<span class="params">worker, error, response</span>) &#123;</span><br><span class="line">        <span class="comment">// Look up the resolve() and reject() functions for this worker</span></span><br><span class="line">        <span class="comment">// and then remove the worker&#x27;s entry from the map.</span></span><br><span class="line">        <span class="keyword">let</span> [resolver, rejector] = <span class="variable language_">this</span>.<span class="property">workerMap</span>.<span class="title function_">get</span>(worker);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">workerMap</span>.<span class="title function_">delete</span>(worker);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If there is no queued work, put this worker back in</span></span><br><span class="line">        <span class="comment">// the list of idle workers. Otherwise, take work from the queue</span></span><br><span class="line">        <span class="comment">// and send it to this worker.</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">workQueue</span>.<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">idleWorkers</span>.<span class="title function_">push</span>(worker);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> [work, resolver, rejector] = <span class="variable language_">this</span>.<span class="property">workQueue</span>.<span class="title function_">shift</span>();</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">workerMap</span>.<span class="title function_">set</span>(worker, [resolver, rejector]);</span><br><span class="line">            worker.<span class="title function_">postMessage</span>(work);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Finally, resolve or reject the promise associated with the worker.</span></span><br><span class="line">        error === <span class="literal">null</span> ? <span class="title function_">resolver</span>(response) : <span class="title function_">rejector</span>(error);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This method adds work to the worker pool and returns a Promise that</span></span><br><span class="line">    <span class="comment">// will resolve with a worker&#x27;s response when the work is done. The work</span></span><br><span class="line">    <span class="comment">// is a value to be passed to a worker with postMessage(). If there is an</span></span><br><span class="line">    <span class="comment">// idle worker, the work message will be sent immediately. Otherwise it</span></span><br><span class="line">    <span class="comment">// will be queued until a worker is available.</span></span><br><span class="line">    <span class="title function_">addWork</span>(<span class="params">work</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">idleWorkers</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">let</span> worker = <span class="variable language_">this</span>.<span class="property">idleWorkers</span>.<span class="title function_">pop</span>();</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">workerMap</span>.<span class="title function_">set</span>(worker, [resolve, reject]);</span><br><span class="line">                worker.<span class="title function_">postMessage</span>(work);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">workQueue</span>.<span class="title function_">push</span>([work, resolve, reject]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This class holds the state information necessary to render a Mandelbrot set.</span></span><br><span class="line"><span class="comment"> * The cx and cy properties give the point in the complex plane that is the</span></span><br><span class="line"><span class="comment"> * center of the image. The perPixel property specifies how much the real and</span></span><br><span class="line"><span class="comment"> * imaginary parts of that complex number changes for each pixel of the image.</span></span><br><span class="line"><span class="comment"> * The maxIterations property specifies how hard we work to compute the set.</span></span><br><span class="line"><span class="comment"> * Larger numbers require more computation but produce crisper images.</span></span><br><span class="line"><span class="comment"> * Note that the size of the canvas is not part of the state. Given cx, cy, and</span></span><br><span class="line"><span class="comment"> * perPixel we simply render whatever portion of the Mandelbrot set fits in</span></span><br><span class="line"><span class="comment"> * the canvas at its current size.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Objects of this type are used with history.pushState() and are used to read</span></span><br><span class="line"><span class="comment"> * the desired state from a bookmarked or shared URL.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PageState</span> &#123;</span><br><span class="line">    <span class="comment">// This factory method returns an initial state to display the entire set.</span></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">initialState</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> s = <span class="keyword">new</span> <span class="title class_">PageState</span>();</span><br><span class="line">        s.<span class="property">cx</span> = -<span class="number">0.5</span>;</span><br><span class="line">        s.<span class="property">cy</span> = <span class="number">0</span>;</span><br><span class="line">        s.<span class="property">perPixel</span> = <span class="number">3</span>/<span class="variable language_">window</span>.<span class="property">innerHeight</span>;</span><br><span class="line">        s.<span class="property">maxIterations</span> = <span class="number">500</span>;</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This factory method obtains state from a URL, or returns null if</span></span><br><span class="line">    <span class="comment">// a valid state could not be read from the URL.</span></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">fromURL</span>(<span class="params">url</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> s = <span class="keyword">new</span> <span class="title class_">PageState</span>();</span><br><span class="line">        <span class="keyword">let</span> u = <span class="keyword">new</span> <span class="title function_">URL</span>(url); <span class="comment">// Initialize state from the url&#x27;s search params.</span></span><br><span class="line">        s.<span class="property">cx</span> = <span class="built_in">parseFloat</span>(u.<span class="property">searchParams</span>.<span class="title function_">get</span>(<span class="string">&quot;cx&quot;</span>));</span><br><span class="line">        s.<span class="property">cy</span> = <span class="built_in">parseFloat</span>(u.<span class="property">searchParams</span>.<span class="title function_">get</span>(<span class="string">&quot;cy&quot;</span>));</span><br><span class="line">        s.<span class="property">perPixel</span> = <span class="built_in">parseFloat</span>(u.<span class="property">searchParams</span>.<span class="title function_">get</span>(<span class="string">&quot;pp&quot;</span>));</span><br><span class="line">        s.<span class="property">maxIterations</span> = <span class="built_in">parseInt</span>(u.<span class="property">searchParams</span>.<span class="title function_">get</span>(<span class="string">&quot;it&quot;</span>));</span><br><span class="line">        <span class="comment">// If we got valid values, return the PageState object, otherwise null.</span></span><br><span class="line">        <span class="keyword">return</span> (<span class="built_in">isNaN</span>(s.<span class="property">cx</span>) || <span class="built_in">isNaN</span>(s.<span class="property">cy</span>) || <span class="built_in">isNaN</span>(s.<span class="property">perPixel</span>)</span><br><span class="line">                || <span class="built_in">isNaN</span>(s.<span class="property">maxIterations</span>))</span><br><span class="line">            ? <span class="literal">null</span></span><br><span class="line">            : s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This instance method encodes the current state into the search</span></span><br><span class="line">    <span class="comment">// parameters of the browser&#x27;s current location.</span></span><br><span class="line">    <span class="title function_">toURL</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> u = <span class="keyword">new</span> <span class="title function_">URL</span>(<span class="variable language_">window</span>.<span class="property">location</span>);</span><br><span class="line">        u.<span class="property">searchParams</span>.<span class="title function_">set</span>(<span class="string">&quot;cx&quot;</span>, <span class="variable language_">this</span>.<span class="property">cx</span>);</span><br><span class="line">        u.<span class="property">searchParams</span>.<span class="title function_">set</span>(<span class="string">&quot;cy&quot;</span>, <span class="variable language_">this</span>.<span class="property">cy</span>);</span><br><span class="line">        u.<span class="property">searchParams</span>.<span class="title function_">set</span>(<span class="string">&quot;pp&quot;</span>, <span class="variable language_">this</span>.<span class="property">perPixel</span>);</span><br><span class="line">        u.<span class="property">searchParams</span>.<span class="title function_">set</span>(<span class="string">&quot;it&quot;</span>, <span class="variable language_">this</span>.<span class="property">maxIterations</span>);</span><br><span class="line">        <span class="keyword">return</span> u.<span class="property">href</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// These constants control the parallelism of the Mandelbrot set computation.</span></span><br><span class="line"><span class="comment">// You may need to adjust them to get optimum performance on your computer.</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">ROWS</span> = <span class="number">3</span>, <span class="variable constant_">COLS</span> = <span class="number">4</span>, <span class="variable constant_">NUMWORKERS</span> = navigator.<span class="property">hardwareConcurrency</span> || <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This is the main class of our Mandelbrot set program. Simply invoke the</span></span><br><span class="line"><span class="comment">// constructor function with the &lt;canvas&gt; element to render into. The program</span></span><br><span class="line"><span class="comment">// assumes that this &lt;canvas&gt; element is styled so that it is always as big</span></span><br><span class="line"><span class="comment">// as the browser window.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MandelbrotCanvas</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">canvas</span>) &#123;</span><br><span class="line">        <span class="comment">// Store the canvas, get its context object, and initialize a WorkerPool</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">canvas</span> = canvas;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">context</span> = canvas.<span class="title function_">getContext</span>(<span class="string">&quot;2d&quot;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">workerPool</span> = <span class="keyword">new</span> <span class="title class_">WorkerPool</span>(<span class="variable constant_">NUMWORKERS</span>, <span class="string">&quot;mandelbrotWorker.js&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Define some properties that we&#x27;ll use later</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">tiles</span> = <span class="literal">null</span>;          <span class="comment">// Subregions of the canvas</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">pendingRender</span> = <span class="literal">null</span>;  <span class="comment">// We&#x27;re not currently rendering</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">wantsRerender</span> = <span class="literal">false</span>; <span class="comment">// No render is currently requested</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">resizeTimer</span> = <span class="literal">null</span>;    <span class="comment">// Prevents us from resizing too frequently</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">colorTable</span> = <span class="literal">null</span>;     <span class="comment">// For converting raw data to pixel values.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set up our event handlers</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;pointerdown&quot;</span>, <span class="function"><span class="params">e</span> =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">handlePointer</span>(e));</span><br><span class="line">        <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;keydown&quot;</span>, <span class="function"><span class="params">e</span> =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">handleKey</span>(e));</span><br><span class="line">        <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;resize&quot;</span>, <span class="function"><span class="params">e</span> =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">handleResize</span>(e));</span><br><span class="line">        <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;popstate&quot;</span>, <span class="function"><span class="params">e</span> =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">setState</span>(e.<span class="property">state</span>, <span class="literal">false</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Initialize our state from the URL or start with the initial state.</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">state</span> =</span><br><span class="line">            <span class="title class_">PageState</span>.<span class="title function_">fromURL</span>(<span class="variable language_">window</span>.<span class="property">location</span>) || <span class="title class_">PageState</span>.<span class="title function_">initialState</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Save this state with the history mechanism.</span></span><br><span class="line">        history.<span class="title function_">replaceState</span>(<span class="variable language_">this</span>.<span class="property">state</span>, <span class="string">&quot;&quot;</span>, <span class="variable language_">this</span>.<span class="property">state</span>.<span class="title function_">toURL</span>());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set the canvas size and get an array of tiles that cover it.</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setSize</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// And render the Mandelbrot set into the canvas.</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">render</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set the canvas size and initialize an array of Tile objects. This</span></span><br><span class="line">    <span class="comment">// method is called from the constructor and also by the handleResize()</span></span><br><span class="line">    <span class="comment">// method when the browser window is resized.</span></span><br><span class="line">    <span class="title function_">setSize</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">width</span> = <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">width</span> = <span class="variable language_">window</span>.<span class="property">innerWidth</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">height</span> = <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">height</span> = <span class="variable language_">window</span>.<span class="property">innerHeight</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">tiles</span> = [...<span class="title class_">Tile</span>.<span class="title function_">tiles</span>(<span class="variable language_">this</span>.<span class="property">width</span>, <span class="variable language_">this</span>.<span class="property">height</span>, <span class="variable constant_">ROWS</span>, <span class="variable constant_">COLS</span>)];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This function makes a change to the PageState, then re-renders the</span></span><br><span class="line">    <span class="comment">// Mandelbrot set using that new state, and also saves the new state with</span></span><br><span class="line">    <span class="comment">// history.pushState(). If the first argument is a function that function</span></span><br><span class="line">    <span class="comment">// will be called with the state object as its argument and should make</span></span><br><span class="line">    <span class="comment">// changes to the state. If the first argument is an object, then we simply</span></span><br><span class="line">    <span class="comment">// copy the properties of that object into the state object. If the optional</span></span><br><span class="line">    <span class="comment">// second argument is false, then the new state will not be saved. (We</span></span><br><span class="line">    <span class="comment">// do this when calling setState in response to a popstate event.)</span></span><br><span class="line">    <span class="title function_">setState</span>(<span class="params">f, save=<span class="literal">true</span></span>) &#123;</span><br><span class="line">        <span class="comment">// If the argument is a function, call it to update the state.</span></span><br><span class="line">        <span class="comment">// Otherwise, copy its properties into the current state.</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> f === <span class="string">&quot;function&quot;</span>) &#123;</span><br><span class="line">            <span class="title function_">f</span>(<span class="variable language_">this</span>.<span class="property">state</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">let</span> property <span class="keyword">in</span> f) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">state</span>[property] = f[property];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// In either case, start rendering the new state ASAP.</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">render</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Normally we save the new state. Except when we&#x27;re called with</span></span><br><span class="line">        <span class="comment">// a second argument of false which we do when we get a popstate event.</span></span><br><span class="line">        <span class="keyword">if</span> (save) &#123;</span><br><span class="line">            history.<span class="title function_">pushState</span>(<span class="variable language_">this</span>.<span class="property">state</span>, <span class="string">&quot;&quot;</span>, <span class="variable language_">this</span>.<span class="property">state</span>.<span class="title function_">toURL</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This method asynchronously draws the portion of the Mandelbrot set</span></span><br><span class="line">    <span class="comment">// specified by the PageState object into the canvas. It is called by</span></span><br><span class="line">    <span class="comment">// the constructor, by setState() when the state changes, and by the</span></span><br><span class="line">    <span class="comment">// resize event handler when the size of the canvas changes.</span></span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// Sometimes the user may use the keyboard or mouse to request renders</span></span><br><span class="line">        <span class="comment">// more quickly than we can perform them. We don&#x27;t want to submit all</span></span><br><span class="line">        <span class="comment">// the renders to the worker pool. Instead if we&#x27;re rendering, we&#x27;ll</span></span><br><span class="line">        <span class="comment">// just make a note that a new render is needed, and when the current</span></span><br><span class="line">        <span class="comment">// render completes, we&#x27;ll render the current state, possibly skipping</span></span><br><span class="line">        <span class="comment">// multiple intermediate states.</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">pendingRender</span>) &#123;        <span class="comment">// If we&#x27;re already rendering,</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">wantsRerender</span> = <span class="literal">true</span>;   <span class="comment">// make a note to rerender later</span></span><br><span class="line">            <span class="keyword">return</span>;                      <span class="comment">// and don&#x27;t do anything more now.</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Get our state variables and compute the complex number for the</span></span><br><span class="line">        <span class="comment">// upper left corner of the canvas.</span></span><br><span class="line">        <span class="keyword">let</span> &#123;cx, cy, perPixel, maxIterations&#125; = <span class="variable language_">this</span>.<span class="property">state</span>;</span><br><span class="line">        <span class="keyword">let</span> x0 = cx - perPixel * <span class="variable language_">this</span>.<span class="property">width</span>/<span class="number">2</span>;</span><br><span class="line">        <span class="keyword">let</span> y0 = cy - perPixel * <span class="variable language_">this</span>.<span class="property">height</span>/<span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// For each of our ROWS*COLS tiles, call addWork() with a message</span></span><br><span class="line">        <span class="comment">// for the code in mandelbrotWorker.js. Collect the resulting Promise</span></span><br><span class="line">        <span class="comment">// objects into an array.</span></span><br><span class="line">        <span class="keyword">let</span> promises = <span class="variable language_">this</span>.<span class="property">tiles</span>.<span class="title function_">map</span>(<span class="function"><span class="params">tile</span> =&gt;</span> <span class="variable language_">this</span>.<span class="property">workerPool</span>.<span class="title function_">addWork</span>(&#123;</span><br><span class="line">            <span class="attr">tile</span>: tile,</span><br><span class="line">            <span class="attr">x0</span>: x0 + tile.<span class="property">x</span> * perPixel,</span><br><span class="line">            <span class="attr">y0</span>: y0 + tile.<span class="property">y</span> * perPixel,</span><br><span class="line">            <span class="attr">perPixel</span>: perPixel,</span><br><span class="line">            <span class="attr">maxIterations</span>: maxIterations</span><br><span class="line">        &#125;));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Use Promise.all() to get an array of responses from the array of</span></span><br><span class="line">        <span class="comment">// promises. Each response is the computation for one of our tiles.</span></span><br><span class="line">        <span class="comment">// Recall from mandelbrotWorker.js that each response includes the</span></span><br><span class="line">        <span class="comment">// Tile object, an ImageData object that includes iteration counts</span></span><br><span class="line">        <span class="comment">// instead of pixel values, and the minimum and maximum iterations</span></span><br><span class="line">        <span class="comment">// for that tile.</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">pendingRender</span> = <span class="title class_">Promise</span>.<span class="title function_">all</span>(promises).<span class="title function_">then</span>(<span class="function"><span class="params">responses</span> =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// First, find the overall max and min iterations over all tiles.</span></span><br><span class="line">            <span class="comment">// We need these numbers so we can assign colors to the pixels.</span></span><br><span class="line">            <span class="keyword">let</span> min = maxIterations, max = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">let</span> r <span class="keyword">of</span> responses) &#123;</span><br><span class="line">                <span class="keyword">if</span> (r.<span class="property">min</span> &lt; min) min = r.<span class="property">min</span>;</span><br><span class="line">                <span class="keyword">if</span> (r.<span class="property">max</span> &gt; max) max = r.<span class="property">max</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Now we need a way to convert the raw iteration counts from the</span></span><br><span class="line">            <span class="comment">// workers into pixel colors that will be displayed in the canvas.</span></span><br><span class="line">            <span class="comment">// We know that all the pixels have between min and max iterations</span></span><br><span class="line">            <span class="comment">// so we precompute the colors for each iteration count and store</span></span><br><span class="line">            <span class="comment">// them in the colorTable array.</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// If we haven&#x27;t allocated a color table yet, or if it is no longer</span></span><br><span class="line">            <span class="comment">// the right size, then allocate a new one.</span></span><br><span class="line">            <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">colorTable</span> || <span class="variable language_">this</span>.<span class="property">colorTable</span>.<span class="property">length</span> !== maxIterations+<span class="number">1</span>)&#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">colorTable</span> = <span class="keyword">new</span> <span class="title class_">Uint32Array</span>(maxIterations+<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Given the max and the min, compute appropriate values in the</span></span><br><span class="line">            <span class="comment">// color table. Pixels in the set will be colored fully opaque</span></span><br><span class="line">            <span class="comment">// black. Pixels outside the set will be translucent black with higher</span></span><br><span class="line">            <span class="comment">// iteration counts resulting in higher opacity. Pixels with</span></span><br><span class="line">            <span class="comment">// minimum iteration counts will be transparent and the white</span></span><br><span class="line">            <span class="comment">// background will show through, resulting in a grayscale image.</span></span><br><span class="line">            <span class="keyword">if</span> (min === max) &#123;                <span class="comment">// If all the pixels are the same,</span></span><br><span class="line">                <span class="keyword">if</span> (min === maxIterations) &#123;  <span class="comment">// Then make them all black</span></span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">colorTable</span>[min] = <span class="number">0xFF000000</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;                      <span class="comment">// Or all transparent.</span></span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">colorTable</span>[min] = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// In the normal case where min and max are different, use a</span></span><br><span class="line">                <span class="comment">// logarithic scale to assign each possible iteration count an</span></span><br><span class="line">                <span class="comment">// opacity between 0 and 255, and then use the shift left</span></span><br><span class="line">                <span class="comment">// operator to turn that into a pixel value.</span></span><br><span class="line">                <span class="keyword">let</span> maxlog = <span class="title class_">Math</span>.<span class="title function_">log</span>(<span class="number">1</span>+max-min);</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">let</span> i = min; i &lt;= max; i++) &#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">colorTable</span>[i] =</span><br><span class="line">                        (<span class="title class_">Math</span>.<span class="title function_">ceil</span>(<span class="title class_">Math</span>.<span class="title function_">log</span>(<span class="number">1</span>+i-min)/maxlog * <span class="number">255</span>) &lt;&lt; <span class="number">24</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Now translate the iteration numbers in each response&#x27;s</span></span><br><span class="line">            <span class="comment">// ImageData to colors from the colorTable.</span></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">let</span> r <span class="keyword">of</span> responses) &#123;</span><br><span class="line">                <span class="keyword">let</span> iterations = <span class="keyword">new</span> <span class="title class_">Uint32Array</span>(r.<span class="property">imageData</span>.<span class="property">data</span>.<span class="property">buffer</span>);</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; iterations.<span class="property">length</span>; i++) &#123;</span><br><span class="line">                    iterations[i] = <span class="variable language_">this</span>.<span class="property">colorTable</span>[iterations[i]];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Finally, render all the imageData objects into their</span></span><br><span class="line">            <span class="comment">// corresponding tiles of the canvas using putImageData().</span></span><br><span class="line">            <span class="comment">// (First, though, remove any CSS transforms on the canvas that may</span></span><br><span class="line">            <span class="comment">// have been set by the pointerdown event handler.)</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">style</span>.<span class="property">transform</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">let</span> r <span class="keyword">of</span> responses) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">context</span>.<span class="title function_">putImageData</span>(r.<span class="property">imageData</span>, r.<span class="property">tile</span>.<span class="property">x</span>, r.<span class="property">tile</span>.<span class="property">y</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        .<span class="title function_">catch</span>(<span class="function">(<span class="params">reason</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// If anything went wrong in any of our Promises, we&#x27;ll log</span></span><br><span class="line">            <span class="comment">// an error here. This shouldn&#x27;t happen, but this will help with</span></span><br><span class="line">            <span class="comment">// debugging if it does.</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;Promise rejected in render():&quot;</span>, reason);</span><br><span class="line">        &#125;)</span><br><span class="line">        .<span class="title function_">finally</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// When we are done rendering, clear the pendingRender flags</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">pendingRender</span> = <span class="literal">null</span>;</span><br><span class="line">            <span class="comment">// And if render requests came in while we were busy, rerender now.</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">wantsRerender</span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">wantsRerender</span> = <span class="literal">false</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">render</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the user resizes the window, this function will be called repeatedly.</span></span><br><span class="line">    <span class="comment">// Resizing a canvas and rerendering the Mandlebrot set is an expensive</span></span><br><span class="line">    <span class="comment">// operation that we can&#x27;t do multiple times a second, so we use a timer</span></span><br><span class="line">    <span class="comment">// to defer handling the resize until 200ms have elapsed since the last</span></span><br><span class="line">    <span class="comment">// resize event was received.</span></span><br><span class="line">    <span class="title function_">handleResize</span>(<span class="params">event</span>) &#123;</span><br><span class="line">        <span class="comment">// If we were already deferring a resize, clear it.</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">resizeTimer</span>) <span class="built_in">clearTimeout</span>(<span class="variable language_">this</span>.<span class="property">resizeTimer</span>);</span><br><span class="line">        <span class="comment">// And defer this resize instead.</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">resizeTimer</span> = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">resizeTimer</span> = <span class="literal">null</span>;  <span class="comment">// Note that resize has been handled</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">setSize</span>();           <span class="comment">// Resize canvas and tiles</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">render</span>();            <span class="comment">// Rerender at the new size</span></span><br><span class="line">        &#125;, <span class="number">200</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the user presses a key, this event handler will be called.</span></span><br><span class="line">    <span class="comment">// We call setState() in response to various keys, and setState() renders</span></span><br><span class="line">    <span class="comment">// the new state, updates the URL, and saves the state in browser history.</span></span><br><span class="line">    <span class="title function_">handleKey</span>(<span class="params">event</span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span>(event.<span class="property">key</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;Escape&quot;</span>:     <span class="comment">// Type Escape to go back to the initial state</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">setState</span>(<span class="title class_">PageState</span>.<span class="title function_">initialState</span>());</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;+&quot;</span>:          <span class="comment">// Type + to increase the number of iterations</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">setState</span>(<span class="function"><span class="params">s</span> =&gt;</span> &#123;</span><br><span class="line">                s.<span class="property">maxIterations</span> = <span class="title class_">Math</span>.<span class="title function_">round</span>(s.<span class="property">maxIterations</span>*<span class="number">1.5</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;-&quot;</span>:          <span class="comment">// Type - to decrease the number of iterations</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">setState</span>(<span class="function"><span class="params">s</span> =&gt;</span> &#123;</span><br><span class="line">                s.<span class="property">maxIterations</span> = <span class="title class_">Math</span>.<span class="title function_">round</span>(s.<span class="property">maxIterations</span>/<span class="number">1.5</span>);</span><br><span class="line">                <span class="keyword">if</span> (s.<span class="property">maxIterations</span> &lt; <span class="number">1</span>) s.<span class="property">maxIterations</span> = <span class="number">1</span>;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;o&quot;</span>:          <span class="comment">// Type o to zoom out</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">setState</span>(<span class="function"><span class="params">s</span> =&gt;</span> s.<span class="property">perPixel</span> *= <span class="number">2</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;ArrowUp&quot;</span>:    <span class="comment">// Up arrow to scroll up</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">setState</span>(<span class="function"><span class="params">s</span> =&gt;</span> s.<span class="property">cy</span> -= <span class="variable language_">this</span>.<span class="property">height</span>/<span class="number">10</span> * s.<span class="property">perPixel</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;ArrowDown&quot;</span>:  <span class="comment">// Down arrow to scroll down</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">setState</span>(<span class="function"><span class="params">s</span> =&gt;</span> s.<span class="property">cy</span> += <span class="variable language_">this</span>.<span class="property">height</span>/<span class="number">10</span> * s.<span class="property">perPixel</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;ArrowLeft&quot;</span>:  <span class="comment">// Left arrow to scroll left</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">setState</span>(<span class="function"><span class="params">s</span> =&gt;</span> s.<span class="property">cx</span> -= <span class="variable language_">this</span>.<span class="property">width</span>/<span class="number">10</span> * s.<span class="property">perPixel</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;ArrowRight&quot;</span>: <span class="comment">// Right arrow to scroll right</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">setState</span>(<span class="function"><span class="params">s</span> =&gt;</span> s.<span class="property">cx</span> += <span class="variable language_">this</span>.<span class="property">width</span>/<span class="number">10</span> * s.<span class="property">perPixel</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This method is called when we get a pointerdown event on the canvas.</span></span><br><span class="line">    <span class="comment">// The pointerdown event might be the start of a zoom gesture (a click or</span></span><br><span class="line">    <span class="comment">// tap) or a pan gesture (a drag). This handler registers handlers for</span></span><br><span class="line">    <span class="comment">// the pointermove and pointerup events in order to respond to the rest</span></span><br><span class="line">    <span class="comment">// of the gesture. (These two extra handlers are removed when the gesture</span></span><br><span class="line">    <span class="comment">// ends with a pointerup.)</span></span><br><span class="line">    <span class="title function_">handlePointer</span>(<span class="params">event</span>) &#123;</span><br><span class="line">        <span class="comment">// The pixel coordinates and time of the initial pointer down.</span></span><br><span class="line">        <span class="comment">// Because the canvas is as big as the window, these event coordinates</span></span><br><span class="line">        <span class="comment">// are also canvas coordinates.</span></span><br><span class="line">        <span class="keyword">const</span> x0 = event.<span class="property">clientX</span>, y0 = event.<span class="property">clientY</span>, t0 = <span class="title class_">Date</span>.<span class="title function_">now</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// This is the handler for move events.</span></span><br><span class="line">        <span class="keyword">const</span> <span class="title function_">pointerMoveHandler</span> = event =&gt; &#123;</span><br><span class="line">            <span class="comment">// How much have we moved, and how much time has passed?</span></span><br><span class="line">            <span class="keyword">let</span> dx=event.<span class="property">clientX</span>-x0, dy=event.<span class="property">clientY</span>-y0, dt=<span class="title class_">Date</span>.<span class="title function_">now</span>()-t0;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If the pointer has moved enough or enough time has passed that</span></span><br><span class="line">            <span class="comment">// this is not a regular click, then use CSS to pan the display.</span></span><br><span class="line">            <span class="comment">// (We will rerender it for real when we get the pointerup event.)</span></span><br><span class="line">            <span class="keyword">if</span> (dx &gt; <span class="number">10</span> || dy &gt; <span class="number">10</span> || dt &gt; <span class="number">500</span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">style</span>.<span class="property">transform</span> = <span class="string">`translate(<span class="subst">$&#123;dx&#125;</span>px, <span class="subst">$&#123;dy&#125;</span>px)`</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// This is the handler for pointerup events</span></span><br><span class="line">        <span class="keyword">const</span> <span class="title function_">pointerUpHandler</span> = event =&gt; &#123;</span><br><span class="line">            <span class="comment">// When the pointer goes up, the gesture is over, so remove</span></span><br><span class="line">            <span class="comment">// the move and up handlers until the next gesture.</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="title function_">removeEventListener</span>(<span class="string">&quot;pointermove&quot;</span>, pointerMoveHandler);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="title function_">removeEventListener</span>(<span class="string">&quot;pointerup&quot;</span>, pointerUpHandler);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// How much did the pointer move, and how much time passed?</span></span><br><span class="line">            <span class="keyword">const</span> dx = event.<span class="property">clientX</span>-x0, dy=event.<span class="property">clientY</span>-y0, dt=<span class="title class_">Date</span>.<span class="title function_">now</span>()-t0;</span><br><span class="line">            <span class="comment">// Unpack the state object into individual constants.</span></span><br><span class="line">            <span class="keyword">const</span> &#123;cx, cy, perPixel&#125; = <span class="variable language_">this</span>.<span class="property">state</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If the pointer moved far enough or if enough time passed, then</span></span><br><span class="line">            <span class="comment">// this was a pan gesture, and we need to change state to change</span></span><br><span class="line">            <span class="comment">// the center point. Otherwise, the user clicked or tapped on a</span></span><br><span class="line">            <span class="comment">// point and we need to center and zoom in on that point.</span></span><br><span class="line">            <span class="keyword">if</span> (dx &gt; <span class="number">10</span> || dy &gt; <span class="number">10</span> || dt &gt; <span class="number">500</span>) &#123;</span><br><span class="line">                <span class="comment">// The user panned the image by (dx, dy) pixels.</span></span><br><span class="line">                <span class="comment">// Convert those values to offsets in the complex plane.</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;<span class="attr">cx</span>: cx - dx*perPixel, <span class="attr">cy</span>: cy - dy*perPixel&#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// The user clicked. Compute how many pixels the center moves.</span></span><br><span class="line">                <span class="keyword">let</span> cdx = x0 - <span class="variable language_">this</span>.<span class="property">width</span>/<span class="number">2</span>;</span><br><span class="line">                <span class="keyword">let</span> cdy = y0 - <span class="variable language_">this</span>.<span class="property">height</span>/<span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Use CSS to quickly and temporarily zoom in</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">style</span>.<span class="property">transform</span> =</span><br><span class="line">                    <span class="string">`translate(<span class="subst">$&#123;-cdx*<span class="number">2</span>&#125;</span>px, <span class="subst">$&#123;-cdy*<span class="number">2</span>&#125;</span>px) scale(2)`</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Set the complex coordinates of the new center point and</span></span><br><span class="line">                <span class="comment">// zoom in by a factor of 2.</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">setState</span>(<span class="function"><span class="params">s</span> =&gt;</span> &#123;</span><br><span class="line">                    s.<span class="property">cx</span> += cdx * s.<span class="property">perPixel</span>;</span><br><span class="line">                    s.<span class="property">cy</span> += cdy * s.<span class="property">perPixel</span>;</span><br><span class="line">                    s.<span class="property">perPixel</span> /= <span class="number">2</span>;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// When the user begins a gesture we register handlers for the</span></span><br><span class="line">        <span class="comment">// pointermove and pointerup events that follow.</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;pointermove&quot;</span>, pointerMoveHandler);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;pointerup&quot;</span>, pointerUpHandler);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Finally, here&#x27;s how we set up the canvas. Note that this JavaScript file</span></span><br><span class="line"><span class="comment">// is self-sufficient. The HTML file only needs to include this one &lt;script&gt;.</span></span><br><span class="line"><span class="keyword">let</span> canvas = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;canvas&quot;</span>); <span class="comment">// Create a canvas element</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">append</span>(canvas);                  <span class="comment">// Insert it into the body</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="property">body</span>.<span class="property">style</span> = <span class="string">&quot;margin:0&quot;</span>;              <span class="comment">// No margin for the &lt;body&gt;</span></span><br><span class="line">canvas.<span class="property">style</span>.<span class="property">width</span> = <span class="string">&quot;100%&quot;</span>;                   <span class="comment">// Make canvas as wide as body</span></span><br><span class="line">canvas.<span class="property">style</span>.<span class="property">height</span> = <span class="string">&quot;100%&quot;</span>;                  <span class="comment">// and as high as the body.</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">MandelbrotCanvas</span>(canvas);                  <span class="comment">// And start rendering into it!</span></span><br></pre></td></tr></table></figure>
<h2 id="15-15-Summary-and-Suggestions-for-Further-Reading"><a href="#15-15-Summary-and-Suggestions-for-Further-Reading" class="headerlink" title="15.15 Summary and Suggestions for Further Reading"></a>15.15 Summary and Suggestions for Further Reading</h2><p>This long chapter has covered the fundamentals of client-side JavaScript programming:</p>
<p>How scripts and JavaScript modules are included in web pages and how and when they are executed.</p>
<p>Client-side JavaScriptâ€™s asynchronous, event-driven programming model.</p>
<p>The Document Object Model (DOM) that allows JavaScript code to inspect and modify the HTML content of the document it is embedded within. This DOM API is the heart of all client-side JavaScript programming.</p>
<p>How JavaScript code can manipulate the CSS styles that are applied to content within the document.</p>
<p>How JavaScript code can obtain the coordinates of document elements in the browser window and within the document itself.</p>
<p>How to create reusable UI â€œWeb Componentsâ€ with JavaScript, HTML, and CSS using the Custom Elements and Shadow DOM APIs.</p>
<p>How to display and dynamically generate graphics with SVG and the HTML <code>&lt;canvas&gt;</code> element.</p>
<p>How to add scripted sound effects (both recorded and synthesized) to your web pages.</p>
<p>How JavaScript can make the browser load new pages, go backward and forward in the userâ€™s browsing history, and even add new entries to the browsing history.</p>
<p>How JavaScript programs can exchange data with web servers using the HTTP and WebSocket protocols.</p>
<p>How JavaScript programs can store data in the userâ€™s browser.</p>
<p>How JavaScript programs can use worker threads to achieve a safe form of concurrency.</p>
<p>This has been the longest chapter of the book, by far. But it cannot come close to covering all the APIs available to web browsers. The web platform is sprawling and ever-evolving, and my goal for this chapter was to introduce the most important core APIs. With the knowledge you have from this book, you are well equipped to learn and use new APIs as you need them. But you canâ€™t learn about a new API if you donâ€™t know that it exists, so the short sections that follow end the chapter with a quick list of web platform features that you might want to investigate in the future.</p>
<h3 id="15-15-1-HTML-and-CSS"><a href="#15-15-1-HTML-and-CSS" class="headerlink" title="15.15.1 HTML and CSS"></a>15.15.1 HTML and CSS</h3><p>The web is built upon three key technologies: HTML, CSS, and JavaScript, and knowledge of JavaScript can take you only so far as a web developer unless you also develop your expertise with HTML and CSS. It is important to know how to use JavaScript to manipulate HTML elements and CSS styles, but that knowledge is is much more useful if you also know which HTML elements and which CSS styles to use.</p>
<p>So before you start exploring more JavaScript APIs, I would encourage you to invest some time in mastering the other tools in a web developerâ€™s toolkit. HTML form and input elements, for example, have sophisticated behavior that is important to understand, and the flexbox and grid layout modes in CSS are incredibly powerful.</p>
<p>Two topics worth paying particular attention to in this area are accessibility (including ARIA attributes) and internationalization (including support for right-to-left writing directions).</p>
<h3 id="15-15-2-Performance"><a href="#15-15-2-Performance" class="headerlink" title="15.15.2 Performance"></a>15.15.2 Performance</h3><p>Once you have written a web application and released it to the world, the never-ending quest to make it fast begins. It is hard to optimize things that you canâ€™t measure, however, so it is worth familiarizing yourself with the Performance APIs. The performance property of the window object is the main entry point to this API. It includes a high-resolution time source performance.now(), and methods performance.mark() and performance.measure() for marking critical points in your code and measuring the elapsed time between them. Calling these methods creates PerformanceEntry objects that you can access with performance.getEntries(). Browsers add their own PerformanceEntry objects any time the browser loads a new page or fetches a file over the network, and these automatically created PerformanceEntry objects include granular timing details of your applicationâ€™s network performance. The related PerformanceObserver class allows you to specify a function to be invoked when new PerformanceEntry objects are created.</p>
<h3 id="15-15-3-Security"><a href="#15-15-3-Security" class="headerlink" title="15.15.3 Security"></a>15.15.3 Security</h3><p>This chapter introduced the general idea of how to defend against cross-site scripting (XSS) security vulnerabilities in your websites, but we did not go into much detail. The topic of web security is an important one, and you may want to spend some time learning more about it. In addition to XSS, it is worth learning about the Content-Security-Policy HTTP header and understanding how CSP allows you to ask the web browser to restrict the capabilities it grants to JavaScript code. Understanding CORS (Cross-Origin Resource Sharing) is also important.</p>
<h3 id="15-15-4-WebAssembly"><a href="#15-15-4-WebAssembly" class="headerlink" title="15.15.4 WebAssembly"></a>15.15.4 WebAssembly</h3><p>WebAssembly (or â€œwasmâ€) is a low-level virtual machine bytecode format that is designed to integrate well with JavaScript interpreters in web browsers. There are compilers that allow you to compile C, C++, and Rust programs to WebAssembly bytecode and to run those programs in web browsers at close to native speed, without breaking the browser sandbox or security model. WebAssembly can export functions that can be called by JavaScript programs. A typical use case for WebAssembly would be to compile the standard C-language zlib compression library so that JavaScript code has access to high-speed compression and decompression algorithms. Learn more at <a target="_blank" rel="noopener" href="https://webassembly.org/">https://webassembly.org</a>.</p>
<h3 id="15-15-5-More-Document-and-Window-Features"><a href="#15-15-5-More-Document-and-Window-Features" class="headerlink" title="15.15.5 More Document and Window Features"></a>15.15.5 More Document and Window Features</h3><p>The Window and Document objects have a number of features that were not covered in this chapter:</p>
<p>The Window object defines alert(), confirm(), and prompt() methods that display simple modal dialogues to the user. These methods block the main thread. The confirm() method synchronously returns a boolean value, and prompt() synchronously returns a string of user input. These are not suitable for production use but can be useful for simple projects and prototypes.</p>
<p>The navigator and screen properties of the Window object were mentioned in passing at the start of this chapter, but the Navigator and Screen objects that they reference have some features that were not described here that you may find useful.</p>
<p>The requestFullscreen() method of any Element object requests that that element (a <code>&lt;video&gt;</code> or <code>&lt;canvas&gt;</code> element, for example) be displayed in fullscreen mode. The exitFullscreen() method of the Document returns to normal display mode.</p>
<p>The requestAnimationFrame() method of the Window object takes a function as its argument and will execute that function when the browser is preparing to render the next frame. When you are making visual changes (especially repeated or animated ones), wrapping your code within a call to requestAnimationFrame() can help to ensure that the changes are rendered smoothly and in a way that is optimized by the browser.</p>
<p>If the user selects text within your document, you can obtain details of that selection with the Window method getSelection() and get the selected text with getSelection().toString(). In some browsers, navigator.clipboard is an object with an async API for reading and setting the content of the system clipboard to enable copy-and-paste interactions with applications outside of the browser.</p>
<p>A little-known feature of web browsers is that HTML elements with a contenteditable&#x3D;â€trueâ€ attribute allow their content to be edited. The document.execCommand() method enables rich-text editing features for editable content.</p>
<p>A MutationObserver allows JavaScript to monitor changes to, or beneath, a specified element in the document. Create a MutationObserver with the MutationObserver() constructor, passing the callback function that should be called when changes are made. Then call the observe() method of the MutationObserver to specify which parts of which element are to be monitored.</p>
<p>An IntersectionObserver allows JavaScript to determine which document elements are on the screen and which are close to being on the screen. It is particularly useful for applications that want to dynamically load content on demand as the user scrolls.</p>
<h3 id="15-15-6-Events"><a href="#15-15-6-Events" class="headerlink" title="15.15.6 Events"></a>15.15.6 Events</h3><p>The sheer number and diversity of events supported by the web platform can be daunting. This chapter has discussed a variety of event types, but here are some more that you may find useful:</p>
<p>Browsers fire â€œonlineâ€ and â€œofflineâ€ events at the Window object when the browser gains or loses an internet connection.</p>
<p>Browsers fire a â€œvisiblitychangeâ€ event at the Document object when a document becomes visible or invisible (usually because a user has switched tabs). JavaScript can check document.visibilityState to determine whether its document is currently â€œvisibleâ€ or â€œhidden.â€</p>
<p>Browsers support a complicated API to support drag-and-drop UIs and to support data exchange with applications outside the browser. This API involves a number of events, including â€œdragstart,â€ â€œdragover,â€ â€œdragend,â€ and â€œdrop.â€ This API is tricky to use correctly but useful when you need it. It is an important API to know about if you want to enable users to drag files from their desktop into your web application.</p>
<p>The Pointer Lock API enables JavaScript to hide the mouse pointer and get raw mouse events as relative movement amounts rather than absolute positions on the screen. This is typically useful for games. Call requestPointerLock() on the element you want all mouse events directed to. After you do this, â€œmousemoveâ€ events delivered to that element will have movementX and movementY properties.</p>
<p>The Gamepad API adds support for game controllers. Use navigator.getGamepads() to get connected Gamepad objects, and listen for â€œgamepadconnectedâ€ events on the Window object to be notified when a new controller is plugged in. The Gamepad object defines an API for querying the current state of the buttons on the controller.</p>
<h3 id="15-15-7-Progressive-Web-Apps-and-Service-Workers"><a href="#15-15-7-Progressive-Web-Apps-and-Service-Workers" class="headerlink" title="15.15.7 Progressive Web Apps and Service Workers"></a>15.15.7 Progressive Web Apps and Service Workers</h3><p>The term Progressive Web Apps, or PWAs, is a buzzword that describes web applications that are built using a few key technologies. Careful documentation of these key technologies would require a book of its own, and I have not covered them in this chapter, but you should be aware of all of these APIs. It is worth noting that powerful modern APIs like these are typically designed to work only on secure HTTPS connections. Websites that are still using http:&#x2F;&#x2F; URLs will not be able to take advantage of these:</p>
<p>A ServiceWorker is a kind of worker thread with the ability to intercept, inspect, and respond to network requests from the web application that it â€œservices.â€ When a web application registers a service worker, that workerâ€™s code becomes persistent in the browserâ€™s local storage, and when the user visits the associated website again, the service worker is reactivated. Service workers can cache network responses (including files of JavaScript code), which means that web applications that use service workers can effectively install themselves onto the userâ€™s computer for rapid startup and offline use. The Service Worker Cookbook at <a target="_blank" rel="noopener" href="https://serviceworke.rs/">https://serviceworke.rs</a> is a valuable resource for learning about service workers and their related technologies.</p>
<p>The Cache API is designed for use by service workers (but is also available to regular JavaScript code outside of workers). It works with the Request and Response objects defined by the fetch() API and implements a cache of Request&#x2F;Response pairs. The Cache API enables a service worker to cache the scripts and other assets of the web app it serves and can also help to enable offline use of the web app (which is particularly important for mobile devices).</p>
<p>A Web Manifest is a JSON-formatted file that describes a web application including a name, a URL, and links to icons in various sizes. If your web app uses a service worker and includes a <code>&lt;link rel=&quot;manifest&quot;&gt;</code> tag that references a .webmanifest file, then browsers (particularly browsers on mobile devices) may give you the option to add an icon for the web app to your desktop or home screen.</p>
<p>The Notifications API allows web apps to display notifications using the native OS notification system on both mobile and desktop devices. Notifications can include an image and text, and your code can receive an event if the user clicks on the notification. Using this API is complicated by the fact that you must first request the userâ€™s permission to display notifications.</p>
<p>The Push API allows web applications that have a service worker (and that have the userâ€™s permission) to subscribe to notifications from a server, and to display those notifications even when the application itself is not running. Push notifications are common on mobile devices, and the Push API brings web apps closer to feature parity with native apps on mobile.</p>
<h3 id="15-15-8-Mobile-Device-APIs"><a href="#15-15-8-Mobile-Device-APIs" class="headerlink" title="15.15.8 Mobile Device APIs"></a>15.15.8 Mobile Device APIs</h3><p>There are a number of web APIs that are primarily useful for web apps running on mobile devices. (Unfortunately, a number of these APIs only work on Android devices and not iOS devices.)</p>
<p>The Geolocation API allows JavaScript (with the userâ€™s permission) to determine the userâ€™s physical location. It is well supported on desktop and mobile devices, including iOS devices. Use navigator.geolocation.getCurrentPosition() to request the userâ€™s current position and use navigator.geolocation.watchPosition() to register a callback to be called when the userâ€™s position changes.</p>
<p>The navigator.vibrate() method causes a mobile device (but not iOS) to vibrate. Often this is only allowed in response to a user gesture, but calling this method will allow your app to provide silent feedback that a gesture has been recognized.</p>
<p>The ScreenOrientation API enables a web application to query the current orientation of a mobile device screen and also to lock themselves to landscape or portrait orientation.</p>
<p>The â€œdevicemotionâ€ and â€œdeviceorientationâ€ events on the window object report accelerometer and magnetometer data for the device, enabling you to determine how the device is accelerating and how the user is orienting it in space. (These events do work on iOS.)</p>
<p>The Sensor API is not yet widely supported beyond Chrome on Android devices, but it enables JavaScript access to the full suite of mobile device sensors, including accelerometer, gyroscope, magnetometer, and ambient light sensor. These sensors enable JavaScript to determine which direction a user is facing or to detect when the user shakes their phone, for example.</p>
<h3 id="15-15-9-Binary-APIs"><a href="#15-15-9-Binary-APIs" class="headerlink" title="15.15.9 Binary APIs"></a>15.15.9 Binary APIs</h3><p>Typed arrays, ArrayBuffers, and the DataView class (all covered in Â§11.2) enable JavaScript to work with binary data. As described earlier in this chapter, the fetch() API enables JavaScript programs to load binary data over the network. Another source of binary data is files from the userâ€™s local filesystem. For security reasons, JavaScript canâ€™t just read local files. But if the user selects a file for upload (using an <code>&lt;input type=&quot;file&gt;</code> form element) or uses drag-and-drop to drop a file into your web application, then JavaScript can access that file as a File object.</p>
<p>File is a subclass of Blob, and as such, it is an opaque representation of a chunk of data. You can use a FileReader class to asynchronously get the content of a file as an ArrayBuffer or string. (In some browsers, you can skip the FileReader and instead use the Promise-based text() and arrayBuffer() methods defined by the Blob class, or the stream() method for streaming access to the file contents.)</p>
<p>When working with binary data, especially streaming binary data, you may need to decode bytes into text or encode text as bytes. The TextEncoder and TextDecoder classes help with this task.</p>
<h3 id="15-15-10-Media-APIs"><a href="#15-15-10-Media-APIs" class="headerlink" title="15.15.10 Media APIs"></a>15.15.10 Media APIs</h3><p>The navigator.mediaDevices.getUserMedia() function allows JavaScript to request access to the userâ€™s microphone and&#x2F;or video camera. A successful request results in a MediaStream object. Video streams can be displayed in a <code>&lt;video&gt;</code> tag (by setting the srcObject property to the stream). Still frames of the video can be captured into an offscreen <code>&lt;canvas&gt;</code> with the canvas drawImage() function resulting in a relatively low-resolution photograph. Audio and video streams returned by getUserMedia() can be recorded and encoded to a Blob with a MediaRecorder object.</p>
<p>The more complex WebRTC API enables the transmission and reception of MediaStreams over the network, enabling peer-to-peer video conferencing, for example.</p>
<h3 id="15-15-11-Cryptography-and-Related-APIs"><a href="#15-15-11-Cryptography-and-Related-APIs" class="headerlink" title="15.15.11 Cryptography and Related APIs"></a>15.15.11 Cryptography and Related APIs</h3><p>The crypto property of the Window object exposes a getRandomValues() method for cryptographically secure pseudorandom numbers. Other methods for encryption, decryption, key generation, digital signatures, and so on are available through crypto.subtle. The name of this property is a warning to everyone who uses these methods that properly using cryptographic algorithms is difficult and that you should not use those methods unless you really know what you are doing. Also, the methods of crypto.subtle are only available to JavaScript code running within documents that were loaded over a secure HTTPS connection.</p>
<p>The Credential Management API and the Web Authentication API allow JavaScript to generate, store, and retrieve public key (and other types of) credentials and enables account creation and login without passwords. The JavaScript API consists primarily of the functions navigator.credentials.create() and navigator.credentials.get(), but substantial infrastructure is required on the server side to make these methods work. These APIs are not universally supported yet, but have the potential to revolutionize the way we log in to websites.</p>
<p>The Payment Request API adds browser support for making credit card payments on the web. It allows users to store their payment details securely in the browser so that they donâ€™t have to type their credit card number each time they make a purchase. Web applications that want to request a payment create a PaymentRequest object and call its show() method to display the request to the user.</p>
<p>1 Previous editions of this book had an extensive reference section covering the JavaScript standard library and web APIs. It was removed in the seventh edition because MDN has made it obsolete: today, it is quicker to look something up on MDN than it is to flip through a book, and my former colleagues at MDN do a better job at keeping their online documentation up to date than this book ever could.</p>
<p>2 Some sources, including the HTML specification, make a technical distinction between handlers and listeners, based on the way in which they are registered. In this book, we treat the two terms as synonyms.</p>
<p>3 If you have used the React framework to create client-side user interfaces, this may surprise you. React makes a number of minor changes to the client-side event model, and one of them is that in React, event handler property names are written in camelCase: onClick, onMouseOver, and so on. When working with the web platform natively, however, the event handler properties are written entirely in lowercase.</p>
<p>4 The custom element specification allows subclassing of <code>&lt;button&gt;</code> and other specific element classes, but this is not supported in Safari and a different syntax is required to use a custom element that extends anything other than HTMLElement.</p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="å¤´åƒ"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img02.anzhiy.cn/adminuploads/1/2022/09/15/63232b7d91d22.jpg" title="å¤´åƒ" alt="å¤´åƒ"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img02.anzhiy.cn/adminuploads/1/2022/09/15/63232b7d91d22.jpg" title="å¤´åƒ" alt="å¤´åƒ"></a><div class="post-copyright__author_name">Jack hou</div><div class="post-copyright__author_desc"></div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="è¯¥æ–‡ç« ä¸ºåŸåˆ›æ–‡ç« ï¼Œæ³¨æ„ç‰ˆæƒåè®®" href="http://www.houyanbin.com/2023/04/26/Books/%E3%80%8AJavaScript%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E3%80%8B/ch15/">åŸåˆ›</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://www.houyanbin.com/2023/04/26/Books/%E3%80%8AJavaScript%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E3%80%8B/ch15/')">ç¬¬15ç«  Web æµè§ˆå™¨ä¸­çš„ JavaScript</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="èµèµä½œè€…"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>æ‰“èµä½œè€…</div><div class="reward-main"><div class="reward-all"><span class="reward-title">æ„Ÿè°¢ä½ èµäºˆæˆ‘å‰è¿›çš„åŠ›é‡</span><ul class="reward-group"><li class="reward-item"><a href="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/index/wechat.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/index/wechat.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/index/alipay.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/index/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">èµèµè€…åå•</div><div class="reward-dec">å› ä¸ºä½ ä»¬çš„æ”¯æŒè®©æˆ‘æ„è¯†åˆ°å†™æ–‡ç« çš„ä»·å€¼ğŸ™</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display: none"></div><div class="reward-link mode"><a class="reward-link-button" href="/wechat/" data-pjax-state=""><i class="anzhiyufont anzhiyu-icon-plant-fill"></i>è¿è¥æ¨¡å¼ä¸è´£ä»»</a></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="ä½¿ç”¨æ‰‹æœºè®¿é—®è¿™ç¯‡æ–‡ç« "><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://www.houyanbin.com/2023/04/26/Books/%E3%80%8AJavaScript%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E3%80%8B/ch15/"></div><div class="reward-dec">ä½¿ç”¨æ‰‹æœºè®¿é—®è¿™ç¯‡æ–‡ç« </div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=ç¬¬15ç«  Web æµè§ˆå™¨ä¸­çš„ JavaScript&amp;url=http://www.houyanbin.com/2023/04/26/Books/%E3%80%8AJavaScript%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E3%80%8B/ch15/&amp;pic=https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/post/default_cover5.jpg" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="å¤åˆ¶é“¾æ¥" onclick="rm.copyPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="http://www.houyanbin.com" target="_blank">Jackhou Blog</a>ï¼</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/%E3%80%8AJavaScript%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E3%80%8B/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>ã€ŠJavaScriptæƒå¨æŒ‡å—ã€‹<span class="tagsPageCount">17</span></a><a class="post-meta__box__tags" href="/tags/JavaScript/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>JavaScript<span class="tagsPageCount">17</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/post/default_cover6.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/04/26/Books/%E3%80%8AJavaScript%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E3%80%8B/ch16/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/post/default_cover9.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">ç¬¬16ç«  æœåŠ¡å™¨ç«¯ JavaScript</div></div></a></div><div class="next-post pull-right"><a href="/2023/04/26/Books/%E3%80%8AJavaScript%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E3%80%8B/ch14/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/post/default_cover6.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">ç¬¬14ç«  å…ƒç¼–ç¨‹</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><div><a href="/2023/04/26/Books/%E3%80%8AJavaScript%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E3%80%8B/ch1/" title="ç¬¬1ç«  JavaScript æ¦‚è¿°"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/post/default_cover1.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-04-26</div><div class="title">ç¬¬1ç«  JavaScript æ¦‚è¿°</div></div></a></div><div><a href="/2023/04/26/Books/%E3%80%8AJavaScript%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E3%80%8B/ch12/" title="ç¬¬12ç«  è¿­ä»£å™¨å’Œç”Ÿæˆå™¨"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/post/default_cover4.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-04-26</div><div class="title">ç¬¬12ç«  è¿­ä»£å™¨å’Œç”Ÿæˆå™¨</div></div></a></div><div><a href="/2023/04/26/Books/%E3%80%8AJavaScript%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E3%80%8B/ch10/" title="ç¬¬10ç«  æ¨¡å—"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/post/default_cover10.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-04-26</div><div class="title">ç¬¬10ç«  æ¨¡å—</div></div></a></div><div><a href="/2023/04/26/Books/%E3%80%8AJavaScript%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E3%80%8B/ch14/" title="ç¬¬14ç«  å…ƒç¼–ç¨‹"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/post/default_cover6.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-04-26</div><div class="title">ç¬¬14ç«  å…ƒç¼–ç¨‹</div></div></a></div><div><a href="/2023/04/26/Books/%E3%80%8AJavaScript%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E3%80%8B/ch11/" title="ç¬¬11ç«  JavaScript æ ‡å‡†åº“"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/post/default_cover.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-04-26</div><div class="title">ç¬¬11ç«  JavaScript æ ‡å‡†åº“</div></div></a></div><div><a href="/2023/04/26/Books/%E3%80%8AJavaScript%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E3%80%8B/ch13/" title="ç¬¬13ç«  å¼‚æ­¥ JavaScript"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/post/default_cover3.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-04-26</div><div class="title">ç¬¬13ç«  å¼‚æ­¥ JavaScript</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> è¯„è®º</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">åŒ¿åè¯„è®º</a></div><div class="comment-tips" id="comment-tips"><span>âœ… ä½ æ— éœ€åˆ é™¤ç©ºè¡Œï¼Œç›´æ¥è¯„è®ºä»¥è·å–æœ€ä½³å±•ç¤ºæ•ˆæœ</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-top" title="ç‚¹å‡»å±•å¼€"><div class="card-info-avatar"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img02.anzhiy.cn/adminuploads/1/2022/09/15/63232b7d91d22.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">Hiï¼Œè¿™æ˜¯æˆ‘çš„åšå®¢ç½‘ç«™ï¼Œæ¬¢è¿ä½ èƒ½åˆ°è®¿~</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">æˆ‘ä¼šåœ¨è¿™é‡Œåˆ†äº«æˆ‘çš„<b style="color:#fff">æŠ€æœ¯çŸ¥è¯†</b>ã€<b style="color:#fff">æ—¥å¸¸ç”Ÿæ´»</b>å’Œ<b style="color:#fff">äººç”Ÿç»éªŒã€‚</b></div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">Jack hou</h1><div class="author-info__desc"></div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/Hou-yanbin" target="_blank" title="Github"><i class="fab fa-github faa-tada"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/478589474" target="_blank" title="BiliBili"><i class="fa-brands fa-bilibili faa-tada"></i></a><a class="social-icon faa-parent animated-hover" href="https://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=jackhou921@qq.com" target="_blank" title="Email"><i class="anzhiyufont anzhiyu-icon-envelope"></i></a></div></div></div></div><div class="card-widget anzhiyu-right-widget" id="card-wechat" onclick="null"><div id="flip-wrapper"><div id="flip-content"><div class="face" style="background: url(https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/index/wxgzh1.png) center center / 100% no-repeat"></div><div class="back face" style="background: url(https://bu.dusays.com/2023/05/13/645fa415e8694.png) center center / 100% no-repeat"></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>æ–‡ç« ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#CLIENT-SIDE-JAVASCRIPT"><span class="toc-text">CLIENT-SIDE JAVASCRIPT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LEGACY-APIS"><span class="toc-text">LEGACY APIS</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#15-1-Web-Programming-Basics"><span class="toc-text">15.1 Web Programming Basics</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#15-1-1-JavaScript-in-HTML-lt-script-gt-Tags"><span class="toc-text">15.1.1 JavaScript in HTML &lt;script&gt; Tags</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-1-2-The-Document-Object-Model"><span class="toc-text">15.1.2 The Document Object Model</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-1-3-The-Global-Object-in-Web-Browsers"><span class="toc-text">15.1.3 The Global Object in Web Browsers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-1-4-Scripts-Share-a-Namespace"><span class="toc-text">15.1.4 Scripts Share a Namespace</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-1-5-Execution-of-JavaScript-Programs"><span class="toc-text">15.1.5 Execution of JavaScript Programs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-1-6-Program-Input-and-Output"><span class="toc-text">15.1.6 Program Input and Output</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-1-7-Program-Errors"><span class="toc-text">15.1.7 Program Errors</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-1-8-The-Web-Security-Model"><span class="toc-text">15.1.8 The Web Security Model</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#15-2-Events"><span class="toc-text">15.2 Events</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#15-2-1-Event-Categories"><span class="toc-text">15.2.1 Event Categories</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-2-2-Registering-Event-Handlers"><span class="toc-text">15.2.2 Registering Event Handlers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-2-3-Event-Handler-Invocation"><span class="toc-text">15.2.3 Event Handler Invocation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-2-4-Event-Propagation"><span class="toc-text">15.2.4 Event Propagation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-2-5-Event-Cancellation"><span class="toc-text">15.2.5 Event Cancellation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-2-6-Dispatching-Custom-Events"><span class="toc-text">15.2.6 Dispatching Custom Events</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#15-3-Scripting-Documents"><span class="toc-text">15.3 Scripting Documents</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#15-3-1-Selecting-Document-Elements"><span class="toc-text">15.3.1 Selecting Document Elements</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-3-2-Document-Structure-and-Traversal"><span class="toc-text">15.3.2 Document Structure and Traversal</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-3-3-Attributes"><span class="toc-text">15.3.3 Attributes</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-3-4-Element-Content"><span class="toc-text">15.3.4 Element Content</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ELEMENT-CONTENT-AS-PLAIN-TEXT"><span class="toc-text">ELEMENT CONTENT AS PLAIN TEXT</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-3-5-Creating-Inserting-and-Deleting-Nodes"><span class="toc-text">15.3.5 Creating, Inserting, and Deleting Nodes</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-3-6-Example-Generating-a-Table-of-Contents"><span class="toc-text">15.3.6 Example: Generating a Table of Contents</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#15-4-Scripting-CSS"><span class="toc-text">15.4 Scripting CSS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#15-4-1-CSS-Classes"><span class="toc-text">15.4.1 CSS Classes</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-4-2-Inline-Styles"><span class="toc-text">15.4.2 Inline Styles</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-4-3-Computed-Styles"><span class="toc-text">15.4.3 Computed Styles</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-4-4-Scripting-Stylesheets"><span class="toc-text">15.4.4 Scripting Stylesheets</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-4-5-CSS-Animations-and-Events"><span class="toc-text">15.4.5 CSS Animations and Events</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#15-5-Document-Geometry-and-Scrolling"><span class="toc-text">15.5 Document Geometry and Scrolling</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#15-5-1-Document-Coordinates-and-Viewport-Coordinates"><span class="toc-text">15.5.1 Document Coordinates and Viewport Coordinates</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-5-2-Querying-the-Geometry-of-an-Element"><span class="toc-text">15.5.2 Querying the Geometry of an Element</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-5-3-Determining-the-Element-at-a-Point"><span class="toc-text">15.5.3 Determining the Element at a Point</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-5-4-Scrolling"><span class="toc-text">15.5.4 Scrolling</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-5-5-Viewport-Size-Content-Size-and-Scroll-Position"><span class="toc-text">15.5.5 Viewport Size, Content Size, and Scroll Position</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#15-6-Web-Components"><span class="toc-text">15.6 Web Components</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#15-6-1-Using-Web-Components"><span class="toc-text">15.6.1 Using Web Components</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-6-2-HTML-Templates"><span class="toc-text">15.6.2 HTML Templates</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-6-3-Custom-Elements"><span class="toc-text">15.6.3 Custom Elements</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-6-4-Shadow-DOM"><span class="toc-text">15.6.4 Shadow DOM</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-6-5-Example-a-lt-search-box-gt-Web-Component"><span class="toc-text">15.6.5 Example: a &lt;search-box&gt; Web Component</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#15-7-SVG-Scalable-Vector-Graphics"><span class="toc-text">15.7 SVG: Scalable Vector Graphics</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#15-7-1-SVG-in-HTML"><span class="toc-text">15.7.1 SVG in HTML</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-7-2-Scripting-SVG"><span class="toc-text">15.7.2 Scripting SVG</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-7-3-Creating-SVG-Images-with-JavaScript"><span class="toc-text">15.7.3 Creating SVG Images with JavaScript</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#15-8-Graphics-in-a-lt-canvas-gt"><span class="toc-text">15.8 Graphics in a &lt;canvas&gt;</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#15-8-1-Paths-and-Polygons"><span class="toc-text">15.8.1 Paths and Polygons</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-8-2-Canvas-Dimensions-and-Coordinates"><span class="toc-text">15.8.2 Canvas Dimensions and Coordinates</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-8-3-Graphics-Attributes"><span class="toc-text">15.8.3 Graphics Attributes</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-8-4-Canvas-Drawing-Operations"><span class="toc-text">15.8.4 Canvas Drawing Operations</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-8-5-Coordinate-System-Transforms"><span class="toc-text">15.8.5 Coordinate System Transforms</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-8-6-Clipping"><span class="toc-text">15.8.6 Clipping</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-8-7-Pixel-Manipulation"><span class="toc-text">15.8.7 Pixel Manipulation</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#15-9-Audio-APIs"><span class="toc-text">15.9 Audio APIs</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#15-9-1-The-Audio-Constructor"><span class="toc-text">15.9.1 The Audio() Constructor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-9-2-The-WebAudio-API"><span class="toc-text">15.9.2 The WebAudio API</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#15-10-Location-Navigation-and-History"><span class="toc-text">15.10 Location, Navigation, and History</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#15-10-1-Loading-New-Documents"><span class="toc-text">15.10.1 Loading New Documents</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-10-2-Browsing-History"><span class="toc-text">15.10.2 Browsing History</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-10-3-History-Management-with-hashchange-Events"><span class="toc-text">15.10.3 History Management with hashchange Events</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-10-4-History-Management-with-pushState"><span class="toc-text">15.10.4 History Management with pushState()</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#15-11-Networking"><span class="toc-text">15.11 Networking</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#15-11-1-fetch"><span class="toc-text">15.11.1 fetch()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-11-2-Server-Sent-Events"><span class="toc-text">15.11.2 Server-Sent Events</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-11-3-WebSockets"><span class="toc-text">15.11.3 WebSockets</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#15-12-Storage"><span class="toc-text">15.12 Storage</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#15-12-1-localStorage-and-sessionStorage"><span class="toc-text">15.12.1 localStorage and sessionStorage</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-12-2-Cookies"><span class="toc-text">15.12.2 Cookies</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-12-3-IndexedDB"><span class="toc-text">15.12.3 IndexedDB</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#15-13-Worker-Threads-and-Messaging"><span class="toc-text">15.13 Worker Threads and Messaging</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#15-13-1-Worker-Objects"><span class="toc-text">15.13.1 Worker Objects</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-13-2-The-Global-Object-in-Workers"><span class="toc-text">15.13.2 The Global Object in Workers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-13-3-Importing-Code-into-a-Worker"><span class="toc-text">15.13.3 Importing Code into a Worker</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-13-4-Worker-Execution-Model"><span class="toc-text">15.13.4 Worker Execution Model</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-13-5-postMessage-MessagePorts-and-MessageChannels"><span class="toc-text">15.13.5 postMessage(), MessagePorts, and MessageChannels</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-13-6-Cross-Origin-Messaging-with-postMessage"><span class="toc-text">15.13.6 Cross-Origin Messaging with postMessage()</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#15-14-Example-The-Mandelbrot-Set"><span class="toc-text">15.14 Example: The Mandelbrot Set</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#15-15-Summary-and-Suggestions-for-Further-Reading"><span class="toc-text">15.15 Summary and Suggestions for Further Reading</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#15-15-1-HTML-and-CSS"><span class="toc-text">15.15.1 HTML and CSS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-15-2-Performance"><span class="toc-text">15.15.2 Performance</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-15-3-Security"><span class="toc-text">15.15.3 Security</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-15-4-WebAssembly"><span class="toc-text">15.15.4 WebAssembly</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-15-5-More-Document-and-Window-Features"><span class="toc-text">15.15.5 More Document and Window Features</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-15-6-Events"><span class="toc-text">15.15.6 Events</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-15-7-Progressive-Web-Apps-and-Service-Workers"><span class="toc-text">15.15.7 Progressive Web Apps and Service Workers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-15-8-Mobile-Device-APIs"><span class="toc-text">15.15.8 Mobile Device APIs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-15-9-Binary-APIs"><span class="toc-text">15.15.9 Binary APIs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-15-10-Media-APIs"><span class="toc-text">15.15.10 Media APIs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-15-11-Cryptography-and-Related-APIs"><span class="toc-text">15.15.11 Cryptography and Related APIs</span></a></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/09/22/%E5%8C%BF%E5%90%8D/test/" title="test"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/post/default_cover6.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="test"/></a><div class="content"><a class="title" href="/2023/09/22/%E5%8C%BF%E5%90%8D/test/" title="test">test</a><time datetime="2023-09-21T16:00:00.000Z" title="å‘è¡¨äº 2023-09-22 00:00:00">2023-09-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/08/15/%E5%8C%BF%E5%90%8D/%E6%83%85%E4%BA%BA/" title="åšæƒ…äººçœŸçš„æ²¡æœ‰å¥½ä¸‹åœºå—ï¼Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/post/default_cover8.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="åšæƒ…äººçœŸçš„æ²¡æœ‰å¥½ä¸‹åœºå—ï¼Ÿ"/></a><div class="content"><a class="title" href="/2023/08/15/%E5%8C%BF%E5%90%8D/%E6%83%85%E4%BA%BA/" title="åšæƒ…äººçœŸçš„æ²¡æœ‰å¥½ä¸‹åœºå—ï¼Ÿ">åšæƒ…äººçœŸçš„æ²¡æœ‰å¥½ä¸‹åœºå—ï¼Ÿ</a><time datetime="2023-08-14T16:00:00.000Z" title="å‘è¡¨äº 2023-08-15 00:00:00">2023-08-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/07/30/%E5%8C%BF%E5%90%8D/%E4%B8%8D%E7%88%B1%E6%80%8E%E4%B9%88%E8%B5%B0%E4%B8%8B%E5%8E%BB/" title="ä¸çˆ±å‰è¡Œ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/post/default_cover8.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ä¸çˆ±å‰è¡Œ"/></a><div class="content"><a class="title" href="/2023/07/30/%E5%8C%BF%E5%90%8D/%E4%B8%8D%E7%88%B1%E6%80%8E%E4%B9%88%E8%B5%B0%E4%B8%8B%E5%8E%BB/" title="ä¸çˆ±å‰è¡Œ">ä¸çˆ±å‰è¡Œ</a><time datetime="2023-07-29T16:00:00.000Z" title="å‘è¡¨äº 2023-07-30 00:00:00">2023-07-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/07/22/%E5%8C%BF%E5%90%8D/%E7%A7%9F%E6%88%BF%E6%97%B6%E5%85%89/" title="ç§Ÿæˆ¿æ—¶å…‰"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/post/default_cover7.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ç§Ÿæˆ¿æ—¶å…‰"/></a><div class="content"><a class="title" href="/2023/07/22/%E5%8C%BF%E5%90%8D/%E7%A7%9F%E6%88%BF%E6%97%B6%E5%85%89/" title="ç§Ÿæˆ¿æ—¶å…‰">ç§Ÿæˆ¿æ—¶å…‰</a><time datetime="2023-07-21T16:00:00.000Z" title="å‘è¡¨äº 2023-07-22 00:00:00">2023-07-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/06/11/%E6%97%85%E8%A1%8C/%E6%95%85%E5%AE%AB%E8%AE%B0/" title="æ•…å®«è®°"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://imagesblog.oss-cn-hangzhou.aliyuncs.com/themes/post/default_cover6.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="æ•…å®«è®°"/></a><div class="content"><a class="title" href="/2023/06/11/%E6%97%85%E8%A1%8C/%E6%95%85%E5%AE%AB%E8%AE%B0/" title="æ•…å®«è®°">æ•…å®«è®°</a><time datetime="2023-06-10T16:00:00.000Z" title="å‘è¡¨äº 2023-06-11 00:00:00">2023-06-11</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div id="workboard"><img class="workSituationImg boardsign" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.0.4/img/badge/å®‰çŸ¥é±¼-ä¸Šç­æ‘¸é±¼ä¸­.svg" alt="è·ç¦»æœˆå…¥25kä¹Ÿå°±è¿˜å·®ä¸€ä¸ªå¤§ä½¬å¸¦æˆ‘~" title="è·ç¦»æœˆå…¥25kä¹Ÿå°±è¿˜å·®ä¸€ä¸ªå¤§ä½¬å¸¦æˆ‘~"/><div id="runtimeTextTip"></div></div></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2023 By Jack hou </div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://houyanbin.com" title="ä¸»é¢˜">ä¸»é¢˜</a></div></div></div></footer></div></div></div><div id="sidebar"><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img02.anzhiy.cn/adminuploads/1/2022/09/15/63232b7d91d22.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">æ–‡ç« </div><div class="length-num">59</div></a><a href="/tags/" title="tag"><div class="headline">æ ‡ç­¾</div><div class="length-num">19</div></a><a href="/categories/" title="category"><div class="headline">åˆ†ç±»</div><div class="length-num">11</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><span> æ–‡ç« </span></a><ul class="menus_item_child" style="left:-79px;"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> éš§é“</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> åˆ†ç±»</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> æ ‡ç­¾</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><span> å‹é“¾</span></a><ul class="menus_item_child" style="left:-31px;"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> å‹äººå¸</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> ç•™è¨€æ¿</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><span> æˆ‘çš„</span></a><ul class="menus_item_child" style="left:-79px;"><li><a class="site-page child faa-parent animated-hover" href="/music/?id=8868465080&amp;server=tencent&amp;type=0"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> éŸ³ä¹é¦†</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/bangumis/"><i class="anzhiyufont anzhiyu-icon-bilibili faa-tada" style="font-size: 0.9em;"></i><span> è¿½ç•ªé¡µ</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> ç›¸å†Œé›†</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><span> å…³äº</span></a><ul class="menus_item_child" style="left:-79px;"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> å…³äºæœ¬äºº</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> é—²è¨€ç¢è¯­</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> éšä¾¿é€›é€›</span></a></li></ul></div></div></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="ç®€ç¹è½¬æ¢">ç¹</button><button id="darkmode" type="button" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="ç›´è¾¾è¯„è®º"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><a id="switch_commentBarrage" href="javascript:anzhiyu.switchCommentBarrage();" title="å¼€å…³å¼¹å¹•"><i class="anzhiyufont anzhiyu-icon-danmu"></i></a><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">æ’­æ”¾éŸ³ä¹</a><div id="console-music-bg"></div><meting-js id="8868465080" server="tencent" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">æœç´¢</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  æ•°æ®åº“åŠ è½½ä¸­</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« " type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>å¤åˆ¶é€‰ä¸­æ–‡æœ¬</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>ç²˜è´´æ–‡æœ¬</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>å¼•ç”¨åˆ°è¯„è®º</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>æ–°çª—å£æ‰“å¼€</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>å¤åˆ¶é“¾æ¥åœ°å€</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>å¤åˆ¶æ­¤å›¾ç‰‡</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>ä¸‹è½½æ­¤å›¾ç‰‡</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>æ–°çª—å£æ‰“å¼€å›¾ç‰‡</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>ç«™å†…æœç´¢</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>ç™¾åº¦æœç´¢</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>æ’­æ”¾éŸ³ä¹</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>åˆ‡æ¢åˆ°ä¸Šä¸€é¦–</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>åˆ‡æ¢åˆ°ä¸‹ä¸€é¦–</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8868465080&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>æŸ¥çœ‹æ‰€æœ‰æ­Œæ›²</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>å¤åˆ¶æ­Œå</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>éšä¾¿é€›é€›</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>åšå®¢åˆ†ç±»</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>æ–‡ç« æ ‡ç­¾</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>å¤åˆ¶åœ°å€</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">å…³é—­çƒ­è¯„</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">æ·±è‰²æ¨¡å¼</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>è½‰ç‚ºç¹é«”</span></a></div></div><div id="rightmenu-mask"></div><div id="he-plugin-simple"></div><script>var WIDGET = {
  "CONFIG": {
    "modules": "0124",
    "background": "2",
    "tmpColor": "FFFFFF",
    "tmpSize": "16",
    "cityColor": "FFFFFF",
    "citySize": "16",
    "aqiColor": "E8D87B",
    "aqiSize": "16",
    "weatherIconSize": "24",
    "alertIconSize": "18",
    "padding": "10px 10px 10px 10px",
    "shadow": "0",
    "language": "auto",
    "borderRadius": "20",
    "fixed": "true",
    "vertical": "top",
    "horizontal": "left",
    "left": "20",
    "top": "7.1",
    "key": "df245676fb434a0691ead1c63341cd94"
  }
}
</script><link rel="stylesheet" href="https://widget.qweather.net/simple/static/css/he-simple.css?v=1.4.0"/><script src="https://widget.qweather.net/simple/static/js/he-simple.js?v=1.4.0"></script><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.14/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.3.1/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// æ¶ˆé™¤æ§åˆ¶å°æ‰“å°
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //åœ¨æ¢å¤å‰è¾“å‡ºæ—¥å¿—
  const grt = new Date("4/15/2023 00:00:00"); //æ­¤å¤„ä¿®æ”¹ä½ çš„å»ºç«™æ—¶é—´æˆ–è€…ç½‘ç«™ä¸Šçº¿æ—¶é—´
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `æ¬¢è¿ä½¿ç”¨å®‰çŸ¥é±¼!`,
    `ç”Ÿæ´»æ˜æœ—, ä¸‡ç‰©å¯çˆ±`,
    `
        
       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—
      â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â•šâ•â•â–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘
      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘
      â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ–ˆâ•”â•  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â•šâ–ˆâ–ˆâ•”â•  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘
      â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•
      â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•â•â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•   â•šâ•â•    â•šâ•â•â•â•â•â•
        
        `,
    "å·²ä¸Šçº¿",
    dnum,
    "å¤©",
    "Â©2023 By å®‰çŸ¥é±¼ V1.5.3",
  ];
  const ascll2 = [`NCC2-036`, `è°ƒç”¨å‰ç½®æ‘„åƒå¤´æ‹ç…§æˆåŠŸï¼Œè¯†åˆ«ä¸ºã€å°ç¬¨è›‹ã€‘.`, `Photo captured: `, `ğŸ¤ª`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#3b70fc",
      "",
      "color:#3b70fc",
      "color:#3b70fc",
      "",
      "color:#3b70fc",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c ä½ å¥½ï¼Œå°ç¬¨è›‹.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c âš¡ Powered by å®‰çŸ¥é±¼ %c ä½ æ­£åœ¨è®¿é—® Jack hou çš„åšå®¢.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c ä½ å·²æ‰“å¼€æ§åˆ¶å°.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c ä½ ç°åœ¨æ­£å¤„äºç›‘æ§ä¸­.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script async="async">(function () {
  var grt = new Date("4/15/2023 00:00:00"); //è®¾ç½®ç½‘ç«™ä¸Šçº¿æ—¶é—´
  var now = new Date();
  var dnum;
  var hnum;
  var mnum;
  var snum;
  var nowHour;

  // è®¡ç®—å¹¶æ›´æ–°å¤©æ•°ã€å°æ—¶æ•°ã€åˆ†é’Ÿæ•°å’Œç§’æ•°
  function updateTime() {
    now = new Date(); // æ›´æ–° now çš„å€¼
    nowHour = now.getHours(); // æ›´æ–° nowHour çš„å€¼
    var days = (now - grt) / 1000 / 60 / 60 / 24;
    dnum = Math.floor(days);
    var hours = (now - grt) / 1000 / 60 / 60 - 24 * dnum;
    hnum = Math.floor(hours);
    if (String(hnum).length == 1) {
      hnum = "0" + hnum;
    }
    var minutes = (now - grt) / 1000 / 60 - 24 * 60 * dnum - 60 * hnum;
    mnum = Math.floor(minutes);
    if (String(mnum).length == 1) {
      mnum = "0" + mnum;
    }
    var seconds = (now - grt) / 1000 - 24 * 60 * 60 * dnum - 60 * 60 * hnum - 60 * mnum;
    snum = Math.round(seconds);
    if (String(snum).length == 1) {
      snum = "0" + snum;
    }
  }

  // æ›´æ–°ç½‘é¡µä¸­æ˜¾ç¤ºçš„ç½‘ç«™è¿è¡Œæ—¶é—´
  function updateHtml() {
    const footer = document.getElementById("footer");
    if (!footer) return
    let currentTimeHtml = "";
    if (nowHour < 18 && nowHour >= 9) {
      // å¦‚æœæ˜¯ä¸Šç­æ—¶é—´ï¼Œé»˜è®¤å°±æ˜¯"å®‰çŸ¥é±¼-ä¸Šç­æ‘¸é±¼ä¸­.svg"å›¾ç‰‡ï¼Œä¸éœ€è¦æ›´æ”¹
      currentTimeHtml = `æœ¬ç«™å±…ç„¶è¿è¡Œäº† ${dnum} å¤©<span id='runtime'> ${hnum} å°æ—¶ ${mnum} åˆ† ${snum} ç§’ </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`;
    } else {
      // å¦‚æœæ˜¯ä¸‹ç­æ—¶é—´ï¼Œæ’å…¥"å®‰çŸ¥é±¼-ä¸‹ç­å•¦.svg"å›¾ç‰‡
      let img = document.querySelector("#workboard .workSituationImg");
      img.src = "https://npm.elemecdn.com/anzhiyu-blog@2.0.4/img/badge/å®‰çŸ¥é±¼-ä¸‹ç­å•¦.svg";
      img.title = "ä¸‹ç­äº†å°±è¯¥å¼€å¼€å¿ƒå¿ƒçš„ç©è€ï¼Œå˜¿å˜¿~";
      img.alt = "ä¸‹ç­äº†å°±è¯¥å¼€å¼€å¿ƒå¿ƒçš„ç©è€ï¼Œå˜¿å˜¿~";

      currentTimeHtml = `æœ¬ç«™å±…ç„¶è¿è¡Œäº† ${dnum} å¤©<span id='runtime'> ${hnum} å°æ—¶ ${mnum} åˆ† ${snum} ç§’ </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`;
    }

    if (document.getElementById("runtimeTextTip")) {
      document.getElementById("runtimeTextTip").innerHTML = currentTimeHtml;
    }
  }

  setInterval(() => {
    updateTime();
    updateHtml();
  }, 1000);
})();</script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://twikoo.houyanbin.com/',
      region: '',
      onCommentLoaded: function () {
        anzhiyu.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoo.houyanbin.com/',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      countELement.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init();
    
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://cdn.cbd.int/twikoo@1.6.17/dist/twikoo.all.min.js').then(runFn)
  }
  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) anzhiyu.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[å›¾ç‰‡]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[é“¾æ¥]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[ä»£ç ]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getComment = () => {
    const runTwikoo = () => {
      twikoo.getRecentComments({
        envId: 'https://twikoo.houyanbin.com/',
        region: '',
        pageSize: 6,
        includeReply: true
      }).then(function (res) {
        const twikooArray = res.map(e => {
          return {
            'content': changeContent(e.comment),
            'avatar': e.avatar,
            'nick': e.nick,
            'url': e.url + '#' + e.id,
            'date': new Date(e.created).toISOString()
          }
        })

        saveToLocal.set('twikoo-newest-comments', JSON.stringify(twikooArray), 10/(60*24))
        generateHtml(twikooArray)
      }).catch(function (err) {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.innerHTML= "æ— æ³•è·å–è¯„è®ºï¼Œè¯·ç¡®è®¤ç›¸å…³é…ç½®æ˜¯å¦æ­£ç¡®"
      })
    }

    if (typeof twikoo === 'object') {
      runTwikoo()
    } else {
      getScript('https://cdn.cbd.int/twikoo@1.6.17/dist/twikoo.all.min.js').then(runTwikoo)
    }
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'><div class='name'><span>${array[i].nick}</span></div></a>`
        }
        
        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div>`
      }
    } else {
      result += 'æ²¡æœ‰è¯„è®º'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom.innerHTML= result
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('twikoo-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "visitor@anzhiy.cn";</script><script>//åŠ¨æ€æ ‡é¢˜
let leaveTitle = 'w(ï¾ŸĞ”ï¾Ÿ)w ä¸è¦èµ°ï¼å†çœ‹çœ‹å˜›ï¼';
let backTitle = 'â™ª(^âˆ‡^*)æ¬¢è¿è‚¥æ¥ï¼';
let OriginTitile = document.title
let titleTime
document.addEventListener('visibilitychange', function () {
  if (document.hidden) {
    //ç¦»å¼€å½“å‰é¡µé¢æ—¶æ ‡ç­¾æ˜¾ç¤ºå†…å®¹
    document.title = leaveTitle
    clearTimeout(titleTime)
  } else {
    //è¿”å›å½“å‰é¡µé¢æ—¶æ ‡ç­¾æ˜¾ç¤ºå†…å®¹
    document.title = backTitle + OriginTitile
    //ä¸¤ç§’åå˜å›æ­£å¸¸æ ‡é¢˜
    titleTime = setTimeout(function () {
      document.title = OriginTitile
    }, 2000)
  }
})</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script>// åˆå§‹åŒ–å‡½æ•°
let rm = {};

//ç¦æ­¢å›¾ç‰‡ä¸è¶…é“¾æ¥æ‹–æ‹½
let aElements = document.getElementsByTagName("a");
for (let i = 0; i < aElements.length; i++) {
  aElements[i].setAttribute("draggable", "false");
  let imgElements = aElements[i].getElementsByTagName("img");
  for (let j = 0; j < imgElements.length; j++) {
    imgElements[j].setAttribute("draggable", "false");
  }
}

// æ˜¾ç¤ºèœå•
rm.showRightMenu = function (isTrue, x = 0, y = 0) {
  console.info(x, y)
  let rightMenu = document.getElementById("rightMenu");
  rightMenu.style.top = x + "px";
  rightMenu.style.left = y + "px";
  if (isTrue) {
    rightMenu.style.display = "block";
    stopMaskScroll();
  } else {
    rightMenu.style.display = "none";
  }
};

// éšè—èœå•
rm.hideRightMenu = function () {
  rm.showRightMenu(false);
  let rightMenuMask = document.querySelector("#rightmenu-mask");
  rightMenuMask.style.display = "none";
};

// å°ºå¯¸
let rmWidth = document.getElementById("rightMenu").offsetWidth;
let rmHeight = document.getElementById("rightMenu").offsetHeight;

// é‡æ–°å®šä¹‰å°ºå¯¸
rm.reloadrmSize = function () {
  rightMenu.style.visibility = "hidden";
  rightMenu.style.display = "block";
  // è·å–å®½åº¦å’Œé«˜åº¦
  rmWidth = document.getElementById("rightMenu").offsetWidth;
  rmHeight = document.getElementById("rightMenu").offsetHeight;
  rightMenu.style.visibility = "visible";
};

// è·å–ç‚¹å‡»çš„href
let domhref = "";
let domImgSrc = "";
let globalEvent = null;

var oncontextmenuFunction = function (event) {
  if (document.body.clientWidth > 768) {
    let pageX = event.clientX + 10; //åŠ 10æ˜¯ä¸ºäº†é˜²æ­¢æ˜¾ç¤ºæ—¶é¼ æ ‡é®åœ¨èœå•ä¸Š
    let pageY = event.clientY;

    //å…¶ä»–é¢å¤–èœå•
    const $rightMenuOther = document.querySelector(".rightMenuOther");
    const $rightMenuPlugin = document.querySelector(".rightMenuPlugin");
    const $rightMenuCopyText = document.querySelector("#menu-copytext");
    const $rightMenuPasteText = document.querySelector("#menu-pastetext");
    const $rightMenuCommentText = document.querySelector("#menu-commenttext");
    const $rightMenuNewWindow = document.querySelector("#menu-newwindow");
    const $rightMenuNewWindowImg = document.querySelector("#menu-newwindowimg");
    const $rightMenuCopyLink = document.querySelector("#menu-copylink");
    const $rightMenuCopyImg = document.querySelector("#menu-copyimg");
    const $rightMenuDownloadImg = document.querySelector("#menu-downloadimg");
    const $rightMenuSearch = document.querySelector("#menu-search");
    const $rightMenuSearchBaidu = document.querySelector("#menu-searchBaidu");
    const $rightMenuMusicToggle = document.querySelector("#menu-music-toggle");
    const $rightMenuMusicBack = document.querySelector("#menu-music-back");
    const $rightMenuMusicForward = document.querySelector("#menu-music-forward");
    const $rightMenuMusicPlaylist = document.querySelector("#menu-music-playlist");
    const $rightMenuMusicCopyMusicName = document.querySelector("#menu-music-copyMusicName");

    let href = event.target.href;
    let imgsrc = event.target.currentSrc;

    // åˆ¤æ–­æ¨¡å¼ æ‰©å±•æ¨¡å¼ä¸ºæœ‰äº‹ä»¶
    let pluginMode = false;
    $rightMenuOther.style.display = "block";
    globalEvent = event;

    // æ£€æŸ¥æ˜¯å¦éœ€è¦å¤åˆ¶ æ˜¯å¦æœ‰é€‰ä¸­æ–‡æœ¬
    if (selectTextNow && window.getSelection()) {
      pluginMode = true;
      $rightMenuCopyText.style.display = "block";
      $rightMenuCommentText.style.display = "block";
      $rightMenuSearch.style.display = "block";
      $rightMenuSearchBaidu.style.display = "block";
    } else {
      $rightMenuCopyText.style.display = "none";
      $rightMenuCommentText.style.display = "none";
      $rightMenuSearchBaidu.style.display = "none";
      $rightMenuSearch.style.display = "none";
    }

    //æ£€æŸ¥æ˜¯å¦å³é”®ç‚¹å‡»äº†é“¾æ¥aæ ‡ç­¾
    if (href) {
      pluginMode = true;
      $rightMenuNewWindow.style.display = "block";
      $rightMenuCopyLink.style.display = "block";
      domhref = href;
    } else {
      $rightMenuNewWindow.style.display = "none";
      $rightMenuCopyLink.style.display = "none";
    }

    //æ£€æŸ¥æ˜¯å¦éœ€è¦å¤åˆ¶å›¾ç‰‡
    if (imgsrc) {
      pluginMode = true;
      $rightMenuCopyImg.style.display = "block";
      $rightMenuDownloadImg.style.display = "block";
      $rightMenuNewWindowImg.style.display = "block";
      document.getElementById("rightMenu").style.width="12rem"
      domImgSrc = imgsrc;
    } else {
      $rightMenuCopyImg.style.display = "none";
      $rightMenuDownloadImg.style.display = "none";
      $rightMenuNewWindowImg.style.display = "none";
    }

    // åˆ¤æ–­æ˜¯å¦ä¸ºè¾“å…¥æ¡†
    if (event.target.tagName.toLowerCase() === "input" || event.target.tagName.toLowerCase() === "textarea") {
      pluginMode = true;
      $rightMenuPasteText.style.display = "block";
    } else {
      $rightMenuPasteText.style.display = "none";
    }
    const navMusicEl = document.querySelector("#nav-music");
    //åˆ¤æ–­æ˜¯å¦æ˜¯éŸ³ä¹
    if (navMusicEl && navMusicEl.contains(event.target)) {
      pluginMode = true;
      $rightMenuMusicToggle.style.display = "block";
      $rightMenuMusicBack.style.display = "block";
      $rightMenuMusicForward.style.display = "block";
      $rightMenuMusicPlaylist.style.display = "block";
      $rightMenuMusicCopyMusicName.style.display = "block";
    } else {
      $rightMenuMusicToggle.style.display = "none";
      $rightMenuMusicBack.style.display = "none";
      $rightMenuMusicForward.style.display = "none";
      $rightMenuMusicPlaylist.style.display = "none";
      $rightMenuMusicCopyMusicName.style.display = "none";
    }

    // å¦‚æœä¸æ˜¯æ‰©å±•æ¨¡å¼åˆ™éšè—æ‰©å±•æ¨¡å—
    if (pluginMode) {
      $rightMenuOther.style.display = "none";
      $rightMenuPlugin.style.display = "block";
    } else {
      $rightMenuPlugin.style.display = "none";
    }

    rm.reloadrmSize();

    // é¼ æ ‡é»˜è®¤æ˜¾ç¤ºåœ¨é¼ æ ‡å³ä¸‹æ–¹ï¼Œå½“é¼ æ ‡é å³æˆ–é ä¸‹æ—¶ï¼Œå°†èœå•æ˜¾ç¤ºåœ¨é¼ æ ‡å·¦æ–¹\ä¸Šæ–¹
    if (pageX + rmWidth > window.innerWidth) {
      pageX -= rmWidth + 10;
    }
    if (pageY + rmHeight > window.innerHeight) {
      pageY -= pageY + rmHeight - window.innerHeight;
    }

    rm.showRightMenu(true, pageY, pageX);
    document.getElementById("rightmenu-mask").style.display = "flex";
    return false;
  }
};

// ç›‘å¬å³é”®åˆå§‹åŒ–
window.oncontextmenu = oncontextmenuFunction

// ä¸‹è½½å›¾ç‰‡çŠ¶æ€
rm.downloadimging = false;

// å¤åˆ¶å›¾ç‰‡åˆ°å‰ªè´´æ¿
rm.writeClipImg = function (imgsrc) {
  console.log("æŒ‰ä¸‹å¤åˆ¶");
  rm.hideRightMenu();
  anzhiyu.snackbarShow("æ­£åœ¨ä¸‹è½½ä¸­ï¼Œè¯·ç¨å", false, 10000);
  if (rm.downloadimging == false) {
    rm.downloadimging = true;
    setTimeout(function () {
      copyImage(imgsrc);
      anzhiyu.snackbarShow("å¤åˆ¶æˆåŠŸï¼å›¾ç‰‡å·²æ·»åŠ ç›²æ°´å°ï¼Œè¯·éµå®ˆç‰ˆæƒåè®®");
      rm.downloadimging = false;
    }, "10000");
  }
};

function imageToBlob(imageURL) {
  const img = new Image();
  const c = document.createElement("canvas");
  const ctx = c.getContext("2d");
  img.crossOrigin = "";
  img.src = imageURL;
  return new Promise(resolve => {
    img.onload = function () {
      c.width = this.naturalWidth;
      c.height = this.naturalHeight;
      ctx.drawImage(this, 0, 0);
      c.toBlob(
        blob => {
          // here the image is a blob
          resolve(blob);
        },
        "image/png",
        0.75
      );
    };
  });
}

async function copyImage(imageURL) {
  const blob = await imageToBlob(imageURL);
  const item = new ClipboardItem({ "image/png": blob });
  navigator.clipboard.write([item]);
}

rm.copyUrl = function (id) {
  const input = document.createElement("input"); // Create a new <input> element
  input.id = "copyVal"; // Set the id of the new element to "copyVal"
  document.body.appendChild(input); // Append the new element to the end of the <body> element
  
  const text = id;
  input.value = text;
  input.select();
  input.setSelectionRange(0, input.value.length);
  document.execCommand("copy");
  
  input.remove(); // Remove the <input> element from the DOM
};

function stopMaskScroll() {
  if (document.getElementById("rightmenu-mask")) {
    let xscroll = document.getElementById("rightmenu-mask");
    xscroll.addEventListener(
      "mousewheel",
      function (e) {
        //é˜»æ­¢æµè§ˆå™¨é»˜è®¤æ–¹æ³•
        rm.hideRightMenu();
        // e.preventDefault();
      },
      { passive: true }
    );
  }
  if (document.getElementById("rightMenu")) {
    let xscroll = document.getElementById("rightMenu");
    xscroll.addEventListener(
      "mousewheel",
      function (e) {
        //é˜»æ­¢æµè§ˆå™¨é»˜è®¤æ–¹æ³•
        rm.hideRightMenu();
        // e.preventDefault();
      },
      { passive: true }
    );
  }
}

rm.rightmenuCopyText = function (txt) {
  if (navigator.clipboard) {
    navigator.clipboard.writeText(txt);
  }
  rm.hideRightMenu();
};

rm.copyPageUrl = function (url) {
  if (!url) {
    url = window.location.href;
  }
  rm.copyUrl(url);
  anzhiyu.snackbarShow("å¤åˆ¶é“¾æ¥åœ°å€æˆåŠŸ", false, 2000);
  rm.hideRightMenu();
};

rm.sharePage = function () {
  var content = window.location.href;
  rm.copyUrl(url);
  anzhiyu.snackbarShow("å¤åˆ¶é“¾æ¥åœ°å€æˆåŠŸ", false, 2000);
  rm.hideRightMenu();
};

// å¤åˆ¶å½“å‰é€‰ä¸­æ–‡æœ¬
var selectTextNow = "";
document.onmouseup = document.ondblclick = selceText;

function selceText() {
  var txt;
  if (document.selection) {
    txt = document.selection.createRange().text;
  } else {
    txt = window.getSelection().toString();
  }
  selectTextNow = txt !== "" ? txt : "";
}

// è¯»å–å‰ªåˆ‡æ¿
rm.readClipboard = function () {
  if (navigator.clipboard) {
    navigator.clipboard.readText().then(clipText => rm.insertAtCaret(globalEvent.target, clipText));
  }
};

// ç²˜è´´æ–‡æœ¬åˆ°ç„¦ç‚¹
rm.insertAtCaret = function (elemt, value) {
  const startPos = elemt.selectionStart,
    endPos = elemt.selectionEnd;
  if (document.selection) {
    elemt.focus();
    var sel = document.selection.createRange();
    sel.text = value;
    elemt.focus();
  } else {
    if (startPos || startPos == "0") {
      var scrollTop = elemt.scrollTop;
      elemt.value = elemt.value.substring(0, startPos) + value + elemt.value.substring(endPos, elemt.value.length);
      elemt.focus();
      elemt.selectionStart = startPos + value.length;
      elemt.selectionEnd = startPos + value.length;
      elemt.scrollTop = scrollTop;
    } else {
      elemt.value += value;
      elemt.focus();
    }
  }
};

//ç²˜è´´æ–‡æœ¬
rm.pasteText = function () {
  const result = rm.readClipboard() || "";
  rm.hideRightMenu();
};

//å¼•ç”¨åˆ°è¯„è®º
rm.rightMenuCommentText = function (txt) {
  rm.hideRightMenu();
  const postCommentDom = document.getElementById("post-comment");
  var domTop = postCommentDom.offsetTop;
  window.scrollTo(0, domTop - 80);
  if (txt == "undefined" || txt == "null") txt = "å¥½æ£’ï¼";
  function setText() {
    setTimeout(() => {
      var input = document.getElementsByClassName("el-textarea__inner")[0];
      if (!input) setText();
      let evt = document.createEvent("HTMLEvents");
      evt.initEvent("input", true, true);
      let inputValue = replaceAll(txt, "\n", "\n> ");
      input.value = "> " + inputValue + "\n\n";
      input.dispatchEvent(evt);
      input.focus();
      input.setSelectionRange(-1, -1);
      if (document.getElementById("comment-tips")) {
        document.getElementById("comment-tips").classList.add("show");
      }
    }, 100);
  }
  setText();
};

//æ›¿æ¢æ‰€æœ‰å†…å®¹
function replaceAll(string, search, replace) {
  return string.split(search).join(replace);
}

// ç™¾åº¦æœç´¢
rm.searchBaidu = function () {
  anzhiyu.snackbarShow("å³å°†è·³è½¬åˆ°ç™¾åº¦æœç´¢", false, 2000);
  setTimeout(function () {
    window.open("https://www.baidu.com/s?wd=" + selectTextNow);
  }, "2000");
  rm.hideRightMenu();
};

//åˆ†äº«é“¾æ¥
rm.copyLink = function () {
  rm.rightmenuCopyText(domhref);
  anzhiyu.snackbarShow("å·²å¤åˆ¶é“¾æ¥åœ°å€");
};

function addRightMenuClickEvent() {
  // æ·»åŠ ç‚¹å‡»äº‹ä»¶
  document.getElementById("menu-backward").addEventListener("click", function () {
  window.history.back();
    rm.hideRightMenu();
  });

  document.getElementById("menu-forward").addEventListener("click", function () {
    window.history.forward();
    rm.hideRightMenu();
  });

  document.getElementById("menu-refresh").addEventListener("click", function () {
    window.location.reload();
  });

  document.getElementById("menu-top").addEventListener("click", function () {
    anzhiyu.scrollToDest(0, 500);
    rm.hideRightMenu();
  });

  const menuLinks = document.querySelectorAll(".menu-link");
  menuLinks.forEach(function (link) {
    link.addEventListener("click", rm.hideRightMenu);
  });

  document.getElementById("menu-darkmode").addEventListener("click", anzhiyu.switchDarkMode);

  document.getElementById("menu-home") && document.getElementById("menu-home").addEventListener("click", function () {
    window.location.href = window.location.origin;
  });

  document.getElementById("menu-randomPost").addEventListener("click", function () {
    toRandomPost();
  });

  document.getElementById("menu-commentBarrage").addEventListener("click", anzhiyu.switchCommentBarrage);

  document.getElementById("rightmenu-mask").addEventListener("click", rm.hideRightMenu);

  document.getElementById("rightmenu-mask").addEventListener("contextmenu", function (event) {
    rm.hideRightMenu();
    event.preventDefault(); // Prevent the default context menu from appearing
  });

  document.getElementById("menu-copy").addEventListener("click", rm.copyPageUrl);

  document.getElementById("menu-pastetext").addEventListener("click", rm.pasteText);

  document.getElementById("menu-copytext").addEventListener("click", function () {
    rm.rightmenuCopyText(selectTextNow);
    anzhiyu.snackbarShow("å¤åˆ¶æˆåŠŸï¼Œå¤åˆ¶å’Œè½¬è½½è¯·æ ‡æ³¨æœ¬æ–‡åœ°å€");
  });

  document.getElementById("menu-commenttext").addEventListener("click", function () {
    rm.rightMenuCommentText(selectTextNow);
  });

  document.getElementById("menu-newwindow").addEventListener("click", function () {
    window.open(domhref, "_blank");
    rm.hideRightMenu();
  });

  document.getElementById("menu-copylink").addEventListener("click", rm.copyLink);

  document.getElementById("menu-downloadimg").addEventListener("click", function () {
    anzhiyu.downloadImage(domImgSrc, "anzhiyu");
  });

  document.getElementById("menu-newwindowimg").addEventListener("click", function () {
    window.open(domImgSrc, "_blank");
    rm.hideRightMenu();
  });

  document.getElementById("menu-copyimg").addEventListener("click", function () {
    rm.writeClipImg(domImgSrc);
  });

  document.getElementById("menu-searchBaidu").addEventListener("click", rm.searchBaidu);

  //éŸ³ä¹
  document.getElementById("menu-music-toggle").addEventListener("click", anzhiyu.musicToggle);

  document.getElementById("menu-music-back").addEventListener("click", anzhiyu.musicSkipBack);

  document.getElementById("menu-music-forward").addEventListener("click", anzhiyu.musicSkipForward);

  document.getElementById("menu-music-copyMusicName").addEventListener("click", function () {
    rm.rightmenuCopyText(anzhiyu.musicGetName());
    anzhiyu.snackbarShow("å¤åˆ¶æ­Œæ›²åç§°æˆåŠŸ", false, 3000);
  });

}

addRightMenuClickEvent();</script><script data-pjax>var themeColorMeta = document.querySelector('meta[name="theme-color"]');
var pageHeaderEl = document.getElementById("page-header");
var navMusicEl = document.getElementById("nav-music");
var consoleEl = document.getElementById("console");
// å·²éšæœºçš„æ­Œæ›²
var selectRandomSong = [];
// éŸ³ä¹é»˜è®¤å£°éŸ³å¤§å°
var musicVolume = 0.8;
// æ˜¯å¦åˆ‡æ¢äº†å‘¨æ°ä¼¦éŸ³ä¹åˆ—è¡¨
var changeMusicListFlag = false;
// å½“å‰é»˜è®¤æ’­æ”¾åˆ—è¡¨
var defaultPlayMusicList = [];

document.getElementById("page-name").innerText = document.title.split(" | Jackhou Blog")[0];
anzhiyu.initIndexEssay();
anzhiyu.changeTimeInEssay();
anzhiyu.removeBodyPaceClass();
anzhiyu.qrcodeCreate();
anzhiyu.changeTimeInAlbumDetail();
anzhiyu.reflashEssayWaterFall();
anzhiyu.sayhi();
anzhiyu.stopImgRightDrag();
anzhiyu.addNavBackgroundInit();
anzhiyu.setValueToBodyType();
anzhiyu.catalogActive();
anzhiyu.tagsPageActive();
anzhiyu.categoriesBarActive();
anzhiyu.topCategoriesBarScroll();
anzhiyu.switchRightClickMenuHotReview();
anzhiyu.getCustomPlayList();
anzhiyu.addEventListenerConsoleMusicList(false);
setTimeout(() => {if (typeof addFriendLinksInFooter === "function") {addFriendLinksInFooter();}}, 200)</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","meta[property=\"og:type\"]","meta[property=\"og:site_name\"]","meta[property=\"og:description\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div></body></html>